/*
Copyright 2013, KISSY UI Library v1.40dev
MIT Licensed
build time: Aug 1 12:11
*/
KISSY.add("dd/ddm",function(k,g,l,i){function j(){j.superclass.constructor.apply(this,arguments)}function b(f){var a,b;if(f.touches&&1<f.touches.length)o._end();else{if(a=this.__activeToDrag)a._move(f);else if(b=this.get("activeDrag"))b._move(f),this.__needDropCheck&&h(this,f,b);(a=a||b)&&a.get("preventDefaultOnMove")&&f.preventDefault()}}function h(f,b,d){var c=f.get("validDrops"),h=d.get("mode"),e=0,g=0,m=n(d.get("node")),j=a(m);k.each(c,function(f){if(f.get("disabled"))return i;var c;c=f.getNodeFromTarget(b,
d.get("dragNode")[0],d.get("node")[0]);if(!c)return i;if("point"==h)q(n(c),d.mousePos)&&(c=a(n(c)),e?c<g&&(e=f,g=c):(e=f,g=c));else if("intersect"==h)c=a(w(m,n(c))),c>g&&(g=c,e=f);else if("strict"==h&&(c=a(w(m,n(c))),c==j))return e=f,!1;return i});if((c=f.get("activeDrop"))&&c!=e)c._handleOut(b),d._handleOut(b);f.setInternal("activeDrop",e);e&&(c!=e?e._handleEnter(b):e._handleOver(b))}function d(f){f._shim=u('<div style="background-color:red;position:'+(v?"absolute":"fixed")+";left:0;width:100%;height:100%;top:0;cursor:"+
o.get("dragCursor")+";z-index:"+C+';"></div>').prependTo(r.body||r.documentElement).css("opacity",0);d=e;if(v)D.on("resize scroll",x,f);e(f)}function e(f){var a=f.get("activeDrag").get("activeHandler"),b="auto";a&&(b=a.css("cursor"));"auto"==b&&(b=f.get("dragCursor"));f._shim.css({cursor:b,display:"block"});v&&x.call(f)}function m(f){var a=f.get("drops");f.setInternal("validDrops",[]);a.length&&k.each(a,function(f){f._active()})}function s(f){var a=f.get("drops");f.setInternal("validDrops",[]);a.length&&
k.each(a,function(f){f._deActive()})}function n(f){var a=f.offset();return{left:a.left,right:a.left+(f.__dd_cached_width||f.outerWidth()),top:a.top,bottom:a.top+(f.__dd_cached_height||f.outerHeight())}}function q(a,b){return a.left<=b.left&&a.right>=b.left&&a.top<=b.top&&a.bottom>=b.top}function a(a){return a.top>=a.bottom||a.left>=a.right?0:(a.right-a.left)*(a.bottom-a.top)}function w(a,b){var c=Math.max(a.top,b.top),d=Math.min(a.right,b.right),e=Math.min(a.bottom,b.bottom);return{left:Math.max(a.left,
b.left),right:d,top:c,bottom:e}}function c(a){a&&(a.__dd_cached_width=a.outerWidth(),a.__dd_cached_height=a.outerHeight())}var t=k.UA,u=g.all,y=k.Env.host,r=y.document,p=u(r),D=u(y),v=6===t.ie,C=999999,g=g.Gesture,z=g.move,A=g.end;j.ATTRS={dragCursor:{value:"move"},clickPixelThresh:{value:3},bufferTime:{value:1},activeDrag:{},activeDrop:{},drops:{value:[]},validDrops:{value:[]}};var B=t.ie&&8>t.ie?k.throttle(b,30):b,x=k.throttle(function(){var a;(a=this.get("activeDrag"))&&a.get("shim")&&this._shim.css({width:p.width(),
height:p.height()})},30);k.extend(j,l,{__activeToDrag:0,_regDrop:function(a){this.get("drops").push(a)},_unRegDrop:function(a){var b=this.get("drops"),a=k.indexOf(a,b);-1!=a&&b.splice(a,1)},_regToDrag:function(a){this.__activeToDrag=a;p.on(A,this._end,this);p.on(z,B,this);6===t.ie&&r.body.setCapture()},_start:function(){this.get("drops");var a=this.__activeToDrag;this.setInternal("activeDrag",a);this.__activeToDrag=0;a.get("shim")&&d(this);this.__needDropCheck=0;a.get("groups")&&(m(this),this.get("validDrops").length&&
(c(a.get("node")),this.__needDropCheck=1))},_addValidDrop:function(a){this.get("validDrops").push(a)},_end:function(a){var b=this.__activeToDrag,c=this.get("activeDrag"),d=this.get("activeDrop");a&&(b&&b._move(a),c&&c._move(a));p.detach(z,B,this);p.detach(A,this._end,this);6===t.ie&&r.body.releaseCapture();b&&(b._end(a),this.__activeToDrag=0);this._shim&&this._shim.hide();c&&(c._end(a),s(this),d&&d._end(a),this.setInternal("activeDrag",null),this.setInternal("activeDrop",null))}});var o=new j;o.inRegion=
q;o.region=n;o.area=a;o.cacheWH=c;o.PREFIX_CLS="ks-dd-";return o},{requires:["node","base"]});
KISSY.add("dd/draggable",function(k,g,l,i){function j(){return!1}var b=g.all,h=k.each,d=k.Features,e=k.UA.ie,m=i.PREFIX_CLS,s=k.Env.host.document,l=l.extend({initializer:function(){this.addTarget(i);this._allowMove=this.get("move")},_onSetNode:function(a){this.setInternal("dragNode",a);this.bindDragEvent()},bindDragEvent:function(){this.get("node").on(g.Gesture.start,q,this).on("dragstart",this._fixDragStart)},detachDragEvent:function(a){a=this;a.get("node").detach(g.Gesture.start,q,a).detach("dragstart",
a._fixDragStart)},_bufferTimer:null,_onSetDisabledChange:function(a){this.get("dragNode")[a?"addClass":"removeClass"](m+"-disabled")},_fixDragStart:function(a){a.preventDefault()},_checkHandler:function(a){var b=this,c=b.get("handlers"),d=0;h(c,function(c){if(c[0]==a||c.contains(a))return d=1,b.setInternal("activeHandler",c),!1});return d},_checkDragStartValid:function(a){return this.get("primaryButtonOnly")&&1!=a.which||this.get("disabled")?0:1},_prepare:function(a){if(a){var b=this;e&&(n=s.body.onselectstart,
s.body.onselectstart=j);b.get("halt")&&a.stopPropagation();d.isTouchEventSupported()||a.preventDefault();var c=a.pageX,h=a.pageY;b.setInternal("startMousePos",b.mousePos={left:c,top:h});if(b._allowMove){var g=b.get("node").offset();b.setInternal("startNodePos",g);b.setInternal("deltaPos",{left:c-g.left,top:h-g.top})}i._regToDrag(b);if(c=b.get("bufferTime"))b._bufferTimer=setTimeout(function(){b._start(a)},1E3*c)}},_clearBufferTimer:function(){this._bufferTimer&&(clearTimeout(this._bufferTimer),this._bufferTimer=
0)},_move:function(a){var b=a.pageX,c=a.pageY;if(!this.get("dragging")){var d=this.get("startMousePos"),e=0,h=this.get("clickPixelThresh");if(Math.abs(b-d.left)>=h||Math.abs(c-d.top)>=h)this._start(a),e=1;if(!e)return}this.mousePos={left:b,top:c};a.drag=this;if(d=this._allowMove)e=this.get("deltaPos"),b-=e.left,c-=e.top,a.left=b,a.top=c,this.setInternal("actualPos",{left:b,top:c}),this.fire("dragalign",a);c=1;!1===this.fire("drag",a)&&(c=0);c&&d&&this.get("node").offset(this.get("actualPos"))},stopDrag:function(){i._end()},
_end:function(a){var a=a||{},b;this._clearBufferTimer();e&&(s.body.onselectstart=n);this.get("dragging")&&(this.get("node").removeClass(m+"drag-over"),(b=i.get("activeDrop"))?this.fire("dragdrophit",{drag:this,drop:b}):this.fire("dragdropmiss",{drag:this}),this.setInternal("dragging",0),this.fire("dragend",{drag:this,pageX:a.pageX,pageY:a.pageY}))},_handleOut:function(){this.get("node").removeClass(m+"drag-over");this.fire("dragexit",{drag:this,drop:i.get("activeDrop")})},_handleEnter:function(a){this.get("node").addClass(m+
"drag-over");this.fire("dragenter",a)},_handleOver:function(a){this.fire("dragover",a)},_start:function(a){this._clearBufferTimer();this.setInternal("dragging",1);this.setInternal("dragStartMousePos",{left:a.pageX,top:a.pageY});i._start();this.fire("dragstart",{drag:this,pageX:a.pageX,pageY:a.pageY})},destructor:function(){this.detachDragEvent();this.detach()}},{name:"Draggable",ATTRS:{node:{setter:function(a){if(!(a instanceof g))return b(a)}},clickPixelThresh:{valueFn:function(){return i.get("clickPixelThresh")}},
bufferTime:{valueFn:function(){return i.get("bufferTime")}},dragNode:{},shim:{value:!1},handlers:{value:[],getter:function(a){var d=this;a.length||(a[0]=d.get("node"));h(a,function(c,e){"function"===typeof c&&(c=c.call(d));"string"==typeof c&&(c=d.get("node").one(c));c.nodeType&&(c=b(c));a[e]=c});d.setInternal("handlers",a);return a}},activeHandler:{},dragging:{value:!1,setter:function(a){this.get("dragNode")[a?"addClass":"removeClass"](m+"dragging")}},mode:{value:"point"},disabled:{value:!1},move:{value:!1},
primaryButtonOnly:{value:!0},halt:{value:!0},groups:{value:!0},startMousePos:{},dragStartMousePos:{},startNodePos:{},deltaPos:{},actualPos:{},preventDefaultOnMove:{value:!0}}});l.DropMode={POINT:"point",INTERSECT:"intersect",STRICT:"strict"};k.mix(l,l.DropMode);var n,q=function(a){var b=a.target;this._checkDragStartValid(a)&&this._checkHandler(b)&&this._prepare(a)};return l},{requires:["node","rich-base","./ddm"]});
KISSY.add("dd/draggable-delegate",function(k,g,l,i){var j=g.PREFIX_CLS,b=i.all,h=function(d){var e,h;if(this._checkDragStartValid(d)){e=this.get("handlers");var g=b(d.target);(e=e.length?this._getHandler(g):g)&&(h=this._getNode(e));h&&(this.setInternal("activeHandler",e),this.setInternal("node",h),this.setInternal("dragNode",h),this._prepare(d))}};return l.extend({_onSetNode:function(){},_onSetContainer:function(){this.bindDragEvent()},_onSetDisabledChange:function(b){this.get("container")[b?"addClass":
"removeClass"](j+"-disabled")},bindDragEvent:function(){this.get("container").on(i.Gesture.start,h,this).on("dragstart",this._fixDragStart)},detachDragEvent:function(){this.get("container").detach(i.Gesture.start,h,this).detach("dragstart",this._fixDragStart)},_getHandler:function(b){for(var e=void 0,h=this.get("container"),g=this.get("handlers");b&&b[0]!==h[0];){k.each(g,function(h){if(b.test(h))return e=b,!1});if(e)break;b=b.parent()}return e},_getNode:function(b){return b.closest(this.get("selector"),
this.get("container"))}},{ATTRS:{container:{setter:function(d){return b(d)}},selector:{},handlers:{value:[],getter:0}}})},{requires:["./ddm","./draggable","node"]});
KISSY.add("dd/droppable",function(k,g,l,i){var j=i.PREFIX_CLS;return l.extend({initializer:function(){this.addTarget(i);i._regDrop(this)},getNodeFromTarget:function(b,h,d){var b=this.get("node"),e=b[0];return e==h||e==d?null:b},_active:function(){var b=i.get("activeDrag"),h=this.get("node"),d=this.get("groups"),b=b.get("groups");a:if(!0===b)d=1;else{for(var e in d)if(b[e]){d=1;break a}d=0}d?(i._addValidDrop(this),h&&(h.addClass(j+"drop-active-valid"),i.cacheWH(h))):h&&h.addClass(j+"drop-active-invalid")},
_deActive:function(){var b=this.get("node");b&&b.removeClass(j+"drop-active-valid").removeClass(j+"drop-active-invalid")},__getCustomEvt:function(b){return k.mix({drag:i.get("activeDrag"),drop:this},b)},_handleOut:function(){var b=this.__getCustomEvt();this.get("node").removeClass(j+"drop-over");this.fire("dropexit",b)},_handleEnter:function(b){b=this.__getCustomEvt(b);b.drag._handleEnter(b);this.get("node").addClass(j+"drop-over");this.fire("dropenter",b)},_handleOver:function(b){b=this.__getCustomEvt(b);
b.drag._handleOver(b);this.fire("dropover",b)},_end:function(){var b=this.__getCustomEvt();this.get("node").removeClass(j+"drop-over");this.fire("drophit",b)},destructor:function(){i._unRegDrop(this)}},{name:"Droppable",ATTRS:{node:{setter:function(b){if(b)return g.one(b)}},groups:{value:{}},disabled:{}}})},{requires:["node","rich-base","./ddm"]});
KISSY.add("dd/droppable-delegate",function(k,g,l,i){function j(){var b=this.get("container"),d=[],e=this.get("selector");b.all(e).each(function(b){g.cacheWH(b);d.push(b)});this.__allNodes=d}var b=l.extend({initializer:function(){g.on("dragstart",j,this)},getNodeFromTarget:function(b,d,e){var i={left:b.pageX,top:b.pageY},b=this.__allNodes,j=0,l=Number.MAX_VALUE;b&&k.each(b,function(b){var a=b[0];a===e||a===d||(a=g.region(b),g.inRegion(a,i)&&(a=g.area(a),a<l&&(l=a,j=b)))});j&&(this.setInternal("lastNode",
this.get("node")),this.setInternal("node",j));return j},_handleOut:function(){b.superclass._handleOut.apply(this,arguments);this.setInternal("node",0);this.setInternal("lastNode",0)},_handleOver:function(h){var d=this.get("node"),e=b.superclass._handleOut,g=b.superclass._handleOver,i=b.superclass._handleEnter,j=this.get("lastNode");j[0]!==d[0]?(this.setInternal("node",j),e.apply(this,arguments),this.setInternal("node",d),i.call(this,h)):g.call(this,h)},_end:function(){b.superclass._end.apply(this,
arguments);this.setInternal("node",0)}},{ATTRS:{lastNode:{},selector:{},container:{setter:function(b){return i.one(b)}}}});return b},{requires:["./ddm","./droppable","node"]});KISSY.add("dd",function(k,g,l,i,j,b){k={Draggable:l,DDM:g,Droppable:j,DroppableDelegate:b,DraggableDelegate:i};return KISSY.DD=k},{requires:["dd/ddm","dd/draggable","dd/draggable-delegate","dd/droppable","dd/droppable-delegate"]});
