/*
Copyright 2013, KISSY UI Library v1.40dev
MIT Licensed
build time: Aug 1 15:51
*/
KISSY.add("scroll-view/drag",function(m,C,D,E){function t(a,c,b){var c=c.timeStamp,f=a.get("scroll"+m.ucfirst(b));a.startScroll[b]=f;a.swipe[b].startTime=c;a.swipe[b].scroll=f}function u(a,c,b,f){if(!v(a,b)){var d="left"==b?"pageX":"pageY",j=a.lastPageXY,i,e=a.startScroll[b]-(c[d]-f[b]),f=c.timeStamp,h=a.minScroll,l=a.maxScroll,k=a.lastDirection,g=a.swipe,p;j[d]&&(i=c[d]==j[d],p=0<c[d]-j[d]);a.get("bounce")||(e=Math.min(Math.max(e,h[b]),l[b]));e<h[b]?(e=h[b]-e,e*=w,e=h[b]-e):e>l[b]&&(e-=l[b],e*=w,
e=l[b]+e);h=f-g[b].startTime;if(!i&&void 0!==k[b]&&k[b]!==p||h>F)g[b].startTime=f,g[b].scroll=e;a.set("scroll"+m.ucfirst(b),e);k[b]=p;j[d]=c[d]}}function v(a,c){return!a.allowScroll[c]&&a.get("left"==c?"lockX":"lockY")?1:0}function x(a,c,b,f){if(v(a,b))f();else{var d="scroll"+m.ucfirst(b),j=a.$contentEl,i=a.get(d),e={},h=a.minScroll,l=a.maxScroll,k=c.timeStamp,c=a.swipe,g;i<h[b]?g=h[b]:i>l[b]&&(g=l[b]);void 0!==g?(d={},d[b]=g,a.scrollTo(d,{duration:a.get("bounceDuration"),easing:a.get("bounceEasing"),
queue:!1,complete:f})):a.pagesOffset?f():(g=k-c[b].startTime,c=i-c[b].scroll,0==g||0==c?f():(g=Math.min(Math.max(c/g,-y),y),e[b]={fx:{frame:G(a,g,i,d,l[b],h[b])}},j.animate(e,{duration:9999,queue:!1,complete:f})))}}function G(a,c,b,f,d,j){var i=c*n,e=1,h=0;return function(c){var k=m.now();if(e){var c=k-c.startTime,g=Math.exp(c*H),c=parseInt(b+i*(1-g)/-z);c>j&&c<d?(this.lastValue===c&&(this.finished=1),this.lastValue=c,a.set(f,c)):(e=0,i*=g,b=c<=j?j:d,h=k)}else c=k-h,k=c/n,k*=Math.exp(-I*k),c=parseInt(i*
k),0===c&&(this.finished=1),a.set(f,b+c)}}function J(a){this.stopAnimation();if(this.isScrolling){var c=this.get("pageIndex");this.isScrolling=0;this.fire("scrollEnd",{pageX:a.pageX,pageY:a.pageY,fromPageIndex:c,pageIndex:c})}}function K(a){A(this);this.startMousePos=this.dd.get("startMousePos");t(this,a,"left");t(this,a,"top");this.fire("scrollStart",{pageX:a.pageX,pageY:a.pageY});this.isScrolling=1}function L(a){var c=this.startMousePos;if(c){var b=this.get("lockX"),f=this.get("lockY");if(b||f){var d;
if(!(d=this.dragInitDirection))this.dragInitDirection=d=Math.abs(a.pageX-c.left)>Math.abs(a.pageY-c.top)?"left":"top";if(b&&"left"==d&&!this.allowScroll[d]){this.dd.stopDrag();return}if(f&&"top"==d&&!this.allowScroll[d]){this.dd.stopDrag();return}}a.preventDefault();u(this,a,"left",c);u(this,a,"top",c);this.fire("scrollMove",{pageX:a.pageX,pageY:a.pageY})}}function M(a){function c(){f++;if(2==f){var c=function(){b.fire("scrollEnd",{pageX:a.pageX,pageY:a.pageY,fromPageIndex:p,pageIndex:b.get("pageIndex")})};
if(b.pagesOffset){b.get("snapThreshold");var d=b.get("snapDuration"),g=b.get("snapEasing"),p=b.get("pageIndex"),n=b.get("scrollLeft"),o=b.get("scrollTop"),d={duration:d,easing:g,complete:c},g=b.pagesOffset.concat([]);b.isScrolling=0;if(e||h)if(e&&h){var q=[],r=void 0;m.each(g,function(a){a&&(0<j&&a.left>n?q.push(a):0>j&&a.left<n&&q.push(a))});var s;0<i?(s=Number.MAX_VALUE,m.each(q,function(a){a.top>o&&s<a.top-o&&(s=a.top-o,r=q.index)})):(s=Number.MAX_VALUE,m.each(q,function(a){a.top<o&&s<o-a.top&&
(s=o-a.top,r=q.index)}));void 0!=r?r!=p?b.scrollToPage(r,d):(b.scrollToPage(r),c()):c()}else e||h?(c=b._getPageIndexFromXY(e?n:o,e,e?j:i),b.scrollToPage(c,d)):(b.scrollToPage(b.get("pageIndex")),c())}else c()}}var b=this,f=0,d=b.startMousePos,j=d.left-a.pageX,i=d.top-a.pageY,d=b.get("snapThreshold"),e=b.allowScroll.left&&Math.abs(j)>d,h=b.allowScroll.top&&Math.abs(i)>d;b.fire("dragend",{pageX:a.pageX,pageY:a.pageY});x(b,a,"left",c);x(b,a,"top",c)}function A(a){a.lastPageXY={};a.lastDirection={};a.swipe=
{left:{},top:{}};a.startMousePos=null;a.startScroll={};a.dragInitDirection=null}var w=0.5,N=E.Gesture,F=300,y=6,n=20,z=Math.log(0.95),H=z/n,I=0.3,B;return B=C.extend({bindUI:function(){var a=this.$contentEl;a.on(N.start,J,this);(this.dd=new D.Draggable({node:a,groups:!1,preventDefaultOnMove:!1,halt:!0})).on("dragstart",K,this).on("drag",L,this).on("dragend",M,this)},syncUI:function(){A(this)},destructor:function(){this.dd.destroy();this.stopAnimation()},stopAnimation:function(){B.superclass.stopAnimation.apply(this,
arguments);this.dd.stopDrag()},_onSetDisabled:function(a){this.dd.set("disabled",a)}},{ATTRS:{lockX:{value:!0},lockY:{value:!1},snapThreshold:{value:5},bounce:{value:!0},bounceDuration:{value:0.4},bounceEasing:{value:"easeOut"}},xclass:"scroll-view"})},{requires:["./base","dd","node"]});
