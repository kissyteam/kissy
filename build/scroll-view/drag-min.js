/*
Copyright 2013, KISSY UI Library v1.40dev
MIT Licensed
build time: Jul 3 13:57
*/
KISSY.add("scroll-view/drag",function(r,E,F,G){function s(a,c,b){var c=c.timeStamp,f=a.get("scroll"+r.ucfirst(b));a.startScroll[b]=f;a.swipe[b].startTime=c;a.swipe[b].scroll=f}function v(a,c,b,f){if(!w(a,b)){var d="left"==b?"pageX":"pageY",j=a.lastPageXY,h,e=a.startScroll[b]-(c[d]-f[b]),f=c.timeStamp,k=a.minScroll,l=a.maxScroll,g=a.lastDirection,i=a.swipe,t;j[d]&&(h=c[d]==j[d],t=0<c[d]-j[d]);e<k[b]?(e=k[b]-e,e*=x,e=k[b]-e):e>l[b]&&(e-=l[b],e*=x,e=l[b]+e);k=f-i[b].startTime;if(!h&&void 0!==g[b]&&g[b]!==
t||k>H)i[b].startTime=f,i[b].scroll=e;a.set("left"==b?"scrollLeft":"scrollTop",e);g[b]=t;j[d]=c[d]}}function w(a,c){return!a.allowScroll[c]&&a.get("left"==c?"lockX":"lockY")?1:0}function y(a,c,b,f){if(w(a,b))f();else{var d="scroll"+("left"==b?"Left":"Top"),j=a.$contentEl,h=a.get(d),e={},k=a.minScroll,l=a.maxScroll,g=c.timeStamp,c=a.swipe,i;h<k[b]?i=k[b]:h>l[b]&&(i=l[b]);void 0!==i?(d={},d[b]=i,a.scrollTo(d,{duration:a.get("bounceDuration"),easing:a.get("bounceEasing"),queue:!1,complete:f})):a.pagesXY?
f():(i=g-c[b].startTime,c=h-c[b].scroll,0==i||0==c?f():(i=Math.min(Math.max(c/i,-z),z),e[b]={fx:{frame:I(a,i,h,d,l[b],k[b])}},j.animate(e,{duration:9999,queue:!1,complete:f})))}}function I(a,c,b,f,d,j){var h=c*m,e=1,k=0;return function(c){var g=r.now();if(e){var c=g-c.startTime,i=Math.exp(c*J),c=parseInt(b+h*(1-i)/-A);c>j&&c<d?(this.lastValue===c&&(this.finished=1),this.lastValue=c,a.set(f,c)):(e=0,h*=i,b=c<=j?j:d,k=g)}else c=g-k,g=c/m,g*=Math.exp(-K*g),c=parseInt(h*g),0===c&&(this.finished=1),a.set(f,
b+c)}}function B(a){this.stopAnimation();if(this.isScrolling){var c=this.get("pageIndex");this.isScrolling=0;this.fire("scrollEnd",{pageX:a.pageX,pageY:a.pageY,fromPageIndex:c,pageIndex:c})}}function L(a){C(this);this.startMousePos={left:a.pageX,top:a.pageY};s(this,a,"left");s(this,a,"top");this.fire("scrollStart",{pageX:a.pageX,pageY:a.pageY});this.isScrolling=1}function M(a){var c=this.startMousePos;v(this,a,"left",c);v(this,a,"top",c);this.fire("scrollMove",{pageX:a.pageX,pageY:a.pageY})}function N(a){function c(){f++;
if(2==f){var c=function(){b.fire("scrollEnd",{pageX:a.pageX,pageY:a.pageY,fromPageIndex:s,pageIndex:b.get("pageIndex")})};if(b.pagesXY){b.get("snapThreshold");var d=b.get("snapDuration"),m=b.get("snapEasing"),s=b.get("pageIndex"),u=b.get("scrollLeft"),n=b.get("scrollTop"),d={duration:d,easing:m,complete:c},m=b.pagesXY.concat([]);b.isScrolling=0;if(l||g)if(l&&g&&e&&k){var o=[],p=void 0;r.each(m,function(a){a&&(0<j&&a.x>u?o.push(a):0>j&&a.x<u&&o.push(a))});var q;0<h?(q=Number.MAX_VALUE,r.each(o,function(a){a.y>
n&&q<a.y-n&&(q=a.y-n,p=o.index)})):(q=Number.MAX_VALUE,r.each(o,function(a){a.y<n&&q<n-a.y&&(q=n-a.y,p=o.index)}));void 0!=p?p!=s?b.scrollToPage(p,d):(b.scrollToPage(p),c()):c()}else l&&e||g&&k?(c=b._getPageIndexFromXY(l?u:n,l,l?j:h),b.scrollToPage(c,d)):(b.scrollToPage(b.get("pageIndex")),c())}else c()}}var b=this,f=0,d=b.startMousePos,j=d.left-a.pageX,h=d.top-a.pageY,d=b.get("snapThreshold"),e=Math.abs(j)>d,k=Math.abs(h)>d,l=b.allowScroll.left,g=b.allowScroll.top;b.fire("dragend",{pageX:a.pageX,
pageY:a.pageY});y(b,a,"left",c);y(b,a,"top",c)}function C(a){a.lastPageXY={};a.lastDirection={};a.swipe={left:{},top:{}};a.startScroll={}}var x=0.5,D=G.Gesture.singleTouchStart,H=300,z=6,m=20,A=Math.log(0.95),J=A/m,K=0.3;return E.extend({bindUI:function(){var a=this.$contentEl;(this.dd=new F.Draggable({node:a,groups:!1,halt:!0})).on("dragstart",L,this).on("drag",M,this).on("dragend",N,this);this.get("el").on(D,B,this);a.on(D,B,this)},syncUI:function(){C(this)},destructor:function(){this.dd.destroy();
this.stopAnimation()},_onSetDisabled:function(a){this.dd.set("disabled",a)}},{ATTRS:{lockX:{value:!0},lockY:{value:!1},snapThreshold:{value:5},bounceDuration:{value:0.4},bounceEasing:{value:"easeOut"}},xclass:"scroll-view"})},{requires:["./base","dd","node"]});
