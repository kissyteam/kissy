/*
Copyright 2013, KISSY v1.40dev
MIT Licensed
build time: Oct 25 12:56
*/
KISSY.add("scroll-view/drag",function(l,H,x,I){function y(b,c,a){var c=c.timeStamp,d=b.get("scroll"+l.ucfirst(a));b.startScroll[a]=d;b.swipe[a].startTime=c;b.swipe[a].scroll=d}function z(b,c,a,d){if(!A(b,a)){var f={pageX:c.touches[0].pageX,pageY:c.touches[0].pageY},e="left"==a?"pageX":"pageY",j=b.lastPageXY,g,k=b.startScroll[a]-(f[e]-d[e]),d=c.timeStamp,n=b.minScroll,p=b.maxScroll,h=b.lastDirection,i=b.swipe,m;j[e]&&(g=f[e]==j[e],m=0<f[e]-j[e]);b.get("bounce")||(k=Math.min(Math.max(k,n[a]),p[a]));
k<n[a]?(f=n[a]-k,f*=B,k=n[a]-f):k>p[a]&&(f=k-p[a],f*=B,k=p[a]+f);f=d-i[a].startTime;if(!g&&void 0!==h[a]&&h[a]!==m||f>J)i[a].startTime=d,i[a].scroll=k;b.set("scroll"+l.ucfirst(a),k);h[a]=m;j[e]=c[e]}}function A(b,c){return!b.allowScroll[c]&&b.get("left"==c?"lockX":"lockY")?1:0}function C(b,c,a,d){if(A(b,a))d();else{var f="scroll"+l.ucfirst(a),e=b.get(f),j=b.minScroll,g=b.maxScroll,k=c.timeStamp,c=b.swipe,n;e<j[a]?n=j[a]:e>g[a]&&(n=g[a]);void 0!==n?(e={},e[a]=n,b.scrollTo(e,{duration:b.get("bounceDuration"),
easing:b.get("bounceEasing"),queue:!1,complete:d})):b.pagesOffset?d():(n=k-c[a].startTime,c=e-c[a].scroll,0==n||0==c?d():(n=Math.min(Math.max(c/n,-D),D),d={node:{},to:{},duration:9999,queue:!1,complete:d,frame:K(b,n,e,f,g[a],j[a])},d.node[a]=e,d.to[a]=null,b.scrollAnims.push((new I(d)).run())))}}function K(b,c,a,d,f,e){var j=c*w,g=1,k=0;return function(c,p){var h=l.now(),i;if(g){i=h-c.startTime;var m=Math.exp(i*L);i=parseInt(a+j*(1-m)/-E);i>e&&i<f?p.lastValue===i?p.pos=1:(p.lastValue=i,b.set(d,i)):
(g=0,j*=m,a=i<=e?e:f,k=h)}else i=h-k,h=i/w,h*=Math.exp(-M*h),i=parseInt(j*h),0===i&&(p.pos=1),b.set(d,a+i)}}function N(b){var c=b.touches;if(!this.get("disabled")){this.stopAnimation();var a={pageX:b.touches[0].pageX,pageY:b.touches[0].pageY};if(this.isScrolling){var d=this.get("pageIndex");this.fire("scrollEnd",l.mix({fromPageIndex:d,pageIndex:d},a))}1<c.length||(F(this),this.startMousePos=a,y(this,b,"left"),y(this,b,"top"),G.on(u.move,v,this).on(u.end,O,this))}}function v(b){var c=b.touches,a=this.startMousePos;
if(a){var c={pageX:c[0].pageX,pageY:c[0].pageY},d=Math.abs(c.pageX-a.pageX),f=Math.abs(c.pageY-a.pageY);if(!(Math.max(d,f)<P)){this.isScrolling||(this.fire("scrollStart",c),this.isScrolling=1);var e=this.get("lockX"),j=this.get("lockY");if(e||j){var g;if(!(g=this.dragInitDirection))this.dragInitDirection=g=d>f?"left":"top";if(e&&"left"==g&&!this.allowScroll[g]){this.isScrolling=0;this.get("preventDefaultX")&&b.preventDefault();return}if(j&&"top"==g&&!this.allowScroll[g]){this.isScrolling=0;this.get("preventDefaultY")&&
b.preventDefault();return}}l.Features.isTouchEventSupported()&&b.preventDefault();z(this,b,"left",a);z(this,b,"top",a);this.fire("scrollMove",c)}}}function O(b){function c(){f++;if(2==f){var c=function(){a.isScrolling=0;a.fire("scrollEnd",{pageX:b.pageX,pageY:b.pageY,fromPageIndex:i,pageIndex:a.get("pageIndex")})};if(a.pagesOffset){var d=a._snapDurationCfg,h=a._snapEasingCfg,i=a.get("pageIndex"),m=a.get("scrollLeft"),l=a.get("scrollTop"),d={duration:d,easing:h,complete:c},s=a.pagesOffset,q=s.length;
a.isScrolling=0;if(g||k)if(g&&k){var h=[],o,r=void 0;for(o=0;o<q;o++){var t=s[o];t&&(0<e&&t.left>m?h.push(t):0>e&&t.left<m&&h.push(t))}s=h.length;if(0<j){m=Number.MAX_VALUE;for(o=0;o<s;o++)q=h[o],q.top>l&&m<q.top-l&&(m=q.top-l,r=h.index)}else{m=Number.MAX_VALUE;for(o=0;o<s;o++)q=h[o],q.top<l&&m<l-q.top&&(m=l-q.top,r=h.index)}void 0!=r?r!=i?a.scrollToPage(r,d):(a.scrollToPage(r),c()):c()}else g||k?(c=a._getPageIndexFromXY(g?m:l,g,g?e:j),a.scrollToPage(c,d)):(a.scrollToPage(i),c())}else c()}}var a=
this,d=a.startMousePos;G.detach(u.move,v,a);if(d&&a.isScrolling){var f=0,e=d.pageX-b.pageX,j=d.pageY-b.pageY,d=a._snapThresholdCfg,g=a.allowScroll.left&&Math.abs(e)>d,k=a.allowScroll.top&&Math.abs(j)>d;a.fire("dragend",{pageX:b.pageX,pageY:b.pageY});C(a,b,"left",c);C(a,b,"top",c)}}function F(b){b.lastPageXY={};b.lastDirection={};b.swipe={left:{},top:{}};b.startMousePos=null;b.startScroll={};b.dragInitDirection=null}function Q(b){b.preventDefault()}var B=0.5,P=3,u=x.Gesture,J=300,D=6,G=x.all(document),
w=20,E=Math.log(0.95),L=E/w,M=0.3;l.UA.ie&&(v=l.throttle(v,30));return H.extend({initializer:function(){this._snapThresholdCfg=this.get("snapThreshold");this._snapDurationCfg=this.get("snapDuration");this._snapEasingCfg=this.get("snapEasing")},bindUI:function(){this.$contentEl.on("dragstart",Q).on(u.start,N,this)},syncUI:function(){F(this)},destructor:function(){this.stopAnimation()},stopAnimation:function(){this.callSuper();this.isScrolling=0}},{ATTRS:{lockX:{value:!0},preventDefaultX:{value:!0},
lockY:{value:!1},preventDefaultY:{value:!1},snapDuration:{value:0.3},snapEasing:{value:"easeOut"},snapThreshold:{value:5},bounce:{value:!0},bounceDuration:{value:0.4},bounceEasing:{value:"easeOut"}},xclass:"scroll-view"})},{requires:["./base","node","anim"]});
