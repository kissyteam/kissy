/*
Copyright 2013, KISSY UI Library v1.40dev
MIT Licensed
build time: Jan 7 17:08
*/
KISSY.add("datalazyload",function(d,e,f,q,l){function m(a,b){a.style.display=r;a.className="";var c=e.create("<div>");a.parentNode.insertBefore(c,a);e.html(c,a.value,b)}function n(a,b){var c,g;if(!(c=a.id))c=a.id=d.guid("ks-lazyload");if(!(g=b.ksLazyloadId))g=b.ksLazyloadId=d.guid("ks-lazyload");return c+g}function h(a,b){if(!(this instanceof h))return new h(a,b);var c=a;d.isPlainObject(c)||(c=b||{},a&&(c.container=a));h.superclass.constructor.call(this,c);this._callbacks={};this._containerIsNotDocument=
9!=this.get("container").nodeType;this._filterItems();this._initLoadEvent()}function o(a,b){var c,g,d,e;c=Math.max(a.top,b.top);g=Math.min(a.bottom,b.bottom);d=Math.max(a.left,b.left);e=Math.min(a.right,b.right);return g>=c&&e>=d}var i=d.Env.host,k=i.document,r="none",p=function(a,b){var b=b||"data-ks-lazyload",c=a.getAttribute(b);c&&a.src!=c&&(a.src=c,a.removeAttribute(b))};h.ATTRS={diff:{value:"default"},placeholder:{value:"http://a.tbcdn.cn/kissy/1.0.0/build/imglazyload/spaceball.gif"},execScript:{value:!0},
container:{setter:function(a){a=a||k;d.isWindow(a)?a=a.document:(a=e.get(a),"body"==e.nodeName(a)&&(a=a.ownerDocument));return a},valueFn:function(){return k}},autoDestroy:{value:!0}};d.extend(h,q,{_filterItems:function(){var a=this.get("container");this._images=d.filter(e.query("img",a),this._filterImg,this);this._textareas=e.query("textarea.ks-datalazyload",a)},_filterImg:function(a){var b=this.get("placeholder");return a.getAttribute("data-ks-lazyload")?(a.src||(a.src=b),!0):l},_initLoadEvent:function(){var a=
this,b=a.get("autoDestroy"),c=function(){a._loadItems();b&&a._isLoadAllLazyElements()&&a.destroy()};a._loadFn=d.buffer(c,100,a);a.resume();a._isLoadAllLazyElements()||d.ready(c)},refresh:function(){this._loadFn()},_loadItems:function(){this._loadImgs();this._loadTextAreas();this._fireCallbacks()},_loadImgs:function(){this._images=d.filter(this._images,this._loadImg,this)},_loadImg:function(a){if(this._elementInViewport(a))p(a);else return!0;return l},_loadTextAreas:function(){this._textareas=d.filter(this._textareas,
this._loadTextArea,this)},_loadTextArea:function(a){if(this._elementInViewport(a))m(a,this.get("execScript"));else return!0;return l},_fireCallbacks:function(){var a=this,b=a._callbacks;d.each(b,function(c,g){var d=c.el,e=!1,f=c.fn;a._elementInViewport(d)&&(e=f.call(d));!1!==e&&delete b[g]})},addCallback:function(a,b){var c=this._callbacks,a=e.get(a);c[n(a,b)]={el:e.get(a),fn:b};this._loadFn()},removeCallback:function(a,b){var c=this._callbacks,a=e.get(a);delete c[n(a,b)]},getElements:function(){return{images:this._images,
textareas:this._textareas}},addElements:function(a){"string"==typeof a?a=e.query(a):d.isArray(a)||(a=[a]);var b=this._images||[],c=this._textareas||[];d.each(a,function(a){var e=a.nodeName.toLowerCase();"img"==e?d.inArray(a,b)||b.push(a):"textarea"==e&&(d.inArray(a,c)||c.push(a))});this._images=b;this._textareas=c},removeElements:function(a){"string"==typeof a?a=e.query(a):d.isArray(a)||(a=[a]);var b=[],c=[];d.each(this._images,function(c){d.inArray(c,a)||b.push(c)});d.each(this._textareas,function(b){d.inArray(b,
a)||c.push(b)});this._images=b;this._textareas=c},_getBoundingRect:function(a){var b,c,g;a!==l?(b=e.outerHeight(a),c=e.outerWidth(a),g=e.offset(a),a=g.left,g=g.top):(b=e.viewportHeight(),c=e.viewportWidth(),a=e.scrollLeft(),g=e.scrollTop());var j=this.get("diff"),f=0,h="default"===j?c:j,i=0,k="default"===j?b:j;c=a+c;b=g+b;d.isObject(j)&&(f=j.left||0,h=j.right||0,i=j.top||0,k=j.bottom||0);return{left:a-f,top:g-i,right:c+h,bottom:b+k}},_isLoadAllLazyElements:function(){return 0==this._images.length+
this._textareas.length+(d.isEmptyObject(this._callbacks)?0:1)},_elementInViewport:function(a){if(!e.contains(k,a)||!a.offsetWidth)return!1;var b=e.offset(a),c=!0,d=this.get("container"),f=this._getBoundingRect(),h=b.left,b=b.top,a={left:h,top:b,right:h+e.outerWidth(a),bottom:b+e.outerHeight(a)};if((f=o(f,a))&&this._containerIsNotDocument)c=this._getBoundingRect(d),c=o(c,a);return c&&f},pause:function(){var a=this._loadFn;if(!this._destroyed&&(f.remove(i,"scroll",a),f.remove(i,"touchmove",a),f.remove(i,
"resize",a),a.stop(),this._containerIsNotDocument)){var b=this.get("container");f.remove(b,"scroll",a);f.remove(b,"touchmove",a)}},resume:function(){var a=this._loadFn;if(!this._destroyed&&(f.on(i,"scroll",a),f.on(i,"touchmove",a),f.on(i,"resize",a),this._containerIsNotDocument)){var b=this.get("container");f.on(b,"scroll",a);f.on(b,"touchmove",a)}},destroy:function(){this.pause();this._callbacks={};this._images=[];this._textareas=[];this.fire("destroy");this._destroyed=1}});h.loadCustomLazyData=
function(a,b,c){var f;"img-src"===b&&(b="img");d.isArray(a)||(a=[e.get(a)]);var h=c||"data-ks-lazyload-custom",i=c||"ks-datalazyload-custom";d.each(a,function(a){switch(b){case "img":f="IMG"===a.nodeName?[a]:e.query("img",a);d.each(f,function(a){p(a,h)});break;default:e.query("textarea."+i,a).each(function(a){m(a,!0)})}})};return d.DataLazyload=h},{requires:["dom","event","base"]});
