/*
Copyright 2012, KISSY UI Library v1.40dev
MIT Licensed
build time: Oct 23 12:42
*/
KISSY.add("datalazyload",function(e,g,h,u,n){function o(a,b){for(var c=[],d=0;d<a.length;d++)e.inArray(a[d],b)||c.push(a[d]);return c}function p(a,b){a.style.display=m;a.className="";var c=g.create("<div>");a.parentNode.insertBefore(c,a);g.html(c,a.value,b)}function v(a){return g.hasClass(a,q)}function i(a,b){if(!(this instanceof i))return new i(a,b);b===n&&(b=a,a=[l]);e.isArray(a)||(a=[g.get(a)||l]);b=b||{};b.containers=a;i.superclass.constructor.call(this,b);this._callbacks={els:[],fns:[]};this._init()}
function r(a,b){var c,d,f,e;c=Math.max(a.top,b.top);d=Math.min(a.bottom,b.bottom);f=Math.max(a.left,b.left);e=Math.min(a.right,b.right);return d>=c&&e>=f}var k=e.Env.host,l=k.document,q="ks-datalazyload",m="none",s=function(a,b){var b=b||"data-ks-lazyload",c=a.getAttribute(b);c&&a.src!=c&&(a.src=c,a.removeAttribute(b))};i.ATTRS={mod:{value:"manual"},diff:{value:"default"},placeholder:{value:m},execScript:{value:!0},containers:{valueFn:function(){return[l]}},autoDestroy:{value:!0}};e.extend(i,u,{_init:function(){this._filterItems();
this._initLoadEvent()},_filterItems:function(){var a=this.get("containers"),b,c,d,f=[],j=[];b=0;for(c=a.length;b<c;++b)d=o(g.query("img",a[b]),f),f=f.concat(e.filter(d,this._filterImg,this)),d=o(g.query("textarea",a[b]),j),j=j.concat(e.filter(d,v,this));this._images=f;this._areaes=j},_filterImg:function(a){var b=a.getAttribute("data-ks-lazyload"),c=this.get("placeholder");if("manual"===this.get("mod")){if(b)return c!==m&&(a.src=c),!0}else if(!b&&!this._checkElemInViewport(a))return g.attr(a,"data-ks-lazyload",
a.src),c!==m?a.src=c:a.removeAttribute("src"),!0},_initLoadEvent:function(){var a=this,b=a.get("autoDestroy"),c=function(){a.loadItems();b&&0===a._getItemsLength()&&a.destroy()},d=e.buffer(c,100,this);h.on(k,"scroll",d);h.on(k,"touchmove",d);h.on(k,"resize",d);e.each(a.get("containers"),function(a){9!=a.nodeType&&(h.on(a,"scroll",d),h.on(a,"touchmove",d))});a._loadFn=d;a._getItemsLength()&&e.ready(c)},loadItems:function(){this._loadImgs();this._loadAreas();this._fireCallbacks()},_loadImgs:function(){this._images=
e.filter(this._images,this._loadImg,this)},_loadImg:function(a){if(g.contains(l,a))if(this._checkElemInViewport(a))s(a);else return!0},_loadAreas:function(){this._areaes=e.filter(this._areaes,this._loadArea,this)},_loadArea:function(a){if(g.contains(l,a))if(this._checkElemInViewport(a))p(a,this.get("execScript"));else return!0},_fireCallbacks:function(){var a=this._callbacks,b=a.els,c=a.fns,d=0,f,e,h,t=[],i=[];for(f=0;(e=b[f])&&(h=c[f++]);)d=!1,g.contains(l,e)?this._checkElemInViewport(e)&&(d=h.call(e)):
d=!0,!1===d&&(t.push(e),i.push(h));a.els=t;a.fns=i},addCallback:function(a,b){var c=this._callbacks;if((a=g.get(a))&&e.isFunction(b))c.els.push(a),c.fns.push(b);this._fireCallbacks()},removeCallback:function(a,b){var c=this._callbacks,d=[],f=[],j=c.fns,a=g.get(a);e.each(c.els,function(c,e){c==a&&(b===n||b==j[e])||(d.push(c),f.push(j[e]))});c.fns=f;c.els=d},addElements:function(a){e.isArray(a)||(a=[a]);var b=this._images||[],c=this._areaes||[];e.each(a,function(a){var f=a.nodeName.toLowerCase();"img"==
f?e.inArray(a,b)||b.push(a):"textarea"==f&&(e.inArray(a,c)||c.push(a))});this._images=b;this._areaes=c},removeElements:function(a){e.isArray(a)||(a=[a]);var b=[],c=[];e.each(this._images,function(c){e.inArray(c,a)||b.push(c)});e.each(this._areaes,function(b){e.inArray(b,a)||c.push(b)});this._images=b;this._areaes=c},_getBoundingRect:function(a){var b,c,d;a!==n&&!e.isWindow(a)&&9!=a.nodeType?(b=g.outerHeight(a),c=g.outerWidth(a),d=g.offset(a),a=d.left,d=d.top):(b=g.viewportHeight(),c=g.viewportWidth(),
a=g.scrollLeft(),d=g.scrollTop());var f=this.get("diff"),j=0,h="default"===f?c:f,i=0,k="default"===f?b:f;c=a+c;b=d+b;e.isObject(f)&&(j=f.left||0,h=f.right||0,i=f.top||0,k=f.bottom||0);return{left:a-j,top:d-i,right:c+h,bottom:b+k}},_getItemsLength:function(){return this._images.length+this._areaes.length+this._callbacks.els.length},_checkElemInViewport:function(a){var b=g.offset(a),c=!0,d;a:{var e=this.get("containers");for(d=0;d<e.length;d++)if(9!=e[d].nodeType&&e[d].contains(a)){d=e[d];break a}d=
0}var e=this._getBoundingRect(),j=b.left,b=b.top,a={left:j,top:b,right:j+g.outerWidth(a),bottom:b+g.outerHeight(a)};d&&(c=this._getBoundingRect(d),c=r(c,a));a=r(e,a);return c&&a},destroy:function(){var a=this._loadFn;h.remove(k,"scroll",a);h.remove(k,"touchmove",a);h.remove(k,"resize",a);e.each(this.get("containers"),function(b){9!=b.nodeType&&(h.remove(b,"scroll",a),h.remove(b,"touchmove",a))});this._callbacks.els=[];this._callbacks.fns=[];this._images=[];this._areaes=[];this.fire("destroy")}});
i.loadCustomLazyData=function(a,b,c){var d;"img-src"===b&&(b="img");e.isArray(a)||(a=[g.get(a)]);e.each(a,function(a){switch(b){case "img":d="IMG"===a.nodeName?[a]:g.query("img",a);e.each(d,function(a){s(a,c||"data-ks-lazyload-custom")});break;default:g.query("textarea",a).each(function(a){g.hasClass(a,c||q+"-custom")&&p(a,!0)})}})};return e.DataLazyload=i},{requires:["dom","event","base"]});
