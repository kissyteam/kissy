/*
Copyright 2012, KISSY UI Library v1.40dev
MIT Licensed
build time: Dec 24 12:48
*/
KISSY.add("datalazyload",function(e,f,h,s,m){function n(a,b){for(var d=[],c=0;c<a.length;c++)e.inArray(a[c],b)||d.push(a[c]);return d}function o(a,b){a.style.display=t;a.className="";var d=f.create("<div>");a.parentNode.insertBefore(d,a);f.html(d,a.value,b)}function u(a){return f.hasClass(a,p)}function i(a,b){if(!(this instanceof i))return new i(a,b);b===m&&(b=a,a=[j]);e.isArray(a)||(a=[f.get(a)||j]);b=b||{};b.containers=a;i.superclass.constructor.call(this,b);this._callbacks=[];this._init()}function q(a,
b){var d,c,g,f;d=Math.max(a.top,b.top);c=Math.min(a.bottom,b.bottom);g=Math.max(a.left,b.left);f=Math.min(a.right,b.right);return c>=d&&f>=g}var l=e.Env.host,j=l.document,p="ks-datalazyload",t="none",r=function(a,b){var b=b||"data-ks-lazyload",d=a.getAttribute(b);d&&a.src!=d&&(a.src=d,a.removeAttribute(b))};i.ATTRS={mod:{value:"manual"},diff:{value:"default"},placeholder:{},execScript:{value:!0},containers:{valueFn:function(){return[j]}},autoDestroy:{value:!0}};e.extend(i,s,{_init:function(){this._filterItems();
this._initLoadEvent()},_filterItems:function(){var a=this.get("containers"),b,d,c,g=[],k=[];b=0;for(d=a.length;b<d;++b)c=n(f.query("img",a[b]),g),g=g.concat(e.filter(c,this._filterImg,this)),c=n(f.query("textarea",a[b]),k),k=k.concat(e.filter(c,u,this));this._images=g;this._areaes=k},_filterImg:function(a){var b=a.getAttribute("data-ks-lazyload"),d=this.get("placeholder");if("manual"===this.get("mod")){if(b)return d&&(a.src=d),!0}else if(!b&&!this._checkElemInViewport(a))return f.attr(a,"data-ks-lazyload",
a.src),d?a.src=d:a.removeAttribute("src"),!0;return m},_initLoadEvent:function(){var a=this,b=a.get("autoDestroy"),d=function(){a._loadItems();b&&0===a._getItemsLength()&&a.destroy()},c=e.buffer(d,100,this);h.on(l,"scroll",c);h.on(l,"touchmove",c);h.on(l,"resize",c);e.each(a.get("containers"),function(a){9!=a.nodeType&&(h.on(a,"scroll",c),h.on(a,"touchmove",c))});a._loadFn=c;a._getItemsLength()&&e.ready(d)},refresh:function(){this._loadFn()},_loadItems:function(){this._loadImgs();this._loadAreas();
this._fireCallbacks()},_loadImgs:function(){this._images=e.filter(this._images,this._loadImg,this)},_loadImg:function(a){if(f.contains(j,a))if(this._checkElemInViewport(a))r(a);else return!0;return m},_loadAreas:function(){this._areaes=e.filter(this._areaes,this._loadArea,this)},_loadArea:function(a){if(f.contains(j,a))if(this._checkElemInViewport(a))o(a,this.get("execScript"));else return!0;return m},_fireCallbacks:function(){var a=this,b=a._callbacks,d=[],c=0;a._callbacks=[];e.each(b,function(b){var e=
b.el,b=b.fn;f.contains(j,e)?a._checkElemInViewport(e)&&(c=b.call(e)):c=!0;!1!==c&&d.push({el:e,fn:b})});a._callbacks=a._callbacks.concat(d)},addCallback:function(a,b){this._callbacks.push({el:f.get(a),fn:b});this._loadFn()},removeCallback:function(a,b){var d=this._callbacks,c,g,a=f.get(a);for(c=d.length-1;0<=c;c--)g=d[c],g.el==a&&g.fn==b&&d.splice(c,1)},addElements:function(a){"string"==typeof a?a=f.query(a):e.isArray(a)||(a=[a]);var b=this._images||[],d=this._areaes||[];e.each(a,function(a){var g=
a.nodeName.toLowerCase();"img"==g?e.inArray(a,b)||b.push(a):"textarea"==g&&(e.inArray(a,d)||d.push(a))});this._images=b;this._areaes=d},removeElements:function(a){"string"==typeof a?a=f.query(a):e.isArray(a)||(a=[a]);var b=[],d=[];e.each(this._images,function(c){e.inArray(c,a)||b.push(c)});e.each(this._areaes,function(b){e.inArray(b,a)||d.push(b)});this._images=b;this._areaes=d},_getBoundingRect:function(a){var b,d,c;a!==m&&!e.isWindow(a)&&9!=a.nodeType?(b=f.outerHeight(a),d=f.outerWidth(a),c=f.offset(a),
a=c.left,c=c.top):(b=f.viewportHeight(),d=f.viewportWidth(),a=f.scrollLeft(),c=f.scrollTop());var g=this.get("diff"),k=0,h="default"===g?d:g,i=0,j="default"===g?b:g;d=a+d;b=c+b;e.isObject(g)&&(k=g.left||0,h=g.right||0,i=g.top||0,j=g.bottom||0);return{left:a-k,top:c-i,right:d+h,bottom:b+j}},_getItemsLength:function(){return this._images.length+this._areaes.length+this._callbacks.length},_checkElemInViewport:function(a){if(!f.contains(j,a))return!1;var b=f.offset(a),d=!0,c;a:{var g=this.get("containers");
for(c=0;c<g.length;c++)if(9!=g[c].nodeType&&g[c].contains(a)){c=g[c];break a}c=0}var g=this._getBoundingRect(),e=b.left,b=b.top,a={left:e,top:b,right:e+f.outerWidth(a),bottom:b+f.outerHeight(a)};c&&(d=this._getBoundingRect(c),d=q(d,a));a=q(g,a);return d&&a},destroy:function(){var a=this._loadFn;h.remove(l,"scroll",a);h.remove(l,"touchmove",a);h.remove(l,"resize",a);a.stop();e.each(this.get("containers"),function(b){9!=b.nodeType&&(h.remove(b,"scroll",a),h.remove(b,"touchmove",a))});this._callbacks=
[];this._images=[];this._areaes=[];this.fire("destroy")}});i.loadCustomLazyData=function(a,b,d){var c;"img-src"===b&&(b="img");e.isArray(a)||(a=[f.get(a)]);e.each(a,function(a){switch(b){case "img":c="IMG"===a.nodeName?[a]:f.query("img",a);e.each(c,function(a){r(a,d||"data-ks-lazyload-custom")});break;default:f.query("textarea",a).each(function(a){f.hasClass(a,d||p+"-custom")&&o(a,!0)})}})};return e.DataLazyload=i},{requires:["dom","event","base"]});
