/*
Copyright 2013, KISSY UI Library v1.40dev
MIT Licensed
build time: Apr 8 22:39
*/
/*
 thanks to CKSource's intelligent work on CKEditor
 @author yiminghe@gmail.com
*/
KISSY.add("editor/core/base",function(a,k,t){k=t.Controller.extend({initializer:function(){this.__commands={};this.__controls={}}},{Config:{},XHTML_DTD:k.DTD,ATTRS:{textarea:{},iframe:{},window:{},document:{},toolBarEl:{},statusBarEl:{},handleMouseEvents:{value:!1},focusable:{value:!1},mode:{value:1},data:{getter:function(a){var k=this._getData();return void 0===k?a:k}},formatData:{getter:function(){return this._getData(1)}},customStyle:{value:""},customLink:{value:[]}}},{xclass:"editor"});k.HTML_PARSER=
{textarea:function(a){return a.one("."+this.get("prefixCls")+"editor-textarea")},data:function(a){return a.one("."+this.get("prefixCls")+"editor-textarea").val()}};a.mix(k,a.EventTarget);return KISSY.Editor=k},{requires:["htmlparser","component/base","core"]});
KISSY.add("editor/core/clipboard",function(a,k,t,r){function o(b){this.editor=b;this._init()}function e(b){if(j.ie&&"BackCompat"!=b.get("document")[0].compatMode){var f=b.getSelection(),d;if(f.getType()==r.SELECTION_ELEMENT&&(d=f.getSelectedElement())){var g=f.getRanges()[0],c=h(b.get("document")[0].createTextNode(""));c.insertBefore(d);g.setStartBefore(c);g.setEndAfter(d);f.selectRanges([g]);setTimeout(function(){d.parent()&&(c.remove(),f.selectElement(d))},0)}}}var h=a.all,j=a.UA,q=k.RANGE,m=a.Event;
a.augment(o,{_init:function(){var b=this.editor,a=b.get("document")[0].body;m.on(a,j.ie?"beforepaste":"paste",this._paste,this);m.on(a,"contextmenu",function(){f=1;setTimeout(function(){f=0},10)});b.addCommand("copy",new v("copy"));b.addCommand("cut",new v("cut"));b.addCommand("paste",new v("paste"))},_paste:function(){if(!f){var b=this.editor,u=b.get("document")[0];if(!u.getElementById("ke_pastebin")){var d=b.getSelection(),g=new t(u),c=h(j.webkit?"<body></body>":u.createElement("div"),null,u);c.attr("id",
"ke_pastebin");j.webkit&&c[0].appendChild(u.createTextNode("\u00a0"));u.body.appendChild(c[0]);c.css({position:"absolute",top:d.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});c.css("left","-1000px");var l=d.createBookmarks();g.setStartAt(c,q.POSITION_AFTER_START);g.setEndAt(c,q.POSITION_BEFORE_END);g.select(!0);setTimeout(function(){var f;c=j.webkit&&(f=c.first())&&f.hasClass("Apple-style-span")?f:c;d.selectBookmarks(l);c.remove();var g=c.html();if(g=a.trim(g.replace(/<span[^>]+_ke_bookmark[^<]*?<\/span>(&nbsp;)*/ig,
"")))f=b.fire("paste",{html:g,holder:c}),void 0!==f&&(g=f),/(class="?Mso|style="[^"]*\bmso\-|w:WordDocument)/.test(g)?a.use("editor/plugin/word-filter",function(c,d){b.insertHtml(d.toDataFormat(g,b))}):b.insertHtml(g)},0)}}}});var w=function(b,f){var d=b.get("document")[0],g=h(d.body),c=!1,a=function(){c=!0};g.on(f,a);(7<j.ie?d:d.selection.createRange()).execCommand(f);g.detach(f,a);return c},n=j.ie?function(b,f){return w(b,f)}:function(b,f){try{return b.get("document")[0].execCommand(f)}catch(d){return!1}},
x={cut:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u526a\u5207\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+X)\u6765\u5b8c\u6210",copy:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u590d\u5236\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+C)\u6765\u5b8c\u6210",paste:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u7c98\u8d34\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+V)\u6765\u5b8c\u6210"},v=function(b){this.type=b};v.prototype={constructor:v,exec:function(b){"cut"==this.type&&e(b);(b=n(b,this.type))||alert(x[this.type]);return b}};var i={copy:"\u590d\u5236",paste:"\u7c98\u8d34",cut:"\u526a\u5207"},f;return{init:function(b){b.docReady(function(){new o(b)});var f={copy:1,cut:1,paste:1};b.on("contextmenu",function(d){d=d.contextmenu;if(!d.__copy_fix){d.__copy_fix=
1;for(var g in f)d.addChild({content:i[g],value:g});d.on("click",function(c){var d=c.target.get("value");f[d]&&(this.hide(),setTimeout(function(){b.execCommand(d)},30))})}})}}},{requires:["./base","./range","./selection"]});
KISSY.add("editor/core/dom",function(a,k,t){function r(f,b){var a=f[b?"next":"prev"](o,1);if(a&&a[0].nodeType==j.ELEMENT_NODE){for(var d=[];a.attr("_ke_bookmark")||a._4e_isEmptyInlineRemovable(o);)if(d.push(a),a=b?a.next(o,1):a.prev(o,1),!a)return;if(f._4e_isIdentical(a,o)){for(var g=new m(b?f[0].lastChild:f[0].firstChild);d.length;)d.shift()._4e_move(f,!b,o);a._4e_moveChildren(f,!b,o);a.remove();g[0]&&g[0].nodeType==j.ELEMENT_NODE&&g._4e_mergeSiblings()}}}var o=o,e=k.XHTML_DTD,h=a.DOM,j=h.NodeType,
q=a.UA,m=a.Node,w={a:1,abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};k.POSITION={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};var n=k.POSITION,x={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,
"table-column":1,"table-cell":1,"table-caption":1},v={hr:1},i=function(f){return f&&(f[0]||f)};t.injectDom({_4e_sameLevel:function(f,b){var b=i(b),a=f.parentNode;return a&&a==b.parentNode},_4e_isBlockBoundary:function(f,b){var u=a.merge(v,b);return!(!x[h.css(f,"display")]&&!u[h.nodeName(f)])},_4e_index:function(f,b){for(var a=f.parentNode.childNodes,d,g=-1,c=0;c<a.length;c++)if(d=a[c],!b||!(3==d.nodeType&&d.previousSibling&&3==d.previousSibling.nodeType))if(g++,d===f)return g;return-1},_4e_move:function(f,
b,a){b=i(b);a?b.insertBefore(f,b.firstChild):b.appendChild(f)},_4e_isIdentical:function(f,b){if(!b)return!1;b=i(b);if(h.nodeName(f)!=h.nodeName(b))return!1;var a=f.attributes,d=b.attributes,g=a.length,c=d.length;if(g!=c)return!1;for(var l=0;l<g;l++){var s=a[l],e=s.name;if(s.specified&&h.attr(f,e)!=h.attr(b,e))return!1}if(8>t.ieEngine)for(l=0;l<c;l++)if(s=d[l],e=s.name,s.specified&&h.attr(f,e)!=h.attr(b,e))return!1;return!0},_4e_isEmptyInlineRemovable:function(f){if(!e.$removeEmpty[h.nodeName(f)])return!1;
for(var f=f.childNodes,b=0,u=f.length;b<u;b++){var d=f[b],g=d.nodeType;if(!(g==j.ELEMENT_NODE&&d.getAttribute("_ke_bookmark"))&&(g==j.ELEMENT_NODE&&!h._4e_isEmptyInlineRemovable(d)||g==h.NodeType.TEXT_NODE&&a.trim(d.nodeValue)))return!1}return!0},_4e_moveChildren:function(f,b,a){b=i(b);if(f!=b)if(a)for(;a=f.lastChild;)b.insertBefore(f.removeChild(a),b.firstChild);else for(;a=f.firstChild;)b.appendChild(f.removeChild(a))},_4e_mergeSiblings:function(f){f=new m(f);w[f.nodeName()]&&(r(f,!0),r(f))},_4e_splitText:function(f,
b){var a=f.ownerDocument;if(f.nodeType==h.NodeType.TEXT_NODE){if(q.ie&&b==f.nodeValue.length){var d=a.createTextNode("");h.insertAfter(d,f);return d}d=f.splitText(b);a.documentMode&&(a=a.createTextNode(""),h.insertAfter(a,d),h.remove(a));return d}},_4e_parents:function(f,b){var a=[];a.__IS_NODELIST=1;do a[b?"push":"unshift"](f);while(f=f.parentNode);return a},_4e_nextSourceNode:function(f,b,a,d){if(d&&!d.call)var g=i(d),d=function(b){return b!==g};var b=!b&&f.firstChild,c=f;if(!b){if(f.nodeType==
j.ELEMENT_NODE&&d&&!1===d(f,!0))return null;b=f.nextSibling}for(;!b&&(c=c.parentNode);){if(d&&!1===d(c,!0))return null;b=c.nextSibling}return!b||d&&!1===d(b)?null:a&&a!=b.nodeType?h._4e_nextSourceNode(b,!1,a,d):b},_4e_previousSourceNode:function(a,b,e,d){if(d&&!d.call)var g=i(d),d=function(b){return b!==g};var b=!b&&a.lastChild,c=a;if(!b){if(a.nodeType==j.ELEMENT_NODE&&d&&!1===d(a,!0))return null;b=a.previousSibling}for(;!b&&(c=c.parentNode);){if(d&&!1===d(c,!0))return null;b=c.previousSibling}return!b||
d&&!1===d(b)?null:e&&b.nodeType!=e?h._4e_previousSourceNode(b,!1,e,d):b},_4e_commonAncestor:function(a,b){b=i(b);if(a===b)return a;if(h.contains(b,a))return b;var e=a;do if(h.contains(e,b))return e;while(e=e.parentNode);return null},_4e_hasAttributes:9>t.ieEngine?function(a){for(var b=a.attributes,h=0;h<b.length;h++){var d=b[h];switch(d.name){case "class":if(a.getAttribute("class"))return!0;break;default:if(d.specified)return!0}}return!1}:function(a){q.gecko&&a.removeAttribute("_moz_dirty");return a.hasAttributes()},
_4e_position:function(a,b){var e=i(b);if(a.compareDocumentPosition)return a.compareDocumentPosition(e);if(a==e)return n.POSITION_IDENTICAL;if(a.nodeType==j.ELEMENT_NODE&&e.nodeType==j.ELEMENT_NODE){if(h.contains(a,e))return n.POSITION_CONTAINS+n.POSITION_PRECEDING;if(h.contains(e,a))return n.POSITION_IS_CONTAINED+n.POSITION_FOLLOWING;if("sourceIndex"in a)return 0>a.sourceIndex||0>e.sourceIndex?n.POSITION_DISCONNECTED:a.sourceIndex<e.sourceIndex?n.POSITION_PRECEDING:n.POSITION_FOLLOWING}for(var d=
h._4e_address(a),e=h._4e_address(e),g=Math.min(d.length,e.length),c=0;c<=g-1;c++)if(d[c]!=e[c])return d[c]<e[c]?n.POSITION_PRECEDING:n.POSITION_FOLLOWING;return d.length<e.length?n.POSITION_CONTAINS+n.POSITION_PRECEDING:n.POSITION_IS_CONTAINED+n.POSITION_FOLLOWING},_4e_address:function(a,b){for(var e=[],d=a.ownerDocument.documentElement,g=a;g&&g!=d;)e.unshift(h._4e_index(g,b)),g=g.parentNode;return e},_4e_remove:function(a,b){var e=a.parentNode;if(e){if(b)for(var d;d=a.firstChild;)e.insertBefore(a.removeChild(d),
a);e.removeChild(a)}return a},_4e_trim:function(a){h._4e_ltrim(a);h._4e_rtrim(a)},_4e_ltrim:function(a){for(var b;b=a.firstChild;){if(b.nodeType==h.NodeType.TEXT_NODE){var e=t.ltrim(b.nodeValue),d=b.nodeValue.length;if(e)e.length<d&&(h._4e_splitText(b,d-e.length),a.removeChild(a.firstChild));else{a.removeChild(b);continue}}break}},_4e_rtrim:function(a){for(var b;b=a.lastChild;){if(b.type==h.NodeType.TEXT_NODE){var e=t.rtrim(b.nodeValue),d=b.nodeValue.length;if(e)e.length<d&&(h._4e_splitText(b,e.length),
a.removeChild(a.lastChild));else{a.removeChild(b);continue}}break}!q.ie&&!q.opera&&(b=a.lastChild)&&1==b.nodeType&&"br"==h.nodeName(b)&&a.removeChild(b)},_4e_appendBogus:function(f){for(var b=f.lastChild;b&&b.nodeType==h.NodeType.TEXT_NODE&&!a.trim(b.nodeValue);)b=b.previousSibling;if(!b||b.nodeType==h.NodeType.TEXT_NODE||"br"!==h.nodeName(b))b=q.opera?f.ownerDocument.createTextNode(""):f.ownerDocument.createElement("br"),q.gecko&&b.setAttribute("type","_moz"),f.appendChild(b)},_4e_outerHtml:function(a){if(a.outerHTML)return a.outerHTML.replace(/<\?[^>]*>/,
"");var b=a.ownerDocument.createElement("div");b.appendChild(a.cloneNode(!0));return b.innerHTML},_4e_setMarker:function(f,b,e,d){var f=new m(f),g=f.data("list_marker_id")||f.data("list_marker_id",a.guid()).data("list_marker_id"),c=f.data("list_marker_names")||f.data("list_marker_names",{}).data("list_marker_names");b[g]=f;c[e]=1;return f.data(e,d)},_4e_clearMarkers:function(a,b,e){var a=new m(a),d=a.data("list_marker_names"),g=a.data("list_marker_id"),c;for(c in d)a.removeData(c);a.removeData("list_marker_names");
e&&(a.removeData("list_marker_id"),delete b[g])},_4e_copyAttributes:function(a,b,e){for(var b=new m(b),d=a.attributes,e=e||{},g=0;g<d.length;g++){var c=d[g],l=c.name.toLowerCase(),s;if(!(l in e))if("checked"==l&&(s=h.attr(a,l)))b.attr(l,s);else if(c.specified||q.ie&&c.value&&"value"==l)s=h.attr(a,l),null===s&&(s=c.nodeValue),b.attr(l,s)}""!==a.style.cssText&&(b[0].style.cssText=a.style.cssText)},_4e_isEditable:function(a){a=h.nodeName(a);return(a=!e.$nonEditable[a]&&(e[a]||e.span))&&a["#text"]},_4e_getByAddress:function(a,
b,e){for(var a=a.documentElement,d=0;a&&d<b.length;d++){var g=b[d];if(e)for(var c=-1,l=0;l<a.childNodes.length;l++){var s=a.childNodes[l];if(!(!0===e&&3==s.nodeType&&s.previousSibling&&3==s.previousSibling.nodeType)&&(c++,c==g)){a=s;break}}else a=a.childNodes[g]}return a}})},{requires:["./base","./utils"]});
KISSY.add("editor/core/domIterator",function(a){function k(a){1>arguments.length||(this.range=a,this.forceBrBreak=r,this.enlargeBr=t,this.enforceRealBlocks=r,this._||(this._={}))}var t=!0,r=!1,o=a.Editor,e=a.UA,h=o.Walker,j=o.Range,q=o.RANGE,m=o.ElementPath,w=a.Node,n=a.DOM,x=/^[\r\n\t ]*$/;a.augment(k,{getNextParagraph:function(k){var i,f,b,u,d;if(!this._.lastNode){f=this.range.clone();f.shrink(q.SHRINK_ELEMENT,t);f.enlarge(this.forceBrBreak||!this.enlargeBr?q.ENLARGE_LIST_ITEM_CONTENTS:q.ENLARGE_BLOCK_CONTENTS);
var g=new h(f),c=h.bookmark(t,t);g.evaluator=c;this._.nextNode=g.next();g=new h(f);g.evaluator=c;g=g.previous();this._.lastNode=g._4e_nextSourceNode(t);this._.lastNode&&this._.lastNode[0].nodeType==n.NodeType.TEXT_NODE&&!a.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()&&(c=new j(f.document),c.moveToPosition(this._.lastNode,q.POSITION_AFTER_END),c.checkEndOfBlock()&&(c=new m(c.endContainer),this._.lastNode=(c.block||c.blockLimit)._4e_nextSourceNode(t)));this._.lastNode||
(this._.lastNode=this._.docEndMarker=new w(f.document.createTextNode("")),n.insertAfter(this._.lastNode[0],g[0]));f=null}c=this._.nextNode;g=this._.lastNode;for(this._.nextNode=null;c;){var l=r,s=c[0].nodeType!=n.NodeType.ELEMENT_NODE,A=r;if(s)c[0].nodeType==n.NodeType.TEXT_NODE&&x.test(c[0].nodeValue)&&(s=r);else{var C=c.nodeName();if(c._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if("br"==C)s=t;else if(!f&&!c[0].childNodes.length&&"hr"!=C){i=c;b=c.equals(g);break}f&&(f.setEndAt(c,q.POSITION_BEFORE_START),
"br"!=C&&(this._.nextNode=c));l=t}else{if(c[0].firstChild){f||(f=new j(this.range.document),f.setStartAt(c,q.POSITION_BEFORE_START));c=new w(c[0].firstChild);continue}s=t}}s&&!f&&(f=new j(this.range.document),f.setStartAt(c,q.POSITION_BEFORE_START));b=(!l||s)&&c.equals(g);if(f&&!l)for(;!c[0].nextSibling&&!b;){C=c.parent();if(C._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){l=t;b||C.equals(g);break}c=C;s=t;b=c.equals(g);A=t}s&&f.setEndAt(c,q.POSITION_AFTER_END);c=c._4e_nextSourceNode(A,null,g);if((b=
!c)||l&&f)break}if(!i){if(!f)return this._.docEndMarker&&this._.docEndMarker._4e_remove(),this._.nextNode=null;i=new m(f.startContainer);c=i.blockLimit;l={div:1,th:1,td:1};i=i.block;if((!i||!i[0])&&!this.enforceRealBlocks&&l[c.nodeName()]&&f.checkStartOfBlock()&&f.checkEndOfBlock())i=c;else if(!i||this.enforceRealBlocks&&"li"==i.nodeName())i=new w(this.range.document.createElement(k||"p")),i[0].appendChild(f.extractContents()),i._4e_trim(),f.insertNode(i),u=d=t;else if("li"!=i.nodeName()){if(!f.checkStartOfBlock()||
!f.checkEndOfBlock())i=i.clone(r),i[0].appendChild(f.extractContents()),i._4e_trim(),d=f.splitBlock(),u=!d.wasStartOfBlock,d=!d.wasEndOfBlock,f.insertNode(i)}else b||(this._.nextNode=i.equals(g)?null:f.getBoundaryNodes().endNode._4e_nextSourceNode(t,null,g))}u&&(f=new w(i[0].previousSibling),f[0]&&f[0].nodeType==n.NodeType.ELEMENT_NODE&&("br"==f.nodeName()?f._4e_remove():f[0].lastChild&&"br"==n.nodeName(f[0].lastChild)&&n._4e_remove(f[0].lastChild)));d&&(f=h.bookmark(r,t),u=new w(i[0].lastChild),
u[0]&&u[0].nodeType==n.NodeType.ELEMENT_NODE&&"br"==u.nodeName()&&(e.ie||u.prev(f,1)||u.next(f,1))&&u.remove());this._.nextNode||(this._.nextNode=b||i.equals(g)?null:i._4e_nextSourceNode(t,null,g));return i}});j.prototype.createIterator=function(){return new k(this)};return k},{requires:["./base","./range","./elementPath","./walker"]});
KISSY.add("editor/core",function(a,k,t,r,o,e,h,j,q,m){function w(a,b){var c=a.body;D(function(){a.designMode="on";setTimeout(function(){a.designMode="off";c.focus();arguments.callee.retry||(arguments.callee.retry=f)},50)},function(){a.designMode="off";s.attr(c,"contentEditable",d);s.attr(c,"contentEditable",f);!b&&w(a,1)})}function n(b){b.get("iframe");var p=b.get("textarea")[0],g=b.get("window")[0],f=b.get("document")[0];c.webkit&&(z.on(f,"click",function(b){var c=new C(b.target);a.inArray(c.nodeName(),
["input","select"])&&b.preventDefault()}),z.on(f,"mouseup",function(b){var c=new C(b.target);a.inArray(c.nodeName(),["input","textarea"])&&b.preventDefault()}));if(c.gecko||l||c.opera){var e;e=(new C('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>')).insertAfter(p);e.on("focus",function(){b.focus()});b.activateGecko=function(){c.gecko&&b.__iframeFocus&&e[0].focus()};b.on("destroy",function(){e.detach();e.remove()})}z.on(g,"focus",function(){c.gecko?w(f,d):c.opera&&
f.body.focus();b.notifySelectionChange()});if(c.gecko)z.on(f,"mousedown",function(){b.__iframeFocus||w(f,d)});if(l&&(z.on(f,"keydown",function(a){if(a.keyCode in{8:1,46:1}){var c=b.getSelection(),d=c.getSelectedElement();if(d){b.execCommand("save");var p=c.getRanges()[0].createBookmark();d.remove();c.selectBookmarks([p]);b.execCommand("save");a.preventDefault()}}}),"CSS1Compat"==f.compatMode)){var y={33:1,34:1};z.on(f,"keydown",function(a){a.keyCode in y&&setTimeout(function(){b.getSelection().scrollIntoView()},
0)})}if(c.webkit)z.on(f,"mousedown",function(c){c=new C(c.target);a.inArray(c.nodeName(),["img","hr","input","textarea","select"])&&b.getSelection().selectElement(c)});if(c.gecko)z.on(f,"dragstart",function(a){var b=new C(a.target);b.nodeName()==="img"&&/ke_/.test(b[0].className)&&a.preventDefault()});r.add(b)}function x(b,c,d,l){var f="",e,y=t.debugUrl("theme/editor-iframe.css");for(e=0;e<d.length;e++)f+=a.substitute('<link href="{href}" rel="stylesheet" />',{href:d[e]});return a.substitute(p,{doctype:8===
g.documentMode?'<meta http-equiv="X-UA-Compatible" content="IE=7" />':"",title:"${title}",href:y,style:c,data:l||"&nbsp;",script:b?'<script id="ke_active_script">'+(s.isCustomDomain()?'document.domain="'+g.domain+'";':"")+'parent.KISSY.Editor._initIFrame("'+b+'");<\/script>':""})}function v(a,b){function c(){e=f.document;a.setInternal("document",new C(e));a.setInternal("window",new C(f));d.detach();e.open("text/html","replace");e.write(p);e.close()}var d=a.get("iframe"),p=x(a._UUID,a.get("customStyle"),
a.get("customLink"),b),g=d[0],f=g.contentWindow,e;d.__loaded=1;try{e=f.document}catch(y){if(g.src=g.src,7>l){setTimeout(c,10);return}}c()}function i(b,d){var p=s.getEmptyIframeSrc()||"";p&&(p=' src="'+p+'" ');var p=new C(a.substitute(F,{iframeSrc:p})),g=b.get("textarea");g.hasAttr("tabindex")&&p.attr("tabindex",c.webkit?-1:g.attr("tabindex"));g.parent().prepend(p);b.set("iframe",p);b.__docReady=0;if(c.gecko&&!p.__loaded)p.on("load",function(){v(b,d)},b);else v(b,d)}var f=!0,b=b,u=a.all,d=!1,g=document,
c=a.UA,l=c.ie,s=a.DOM,A=s.NodeType,C=a.Node,z=a.Event,D=t.tryThese,p='<!doctype html><html><head>{doctype}<title>{title}</title><link href="{href}" rel="stylesheet" /><style>{style}</style>{links}</head><body class="ks-editor" >{data}{script}</body></html>',F='<iframe style="width:100%;height:100%;border:none;"  frameborder="0"  title="kissy-editor"  allowTransparency="true"  {iframeSrc} ></iframe>',y='<div class="{prefixCls}editor-tools"></div><div class="{prefixCls}editor-textarea-wrap" '+(c.mobile?
'style="overflow:scroll;-webkit-overflow-scrolling:touch;"':"")+'></div><div class="{prefixCls}editor-status"></div>';a.mix(k,{SOURCE_MODE:0,WYSIWYG_MODE:1});var I=k.WYSIWYG_MODE;a.augment(k,{createDom:function(){var b,c=this.get("prefixCls"),d=this.get("textarea"),p;d?(this.set("textarea",d=u(d)),d[0].parentNode&&d.remove()):(b=this.get("data"),this.set("textarea",d=u('<textarea class="'+c+'-editor-textarea"></textarea>')),d.val(b));p=this.get("el");p.html(a.substitute(y,{prefixCls:c}));b=p.one(a.substitute(".{prefixCls}editor-textarea-wrap",
{prefixCls:c}));this._UUID=a.guid();this.set({toolBarEl:p.one(a.substitute(".{prefixCls}editor-tools",{prefixCls:c})),statusBarEl:p.one(a.substitute(".{prefixCls}editor-status",{prefixCls:c}))},{silent:1});d.css("width","100%");d.css("display","none");b.append(d);r.register(this)},renderUI:function(){h.init(this);j.init(this);q.init(this);m.init(this)},bindUI:function(){function a(){b.detach("docReady",a);if(b.get("focused"))b.focus();else{var c=b.getSelection();c&&c.removeAllRanges()}}var b=this,
c,d=b.get("prefixCls"),p=b.get("textarea");if(b.get("attachForm")&&(c=p[0].form))z.on(c,"submit",b.sync,b);b.on("docReady",a);b.on("blur",function(){b.get("el").removeClass(d+"editor-focused")});b.on("focus",function(){b.get("el").addClass(d+"editor-focused")})},syncUI:function(){this.get("rendered")&&this.get("textarea").val(this.get("data"))},_onSetHeight:function(a){var b=this.get("textarea"),c=this.get("toolBarEl"),d=this.get("statusBarEl"),a=parseInt(a,10),a=a-((c&&c.outerHeight()||0)+(d&&d.outerHeight()||
0));b.parent().css("height",a);b.css("height",a)},_onSetMode:function(a){this.get("rendered");var b=this.get("iframe"),c=this.get("textarea");a==I?(this._setData(c.val()),c.hide(),this.fire("wysiwygMode")):(b&&(c.val(this._getData(1,I)),b.hide()),c.show(),this.fire("sourceMode"))},_onSetFocused:function(a){a&&this.__docReady&&this.focus()},_onSetData:function(a){this.get("rendered")&&this._setData(a)},destructor:function(){var b,c=this.get("textarea"),d=this.get("document")[0],p=this.get("window");
this.get("attachForm")&&(b=c[0].form)&&z.detach(b,"submit",this.sync,this);r.remove(this);z.remove([d,d.documentElement,d.body,p[0]]);a.each(this.__controls,function(a){a.destroy&&a.destroy()});this.__commands={};this.__controls={}},getControl:function(a){return this.__controls[a]},getControls:function(){return this.__controls},addControl:function(a,b){this.__controls[a]=b},showDialog:function(a,b){var a=a+"/dialog",c=this.__controls[a];c.show(b);this.fire("dialogShow",{dialog:c.dialog,pluginDialog:c,
dialogName:a})},addCommand:function(a,b){this.__commands[a]=b},hasCommand:function(a){return this.__commands[a]},execCommand:function(c){var d=this.__commands[c],p=a.makeArray(arguments);p.shift();p.unshift(this);return d?d.exec.apply(d,p):b},queryCommandValue:function(a){return this.execCommand(t.getQueryCmd(a))},_getData:function(c,d){var p=this.htmlDataProcessor,g;if(!this.get("rendered"))return b;d==b&&(d=this.get("mode"));g=d==I&&this.isDocReady()?this.get("document")[0].body.innerHTML:p.toDataFormat(this.get("textarea").val());
g=c?p.toHtml(g):p.toServer(g);g=a.trim(g);/^(?:<(p)>)?(?:(?:&nbsp;)|\s)*(?:<\/\1>)?$/.test(g)&&(g="");return g},_setData:function(a){var b,c=a;if(this.get("mode")!=I)this.get("textarea").val(a);else{if(b=this.htmlDataProcessor)c=b.toDataFormat(a);if(this.get("iframe")){a=this.get("iframe");b=this.get("window")[0];var d=this.get("document")[0];z.remove([d,d.documentElement,d.body,b]);a.remove()}i(this,c)}},getDocHtml:function(){return x(0,this.get("customStyle"),this.get("customLink"),this.get("formatData"))},
getSelection:function(){return k.Selection.getSelection(this.get("document")[0])},getSelectedHtml:function(){var a=this.getSelection().getRanges()[0],b;a&&(a=a.cloneContents(),b=this.get("document")[0].createElement("div"),b.appendChild(a),b=b.innerHTML);return b},focus:function(){var a=this.get("window");if(a){var b=this.get("document")[0],a=a[0];c.ie||a&&a.parent&&a.parent.focus();a&&a.focus();try{b.body.focus()}catch(d){}this.notifySelectionChange()}},blur:function(){this.get("window")[0].blur();
this.get("document")[0].body.blur()},addCustomStyle:function(a,b){var c=this.get("window"),d=this.get("customStyle")||"";this.set("customStyle",d+("\n"+a));c&&s.addStyleSheet(c,a,b)},removeCustomStyle:function(a){s.remove(s.get("#"+a,this.get("window")[0]))},addCustomLink:function(a){var b=this.get("customLink")||[],c=this.get("document")[0];b.push(a);this.set("customLink",b);b=c.createElement("link");b.rel="stylesheet";c.getElementsByTagName("head")[0].appendChild(b);b.href=a},removeCustomLink:function(b){for(var c=
this.get("document")[0],c=s.query("link",c),d=0;d<c.length;d++)s.attr(c[d],"href")==b&&s.remove(c[d]);c=this.get("customLink")||[];b=a.indexOf(b,c);-1!=b&&c.splice(b,1)},docReady:function(a){this.on("docReady",a);this.__docReady&&a.call(this)},isDocReady:function(){return this.__docReady},checkSelectionChange:function(){var a=this;a.__checkSelectionChangeId&&clearTimeout(a.__checkSelectionChangeId);a.__checkSelectionChangeId=setTimeout(function(){var b=a.getSelection();if(b&&!b.isInvalid){var c=b.getStartElement(),
d=new k.ElementPath(c);if(!a.__previousPath||!a.__previousPath.compare(d))a.__previousPath=d,a.fire("selectionChange",{selection:b,path:d,element:c})}},100)},notifySelectionChange:function(){this.__previousPath=null;this.checkSelectionChange()},insertElement:function(a){if(this.get("mode")!==I)return b;this.focus();var c,d=a.nodeName(),p=k.XHTML_DTD,g=p.$block[d],l=k.RANGE,e=(d=this.getSelection())&&d.getRanges(),y,F,s;if(!e||0==e.length)return b;this.execCommand("save");for(F=e.length-1;0<=F;F--)y=
e[F],c=!F&&a||a.clone(f),y.insertNodeByDtd(c),s||(s=c);if(!s)return b;y.moveToPosition(s,l.POSITION_AFTER_END);g&&(a=k.Walker.whitespaces(!0),(a=(s=s.next(a,1))&&s[0].nodeType==A.ELEMENT_NODE&&s.nodeName())&&p.$block[a]&&p[a]["#text"]&&y.moveToElementEditablePosition(s));d.selectRanges([y]);this.focus();c&&1==c[0].nodeType&&c.scrollIntoView(b,{alignWithTop:!1,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0});G.call(this);return c},insertHtml:function(a,c){var p=this,g,e=p.get("document")[0];if(p.get("mode")===
I){if(g=p.htmlDataProcessor)a=g.toDataFormat(a,c);p.focus();p.execCommand("save");if(l){g=e.selection;"Control"==g.type&&g.clear();try{g.createRange().pasteHTML(a)}catch(f){}}else try{e.execCommand("inserthtml",d,a)}catch(y){setTimeout(function(){if(0==p.getSelection().getRanges().length){var c=new k.Range(e),g=s.first(e.body,function(a){return 1==a.nodeType&&"br"!=s.nodeName(a)});g||(g=new C(e.createElement("p")),g._4e_appendBogus(b),e.body.appendChild(g[0]));c.setStartAt(g,k.RANGE.POSITION_AFTER_START);
c.select()}e.execCommand("inserthtml",d,a)},50)}setTimeout(function(){p.getSelection().scrollIntoView()},50);G.call(p)}}});k._initIFrame=function(a){var b=r.getInstance(a),p=b.get("document")[0],a=p.getElementById("ke_active_script");s.remove(a);n(b);var g=p.body;l?(g.hideFocus=f,g.disabled=f,g.contentEditable=f,g.removeAttribute("disabled")):setTimeout(function(){c.gecko||c.opera?g.contentEditable=f:c.webkit?g.parentNode.contentEditable=f:p.designMode="on"},0);if(c.gecko||c.opera){var e=p.documentElement;
z.on(e,"mousedown",function(a){if(a.target==e){c.gecko&&w(p,d);b.activateGecko()}})}setTimeout(function(){l&&setTimeout(function(){if(p){g.runtimeStyle.marginBottom="0px";g.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){b.__docReady=1;b.fire("docReady");var a=b.get("disableObjectResizing"),c=b.get("disableInlineTableEditing");if(a||c)try{p.execCommand("enableObjectResizing",d,!a);p.execCommand("enableInlineTableEditing",d,!c)}catch(e){z.on(g,l?"resizestart":"resize",function(b){var d=
new C(b.target);(a||d.nodeName()==="table"&&c)&&b.preventDefault()})}},10)};var G=a.buffer(function(){this.execCommand("save")},50);return k},{requires:"editor/core/base,editor/core/utils,editor/core/focusManager,editor/core/styles,editor/core/zIndexManager,editor/core/clipboard,editor/core/enterKey,editor/core/htmlDataProcessor,editor/core/selectionFix".split(",")});
KISSY.add("editor/core/elementPath",function(a){function k(a){for(var m=e,k=e,n=[];a;){if(a[0].nodeType==r.NodeType.ELEMENT_NODE){this.lastElement||(this.lastElement=a);var x=a.nodeName();if(!k&&(!m&&h[x]&&(m=a),j[x])){var v;if(v=!m)if(v="div"==x){a:{v=a[0].childNodes;for(var i=0,f=v.length;i<f;i++){var b=v[i];if(b.nodeType==r.NodeType.ELEMENT_NODE&&o.$block[b.nodeName.toLowerCase()]){v=!0;break a}}v=!1}v=!v}v?m=a:k=a}n.push(a);if("body"==x)break}a=a.parent()}this.block=m;this.blockLimit=k;this.elements=
n}var t=a.Editor,r=a.DOM,o=t.XHTML_DTD,e=null,h={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},j={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};k.prototype={constructor:k,compare:function(a){var e=this.elements,a=a&&a.elements;if(!a||e.length!=a.length)return!1;for(var h=0;h<e.length;h++)if(!r.equals(e[h],a[h]))return!1;return!0},contains:function(a){for(var h=this.elements,j=0;j<h.length;j++)if(h[j].nodeName()in a)return h[j];return e},toString:function(){var a=
this.elements,e,h=[];for(e=0;e<a.length;e++)h.push(a[e].nodeName());return h.toString()}};return t.ElementPath=k},{requires:["./base","./dom"]});
KISSY.add("editor/core/enterKey",function(a,k,t,r){function o(e){var k;k=e.getSelection().getRanges();for(var o=k.length-1;0<o;o--)k[o].deleteContents();k=k[0];o=k.document;if(k.checkStartOfBlock()&&k.checkEndOfBlock()){var i=(new r(k.startContainer)).block;if(i&&("li"==i.nodeName()||"li"==i.parent().nodeName()))return e.hasCommand("outdent")?(e.execCommand("save"),e.execCommand("outdent"),e.execCommand("save"),!0):!1}var f=k.splitBlock("p");if(!f)return!0;var e=f.previousBlock,i=f.nextBlock,b=f.wasStartOfBlock,
u=f.wasEndOfBlock,d;if(i)d=i.parent(),"li"==d.nodeName()&&(i._4e_breakParent(d),i._4e_move(i.next(),!0));else if(e&&(d=e.parent())&&"li"==d.nodeName())e._4e_breakParent(d),k.moveToElementEditablePosition(e.next()),e._4e_move(e.prev());if(!b&&!u){if("li"==i.nodeName()&&(d=i.first(t.invisible(!0)))&&a.inArray(d.nodeName(),["ul","ol"]))(h.ie?new m(o.createTextNode("\u00a0")):new m(o.createElement("br"))).insertBefore(d);i&&k.moveToElementEditablePosition(i)}else{var g;if(e){if("li"==e.nodeName()||!j.test(e.nodeName()))g=
e.clone()}else i&&(g=i.clone());g||(g=new m("<p>",null,o));if(d=f.elementPath)for(var f=0,c=d.elements.length;f<c;f++){var l=d.elements[f];if(l.equals(d.block)||l.equals(d.blockLimit))break;q.$removeEmpty[l.nodeName()]&&(l=l.clone(),g._4e_moveChildren(l),g.append(l))}h.ie||g._4e_appendBogus();k.insertNode(g);if(h.ie&&b&&(!u||!e[0].childNodes.length))k.moveToElementEditablePosition(u?e:g),k.select();k.moveToElementEditablePosition(b&&!u?i:g)}h.ie||(i?(g=new m(o.createElement("span")),g.html("&nbsp;"),
k.insertNode(g),g.scrollIntoView(void 0,{alignWithTop:!1,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0}),k.deleteContents()):g.scrollIntoView(void 0,{alignWithTop:!1,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0}));k.select();return!0}function e(a){var e=a.get("document")[0];w.on(e,"keydown",function(e){if(13===e.keyCode&&!e.shiftKey&&!e.ctrlKey&&!e.metaKey){a.execCommand("save");var h=a.execCommand("enterBlock");a.execCommand("save");!1!==h&&e.preventDefault()}})}var h=a.UA,j=/^h[1-6]$/,q=k.XHTML_DTD,
m=a.Node,w=a.Event;return{init:function(a){a.addCommand("enterBlock",{exec:o});a.docReady(function(){e(a)})}}},{requires:["./base","./walker","./elementPath"]});
KISSY.add("editor/core/focusManager",function(a){function k(){var a=this;a.__iframeFocus=q;j=a;h&&clearTimeout(h);h=setTimeout(function(){a.fire("focus")},100)}function t(){var a=this;a.__iframeFocus=m;j=w;h&&clearTimeout(h);h=setTimeout(function(){a.fire("blur")},100)}var r=a.Editor,o=a.Event,e={},h,j,a={refreshAll:function(){for(var a in e){var h=e[a].get("document")[0];h.designMode="off";h.designMode="on"}},currentInstance:function(){return j},getInstance:function(a){return e[a]},add:function(a){var e=
a.get("window")[0];o.on(e,"focus",k,a);o.on(e,"blur",t,a)},register:function(a){e[a._UUID]=a},remove:function(a){delete e[a._UUID];var h=a.get("window")[0];o.remove(h,"focus",k,a);o.remove(h,"blur",t,a)}},q=!0,m=!1,w=null;a.refreshAll=a.refreshAll;r.focusManager=a;r.getInstances=function(){return e};return a},{requires:["./base","./dom"]});
KISSY.add("editor/core/htmlDataProcessor",function(a,k){return{init:function(t){function r(a){if((a.getAttribute("class")+"").match(/Apple-\w+-span/)||!a.attributes.length)a.setTagName(null);else if(!a.childNodes.length&&!a.attributes.length)return!1}function o(a){return a.replace(x,function(a,b,c){return"<"+b+c.replace(v,function(a,b){return-1==c.indexOf("_ke_saved_"+b)?" _ke_saved_"+a+" "+a:a})+">"})}function e(a){return a.replace(f,function(a){return"<ke:encoded>"+encodeURIComponent(a)+"</ke:encoded>"})}
function h(c){return c.replace(b,function(b,c){return a.urlDecode(c)})}var j=a.Node,q=a.UA,m=a.require("htmlparser"),w=new m.Filter,n=new m.Filter;(function(){function b(a){a=m.serialize(a);return new m.Comment(i+encodeURIComponent(a).replace(/--/g,"%2D%2D"))}var d={tagNames:[[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],attributeNames:[[/^on/,"ke_on"],[/^lang$/,""]],tags:{script:b,noscript:b,span:r}},g={tagNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],tags:{$:function(a){if(a.attributes.length)for(var b=
["name","href","src"],c,d=0;d<b.length;d++)c="_ke_saved_"+b[d],a.getAttribute(c)&&a.removeAttribute(b[d]);return a},embed:function(a){var b=a.parentNode;if(b&&"object"==b.nodeName){var c=b.getAttribute("width"),b=b.getAttribute("height");c&&a.setAttribute("width",c);b&&a.setAttribute("width",b)}},a:function(a){if(!a.childNodes.length&&!a.attributes.length)return!1},span:r},attributes:{style:function(b){if(!a.trim(b))return!1}},attributeNames:[[/^_ke_saved_/,""],[/^ke_on/,"on"],[/^_ke.*/,""],[/^ke:.*$/,
""],[/^_ks.*/,""]],text:function(a){if(q.webkit)return a.replace(/\u200b/g,"")},comment:function(b){if(b.substr(0,i.length)==i)return b=a.trim(a.urlDecode(b.substr(i.length))),m.parse(b).childNodes[0]}};q.ie&&(g.attributes.style=function(a){return a.replace(/(^|;)([^:]+)/g,function(a){return a.toLowerCase()})});w.addRules(g);n.addRules(d)})();(function(){function b(c){for(var c=c.childNodes,d=c.length,p=c[d-1];p&&3==p.nodeType&&!a.trim(p.nodeValue);)p=c[--d];return p}function d(a,p){var g=b(a);g&&
((p||!q.ie)&&1==g.nodeType&&"br"==g.nodeName?a.removeChild(g):3==g.nodeType&&h.test(g.nodeValue)&&a.removeChild(g))}function g(a){var d=b(a);return!d||1==d.nodeType&&"br"==d.nodeName||"form"==a.nodeName&&"input"==d.nodeName}function e(a){d(a,!0);g(a)&&(q.ie?a.appendChild(new m.Text("\u00a0")):(a.appendChild(new m.Text("&nbsp;")),a.appendChild(new m.Tag("br"))))}function f(a){d(a,!1);g(a)&&a.appendChild(new m.Text("\u00a0"))}var h=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,i=k.XHTML_DTD,p=a.merge(i.$block,i.$listItem,i.$tableContent),
F;for(F in p)"br"in i[F]||delete p[F];delete p.td;delete p.pre;var i={tags:{}},y={tags:{}};for(F in p)i.tags[F]=e,y.tags[F]=f;n.addRules(i);w.addRules(y)})();w.addRules({text:function(a){return a.replace(/\xa0/g,"&nbsp;")}});var x=/<(a|area|img|input)\b([^>]*)>/gi,v=/\b(href|src|name)\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|(?:[^ "'>]+))/gi,i="{ke_protected}",f=/(?:<textarea[^>]*>[\s\S]*<\/textarea>)|(?:<style[^>]*>[\s\S]*<\/style>)|(?:<(:?link|meta|base)[^>]*>)/gi,b=/<ke:encoded>([^<]*)<\/ke:encoded>/gi,
u=/(<\/?)((?:object|embed|param|html|body|head|title|script|noscript)[^>]*>)/gi,d=/(<\/?)ke:((?:object|embed|param|html|body|head|title|script|noscript)[^>]*>)/gi,g=/<ke:(param|embed)([^>]*?)\/?>(?!\s*<\/ke:\1)/gi;t.htmlDataProcessor={dataFilter:n,htmlFilter:w,toHtml:function(a){var b=new m.BeautifyWriter;(new m.Parser(a)).parse().writeHtml(b,w);return a=b.getHtml()},toDataFormat:function(a,b){var b=b||n,a=e(a),a=o(a),a=a.replace(u,"$1ke:$2"),a=a.replace(g,"<ke:$1$2></ke:$1>"),f=new j("<div>");f.html("a"+
a);a=f.html().substr(1);a=a.replace(d,"$1$2");a=h(a);f=new m.BasicWriter;(new m.Parser(a)).parse().writeHtml(f,b);return a=f.getHtml()},toServer:function(a){var b=new m.MinifyWriter;(new m.Parser(a)).parse().writeHtml(b,w);return b.getHtml()}}}}},{requires:["./base"]});
(function(a){a({"editor/plugin/back-color":{requires:["editor","editor/plugin/color/btn"]}});a({"editor/plugin/back-color/cmd":{requires:["editor/plugin/color/cmd"]}});a({"editor/plugin/bold":{requires:["editor","editor/plugin/font/ui"]}});a({"editor/plugin/bold/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/bubble":{requires:["overlay","editor"]}});a({"editor/plugin/button":{requires:["editor","button"]}});a({"editor/plugin/checkbox-source-area":{requires:["editor"]}});a({"editor/plugin/code":{requires:["editor",
"editor/plugin/dialog-loader"]}});a({"editor/plugin/code/dialog":{requires:["editor","editor/plugin/dialog","menubutton"]}});a({"editor/plugin/color/btn":{requires:["editor","editor/plugin/button","editor/plugin/overlay","editor/plugin/dialog-loader"]}});a({"editor/plugin/color/cmd":{requires:["editor"]}});a({"editor/plugin/color/dialog":{requires:["editor","editor/plugin/dialog"]}});a({"editor/plugin/contextmenu":{requires:["editor","menu","editor/plugin/focus-fix"]}});a({"editor/plugin/dent-cmd":{requires:["editor",
"editor/plugin/list-utils"]}});a({"editor/plugin/dialog-loader":{requires:["overlay","editor"]}});a({"editor/plugin/dialog":{requires:["editor","overlay","editor/plugin/focus-fix","dd/plugin/constrain","component/plugin/drag"]}});a({"editor/plugin/draft":{requires:["editor","editor/plugin/local-storage","overlay","editor/plugin/menubutton"]}});a({"editor/plugin/drag-upload":{requires:["editor"]}});a({"editor/plugin/element-path":{requires:["editor"]}});a({"editor/plugin/fake-objects":{requires:["editor"]}});
a({"editor/plugin/flash-bridge":{requires:["swf","editor"]}});a({"editor/plugin/flash-common/base-class":{requires:["editor","editor/plugin/contextmenu","editor/plugin/bubble","editor/plugin/dialog-loader","editor/plugin/flash-common/utils"]}});a({"editor/plugin/flash-common/utils":{requires:["swf"]}});a({"editor/plugin/flash":{requires:["editor","editor/plugin/flash-common/base-class","editor/plugin/flash-common/utils","editor/plugin/fake-objects"]}});a({"editor/plugin/flash/dialog":{requires:["editor",
"editor/plugin/flash-common/utils","editor/plugin/dialog","editor/plugin/menubutton"]}});a({"editor/plugin/focus-fix":{requires:["editor"]}});a({"editor/plugin/font-family":{requires:["editor","editor/plugin/font/ui"]}});a({"editor/plugin/font-family/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/font-size":{requires:["editor","editor/plugin/font/ui"]}});a({"editor/plugin/font-size/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/font/cmd":{requires:["editor"]}});
a({"editor/plugin/font/ui":{requires:["editor","editor/plugin/button","editor/plugin/menubutton"]}});a({"editor/plugin/fore-color":{requires:["editor","editor/plugin/color/btn"]}});a({"editor/plugin/fore-color/cmd":{requires:["editor/plugin/color/cmd"]}});a({"editor/plugin/heading":{requires:["editor"]}});a({"editor/plugin/heading/cmd":{requires:["editor"]}});a({"editor/plugin/image":{requires:["editor","editor/plugin/button","editor/plugin/bubble","editor/plugin/contextmenu","editor/plugin/dialog-loader"]}});
a({"editor/plugin/image/dialog":{requires:["io","editor","editor/plugin/dialog","tabs","editor/plugin/menubutton"]}});a({"editor/plugin/indent":{requires:["editor"]}});a({"editor/plugin/indent/cmd":{requires:["editor","editor/plugin/dent-cmd"]}});a({"editor/plugin/italic":{requires:["editor","editor/plugin/font/ui"]}});a({"editor/plugin/italic/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/justify-center":{requires:["editor"]}});a({"editor/plugin/justify-center/cmd":{requires:["editor/plugin/justify-cmd"]}});
a({"editor/plugin/justify-cmd":{requires:["editor"]}});a({"editor/plugin/justify-left":{requires:["editor"]}});a({"editor/plugin/justify-left/cmd":{requires:["editor/plugin/justify-cmd"]}});a({"editor/plugin/justify-right":{requires:["editor"]}});a({"editor/plugin/justify-right/cmd":{requires:["editor/plugin/justify-cmd"]}});a({"editor/plugin/link":{requires:["editor","editor/plugin/bubble","editor/plugin/dialog-loader","editor/plugin/button"]}});a({"editor/plugin/link/dialog":{requires:["editor",
"editor/plugin/dialog","editor/plugin/link/utils"]}});a({"editor/plugin/link/utils":{requires:["editor"]}});a({"editor/plugin/list-utils":{requires:["editor"]}});a({"editor/plugin/list-utils/btn":{requires:["editor","editor/plugin/button","editor/plugin/menubutton"]}});a({"editor/plugin/list-utils/cmd":{requires:["editor","editor/plugin/list-utils"]}});a({"editor/plugin/local-storage":{requires:["editor","overlay","editor/plugin/flash-bridge"]}});a({"editor/plugin/maximize":{requires:["editor"]}});
a({"editor/plugin/maximize/cmd":{requires:["editor"]}});a({"editor/plugin/menubutton":{requires:["editor","menubutton"]}});a({"editor/plugin/multiple-upload":{requires:["editor","editor/plugin/dialog-loader"]}});a({"editor/plugin/multiple-upload/dialog":{requires:"editor,component/plugin/drag,editor/plugin/progressbar,editor/plugin/dialog,editor/plugin/flash-bridge,editor/plugin/local-storage,swf".split(",")}});a({"editor/plugin/ordered-list":{requires:["editor","editor/plugin/list-utils/btn"]}});
a({"editor/plugin/ordered-list/cmd":{requires:["editor","editor/plugin/list-utils/cmd"]}});a({"editor/plugin/outdent":{requires:["editor"]}});a({"editor/plugin/outdent/cmd":{requires:["editor","editor/plugin/dent-cmd"]}});a({"editor/plugin/overlay":{requires:["editor","overlay","editor/plugin/focus-fix"]}});a({"editor/plugin/page-break":{requires:["editor","editor/plugin/fake-objects"]}});a({"editor/plugin/remove-format":{requires:["editor","editor/plugin/button"]}});a({"editor/plugin/remove-format/cmd":{requires:["editor"]}});
a({"editor/plugin/resize":{requires:["editor","dd/base"]}});a({"editor/plugin/separator":{requires:["editor"]}});a({"editor/plugin/smiley":{requires:["editor","editor/plugin/overlay"]}});a({"editor/plugin/source-area":{requires:["editor","editor/plugin/button"]}});a({"editor/plugin/strike-through":{requires:["editor","editor/plugin/font/ui"]}});a({"editor/plugin/strike-through/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/table":{requires:["editor","editor/plugin/dialog-loader",
"editor/plugin/contextmenu"]}});a({"editor/plugin/table/dialog":{requires:["editor","editor/plugin/dialog","editor/plugin/menubutton"]}});a({"editor/plugin/underline":{requires:["editor","editor/plugin/font/ui"]}});a({"editor/plugin/underline/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/undo":{requires:["editor"]}});a({"editor/plugin/undo/btn":{requires:["editor","editor/plugin/button"]}});a({"editor/plugin/undo/cmd":{requires:["editor"]}});a({"editor/plugin/unordered-list":{requires:["editor",
"editor/plugin/list-utils/btn"]}});a({"editor/plugin/unordered-list/cmd":{requires:["editor","editor/plugin/list-utils/cmd"]}});a({"editor/plugin/video":{requires:["editor","editor/plugin/flash-common/utils","editor/plugin/flash-common/base-class","editor/plugin/fake-objects"]}});a({"editor/plugin/video/dialog":{requires:["editor","editor/plugin/flash/dialog","editor/plugin/menubutton"]}});a({"editor/plugin/word-filter":{requires:["htmlparser"]}});a({"editor/plugin/xiami-music":{requires:["editor",
"editor/plugin/flash-common/base-class","editor/plugin/flash-common/utils","editor/plugin/fake-objects"]}});a({"editor/plugin/xiami-music/dialog":{requires:["editor","editor/plugin/flash/dialog","editor/plugin/menubutton"]}})})(function(a){KISSY.config("modules",a)},KISSY.Features,KISSY.UA);
KISSY.add("editor/core/range",function(a,k,t,r,o){function e(c){var g=c.nodeType!=b.NodeType.TEXT_NODE&&b.nodeName(c)in d.$removeEmpty,e=c.nodeType==b.NodeType.TEXT_NODE&&!a.trim(c.nodeValue),c=!!c.parentNode.getAttribute("_ke_bookmark");return g||e||c}function h(a){return!s(a)&&!A(a)}function j(d){var c=x;return function(g){if(A(g))return n;if(g.nodeType==b.NodeType.TEXT_NODE){if(a.trim(g.nodeValue).length)return x}else if(g.nodeType==b.NodeType.ELEMENT_NODE&&(g=b.nodeName(g),!D[g]))if(!d&&!u.ie&&
"br"==g&&!c)c=n;else return x;return n}}function q(a,d){var c=a.startContainer,e=a.endContainer,f=a.startOffset,l=a.endOffset,h,s=x,i=x,j=void 0,k=a.document,m;0<d&&(j=k.createDocumentFragment());if(a.collapsed)return j;a.optimizeBookmark();e[0].nodeType==b.NodeType.TEXT_NODE?(i=n,e=e._4e_splitText(l)):0<e[0].childNodes.length&&(l>=e[0].childNodes.length?(e=new g(e[0].appendChild(k.createTextNode(""))),m=n):e=new g(e[0].childNodes[l]));c[0].nodeType==b.NodeType.TEXT_NODE?(s=n,c._4e_splitText(f)):
f?f>=c[0].childNodes.length?(c=new g(c[0].appendChild(k.createTextNode(""))),h=n):c=new g(c[0].childNodes[f].previousSibling):(h=new g(k.createTextNode("")),c.prepend(h),c=h,h=n);var H=c._4e_parents(),K=e._4e_parents();H.each(function(a,b){H[b]=a});K.each(function(a,b){K[b]=a});for(var E,N,k=0;k<H.length&&!(E=H[k],N=K[k],!E.equals(N));k++);for(var f=j,B,J,A=k;A<H.length;A++){B=H[A];l=0<d&&!B.equals(c)?f.appendChild(B.clone()[0]):null;B=B[0].nextSibling;J=K[A];for(var q=e[0],u=J&&J[0];B&&!(u==B||q==
B);)J=B.nextSibling,2==d?f.appendChild(B.cloneNode(n)):(b._4e_remove(B),1==d&&f.appendChild(B)),B=J;l&&(f=l)}for(f=j;k<K.length;k++){B=K[k];l=0<d&&!B.equals(e)?f.appendChild(B.clone()[0]):null;if(!H[k]||!B._4e_sameLevel(H[k]))for(B=B[0].previousSibling;B;)J=B.previousSibling,2==d?f.insertBefore(B.cloneNode(n),f.firstChild):(b._4e_remove(B),1==d&&f.insertBefore(B,f.firstChild)),B=J;l&&(f=l)}if(2==d){if(s&&(E=c[0],E.nodeType==b.NodeType.TEXT_NODE&&E.nextSibling&&E.nextSibling.nodeType==b.NodeType.TEXT_NODE&&
(E.data+=E.nextSibling.data,E.parentNode.removeChild(E.nextSibling))),i)i=e[0],i.nodeType==b.NodeType.TEXT_NODE&&i.previousSibling&&i.previousSibling.nodeType==b.NodeType.TEXT_NODE&&(i.previousSibling.data+=i.data,i.parentNode.removeChild(i))}else{if(E&&N&&(!c._4e_sameLevel(E)||!e._4e_sameLevel(N)))i=E._4e_index(),h&&E._4e_sameLevel(c)&&i--,a.setStart(E.parent(),i+1);a.collapse(n)}h&&c.remove();m&&e.remove();return j}function m(a){a.collapsed=a.startContainer&&a.endContainer&&a.startContainer[0]==
a.endContainer[0]&&a.startOffset==a.endOffset}function w(a){this.endOffset=this.endContainer=this.startOffset=this.startContainer=v;this.collapsed=n;this.document=a}k.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var n=!0,x=!1,v=null,i=k.RANGE,f=k.POSITION,b=a.DOM,u=a.UA,d=k.XHTML_DTD,g=a.Node,c=g.all,l={area:1,base:1,br:1,col:1,hr:1,
img:1,input:1,link:1,meta:1,param:1},s=new r.whitespaces,A=new r.bookmark,C=r.whitespaces(n),z=r.bookmark(!1,!0),D={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};a.augment(w,{toString:function(){var a=[],b=this.startContainer[0],c=this.endContainer[0];a.push((b.id||b.nodeName)+":"+this.startOffset);a.push((c.id||c.nodeName)+":"+this.endOffset);return a.join("<br/>")},optimize:function(){var a=
this.startContainer,c=this.startOffset;a[0].nodeType!=b.NodeType.ELEMENT_NODE&&(c?c>=a[0].nodeValue.length&&this.setStartAfter(a):this.setStartBefore(a));a=this.endContainer;c=this.endOffset;a[0].nodeType!=b.NodeType.ELEMENT_NODE&&(c?c>=a[0].nodeValue.length&&this.setEndAfter(a):this.setEndBefore(a))},setStartAfter:function(a){this.setStart(a.parent(),a._4e_index()+1)},setStartBefore:function(a){this.setStart(a.parent(),a._4e_index())},setEndAfter:function(a){this.setEnd(a.parent(),a._4e_index()+
1)},setEndBefore:function(a){this.setEnd(a.parent(),a._4e_index())},optimizeBookmark:function(){var a=this.startContainer,b=this.endContainer;a&&"span"==a.nodeName()&&a.attr("_ke_bookmark")&&this.setStartBefore(a);b&&"span"==b.nodeName()&&b.attr("_ke_bookmark")&&this.setEndAfter(b)},setStart:function(a,c){a[0].nodeType==b.NodeType.ELEMENT_NODE&&l[a.nodeName()]&&(a=a.parent(),c=a._4e_index());this.startContainer=a;this.startOffset=c;this.endContainer||(this.endContainer=a,this.endOffset=c);m(this)},
setEnd:function(a,c){a[0].nodeType==b.NodeType.ELEMENT_NODE&&l[a.nodeName()]&&(a=a.parent(),c=a._4e_index()+1);this.endContainer=a;this.endOffset=c;this.startContainer||(this.startContainer=a,this.startOffset=c);m(this)},setStartAt:function(a,c){switch(c){case i.POSITION_AFTER_START:this.setStart(a,0);break;case i.POSITION_BEFORE_END:a[0].nodeType==b.NodeType.TEXT_NODE?this.setStart(a,a[0].nodeValue.length):this.setStart(a,a[0].childNodes.length);break;case i.POSITION_BEFORE_START:this.setStartBefore(a);
break;case i.POSITION_AFTER_END:this.setStartAfter(a)}m(this)},setEndAt:function(a,c){switch(c){case i.POSITION_AFTER_START:this.setEnd(a,0);break;case i.POSITION_BEFORE_END:a[0].nodeType==b.NodeType.TEXT_NODE?this.setEnd(a,a[0].nodeValue.length):this.setEnd(a,a[0].childNodes.length);break;case i.POSITION_BEFORE_START:this.setEndBefore(a);break;case i.POSITION_AFTER_END:this.setEndAfter(a)}m(this)},cloneContents:function(){return q(this,2)},deleteContents:function(){return q(this,0)},extractContents:function(){return q(this,
1)},collapse:function(a){a?(this.endContainer=this.startContainer,this.endOffset=this.startOffset):(this.startContainer=this.endContainer,this.startOffset=this.endOffset);this.collapsed=n},clone:function(){var a=new w(this.document);a.startContainer=this.startContainer;a.startOffset=this.startOffset;a.endContainer=this.endContainer;a.endOffset=this.endOffset;a.collapsed=this.collapsed;return a},getEnclosedNode:function(){var a=this.clone();a.optimize();if(a.startContainer[0].nodeType!=b.NodeType.ELEMENT_NODE||
a.endContainer[0].nodeType!=b.NodeType.ELEMENT_NODE)return v;var c=new r(a);c.evaluator=function(a){return C(a)&&z(a)};a=c.next();c.reset();c=c.previous();return a&&a.equals(c)?a:v},shrink:function(a,c){if(!this.collapsed){var a=a||i.SHRINK_TEXT,d=this.clone(),g=this.startContainer,e=this.endContainer,f=this.startOffset,l=this.endOffset,h=n,s,j,k=n;g&&g[0].nodeType==b.NodeType.TEXT_NODE&&(f?f>=g[0].nodeValue.length?d.setStartAfter(g):(d.setStartBefore(g),h=x):d.setStartBefore(g));e&&e[0].nodeType==
b.NodeType.TEXT_NODE&&(l?l>=e[0].nodeValue.length?d.setEndAfter(e):(d.setEndAfter(e),k=x):d.setEndBefore(e));if(h||k)j=new r(d),j.evaluator=function(c){return c.nodeType==(a==i.SHRINK_ELEMENT?b.NodeType.ELEMENT_NODE:b.NodeType.TEXT_NODE)},j.guard=function(c,d){if(a==i.SHRINK_ELEMENT&&c.nodeType==b.NodeType.TEXT_NODE||d&&c==s)return x;!d&&c.nodeType==b.NodeType.ELEMENT_NODE&&(s=c);return n};h&&(d=j[a==i.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(d,c?i.POSITION_AFTER_START:i.POSITION_BEFORE_START);
k&&(j.reset(),(j=j[a==i.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(j,c?i.POSITION_BEFORE_END:i.POSITION_AFTER_END));return h||k}},createBookmark2:function(a){var c=this.startContainer,d=this.endContainer,e=this.startOffset,f=this.endOffset,l,h;if(!c||!d)return{start:0,end:0};if(a){if(c[0].nodeType==b.NodeType.ELEMENT_NODE&&(l=new g(c[0].childNodes[e]))&&l[0]&&l[0].nodeType==b.NodeType.TEXT_NODE&&0<e&&l[0].previousSibling.nodeType==b.NodeType.TEXT_NODE)c=l,e=0;for(;c[0].nodeType==
b.NodeType.TEXT_NODE&&(h=c.prev(void 0,1))&&h[0].nodeType==b.NodeType.TEXT_NODE;)c=h,e+=h[0].nodeValue.length;if(!this.collapsed){if(d[0].nodeType==b.NodeType.ELEMENT_NODE&&(l=new g(d[0].childNodes[f]))&&l[0]&&l[0].nodeType==b.NodeType.TEXT_NODE&&0<f&&l[0].previousSibling.nodeType==b.NodeType.TEXT_NODE)d=l,f=0;for(;d[0].nodeType==b.NodeType.TEXT_NODE&&(h=d.prev(void 0,1))&&h[0].nodeType==b.NodeType.TEXT_NODE;)d=h,f+=h[0].nodeValue.length}}return{start:c._4e_address(a),end:this.collapsed?v:d._4e_address(a),
startOffset:e,endOffset:f,normalized:a,is2:n}},createBookmark:function(b){var c,d,e,f,l=this.collapsed;c=new g("<span>",v,this.document);c.attr("_ke_bookmark",1);c.css("display","none");c.html("&nbsp;");b&&(e=a.guid("ke_bm_"),c.attr("id",e+"S"));l||(d=c.clone(),d.html("&nbsp;"),b&&d.attr("id",e+"E"),f=this.clone(),f.collapse(),f.insertNode(d));f=this.clone();f.collapse(n);f.insertNode(c);d?(this.setStartAfter(c),this.setEndBefore(d)):this.moveToPosition(c,i.POSITION_AFTER_END);return{startNode:b?
e+"S":c,endNode:b?e+"E":d,serializable:b,collapsed:l}},moveToPosition:function(a,b){this.setStartAt(a,b);this.collapse(n)},trim:function(a,c){var d=this.startContainer,g=this.startOffset,e=this.collapsed;if((!a||e)&&d[0]&&d[0].nodeType==b.NodeType.TEXT_NODE){if(g)if(g>=d[0].nodeValue.length)g=d._4e_index()+1,d=d.parent();else{var f=d._4e_splitText(g),g=d._4e_index()+1,d=d.parent();b.equals(this.startContainer,this.endContainer)?this.setEnd(f,this.endOffset-this.startOffset):b.equals(d,this.endContainer)&&
(this.endOffset+=1)}else g=d._4e_index(),d=d.parent();this.setStart(d,g);if(e){this.collapse(n);return}}d=this.endContainer;g=this.endOffset;!c&&!e&&d[0]&&d[0].nodeType==b.NodeType.TEXT_NODE&&(g?(g>=d[0].nodeValue.length||d._4e_splitText(g),g=d._4e_index()+1):g=d._4e_index(),d=d.parent(),this.setEnd(d,g))},insertNode:function(a){this.optimizeBookmark();this.trim(x,n);var b=this.startContainer;b[0].insertBefore(a[0],b[0].childNodes[this.startOffset]||null);b[0]==this.endContainer[0]&&this.endOffset++;
this.setStartBefore(a)},moveToBookmark:function(b){var d=c(this.document);if(b.is2){var g=d._4e_getByAddress(b.start,b.normalized),e=b.startOffset,d=b.end&&d._4e_getByAddress(b.end,b.normalized),b=b.endOffset;this.setStart(g,e);d?this.setEnd(d,b):this.collapse(n)}else g=(e=b.serializable)?a.one("#"+b.startNode,d):b.startNode,b=e?a.one("#"+b.endNode,d):b.endNode,this.setStartBefore(g),g._4e_remove(),b&&b[0]?(this.setEndBefore(b),b._4e_remove()):this.collapse(n)},getCommonAncestor:function(a,d){var c=
this.startContainer,e=this.endContainer,c=c[0]==e[0]?a&&c[0].nodeType==b.NodeType.ELEMENT_NODE&&this.startOffset==this.endOffset-1?new g(c[0].childNodes[this.startOffset]):c:c._4e_commonAncestor(e);return d&&c[0].nodeType==b.NodeType.TEXT_NODE?c.parent():c},enlarge:function(){function a(d,g,e,f){var l=d[g?"startContainer":"endContainer"],h,i=g?0:1,p=0,j=g?"previousSibling":"nextSibling";h=d[g?"startOffset":"endOffset"];if(l[0].nodeType==b.NodeType.TEXT_NODE){if(g){if(h)return}else if(h<l[0].nodeValue.length)return;
h=l[0][j];l=l[0].parentNode}else h=l[0].childNodes[h+(g?-1:1)]||null,l=l[0];for(;l;){for(;h;)if(s(h)||A(h))h=h[j];else break;if(h){if(!p)d[g?"setStartAfter":"setEndBefore"](c(h));break}l=c(l);if("body"==l.nodeName())break;if(p||l.equals(f))e[i]=l,p=1;else d[g?"setStartBefore":"setEndAfter"](l);h=l[0][j];l=l[0].parentNode}}return function(d){switch(d){case i.ENLARGE_ELEMENT:if(this.collapsed)break;var d=this.getCommonAncestor(),e=[];a(this,1,e,d);a(this,0,e,d);e[0]&&e[1]&&(d=e[0].contains(e[1])?e[1]:
e[0],this.setStartBefore(d),this.setEndAfter(d));break;case i.ENLARGE_BLOCK_CONTENTS:case i.ENLARGE_LIST_ITEM_CONTENTS:var f=new w(this.document),e=new g(this.document.body);f.setStartAt(e,i.POSITION_AFTER_START);f.setEnd(this.startContainer,this.startOffset);var f=new r(f),l,h,s=r.blockBoundary(d==i.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:v),j=function(a){var b=s(a);b||(l=c(a));return b},k=function(a){var d=j(a);!d&&"br"==b.nodeName(a)&&(h=c(a));return d};f.guard=j;f=f.lastBackward();l=l||e;this.setStartAt(l,
"br"!=l.nodeName()&&(!f&&this.checkStartOfBlock()||f&&l.contains(f))?i.POSITION_AFTER_START:i.POSITION_AFTER_END);f=this.clone();f.collapse();f.setEndAt(e,i.POSITION_BEFORE_END);f=new r(f);f.guard=d==i.ENLARGE_LIST_ITEM_CONTENTS?k:j;l=v;f=f.lastForward();l=l||e;this.setEndAt(l,!f&&this.checkEndOfBlock()||f&&l.contains(f)?i.POSITION_BEFORE_END:i.POSITION_BEFORE_START);h&&this.setEndAfter(h)}}}(),checkStartOfBlock:function(){var d=this.startContainer,c=this.startOffset;if(c&&d[0].nodeType==b.NodeType.TEXT_NODE&&
a.trim(d[0].nodeValue.substring(0,c)).length)return x;this.trim();d=new o(this.startContainer);c=this.clone();c.collapse(n);c.setStartAt(d.block||d.blockLimit,i.POSITION_AFTER_START);d=new r(c);d.evaluator=j(n);return d.checkBackward()},checkEndOfBlock:function(){var d=this.endContainer,c=this.endOffset;if(d[0].nodeType==b.NodeType.TEXT_NODE&&a.trim(d[0].nodeValue.substring(c)).length)return x;this.trim();d=new o(this.endContainer);c=this.clone();c.collapse(x);c.setEndAt(d.block||d.blockLimit,i.POSITION_BEFORE_END);
d=new r(c);d.evaluator=j(x);return d.checkForward()},checkBoundaryOfElement:function(a,b){var d=this.clone();d[b==i.START?"setStartAt":"setEndAt"](a,b==i.START?i.POSITION_AFTER_START:i.POSITION_BEFORE_END);d=new r(d);d.evaluator=e;return d[b==i.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var a=this.startContainer,d=this.endContainer,g=this.startOffset,e=this.endOffset,l;if(a[0].nodeType==b.NodeType.ELEMENT_NODE)if(l=a[0].childNodes.length,l>g)a=c(a[0].childNodes[g]);else if(0==
l)a=a._4e_previousSourceNode();else{for(a=a[0];a.lastChild;)a=a.lastChild;a=c(a);a=a._4e_nextSourceNode()||a}if(d[0].nodeType==b.NodeType.ELEMENT_NODE)if(l=d[0].childNodes.length,l>e)d=c(d[0].childNodes[e])._4e_previousSourceNode(n);else if(0==l)d=d._4e_previousSourceNode();else{for(d=d[0];d.lastChild;)d=d.lastChild;d=c(d)}a._4e_position(d)&f.POSITION_FOLLOWING&&(a=d);return{startNode:a,endNode:d}},fixBlock:function(a,b){var d=this.createBookmark(),g=c(this.document.createElement(b));this.collapse(a);
this.enlarge(i.ENLARGE_BLOCK_CONTENTS);g[0].appendChild(this.extractContents());g._4e_trim();u.ie||g._4e_appendBogus();this.insertNode(g);this.moveToBookmark(d);return g},splitBlock:function(b){var d=new o(this.startContainer),c=new o(this.endContainer),g=d.block,e=c.block,f=v;if(!d.blockLimit.equals(c.blockLimit))return v;"br"!=b&&(g||(g=this.fixBlock(n,b),e=(new o(this.endContainer)).block),e||(e=this.fixBlock(x,b)));b=g&&this.checkStartOfBlock();d=e&&this.checkEndOfBlock();this.deleteContents();
g&&g[0]==e[0]&&(d?(f=new o(this.startContainer),this.moveToPosition(e,i.POSITION_AFTER_END),e=v):b?(f=new o(this.startContainer),this.moveToPosition(g,i.POSITION_BEFORE_START),g=v):(e=this.splitElement(g),!u.ie&&!a.inArray(g.nodeName(),["ul","ol"])&&g._4e_appendBogus()));return{previousBlock:g,nextBlock:e,wasStartOfBlock:b,wasEndOfBlock:d,elementPath:f}},splitElement:function(a){if(!this.collapsed)return v;this.setEndAt(a,i.POSITION_BEFORE_END);var b=this.extractContents(),d=a.clone(x);d[0].appendChild(b);
d.insertAfter(a);this.moveToPosition(a,i.POSITION_AFTER_END);return d},moveToElementEditablePosition:function(a,d){for(var c=0;a;){if(a[0].nodeType==b.NodeType.TEXT_NODE){this.moveToPosition(a,d?i.POSITION_AFTER_END:i.POSITION_BEFORE_START);c=1;break}a[0].nodeType==b.NodeType.ELEMENT_NODE&&a._4e_isEditable()&&(this.moveToPosition(a,d?i.POSITION_BEFORE_END:i.POSITION_AFTER_START),c=1);var g=a,e=c,f=void 0;g[0].nodeType==b.NodeType.ELEMENT_NODE&&g._4e_isEditable()&&(f=g[d?"last":"first"](h,1));!e&&
!f&&(f=g[d?"prev":"next"](h,1));a=f}return!!c},selectNodeContents:function(a){var d=a[0];this.setStart(a,0);this.setEnd(a,d.nodeType==b.NodeType.TEXT_NODE?d.nodeValue.length:d.childNodes.length)},insertNodeByDtd:function(a){var b,c,g,e=a.nodeName();b=d.$block[e];this.deleteContents();if(b){for(b=this.getCommonAncestor(x,n);(c=d[b.nodeName()])&&(!c||!c[e]);){var f=b.parent();this.checkStartOfBlock()&&this.checkEndOfBlock()?(this.setStartBefore(b),this.collapse(n),b.remove()):g=b;b=f}g&&this.splitElement(g)}this.insertNode(a)}});
t.injectDom({_4e_breakParent:function(a,b){var b=c(b),a=c(a),d,g=new k.Range(a[0].ownerDocument);g.setStartAfter(a);g.setEndAfter(b);d=g.extractContents();g.insertNode(a.remove());a.after(d)}});return k.Range=w},{requires:["./base","./utils","./walker","./elementPath","./dom"]});
KISSY.add("editor/core/selection",function(a){function k(a){this.document=a;this._={cache:{}};if(n)try{var b=this.getNative().createRange();if(!b||b.item&&b.item(0).ownerDocument!=a||b.parentElement&&b.parentElement().ownerDocument!=a)this.isInvalid=o}catch(c){this.isInvalid=o}}function t(a){a=new k(a);return!a||a.isInvalid?e:a}var r=a.Editor;r.SELECTION={SELECTION_NONE:1,SELECTION_TEXT:2,SELECTION_ELEMENT:3};var o=!0,e=null,h=a.UA,j=a.DOM,q=a.Node,m=r.SELECTION,w=r.RANGE,n=h.ie,x=r.Walker,v=r.Range,
i={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};a.augment(k,{getNative:!n?function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=j.getWindow(this.document).getSelection())}:function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=this.document.selection)},getType:!n?function(){var a=this._.cache;if(a.type)return a.type;var b=m.SELECTION_TEXT,c=this.getNative();if(c){if(1==c.rangeCount){var c=
c.getRangeAt(0),e=c.startContainer;e==c.endContainer&&e.nodeType==j.NodeType.ELEMENT_NODE&&1==Number(c.endOffset-c.startOffset)&&i[e.childNodes[c.startOffset].nodeName.toLowerCase()]&&(b=m.SELECTION_ELEMENT)}}else b=m.SELECTION_NONE;return a.type=b}:function(){var a=this._.cache;if(a.type)return a.type;var b=m.SELECTION_NONE;try{var c=this.getNative(),e=c.type;"Text"==e&&(b=m.SELECTION_TEXT);"Control"==e&&(b=m.SELECTION_ELEMENT);c.createRange().parentElement&&(b=m.SELECTION_TEXT)}catch(f){}return a.type=
b},getRanges:n?function(){var a=function(a,b){a=a.duplicate();a.collapse(b);for(var d=a.parentElement(),f=d.childNodes,h,i=0;i<f.length;i++){var k=f[i];if(k.nodeType==j.NodeType.ELEMENT_NODE){h=a.duplicate();h.moveToElementText(k);var k=h.compareEndPoints("StartToStart",a),m=h.compareEndPoints("EndToStart",a);h.collapse();if(0<k)break;else{if(!k||1==m&&-1==k)return{container:d,offset:i};if(!m)return{container:d,offset:i+1}}h=e}}h||(h=a.duplicate(),h.moveToElementText(d),h.collapse(!1));h.setEndPoint("StartToStart",
a);h=(""+h.text).replace(/\r\n|\r/g,"\n").length;try{for(;0<h;)h-=f[--i].nodeValue.length}catch(p){h=0}return 0===h?{container:d,offset:i}:{container:f[i],offset:-h}};return function(b){var c=this._.cache;if(c.ranges&&!b)return c.ranges;var e=this.getNative(),b=e&&e.createRange(),f=this.getType();if(!e)return[];if(f==m.SELECTION_TEXT)return e=new v(this.document),f=a(b,o),e.setStart(new q(f.container),f.offset),f=a(b),e.setEnd(new q(f.container),f.offset),c.ranges=[e];if(f==m.SELECTION_ELEMENT){c=
c.ranges=[];for(f=0;f<b.length;f++){for(var h=b.item(f),i=h.parentNode,j=0,e=new v(this.document);j<i.childNodes.length&&i.childNodes[j]!=h;j++);e.setStart(new q(i),j);e.setEnd(new q(i),j+1);c.push(e)}return c}return c.ranges=[]}}():function(a){var b=this._.cache;if(b.ranges&&!a)return b.ranges;var a=[],c=this.getNative();if(!c)return[];for(var e=0;e<c.rangeCount;e++){var f=c.getRangeAt(e),h=new v(this.document);h.setStart(new q(f.startContainer),f.startOffset);h.setEnd(new q(f.endContainer),f.endOffset);
a.push(h)}return b.ranges=a},getStartElement:function(){var a=this._.cache;if(void 0!==a.startElement)return a.startElement;var b,c=this.getNative();switch(this.getType()){case m.SELECTION_ELEMENT:return this.getSelectedElement();case m.SELECTION_TEXT:var e=this.getRanges()[0];if(e&&!e.collapsed){for(e.optimize();o;)if(b=e.startContainer,e.startOffset==(b[0].nodeType===j.NodeType.ELEMENT_NODE?b[0].childNodes.length:b[0].nodeValue.length)&&!b._4e_isBlockBoundary())e.setStartAfter(b);else break;b=e.startContainer;
if(b[0].nodeType!=j.NodeType.ELEMENT_NODE)return b.parent();b=new q(b[0].childNodes[e.startOffset]);if(!b[0]||b[0].nodeType!=j.NodeType.ELEMENT_NODE)return e.startContainer;for(e=b[0].firstChild;e&&e.nodeType==j.NodeType.ELEMENT_NODE;)b=new q(e),e=e.firstChild;return b}if(n)e=c.createRange(),e.collapse(o),b=new q(e.parentElement());else{if((b=c.anchorNode)&&b.nodeType!=j.NodeType.ELEMENT_NODE)b=b.parentNode;b&&(b=new q(b))}}return a.startElement=b},getSelectedElement:function(){var a,b=this._.cache;
if(void 0!==b.selectedElement)return b.selectedElement;n&&(a=this.getNative().createRange(),a=a.item&&a.item(0));var c;if(a)c=new q(a);else{a=this.getRanges()[0];for(var e,f=2;f&&(!(c=a.getEnclosedNode())||!(c[0].nodeType==j.NodeType.ELEMENT_NODE&&i[c.nodeName()]&&(e=c)));f--)a.shrink(w.SHRINK_ELEMENT);c=e}return b.selectedElement=c},reset:function(){this._.cache={}},selectElement:function(a){var b,c=this.document;if(n)try{b=c.body.createControlRange(),b.addElement(a[0]),b.select()}catch(e){b=c.body.createTextRange(),
b.moveToElementText(a[0]),b.select()}finally{}else b=c.createRange(),b.selectNode(a[0]),a=this.getNative(),a.removeAllRanges(),a.addRange(b);this.reset()},selectRanges:function(a){if(n){if(1<a.length){var b=a[a.length-1];a[0].setEnd(b.endContainer,b.endOffset);a.length=1}a[0]&&a[0].select()}else{b=this.getNative();if(!b)return;b.removeAllRanges();for(var c=0;c<a.length;c++){var e=a[c],f=this.document.createRange(),i=e.startContainer;if(e.collapsed&&(h.gecko&&1.09>h.gecko||h.opera||h.webkit)&&i[0].nodeType==
j.NodeType.ELEMENT_NODE&&!i[0].childNodes.length)i[0].appendChild(this.document.createTextNode(h.webkit?"\u200b":"")),e.startOffset++,e.endOffset++;f.setStart(i[0],e.startOffset);f.setEnd(e.endContainer[0],e.endOffset);b.addRange(f)}}this.reset()},createBookmarks2:function(a){for(var b=[],c=this.getRanges(),e=0;e<c.length;e++)b.push(c[e].createBookmark2(a));return b},createBookmarks:function(b,e){for(var c=[],f=this.document,h,e=e||this.getRanges(),i=e.length,k=0;k<i;k++){c.push(h=e[k].createBookmark(b,
o));var m=(b=h.serializable)?a.one("#"+h.startNode,f):h.startNode;h=b?a.one("#"+h.endNode,f):h.endNode;for(var q=k+1;q<i;q++){var p=e[q],n=p.startContainer,u=p.endContainer;j.equals(n,m.parent())&&p.startOffset++;j.equals(n,h.parent())&&p.startOffset++;j.equals(u,m.parent())&&p.endOffset++;j.equals(u,h.parent())&&p.endOffset++}}return c},selectBookmarks:function(a){for(var b=[],c=0;c<a.length;c++){var e=new v(this.document);e.moveToBookmark(a[c]);b.push(e)}this.selectRanges(b);return this},getCommonAncestor:function(){var a=
this.getRanges();return a[0].startContainer._4e_commonAncestor(a[a.length-1].endContainer)},scrollIntoView:function(){var a=this.getStartElement();a&&a.scrollIntoView(void 0,{alignWithTop:!1,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0})},removeAllRanges:function(){var a=this.getNative();n?a&&a.clear():a&&a.removeAllRanges()}});var f={table:1,tbody:1,tr:1},b=x.whitespaces(o),u=/\ufeff|\u00a0/;v.prototype.select=v.prototype.select=!n?function(){var a=this.startContainer;this.collapsed&&a[0].nodeType==
j.NodeType.ELEMENT_NODE&&!a[0].childNodes.length&&a[0].appendChild(this.document.createTextNode(""));var b=this.document.createRange();b.setStart(a[0],this.startOffset);try{b.setEnd(this.endContainer[0],this.endOffset)}catch(c){if(0<=c.toString().indexOf("NS_ERROR_ILLEGAL_VALUE"))this.collapse(o),b.setEnd(this.endContainer[0],this.endOffset);else throw c;}a=t(this.document).getNative();a.removeAllRanges();a.addRange(b)}:function(a){var e=this.collapsed,c,h;if(this.startContainer[0]===this.endContainer[0]&&
1==this.endOffset-this.startOffset){var i=this.startContainer[0].childNodes[this.startOffset];if(i.nodeType==j.NodeType.ELEMENT_NODE){(new k(this.document)).selectElement(new q(i));return}}(this.startContainer[0].nodeType==j.NodeType.ELEMENT_NODE&&this.startContainer.nodeName()in f||this.endContainer[0].nodeType==j.NodeType.ELEMENT_NODE&&this.endContainer.nodeName()in f)&&this.shrink(w.SHRINK_ELEMENT,o);var m=this.createBookmark(),i=m.startNode,n;e||(n=m.endNode);m=this.document.body.createTextRange();
m.moveToElementText(i[0]);m.moveStart("character",1);if(n)a=this.document.body.createTextRange(),a.moveToElementText(n[0]),m.setEndPoint("EndToEnd",a),m.moveEnd("character",-1);else{for(c=i[0].nextSibling;c&&!b(c);)c=c.nextSibling;c=!(c&&c.nodeValue&&c.nodeValue.match(u))&&(a||!i[0].previousSibling||i[0].previousSibling&&"br"==j.nodeName(i[0].previousSibling));h=new q(this.document.createElement("span"));h.html("&#65279;");h.insertBefore(i);c&&j.insertBefore(this.document.createTextNode("\ufeff"),i[0]||
i)}this.setStartBefore(i);i._4e_remove();if(e){if(c?(m.moveStart("character",-1),m.select(),this.document.selection.clear()):m.select(),h)this.moveToPosition(h,w.POSITION_BEFORE_START),h._4e_remove()}else this.setEndBefore(n),n._4e_remove(),m.select()};k.getSelection=t;return r.Selection=k},{requires:["./base","./walker","./range","./dom"]});
KISSY.add("editor/core/selectionFix",function(a,k){function t(a){function e(a,b){var d=c.body.createTextRange();try{d.moveToPoint(a,b)}catch(f){d=q}return d}function b(){var a=c.selection.createRange();l&&!a.item&&0===a.compareEndPoints("StartToEnd",a)&&l.select();w.remove(c,"mouseup",b);w.remove(c,"mousemove",h);l=d=0}function h(a){if(a.button){if(a=e(a.pageX,a.pageY))0<a.compareEndPoints("StartToStart",l)?a.setEndPoint("StartToStart",l):a.setEndPoint("EndToEnd",l),a.select()}else b()}var d,g=a.get("window")[0],
c=a.get("document")[0],l;w.on(c,"mousedown contextmenu",function(a){var i=c.documentElement;if(a.target===i&&(d&&b(),!(i.scrollHeight>i.clientHeight)&&(d=1,l=e(a.pageX,a.pageY))))w.on(c,"mouseup",b),w.on(c,"mousemove",h),g.focus(),l.select()})}function r(a){function e(d){if(c){var l=a.getSelection(),j=l&&l.getType(),k=l&&b.selection;if(d&&k&&j==v.SELECTION_NONE&&!b.queryCommandEnabled("InsertImage"))setTimeout(function(){e(h)},50);else{var m;if(!k||!k.type||!("Control"!=k.type&&(m=k.createRange())&&
(m=m.parentElement())&&(m=m.nodeName)&&m.toLowerCase()in{input:1,textarea:1}))g=k&&l.getRanges()[0],a.checkSelectionChange()}}}var b=a.get("document")[0],m=new x(b.body),d=new x(b.documentElement);if(8>k.Utils.ieEngine)d.on("click",function(b){"html"===(new x(b.target)).nodeName()&&a.getSelection().getNative().createRange().select()});var g,c,l=h;d.on("mousedown",function(){l=j});d.on("mouseup",function(){l=h});m.on("focusin",function(a){if("body"==(new x(a.target)).nodeName()&&g){try{l&&g.select()}catch(b){}g=
q}});m.on("focus",function(){c=h;e()});m.on("beforedeactivate",function(a){a.relatedTarget||(c=j,l=h)});m.on("mousedown",function(){c=j});m.on("mouseup",function(){c=h;setTimeout(function(){e(h)},0)});m.on("keydown",function(){c=j});m.on("keyup",function(){c=h;setTimeout(function(){e()},0)})}function o(a){var e=a.get("document")[0];w.on(e,"mouseup keyup selectionchange",function(){a.checkSelectionChange()})}function e(a){function e(a){var b=k.XHTML_DTD;return a._4e_isBlockBoundary()&&b.$empty[a.nodeName()]}
function b(a){return d(a)&&g(a)}var q=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;|(<\!--[\s\S]*?--\>))?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,d=k.Walker.whitespaces(h),g=k.Walker.bookmark(j,h),c=function(a){return d(a)&&8!=a.nodeType};a.on("selectionChange",function(d){var g=d.path,o=new x(a.get("document")[0].body),d=(d=d.selection)&&d.getRanges()[0],r=g.blockLimit;if(m.gecko){var t=g.block||g.blockLimit,v=t&&t.last(b);t&&t._4e_isBlockBoundary()&&(!v||!(1==v[0].nodeType&&
v._4e_isBlockBoundary()))&&"pre"!=t.nodeName()&&!t._4e_getBogus()&&t._4e_appendBogus()}if(d&&d.collapsed&&!g.block){if("body"==r.nodeName()){if((g=d.fixBlock(h,"p"))&&g[0]!=o[0].lastChild&&g._4e_outerHtml().match(q))if((r=g.next(c,1))&&r[0].nodeType==n.NodeType.ELEMENT_NODE&&!e[r])d.moveToElementEditablePosition(r),g._4e_remove();else if((r=g.prev(c,1))&&r[0].nodeType==n.NodeType.ELEMENT_NODE&&!e[r])d.moveToElementEditablePosition(r,r._4e_outerHtml().match(q)?j:h),g._4e_remove();d.select();a.notifySelectionChange()}g=
a.get("document")[0];d=new k.Range(g);d.moveToElementEditablePosition(o,h);"body"!==(new k.ElementPath(d.startContainer)).blockLimit.nodeName()&&(o=(new x(g.createElement("p"))).appendTo(o),m.ie||o._4e_appendBogus())}})}var h=!0,j=!1,q=null,m=a.UA,w=a.Event,n=a.DOM,x=a.Node,v=k.SELECTION;return{init:function(a){a.docReady(function(){m.ie?(t(a),r(a)):o(a)});e(a)}}},{requires:["./base","./selection"]});
KISSY.add("editor/core/styles",function(a,k){function t(a){return!z.attr(a,"_ke_bookmark")}function r(a,b){for(var c in a)"string"==typeof a[c]?a[c]=a[c].replace(S,function(a,c){return b[c]}):r(a[c],b)}function o(b,c){c&&(b=a.clone(b),r(b,c));var d=this.element=this.element=(b.element||"*").toLowerCase();this.type=this.type="#text"==d||R[d]?D.STYLE_BLOCK:P[d]?D.STYLE_OBJECT:D.STYLE_INLINE;this._={definition:b}}function e(a,b){var c=b?this.removeFromRange:this.applyToRange;a.body.focus();for(var d=
new F(a),e=d.getRanges(),f=0;f<e.length;f++)c.call(this,e[f]);d.selectRanges(e)}function h(a,b,c){var d=a.element;"*"==d&&(d="span");b=new G(b.createElement(d));c&&c._4e_copyAttributes(b);c=a._.definition;a=c.attributes;c=o.getStyleText(c);if(a)for(var e in a)b.attr(e,a[e]);c&&(b[0].style.cssText=c);return b}function j(a){var b=a.createBookmark(l),c=a.createIterator();c.enforceRealBlocks=l;c.enlargeBr=l;for(var d,e=a.document;d=c.getNextParagraph();){var f=h(this,e,d),g=f,f="pre"==g.nodeName,i="pre"==
d.nodeName,j=!f&&i;f&&!i?(i=d,j=i.html(),j=q(j,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,""),j=j.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1"),j=j.replace(/([ \t\n\r]+|&nbsp;)/g," "),j=j.replace(/<br\b[^>]*>/gi,"\n"),M.ie?(i=i[0].ownerDocument.createElement("div"),i.appendChild(g[0]),g[0].outerHTML="<pre>"+j+"</pre>",g=new G(i.firstChild),g._4e_remove()):g.html(j)):j?g=w(m(d),g):d._4e_moveChildren(g);d[0].parentNode.replaceChild(g[0],d[0]);if(f&&(d=g,f=void 0,(f=d._4e_previousSourceNode(l,z.NodeType.ELEMENT_NODE))&&
"pre"==f.nodeName()))g=q(f.html(),/\n$/,"")+"\n\n"+q(d.html(),/^\n/,""),M.ie?d[0].outerHTML="<pre>"+g+"</pre>":d.html(g),f._4e_remove()}a.moveToBookmark(b)}function q(a,b,c){var d="",e="",a=a.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(a,b,c){b&&(d=b);c&&(e=c);return""});return d+a.replace(b,c)+e}function m(a){var b=[];q(a._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,function(a,b,c){return b+"</pre>"+c+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,
function(a,c){b.push(c)});return b}function w(a,b){for(var c=b[0].ownerDocument.createDocumentFragment(),d=0;d<a.length;d++){var e=a[d],e=e.replace(/(\r\n|\r)/g,"\n"),e=q(e,/^[ \t]*\n/,""),e=q(e,/\n$/,""),e=q(e,/^[ \t]+|[ \t]+$/g,function(a,b){return 1==a.length?"&nbsp;":b?" "+Array(a.length).join("&nbsp;"):Array(a.length).join("&nbsp;")+" "}),e=e.replace(/\n/g,"<br>"),e=e.replace(/[ \t]{2,}/g,function(a){return Array(a.length).join("&nbsp;")+" "}),f=b.clone();f.html(e);c.appendChild(f[0])}return c}
function n(a){var b=a.document;if(a.collapsed)b=h(this,b,void 0),a.insertNode(b),a.moveToPosition(b,p.POSITION_BEFORE_END);else{var c=this.element,e=this._.definition,f,g=L[c];g||(f=l,g=L.span);var i=a.createBookmark();a.enlarge(p.ENLARGE_ELEMENT);a.trim();for(var j=a.createBookmark(),k=j.startNode,j=j.endNode,m=k,q;m&&m[0];){var n=s;if(z.equals(m,j))m=A,n=l;else{var o=m[0].nodeType,r=o==z.NodeType.ELEMENT_NODE?m.nodeName():A;if(r&&m.attr("_ke_bookmark")){m=m._4e_nextSourceNode(l);continue}if(!r||
g[r]&&(m._4e_position(j)|y.POSITION_PRECEDING|y.POSITION_IDENTICAL|y.POSITION_IS_CONTAINED)==y.POSITION_PRECEDING+y.POSITION_IDENTICAL+y.POSITION_IS_CONTAINED&&(!e.childRule||e.childRule(m))){var u=m.parent();if(u&&"a"==c&&u.nodeName()==c)o=h(this,b,void 0),u._4e_moveChildren(o),u[0].parentNode.replaceChild(o[0],u[0]),o._4e_mergeSiblings();else if(u&&u[0]&&((L[u.nodeName()]||L.span)[c]||f)&&(!e.parentRule||e.parentRule(u))){if(!q&&(!r||!L.$removeEmpty[r]||(m._4e_position(j)|y.POSITION_PRECEDING|y.POSITION_IDENTICAL|
y.POSITION_IS_CONTAINED)==y.POSITION_PRECEDING+y.POSITION_IDENTICAL+y.POSITION_IS_CONTAINED))q=new I(b),q.setStartBefore(m);if(o==z.NodeType.TEXT_NODE||o==z.NodeType.ELEMENT_NODE&&!m[0].childNodes.length){u=m;for(o=null;(n=!u.next(t,1))&&(o=u.parent())&&g[o.nodeName()]&&(o._4e_position(k)|y.POSITION_FOLLOWING|y.POSITION_IDENTICAL|y.POSITION_IS_CONTAINED)==y.POSITION_FOLLOWING+y.POSITION_IDENTICAL+y.POSITION_IS_CONTAINED&&(!e.childRule||e.childRule(o));)u=o;q.setEndAfter(u)}}else n=l}else n=l;m=m._4e_nextSourceNode()}if(n&&
q&&!q.collapsed){for(var n=h(this,b,void 0),u=q.getCommonAncestor(),o={},r={},v,w=null,x;n&&u&&n[0]&&u[0];){if(u.nodeName()==c){for(v in e.attributes)if(!r[v]&&(x=u.attr(w)))n.attr(v)==x?n.removeAttr(v):r[v]=1;for(w in e.styles)if(!o[w]&&(x=u.style(w)))n.style(w)==x?n.style(w,""):o[w]=1;if(!n._4e_hasAttributes()){n=A;break}}u=u.parent()}n?(n[0].appendChild(q.extractContents()),d(this,n),q.insertNode(n),n._4e_mergeSiblings(),M.ie||n[0].normalize()):(n=new G(b.createElement("span")),n[0].appendChild(q.extractContents()),
q.insertNode(n),d(this,n),n._4e_remove(!0));q=A}}k._4e_remove();j._4e_remove();a.moveToBookmark(i);a.shrink(p.SHRINK_TEXT)}}function x(a){a.enlarge(p.ENLARGE_ELEMENT);var c=a.createBookmark(),d=c.startNode;if(a.collapsed){for(var e=new O(d.parent()),h,i=0,j;i<e.elements.length&&(j=e.elements[i])&&!(j==e.block||j==e.blockLimit);i++)if(this.checkElementRemovable(j)){var l=a.checkBoundaryOfElement(j,p.END),k=!l&&a.checkBoundaryOfElement(j,p.START);k||l?(h=j,h.match=k?"start":"end"):(j._4e_mergeSiblings(),
j.nodeName()!=this.element?(l=f(this),g(j,l[j.nodeName()]||l["*"])):b(this,j))}if(h){j=d;for(i=0;;i++){l=e.elements[i];if(l.equals(h))break;else if(l.match)continue;else l=l.clone();l[0].appendChild(j[0]);j=l}j["start"==h.match?"insertBefore":"insertAfter"](h);e=h.html();!e||"\u200b"==e?h.remove():M.webkit&&C(a.document.createTextNode("\u200b")).insertBefore(j)}}else{var m=c.endNode,n=this;h=function(){for(var a=new O(d.parent()),b=new O(m.parent()),c=A,e=A,f=0;f<a.elements.length;f++){var g=a.elements[f];
if(g==a.block||g==a.blockLimit)break;n.checkElementRemovable(g)&&(c=g)}for(f=0;f<b.elements.length;f++){g=b.elements[f];if(g==b.block||g==b.blockLimit)break;n.checkElementRemovable(g)&&(e=g)}e&&m._4e_breakParent(e);c&&d._4e_breakParent(c)};h();for(e=new G(d[0].nextSibling);e[0]!==m[0];){i=e._4e_nextSourceNode();if(e[0]&&e[0].nodeType==z.NodeType.ELEMENT_NODE&&this.checkElementRemovable(e)&&(e.nodeName()==this.element?b(this,e):(j=f(this),g(e,j[e.nodeName()]||j["*"])),i[0].nodeType==z.NodeType.ELEMENT_NODE&&
i.contains(d)))h(),i=new G(d[0].nextSibling);e=i}}a.moveToBookmark(c)}function v(a){var b={};(""+a).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(a,c,d){b[c]=d});return b}function i(a,b){var c="";b!==s?(c=document.createElement("span"),c.style.cssText=a,c=c.style.cssText||""):c=a;return c.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function f(b){if(b._.overrides)return b._.overrides;var c=b._.overrides={},d=b._.definition.overrides;
if(d){a.isArray(d)||(d=[d]);for(var e=0;e<d.length;e++){var f=d[e],g,h,i;"string"==typeof f?g=f.toLowerCase():(g=f.element?f.element.toLowerCase():b.element,h=f.attributes,i=f.styles);f=c[g]||(c[g]={});if(h){g=f.attributes=f.attributes||[];for(var j in h)g.push([j.toLowerCase(),h[j]])}if(i){var f=f.styles=f.styles||[],l;for(l in i)f.push([l.toLowerCase(),i[l]])}}}return c}function b(b,d){var e=b._.definition,g=f(b),h=a.merge(e.attributes,(g[d.nodeName()]||g["*"]||{}).attributes),e=a.merge(e.styles,
(g[d.nodeName()]||g["*"]||{}).styles),g=a.isEmptyObject(h)&&a.isEmptyObject(e),i;for(i in h)("class"==i||b._.definition.fullMatch)&&d.attr(i)!=u(i,h[i])||(g=g||!!d.hasAttr(i),d.removeAttr(i));for(var j in e)b._.definition.fullMatch&&d.style(j)!=u(j,e[j],l)||(g=g||!!d.style(j),d.style(j,""));c(d)}function u(a,b,c){var d=new G("<span>");d[c?"style":"attr"](a,b);return d[c?"style":"attr"](a)}function d(a,c){for(var d=f(a),e=c.all(a.element),h=e.length;0<=--h;)b(a,new G(e[h]));for(var i in d)if(i!=a.element){e=
c.all(i);for(h=e.length-1;0<=h;h--){var j=new G(e[h]);g(j,d[i])}}}function g(a,b){var d,e=b&&b.attributes;if(e)for(d=0;d<e.length;d++){var f=e[d][0],g;if(g=a.attr(f)){var h=e[d][1];(h===A||h.test&&h.test(g)||"string"==typeof h&&g==h)&&a[0].removeAttribute(f)}}if(e=b&&b.styles)for(d=0;d<e.length;d++)if(f=e[d][0],h=a.css(f)){var i=e[d][1];(i===A||i.test&&i.test(g)||"string"==typeof i&&h==i)&&a.css(f,"")}c(a)}function c(a){if(!a._4e_hasAttributes()){var b=a[0].firstChild,c=a[0].lastChild;a._4e_remove(l);
b&&(b.nodeType==z.NodeType.ELEMENT_NODE&&z._4e_mergeSiblings(b),c&&b!=c&&c.nodeType==z.NodeType.ELEMENT_NODE&&z._4e_mergeSiblings(c))}}var l=!0,s=!1,A=null,C=a.all,z=a.DOM,D={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3},p=k.RANGE,F=k.Selection,y=k.POSITION,I=k.Range,G=a.Node,M=a.UA,O=k.ElementPath,R={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},L=k.XHTML_DTD,P={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},Q=/\s*(?:;\s*|$)/g,S=/#\((.+?)\)/g;k.STYLE=
D;o.prototype={constructor:o,apply:function(a){e.call(this,a,s)},remove:function(a){e.call(this,a,l)},applyToRange:function(a){return(this.applyToRange=this.type==D.STYLE_INLINE?n:this.type==D.STYLE_BLOCK?j:A).call(this,a)},removeFromRange:function(a){return(this.removeFromRange=this.type==D.STYLE_INLINE?x:A).call(this,a)},checkElementRemovable:function(a,b){if(!a)return s;var c=this._.definition,d;if(a.nodeName()==this.element){if(!b&&!a._4e_hasAttributes())return l;var e=c._AC;if(e)c=e;else{var e=
{},g=0,h=c.attributes;if(h)for(var j in h)g++,e[j]=h[j];if(h=o.getStyleText(c))e.style||g++,e.style=h;e._length=g;c=c._AC=e}if(c._length){for(var k in c)if("_length"!=k){g=a.attr(k)||"";if("style"==k)a:{e=c[k];g=i(g,s);"string"==typeof e&&(e=v(e));"string"==typeof g&&(g=v(g));h=void 0;for(h in e)if(!(h in g&&(g[h]==e[h]||"inherit"==e[h]||"inherit"==g[h]))){e=s;break a}e=l}else e=c[k]==g;if(e){if(!b)return l}else if(b)return s}if(b)return l}else return l}k=f(this);if(k=k[a.nodeName()]||k["*"]){if(!(c=
k.attributes)&&!(d=k.styles))return l;if(c)for(e=0;e<c.length;e++)if(k=c[e][0],k=a.attr(k))if(g=c[e][1],g===A||"string"==typeof g&&k==g||g.test&&g.test(k))return l;if(d)for(e=0;e<d.length;e++)if(k=a.css(d[e][0]))if(c=d[e][1],c===A||"string"==typeof c&&k==c||c.test&&c.test(k))return l}return s},checkActive:function(a){switch(this.type){case D.STYLE_BLOCK:return this.checkElementRemovable(a.block||a.blockLimit,l);case D.STYLE_OBJECT:case D.STYLE_INLINE:for(var b=a.elements,c=0,e;c<b.length;c++)if(e=
b[c],!(this.type==D.STYLE_INLINE&&(z.equals(e,a.block)||z.equals(e,a.blockLimit))))if((this.type!=D.STYLE_OBJECT||e.nodeName()in P)&&this.checkElementRemovable(e,l))return l}return s}};o.getStyleText=function(a){var b=a._ST;if(b)return b;var b=a.styles,c=a.attributes&&a.attributes.style||"",e="";c.length&&(c=c.replace(Q,";"));for(var d in b){var g=b[d],f=(d+":"+g).replace(Q,";");"inherit"==g?e+=f:c+=f}c.length&&(c=i(c));return a._ST=c+e};return k.Style=o},{requires:["./base","./range","./selection",
"./domIterator","./elementPath"]});
KISSY.add("editor/core/utils",function(a){var k=a.Node,t=a.DOM,r=a.UA,o={debugUrl:function(e){var h=a.Config;h.debug||(e=e.replace(/\.(js|css)/i,"-min.$1"));-1==e.indexOf("?t")&&(e=-1!=e.indexOf("?")?e+"&":e+"?",e+="t="+encodeURIComponent(h.tag));return h.base+"editor/"+e},lazyRun:function(a,h,j){var k=a[h],m=a[j];a[h]=function(){k.apply(this,arguments);a[h]=a[j];return m.apply(this,arguments)}},getXY:function(a,h){var j=a.left,k=a.top,m=h.get("window")[0],j=j-t.scrollLeft(m),k=k-t.scrollTop(m),m=
h.get("iframe").offset(),j=j+m.left,k=k+m.top;return{left:j,top:k}},tryThese:function(a){for(var h,j=0,k=arguments.length;j<k;j++){var m=arguments[j];try{h=m();break}catch(o){}}return h},arrayCompare:function(a,h){if(!a&&!h)return!0;if(!a||!h||a.length!=h.length)return!1;for(var j=0;j<a.length;j++)if(a[j]!==h[j])return!1;return!0},clearAllMarkers:function(a){for(var h in a)a[h]._4e_clearMarkers(a,!0,void 0)},ltrim:function(a){return a.replace(/^\s+/,"")},rtrim:function(a){return a.replace(/\s+$/,
"")},isNumber:function(e){return/^\d+(.\d+)?$/.test(a.trim(e))},verifyInputs:function(e){for(var h=0;h<e.length;h++){var j=new k(e[h]),q=a.trim(o.valInput(j)),m=j.attr("data-verify"),j=j.attr("data-warning");if(m&&!RegExp(m).test(q))return alert(j),!1}return!0},sourceDisable:function(a,h){a.on("sourceMode",h.disable,h);a.on("wysiwygMode",h.enable,h)},resetInput:function(a){var h=a.attr("placeholder");h&&r.ie?(a.addClass("ks-editor-input-tip"),a.val(h)):r.ie||a.val("")},valInput:function(a,h){if(void 0===
h)return a.hasClass("ks-editor-input-tip")?"":a.val();a.removeClass("ks-editor-input-tip");a.val(h)},placeholder:function(e,h){e.attr("placeholder",h);r.ie&&(e.on("blur",function(){a.trim(e.val())||(e.addClass("ks-editor-input-tip"),e.val(h))}),e.on("focus",function(){e.removeClass("ks-editor-input-tip");a.trim(e.val())==h&&e.val("")}))},htmlEncode:function(a){return!a?a:(""+a).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")},normParams:function(e){var e=a.clone(e),
h;for(h in e){var j=e[h];a.isFunction(j)&&(e[h]=j())}return e},map:function(a,h){for(var j=0;j<a.length;j++)a[j]=h(a[j]);return a},ieEngine:document.documentMode||r.ie,preventFocus:function(a){r.ie?a.unselectable(void 0):a.attr("onmousedown","return false;")},injectDom:function(e){a.mix(t,e);for(var h in e)(function(h){k.prototype[h]=function(){var o=[].slice.call(arguments,0);o.unshift(this[0]);return(o=e[h].apply(null,o))&&(o.nodeType||a.isWindow(o))?new k(o):a.isArray(o)&&(o.__IS_NODELIST||o[0]&&
o[0].nodeType)?new k(o):o}})(h)},addRes:function(){var e=this.__res=this.__res||[];e.push.apply(e,a.makeArray(arguments))},destroyRes:function(){for(var e=this.__res||[],h=0;h<e.length;h++){var j=e[h];a.isFunction(j)?j():j.destroy?j.destroy():j.remove&&j.remove()}this.__res=[]},getQueryCmd:function(a){return"query"+("-"+a).replace(/-(\w)/g,function(a,e){return e.toUpperCase()})+"Value"}};return a.Editor.Utils=o},{requires:["./base"]});
KISSY.add("editor/core/walker",function(a,k){function t(a,f){if(this._.end)return j;var d,g=this.range,c,i=this.guard,k=this.type,o=a?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start&&(this._.start=1,g.trim(),g.collapsed))return this.end(),j;if(!a&&!this._.guardLTR){var q=g.endContainer[0],r=q.childNodes[g.endOffset];this._.guardLTR=function(a,b){return b&&(q==a||"body"==m.nodeName(a))?!1:a!=r}}if(a&&!this._.guardRTL){var t=g.startContainer[0],p=0<g.startOffset&&t.childNodes[g.startOffset-
1]||null;this._.guardRTL=function(a,b){return b&&(t==a||"body"==m.nodeName(a))?!1:a!=p}}var v=a?this._.guardRTL:this._.guardLTR;c=i?function(a,b){return v(a,b)===h?h:i(a,b)}:v;this.current?d=this.current[o](h,k,c):a?(d=g.endContainer,0<g.endOffset?(d=new n(d[0].childNodes[g.endOffset-1]),c(d[0])===h&&(d=j)):d=c(d,e)===h?j:d._4e_previousSourceNode(e,k,c,void 0)):(d=g.startContainer,d=new n(d[0].childNodes[g.startOffset]),d.length?c(d[0])===h&&(d=j):d=c(g.startContainer,e)===h?j:g.startContainer._4e_nextSourceNode(e,
k,c,void 0));for(;d&&!this._.end;){this.current=d;if(!this.evaluator||this.evaluator(d[0])!==h){if(!f)return d}else if(f&&this.evaluator)return h;d=d[o](h,k,c)}this.end();return this.current=j}function r(a){for(var e,d=j;e=t.call(this,a);)d=e;return d}function o(a){this.range=a;this.guard=this.evaluator=j;this._={}}var e=!0,h=!1,j=null,q=a.UA,m=a.DOM,w=k.XHTML_DTD,n=a.Node;a.augment(o,{end:function(){this._.end=1},next:function(){return t.call(this)},previous:function(){return t.call(this,e)},checkForward:function(){return t.call(this,
h,e)!==h},checkBackward:function(){return t.call(this,e,e)!==h},lastForward:function(){return r.call(this)},lastBackward:function(){return r.call(this,e)},reset:function(){delete this.current;this._={}},_iterator:t});a.mix(o,{blockBoundary:function(a){return function(e){return!(e.nodeType==m.NodeType.ELEMENT_NODE&&m._4e_isBlockBoundary(e,a))}},bookmark:function(a,e){function d(a){return"span"==m.nodeName(a)&&m.attr(a,"_ke_bookmark")}return function(g){var c,f;c=g.nodeType==m.NodeType.TEXT_NODE&&(f=
g.parentNode)&&d(f);c=a?c:c||d(g);return!!(e^c)}},whitespaces:function(b){return function(e){e=e.nodeType==m.NodeType.TEXT_NODE&&!a.trim(e.nodeValue);return!!(b^e)}},invisible:function(a){var e=o.whitespaces();return function(d){d=e(d)||d.nodeType==m.NodeType.ELEMENT_NODE&&!d.offsetHeight;return!!(a^d)}}});var x=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,v=o.whitespaces(),i=o.bookmark(),f=function(a){var e=m.nodeName(a);return i(a)||v(a)||1==a.nodeType&&e in w.$inline&&!(e in w.$empty)};k.Utils.injectDom({_4e_getBogus:function(a){a=
new n(a);do a=a._4e_previousSourceNode();while(a&&f(a[0]));return a&&(!q.ie?"br"==a.nodeName():3==a[0].nodeType&&x.test(a.text()))?a[0]:!1}});return k.Walker=o},{requires:["./base","./utils","./dom"]});KISSY.add("editor/core/zIndexManager",function(a){var k=a.Editor,a=k.zIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,STORE_FLASH_SHOW:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};k.baseZIndex=function(a){return(k.Config.baseZIndex||1E4)+a};return a},{requires:["./base"]});
