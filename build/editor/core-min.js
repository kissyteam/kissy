/*
Copyright 2013, KISSY UI Library v1.40dev
MIT Licensed
build time: Jun 4 20:13
*/
/*
 thanks to CKSource's intelligent work on CKEditor
 @author yiminghe@gmail.com
*/
KISSY.add("editor/core/base",function(a,m,r){m=r.Controller.extend({initializer:function(){this.__commands={};this.__controls={}}},{Config:{},XHTML_DTD:m.DTD,ATTRS:{textarea:{},iframe:{},window:{},document:{},toolBarEl:{},statusBarEl:{},handleMouseEvents:{value:!1},focusable:{value:!1},mode:{value:1},data:{getter:function(a){var m=this._getData();return void 0===m?a:m}},formatData:{getter:function(){return this._getData(1)}},customStyle:{value:""},customLink:{value:[]}}},{xclass:"editor"});m.HTML_PARSER=
{textarea:function(a){return a.one("."+this.get("prefixCls")+"editor-textarea")},data:function(a){return a.one("."+this.get("prefixCls")+"editor-textarea").val()}};a.mix(m,a.EventTarget);return KISSY.Editor=m},{requires:["htmlparser","component/base","core"]});
KISSY.add("editor/core/utils",function(a){var m=a.Node,r=a.DOM,t=a.UA,s={debugUrl:function(n){var d=a.Config;d.debug||(n=n.replace(/\.(js|css)/i,"-min.$1"));-1==n.indexOf("?t")&&(n=-1!=n.indexOf("?")?n+"&":n+"?",n+="t="+encodeURIComponent(d.tag));return d.base+"editor/"+n},lazyRun:function(a,d,g){var o=a[d],p=a[g];a[d]=function(){o.apply(this,arguments);a[d]=a[g];return p.apply(this,arguments)}},getXY:function(a,d){var g=a.left,o=a.top,p=d.get("window")[0],g=g-r.scrollLeft(p),o=o-r.scrollTop(p),p=
d.get("iframe").offset(),g=g+p.left,o=o+p.top;return{left:g,top:o}},tryThese:function(a){for(var d,g=0,o=arguments.length;g<o;g++){var p=arguments[g];try{d=p();break}catch(m){}}return d},arrayCompare:function(a,d){if(!a&&!d)return!0;if(!a||!d||a.length!=d.length)return!1;for(var g=0;g<a.length;g++)if(a[g]!==d[g])return!1;return!0},clearAllMarkers:function(a){for(var d in a)a[d]._4e_clearMarkers(a,!0,void 0)},ltrim:function(a){return a.replace(/^\s+/,"")},rtrim:function(a){return a.replace(/\s+$/,
"")},isNumber:function(n){return/^\d+(.\d+)?$/.test(a.trim(n))},verifyInputs:function(n){for(var d=0;d<n.length;d++){var g=new m(n[d]),o=a.trim(s.valInput(g)),p=g.attr("data-verify"),g=g.attr("data-warning");if(p&&!RegExp(p).test(o))return alert(g),!1}return!0},sourceDisable:function(a,d){a.on("sourceMode",d.disable,d);a.on("wysiwygMode",d.enable,d)},resetInput:function(a){var d=a.attr("placeholder");d&&t.ie?(a.addClass("ks-editor-input-tip"),a.val(d)):t.ie||a.val("")},valInput:function(a,d){if(void 0===
d)return a.hasClass("ks-editor-input-tip")?"":a.val();a.removeClass("ks-editor-input-tip");a.val(d)},placeholder:function(n,d){n.attr("placeholder",d);t.ie&&(n.on("blur",function(){a.trim(n.val())||(n.addClass("ks-editor-input-tip"),n.val(d))}),n.on("focus",function(){n.removeClass("ks-editor-input-tip");a.trim(n.val())==d&&n.val("")}))},htmlEncode:function(a){return!a?a:(""+a).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")},normParams:function(n){var n=a.clone(n),
d;for(d in n){var g=n[d];a.isFunction(g)&&(n[d]=g())}return n},map:function(a,d){for(var g=0;g<a.length;g++)a[g]=d(a[g]);return a},ieEngine:document.documentMode||t.ie,preventFocus:function(a){t.ie?a.unselectable():a.attr("onmousedown","return false;")},injectDom:function(n){a.mix(r,n);for(var d in n)(function(d){m.prototype[d]=function(){var o=[].slice.call(arguments,0);o.unshift(this[0]);return(o=n[d].apply(null,o))&&(o.nodeType||a.isWindow(o))?new m(o):a.isArray(o)&&(o.__IS_NODELIST||o[0]&&o[0].nodeType)?
new m(o):o}})(d)},addRes:function(){var n=this.__res=this.__res||[];n.push.apply(n,a.makeArray(arguments))},destroyRes:function(){for(var n=this.__res||[],d=0;d<n.length;d++){var g=n[d];a.isFunction(g)?g():g.destroy?g.destroy():g.remove&&g.remove()}this.__res=[]},getQueryCmd:function(a){return"query"+("-"+a).replace(/-(\w)/g,function(a,g){return g.toUpperCase()})+"Value"}};return a.Editor.Utils=s},{requires:["./base"]});
KISSY.add("editor/core/dom",function(a,m,r){function t(a,f){var c=a[f?"next":"prev"](s,1);if(c&&c[0].nodeType==g.ELEMENT_NODE){for(var b=[];c.attr("_ke_bookmark")||c._4e_isEmptyInlineRemovable(s);)if(b.push(c),c=f?c.next(s,1):c.prev(s,1),!c)return;if(a._4e_isIdentical(c,s)){for(var l=new p(f?a[0].lastChild:a[0].firstChild);b.length;)b.shift()._4e_move(a,!f,s);c._4e_moveChildren(a,!f,s);c.remove();l[0]&&l[0].nodeType==g.ELEMENT_NODE&&l._4e_mergeSiblings()}}}var s=s,n=m.XHTML_DTD,d=a.DOM,g=d.NodeType,
o=a.UA,p=a.Node,w={a:1,abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};m.POSITION={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};var j=m.POSITION,y={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,
"table-column":1,"table-cell":1,"table-caption":1},x={hr:1},c=function(a){return a&&(a[0]||a)};r.injectDom({_4e_sameLevel:function(a,f){var f=c(f),q=a.parentNode;return q&&q==f.parentNode},_4e_isBlockBoundary:function(i,f){var c=a.merge(x,f);return!(!y[d.css(i,"display")]&&!c[d.nodeName(i)])},_4e_index:function(a,f){for(var c=a.parentNode.childNodes,b,l=-1,e=0;e<c.length;e++)if(b=c[e],!f||!(3==b.nodeType&&b.previousSibling&&3==b.previousSibling.nodeType))if(l++,b===a)return l;return-1},_4e_move:function(a,
f,q){f=c(f);q?f.insertBefore(a,f.firstChild):f.appendChild(a)},_4e_isIdentical:function(a,f){if(!f)return!1;f=c(f);if(d.nodeName(a)!=d.nodeName(f))return!1;var q=a.attributes,b=f.attributes,l=q.length,e=b.length;if(l!=e)return!1;for(var h=0;h<l;h++){var k=q[h],j=k.name;if(k.specified&&d.attr(a,j)!=d.attr(f,j))return!1}if(8>r.ieEngine)for(h=0;h<e;h++)if(k=b[h],j=k.name,k.specified&&d.attr(a,j)!=d.attr(f,j))return!1;return!0},_4e_isEmptyInlineRemovable:function(i){if(!n.$removeEmpty[d.nodeName(i)])return!1;
for(var i=i.childNodes,f=0,c=i.length;f<c;f++){var b=i[f],l=b.nodeType;if(!(l==g.ELEMENT_NODE&&b.getAttribute("_ke_bookmark"))&&(l==g.ELEMENT_NODE&&!d._4e_isEmptyInlineRemovable(b)||l==d.NodeType.TEXT_NODE&&a.trim(b.nodeValue)))return!1}return!0},_4e_moveChildren:function(a,f,q){f=c(f);if(a!=f)if(q)for(;q=a.lastChild;)f.insertBefore(a.removeChild(q),f.firstChild);else for(;q=a.firstChild;)f.appendChild(a.removeChild(q))},_4e_mergeSiblings:function(a){a=new p(a);w[a.nodeName()]&&(t(a,!0),t(a))},_4e_splitText:function(a,
f){var c=a.ownerDocument;if(a.nodeType==d.NodeType.TEXT_NODE){if(o.ie&&f==a.nodeValue.length){var b=c.createTextNode("");d.insertAfter(b,a);return b}b=a.splitText(f);c.documentMode&&(c=c.createTextNode(""),d.insertAfter(c,b),d.remove(c));return b}},_4e_parents:function(a,f){var c=[];c.__IS_NODELIST=1;do c[f?"push":"unshift"](a);while(a=a.parentNode);return c},_4e_nextSourceNode:function(a,f,q,b){if(b&&!b.call)var l=c(b),b=function(a){return a!==l};var f=!f&&a.firstChild,e=a;if(!f){if(a.nodeType==
g.ELEMENT_NODE&&b&&!1===b(a,!0))return null;f=a.nextSibling}for(;!f&&(e=e.parentNode);){if(b&&!1===b(e,!0))return null;f=e.nextSibling}return!f||b&&!1===b(f)?null:q&&q!=f.nodeType?d._4e_nextSourceNode(f,!1,q,b):f},_4e_previousSourceNode:function(a,f,q,b){if(b&&!b.call)var l=c(b),b=function(a){return a!==l};var f=!f&&a.lastChild,e=a;if(!f){if(a.nodeType==g.ELEMENT_NODE&&b&&!1===b(a,!0))return null;f=a.previousSibling}for(;!f&&(e=e.parentNode);){if(b&&!1===b(e,!0))return null;f=e.previousSibling}return!f||
b&&!1===b(f)?null:q&&f.nodeType!=q?d._4e_previousSourceNode(f,!1,q,b):f},_4e_commonAncestor:function(a,f){f=c(f);if(a===f)return a;if(d.contains(f,a))return f;var q=a;do if(d.contains(q,f))return q;while(q=q.parentNode);return null},_4e_hasAttributes:9>r.ieEngine?function(a){for(var f=a.attributes,c=0;c<f.length;c++){var b=f[c];switch(b.name){case "class":if(a.getAttribute("class"))return!0;break;default:if(b.specified)return!0}}return!1}:function(a){o.gecko&&a.removeAttribute("_moz_dirty");return a.hasAttributes()},
_4e_position:function(a,f){var q=c(f);if(a.compareDocumentPosition)return a.compareDocumentPosition(q);if(a==q)return j.POSITION_IDENTICAL;if(a.nodeType==g.ELEMENT_NODE&&q.nodeType==g.ELEMENT_NODE){if(d.contains(a,q))return j.POSITION_CONTAINS+j.POSITION_PRECEDING;if(d.contains(q,a))return j.POSITION_IS_CONTAINED+j.POSITION_FOLLOWING;if("sourceIndex"in a)return 0>a.sourceIndex||0>q.sourceIndex?j.POSITION_DISCONNECTED:a.sourceIndex<q.sourceIndex?j.POSITION_PRECEDING:j.POSITION_FOLLOWING}for(var b=
d._4e_address(a),q=d._4e_address(q),l=Math.min(b.length,q.length),e=0;e<=l-1;e++)if(b[e]!=q[e])return b[e]<q[e]?j.POSITION_PRECEDING:j.POSITION_FOLLOWING;return b.length<q.length?j.POSITION_CONTAINS+j.POSITION_PRECEDING:j.POSITION_IS_CONTAINED+j.POSITION_FOLLOWING},_4e_address:function(a,f){for(var c=[],b=a.ownerDocument.documentElement,l=a;l&&l!=b;)c.unshift(d._4e_index(l,f)),l=l.parentNode;return c},_4e_remove:function(a,f){var c=a.parentNode;if(c){if(f)for(var b;b=a.firstChild;)c.insertBefore(a.removeChild(b),
a);c.removeChild(a)}return a},_4e_trim:function(a){d._4e_ltrim(a);d._4e_rtrim(a)},_4e_ltrim:function(a){for(var f;f=a.firstChild;){if(f.nodeType==d.NodeType.TEXT_NODE){var c=r.ltrim(f.nodeValue),b=f.nodeValue.length;if(c)c.length<b&&(d._4e_splitText(f,b-c.length),a.removeChild(a.firstChild));else{a.removeChild(f);continue}}break}},_4e_rtrim:function(a){for(var f;f=a.lastChild;){if(f.type==d.NodeType.TEXT_NODE){var c=r.rtrim(f.nodeValue),b=f.nodeValue.length;if(c)c.length<b&&(d._4e_splitText(f,c.length),
a.removeChild(a.lastChild));else{a.removeChild(f);continue}}break}!o.ie&&!o.opera&&(f=a.lastChild)&&1==f.nodeType&&"br"==d.nodeName(f)&&a.removeChild(f)},_4e_appendBogus:function(c){for(var f=c.lastChild;f&&f.nodeType==d.NodeType.TEXT_NODE&&!a.trim(f.nodeValue);)f=f.previousSibling;if(!f||f.nodeType==d.NodeType.TEXT_NODE||"br"!==d.nodeName(f))f=o.opera?c.ownerDocument.createTextNode(""):c.ownerDocument.createElement("br"),c.appendChild(f)},_4e_setMarker:function(c,f,d,b){var c=new p(c),l=c.data("list_marker_id")||
c.data("list_marker_id",a.guid()).data("list_marker_id"),e=c.data("list_marker_names")||c.data("list_marker_names",{}).data("list_marker_names");f[l]=c;e[d]=1;return c.data(d,b)},_4e_clearMarkers:function(a,f,c){var a=new p(a),b=a.data("list_marker_names"),l=a.data("list_marker_id"),e;for(e in b)a.removeData(e);a.removeData("list_marker_names");c&&(a.removeData("list_marker_id"),delete f[l])},_4e_copyAttributes:function(a,f,c){for(var f=new p(f),b=a.attributes,c=c||{},l=0;l<b.length;l++){var e=b[l],
h=e.name.toLowerCase(),k;if(!(h in c))if("checked"==h&&(k=d.attr(a,h)))f.attr(h,k);else if(e.specified||o.ie&&e.value&&"value"==h)k=d.attr(a,h),null===k&&(k=e.nodeValue),f.attr(h,k)}""!==a.style.cssText&&(f[0].style.cssText=a.style.cssText)},_4e_isEditable:function(a){a=d.nodeName(a);return(a=!n.$nonEditable[a]&&(n[a]||n.span))&&a["#text"]},_4e_getByAddress:function(a,f,c){for(var a=a.documentElement,b=0;a&&b<f.length;b++){var l=f[b];if(c)for(var e=-1,h=0;h<a.childNodes.length;h++){var k=a.childNodes[h];
if(!(!0===c&&3==k.nodeType&&k.previousSibling&&3==k.previousSibling.nodeType)&&(e++,e==l)){a=k;break}}else a=a.childNodes[l]}return a}})},{requires:["./base","./utils"]});
KISSY.add("editor/core/focusManager",function(a){function m(){var a=this;a.__iframeFocus=o;g=a;d&&clearTimeout(d);d=setTimeout(function(){a.fire("focus")},30)}function r(){var a=this;a.__iframeFocus=p;g=w;d&&clearTimeout(d);d=setTimeout(function(){a.fire("blur")},30)}var t=a.Editor,s=a.Event,n={},d,g,a={refreshAll:function(){for(var a in n){var d=n[a].get("document")[0];d.designMode="off";d.designMode="on"}},currentInstance:function(){return g},getInstance:function(a){return n[a]},add:function(a){var d=
a.get("window")[0];s.on(d,"focus",m,a);s.on(d,"blur",r,a)},register:function(a){n[a._UUID]=a},remove:function(a){delete n[a._UUID];var d=a.get("window")[0];s.remove(d,"focus",m,a);s.remove(d,"blur",r,a)}},o=!0,p=!1,w=null;a.refreshAll=a.refreshAll;t.focusManager=a;t.getInstances=function(){return n};return a},{requires:["./base","./dom"]});
KISSY.add("editor/core/walker",function(a,m){function r(a,c){if(this._.end)return g;var b,l=this.range,e,h=this.guard,k=this.type,i=a?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start&&(this._.start=1,l.trim(),l.collapsed))return this.end(),g;if(!a&&!this._.guardLTR){var o=l.endContainer[0],m=o.childNodes[l.endOffset];this._.guardLTR=function(a,b){return b&&(o==a||"body"==p.nodeName(a))?!1:a!=m}}if(a&&!this._.guardRTL){var r=l.startContainer[0],I=0<l.startOffset&&r.childNodes[l.startOffset-
1]||null;this._.guardRTL=function(a,b){return b&&(r==a||"body"==p.nodeName(a))?!1:a!=I}}var K=a?this._.guardRTL:this._.guardLTR;e=h?function(a,b){return K(a,b)===d?d:h(a,b)}:K;this.current?b=this.current[i](d,k,e):a?(b=l.endContainer,0<l.endOffset?(b=new j(b[0].childNodes[l.endOffset-1]),e(b[0])===d&&(b=g)):b=e(b,n)===d?g:b._4e_previousSourceNode(n,k,e,void 0)):(b=l.startContainer,b=new j(b[0].childNodes[l.startOffset]),b.length?e(b[0])===d&&(b=g):b=e(l.startContainer,n)===d?g:l.startContainer._4e_nextSourceNode(n,
k,e,void 0));for(;b&&!this._.end;){this.current=b;if(!this.evaluator||this.evaluator(b[0])!==d){if(!c)return b}else if(c&&this.evaluator)return d;b=b[i](d,k,e)}this.end();return this.current=g}function t(a){for(var c,b=g;c=r.call(this,a);)b=c;return b}function s(a){this.range=a;this.guard=this.evaluator=g;this._={}}var n=!0,d=!1,g=null,o=a.UA,p=a.DOM,w=m.XHTML_DTD,j=a.Node;a.augment(s,{end:function(){this._.end=1},next:function(){return r.call(this)},previous:function(){return r.call(this,n)},checkForward:function(){return r.call(this,
d,n)!==d},checkBackward:function(){return r.call(this,n,n)!==d},lastForward:function(){return t.call(this)},lastBackward:function(){return t.call(this,n)},reset:function(){delete this.current;this._={}},_iterator:r});a.mix(s,{blockBoundary:function(a){return function(c){return!(c.nodeType==p.NodeType.ELEMENT_NODE&&p._4e_isBlockBoundary(c,a))}},bookmark:function(a,c){function b(a){return"span"==p.nodeName(a)&&p.attr(a,"_ke_bookmark")}return function(l){var e,h;e=l.nodeType==p.NodeType.TEXT_NODE&&(h=
l.parentNode)&&b(h);e=a?e:e||b(l);return!!(c^e)}},whitespaces:function(c){return function(d){d=d.nodeType==p.NodeType.TEXT_NODE&&!a.trim(d.nodeValue);return!!(c^d)}},invisible:function(a){var c=s.whitespaces();return function(b){b=c(b)||b.nodeType==p.NodeType.ELEMENT_NODE&&!b.offsetHeight;return!!(a^b)}}});var y=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,x=s.whitespaces(),c=s.bookmark(),i=function(a){var d=p.nodeName(a);return c(a)||x(a)||1==a.nodeType&&d in w.$inline&&!(d in w.$empty)};m.Utils.injectDom({_4e_getBogus:function(a){a=
new j(a);do a=a._4e_previousSourceNode();while(a&&i(a[0]));return a&&(!o.ie?"br"==a.nodeName():3==a[0].nodeType&&y.test(a.text()))?a[0]:!1}});return m.Walker=s},{requires:["./base","./utils","./dom"]});
KISSY.add("editor/core/elementPath",function(a){function m(a){for(var p=n,m=n,j=[];a;){if(a[0].nodeType==t.NodeType.ELEMENT_NODE){this.lastElement||(this.lastElement=a);var r=a.nodeName();if(!m&&(!p&&d[r]&&(p=a),g[r])){var x;if(x=!p)if(x="div"==r){a:{x=a[0].childNodes;for(var c=0,i=x.length;c<i;c++){var f=x[c];if(f.nodeType==t.NodeType.ELEMENT_NODE&&s.$block[f.nodeName.toLowerCase()]){x=!0;break a}}x=!1}x=!x}x?p=a:m=a}j.push(a);if("body"==r)break}a=a.parent()}this.block=p;this.blockLimit=m;this.elements=
j}var r=a.Editor,t=a.DOM,s=r.XHTML_DTD,n=null,d={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},g={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};m.prototype={constructor:m,compare:function(a){var d=this.elements,a=a&&a.elements;if(!a||d.length!=a.length)return!1;for(var g=0;g<d.length;g++)if(!t.equals(d[g],a[g]))return!1;return!0},contains:function(a){for(var d=this.elements,g=0;g<d.length;g++)if(d[g].nodeName()in a)return d[g];return n},toString:function(){var a=
this.elements,d,g=[];for(d=0;d<a.length;d++)g.push(a[d].nodeName());return g.toString()}};return r.ElementPath=m},{requires:["./base","./dom"]});
KISSY.add("editor/core/range",function(a,m,r,t,s){function n(c){var e=c.nodeType!=f.NodeType.TEXT_NODE&&f.nodeName(c)in b.$removeEmpty,l=c.nodeType==f.NodeType.TEXT_NODE&&!a.trim(c.nodeValue),c=!!c.parentNode.getAttribute("_ke_bookmark");return e||l||c}function d(a){return!k(a)&&!v(a)}function g(b){var c=y;return function(e){if(v(e))return j;if(e.nodeType==f.NodeType.TEXT_NODE){if(a.trim(e.nodeValue).length)return y}else if(e.nodeType==f.NodeType.ELEMENT_NODE&&(e=f.nodeName(e),!F[e]))if(!b&&!q.ie&&
"br"==e&&!c)c=j;else return y;return j}}function o(a,b){var c=a.startContainer,e=a.endContainer,h=a.startOffset,u=a.endOffset,d,k=y,i=y,g=void 0,v=a.document,q;0<b&&(g=v.createDocumentFragment());if(a.collapsed)return g;a.optimizeBookmark();e[0].nodeType==f.NodeType.TEXT_NODE?(i=j,e=e._4e_splitText(u)):0<e[0].childNodes.length&&(u>=e[0].childNodes.length?(e=new l(e[0].appendChild(v.createTextNode(""))),q=j):e=new l(e[0].childNodes[u]));c[0].nodeType==f.NodeType.TEXT_NODE?(k=j,c._4e_splitText(h)):
h?h>=c[0].childNodes.length?(c=new l(c[0].appendChild(v.createTextNode(""))),d=j):c=new l(c[0].childNodes[h].previousSibling):(d=new l(v.createTextNode("")),c.prepend(d),c=d,d=j);var J=c._4e_parents(),L=e._4e_parents();J.each(function(a,c){J[c]=a});L.each(function(a,c){L[c]=a});for(var G,N,v=0;v<J.length&&!(G=J[v],N=L[v],!G.equals(N));v++);for(var h=g,C,m,z=v;z<J.length;z++){C=J[z];u=0<b&&!C.equals(c)?h.appendChild(C.clone()[0]):null;C=C[0].nextSibling;m=L[z];for(var n=e[0],o=m&&m[0];C&&!(o==C||n==
C);)m=C.nextSibling,2==b?h.appendChild(C.cloneNode(j)):(f._4e_remove(C),1==b&&h.appendChild(C)),C=m;u&&(h=u)}for(h=g;v<L.length;v++){C=L[v];u=0<b&&!C.equals(e)?h.appendChild(C.clone()[0]):null;if(!J[v]||!C._4e_sameLevel(J[v]))for(C=C[0].previousSibling;C;)m=C.previousSibling,2==b?h.insertBefore(C.cloneNode(j),h.firstChild):(f._4e_remove(C),1==b&&h.insertBefore(C,h.firstChild)),C=m;u&&(h=u)}if(2==b){if(k&&(G=c[0],G.nodeType==f.NodeType.TEXT_NODE&&G.nextSibling&&G.nextSibling.nodeType==f.NodeType.TEXT_NODE&&
(G.data+=G.nextSibling.data,G.parentNode.removeChild(G.nextSibling))),i)i=e[0],i.nodeType==f.NodeType.TEXT_NODE&&i.previousSibling&&i.previousSibling.nodeType==f.NodeType.TEXT_NODE&&(i.previousSibling.data+=i.data,i.parentNode.removeChild(i))}else{if(G&&N&&(!c._4e_sameLevel(G)||!e._4e_sameLevel(N)))i=G._4e_index(),d&&G._4e_sameLevel(c)&&i--,a.setStart(G.parent(),i+1);a.collapse(j)}d&&c.remove();q&&e.remove();return g}function p(a){a.collapsed=a.startContainer&&a.endContainer&&a.startContainer[0]==
a.endContainer[0]&&a.startOffset==a.endOffset}function w(a){this.endOffset=this.endContainer=this.startOffset=this.startContainer=x;this.collapsed=j;this.document=a}m.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var j=!0,y=!1,x=null,c=m.RANGE,i=m.POSITION,f=a.DOM,q=a.UA,b=m.XHTML_DTD,l=a.Node,e=l.all,h={area:1,base:1,br:1,col:1,hr:1,
img:1,input:1,link:1,meta:1,param:1},k=new t.whitespaces,v=new t.bookmark,z=t.whitespaces(j),A=t.bookmark(!1,!0),F={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};a.augment(w,{toString:function(){var a=[],c=this.startContainer[0],b=this.endContainer[0];a.push((c.id||c.nodeName)+":"+this.startOffset);a.push((b.id||b.nodeName)+":"+this.endOffset);return a.join("<br/>")},optimize:function(){var a=
this.startContainer,c=this.startOffset;a[0].nodeType!=f.NodeType.ELEMENT_NODE&&(c?c>=a[0].nodeValue.length&&this.setStartAfter(a):this.setStartBefore(a));a=this.endContainer;c=this.endOffset;a[0].nodeType!=f.NodeType.ELEMENT_NODE&&(c?c>=a[0].nodeValue.length&&this.setEndAfter(a):this.setEndBefore(a))},setStartAfter:function(a){this.setStart(a.parent(),a._4e_index()+1)},setStartBefore:function(a){this.setStart(a.parent(),a._4e_index())},setEndAfter:function(a){this.setEnd(a.parent(),a._4e_index()+
1)},setEndBefore:function(a){this.setEnd(a.parent(),a._4e_index())},optimizeBookmark:function(){var a=this.startContainer,c=this.endContainer;a&&"span"==a.nodeName()&&a.attr("_ke_bookmark")&&this.setStartBefore(a);c&&"span"==c.nodeName()&&c.attr("_ke_bookmark")&&this.setEndAfter(c)},setStart:function(a,c){a[0].nodeType==f.NodeType.ELEMENT_NODE&&h[a.nodeName()]&&(a=a.parent(),c=a._4e_index());this.startContainer=a;this.startOffset=c;this.endContainer||(this.endContainer=a,this.endOffset=c);p(this)},
setEnd:function(a,c){a[0].nodeType==f.NodeType.ELEMENT_NODE&&h[a.nodeName()]&&(a=a.parent(),c=a._4e_index()+1);this.endContainer=a;this.endOffset=c;this.startContainer||(this.startContainer=a,this.startOffset=c);p(this)},setStartAt:function(a,b){switch(b){case c.POSITION_AFTER_START:this.setStart(a,0);break;case c.POSITION_BEFORE_END:a[0].nodeType==f.NodeType.TEXT_NODE?this.setStart(a,a[0].nodeValue.length):this.setStart(a,a[0].childNodes.length);break;case c.POSITION_BEFORE_START:this.setStartBefore(a);
break;case c.POSITION_AFTER_END:this.setStartAfter(a)}p(this)},setEndAt:function(a,b){switch(b){case c.POSITION_AFTER_START:this.setEnd(a,0);break;case c.POSITION_BEFORE_END:a[0].nodeType==f.NodeType.TEXT_NODE?this.setEnd(a,a[0].nodeValue.length):this.setEnd(a,a[0].childNodes.length);break;case c.POSITION_BEFORE_START:this.setEndBefore(a);break;case c.POSITION_AFTER_END:this.setEndAfter(a)}p(this)},cloneContents:function(){return o(this,2)},deleteContents:function(){return o(this,0)},extractContents:function(){return o(this,
1)},collapse:function(a){a?(this.endContainer=this.startContainer,this.endOffset=this.startOffset):(this.startContainer=this.endContainer,this.startOffset=this.endOffset);this.collapsed=j},clone:function(){var a=new w(this.document);a.startContainer=this.startContainer;a.startOffset=this.startOffset;a.endContainer=this.endContainer;a.endOffset=this.endOffset;a.collapsed=this.collapsed;return a},getEnclosedNode:function(){var a=this.clone();a.optimize();if(a.startContainer[0].nodeType!=f.NodeType.ELEMENT_NODE||
a.endContainer[0].nodeType!=f.NodeType.ELEMENT_NODE)return x;var c=new t(a);c.evaluator=function(a){return z(a)&&A(a)};a=c.next();c.reset();c=c.previous();return a&&a.equals(c)?a:x},shrink:function(a,b){if(!this.collapsed){var a=a||c.SHRINK_TEXT,e=this.clone(),l=this.startContainer,h=this.endContainer,u=this.startOffset,d=this.endOffset,k=j,i,v,g=j;l&&l[0].nodeType==f.NodeType.TEXT_NODE&&(u?u>=l[0].nodeValue.length?e.setStartAfter(l):(e.setStartBefore(l),k=y):e.setStartBefore(l));h&&h[0].nodeType==
f.NodeType.TEXT_NODE&&(d?d>=h[0].nodeValue.length?e.setEndAfter(h):(e.setEndAfter(h),g=y):e.setEndBefore(h));if(k||g)v=new t(e),v.evaluator=function(b){return b.nodeType==(a==c.SHRINK_ELEMENT?f.NodeType.ELEMENT_NODE:f.NodeType.TEXT_NODE)},v.guard=function(b,e){if(a==c.SHRINK_ELEMENT&&b.nodeType==f.NodeType.TEXT_NODE||e&&b==i)return y;!e&&b.nodeType==f.NodeType.ELEMENT_NODE&&(i=b);return j};k&&(e=v[a==c.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(e,b?c.POSITION_AFTER_START:c.POSITION_BEFORE_START);
g&&(v.reset(),(v=v[a==c.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(v,b?c.POSITION_BEFORE_END:c.POSITION_AFTER_END));return k||g}},createBookmark2:function(a){var c=this.startContainer,b=this.endContainer,e=this.startOffset,h=this.endOffset,u,d;if(!c||!b)return{start:0,end:0};if(a){if(c[0].nodeType==f.NodeType.ELEMENT_NODE&&(u=new l(c[0].childNodes[e]))&&u[0]&&u[0].nodeType==f.NodeType.TEXT_NODE&&0<e&&u[0].previousSibling.nodeType==f.NodeType.TEXT_NODE)c=u,e=0;for(;c[0].nodeType==
f.NodeType.TEXT_NODE&&(d=c.prev(void 0,1))&&d[0].nodeType==f.NodeType.TEXT_NODE;)c=d,e+=d[0].nodeValue.length;if(!this.collapsed){if(b[0].nodeType==f.NodeType.ELEMENT_NODE&&(u=new l(b[0].childNodes[h]))&&u[0]&&u[0].nodeType==f.NodeType.TEXT_NODE&&0<h&&u[0].previousSibling.nodeType==f.NodeType.TEXT_NODE)b=u,h=0;for(;b[0].nodeType==f.NodeType.TEXT_NODE&&(d=b.prev(void 0,1))&&d[0].nodeType==f.NodeType.TEXT_NODE;)b=d,h+=d[0].nodeValue.length}}return{start:c._4e_address(a),end:this.collapsed?x:b._4e_address(a),
startOffset:e,endOffset:h,normalized:a,is2:j}},createBookmark:function(b){var e,h,f,d,u=this.collapsed;e=new l("<span>",x,this.document);e.attr("_ke_bookmark",1);e.css("display","none");e.html("&nbsp;");b&&(f=a.guid("ke_bm_"),e.attr("id",f+"S"));u||(h=e.clone(),h.html("&nbsp;"),b&&h.attr("id",f+"E"),d=this.clone(),d.collapse(),d.insertNode(h));d=this.clone();d.collapse(j);d.insertNode(e);h?(this.setStartAfter(e),this.setEndBefore(h)):this.moveToPosition(e,c.POSITION_AFTER_END);return{startNode:b?
f+"S":e,endNode:b?f+"E":h,serializable:b,collapsed:u}},moveToPosition:function(a,c){this.setStartAt(a,c);this.collapse(j)},trim:function(a,c){var b=this.startContainer,e=this.startOffset,h=this.collapsed;if((!a||h)&&b[0]&&b[0].nodeType==f.NodeType.TEXT_NODE){if(e)if(e>=b[0].nodeValue.length)e=b._4e_index()+1,b=b.parent();else{var l=b._4e_splitText(e),e=b._4e_index()+1,b=b.parent();f.equals(this.startContainer,this.endContainer)?this.setEnd(l,this.endOffset-this.startOffset):f.equals(b,this.endContainer)&&
(this.endOffset+=1)}else e=b._4e_index(),b=b.parent();this.setStart(b,e);if(h){this.collapse(j);return}}b=this.endContainer;e=this.endOffset;!c&&!h&&b[0]&&b[0].nodeType==f.NodeType.TEXT_NODE&&(e?(e>=b[0].nodeValue.length||b._4e_splitText(e),e=b._4e_index()+1):e=b._4e_index(),b=b.parent(),this.setEnd(b,e))},insertNode:function(a){this.optimizeBookmark();this.trim(y,j);var b=this.startContainer;b[0].insertBefore(a[0],b[0].childNodes[this.startOffset]||null);b[0]==this.endContainer[0]&&this.endOffset++;
this.setStartBefore(a)},moveToBookmark:function(b){var c=e(this.document);if(b.is2){var h=c._4e_getByAddress(b.start,b.normalized),f=b.startOffset,c=b.end&&c._4e_getByAddress(b.end,b.normalized),b=b.endOffset;this.setStart(h,f);c?this.setEnd(c,b):this.collapse(j)}else h=(f=b.serializable)?a.one("#"+b.startNode,c):b.startNode,b=f?a.one("#"+b.endNode,c):b.endNode,this.setStartBefore(h),h._4e_remove(),b&&b[0]?(this.setEndBefore(b),b._4e_remove()):this.collapse(j)},getCommonAncestor:function(a,b){var c=
this.startContainer,e=this.endContainer,c=c[0]==e[0]?a&&c[0].nodeType==f.NodeType.ELEMENT_NODE&&this.startOffset==this.endOffset-1?new l(c[0].childNodes[this.startOffset]):c:c._4e_commonAncestor(e);return b&&c[0].nodeType==f.NodeType.TEXT_NODE?c.parent():c},enlarge:function(){function a(b,c,h,l){var d=b[c?"startContainer":"endContainer"],i,g=c?0:1,j=0,q=c?"previousSibling":"nextSibling";i=b[c?"startOffset":"endOffset"];if(d[0].nodeType==f.NodeType.TEXT_NODE){if(c){if(i)return}else if(i<d[0].nodeValue.length)return;
i=d[0][q];d=d[0].parentNode}else i=d[0].childNodes[i+(c?-1:1)]||null,d=d[0];for(;d;){for(;i;)if(k(i)||v(i))i=i[q];else break;if(i){if(!j)b[c?"setStartAfter":"setEndBefore"](e(i));break}d=e(d);if("body"==d.nodeName())break;if(j||d.equals(l))h[g]=d,j=1;else b[c?"setStartBefore":"setEndAfter"](d);i=d[0][q];d=d[0].parentNode}}return function(b){switch(b){case c.ENLARGE_ELEMENT:if(this.collapsed)break;var b=this.getCommonAncestor(),h=[];a(this,1,h,b);a(this,0,h,b);h[0]&&h[1]&&(b=h[0].contains(h[1])?h[1]:
h[0],this.setStartBefore(b),this.setEndAfter(b));break;case c.ENLARGE_BLOCK_CONTENTS:case c.ENLARGE_LIST_ITEM_CONTENTS:var d=new w(this.document),h=new l(this.document.body);d.setStartAt(h,c.POSITION_AFTER_START);d.setEnd(this.startContainer,this.startOffset);var d=new t(d),k,u,i=t.blockBoundary(b==c.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:x),v=function(a){var b=i(a);b||(k=e(a));return b},g=function(a){var b=v(a);!b&&"br"==f.nodeName(a)&&(u=e(a));return b};d.guard=v;d=d.lastBackward();k=k||h;this.setStartAt(k,
"br"!=k.nodeName()&&(!d&&this.checkStartOfBlock()||d&&k.contains(d))?c.POSITION_AFTER_START:c.POSITION_AFTER_END);d=this.clone();d.collapse();d.setEndAt(h,c.POSITION_BEFORE_END);d=new t(d);d.guard=b==c.ENLARGE_LIST_ITEM_CONTENTS?g:v;k=x;d=d.lastForward();k=k||h;this.setEndAt(k,!d&&this.checkEndOfBlock()||d&&k.contains(d)?c.POSITION_BEFORE_END:c.POSITION_BEFORE_START);u&&this.setEndAfter(u)}}}(),checkStartOfBlock:function(){var b=this.startContainer,e=this.startOffset;if(e&&b[0].nodeType==f.NodeType.TEXT_NODE&&
a.trim(b[0].nodeValue.substring(0,e)).length)return y;this.trim();b=new s(this.startContainer);e=this.clone();e.collapse(j);e.setStartAt(b.block||b.blockLimit,c.POSITION_AFTER_START);b=new t(e);b.evaluator=g(j);return b.checkBackward()},checkEndOfBlock:function(){var b=this.endContainer,e=this.endOffset;if(b[0].nodeType==f.NodeType.TEXT_NODE&&a.trim(b[0].nodeValue.substring(e)).length)return y;this.trim();b=new s(this.endContainer);e=this.clone();e.collapse(y);e.setEndAt(b.block||b.blockLimit,c.POSITION_BEFORE_END);
b=new t(e);b.evaluator=g(y);return b.checkForward()},checkBoundaryOfElement:function(a,b){var e=this.clone();e[b==c.START?"setStartAt":"setEndAt"](a,b==c.START?c.POSITION_AFTER_START:c.POSITION_BEFORE_END);e=new t(e);e.evaluator=n;return e[b==c.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var a=this.startContainer,b=this.endContainer,c=this.startOffset,h=this.endOffset,d;if(a[0].nodeType==f.NodeType.ELEMENT_NODE)if(d=a[0].childNodes.length,d>c)a=e(a[0].childNodes[c]);else if(0==
d)a=a._4e_previousSourceNode();else{for(a=a[0];a.lastChild;)a=a.lastChild;a=e(a);a=a._4e_nextSourceNode()||a}if(b[0].nodeType==f.NodeType.ELEMENT_NODE)if(d=b[0].childNodes.length,d>h)b=e(b[0].childNodes[h])._4e_previousSourceNode(j);else if(0==d)b=b._4e_previousSourceNode();else{for(b=b[0];b.lastChild;)b=b.lastChild;b=e(b)}a._4e_position(b)&i.POSITION_FOLLOWING&&(a=b);return{startNode:a,endNode:b}},fixBlock:function(a,b){var h=this.createBookmark(),d=e(this.document.createElement(b));this.collapse(a);
this.enlarge(c.ENLARGE_BLOCK_CONTENTS);d[0].appendChild(this.extractContents());d._4e_trim();q.ie||d._4e_appendBogus();this.insertNode(d);this.moveToBookmark(h);return d},splitBlock:function(b){var e=new s(this.startContainer),h=new s(this.endContainer),d=e.block,f=h.block,l=x;if(!e.blockLimit.equals(h.blockLimit))return x;"br"!=b&&(d||(d=this.fixBlock(j,b),f=(new s(this.endContainer)).block),f||(f=this.fixBlock(y,b)));b=d&&this.checkStartOfBlock();e=f&&this.checkEndOfBlock();this.deleteContents();
d&&d[0]==f[0]&&(e?(l=new s(this.startContainer),this.moveToPosition(f,c.POSITION_AFTER_END),f=x):b?(l=new s(this.startContainer),this.moveToPosition(d,c.POSITION_BEFORE_START),d=x):(f=this.splitElement(d),!q.ie&&!a.inArray(d.nodeName(),["ul","ol"])&&d._4e_appendBogus()));return{previousBlock:d,nextBlock:f,wasStartOfBlock:b,wasEndOfBlock:e,elementPath:l}},splitElement:function(a){if(!this.collapsed)return x;this.setEndAt(a,c.POSITION_BEFORE_END);var b=this.extractContents(),e=a.clone(y);e[0].appendChild(b);
e.insertAfter(a);this.moveToPosition(a,c.POSITION_AFTER_END);return e},moveToElementEditablePosition:function(a,b){for(var e=0;a;){if(a[0].nodeType==f.NodeType.TEXT_NODE){this.moveToPosition(a,b?c.POSITION_AFTER_END:c.POSITION_BEFORE_START);e=1;break}a[0].nodeType==f.NodeType.ELEMENT_NODE&&a._4e_isEditable()&&(this.moveToPosition(a,b?c.POSITION_BEFORE_END:c.POSITION_AFTER_START),e=1);var h=a,l=e,k=void 0;h[0].nodeType==f.NodeType.ELEMENT_NODE&&h._4e_isEditable()&&(k=h[b?"last":"first"](d,1));!l&&
!k&&(k=h[b?"prev":"next"](d,1));a=k}return!!e},selectNodeContents:function(a){var b=a[0];this.setStart(a,0);this.setEnd(a,b.nodeType==f.NodeType.TEXT_NODE?b.nodeValue.length:b.childNodes.length)},insertNodeByDtd:function(a){var c,e,h,d=a.nodeName();c=b.$block[d];this.deleteContents();if(c){for(c=this.getCommonAncestor(y,j);(e=b[c.nodeName()])&&(!e||!e[d]);){var f=c.parent();this.checkStartOfBlock()&&this.checkEndOfBlock()?(this.setStartBefore(c),this.collapse(j),c.remove()):h=c;c=f}h&&this.splitElement(h)}this.insertNode(a)}});
r.injectDom({_4e_breakParent:function(a,b){var b=e(b),a=e(a),c,h=new m.Range(a[0].ownerDocument);h.setStartAfter(a);h.setEndAfter(b);c=h.extractContents();h.insertNode(a.remove());a.after(c)}});return m.Range=w},{requires:["./base","./utils","./walker","./elementPath","./dom"]});
KISSY.add("editor/core/selection",function(a){function m(a){this.document=a;this._={cache:{}};if(j)try{var c=this.getNative().createRange();if(!c||c.item&&c.item(0).ownerDocument!=a||c.parentElement&&c.parentElement().ownerDocument!=a)this.isInvalid=s}catch(e){this.isInvalid=s}}function r(a){a=new m(a);return!a||a.isInvalid?n:a}var t=a.Editor;t.SELECTION={SELECTION_NONE:1,SELECTION_TEXT:2,SELECTION_ELEMENT:3};var s=!0,n=null,d=a.UA,g=a.DOM,o=a.Node,p=t.SELECTION,w=t.RANGE,j=d.ie,y=t.Walker,x=t.Range,
c={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};a.augment(m,{getNative:!j?function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=g.getWindow(this.document).getSelection())}:function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=this.document.selection)},getType:!j?function(){var a=this._.cache;if(a.type)return a.type;var d=p.SELECTION_TEXT,e=this.getNative();if(e){if(1==e.rangeCount){var e=
e.getRangeAt(0),h=e.startContainer;h==e.endContainer&&h.nodeType==g.NodeType.ELEMENT_NODE&&1==Number(e.endOffset-e.startOffset)&&c[h.childNodes[e.startOffset].nodeName.toLowerCase()]&&(d=p.SELECTION_ELEMENT)}}else d=p.SELECTION_NONE;return a.type=d}:function(){var a=this._.cache;if(a.type)return a.type;var c=p.SELECTION_NONE;try{var e=this.getNative(),h=e.type;"Text"==h&&(c=p.SELECTION_TEXT);"Control"==h&&(c=p.SELECTION_ELEMENT);e.createRange().parentElement&&(c=p.SELECTION_TEXT)}catch(d){}return a.type=
c},getRanges:j?function(){var a=function(a,b){a=a.duplicate();a.collapse(b);for(var c=a.parentElement(),d=c.childNodes,f,i=0;i<d.length;i++){var j=d[i];if(j.nodeType==g.NodeType.ELEMENT_NODE){f=a.duplicate();f.moveToElementText(j);var j=f.compareEndPoints("StartToStart",a),q=f.compareEndPoints("EndToStart",a);f.collapse();if(0<j)break;else{if(!j||1==q&&-1==j)return{container:c,offset:i};if(!q)return{container:c,offset:i+1}}f=n}}f||(f=a.duplicate(),f.moveToElementText(c),f.collapse(!1));f.setEndPoint("StartToStart",
a);f=(""+f.text).replace(/\r\n|\r/g,"\n").length;try{for(;0<f;)f-=d[--i].nodeValue.length}catch(m){f=0}return 0===f?{container:c,offset:i}:{container:d[i],offset:-f}};return function(c){var e=this._.cache;if(e.ranges&&!c)return e.ranges;var h=this.getNative(),c=h&&h.createRange(),d=this.getType();if(!h)return[];if(d==p.SELECTION_TEXT)return h=new x(this.document),d=a(c,s),h.setStart(new o(d.container),d.offset),d=a(c),h.setEnd(new o(d.container),d.offset),e.ranges=[h];if(d==p.SELECTION_ELEMENT){e=
e.ranges=[];for(d=0;d<c.length;d++){for(var f=c.item(d),i=f.parentNode,g=0,h=new x(this.document);g<i.childNodes.length&&i.childNodes[g]!=f;g++);h.setStart(new o(i),g);h.setEnd(new o(i),g+1);e.push(h)}return e}return e.ranges=[]}}():function(a){var c=this._.cache;if(c.ranges&&!a)return c.ranges;var a=[],e=this.getNative();if(!e)return[];for(var d=0;d<e.rangeCount;d++){var f=e.getRangeAt(d),i=new x(this.document);i.setStart(new o(f.startContainer),f.startOffset);i.setEnd(new o(f.endContainer),f.endOffset);
a.push(i)}return c.ranges=a},getStartElement:function(){var a=this._.cache;if(void 0!==a.startElement)return a.startElement;var c,e=this.getNative();switch(this.getType()){case p.SELECTION_ELEMENT:return this.getSelectedElement();case p.SELECTION_TEXT:var d=this.getRanges()[0];if(d&&!d.collapsed){for(d.optimize();s;)if(c=d.startContainer,d.startOffset==(c[0].nodeType===g.NodeType.ELEMENT_NODE?c[0].childNodes.length:c[0].nodeValue.length)&&!c._4e_isBlockBoundary())d.setStartAfter(c);else break;c=d.startContainer;
if(c[0].nodeType!=g.NodeType.ELEMENT_NODE)return c.parent();c=new o(c[0].childNodes[d.startOffset]);if(!c[0]||c[0].nodeType!=g.NodeType.ELEMENT_NODE)return d.startContainer;for(d=c[0].firstChild;d&&d.nodeType==g.NodeType.ELEMENT_NODE;)c=new o(d),d=d.firstChild;return c}if(j)d=e.createRange(),d.collapse(s),c=new o(d.parentElement());else{if((c=e.anchorNode)&&c.nodeType!=g.NodeType.ELEMENT_NODE)c=c.parentNode;c&&(c=new o(c))}}return a.startElement=c},getSelectedElement:function(){var a,d=this._.cache;
if(void 0!==d.selectedElement)return d.selectedElement;j&&(a=this.getNative().createRange(),a=a.item&&a.item(0));var e;if(a)e=new o(a);else{a=this.getRanges()[0];for(var f,k=2;k&&(!(e=a.getEnclosedNode())||!(e[0].nodeType==g.NodeType.ELEMENT_NODE&&c[e.nodeName()]&&(f=e)));k--)a.shrink(w.SHRINK_ELEMENT);e=f}return d.selectedElement=e},reset:function(){this._.cache={}},selectElement:function(a){var c,e=this.document;if(j)try{c=e.body.createControlRange(),c.addElement(a[0]),c.select()}catch(d){c=e.body.createTextRange(),
c.moveToElementText(a[0]),c.select()}finally{}else c=e.createRange(),c.selectNode(a[0]),a=this.getNative(),a.removeAllRanges(),a.addRange(c);this.reset()},selectRanges:function(a){if(j){if(1<a.length){var c=a[a.length-1];a[0].setEnd(c.endContainer,c.endOffset);a.length=1}a[0]&&a[0].select()}else{c=this.getNative();if(!c)return;c.removeAllRanges();for(var e=0;e<a.length;e++){var f=a[e],k=this.document.createRange(),i=f.startContainer;if(f.collapsed&&(d.gecko&&1.09>d.gecko||d.opera||d.webkit)&&i[0].nodeType==
g.NodeType.ELEMENT_NODE&&!i[0].childNodes.length)i[0].appendChild(this.document.createTextNode(d.webkit?"\u200b":"")),f.startOffset++,f.endOffset++;k.setStart(i[0],f.startOffset);k.setEnd(f.endContainer[0],f.endOffset);c.addRange(k)}}this.reset()},createBookmarks2:function(a){for(var c=[],e=this.getRanges(),d=0;d<e.length;d++)c.push(e[d].createBookmark2(a));return c},createBookmarks:function(c,d){for(var e=[],f=this.document,i,d=d||this.getRanges(),j=d.length,q=0;q<j;q++){e.push(i=d[q].createBookmark(c,
s));var m=(c=i.serializable)?a.one("#"+i.startNode,f):i.startNode;i=c?a.one("#"+i.endNode,f):i.endNode;for(var n=q+1;n<j;n++){var o=d[n],r=o.startContainer,p=o.endContainer;g.equals(r,m.parent())&&o.startOffset++;g.equals(r,i.parent())&&o.startOffset++;g.equals(p,m.parent())&&o.endOffset++;g.equals(p,i.parent())&&o.endOffset++}}return e},selectBookmarks:function(a){for(var c=[],e=0;e<a.length;e++){var d=new x(this.document);d.moveToBookmark(a[e]);c.push(d)}this.selectRanges(c);return this},getCommonAncestor:function(){var a=
this.getRanges();return a[0].startContainer._4e_commonAncestor(a[a.length-1].endContainer)},scrollIntoView:function(){var a=this.getStartElement();a&&a.scrollIntoView(void 0,{alignWithTop:!1,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0})},removeAllRanges:function(){var a=this.getNative();j?a&&a.clear():a&&a.removeAllRanges()}});var i={table:1,tbody:1,tr:1},f=y.whitespaces(s),q=/\ufeff|\u00a0/;x.prototype.select=x.prototype.select=!j?function(){var a=this.startContainer;this.collapsed&&a[0].nodeType==
g.NodeType.ELEMENT_NODE&&!a[0].childNodes.length&&(a[0].appendChild(this.document.createTextNode(d.webkit?"\u200b":"")),this.startOffset++,this.endOffset++);var c=this.document.createRange();c.setStart(a[0],this.startOffset);try{c.setEnd(this.endContainer[0],this.endOffset)}catch(e){if(0<=e.toString().indexOf("NS_ERROR_ILLEGAL_VALUE"))this.collapse(s),c.setEnd(this.endContainer[0],this.endOffset);else throw e;}a=r(this.document).getNative();a.removeAllRanges();a.addRange(c)}:function(a){var c=this.collapsed,
e,d;if(this.startContainer[0]===this.endContainer[0]&&1==this.endOffset-this.startOffset){var k=this.startContainer[0].childNodes[this.startOffset];if(k.nodeType==g.NodeType.ELEMENT_NODE){(new m(this.document)).selectElement(new o(k));return}}(this.startContainer[0].nodeType==g.NodeType.ELEMENT_NODE&&this.startContainer.nodeName()in i||this.endContainer[0].nodeType==g.NodeType.ELEMENT_NODE&&this.endContainer.nodeName()in i)&&this.shrink(w.SHRINK_ELEMENT,s);var j=this.createBookmark(),k=j.startNode,
n;c||(n=j.endNode);j=this.document.body.createTextRange();j.moveToElementText(k[0]);j.moveStart("character",1);if(n)a=this.document.body.createTextRange(),a.moveToElementText(n[0]),j.setEndPoint("EndToEnd",a),j.moveEnd("character",-1);else{for(e=k[0].nextSibling;e&&!f(e);)e=e.nextSibling;e=!(e&&e.nodeValue&&e.nodeValue.match(q))&&(a||!k[0].previousSibling||k[0].previousSibling&&"br"==g.nodeName(k[0].previousSibling));d=new o(this.document.createElement("span"));d.html("&#65279;");d.insertBefore(k);
e&&g.insertBefore(this.document.createTextNode("\ufeff"),k[0]||k)}this.setStartBefore(k);k._4e_remove();if(c){if(e?(j.moveStart("character",-1),j.select(),this.document.selection.clear()):j.select(),d)this.moveToPosition(d,w.POSITION_BEFORE_START),d._4e_remove()}else this.setEndBefore(n),n._4e_remove(),j.select()};m.getSelection=r;return t.Selection=m},{requires:["./base","./walker","./range","./dom"]});
KISSY.add("editor/core/domIterator",function(a){function m(a){1>arguments.length||(this.range=a,this.forceBrBreak=t,this.enlargeBr=r,this.enforceRealBlocks=t,this._||(this._={}))}var r=!0,t=!1,s=a.Editor,n=a.UA,d=s.Walker,g=s.Range,o=s.RANGE,p=s.ElementPath,w=a.Node,j=a.DOM,y=/^[\r\n\t ]*$/;a.augment(m,{getNextParagraph:function(m){var c,i,f,q,b;if(!this._.lastNode){i=this.range.clone();i.shrink(o.SHRINK_ELEMENT,r);i.enlarge(this.forceBrBreak||!this.enlargeBr?o.ENLARGE_LIST_ITEM_CONTENTS:o.ENLARGE_BLOCK_CONTENTS);
var l=new d(i),e=d.bookmark(r,r);l.evaluator=e;this._.nextNode=l.next();l=new d(i);l.evaluator=e;l=l.previous();this._.lastNode=l._4e_nextSourceNode(r);this._.lastNode&&this._.lastNode[0].nodeType==j.NodeType.TEXT_NODE&&!a.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()&&(e=new g(i.document),e.moveToPosition(this._.lastNode,o.POSITION_AFTER_END),e.checkEndOfBlock()&&(e=new p(e.endContainer),this._.lastNode=(e.block||e.blockLimit)._4e_nextSourceNode(r)));this._.lastNode||
(this._.lastNode=this._.docEndMarker=new w(i.document.createTextNode("")),j.insertAfter(this._.lastNode[0],l[0]));i=null}e=this._.nextNode;l=this._.lastNode;for(this._.nextNode=null;e;){var h=t,k=e[0].nodeType!=j.NodeType.ELEMENT_NODE,v=t;if(k)e[0].nodeType==j.NodeType.TEXT_NODE&&y.test(e[0].nodeValue)&&(k=t);else{var z=e.nodeName();if(e._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if("br"==z)k=r;else if(!i&&!e[0].childNodes.length&&"hr"!=z){c=e;f=e.equals(l);break}i&&(i.setEndAt(e,o.POSITION_BEFORE_START),
"br"!=z&&(this._.nextNode=e));h=r}else{if(e[0].firstChild){i||(i=new g(this.range.document),i.setStartAt(e,o.POSITION_BEFORE_START));e=new w(e[0].firstChild);continue}k=r}}k&&!i&&(i=new g(this.range.document),i.setStartAt(e,o.POSITION_BEFORE_START));f=(!h||k)&&e.equals(l);if(i&&!h)for(;!e[0].nextSibling&&!f;){z=e.parent();if(z._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){h=r;f||z.equals(l);break}e=z;k=r;f=e.equals(l);v=r}k&&i.setEndAt(e,o.POSITION_AFTER_END);e=e._4e_nextSourceNode(v,null,l);if((f=
!e)||h&&i)break}if(!c){if(!i)return this._.docEndMarker&&this._.docEndMarker._4e_remove(),this._.nextNode=null;c=new p(i.startContainer);e=c.blockLimit;h={div:1,th:1,td:1};c=c.block;if((!c||!c[0])&&!this.enforceRealBlocks&&h[e.nodeName()]&&i.checkStartOfBlock()&&i.checkEndOfBlock())c=e;else if(!c||this.enforceRealBlocks&&"li"==c.nodeName())c=new w(this.range.document.createElement(m||"p")),c[0].appendChild(i.extractContents()),c._4e_trim(),i.insertNode(c),q=b=r;else if("li"!=c.nodeName()){if(!i.checkStartOfBlock()||
!i.checkEndOfBlock())c=c.clone(t),c[0].appendChild(i.extractContents()),c._4e_trim(),b=i.splitBlock(),q=!b.wasStartOfBlock,b=!b.wasEndOfBlock,i.insertNode(c)}else f||(this._.nextNode=c.equals(l)?null:i.getBoundaryNodes().endNode._4e_nextSourceNode(r,null,l))}q&&(i=new w(c[0].previousSibling),i[0]&&i[0].nodeType==j.NodeType.ELEMENT_NODE&&("br"==i.nodeName()?i._4e_remove():i[0].lastChild&&"br"==j.nodeName(i[0].lastChild)&&j._4e_remove(i[0].lastChild)));b&&(i=d.bookmark(t,r),q=new w(c[0].lastChild),
q[0]&&q[0].nodeType==j.NodeType.ELEMENT_NODE&&"br"==q.nodeName()&&(n.ie||q.prev(i,1)||q.next(i,1))&&q.remove());this._.nextNode||(this._.nextNode=f||c.equals(l)?null:c._4e_nextSourceNode(r,null,l));return c}});g.prototype.createIterator=function(){return new m(this)};return m},{requires:["./base","./range","./elementPath","./walker"]});
KISSY.add("editor/core/styles",function(a,m){function r(a){return!A.attr(a,"_ke_bookmark")}function t(a,c){for(var e in a)"string"==typeof a[e]?a[e]=a[e].replace(R,function(a,e){return c[e]}):t(a[e],c)}function s(c,e){e&&(c=a.clone(c),t(c,e));var b=this.element=this.element=(c.element||"*").toLowerCase();this.type=this.type="#text"==b||B[b]?F.STYLE_BLOCK:P[b]?F.STYLE_OBJECT:F.STYLE_INLINE;this._={definition:c}}function n(a,c){var e=c?this.removeFromRange:this.applyToRange;a.body.focus();for(var b=
new K(a),d=b.getRanges(),f=0;f<d.length;f++)e.call(this,d[f]);b.selectRanges(d)}function d(a,c,e){var b=a.element;"*"==b&&(b="span");c=new H(c.createElement(b));e&&e._4e_copyAttributes(c);e=a._.definition;a=e.attributes;e=s.getStyleText(e);if(a)for(var d in a)c.attr(d,a[d]);e&&(c[0].style.cssText=e);return c}function g(a){var c=a.createBookmark(h),e=a.createIterator();e.enforceRealBlocks=h;e.enlargeBr=h;for(var b,f=a.document;b=e.getNextParagraph();){var i=d(this,f,b),k=i,i="pre"==k.nodeName,l="pre"==
b.nodeName,g=!i&&l;i&&!l?(l=b,g=l.html(),g=o(g,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,""),g=g.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1"),g=g.replace(/([ \t\n\r]+|&nbsp;)/g," "),g=g.replace(/<br\b[^>]*>/gi,"\n"),u.ie?(l=l[0].ownerDocument.createElement("div"),l.appendChild(k[0]),k[0].outerHTML="<pre>"+g+"</pre>",k=new H(l.firstChild),k._4e_remove()):k.html(g)):g?k=w(p(b),k):b._4e_moveChildren(k);b[0].parentNode.replaceChild(k[0],b[0]);if(i&&(b=k,i=void 0,(i=b._4e_previousSourceNode(h,A.NodeType.ELEMENT_NODE))&&
"pre"==i.nodeName()))k=o(i.html(),/\n$/,"")+"\n\n"+o(b.html(),/^\n/,""),u.ie?b[0].outerHTML="<pre>"+k+"</pre>":b.html(k),i._4e_remove()}a.moveToBookmark(c)}function o(a,c,e){var b="",d="",a=a.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(a,c,e){c&&(b=c);e&&(d=e);return""});return b+a.replace(c,e)+d}function p(a){var c=[];o(a.outerHTML(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,function(a,c,e){return c+"</pre>"+e+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,
function(a,e){c.push(e)});return c}function w(a,c){for(var e=c[0].ownerDocument.createDocumentFragment(),b=0;b<a.length;b++){var d=a[b],d=d.replace(/(\r\n|\r)/g,"\n"),d=o(d,/^[ \t]*\n/,""),d=o(d,/\n$/,""),d=o(d,/^[ \t]+|[ \t]+$/g,function(a,c){return 1==a.length?"&nbsp;":c?" "+Array(a.length).join("&nbsp;"):Array(a.length).join("&nbsp;")+" "}),d=d.replace(/\n/g,"<br>"),d=d.replace(/[ \t]{2,}/g,function(a){return Array(a.length).join("&nbsp;")+" "}),f=c.clone();f.html(d);e.appendChild(f[0])}return e}
function j(a){var c=a.document;if(a.collapsed)c=d(this,c,void 0),a.insertNode(c),a.moveToPosition(c,I.POSITION_BEFORE_END);else{var e=this.element,f=this._.definition,i,l=M[e];l||(i=h,l=M.span);var g=a.createBookmark();a.enlarge(I.ENLARGE_ELEMENT);a.trim();for(var j=a.createBookmark(),q=j.startNode,j=j.endNode,D=q,m;D&&D[0];){var B=k;if(A.equals(D,j))D=v,B=h;else{var n=D[0].nodeType,o=n==A.NodeType.ELEMENT_NODE?D.nodeName():v;if(o&&D.attr("_ke_bookmark")){D=D._4e_nextSourceNode(h);continue}if(!o||
l[o]&&(D._4e_position(j)|E.POSITION_PRECEDING|E.POSITION_IDENTICAL|E.POSITION_IS_CONTAINED)==E.POSITION_PRECEDING+E.POSITION_IDENTICAL+E.POSITION_IS_CONTAINED&&(!f.childRule||f.childRule(D))){var p=D.parent();if(p&&"a"==e&&p.nodeName()==e)n=d(this,c,void 0),p._4e_moveChildren(n),p[0].parentNode.replaceChild(n[0],p[0]),n._4e_mergeSiblings();else if(p&&p[0]&&((M[p.nodeName()]||M.span)[e]||i)&&(!f.parentRule||f.parentRule(p))){if(!m&&(!o||!M.$removeEmpty[o]||(D._4e_position(j)|E.POSITION_PRECEDING|E.POSITION_IDENTICAL|
E.POSITION_IS_CONTAINED)==E.POSITION_PRECEDING+E.POSITION_IDENTICAL+E.POSITION_IS_CONTAINED))m=new O(c),m.setStartBefore(D);if(n==A.NodeType.TEXT_NODE||n==A.NodeType.ELEMENT_NODE&&!D[0].childNodes.length){p=D;for(n=null;(B=!p.next(r,1))&&(n=p.parent())&&l[n.nodeName()]&&(n._4e_position(q)|E.POSITION_FOLLOWING|E.POSITION_IDENTICAL|E.POSITION_IS_CONTAINED)==E.POSITION_FOLLOWING+E.POSITION_IDENTICAL+E.POSITION_IS_CONTAINED&&(!f.childRule||f.childRule(n));)p=n;m.setEndAfter(p)}}else B=h}else B=h;D=D._4e_nextSourceNode()}if(B&&
m&&!m.collapsed){for(var B=d(this,c,void 0),p=m.getCommonAncestor(),n={},o={},z,s=null,t;B&&p&&B[0]&&p[0];){if(p.nodeName()==e){for(z in f.attributes)if(!o[z]&&(t=p.attr(s)))B.attr(z)==t?B.removeAttr(z):o[z]=1;for(s in f.styles)if(!n[s]&&(t=p.style(s)))B.style(s)==t?B.style(s,""):n[s]=1;if(!B._4e_hasAttributes()){B=v;break}}p=p.parent()}B?(B[0].appendChild(m.extractContents()),b(this,B),m.insertNode(B),B._4e_mergeSiblings(),u.ie||B[0].normalize()):(B=new H(c.createElement("span")),B[0].appendChild(m.extractContents()),
m.insertNode(B),b(this,B),B._4e_remove(!0));m=v}}q._4e_remove();j._4e_remove();a.moveToBookmark(g);a.shrink(I.SHRINK_TEXT)}}function y(a){a.enlarge(I.ENLARGE_ELEMENT);var c=a.createBookmark(),e=c.startNode;if(a.collapsed){for(var b=new D(e.parent()),d,h=0,k;h<b.elements.length&&(k=b.elements[h])&&!(k==b.block||k==b.blockLimit);h++)if(this.checkElementRemovable(k)){var g=a.checkBoundaryOfElement(k,I.END),j=!g&&a.checkBoundaryOfElement(k,I.START);j||g?(d=k,d.match=j?"start":"end"):(k._4e_mergeSiblings(),
k.nodeName()!=this.element?(g=i(this),l(k,g[k.nodeName()]||g["*"])):f(this,k))}if(d){k=e;for(h=0;;h++){g=b.elements[h];if(g.equals(d))break;else if(g.match)continue;else g=g.clone();g[0].appendChild(k[0]);k=g}k["start"==d.match?"insertBefore":"insertAfter"](d);b=d.html();!b||"\u200b"==b?d.remove():u.webkit&&z(a.document.createTextNode("\u200b")).insertBefore(k)}}else{var B=c.endNode,q=this;d=function(){for(var a=new D(e.parent()),c=new D(B.parent()),b=v,d=v,f=0;f<a.elements.length;f++){var h=a.elements[f];
if(h==a.block||h==a.blockLimit)break;q.checkElementRemovable(h)&&(b=h)}for(f=0;f<c.elements.length;f++){h=c.elements[f];if(h==c.block||h==c.blockLimit)break;q.checkElementRemovable(h)&&(d=h)}d&&B._4e_breakParent(d);b&&e._4e_breakParent(b)};d();for(b=new H(e[0].nextSibling);b[0]!==B[0];){h=b._4e_nextSourceNode();if(b[0]&&b[0].nodeType==A.NodeType.ELEMENT_NODE&&this.checkElementRemovable(b)&&(b.nodeName()==this.element?f(this,b):(k=i(this),l(b,k[b.nodeName()]||k["*"])),h[0].nodeType==A.NodeType.ELEMENT_NODE&&
h.contains(e)))d(),h=new H(e[0].nextSibling);b=h}}a.moveToBookmark(c)}function x(a){var c={};(""+a).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(a,e,b){c[e]=b});return c}function c(a,c){var e="";c!==k?(e=document.createElement("span"),e.style.cssText=a,e=e.style.cssText||""):e=a;return e.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function i(c){if(c._.overrides)return c._.overrides;var e=c._.overrides={},b=c._.definition.overrides;
if(b){a.isArray(b)||(b=[b]);for(var d=0;d<b.length;d++){var f=b[d],h,k,i;"string"==typeof f?h=f.toLowerCase():(h=f.element?f.element.toLowerCase():c.element,k=f.attributes,i=f.styles);f=e[h]||(e[h]={});if(k){h=f.attributes=f.attributes||[];for(var u in k)h.push([u.toLowerCase(),k[u]])}if(i){var f=f.styles=f.styles||[],g;for(g in i)f.push([g.toLowerCase(),i[g]])}}}return e}function f(c,b){var d=c._.definition,f=i(c),k=a.merge(d.attributes,(f[b.nodeName()]||f["*"]||{}).attributes),d=a.merge(d.styles,
(f[b.nodeName()]||f["*"]||{}).styles),f=a.isEmptyObject(k)&&a.isEmptyObject(d),u;for(u in k)("class"==u||c._.definition.fullMatch)&&b.attr(u)!=q(u,k[u])||(f=f||!!b.hasAttr(u),b.removeAttr(u));for(var g in d)c._.definition.fullMatch&&b.style(g)!=q(g,d[g],h)||(f=f||!!b.style(g),b.style(g,""));e(b)}function q(a,c,b){var e=new H("<span>");e[b?"style":"attr"](a,c);return e[b?"style":"attr"](a)}function b(a,c){for(var b=i(a),e=c.all(a.element),d=e.length;0<=--d;)f(a,new H(e[d]));for(var h in b)if(h!=a.element){e=
c.all(h);for(d=e.length-1;0<=d;d--){var k=new H(e[d]);l(k,b[h])}}}function l(a,c){var b,d=c&&c.attributes;if(d)for(b=0;b<d.length;b++){var f=d[b][0],h;if(h=a.attr(f)){var k=d[b][1];(k===v||k.test&&k.test(h)||"string"==typeof k&&h==k)&&a[0].removeAttribute(f)}}if(d=c&&c.styles)for(b=0;b<d.length;b++)if(f=d[b][0],k=a.css(f)){var i=d[b][1];(i===v||i.test&&i.test(h)||"string"==typeof i&&k==i)&&a.css(f,"")}e(a)}function e(a){if(!a._4e_hasAttributes()){var c=a[0].firstChild,b=a[0].lastChild;a._4e_remove(h);
c&&(c.nodeType==A.NodeType.ELEMENT_NODE&&A._4e_mergeSiblings(c),b&&c!=b&&b.nodeType==A.NodeType.ELEMENT_NODE&&A._4e_mergeSiblings(b))}}var h=!0,k=!1,v=null,z=a.all,A=a.DOM,F={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3},I=m.RANGE,K=m.Selection,E=m.POSITION,O=m.Range,H=a.Node,u=a.UA,D=m.ElementPath,B={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},M=m.XHTML_DTD,P={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},Q=/\s*(?:;\s*|$)/g,R=/#\((.+?)\)/g;m.STYLE=
F;s.prototype={constructor:s,apply:function(a){n.call(this,a,k)},remove:function(a){n.call(this,a,h)},applyToRange:function(a){return(this.applyToRange=this.type==F.STYLE_INLINE?j:this.type==F.STYLE_BLOCK?g:v).call(this,a)},removeFromRange:function(a){return(this.removeFromRange=this.type==F.STYLE_INLINE?y:v).call(this,a)},checkElementRemovable:function(a,b){if(!a)return k;var e=this._.definition,d;if(a.nodeName()==this.element){if(!b&&!a._4e_hasAttributes())return h;var f=e._AC;if(f)e=f;else{var f=
{},u=0,g=e.attributes;if(g)for(var l in g)u++,f[l]=g[l];if(g=s.getStyleText(e))f.style||u++,f.style=g;f._length=u;e=e._AC=f}if(e._length){for(var j in e)if("_length"!=j){u=a.attr(j)||"";if("style"==j)a:{f=e[j];u=c(u,k);"string"==typeof f&&(f=x(f));"string"==typeof u&&(u=x(u));g=void 0;for(g in f)if(!(g in u&&(u[g]==f[g]||"inherit"==f[g]||"inherit"==u[g]))){f=k;break a}f=h}else f=e[j]==u;if(f){if(!b)return h}else if(b)return k}if(b)return h}else return h}j=i(this);if(j=j[a.nodeName()]||j["*"]){if(!(e=
j.attributes)&&!(d=j.styles))return h;if(e)for(f=0;f<e.length;f++)if(j=e[f][0],j=a.attr(j))if(u=e[f][1],u===v||"string"==typeof u&&j==u||u.test&&u.test(j))return h;if(d)for(f=0;f<d.length;f++)if(j=a.css(d[f][0]))if(e=d[f][1],e===v||"string"==typeof e&&j==e||e.test&&e.test(j))return h}return k},checkActive:function(a){switch(this.type){case F.STYLE_BLOCK:return this.checkElementRemovable(a.block||a.blockLimit,h);case F.STYLE_OBJECT:case F.STYLE_INLINE:for(var c=a.elements,b=0,e;b<c.length;b++)if(e=
c[b],!(this.type==F.STYLE_INLINE&&(A.equals(e,a.block)||A.equals(e,a.blockLimit))))if((this.type!=F.STYLE_OBJECT||e.nodeName()in P)&&this.checkElementRemovable(e,h))return h}return k}};s.getStyleText=function(a){var e=a._ST;if(e)return e;var e=a.styles,b=a.attributes&&a.attributes.style||"",d="";b.length&&(b=b.replace(Q,";"));for(var f in e){var h=e[f],k=(f+":"+h).replace(Q,";");"inherit"==h?d+=k:b+=k}b.length&&(b=c(b));return a._ST=b+d};return m.Style=s},{requires:["./base","./range","./selection",
"./domIterator","./elementPath"]});KISSY.add("editor/core/zIndexManager",function(a){var m=a.Editor,a=m.zIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,STORE_FLASH_SHOW:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};m.baseZIndex=function(a){return(m.Config.baseZIndex||1E4)+a};return a},{requires:["./base"]});
KISSY.add("editor/core/clipboard",function(a,m,r,t){function s(a){this.editor=a;this._init()}function n(a){var i=a.get("document")[0],f=a.getSelection(),g;if(f.getType()==t.SELECTION_ELEMENT&&(g=f.getSelectedElement())){var a=f.getRanges()[0],b=d(i.createTextNode(""));b.insertBefore(g);a.setStartBefore(b);a.setEndAfter(g);f.selectRanges([a]);setTimeout(function(){g.parent()&&(b.remove(),f.selectElement(g))},0)}}var d=a.all,g=a.UA,o=g.ie?"beforepaste":"paste",p=m.RANGE;a.augment(s,{_init:function(){var a=
this,d=a.editor,f=d.get("document"),q=f.one("body"),b=function(a){this.type=a};b.prototype={exec:function(b){var e=this.type;b.focus();setTimeout(function(){g.ie&&("cut"==e?n(b):"paste"==e&&(a._preventPasteEvent(),a._getClipboardDataFromPasteBin()));j(b,e)||alert(y[e])},0)}};q.on(o,a._getClipboardDataFromPasteBin,a);g.ie&&(q.on("paste",a._iePaste,a),f.on("keydown",a._onKeyDown,a),f.on("contextmenu",function(){a._isPreventBeforePaste=1;setTimeout(function(){a._isPreventBeforePaste=0},0)}));d.addCommand("copy",
new b("copy"));d.addCommand("cut",new b("cut"));d.addCommand("paste",new b("paste"))},_onKeyDown:function(a){this.editor.get("mode")==m.Mode.WYSIWYG_MODE&&(a.ctrlKey&&86==a.keyCode||a.shiftKey&&45==a.keyCode)&&this._preventPasteEvent()},_stateFromNamedCommand:function(a){var d,f=this.editor;if("paste"==a){this._isPreventBeforePaste=1;try{d=f.get("document")[0].queryCommandEnabled(a)}catch(g){}this._isPreventBeforePaste=0}else d=(a=(a=f.getSelection())&&a.getRanges())&&!(1==a.length&&a[0].collapsed);
return d},_preventPasteEvent:function(){var a=this;a._preventPasteTimer&&clearTimeout(a._preventPasteTimer);a._isPreventPaste=1;a._preventPasteTimer=setTimeout(function(){a._isPreventPaste=0},70)},_iePaste:function(a){var d=this.editor;this._isPreventPaste||(a.preventDefault(),d.execCommand("paste"))},_getClipboardDataFromPasteBin:function(){if(!this._isPreventBeforePaste){var c=this.editor,i=c.get("document")[0];if(!i.getElementById("ke_pastebin")){var f=c.getSelection(),j=new r(i),b=d(g.webkit?
"<body></body>":i.createElement("div"),null,i);b.attr("id","ke_pastebin");g.webkit&&b[0].appendChild(i.createTextNode("\u200b"));i.body.appendChild(b[0]);b.css({position:"absolute",top:f.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});b.css("left","-1000px");var l=f.createBookmarks();j.setStartAt(b,p.POSITION_AFTER_START);j.setEndAt(b,p.POSITION_BEFORE_END);j.select(!0);setTimeout(function(){var e,d=b;b=g.webkit&&(e=b.first())&&e.hasClass("Apple-style-span")?e:b;f.selectBookmarks(l);
var k=b.html();d.remove();if(k=a.trim(k.replace(/<span[^>]+_ke_bookmark[^<]*?<\/span>(&nbsp;)*/ig,"")))e=c.fire("paste",{html:k}),!1!==e&&(void 0!==e&&(k=e),/(class="?Mso|style="[^"]*\bmso\-|w:WordDocument)/.test(k)?a.use("editor/plugin/word-filter",function(a,b){c.insertHTML(b.toDataFormat(k,c))}):c.insertHTML(k))},0)}}}});var w=function(a,i){var f=a.get("document")[0],j=d(f.body),b=!1,l=function(){b=!0};j.on(i,l);(7<g.ie?f:f.selection.createRange()).execCommand(i);j.detach(i,l);return b},j=g.ie?
function(a,d){return w(a,d)}:function(a,d){try{return a.get("document")[0].execCommand(d)}catch(f){return!1}},y={cut:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u526a\u5207\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+X)\u6765\u5b8c\u6210",copy:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u590d\u5236\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+C)\u6765\u5b8c\u6210",paste:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u7c98\u8d34\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+V)\u6765\u5b8c\u6210"},x={copy:"\u590d\u5236",paste:"\u7c98\u8d34",cut:"\u526a\u5207"};return{init:function(a){var d;a.docReady(function(){d=new s(a)});var f={copy:1,cut:1,paste:1},g=["copy","cut","paste"];a.on("contextmenu",function(b){var j=b.contextmenu;if(!j.__copy_fix){j.__copy_fix=
1;for(b=0;b<g.length;b++)j.addChild({content:x[g[b]],value:g[b]});j.on("click",function(b){var e=b.target.get("value");f[e]&&(j.hide(),setTimeout(function(){a.execCommand("save");a.execCommand(e);setTimeout(function(){a.execCommand("save")},10)},30))})}for(var e=j.get("children"),b=e.length-1;b--;0<=b){var h=e[b],k;k=h.get?h.get("value"):h.value;f[k]&&(k=!d._stateFromNamedCommand(k),h.set?h.set("disabled",k):h.disabled=k)}})}}},{requires:["./base","./range","./selection"]});
KISSY.add("editor/core/enterKey",function(a,m,r,t){function s(j){var m;m=j.getSelection().getRanges();for(var n=m.length-1;0<n;n--)m[n].deleteContents();m=m[0];n=m.document;if(m.checkStartOfBlock()&&m.checkEndOfBlock()){var c=(new t(m.startContainer)).block;if(c&&("li"==c.nodeName()||"li"==c.parent().nodeName()))return j.hasCommand("outdent")?(j.execCommand("save"),j.execCommand("outdent"),j.execCommand("save"),!0):!1}var i=m.splitBlock("p");if(!i)return!0;var j=i.previousBlock,c=i.nextBlock,f=i.wasStartOfBlock,
q=i.wasEndOfBlock,b;if(c)b=c.parent(),"li"==b.nodeName()&&(c._4e_breakParent(b),c._4e_move(c.next(),!0));else if(j&&(b=j.parent())&&"li"==b.nodeName())j._4e_breakParent(b),m.moveToElementEditablePosition(j.next()),j._4e_move(j.prev());if(!f&&!q){if("li"==c.nodeName()&&(b=c.first(r.invisible(!0)))&&a.inArray(b.nodeName(),["ul","ol"]))(d.ie?new p(n.createTextNode("\u00a0")):new p(n.createElement("br"))).insertBefore(b);c&&m.moveToElementEditablePosition(c)}else{var l;if(j){if("li"==j.nodeName()||!g.test(j.nodeName()))l=
j.clone()}else c&&(l=c.clone());l||(l=new p("<p>",null,n));if(b=i.elementPath)for(var i=0,e=b.elements.length;i<e;i++){var h=b.elements[i];if(h.equals(b.block)||h.equals(b.blockLimit))break;o.$removeEmpty[h.nodeName()]&&(h=h.clone(),l._4e_moveChildren(h),l.append(h))}d.ie||l._4e_appendBogus();m.insertNode(l);if(d.ie&&f&&(!q||!j[0].childNodes.length))m.moveToElementEditablePosition(q?j:l),m.select();m.moveToElementEditablePosition(f&&!q?c:l)}d.ie||(c?(l=new p(n.createElement("span")),l.html("&nbsp;"),
m.insertNode(l),l.scrollIntoView(void 0,{alignWithTop:!1,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0}),m.deleteContents()):l.scrollIntoView(void 0,{alignWithTop:!1,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0}));m.select();return!0}function n(a){var d=a.get("document")[0];w.on(d,"keydown",function(d){if(13===d.keyCode&&!d.shiftKey&&!d.ctrlKey&&!d.metaKey){a.execCommand("save");var c=a.execCommand("enterBlock");a.execCommand("save");!1!==c&&d.preventDefault()}})}var d=a.UA,g=/^h[1-6]$/,o=m.XHTML_DTD,
p=a.Node,w=a.Event;return{init:function(a){a.addCommand("enterBlock",{exec:s});a.docReady(function(){n(a)})}}},{requires:["./base","./walker","./elementPath"]});
KISSY.add("editor/core/htmlDataProcessor",function(a,m,r){return{init:function(t){function s(c){var c=c.childNodes,b,d,f,g=c.length;if(g){f=1;for(b=0;b<g;b++)if(d=c[b],d.nodeType!=a.DOM.NodeType.TEXT_NODE||d.nodeValue){f=0;break}return f?!1:void 0}return!1}function n(a){return a.replace(y,function(a,c,b){return"<"+c+b.replace(x,function(a,c){return-1==b.indexOf("_ke_saved_"+c)?" _ke_saved_"+a+" "+a:a})+">"})}function d(a){return a.replace(i,function(a){return"<ke:encoded>"+encodeURIComponent(a)+"</ke:encoded>"})}
function g(c){return c.replace(f,function(c,b){return a.urlDecode(b)})}var o=a.Node,p=a.UA,w=new r.Filter,j=new r.Filter;(function(){function b(a){a=r.serialize(a);return new r.Comment(c+encodeURIComponent(a).replace(/--/g,"%2D%2D"))}var d={tagNames:[[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],attributeNames:[[/^on/,"ke_on"],[/^lang$/,""]],tags:{script:b,noscript:b,span:s}},f={tagNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],tags:{$:function(a){if(a.attributes.length)for(var c=["name","href","src"],
b,e=0;e<c.length;e++)b="_ke_saved_"+c[e],a.getAttribute(b)&&a.removeAttribute(c[e]);return a},embed:function(a){var c=a.parentNode;if(c&&"object"==c.nodeName){var b=c.getAttribute("width"),c=c.getAttribute("height");b&&a.setAttribute("width",b);c&&a.setAttribute("width",c)}},a:function(a){if(!a.childNodes.length&&!a.attributes.length)return!1},span:s,strong:s,em:s,del:s,u:s},attributes:{style:function(c){if(!a.trim(c))return!1}},attributeNames:[[/^_ke_saved_/,""],[/^ke_on/,"on"],[/^_ke.*/,""],[/^ke:.*$/,
""],[/^_ks.*/,""]],comment:function(b){if(b.substr(0,c.length)==c)return b=a.trim(a.urlDecode(b.substr(c.length))),r.parse(b).childNodes[0]}};p.ie&&(f.attributes.style=function(a){return a.replace(/(^|;)([^:]+)/g,function(a){return a.toLowerCase()})});w.addRules(f);j.addRules(d)})();(function(){function c(b){for(var b=b.childNodes,e=b.length,d=b[e-1];d&&3==d.nodeType&&!a.trim(d.nodeValue);)d=b[--e];return d}function b(a){var d=c(a);d&&(1==d.nodeType&&"br"==d.nodeName?a.removeChild(d):3==d.nodeType&&
i.test(d.nodeValue)&&a.removeChild(d))}function d(a){var b=c(a);return!b||"form"==a.nodeName&&"input"==b.nodeName}function f(a){b(a);d(a)&&(p.ie||a.appendChild(new r.Tag("br")))}function g(a){b(a);d(a)&&a.appendChild(new r.Text("\u00a0"))}var i=/^[\t\r\n ]*(?:&nbsp;|\xa0)[\t\r\n ]*$/,l=m.XHTML_DTD,n=a.merge(l.$block,l.$listItem,l.$tableContent),q;for(q in n)"br"in l[q]||delete n[q];delete n.pre;var l={tags:{}},o={tags:{}};for(q in n)l.tags[q]=f,o.tags[q]=g;j.addRules(l);w.addRules(o)})();w.addRules({text:function(a){return a.replace(/\xa0/g,
"&nbsp;")}});var y=/<(a|area|img|input)\b([^>]*)>/gi,x=/\b(href|src|name)\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|(?:[^ "'>]+))/gi,c="{ke_protected}",i=/(?:<textarea[^>]*>[\s\S]*<\/textarea>)|(?:<style[^>]*>[\s\S]*<\/style>)|(?:<(:?link|meta|base)[^>]*>)/gi,f=/<ke:encoded>([^<]*)<\/ke:encoded>/gi,q=/(<\/?)((?:object|embed|param|html|body|head|title|script|noscript)[^>]*>)/gi,b=/(<\/?)ke:((?:object|embed|param|html|body|head|title|script|noscript)[^>]*>)/gi,l=/<ke:(param|embed)([^>]*?)\/?>(?!\s*<\/ke:\1)/gi;
t.htmlDataProcessor={dataFilter:j,htmlFilter:w,toHTML:function(a){p.webkit&&(a=a.replace(/\u200b/g,""));var c=new r.BeautifyWriter;(new r.Parser(a)).parse().writeHTML(c,w);return a=c.getHTML()},toDataFormat:function(a,c){var c=c||j,a=d(a),a=n(a),a=a.replace(q,"$1ke:$2"),a=a.replace(l,"<ke:$1$2></ke:$1>"),f=new o("<div>");f.html("a"+a);a=f.html().substr(1);a=a.replace(b,"$1$2");a=g(a);f=new r.BasicWriter;(new r.Parser(a)).parse().writeHTML(f,c);return a=f.getHTML()},toServer:function(a){var c=new r.MinifyWriter;
(new r.Parser(a)).parse().writeHTML(c,w);return c.getHTML()}}}}},{requires:["./base","htmlparser"]});
KISSY.add("editor/core/selectionFix",function(a,m){function r(a){function d(a,c){var b=e.body.createTextRange();try{b.moveToPoint(a,c)}catch(f){b=o}return b}function f(){var a=e.selection.createRange();h&&!a.item&&0===a.compareEndPoints("StartToEnd",a)&&h.select();w.remove(e,"mouseup",f);w.remove(e,"mousemove",g);h=b=0}function g(a){if(a.button){if(a=d(a.pageX,a.pageY))0<a.compareEndPoints("StartToStart",h)?a.setEndPoint("StartToStart",h):a.setEndPoint("EndToEnd",h),a.select()}else f()}var b,j=a.get("window")[0],
e=a.get("document")[0],h;w.on(e,"mousedown contextmenu",function(a){var c=e.documentElement;if(a.target===c&&(b&&f(),!(c.scrollHeight>c.clientHeight)&&(b=1,h=d(a.pageX,a.pageY))))w.on(e,"mouseup",f),w.on(e,"mousemove",g),j.focus(),h.select()})}function t(a){function i(b){if(e){var h=a.getSelection(),g=h&&h.getType(),j=h&&f.selection;if(b&&j&&g==x.SELECTION_NONE&&!f.queryCommandEnabled("InsertImage"))setTimeout(function(){i(d)},50);else{var m;if(!j||!j.type||!("Control"!=j.type&&(m=j.createRange())&&
(m=m.parentElement())&&(m=m.nodeName)&&m.toLowerCase()in{input:1,textarea:1}))l=j&&h.getRanges()[0],a.checkSelectionChange()}}}var f=a.get("document")[0],j=new y(f.body),b=new y(f.documentElement);if(8>m.Utils.ieEngine)b.on("click",function(b){"html"===(new y(b.target)).nodeName()&&a.getSelection().getNative().createRange().select()});var l,e,h=d;b.on("mousedown",function(){h=g});b.on("mouseup",function(){h=d});j.on("focusin",function(a){if("body"==(new y(a.target)).nodeName()&&l){try{h&&l.select()}catch(c){}l=
o}});j.on("focus",function(){e=d;i()});j.on("beforedeactivate",function(a){a.relatedTarget||(e=g,h=d)});j.on("mousedown",function(){e=g});j.on("mouseup",function(){e=d;setTimeout(function(){i(d)},0)});j.on("keydown",function(){e=g});j.on("keyup",function(){e=d;setTimeout(function(){i()},0)})}function s(a){var d=a.get("document")[0];w.on(d,"mouseup keyup selectionchange",function(){a.checkSelectionChange()})}function n(a){function i(a){var c=m.XHTML_DTD;return a._4e_isBlockBoundary()&&c.$empty[a.nodeName()]}
function f(a){return b(a)&&l(a)}var n=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;|(<\!--[\s\S]*?--\>))?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,b=m.Walker.whitespaces(d),l=m.Walker.bookmark(g,d),e=function(a){return b(a)&&8!=a.nodeType};a.on("selectionChange",function(b){var k=b.path,l=new y(a.get("document")[0].body),b=(b=b.selection)&&b.getRanges()[0],o=k.blockLimit;if(p.gecko){var r=k.block||k.blockLimit,s=r&&r.last(f);r&&r._4e_isBlockBoundary()&&(!s||!(1==s[0].nodeType&&
s._4e_isBlockBoundary()))&&"pre"!=r.nodeName()&&!r._4e_getBogus()&&r._4e_appendBogus()}if(b&&b.collapsed&&!k.block){if("body"==o.nodeName()){if((k=b.fixBlock(d,"p"))&&k[0]!=l[0].lastChild&&k.outerHTML().match(n))if((o=k.next(e,1))&&o[0].nodeType==j.NodeType.ELEMENT_NODE&&!i[o])b.moveToElementEditablePosition(o),k._4e_remove();else if((o=k.prev(e,1))&&o[0].nodeType==j.NodeType.ELEMENT_NODE&&!i[o])b.moveToElementEditablePosition(o,o.outerHTML().match(n)?g:d),k._4e_remove();b.select();a.notifySelectionChange()}k=
a.get("document")[0];b=new m.Range(k);b.moveToElementEditablePosition(l,d);"body"!==(new m.ElementPath(b.startContainer)).blockLimit.nodeName()&&(l=(new y(k.createElement("p"))).appendTo(l),p.ie||l._4e_appendBogus())}})}var d=!0,g=!1,o=null,p=a.UA,w=a.Event,j=a.DOM,y=a.Node,x=m.SELECTION;return{init:function(a){a.docReady(function(){p.ie?(r(a),t(a)):s(a)});n(a)}}},{requires:["./base","./selection"]});
KISSY.add("editor/core/plugin-meta",function(){(function(a){a({"editor/plugin/back-color":{requires:["editor","editor/plugin/color/btn","editor/plugin/back-color/cmd"]}});a({"editor/plugin/back-color/cmd":{requires:["editor/plugin/color/cmd"]}});a({"editor/plugin/bold":{requires:["editor","editor/plugin/font/ui","editor/plugin/bold/cmd"]}});a({"editor/plugin/bold/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/bubble":{requires:["overlay","editor"]}});a({"editor/plugin/button":{requires:["editor",
"button"]}});a({"editor/plugin/checkbox-source-area":{requires:["editor"]}});a({"editor/plugin/code":{requires:["editor","editor/plugin/dialog-loader"]}});a({"editor/plugin/code/dialog":{requires:["editor","editor/plugin/dialog","menubutton"]}});a({"editor/plugin/color/btn":{requires:["editor","editor/plugin/button","editor/plugin/overlay","editor/plugin/dialog-loader"]}});a({"editor/plugin/color/cmd":{requires:["editor"]}});a({"editor/plugin/color/dialog":{requires:["editor","editor/plugin/dialog"]}});
a({"editor/plugin/contextmenu":{requires:["editor","menu","editor/plugin/focus-fix"]}});a({"editor/plugin/dent-cmd":{requires:["editor","editor/plugin/list-utils"]}});a({"editor/plugin/dialog-loader":{requires:["overlay","editor"]}});a({"editor/plugin/dialog":{requires:["editor","overlay","editor/plugin/focus-fix","dd/plugin/constrain","component/plugin/drag"]}});a({"editor/plugin/draft":{requires:["editor","editor/plugin/local-storage","overlay","editor/plugin/menubutton"]}});a({"editor/plugin/drag-upload":{requires:["editor"]}});
a({"editor/plugin/element-path":{requires:["editor"]}});a({"editor/plugin/fake-objects":{requires:["editor"]}});a({"editor/plugin/flash-bridge":{requires:["swf","editor"]}});a({"editor/plugin/flash-common/base-class":{requires:["editor","editor/plugin/contextmenu","editor/plugin/bubble","editor/plugin/dialog-loader","editor/plugin/flash-common/utils"]}});a({"editor/plugin/flash-common/utils":{requires:["swf"]}});a({"editor/plugin/flash":{requires:["editor","editor/plugin/flash-common/base-class",
"editor/plugin/flash-common/utils","editor/plugin/fake-objects"]}});a({"editor/plugin/flash/dialog":{requires:["editor","editor/plugin/flash-common/utils","editor/plugin/dialog","editor/plugin/menubutton"]}});a({"editor/plugin/focus-fix":{requires:["editor"]}});a({"editor/plugin/font-family":{requires:["editor","editor/plugin/font/ui","editor/plugin/font-family/cmd"]}});a({"editor/plugin/font-family/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/font-size":{requires:["editor",
"editor/plugin/font/ui","editor/plugin/font-size/cmd"]}});a({"editor/plugin/font-size/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/font/cmd":{requires:["editor"]}});a({"editor/plugin/font/ui":{requires:["editor","editor/plugin/button","editor/plugin/menubutton"]}});a({"editor/plugin/fore-color":{requires:["editor","editor/plugin/color/btn","editor/plugin/fore-color/cmd"]}});a({"editor/plugin/fore-color/cmd":{requires:["editor/plugin/color/cmd"]}});a({"editor/plugin/heading":{requires:["editor",
"editor/plugin/heading/cmd"]}});a({"editor/plugin/heading/cmd":{requires:["editor"]}});a({"editor/plugin/image":{requires:["editor","editor/plugin/button","editor/plugin/bubble","editor/plugin/contextmenu","editor/plugin/dialog-loader"]}});a({"editor/plugin/image/dialog":{requires:["io","editor","editor/plugin/dialog","tabs","editor/plugin/menubutton"]}});a({"editor/plugin/indent":{requires:["editor","editor/plugin/indent/cmd"]}});a({"editor/plugin/indent/cmd":{requires:["editor","editor/plugin/dent-cmd"]}});
a({"editor/plugin/italic":{requires:["editor","editor/plugin/font/ui","editor/plugin/italic/cmd"]}});a({"editor/plugin/italic/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/justify-center":{requires:["editor","editor/plugin/justify-center/cmd"]}});a({"editor/plugin/justify-center/cmd":{requires:["editor/plugin/justify-cmd"]}});a({"editor/plugin/justify-cmd":{requires:["editor"]}});a({"editor/plugin/justify-left":{requires:["editor","editor/plugin/justify-left/cmd"]}});a({"editor/plugin/justify-left/cmd":{requires:["editor/plugin/justify-cmd"]}});
a({"editor/plugin/justify-right":{requires:["editor","editor/plugin/justify-right/cmd"]}});a({"editor/plugin/justify-right/cmd":{requires:["editor/plugin/justify-cmd"]}});a({"editor/plugin/link":{requires:["editor","editor/plugin/bubble","editor/plugin/link/utils","editor/plugin/dialog-loader","editor/plugin/button"]}});a({"editor/plugin/link/dialog":{requires:["editor","editor/plugin/dialog","editor/plugin/link/utils"]}});a({"editor/plugin/link/utils":{requires:["editor"]}});a({"editor/plugin/list-utils":{requires:["editor"]}});
a({"editor/plugin/list-utils/btn":{requires:["editor","editor/plugin/button","editor/plugin/menubutton"]}});a({"editor/plugin/list-utils/cmd":{requires:["editor","editor/plugin/list-utils"]}});a({"editor/plugin/local-storage":{requires:["editor","overlay","editor/plugin/flash-bridge"]}});a({"editor/plugin/maximize":{requires:["editor","editor/plugin/maximize/cmd"]}});a({"editor/plugin/maximize/cmd":{requires:["editor"]}});a({"editor/plugin/menubutton":{requires:["editor","menubutton"]}});a({"editor/plugin/multiple-upload":{requires:["editor",
"editor/plugin/dialog-loader"]}});a({"editor/plugin/multiple-upload/dialog":{requires:"editor,component/plugin/drag,editor/plugin/progressbar,editor/plugin/dialog,editor/plugin/flash-bridge,editor/plugin/local-storage,swf".split(",")}});a({"editor/plugin/ordered-list":{requires:["editor","editor/plugin/list-utils/btn","editor/plugin/ordered-list/cmd"]}});a({"editor/plugin/ordered-list/cmd":{requires:["editor","editor/plugin/list-utils/cmd"]}});a({"editor/plugin/outdent":{requires:["editor","editor/plugin/outdent/cmd"]}});
a({"editor/plugin/outdent/cmd":{requires:["editor","editor/plugin/dent-cmd"]}});a({"editor/plugin/overlay":{requires:["editor","overlay","editor/plugin/focus-fix"]}});a({"editor/plugin/page-break":{requires:["editor","editor/plugin/fake-objects"]}});a({"editor/plugin/remove-format":{requires:["editor","editor/plugin/remove-format/cmd","editor/plugin/button"]}});a({"editor/plugin/remove-format/cmd":{requires:["editor"]}});a({"editor/plugin/resize":{requires:["editor","dd/base"]}});a({"editor/plugin/separator":{requires:["editor"]}});
a({"editor/plugin/smiley":{requires:["editor","editor/plugin/overlay"]}});a({"editor/plugin/source-area":{requires:["editor","editor/plugin/button"]}});a({"editor/plugin/strike-through":{requires:["editor","editor/plugin/font/ui","editor/plugin/strike-through/cmd"]}});a({"editor/plugin/strike-through/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/table":{requires:["editor","editor/plugin/dialog-loader","editor/plugin/contextmenu"]}});a({"editor/plugin/table/dialog":{requires:["editor",
"editor/plugin/dialog","editor/plugin/menubutton"]}});a({"editor/plugin/underline":{requires:["editor","editor/plugin/font/ui","editor/plugin/underline/cmd"]}});a({"editor/plugin/underline/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/undo":{requires:["editor","editor/plugin/undo/btn","editor/plugin/undo/cmd"]}});a({"editor/plugin/undo/btn":{requires:["editor","editor/plugin/button"]}});a({"editor/plugin/undo/cmd":{requires:["editor"]}});a({"editor/plugin/unordered-list":{requires:["editor",
"editor/plugin/list-utils/btn","editor/plugin/unordered-list/cmd"]}});a({"editor/plugin/unordered-list/cmd":{requires:["editor","editor/plugin/list-utils/cmd"]}});a({"editor/plugin/video":{requires:["editor","editor/plugin/flash-common/utils","editor/plugin/flash-common/base-class","editor/plugin/fake-objects"]}});a({"editor/plugin/video/dialog":{requires:["editor","editor/plugin/flash/dialog","editor/plugin/menubutton"]}});a({"editor/plugin/word-filter":{requires:["htmlparser"]}});a({"editor/plugin/xiami-music":{requires:["editor",
"editor/plugin/flash-common/base-class","editor/plugin/flash-common/utils","editor/plugin/fake-objects"]}});a({"editor/plugin/xiami-music/dialog":{requires:["editor","editor/plugin/flash/dialog","editor/plugin/menubutton"]}})})(function(a){KISSY.config("modules",a)},KISSY.Features,KISSY.UA)});
KISSY.add("editor/core",function(a,m,r,t,s,n,d,g,o,p){function w(a,c){var d=a.body;F(function(){a.designMode="on";setTimeout(function(){a.designMode="off";d.focus();arguments.callee.retry||(arguments.callee.retry=i)},50)},function(){a.designMode="off";k.attr(d,"contentEditable",b);k.attr(d,"contentEditable",i);!c&&w(a,1)})}function j(c){c.get("iframe");var d=c.get("textarea")[0],f=c.get("window")[0],g=c.get("document")[0];e.webkit&&(A.on(g,"click",function(c){var b=new z(c.target);a.inArray(b.nodeName(),
["input","select"])&&c.preventDefault()}),A.on(g,"mouseup",function(c){var b=new z(c.target);a.inArray(b.nodeName(),["input","textarea"])&&c.preventDefault()}));if(e.gecko||h||e.opera){var i;i=(new z('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>')).insertAfter(d);i.on("focus",function(){c.focus()});c.activateGecko=function(){e.gecko&&c.__iframeFocus&&i[0].focus()};c.on("destroy",function(){i.detach();i.remove()})}A.on(f,"focus",function(){e.gecko?w(g,b):e.opera&&
g.body.focus();c.notifySelectionChange()});if(e.gecko)A.on(g,"mousedown",function(){c.__iframeFocus||w(g,b)});if(h&&(A.on(g,"keydown",function(a){if(a.keyCode in{8:1,46:1}){var b=c.getSelection(),d=b.getSelectedElement();if(d){c.execCommand("save");var e=b.getRanges()[0].createBookmark();d.remove();b.selectBookmarks([e]);c.execCommand("save");a.preventDefault()}}}),"CSS1Compat"==g.compatMode)){var j={33:1,34:1};A.on(g,"keydown",function(a){a.keyCode in j&&setTimeout(function(){c.getSelection().scrollIntoView()},
0)})}if(e.webkit)A.on(g,"mousedown",function(b){b=new z(b.target);a.inArray(b.nodeName(),["img","hr","input","textarea","select"])&&c.getSelection().selectElement(b)});if(e.gecko)A.on(g,"dragstart",function(a){var b=new z(a.target);b.nodeName()==="img"&&/ke_/.test(b[0].className)&&a.preventDefault()});t.add(c)}function y(b,c,d,e){var f="",h;h=r.debugUrl("theme/editor-iframe.css");d=d.concat([]);d.unshift(h);for(h=0;h<d.length;h++)f+=a.substitute('<link href="{href}" rel="stylesheet" />',{href:d[h]});
return a.substitute(I,{doctype:8===l.documentMode?'<meta http-equiv="X-UA-Compatible" content="IE=7" />':"",title:"${title}",links:f,style:c,data:e||"",script:b?'<script id="ke_active_script">'+(k.isCustomDomain()?'document.domain="'+l.domain+'";':"")+'parent.KISSY.Editor._initIFrame("'+b+'");<\/script>':""})}function x(a,b){function c(){i=g.document;a.setInternal("document",new z(i));a.setInternal("window",new z(g));d.detach();i.open("text/html","replace");i.write(e);i.close()}var d=a.get("iframe"),
e=y(a._UUID,a.get("customStyle"),a.get("customLink"),b),f=d[0],g=f.contentWindow,i;d.__loaded=1;try{i=g.document}catch(j){if(f.src=f.src,7>h){setTimeout(c,10);return}}c()}function c(b,c){var d=k.getEmptyIframeSrc()||"";d&&(d=' src="'+d+'" ');var d=new z(a.substitute(K,{iframeSrc:d})),f=b.get("textarea");f.hasAttr("tabindex")&&d.attr("tabindex",e.webkit?-1:f.attr("tabindex"));f.parent().prepend(d);b.set("iframe",d);b.__docReady=0;if(e.gecko&&!d.__loaded)d.on("load",function(){x(b,c)},b);else x(b,c)}
var i=!0,f=f,q=a.all,b=!1,l=document,e=a.UA,h=e.ie,k=a.DOM,v=k.NodeType,z=a.Node,A=a.Event,F=r.tryThese,I='<!doctype html><html><head>{doctype}<title>{title}</title><style>{style}</style>{links}</head><body class="ks-editor" >{data}{script}</body></html>',K='<iframe style="width:100%;height:100%;border:none;"  frameborder="0"  title="kissy-editor"  allowTransparency="true"  {iframeSrc} ></iframe>',E=/^(?:<(p)>)?(?:(?:&nbsp;)|\s|<br[^>]*>)*(?:<\/\1>)?$/i,O='<div class="{prefixCls}editor-tools"></div><div class="{prefixCls}editor-textarea-wrap" '+
(e.mobile?'style="overflow:scroll;-webkit-overflow-scrolling:touch;"':"")+'></div><div class="{prefixCls}editor-status"></div>';m.Mode={SOURCE_MODE:0,WYSIWYG_MODE:1};a.augment(m,{createDom:function(){var b,c=this.prefixCls,d=this.get("textarea"),e;d?(this.set("textarea",d=q(d)),d[0].parentNode&&d.remove()):(b=this.get("data"),this.set("textarea",d=q('<textarea class="'+c+'-editor-textarea"></textarea>')),d.val(b));e=this.get("el");e.html(a.substitute(O,{prefixCls:c}));b=e.one(a.substitute(".{prefixCls}editor-textarea-wrap",
{prefixCls:c}));this._UUID=a.guid();this.set({toolBarEl:e.one(a.substitute(".{prefixCls}editor-tools",{prefixCls:c})),statusBarEl:e.one(a.substitute(".{prefixCls}editor-status",{prefixCls:c}))},{silent:1});d.css("width","100%");d.css("display","none");b.append(d);t.register(this)},renderUI:function(){d.init(this);g.init(this);o.init(this);p.init(this)},bindUI:function(){function a(){b.detach("docReady",a);if(b.get("focused"))b.focus();else{var c=b.getSelection();c&&c.removeAllRanges()}}var b=this,
c,d=b.prefixCls,e=b.get("textarea");if(b.get("attachForm")&&(c=e[0].form))A.on(c,"submit",b.sync,b);b.on("docReady",a);b.on("blur",function(){b.get("el").removeClass(d+"editor-focused")});b.on("focus",function(){b.get("el").addClass(d+"editor-focused")})},syncUI:function(){this.get("rendered")&&this.get("textarea").val(this.get("data"))},_onSetHeight:function(a){var b=this.get("textarea"),c=this.get("toolBarEl"),d=this.get("statusBarEl"),a=parseInt(a,10),a=a-((c&&c.outerHeight()||0)+(d&&d.outerHeight()||
0));b.parent().css("height",a);b.css("height",a)},_onSetMode:function(a){this.get("rendered");var b=this.get("iframe"),c=this.get("textarea");1==a?(this._setData(c.val()),c.hide(),this.fire("wysiwygMode")):(b&&(c.val(this._getData(1,1)),b.hide()),c.show(),this.fire("sourceMode"))},_onSetFocused:function(a){a&&this.__docReady&&this.focus()},_onSetData:function(a){this.get("rendered")&&this._setData(a)},destructor:function(){var b,c=this.get("textarea"),d=this.get("document")[0],e=this.get("window");
this.get("attachForm")&&(b=c[0].form)&&A.detach(b,"submit",this.sync,this);t.remove(this);A.remove([d,d.documentElement,d.body,e[0]]);a.each(this.__controls,function(a){a.destroy&&a.destroy()});this.__commands={};this.__controls={}},getControl:function(a){return this.__controls[a]},getControls:function(){return this.__controls},addControl:function(a,b){this.__controls[a]=b},showDialog:function(a,b){var a=a+"/dialog",c=this.__controls[a];c.show(b);this.fire("dialogShow",{dialog:c.dialog,pluginDialog:c,
dialogName:a})},addCommand:function(a,b){this.__commands[a]=b},hasCommand:function(a){return this.__commands[a]},execCommand:function(b){var c=this.__commands[b],d=a.makeArray(arguments);d.shift();d.unshift(this);return c?c.exec.apply(c,d):f},queryCommandValue:function(a){return this.execCommand(r.getQueryCmd(a))},_getData:function(b,c){var d=this.htmlDataProcessor,e;if(!this.get("rendered"))return f;c==f&&(c=this.get("mode"));e=1==c&&this.isDocReady()?this.get("document")[0].body.innerHTML:d.toDataFormat(this.get("textarea").val());
e=b?d.toHTML(e):d.toServer(e);e=a.trim(e);E.test(e)&&(e="");return e},_setData:function(a){var b,d=a;if(1!=this.get("mode"))this.get("textarea").val(a);else{if(b=this.htmlDataProcessor)d=b.toDataFormat(a);if(this.get("iframe")){a=this.get("iframe");b=this.get("window")[0];var e=this.get("document")[0];A.remove([e,e.documentElement,e.body,b]);a.remove()}c(this,d)}},getDocHTML:function(){return y(0,this.get("customStyle"),this.get("customLink"),this.get("formatData"))},getDocHtml:function(){return this.getDocHTML()},
getSelection:function(){return m.Selection.getSelection(this.get("document")[0])},getSelectedHTML:function(){var a=this.getSelection().getRanges()[0],b;a&&(a=a.cloneContents(),b=this.get("document")[0].createElement("div"),b.appendChild(a),b=b.innerHTML);return b},focus:function(){var a=this.get("window");if(a){var b=this.get("document")[0],a=a[0];e.ie||a&&a.parent&&a.parent.focus();a&&a.focus();try{b.body.focus()}catch(c){}this.notifySelectionChange()}},blur:function(){this.get("window")[0].blur();
this.get("document")[0].body.blur()},addCustomStyle:function(a,b){var c=this.get("window"),d=this.get("customStyle")||"";this.set("customStyle",d+("\n"+a));c&&k.addStyleSheet(c,a,b)},removeCustomStyle:function(a){k.remove(k.get("#"+a,this.get("window")[0]))},addCustomLink:function(a){var b=this.get("customLink"),c=this.get("document")[0];b.push(a);this.set("customLink",b);b=c.createElement("link");b.rel="stylesheet";c.getElementsByTagName("head")[0].appendChild(b);b.href=a},removeCustomLink:function(b){for(var c=
this.get("document")[0],c=k.query("link",c),d=0;d<c.length;d++)k.attr(c[d],"href")==b&&k.remove(c[d]);c=this.get("customLink");b=a.indexOf(b,c);-1!=b&&c.splice(b,1)},docReady:function(a){this.on("docReady",a);this.__docReady&&a.call(this)},isDocReady:function(){return this.__docReady},checkSelectionChange:function(){var a=this;a.__checkSelectionChangeId&&clearTimeout(a.__checkSelectionChangeId);a.__checkSelectionChangeId=setTimeout(function(){var b=a.getSelection();if(b&&!b.isInvalid){var c=b.getStartElement(),
d=new m.ElementPath(c);if(!a.__previousPath||!a.__previousPath.compare(d))a.__previousPath=d,a.fire("selectionChange",{selection:b,path:d,element:c})}},100)},notifySelectionChange:function(){this.__previousPath=null;this.checkSelectionChange()},insertElement:function(a){if(1!==this.get("mode"))return f;this.focus();var b,c=a.nodeName(),d=m.XHTML_DTD,e=d.$block[c],h=m.RANGE,g=(c=this.getSelection())&&c.getRanges(),j,k,l;if(!g||0==g.length)return f;this.execCommand("save");for(k=g.length-1;0<=k;k--)j=
g[k],b=!k&&a||a.clone(i),j.insertNodeByDtd(b),l||(l=b);if(!l)return f;j.moveToPosition(l,h.POSITION_AFTER_END);e&&(a=m.Walker.whitespaces(!0),(a=(l=l.next(a,1))&&l[0].nodeType==v.ELEMENT_NODE&&l.nodeName())&&d.$block[a]&&d[a]["#text"]&&j.moveToElementEditablePosition(l));c.selectRanges([j]);this.focus();b&&1==b[0].nodeType&&b.scrollIntoView(f,{alignWithTop:!1,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0});H.call(this);return b},insertHTML:function(a,c){var d=this,e,g=d.get("document")[0];if(1===
d.get("mode")){if(e=d.htmlDataProcessor)a=e.toDataFormat(a,c);d.focus();d.execCommand("save");if(h){e=g.selection;"Control"==e.type&&e.clear();try{e.createRange().pasteHTML(a)}catch(i){}}else try{g.execCommand("inserthtml",b,a)}catch(j){setTimeout(function(){if(0==d.getSelection().getRanges().length){var c=new m.Range(g),e=k.first(g.body,function(a){return 1==a.nodeType&&"br"!=k.nodeName(a)});e||(e=new z(g.createElement("p")),e._4e_appendBogus(f),g.body.appendChild(e[0]));c.setStartAt(e,m.RANGE.POSITION_AFTER_START);
c.select()}g.execCommand("inserthtml",b,a)},50)}setTimeout(function(){d.getSelection().scrollIntoView()},50);H.call(d)}}});m._initIFrame=function(a){var c=t.getInstance(a),d=c.get("document")[0],a=d.getElementById("ke_active_script");k.remove(a);j(c);var f=d.body;h?(f.hideFocus=i,f.disabled=i,f.contentEditable=i,f.removeAttribute("disabled")):setTimeout(function(){e.gecko||e.opera?f.contentEditable=i:e.webkit?f.parentNode.contentEditable=i:d.designMode="on"},0);if(e.gecko||e.opera){var g=d.documentElement;
A.on(g,"mousedown",function(a){if(a.target==g){e.gecko&&w(d,b);c.activateGecko()}})}setTimeout(function(){h&&setTimeout(function(){if(d){f.runtimeStyle.marginBottom="0px";f.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){c.__docReady=1;c.fire("docReady");var a=c.get("disableObjectResizing"),e=c.get("disableInlineTableEditing");if(a||e)try{d.execCommand("enableObjectResizing",b,!a);d.execCommand("enableInlineTableEditing",b,!e)}catch(g){A.on(f,h?"resizestart":"resize",function(b){var c=
new z(b.target);(a||c.nodeName()==="table"&&e)&&b.preventDefault()})}},10)};var H=a.buffer(function(){this.execCommand("save")},50);return m},{requires:"editor/core/base,editor/core/utils,editor/core/focusManager,editor/core/styles,editor/core/zIndexManager,editor/core/clipboard,editor/core/enterKey,editor/core/htmlDataProcessor,editor/core/selectionFix,editor/core/plugin-meta".split(",")});
