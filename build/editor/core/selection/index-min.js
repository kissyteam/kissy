/*
Copyright 2012, KISSY UI Library v1.30dev
MIT Licensed
build time: May 30 12:21
*/
KISSY.add("editor/plugin/selection/index",function(r,m){function v(c){function g(a,b){var c=d.body.createTextRange();try{c.moveToPoint(a,b)}catch(e){c=t}return c}function k(){var a=d.selection.createRange();f&&!a.item&&0===a.compareEndPoints("StartToEnd",a)&&f.select();o.remove(d,"mouseup",k);o.remove(d,"mousemove",i);f=l=0}function i(a){if(a.button){if(a=g(a.pageX,a.pageY))0<a.compareEndPoints("StartToStart",f)?a.setEndPoint("StartToStart",f):a.setEndPoint("EndToEnd",f),a.select()}else k()}var l,
j=c.get("window")[0],d=c.get("document")[0],f;o.on(d,"mousedown contextmenu",function(a){var b=d.documentElement;if(a.target===b&&(l&&k(),!(b.scrollHeight>b.clientHeight)&&(l=1,f=g(a.pageX,a.pageY))))o.on(d,"mouseup",k),o.on(d,"mousemove",i),j.focus(),f.select()})}function w(c){function n(a){if(d){var b=c.getSelection(),f=b&&b.getType(),e=b&&k.selection;if(a&&e&&f==x.SELECTION_NONE&&!k.queryCommandEnabled("InsertImage"))setTimeout(function(){n(g)},50);else{var h;if(!e||!e.type||!("Control"!=e.type&&
(h=e.createRange())&&(h=h.parentElement())&&(h=h.nodeName)&&h.toLowerCase()in{input:1,textarea:1}))j=e&&b.getRanges()[0],c.checkSelectionChange()}}}var k=c.get("document")[0],i=new p(k.body),l=new p(k.documentElement);if(8>m.Utils.ieEngine)l.on("click",function(a){"html"===(new p(a.target)).nodeName()&&c.getSelection().getNative().createRange().select()});var j,d,f=g;l.on("mousedown",function(){f=q});l.on("mouseup",function(){f=g});i.on("focusin",function(a){if("body"==(new p(a.target)).nodeName()&&
j){try{f&&j.select()}catch(b){}j=t}});i.on("focus",function(){d=g;n()});i.on("beforedeactivate",function(a){a.relatedTarget||(d=q,f=g)});i.on("mousedown",function(){d=q});i.on("mouseup",function(){d=g;setTimeout(function(){n(g)},0)});i.on("keydown",function(){d=q});i.on("keyup",function(){d=g;setTimeout(function(){n()},0)})}function y(c){var g=c.get("document")[0];o.on(g,"mouseup keyup",function(){c.checkSelectionChange()})}function z(c){function n(a){var b=m.XHTML_DTD;return a._4e_isBlockBoundary()&&
b.$empty[a.nodeName()]}function k(a){return j(a)&&d(a)}var i=c.get("document")[0],l=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;|(<\!--[\s\S]*?--\>))?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,j=m.Walker.whitespaces(g),d=m.Walker.bookmark(q,g),f=function(a){return j(a)&&8!=a.nodeType};c.on("selectionChange",function(a){var b=a.path,d=new p(c.get("document")[0].body),a=(a=a.selection)&&a.getRanges()[0],e=b.blockLimit;if(s.gecko){var h=b.block||b.blockLimit,j=h&&h.last(k);h&&h._4e_isBlockBoundary()&&
(!j||!(1==j[0].nodeType&&j._4e_isBlockBoundary()))&&"pre"!=h.nodeName()&&!h._4e_getBogus()&&h._4e_appendBogus()}if(a&&a.collapsed&&!b.block){if("body"==e.nodeName()){if((b=a.fixBlock(g,"p"))&&b[0]!=d[0].lastChild&&b._4e_outerHtml().match(l))if((e=b.next(f,1))&&e[0].nodeType==u.ELEMENT_NODE&&!n[e])a.moveToElementEditablePosition(e),b._4e_remove();else if((e=b.prev(f,1))&&e[0].nodeType==u.ELEMENT_NODE&&!n[e])a.moveToElementEditablePosition(e,e._4e_outerHtml().match(l)?q:g),b._4e_remove();a.select();
c.notifySelectionChange()}b=new m.Range(i);b.moveToElementEditablePosition(d,g);"body"!==(new m.ElementPath(b.startContainer)).blockLimit.nodeName()&&(d=(new p(i.createElement("p"))).appendTo(d),s.ie||d._4e_appendBogus())}})}var g=!0,q=!1,t=null,s=r.UA,o=r.Event,u=r.DOM,p=r.Node,x=m.SELECTION;return{init:function(c){c.docReady(function(){s.ie?(v(c),w(c)):y(c)});z(c)}}},{requires:["editor"]});
