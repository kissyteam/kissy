/*
Copyright 2014, KISSY v5.0.0
MIT Licensed
build time: Jun 13 11:46
*/
KISSY.add("editor/plugin/image/dialog","util,editor,io,../dialog,xtemplate/runtime,tabs,../menubutton,./dialog/dialog-xtpl,ua,node".split(","),function(h,f,u,l){function d(b){for(;b;){var a=b.nodeName();if(a==="a")return b;if(r.$block[a]||r.$blockLimit[a])break;b=b.parent()}return null}function a(b,a){this.editor=b;this.imageCfg=a||{};this.suffix=(this.cfg=this.imageCfg.upload||null)&&this.cfg.suffix||"png,jpg,jpeg,gif";this.suffixReg=RegExp(this.suffix.split(/,/).join("|")+"$","i");this.suffixWarning=
"\u53ea\u5141\u8bb8\u540e\u7f00\u540d\u4e3a"+this.suffix+"\u7684\u56fe\u7247"}var c=f("util"),i=f("editor"),v=f("io"),w=f("../dialog"),x=f("xtemplate/runtime"),y=f("tabs"),z=f("../menubutton"),A=f("./dialog/dialog-xtpl"),r=i.XHTML_DTD,s=f("ua"),n=f("node"),j="\u8bf7\u70b9\u51fb\u6d4f\u89c8\u4e0a\u4f20\u56fe\u7247",k=i.Utils.valInput;a.prototype={_prepare:function(){var b=this,a=b.editor.get("prefixCls")+"editor-";b.dialog=b.d=(new w({width:500,headerContent:"\u56fe\u7247",bodyContent:(new x(A)).render({prefixCls:a}),footerContent:c.substitute('<div style="padding:5px 20px 20px;"><a href="javascript:void(\'\u786e\u5b9a\')" class="{prefixCls}img-insert {prefixCls}button ks-inline-block" style="margin-right:30px;">\u786e\u5b9a</a> <a  href="javascript:void(\'\u53d6\u6d88\')" class="{prefixCls}img-cancel {prefixCls}button ks-inline-block">\u53d6\u6d88</a></div>',
{prefixCls:a}),mask:true})).render();var e=b.d.get("el"),d=e.one("."+a+"img-cancel"),f=e.one("."+a+"img-insert"),h=i.Utils.verifyInputs,B=e.one("."+a+"img-setting");b.uploadForm=e.one("."+a+"img-upload-form");b.imgLocalUrl=e.one("."+a+"img-local-url");b.tab=(new y({srcNode:b.d.get("body").one("."+a+"img-tabs"),prefixCls:a+"img-"})).render();b.imgLocalUrl.val(j);b.imgUrl=e.one("."+a+"img-url");b.imgHeight=e.one("."+a+"img-height");b.imgWidth=e.one("."+a+"img-width");b.imgRatio=e.one("."+a+"img-ratio");
b.imgAlign=z.Select.decorate(e.one("."+a+"img-align"),{prefixCls:a+"big-",width:80,menuCfg:{prefixCls:a+"",render:e}});b.imgMargin=e.one("."+a+"img-margin");b.imgLink=e.one("."+a+"img-link");b.imgLinkBlank=e.one("."+a+"img-link-blank");var g=i.Utils.placeholder;g(b.imgUrl,"http://");g(b.imgHeight,"\u81ea\u52a8");g(b.imgWidth,"\u81ea\u52a8");g(b.imgLink,"http://");b.imgHeight.on("keyup",function(){var a=parseInt(k(b.imgHeight),10);a&&b.imgRatio[0].checked&&!b.imgRatio[0].disabled&&b.imgRatioValue&&k(b.imgWidth,Math.floor(a*
b.imgRatioValue))});b.imgWidth.on("keyup",function(){var a=parseInt(k(b.imgWidth),10);a&&b.imgRatio[0].checked&&!b.imgRatio[0].disabled&&b.imgRatioValue&&k(b.imgHeight,Math.floor(a/b.imgRatioValue))});d.on("click",function(a){b.d.hide();a.halt()});var p=n('<a class="'+a+'button ks-inline-block" style="position:absolute;z-index:'+i.baseZIndex(i.ZIndexManager.LOADING_CANCEL)+';left:-9999px;top:-9999px;">\u53d6\u6d88\u4e0a\u4f20</a>').appendTo(document.body,void 0);b.loadingCancel=p;f.on("click",function(a){a.halt();if((b.imageCfg.remote===
false||c.indexOf(b.tab.getSelectedTab(),b.tab.getTabs())===1)&&b.cfg){if(h(B.all("input")))if(b.imgLocalUrl.val()===j)alert("\u8bf7\u5148\u9009\u62e9\u6587\u4ef6!");else if(b.suffixReg.test(b.imgLocalUrl.val())){a=b.fileInput[0].files?b.fileInput[0].files[0].size:0;if(m&&m<a/1E3)alert("\u4e0a\u4f20\u56fe\u7247\u6700\u5927\uff1a"+m/1E3+"M");else{b.d.loading();p.on("click",function(b){b.halt();d.abort()});a=i.Utils.normParams(b.cfg.serverParams)||{};a["document-domain"]=document.domain;var d=v({data:a,url:b.cfg.serverUrl,form:b.uploadForm[0],dataType:"json",type:"post",
complete:function(a,c){p.css({left:-9999,top:-9999});b.d.unloading();if(c!=="abort"){a||(a={error:"\u670d\u52a1\u5668\u51fa\u9519\uff0c\u8bf7\u91cd\u8bd5"});if(a.error)alert(a.error);else{k(b.imgUrl,a.imgUrl);(new Image).src=a.imgUrl;b._insert()}}}}),a=b.d.get("el"),g=a.offset();p.css({left:g.left+a[0].offsetWidth/2.5,top:g.top+a[0].offsetHeight/1.5})}}else{alert(b.suffixWarning);b.uploadForm[0].reset();b.imgLocalUrl.val(j)}}else h(e.all("input"))&&b._insert()});if(b.cfg){b.cfg.extraHTML&&e.one("."+a+"img-up-extraHTML").html(b.cfg.extraHTML);
var t=e.one("."+a+"image-up"),m=b.cfg&&b.cfg.sizeLimit;b.fileInput=n('<input type="file" style="position:absolute;cursor:pointer;left:'+(s.ie?"360":s.chrome?"319":"369")+'px;z-index:2;top:0px;height:26px;" size="1" name="'+(b.cfg.fileInput||"Filedata")+'"/>').insertAfter(b.imgLocalUrl);m&&(j="\u5355\u5f20\u56fe\u7247\u5bb9\u91cf\u4e0d\u8d85\u8fc7 "+m/1E3+" M");b.imgLocalUrl.val(j);b.fileInput.css("opacity",0);b.fileInput.on("mouseenter",function(){t.addClass(""+a+"button-hover")});b.fileInput.on("mouseleave",function(){t.removeClass(""+a+"button-hover")});
b.fileInput.on("change",function(){var a=b.fileInput.val();b.imgLocalUrl.val(a.replace(/.+[\/\\]/,""))});b.imageCfg.remote===false&&b.tab.removeItemAt(0,1)}else b.tab.removeItemAt(1,1);b._prepare=c.noop},_insert:function(){var b=this,a=k(b.imgUrl),e,f=parseInt(k(b.imgHeight),10),h=parseInt(k(b.imgWidth),10),i=b.imgAlign.get("value"),j=parseInt(b.imgMargin.val(),10),g="";f&&(g=g+("height:"+f+"px;"));h&&(g=g+("width:"+h+"px;"));i!=="none"&&(g=g+("float:"+i+";"));!isNaN(j)&&j!==0&&(g=g+("margin:"+j+
"px;"));b.d.hide();if(b.selectedEl){e=b.selectedEl;b.editor.execCommand("save");b.selectedEl.attr({src:a,_ke_saved_src:a,style:g})}else{e=n("<img "+(g?'style="'+g+'"':"")+' src="'+a+'" _ke_saved_src="'+a+'" alt="" />',b.editor.get("document")[0]);b.editor.insertElement(e)}setTimeout(function(){var a=d(e),g=c.trim(k(b.imgLink)),f=b.editor.getSelection(),h=b.imgLinkBlank.attr("checked")?"_blank":"_self",i,j=0,o,l,q;if(a){i=a.attr("target")||"_self";if(g!==a.attr("href")||i!==h){e._4eBreakParent(a);
(o=e.prev())&&o.nodeName()==="a"&&!o[0].childNodes.length&&o.remove();(l=e.next())&&l.nodeName()==="a"&&!l[0].childNodes.length&&l.remove()}else j=1}if(!j&&g){b.selectedEl||(q=f.createBookmarks());a=n("<a>");a.attr("_ke_saved_href",g).attr("href",g).attr("target",h);g=e[0];g.parentNode.replaceChild(a[0],g);a.append(g)}q?f.selectBookmarks(q):b.selectedEl&&b.editor.getSelection().selectElement(b.selectedEl);j||b.editor.execCommand("save")},100)},_update:function(a){var c=0,e,f=i.Utils.resetInput;if((this.selectedEl=
a)&&this.imageCfg.remote!==false){k(this.imgUrl,a.attr("src"));e=parseInt(a.style("width"),10);var h=parseInt(a.style("height"),10);h?k(this.imgHeight,h):f(this.imgHeight);e?k(this.imgWidth,e):f(this.imgWidth);this.imgAlign.set("value",a.style("float")||"none");this.imgMargin.val(parseInt(a.style("margin"),10)||0);this.imgRatio[0].disabled=false;this.imgRatioValue=e/h;e=d(a)}else{(a=(a=this.editor.getSelection())&&a.getCommonAncestor())&&(e=d(a));a=this.imageCfg.defaultMargin;a===void 0&&(a=10);this.tab.get("bar").get("children").length===
2&&(c=1);this.imgLinkBlank.attr("checked",true);f(this.imgUrl);f(this.imgLink);f(this.imgHeight);f(this.imgWidth);this.imgAlign.set("value","none");this.imgMargin.val(a);this.imgRatio[0].disabled=true;this.imgRatioValue=null}if(e){k(this.imgLink,e.attr("_ke_saved_href")||e.attr("href"));this.imgLinkBlank.attr("checked",e.attr("target")==="_blank")}else{f(this.imgLink);this.imgLinkBlank.attr("checked",true)}this.uploadForm[0].reset();this.imgLocalUrl.val(j);f=this.tab;f.setSelectedTab(f.getTabAt(c))},
show:function(a){this._prepare();this._update(a);this.d.show()},destroy:function(){this.d.destroy();this.tab.destroy();this.loadingCancel&&this.loadingCancel.remove();this.imgAlign&&this.imgAlign.destroy()}};l.exports=a});
KISSY.add("editor/plugin/image/dialog/dialog-xtpl",[],function(h,f,u,l){h=function(d,a){a.write("<div class='",0);var c=d.resolve(["prefixCls"],0);a.write(c,!1);a.write("img-tabs'>\r\n    <div class='",0);c=d.resolve(["prefixCls"],0);a.write(c,!1);a.write("img-tabs-bar ks-clear'>\r\n        <div\r\n                class='",0);c=d.resolve(["prefixCls"],0);a.write(c,!1);a.write("img-tabs-tab-selected ",0);c=d.resolve(["prefixCls"],0);a.write(c,!1);a.write("img-tabs-tab'\r\n\r\n                hidefocus='hidefocus'>\r\n            \u7f51\u7edc\u56fe\u7247\r\n        </div>\r\n        <div\r\n                class='",
0);c=d.resolve(["prefixCls"],0);a.write(c,!1);a.write("img-tabs-tab'\r\n                hidefocus='hide\r\n    focus'>\r\n            \u672c\u5730\u4e0a\u4f20\r\n        </div>\r\n    </div>\r\n    <div class='",0);c=d.resolve(["prefixCls"],0);a.write(c,!1);a.write("img-tabs-body'>\r\n        <div class='",0);c=d.resolve(["prefixCls"],0);a.write(c,!1);a.write("img-tabs-panel ",0);c=d.resolve(["prefixCls"],0);a.write(c,!1);a.write("img-tabs-panel-selected'>\r\n            <label>\r\n        <span class='",0);c=d.resolve(["prefixCls"],
0);a.write(c,!1);a.write("image-title'>\r\n        \u56fe\u7247\u5730\u5740\uff1a\r\n        </span>\r\n                <input\r\n                        data-verify='^(https?:/)?/[^\\\\s]'\r\n                        data-warning='\u7f51\u5740\u683c\u5f0f\u4e3a\uff1ahttp:// \u6216 /'\r\n                        class='",0);c=d.resolve(["prefixCls"],0);a.write(c,!1);a.write("img-url ",0);c=d.resolve(["prefixCls"],0);a.write(c,!1);a.write("input'\r\n                        style='width:390px;vertical-align:middle;'\r\n                        />\r\n            </label>\r\n        </div>\r\n        <div class='",
0);c=d.resolve(["prefixCls"],0);a.write(c,!1);a.write("img-tabs-panel'>\r\n            <form class='",0);c=d.resolve(["prefixCls"],0);a.write(c,!1);a.write("img-upload-form' enctype='multipart/form-data'>\r\n                <p style='zoom:1;'>\r\n                    <input class='",0);c=d.resolve(["prefixCls"],0);a.write(c,!1);a.write("input ",0);c=d.resolve(["prefixCls"],0);a.write(c,!1);a.write("img-local-url'\r\n                           readonly='readonly'\r\n                           style='margin-right: 15px;\r\n            vertical-align: middle;\r\n            width: 368px;\r\n            color:#969696;'/>\r\n                    <a\r\n                            style='padding:3px 11px;\r\n            position:absolute;\r\n            left:390px;\r\n            top:0;\r\n            z-index:1;'\r\n                            class='",
0);c=d.resolve(["prefixCls"],0);a.write(c,!1);a.write("image-up ",0);c=d.resolve(["prefixCls"],0);a.write(c,!1);a.write("button ks-inline-block'>\u6d4f\u89c8...</a>\r\n                </p>\r\n\r\n                <div class='",0);c=d.resolve(["prefixCls"],0);a.write(c,!1);a.write("img-up-extraHTML'>\r\n                </div>\r\n            </form>\r\n        </div>\r\n    </div>\r\n</div>\r\n<div style='\r\n            padding:0 20px 5px 20px;'>\r\n    <table\r\n            style='width:100%;margin-top:8px;'\r\n            class='",
0);c=d.resolve(["prefixCls"],0);a.write(c,!1);a.write("img-setting'>\r\n        <tr>\r\n            <td>\r\n                <label>\r\n                    \u5bbd\u5ea6\uff1a\r\n                </label>\r\n                <input\r\n                        data-verify='^(\u81ea\u52a8|((?!0$)\\\\d+))?$'\r\n                        data-warning='\u5bbd\u5ea6\u8bf7\u8f93\u5165\u6b63\u6574\u6570'\r\n                        class='",0);c=d.resolve(["prefixCls"],0);a.write(c,!1);a.write("img-width ",0);c=d.resolve(["prefixCls"],0);a.write(c,!1);a.write("input'\r\n                        style='vertical-align:middle;width:60px'\r\n                        /> \u50cf\u7d20\r\n\r\n            </td>\r\n            <td>\r\n                <label>\r\n                    \u9ad8\u5ea6\uff1a\r\n                    <label>\r\n                        <input\r\n                                data-verify='^(\u81ea\u52a8|((?!0$)\\\\d+))?$'\r\n                                data-warning='\u9ad8\u5ea6\u8bf7\u8f93\u5165\u6b63\u6574\u6570'\r\n                                class='",
0);c=d.resolve(["prefixCls"],0);a.write(c,!1);a.write("img-height ",0);c=d.resolve(["prefixCls"],0);a.write(c,!1);a.write("input'\r\n                                style='vertical-align:middle;width:60px'\r\n                                /> \u50cf\u7d20 </label>\r\n\r\n                    <input\r\n                            type='checkbox'\r\n                            class='",0);c=d.resolve(["prefixCls"],0);a.write(c,!1);a.write("img-ratio'\r\n                            style='vertical-align:middle;margin-left:5px;'\r\n                            checked='checked'/>\r\n                    \u9501\u5b9a\u9ad8\u5bbd\u6bd4\r\n                </label>\r\n            </td>\r\n        </tr>\r\n        <tr>\r\n            <td>\r\n                <label>\r\n                    \u5bf9\u9f50\uff1a\r\n                </label>\r\n                <select class='",
0);c=d.resolve(["prefixCls"],0);a.write(c,!1);a.write("img-align' title='\u5bf9\u9f50'>\r\n                    <option value='none'>\u65e0</option>\r\n                    <option value='left'>\u5de6\u5bf9\u9f50</option>\r\n                    <option value='right'>\u53f3\u5bf9\u9f50</option>\r\n                </select>\r\n\r\n            </td>\r\n            <td><label>\r\n                \u95f4\u8ddd\uff1a\r\n            </label>\r\n                <input\r\n                        data-verify='^\\\\d+$'\r\n                        data-warning='\u95f4\u8ddd\u8bf7\u8f93\u5165\u975e\u8d1f\u6574\u6570'\r\n                        class='",
0);c=d.resolve(["prefixCls"],0);a.write(c,!1);a.write("img-margin ",0);c=d.resolve(["prefixCls"],0);a.write(c,!1);a.write("input'\r\n                        style='width:60px'/> \u50cf\u7d20\r\n\r\n            </td>\r\n        </tr>\r\n        <tr>\r\n            <td colspan='2' style='padding-top: 6px'>\r\n                <label>\r\n                    \u94fe\u63a5\u7f51\u5740\uff1a\r\n                </label>\r\n                <input\r\n                        class='",0);c=d.resolve(["prefixCls"],0);a.write(c,!1);a.write("img-link ",
0);c=d.resolve(["prefixCls"],0);a.write(c,!1);a.write("input'\r\n                        style='width:235px;vertical-align:middle;'\r\n                        data-verify='^(?:(?:\\\\s*)|(?:https?://[^\\\\s]+)|(?:#.+))$'\r\n                        data-warning='\u8bf7\u8f93\u5165\u5408\u9002\u7684\u7f51\u5740\u683c\u5f0f'\r\n                        />\r\n\r\n                <label>\r\n                    <input\r\n                            class='",0);c=d.resolve(["prefixCls"],0);a.write(c,!1);a.write("img-link-blank'\r\n                            style='vertical-align:middle;\r\n                margin-left:5px;'\r\n                            type='checkbox'/>\r\n                    &nbsp; \u5728\u65b0\u7a97\u53e3\u6253\u5f00\u94fe\u63a5\r\n                </label>\r\n            </td>\r\n        </tr>\r\n    </table>\r\n</div>\r\n",
0);return a};h.TPL_NAME=l.name;h.version="5.0.0";l.exports=h});
