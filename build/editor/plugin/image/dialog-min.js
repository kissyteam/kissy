/*
Copyright 2012, KISSY UI Library v1.30dev
MIT Licensed
build time: May 30 12:21
*/
KISSY.add("editor/plugin/image/dialog",function(k,s,e,t,u,v){function n(a){for(a=a.parent();a;){var b=a.nodeName();if("a"==b)return a;if(o.$block[b]||o.$blockLimit[b])break;a=a.parent()}return null}function p(a){this.editor=a;this.imageCfg=a.get("pluginConfig").image||{};this.suffix=(this.cfg=this.imageCfg.upload||null)&&this.cfg.suffix||"png,jpg,jpeg,gif";this.suffix_reg=RegExp(this.suffix.split(/,/).join("|")+"$","i");this.suffix_warning="只允许后缀名为"+this.suffix+"的图片"}var o=e.XHTML_DTD,q=k.UA,l=k.Node,
i="请点击浏览上传图片",g=e.Utils.valInput;k.augment(p,{_prepare:function(){var a=this;a.dialog=a.d=new t.Dialog({autoRender:!0,width:500,headerContent:"图片",bodyContent:"<div class='ke-image-wrap'><ul class='ke-tabs ks-clear ks-switchable-nav'><li class='ks-active' hidefocus='hidefocus'>网络图片</li><li hidefocus='hidefocus'>本地上传</li></ul><div style='padding:12px 20px 5px 20px;'><div class='ke-image-tabs-content-wrap ks-switchable-content' ><div><label><span class='ke-image-title'>图片地址： </span><input  data-verify='^(https?:/)?/[^\\s]+$'  data-warning='网址格式为：http:// 或 /' class='ke-img-url ke-input' style='width:390px;vertical-align:middle;' /></label></div><div style='position:relative;display: none'><form class='ke-img-upload-form' enctype='multipart/form-data'><p style='zoom:1;'><input class='ke-input ke-img-local-url' readonly='readonly' style='margin-right: 15px; vertical-align: middle; width: 368px;color:#969696;'/><a style='padding:3px 11px;position:absolute;left:390px;top:0px;z-index:1;' class='ke-image-up ke-button'>浏览...</a></p><div class='ke-img-up-extraHtml'></div></form></div></div><table style='width:100%;margin-top:8px;' class='ke-img-setting'><tr><td><label>宽度： <input  data-verify='^(自动|((?!0$)\\d+))?$'  data-warning='宽度请输入正整数' class='ke-img-width ke-input' style='vertical-align:middle;width:60px' /> 像素 </label></td><td><label>高度： <input  data-verify='^(自动|((?!0$)\\d+))?$'  data-warning='高度请输入正整数' class='ke-img-height ke-input' style='vertical-align:middle;width:60px' /> 像素 </label><label><input type='checkbox' class='ke-img-ratio' style='vertical-align:middle;margin-left:5px;' checked='checked'/> 锁定高宽比</label></td></tr><tr><td><label>对齐：<select class='ke-img-align' title='对齐'><option value=''>无</option><option value='left'>左对齐</option><option value='right'>右对齐</option></select></label></td><td><label>间距： <input  data-verify='^\\d+$'  data-warning='间距请输入非负整数' class='ke-img-margin ke-input' style='width:60px' value='10'/> 像素</label></td></tr><tr><td colspan='2' style='padding-top: 6px'><label>链接网址： <input class='ke-img-link ke-input' style='width:235px;vertical-align:middle;'  data-verify='^(?:(?:\\s*)|(?:https?://[^\\s]+)|(?:#.+))$'  data-warning='请输入合适的网址格式' /></label><label><input class='ke-img-link-blank' style='vertical-align:middle;margin-left:5px;' type='checkbox'/> &nbsp; 在新窗口打开链接</label></td></tr></table></div></div>",
footerContent:"<div style='padding:5px 20px 20px;'><a href='javascript:void('确定')' class='ke-img-insert ke-button' style='margin-right:30px;'>确定</a> <a  href='javascript:void('取消')' class='ke-img-cancel ke-button'>取消</a></div>",mask:!0});var b=a.d.get("el"),c=b.one(".ke-img-cancel"),h=b.one(".ke-img-insert"),r=e.Utils.verifyInputs,w=b.one(".ke-img-setting");a.uploadForm=b.one(".ke-img-upload-form");a.imgLocalUrl=b.one(".ke-img-local-url");a.tab=new u.Tabs(a.d.get("body")[0],{triggerType:"click"});
a.imgLocalUrl.val(i);a.imgUrl=b.one(".ke-img-url");a.imgHeight=b.one(".ke-img-height");a.imgWidth=b.one(".ke-img-width");a.imgRatio=b.one(".ke-img-ratio");a.imgAlign=v.decorate(b.one(".ke-img-align"));a.imgMargin=b.one(".ke-img-margin");a.imgLink=b.one(".ke-img-link");a.imgLinkBlank=b.one(".ke-img-link-blank");var j=e.Utils.placeholder;j(a.imgUrl,"http://");j(a.imgHeight,"自动");j(a.imgWidth,"自动");j(a.imgLink,"http://");a.imgHeight.on("keyup",function(){var b=parseInt(g(a.imgHeight));b&&a.imgRatio[0].checked&&
!a.imgRatio[0].disabled&&a.imgRatioValue&&g(a.imgWidth,Math.floor(b*a.imgRatioValue))});a.imgWidth.on("keyup",function(){var b=parseInt(g(a.imgWidth));b&&a.imgRatio[0].checked&&!a.imgRatio[0].disabled&&a.imgRatioValue&&g(a.imgHeight,Math.floor(b/a.imgRatioValue))});c.on("click",function(b){a.d.hide();b.halt()});var d=(new l("<a class='ke-button' style='position:absolute;z-index:"+e.baseZIndex(e.zIndexManager.LOADING_CANCEL)+";left:-9999px;top:-9999px;'>取消上传</a>")).appendTo(document.body,void 0);h.on("click",
function(c){c.halt();if(1==a.tab.activeIndex&&a.cfg){if(r(w.all("input")))if(a.imgLocalUrl.val()==i)alert("请先选择文件!");else if(a.suffix_reg.test(a.imgLocalUrl.val()))if(c=a.fileInput[0].files?a.fileInput[0].files[0].size:0,f&&f<c/1E3)alert("上传图片最大："+f/1E3+"M");else{a.d.loading();d.on("click",function(a){a.halt();m.abort()});var m=s({data:e.Utils.normParams(a.cfg.serverParams),url:a.cfg.serverUrl,form:a.uploadForm[0],dataType:"json",type:"post",complete:function(b,c){d.css({left:-9999,top:-9999});a.d.unloading();
"abort"!=c&&(b||(b={error:"服务器出错，请重试"}),b.error?alert(b.error):(g(a.imgUrl,b.imgUrl),(new Image).src=b.imgUrl,a._insert()))}}),c=a.d.get("el"),h=c.offset();d.css({left:h.left+c[0].offsetWidth/2.5,top:h.top+c[0].offsetHeight/1.5})}else alert(a.suffix_warning),a.uploadForm[0].reset(),a.imgLocalUrl.val(i)}else r(b.all("input"))&&a._insert()});if(a.cfg){a.cfg.extraHtml&&b.one(".ke-img-up-extraHtml").html(a.cfg.extraHtml);var m=b.one(".ke-image-up"),f=a.cfg&&a.cfg.sizeLimit;a.fileInput=(new l("<input type='file' style='position:absolute;cursor:pointer;left:"+
(q.ie?"360":q.chrome?"319":"369")+"px;z-index:2;top:0px;height:26px;' size='1' name='"+(a.cfg.fileInput||"Filedata")+"'/>")).insertAfter(a.imgLocalUrl);f&&(i="单张图片容量不超过 "+f/1E3+" M");a.imgLocalUrl.val(i);a.fileInput.css("opacity",0);a.fileInput.on("mouseenter",function(){m.addClass("ke-button-hover")});a.fileInput.on("mouseleave",function(){m.removeClass("ke-button-hover")});a.fileInput.on("change",function(){var b=a.fileInput.val();a.imgLocalUrl.val(b.replace(/.+[\/\\]/,""))});!1===a.imageCfg.remote&&
a.tab.remove(0)}else a.tab.remove(1);a._prepare=k.noop},_insert:function(){var a=this,b=g(a.imgUrl),c,h=parseInt(g(a.imgHeight)),e=parseInt(g(a.imgWidth)),i=a.imgAlign.val(),j=parseInt(a.imgMargin.val()),d="";h&&(d+="height:"+h+"px;");e&&(d+="width:"+e+"px;");i&&(d+="float:"+i+";");isNaN(j)||(d+="margin:"+j+"px;");a.d.hide();a.selectedEl?(c=a.selectedEl,a.editor.execCommand("save"),a.selectedEl.attr({src:b,_ke_saved_src:b,style:d})):(c=new l("<img "+(d?"style='"+d+"'":"")+" src='"+b+"' _ke_saved_src='"+
b+"' alt='' />",null,a.editor.get("document")[0]),a.editor.insertElement(c));setTimeout(function(){var b=n(c),f=k.trim(g(a.imgLink)),d=a.editor.getSelection(),e;if(b)if(f)b.attr("_ke_saved_href",f).attr("href",f).attr("target",a.imgLinkBlank.attr("checked")?"_blank":"_self");else{e=d.createBookmarks();b._4e_remove(true)}else if(f){e=d.createBookmarks();b=new l("<a></a>");b.attr("_ke_saved_href",f).attr("href",f).attr("target",a.imgLinkBlank.attr("checked")?"_blank":"_self");f=c[0];f.parentNode.replaceChild(b[0],
f);b.append(f)}e&&d.selectBookmarks(e);a.selectedEl&&a.editor.execCommand("save")},100)},_update:function(a){var b=0,c=e.Utils.resetInput;if((this.selectedEl=a)&&!1!==this.imageCfg.remote){g(this.imgUrl,this.selectedEl.attr("src"));var a=this.selectedEl.width(),h=this.selectedEl.height();g(this.imgHeight,h);g(this.imgWidth,a);this.imgAlign.val(this.selectedEl.css("float")||"none");this.imgMargin.val(parseInt(this.selectedEl.style("margin"))||0);this.imgRatio[0].disabled=!1;this.imgRatioValue=a/h;
(a=n(this.selectedEl))?(g(this.imgLink,a.attr("_ke_saved_href")||a.attr("href")),this.imgLinkBlank.attr("checked","_blank"==a.attr("target"))):(c(this.imgLink),this.imgLinkBlank.attr("checked",!0))}else 2==this.tab.panels.length&&(b=1),this.imgLinkBlank.attr("checked",!0),c(this.imgUrl),c(this.imgLink),c(this.imgHeight),c(this.imgWidth),this.imgAlign.val("none"),this.imgMargin.val(10),this.imgRatio[0].disabled=!0,this.imgRatioValue=null;this.uploadForm[0].reset();this.imgLocalUrl.val(i);this.tab.switchTo(b)},
show:function(a){this._prepare();this._update(a);this.d.show()},destroy:function(){this.d.destroy();this.tab.destroy()}});return p},{requires:["ajax","editor","../overlay/","switchable","../select/"]});
