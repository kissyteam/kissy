/*
Copyright 2012, KISSY UI Library v1.30dev
MIT Licensed
build time: May 31 22:01
*/
KISSY.add("editor/plugin/table/index",function(j,k,r,y){function s(a){function d(a){!(0<f.length)&&a[0].nodeType==l.ELEMENT_NODE&&t.test(a.nodeName())&&!a.data("selected_cell")&&(a._4e_setMarker(e,"selected_cell",!0,void 0),f.push(a))}for(var c=a.createBookmarks(),b=a.getRanges(),f=[],e={},g=0;g<b.length;g++){var i=b[g];if(i.collapsed)i=i.getCommonAncestor(),(i=i.closest("td",void 0)||i.closest("th",void 0))&&f.push(i);else{var i=new Walker(i),h;for(i.guard=d;h=i.next();)if((h=h.parent())&&t.test(h.nodeName())&&
!h.data("selected_cell"))h._4e_setMarker(e,"selected_cell",!0,void 0),f.push(h)}}k.Utils.clearAllMarkers(e);a.selectBookmarks(c);return f}function u(a,d){var c=a.getStartElement().parent("tr");if(c){var b=c.clone(!0);b.insertBefore(c);c=(d?b[0]:c[0]).cells;for(b=0;b<c.length;b++)c[b].innerHTML="",o.ie||(new h(c[b]))._4e_appendBogus(void 0)}}function p(a){if(a instanceof k.Selection){for(var d=s(a),c=d.length,a=[],b,f,e=0;e<c;e++){var g=d[e].parent(),i=g[0].rowIndex;!e&&(b=i-1);a[i]=g;e==c-1&&(f=i+
1)}e=g.parent("table");b=new h(f<e[0].rows.length&&e[0].rows[f]||0<b&&e[0].rows[b]||e[0].parentNode);for(e=a.length;0<=e;e--)a[e]&&p(a[e]);return b}a instanceof h&&(e=a.parent("table"),1==e[0].rows.length?e.remove():a.remove());return 0}function v(a,d){var c=a.getStartElement();if(c=c.closest("td",void 0)||c.closest("th",void 0))for(var b=c.parent("table"),f=c[0].cellIndex,e=0;e<b[0].rows.length;e++){var g=b[0].rows[e];g.cells.length<f+1||(c=new h(g.cells[f].cloneNode(void 0)),o.ie||c._4e_appendBogus(void 0),
g=new h(g.cells[f]),d?c.insertBefore(g):c.insertAfter(g))}}function w(a){if(a instanceof k.Selection){var d=s(a),c,b=[],a=d[0]&&d[0].parent("table"),f,e,g;f=0;for(e=d.length;f<e;f++)b.push(d[f][0].cellIndex);b.sort();f=1;for(e=b.length;f<e;f++)if(1<b[f]-b[f-1]){g=b[f-1]+1;break}g||(g=0<b[0]?b[0]-1:b[b.length-1]+1);b=a[0].rows;f=0;for(e=b.length;f<e&&!(c=b[f].cells[g]);f++);c=c?new h(c):a.prev();for(g=d.length-1;0<=g;g--)d[g]&&w(d[g]);return c}if(a instanceof h){d=a.parent("table");if(!d)return null;
c=a[0].cellIndex;for(g=d[0].rows.length-1;0<=g;g--)a=new h(d[0].rows[g]),!c&&1==a[0].cells.length?p(a):a[0].cells[c]&&a[0].removeChild(a[0].cells[c])}return null}function x(a,d){var c=new k.Range(a[0].ownerDocument);if(!c.moveToElementEditablePosition(a,d?!0:void 0))c.selectNodeContents(a),c.collapse(d?!1:!0);c.select(!0)}function m(a){var d=(a=a.getSelection())&&a.getStartElement(),c=d&&d.closest("table",void 0);if(c)return a=d.closest(function(a){var d=l.nodeName(a);return c.contains(a)&&("td"==
d||"th"==d)},void 0),d=d.closest(function(a){var d=l.nodeName(a);return c.contains(a)&&"tr"==d},void 0),{table:c,td:a,tr:d}}function n(a){return(a=m(a))&&a.td}function q(a){return(a=m(a))&&a.tr}var o=j.UA,l=j.DOM,h=j.Node,z=["tr","th","td","tbody","table"],t=/^(?:td|th)$/,A={"表格属性":m,"删除表格":n,"删除列":n,"删除行":q,"在上方插入行":q,"在下方插入行":q,"在左侧插入列":n,"在右侧插入列":n},B=(6===o.ie?["table.%2,","table.%2 td, table.%2 th,","{","border : #d3d3d3 1px dotted","}"]:" table.%2,; table.%2 > tr > td,  table.%2 > tr > th,; table.%2 > tbody > tr > td,  table.%2 > tbody > tr > th,; table.%2 > thead > tr > td,  table.%2 > thead > tr > th,; table.%2 > tfoot > tr > td,  table.%2 > tfoot > tr > th;{;border : #d3d3d3 1px dotted;}".split(";")).join("").replace(/%2/g,
"ke_show_border"),C={elements:{table:function(a){var a=a.attributes,d=a["class"],c=parseInt(a.border,10);if(!c||0>=c)a["class"]=(d||"")+" ke_show_border"}}},D={elements:{table:function(a){var a=a.attributes,d=a["class"];d&&(a["class"]=j.trim(d.replace("ke_show_border","")))}}};return{init:function(a){a.addCustomStyle(B);var d=a.htmlDataProcessor,c=d&&d.htmlFilter;(d&&d.dataFilter).addRules(C);c.addRules(D);y.register({editor:a,filter:function(a){if(j.inArray(l.nodeName(a),z))return!0},statusChecker:A,
width:"120px",handlers:{"表格属性":function(){var b=m(a);b&&r.useDialog(a,"table/dialog",{selectedTable:b.table,selectedTd:b.td})},"删除表格":function(){var b=a.getSelection(),c=b&&b.getStartElement();if(c=c&&c.closest("table",void 0)){b.selectElement(c);var d=b.getRanges()[0];d.collapse();b.selectRanges([d]);b=c.parent();1==b[0].childNodes.length&&"body"!=b.nodeName()&&"td"!=b.nodeName()?b.remove():c.remove()}},"删除行 ":function(){var b=a.getSelection();x(p(b),void 0)},"删除列 ":function(){var b=a.getSelection();
(b=w(b))&&x(b,!0)},"在上方插入行":function(){var b=a.getSelection();u(b,!0)},"在下方插入行":function(){var b=a.getSelection();u(b,void 0)},"在左侧插入列":function(){var b=a.getSelection();v(b,!0)},"在右侧插入列":function(){var b=a.getSelection();v(b,void 0)}}});a.addButton({contentCls:"ks-editor-toolbar-table",mode:k.WYSIWYG_MODE,title:"插入表格"},{offClick:function(){r.useDialog(a,"table/dialog",{selectedTable:0,selectedTd:0})}})}}},{requires:["editor","../dialogLoader/","../contextmenu/"]});
