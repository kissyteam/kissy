/*
Copyright 2014, KISSY v5.0.0
MIT Licensed
build time: Jun 13 11:49
*/
KISSY.add("editor/plugin/table","editor,./dialog-loader,./contextmenu,./button,util,ua,dom,node".split(","),function(q,i,J,D){function t(a){function b(a){if(!(e.length>0)&&a[0].nodeType===n.NodeType.ELEMENT_NODE&&u.test(a.nodeName())&&!a.data("selected_cell")){a._4eSetMarker(f,"selected_cell",true,void 0);e.push(a)}}for(var d=a.createBookmarks(),g=a.getRanges(),e=[],f={},c=0;c<g.length;c++){var h=g[c];if(h.collapsed){h=h.getCommonAncestor();(h=h.closest("td",void 0)||h.closest("th",void 0))&&e.push(h)}else{var h=
new E(h),k;for(h.guard=b;k=h.next();)if((k=k.parent())&&u.test(k.nodeName())&&!k.data("selected_cell")){k._4eSetMarker(f,"selected_cell",true,void 0);e.push(k)}}}l.Utils.clearAllMarkers(f);a.selectBookmarks(d);return e}function v(a,b){var d=a.getStartElement().parent("tr");if(d){var g=d.clone(true);g.insertBefore(d);d=(b?g[0]:d[0]).cells;for(g=0;g<d.length;g++){d[g].innerHTML="";w||j(d[g])._4eAppendBogus(void 0)}}}function r(a){var b;if(a instanceof l.Selection){for(var d=t(a),g=d.length,a=[],e,f,
c=0;c<g;c++){b=d[c].parent();var h=b[0].rowIndex;c||(e=h-1);a[h]=b;c===g-1&&(f=h+1)}b=b.parent("table");e=j(f<b[0].rows.length&&b[0].rows[f]||e>0&&b[0].rows[e]||b[0].parentNode);for(c=a.length;c>=0;c--)a[c]&&r(a[c]);return e}if(a instanceof j){b=a.parent("table");b[0].rows.length===1?b.remove():a.remove()}return 0}function x(a,b){var d=a.getStartElement();if(d=d.closest("td",void 0)||d.closest("th",void 0))for(var g=d.parent("table"),e=d[0].cellIndex,f=0;f<g[0].rows.length;f++){var c=g[0].rows[f];
if(!(c.cells.length<e+1)){d=j(c.cells[e].cloneNode(void 0));w||d._4eAppendBogus(void 0);c=j(c.cells[e]);b?d.insertBefore(c):d.insertAfter(c)}}}function y(a){var b;if(a instanceof l.Selection){var d=t(a),g,e=[],a=d[0]&&d[0].parent("table"),f,c;f=0;for(c=d.length;f<c;f++)e.push(d[f][0].cellIndex);e.sort();f=1;for(c=e.length;f<c;f++)if(e[f]-e[f-1]>1){b=e[f-1]+1;break}b||(b=e[0]>0?e[0]-1:e[e.length-1]+1);e=a[0].rows;f=0;for(c=e.length;f<c;f++)if(g=e[f].cells[b])break;g=g?j(g):a.prev();for(b=d.length-
1;b>=0;b--)d[b]&&y(d[b]);return g}if(a instanceof j){d=a.parent("table");if(!d)return null;g=a[0].cellIndex;for(b=d[0].rows.length-1;b>=0;b--){a=j(d[0].rows[b]);!g&&a[0].cells.length===1?r(a):a[0].cells[g]&&a[0].removeChild(a[0].cells[g])}}return null}function z(a,b){var d=new l.Range(a[0].ownerDocument);if(!d.moveToElementEditablePosition(a,b?true:void 0)){d.selectNodeContents(a);d.collapse(b?false:true)}d.select(true)}function o(a){var b=(a=a.getSelection())&&a.getStartElement(),d=b&&b.closest("table",
void 0);if(d){a=b.closest(function(a){var b=n.nodeName(a);return d.contains(a)&&(b==="td"||b==="th")},void 0);b=b.closest(function(a){var b=n.nodeName(a);return d.contains(a)&&b==="tr"},void 0);return{table:d,td:a,tr:b}}}function p(a){return(a=o(a))&&a.td}function s(a){return(a=o(a))&&a.tr}function A(a){this.config=a||{}}var l=i("editor"),E=l.Walker,B=i("./dialog-loader");i("./contextmenu");i("./button");var m=i("util"),q=i("ua"),n=i("dom"),j=i("node"),F=["tr","th","td","tbody","table"],u=/^(?:td|th)$/,
w=q.ieMode<11,C={"\u8868\u683c\u5c5e\u6027":o,"\u5220\u9664\u8868\u683c":p,"\u5220\u9664\u5217":p,"\u5220\u9664\u884c":s,"\u5728\u4e0a\u65b9\u63d2\u5165\u884c":s,"\u5728\u4e0b\u65b9\u63d2\u5165\u884c":s,"\u5728\u5de6\u4fa7\u63d2\u5165\u5217":p,"\u5728\u53f3\u4fa7\u63d2\u5165\u5217":p},G=(q.ie===6?["table.%2,","table.%2 td, table.%2 th,","{","border : #d3d3d3 1px dotted","}"]:[" table.%2,"," table.%2 > tr > td,  table.%2 > tr > th,"," table.%2 > tbody > tr > td,  table.%2 > tbody > tr > th,"," table.%2 > thead > tr > td,  table.%2 > thead > tr > th,"," table.%2 > tfoot > tr > td,  table.%2 > tfoot > tr > th","{","border : #d3d3d3 1px dotted","}"]).join("").replace(/%2/g,"ke_show_border"),
H={tags:{table:function(a){var b=a.getAttribute("class"),d=parseInt(a.getAttribute("border"),10);if(!d||d<=0)a.setAttribute("class",m.trim((b||"")+" ke_show_border"))}}},I={tags:{table:function(a){var b=a.getAttribute("class");if(b)(b=m.trim(b.replace("ke_show_border","")))?a.setAttribute("class",b):a.removeAttribute("class")}}};m.augment(A,{pluginRenderUI:function(a){a.addCustomStyle(G);var b=a.htmlDataProcessor,d=b&&b.htmlFilter;(b&&b.dataFilter).addRules(H);d.addRules(I);var g=this,e={"\u8868\u683c\u5c5e\u6027":function(){this.hide();
var c=o(a);c&&B.useDialog(a,"table",g.config,{selectedTable:c.table,selectedTd:c.td})},"\u5220\u9664\u8868\u683c":function(){this.hide();var c=a.getSelection(),b=c&&c.getStartElement();if(b=b&&b.closest("table",void 0)){a.execCommand("save");c.selectElement(b);var d=c.getRanges()[0];d.collapse();c.selectRanges([d]);c=b.parent();c[0].childNodes.length===1&&c.nodeName()!=="body"&&c.nodeName()!=="td"?c.remove():b.remove();a.execCommand("save")}},"\u5220\u9664\u884c ":function(){this.hide();a.execCommand("save");var c=a.getSelection();
z(r(c),void 0);a.execCommand("save")},"\u5220\u9664\u5217 ":function(){this.hide();a.execCommand("save");var c=a.getSelection();(c=y(c))&&z(c,true);a.execCommand("save")},"\u5728\u4e0a\u65b9\u63d2\u5165\u884c":function(){this.hide();a.execCommand("save");var c=a.getSelection();v(c,true);a.execCommand("save")},"\u5728\u4e0b\u65b9\u63d2\u5165\u884c":function(){this.hide();a.execCommand("save");var c=a.getSelection();v(c,void 0);a.execCommand("save")},"\u5728\u5de6\u4fa7\u63d2\u5165\u5217":function(){this.hide();a.execCommand("save");var c=a.getSelection();x(c,true);a.execCommand("save")},"\u5728\u53f3\u4fa7\u63d2\u5165\u5217":function(){this.hide();
a.execCommand("save");var c=a.getSelection();x(c,void 0);a.execCommand("save")}},f=[];m.each(e,function(a,b){f.push({content:b})});a.addContextMenu("table",function(a){if(m.inArray(n.nodeName(a),F))return true},{width:"120px",children:f,listeners:{click:function(a){a=a.target.get("content");e[a]&&e[a].apply(this)},beforeVisibleChange:function(a){if(a.newVal){var b=this,a=b.get("children"),d=b.get("editor");m.each(a,function(a){var c=a.get("content");!C[c]||C[c].call(b,d)?a.set("disabled",false):a.set("disabled",
true)})}}}});a.addButton("table",{mode:l.Mode.WYSIWYG_MODE,listeners:{click:function(){B.useDialog(a,"table",g.config,{selectedTable:0,selectedTd:0})}},tooltip:"\u63d2\u5165\u8868\u683c"})}});D.exports=A});
