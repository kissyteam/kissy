/*
Copyright 2013, KISSY UI Library v1.40dev
MIT Licensed
build time: Jun 5 22:37
*/
KISSY.add("mvc/model",function(d,i){function h(){h.superclass.constructor.apply(this,arguments);this.collections={}}var f="idAttribute,clientId,urlRoot,url,parse,sync".split(",");d.extend(h,i,{addToCollection:function(a){this.collections[d.stamp(a)]=a;this.addTarget(a)},removeFromCollection:function(a){delete this.collections[d.stamp(a)];this.removeTarget(a)},getId:function(){return this.get(this.get("idAttribute"))},setId:function(a){return this.set(this.get("idAttribute"),a)},setInternal:function(){this.__isModified=
1;return h.superclass.setInternal.apply(this,arguments)},isNew:function(){return!this.getId()},isModified:function(){return!(!this.isNew()&&!this.__isModified)},destroy:function(a){var b=this,a=a||{},c=a.success;a.success=function(e){var g=b.collections;if(e){var d=b.get("parse").call(b,e);d&&b.set(d,a)}for(var f in g)g[f].remove(b,a);b.fire("destroy");c&&c.apply(this,arguments)};!b.isNew()&&a["delete"]?b.get("sync").call(b,b,"delete",a):(a.success(),a.complete&&a.complete());return b},load:function(a){var b=
this,a=a||{},c=a.success;a.success=function(e){if(e){var g=b.get("parse").call(b,e);g&&b.set(g,a)}b.__isModified=0;c&&c.apply(this,arguments)};b.get("sync").call(b,b,"read",a);return b},save:function(a){var b=this,a=a||{},c=a.success;a.success=function(e){if(e){var g=b.get("parse").call(b,e);g&&b.set(g,a)}b.__isModified=0;c&&c.apply(this,arguments)};b.get("sync").call(b,b,b.isNew()?"create":"update",a);return b},toJSON:function(){var a=this.getAttrVals();d.each(f,function(b){delete a[b]});return a}},
{ATTRS:{idAttribute:{value:"id"},clientId:{valueFn:function(){return d.guid("mvc-client")}},url:{value:function(){var a,b,c=this.collections;for(a in c)if(c.hasOwnProperty(a)){b=c[a];break}a=b;var e;a=(a&&(e=a.get("url"))?"string"==typeof e?e:e.call(a):e)||this.get("urlRoot");if(this.isNew())return a;a+="/"==a.charAt(a.length-1)?"":"/";return a+encodeURIComponent(this.getId())+"/"}},urlRoot:{value:""},sync:{value:function(){d.require("mvc").sync.apply(this,arguments)}},parse:{value:function(a){return a}}}});
return h},{requires:["base"]});
KISSY.add("mvc/collection",function(d,i,h){function f(){f.superclass.constructor.apply(this,arguments)}f.ATTRS={model:{value:i},models:{setter:function(a){this.remove(this.get("models"),{silent:1});this.add(a,{silent:1});return this.get("models")},value:[]},url:{value:""},comparator:{},sync:{value:function(){d.require("mvc").sync.apply(this,arguments)}},parse:{value:function(a){return a}}};d.extend(f,h,{sort:function(){var a=this.get("comparator");a&&this.get("models").sort(function(b,c){return a(b)-
a(c)})},toJSON:function(){return d.map(this.get("models"),function(a){return a.toJSON()})},add:function(a,b){var c=this,e=!0;if(d.isArray(a)){var g=[].concat(a);d.each(g,function(a){a=c._add(a,b);e=e&&a})}else e=c._add(a,b);return e},remove:function(a,b){var c=this;if(d.isArray(a)){var e=[].concat(a);d.each(e,function(a){c._remove(a,b)})}else a&&c._remove(a,b)},at:function(a){return this.get("models")[a]},_normModel:function(a){var b=!0;a instanceof i||(b=a,a=new (this.get("model")),b=a.set(b,{silent:1}));
return b&&a},load:function(a){var b=this,a=a||{},c=a.success;a.success=function(e){if(e){var g=b.get("parse").call(b,e);g&&b.set("models",g,a)}d.each(b.get("models"),function(a){a.__isModified=0});c&&c.apply(this,arguments)};b.get("sync").call(b,b,"read",a);return b},create:function(a,b){var c=this,b=b||{};if(a=this._normModel(a)){a.addToCollection(c);var e=b.success;b.success=function(){c.add(a,b);e&&e()};a.save(b)}return a},_add:function(a,b){if(a=this._normModel(a)){var b=b||{},c=this.get("models"),
e=this.get("comparator"),g=c.length;if(e)for(var d=e(a),g=0;g<c.length;g++){var f=e(c[g]);if(d<f)break}this.get("models").splice(g,0,a);a.addToCollection(this);b.silent||this.fire("add",{model:a})}return a},_remove:function(a,b){var b=b||{},c=d.indexOf(a,this.get("models"));-1!=c&&(this.get("models").splice(c,1),a.removeFromCollection(this));b.silent||this.fire("remove",{model:a})},getById:function(a){for(var b=this.get("models"),c=0;c<b.length;c++){var e=b[c];if(e.getId()===a)return e}return null},
getByCid:function(a){for(var b=this.get("models"),c=0;c<b.length;c++){var e=b[c];if(e.get("clientId")===a)return e}return null}});return f},{requires:["./model","base"]});
KISSY.add("mvc/view",function(d,i,h){function f(){f.superclass.constructor.apply(this,arguments);var a;(a=this.get("events"))&&this._afterEventsChange({newVal:a})}var a=i.all;f.ATTRS={el:{value:"<div />",getter:function(b){"string"==typeof b&&(b=a(b),this.setInternal("el",b));return b}},events:{}};d.extend(f,h,{_afterEventsChange:function(a){var c=a.prevVal;c&&this._removeEvents(c);this._addEvents(a.newVal)},_removeEvents:function(a){var c=this.get("el"),e;for(e in a){var d=a[e],f;for(f in d)c.undelegate(f,
e,"string"==typeof d[f]?this[d[f]]:d[f],this)}},_addEvents:function(a){var c=this.get("el"),e;for(e in a){var d=a[e],f;for(f in d)c.delegate(f,e,"string"==typeof d[f]?this[d[f]]:d[f],this)}},render:function(){return this},destroy:function(){this.get("el").remove()}});return f},{requires:["node","base"]});
KISSY.add("mvc/router",function(d,i,h){function f(a){var b,c;for(c=0;c<a.length;c++)if(b=a.charAt(c),"\\"==b)c++;else if("("==b)return c;throw Error("impossible to not to get capture group in kissy mvc route");}function a(a){a=a||location.href;if(j.nativeHistory&&n){var a=new d.Uri(a),b=a.getQuery().toString();return a.getPath().substr(j.urlRoot.length)+(b?"?"+b:"")}return(new d.Uri(a)).getFragment().replace(/^!/,"")}function b(a){d.endsWith(a,"/")&&(a=a.substring(0,a.length-1));return a}function c(a){a&&
(d.startsWith(a,"/")&&(a=a.substring(1)),a="/"+a);return a}function e(a,c){a=b(a);c=b(c);return a==c}function g(){var b,c,e=0,g=-1,h="",j=-1,i=0,t="";b=new d.Uri(a());var s=0;c=b.clone();c.query.reset();c=c.toString();l(p,function(a){var b=0;l(a[k],function(d){var r=d.regStr,n=d.paramNames,k=-1,m,o=d.name,p=d.callback;if(m=c.match(d.reg)){m.shift();var q=function(){if(n){var a={};l(m,function(b,c){a[n[c]]=b});return a}return[].concat(m)},d=function(){h=r;j=k;i=p;s=q();e=a;t=o;g=m.length};if(m.length)if(r)k=
f(r),k>j?d():k==j&&g>=m.length?m.length<g?d():r.length>h.length&&d():e||d();else return d(),b=1,!1;else return d(),b=1,!1}});if(b)return!1});s&&(b=b.query.get(),i.apply(e,[s,b,{path:c,url:location.href}]),b={name:t,paths:s,path:c,url:location.href,query:b},e.fire("route:"+t,b),e.fire("route",b))}function x(a,b,c){var e=b,g=[];return d.isFunction(c)?(b=d.escapeRegExp(b),b=b.replace(y,function(a,b,c,d,e){g.push(c||e);if(c)return"([^/]+)";if(e)return"(.*)"}),{name:e,paramNames:g,reg:RegExp("^"+b+"$"),
regStr:b,callback:c}):{name:e,reg:c.reg,callback:!d.isFunction(c.callback)&&"string"==typeof c.callback?a[c.callback]:c.callback}}function u(a){this[k]={};this.addRoutes(a.newVal)}function j(){j.superclass.constructor.apply(this,arguments);this.on("afterRoutesChange",u,this);u.call(this,{newVal:this.get("routes")});p.push(this)}var l=d.each,y=/(:([\w\d]+))|(\\\*([\w\d]+))/g,p=[],q=d.Env.host,v=$(q),w=q.document.documentMode||d.UA.ie,o=q.history,n=!(!o||!o.pushState),k="__routerMap";j.ATTRS={routes:{}};
d.extend(j,h,{addRoutes:function(a){var b=this;l(a,function(a,c){b[k][c]=x(b,c,!d.isFunction(a)&&"string"==typeof a?b[a]:a)})}},{hasRoute:function(a){var b=0;l(p,function(c){l(c[k],function(c){if(a.match(c.reg))return b=1,!1});if(b)return!1});return!!b},removeRoot:function(a){return(new d.Uri(a)).getPath().substr(j.urlRoot.length)},navigate:function(d,e){var e=e||{},f=e.replaceHistory,h;a()!==d?j.nativeHistory&&n?(o[f?"replaceState":"pushState"]({},"",location.protocol+"//"+location.host+b(j.urlRoot)+
c(d)),g()):(h="#!"+d,f?location.replace(h+(w&&8>w?i.REPLACE_HISTORY:"")):location.hash=h):e&&e.triggerRoute&&g()},start:function(d){d=d||{};if(j.__started)return d.success&&d.success();d.urlRoot=(d.urlRoot||"").replace(/\/$/,"");var f,h=d.nativeHistory,i=location.pathname,k=a(),l=location.hash.match(/#!.+/);f=j.urlRoot=d.urlRoot;if(j.nativeHistory=h)if(n)l&&e(i,f)&&(o.replaceState({},"",location.protocol+"//"+location.host+b(j.urlRoot)+c(k)),d.triggerRoute=1);else if(!e(i,f)){location.replace(b(f)+
"/#!"+k);return}setTimeout(function(){if(h&&n)v.on("popstate",g);else v.on("hashchange",g),d.triggerRoute=1;d.triggerRoute&&g();d.success&&d.success()},100);j.__started=1}});return j},{requires:["node","base"]});
KISSY.add("mvc/sync",function(d,i,h){var f={create:"POST",update:"POST","delete":"POST",read:"GET"};return function(a,b,c){var c=d.merge({type:f[b],dataType:"json"},c),e,g;e=c.data=c.data||{};e._method=b;c.url||(g=a.get("url"),c.url="string"==typeof g?g:g.call(a));if("create"==b||"update"==b)e.model=h.stringify(a.toJSON());return i(c)}},{requires:["io","json"]});
KISSY.add("mvc",function(d,i,h,f,a,b){return{sync:b,Model:i,View:f,Collection:h,Router:a}},{requires:["mvc/model","mvc/collection","mvc/view","mvc/router","mvc/sync"]});
