/*
Copyright 2012, KISSY UI Library v1.30dev
MIT Licensed
build time: May 15 20:45
*/
KISSY.add("mvc/base",function(c,h){return{sync:h}},{requires:["./sync"]});
KISSY.add("mvc/collection",function(c,h,i,g,f){function a(){a.superclass.constructor.apply(this,arguments)}a.ATTRS={model:{value:i},models:{setter:function(b){this.remove(this.get("models"),{silent:1});this.add(b,{silent:1});return this.get("models")},value:[]},url:{value:c.noop},comparator:{},sync:{value:function(){g.sync.apply(this,arguments)}},parse:{value:function(b){return b}}};c.extend(a,f,{sort:function(){var b=this.get("comparator");b&&this.get("models").sort(function(a,d){return b(a)-b(d)})},
toJSON:function(){return c.map(this.get("models"),function(b){return b.toJSON()})},add:function(b,a){var d=this,e=!0;if(c.isArray(b)){var m=[].concat(b);c.each(m,function(b){b=d._add(b,a);e=e&&b})}else e=d._add(b,a);return e},remove:function(b,a){var d=this;if(c.isArray(b)){var e=[].concat(b);c.each(e,function(b){d._remove(b,a)})}else b&&d._remove(b,a)},at:function(b){return this.get("models")[b]},_normModel:function(b){var a=!0;b instanceof i||(a=b,b=new (this.get("model")),a=b.set(a,{silent:1}));
return a&&b},load:function(b){var a=this,b=b||{},d=b.success;b.success=function(e){if(e){var c=a.get("parse").call(a,e);c&&a.set("models",c,b)}d&&d.apply(this,arguments)};a.get("sync").call(a,a,"read",b);return a},create:function(b,a){var d=this,a=a||{};if(b=this._normModel(b)){b.addToCollection(d);var e=a.success;a.success=function(){d.add(b,a);e&&e()};b.save(a)}return b},_add:function(a,c){if(a=this._normModel(a)){var c=c||{},d=this.get("models"),e=this.get("comparator"),g=d.length;if(e)for(var f=
e(a),g=0;g<d.length;g++){var h=e(d[g]);if(f<h)break}this.get("models").splice(g,0,a);a.addToCollection(this);c.silent||this.fire("add",{model:a})}return a},_remove:function(a,l){var l=l||{},d=c.indexOf(a,this.get("models"));-1!=d&&(this.get("models").splice(d,1),a.removeFromCollection(this));l.silent||this.fire("remove",{model:a})},getById:function(a){for(var c=this.get("models"),d=0;d<c.length;d++){var e=c[d];if(e.getId()===a)return e}return null},getByCid:function(a){for(var c=this.get("models"),
d=0;d<c.length;d++){var e=c[d];if(e.get("clientId")===a)return e}return null}});return a},{requires:["event","./model","./base","base"]});
KISSY.add("mvc/model",function(c,h,i){function g(){g.superclass.constructor.apply(this,arguments);this.publish("*Change",{bubbles:1});this.collections={}}var f="idAttribute,clientId,urlRoot,url,parse,sync".split(",");c.extend(g,h,{addToCollection:function(a){this.collections[c.stamp(a)]=a;this.addTarget(a)},removeFromCollection:function(a){delete this.collections[c.stamp(a)];this.removeTarget(a)},getId:function(){return this.get(this.get("idAttribute"))},setId:function(a){return this.set(this.get("idAttribute"),
a)},__set:function(){this.__isModified=1;return g.superclass.__set.apply(this,arguments)},isNew:function(){return!this.getId()},isModified:function(){return!(!this.isNew()&&!this.__isModified)},destroy:function(a){var b=this,a=a||{},c=a.success;a.success=function(d){var e=b.collections;if(d){var g=b.get("parse").call(b,d);g&&b.set(g,a)}for(var f in e)e[f].remove(b,a),b.removeFromCollection(e[f]);b.fire("destroy");c&&c.apply(this,arguments)};!b.isNew()&&a["delete"]?b.get("sync").call(b,b,"delete",
a):(a.success(),a.complete&&a.complete());return b},load:function(a){var b=this,a=a||{},c=a.success;a.success=function(d){if(d){var e=b.get("parse").call(b,d);e&&b.set(e,a)}b.__isModified=0;c&&c.apply(this,arguments)};b.get("sync").call(b,b,"read",a);return b},save:function(a){var b=this,a=a||{},c=a.success;a.success=function(d){if(d){var e=b.get("parse").call(b,d);e&&b.set(e,a)}b.__isModified=0;c&&c.apply(this,arguments)};b.get("sync").call(b,b,b.isNew()?"create":"update",a);return b},toJSON:function(){var a=
this.getAttrVals();c.each(f,function(b){delete a[b]});return a}},{ATTRS:{idAttribute:{value:"id"},clientId:{valueFn:function(){return c.guid("mvc-client")}},url:{value:function(){var a,b,g=this.collections;for(a in g)if(g.hasOwnProperty(a)){b=g[a];break}a=b;var d;a=(a&&(d=a.get("url"))?c.isString(d)?d:d.call(a):d)||this.get("urlRoot");if(this.isNew())return a;a+="/"==a.charAt(a.length-1)?"":"/";return a+encodeURIComponent(this.getId())+"/"}},urlRoot:{value:""},sync:{value:function(){i.sync.apply(this,
arguments)}},parse:{value:function(a){return a}}}});return g},{requires:["base","./base"]});KISSY.add("mvc",function(c,h,i,g,f,a){return c.mix(h,{Model:i,View:f,Collection:g,Router:a})},{requires:["mvc/base","mvc/model","mvc/collection","mvc/view","mvc/router"]});
KISSY.add("mvc/router",function(c,h,i){function g(a){var b,c;for(c=0;c<a.length;c++)if(b=a.charAt(c),"\\"==b)c++;else if("("==b)return c;throw Error("impossible to not to get capture group in kissy mvc route");}function f(){return j.nativeHistory&&o?k.pathname.substr(j.urlRoot.length)+k.search:k.href.replace(/^[^#]*#?!?(.*)$/,"$1")}function a(a){c.endsWith(a,"/")&&(a=a.substring(0,a.length-1));return a}function b(a){c.startsWith(a,"/")&&(a=a.substring(1));return a}function l(b,c){b=a(b);c=a(c);return b==
c}function d(a){var b,d={};return(b=a.match(v))?c.unparam(b[1]):d}function e(){var a=f(),b=a,c=0,e=-1,l="",h=-1,i=0,j=0,a=b.replace(v,"");p(w,function(b){var d=0;p(b[t],function(f){var r=f.regStr,k=f.paramNames,m=-1,n,o=f.callback;if(n=a.match(f.reg)){n.shift();var q=function(){if(k){var a={};p(n,function(b,c){a[k[c]]=b});return a}return[].concat(n)},f=function(){l=r;h=m;i=o;j=q();c=b;e=n.length};if(n.length)r?(m=g(r),m>h?f():m==h&&e>=n.length?n.length<e?f():r.length>l.length&&f():c||f()):f();else return f(),
d=1,!1}});if(d)return!1});j&&(b=d(b),i.apply(c,[j,b]),b={name:name,paths:j,query:b},c.fire("route:"+name,b),c.fire("route",b))}function m(a,b,d){var e=b,f=[];return c.isFunction(d)?(b=c.escapeRegExp(b),b=b.replace(x,function(a,b,c,d,e){f.push(c||e);if(c)return"([^/]+)";if(e)return"(.*)"}),{name:e,paramNames:f,reg:RegExp("^"+b+"$"),regStr:b,callback:d}):{name:e,reg:d.reg,callback:!c.isFunction(d.callback)&&c.isString(d.callback)?a[d.callback]:d.callback}}function u(a){this[t]={};this.addRoutes(a.newVal)}
function j(){j.superclass.constructor.apply(this,arguments);this.on("afterRoutesChange",u,this);u.call(this,{newVal:this.get("routes")});w.push(this)}var v=/\?(.*)/,p=c.each,x=/(:([\w\d]+))|(\\\*([\w\d]+))/g,w=[],q=c.Env.host,k=q.location,s=q.history,o=!(!s||!s.pushState),t="__routerMap";j.ATTRS={routes:{}};c.extend(j,i,{addRoutes:function(a){var b=this;p(a,function(a,d){b[t][d]=m(b,d,!c.isFunction(a)&&c.isString(a)?b[a]:a)})}},{navigate:function(c,d){f()!==c?j.nativeHistory&&o?(s.pushState({},"",
k.protocol+"//"+k.host+a(j.urlRoot)+("/"+b(c))),e()):k.hash="!"+c:d&&d.triggerRoute&&e()},start:function(c){c=c||{};c.urlRoot=c.urlRoot||"";var d,g=c.nativeHistory,i=k.pathname,m=f(),p=k.hash.match(/#!.+/);d=j.urlRoot=c.urlRoot;if(j.nativeHistory=g)if(o)p&&l(i,d)&&(s.replaceState({},"",k.protocol+"//"+k.host+a(j.urlRoot)+("/"+b(m))),c.triggerRoute=1);else if(!l(i,d)){k.replace(a(d)+"/#!"+m);return}setTimeout(function(){if(g&&o)h.on(q,"popstate",e);else h.on(q,"hashchange",e),c.triggerRoute=1;c.triggerRoute&&
e();c.success&&c.success()},100)}});return j},{requires:["event","base"]});KISSY.add("mvc/sync",function(c,h,i){var g={create:"POST",update:"POST","delete":"POST",read:"GET"};return function(f,a,b){var b=c.merge({type:g[a],dataType:"json"},b),l=b.data=b.data||{};l._method=a;b.url||(b.url=c.isString(f.get("url"))?f.get("url"):f.get("url").call(f));if("create"==a||"update"==a)l.model=i.stringify(f.toJSON());return h(b)}},{requires:["ajax","json"]});
KISSY.add("mvc/view",function(c,h,i){function g(){g.superclass.constructor.apply(this,arguments);var a;(a=this.get("events"))&&this._afterEventsChange({newVal:a})}var f=h.all;g.ATTRS={el:{value:"<div />",getter:function(a){c.isString(a)&&(a=f(a),this.__set("el",a));return a}},events:{}};c.extend(g,i,{_afterEventsChange:function(a){var b=a.prevVal;b&&this._removeEvents(b);this._addEvents(a.newVal)},_removeEvents:function(a){var b=this.get("el"),f;for(f in a){var d=a[f],e;for(e in d){var g=c.isString(d[e])?
this[d[e]]:d[e];b.undelegate(e,f,g,this)}}},_addEvents:function(a){var b=this.get("el"),f;for(f in a){var d=a[f],e;for(e in d){var g=c.isString(d[e])?this[d[e]]:d[e];b.delegate(e,f,g,this)}}},render:function(){return this},destroy:function(){this.get("el").remove()}});return g},{requires:["node","base"]});
