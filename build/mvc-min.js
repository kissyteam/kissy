/*
Copyright 2012, KISSY UI Library v1.40dev
MIT Licensed
build time: Sep 26 13:42
*/
KISSY.add("mvc/collection",function(c,k,f,j){function b(){b.superclass.constructor.apply(this,arguments)}b.ATTRS={model:{value:f},models:{setter:function(a){this.remove(this.get("models"),{silent:1});this.add(a,{silent:1});return this.get("models")},value:[]},url:{value:""},comparator:{},sync:{value:function(){c.require("mvc").sync.apply(this,arguments)}},parse:{value:function(a){return a}}};c.extend(b,j,{sort:function(){var a=this.get("comparator");a&&this.get("models").sort(function(b,d){return a(b)-
a(d)})},toJSON:function(){return c.map(this.get("models"),function(a){return a.toJSON()})},add:function(a,b){var d=this,e=!0;if(c.isArray(a)){var g=[].concat(a);c.each(g,function(a){a=d._add(a,b);e=e&&a})}else e=d._add(a,b);return e},remove:function(a,b){var d=this;if(c.isArray(a)){var e=[].concat(a);c.each(e,function(a){d._remove(a,b)})}else a&&d._remove(a,b)},at:function(a){return this.get("models")[a]},_normModel:function(a){var b=!0;a instanceof f||(b=a,a=new (this.get("model")),b=a.set(b,{silent:1}));
return b&&a},load:function(a){var b=this,a=a||{},d=a.success;a.success=function(e){if(e){var g=b.get("parse").call(b,e);g&&b.set("models",g,a)}c.each(b.get("models"),function(a){a.__isModified=0});d&&d.apply(this,arguments)};b.get("sync").call(b,b,"read",a);return b},create:function(a,b){var d=this,b=b||{};if(a=this._normModel(a)){a.addToCollection(d);var e=b.success;b.success=function(){d.add(a,b);e&&e()};a.save(b)}return a},_add:function(a,b){if(a=this._normModel(a)){var b=b||{},d=this.get("models"),
e=this.get("comparator"),c=d.length;if(e)for(var f=e(a),c=0;c<d.length;c++){var i=e(d[c]);if(f<i)break}this.get("models").splice(c,0,a);a.addToCollection(this);b.silent||this.fire("add",{model:a})}return a},_remove:function(a,b){var b=b||{},d=c.indexOf(a,this.get("models"));-1!=d&&(this.get("models").splice(d,1),a.removeFromCollection(this));b.silent||this.fire("remove",{model:a})},getById:function(a){for(var b=this.get("models"),d=0;d<b.length;d++){var c=b[d];if(c.getId()===a)return c}return null},
getByCid:function(a){for(var b=this.get("models"),d=0;d<b.length;d++){var c=b[d];if(c.get("clientId")===a)return c}return null}});return b},{requires:["event","./model","base"]});
KISSY.add("mvc/model",function(c,k){function f(){f.superclass.constructor.apply(this,arguments);this.publish("*Change",{bubbles:1});this.collections={}}var j="idAttribute,clientId,urlRoot,url,parse,sync".split(",");c.extend(f,k,{addToCollection:function(b){this.collections[c.stamp(b)]=b;this.addTarget(b)},removeFromCollection:function(b){delete this.collections[c.stamp(b)];this.removeTarget(b)},getId:function(){return this.get(this.get("idAttribute"))},setId:function(b){return this.set(this.get("idAttribute"),
b)},setInternal:function(){this.__isModified=1;return f.superclass.setInternal.apply(this,arguments)},isNew:function(){return!this.getId()},isModified:function(){return!(!this.isNew()&&!this.__isModified)},destroy:function(b){var a=this,b=b||{},c=b.success;b.success=function(d){var e=a.collections;if(d){var g=a.get("parse").call(a,d);g&&a.set(g,b)}for(var f in e)e[f].remove(a,b),a.removeFromCollection(e[f]);a.fire("destroy");c&&c.apply(this,arguments)};!a.isNew()&&b["delete"]?a.get("sync").call(a,
a,"delete",b):(b.success(),b.complete&&b.complete());return a},load:function(b){var a=this,b=b||{},c=b.success;b.success=function(d){if(d){var e=a.get("parse").call(a,d);e&&a.set(e,b)}a.__isModified=0;c&&c.apply(this,arguments)};a.get("sync").call(a,a,"read",b);return a},save:function(b){var a=this,b=b||{},c=b.success;b.success=function(d){if(d){var e=a.get("parse").call(a,d);e&&a.set(e,b)}a.__isModified=0;c&&c.apply(this,arguments)};a.get("sync").call(a,a,a.isNew()?"create":"update",b);return a},
toJSON:function(){var b=this.getAttrVals();c.each(j,function(a){delete b[a]});return b}},{ATTRS:{idAttribute:{value:"id"},clientId:{valueFn:function(){return c.guid("mvc-client")}},url:{value:function(){var b,a,h=this.collections;for(b in h)if(h.hasOwnProperty(b)){a=h[b];break}b=a;var d;b=(b&&(d=b.get("url"))?c.isString(d)?d:d.call(b):d)||this.get("urlRoot");if(this.isNew())return b;b+="/"==b.charAt(b.length-1)?"":"/";return b+encodeURIComponent(this.getId())+"/"}},urlRoot:{value:""},sync:{value:function(){c.require("mvc").sync.apply(this,
arguments)}},parse:{value:function(b){return b}}}});return f},{requires:["base"]});KISSY.add("mvc",function(c,k,f,j,b,a){return{sync:a,Model:k,View:j,Collection:f,Router:b}},{requires:["mvc/model","mvc/collection","mvc/view","mvc/router","mvc/sync"]});
KISSY.add("mvc/router",function(c,k,f){function j(a){var b,c;for(c=0;c<a.length;c++)if(b=a.charAt(c),"\\"==b)c++;else if("("==b)return c;throw Error("impossible to not to get capture group in kissy mvc route");}function b(a){a=a||location.href;if(i.nativeHistory&&o){var a=new c.Uri(a),b=a.getQuery().toString();return a.getPath().substr(i.urlRoot.length)+(b?"?"+b:"")}return(new c.Uri(a)).getFragment().replace(/^!/,"")}function a(a){c.endsWith(a,"/")&&(a=a.substring(0,a.length-1));return a}function h(a){c.startsWith(a,
"/")&&(a=a.substring(1));return"/"+a}function d(b,c){b=a(b);c=a(c);return b==c}function e(){var a,d,e=0,h=-1,g="",f=-1,i=0,k="";a=new c.Uri(b());var m=0;d=a.clone();d.query.reset();d=d.toString();p(s,function(a){var b=0;p(a[l],function(c){var t=c.regStr,o=c.paramNames,l=-1,n,q=c.name,r=c.callback;if(n=d.match(c.reg)){n.shift();var s=function(){if(o){var a={};p(n,function(b,c){a[o[c]]=b});return a}return[].concat(n)},c=function(){g=t;f=l;i=r;m=s();e=a;k=q;h=n.length};if(n.length)if(t)l=j(t),l>f?c():
l==f&&h>=n.length?n.length<h?c():t.length>g.length&&c():e||c();else return c(),b=1,!1;else return c(),b=1,!1}});if(b)return!1});m&&(a=a.query.get(),i.apply(e,[m,a,{path:d,url:location.href}]),a={name:k,paths:m,path:d,url:location.href,query:a},e.fire("route:"+k,a),e.fire("route",a))}function g(a,b,d){var e=b,h=[];return c.isFunction(d)?(b=c.escapeRegExp(b),b=b.replace(v,function(a,b,c,d,e){h.push(c||e);if(c)return"([^/]+)";if(e)return"(.*)"}),{name:e,paramNames:h,reg:RegExp("^"+b+"$"),regStr:b,callback:d}):
{name:e,reg:d.reg,callback:!c.isFunction(d.callback)&&c.isString(d.callback)?a[d.callback]:d.callback}}function m(a){this[l]={};this.addRoutes(a.newVal)}function i(){i.superclass.constructor.apply(this,arguments);this.on("afterRoutesChange",m,this);m.call(this,{newVal:this.get("routes")});s.push(this)}var p=c.each,v=/(:([\w\d]+))|(\\\*([\w\d]+))/g,s=[],q=c.Env.host,u=q.document.documentMode||c.UA.ie,r=q.history,o=!(!r||!r.pushState),l="__routerMap";i.ATTRS={routes:{}};c.extend(i,f,{addRoutes:function(a){var b=
this;p(a,function(a,d){b[l][d]=g(b,d,!c.isFunction(a)&&c.isString(a)?b[a]:a)})}},{hasRoute:function(a){var b=0;p(s,function(c){p(c[l],function(c){if(a.match(c.reg))return b=1,!1});if(b)return!1});return!!b},removeRoot:function(a){return(new c.Uri(a)).getPath().substr(i.urlRoot.length)},navigate:function(c,d){var d=d||{},f=d.replaceHistory,g;b()!==c?i.nativeHistory&&o?(r[f?"replaceState":"pushState"]({},"",location.protocol+"//"+location.host+a(i.urlRoot)+h(c)),e()):(g="#!"+c,f?location.replace(g+
(u&&8>u?k.REPLACE_HISTORY:"")):location.hash=g):d&&d.triggerRoute&&e()},start:function(c){c=c||{};if(i.__started)return c.success&&c.success();c.urlRoot=(c.urlRoot||"").replace(/\/$/,"");var g,f=c.nativeHistory,j=location.pathname,m=b(),l=location.hash.match(/#!.+/);g=i.urlRoot=c.urlRoot;if(i.nativeHistory=f)if(o)l&&d(j,g)&&(r.replaceState({},"",location.protocol+"//"+location.host+a(i.urlRoot)+h(m)),c.triggerRoute=1);else if(!d(j,g)){location.replace(a(g)+"/#!"+m);return}setTimeout(function(){if(f&&
o)k.on(q,"popstate",e);else k.on(q,"hashchange",e),c.triggerRoute=1;c.triggerRoute&&e();c.success&&c.success()},100);i.__started=1}});return i},{requires:["event","base"]});
KISSY.add("mvc/sync",function(c,k,f){var j={create:"POST",update:"POST","delete":"POST",read:"GET"};return function(b,a,h){var h=c.merge({type:j[a],dataType:"json"},h),d=h.data=h.data||{};d._method=a;h.url||(h.url=c.isString(b.get("url"))?b.get("url"):b.get("url").call(b));if("create"==a||"update"==a)d.model=f.stringify(b.toJSON());return k(h)}},{requires:["ajax","json"]});
KISSY.add("mvc/view",function(c,k,f){function j(){j.superclass.constructor.apply(this,arguments);var a;(a=this.get("events"))&&this._afterEventsChange({newVal:a})}var b=k.all;j.ATTRS={el:{value:"<div />",getter:function(a){c.isString(a)&&(a=b(a),this.setInternal("el",a));return a}},events:{}};c.extend(j,f,{_afterEventsChange:function(a){var b=a.prevVal;b&&this._removeEvents(b);this._addEvents(a.newVal)},_removeEvents:function(a){var b=this.get("el"),d;for(d in a){var e=a[d],g;for(g in e){var f=c.isString(e[g])?
this[e[g]]:e[g];b.undelegate(g,d,f,this)}}},_addEvents:function(a){var b=this.get("el"),d;for(d in a){var e=a[d],g;for(g in e){var f=c.isString(e[g])?this[e[g]]:e[g];b.delegate(g,d,f,this)}}},render:function(){return this},destroy:function(){this.get("el").remove()}});return j},{requires:["node","base"]});
