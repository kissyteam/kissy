/*
Copyright 2013, KISSY UI Library v1.40dev
MIT Licensed
build time: Jul 3 13:57
*/
KISSY.add("mvc/model",function(d,i){function h(){h.superclass.constructor.apply(this,arguments);this.collections={}}var g="idAttribute,clientId,urlRoot,url,parse,sync".split(",");d.extend(h,i,{addToCollection:function(a){this.collections[d.stamp(a)]=a;this.addTarget(a)},removeFromCollection:function(a){delete this.collections[d.stamp(a)];this.removeTarget(a)},getId:function(){return this.get(this.get("idAttribute"))},setId:function(a){return this.set(this.get("idAttribute"),a)},setInternal:function(){this.__isModified=
1;return h.superclass.setInternal.apply(this,arguments)},isNew:function(){return!this.getId()},isModified:function(){return!(!this.isNew()&&!this.__isModified)},destroy:function(a){var b=this,a=a||{},c=a.success;a.success=function(e){var f=b.collections;if(e){var d=b.get("parse").call(b,e);d&&b.set(d,a)}for(var g in f)f[g].remove(b,a);b.fire("destroy");c&&c.apply(this,arguments)};!b.isNew()&&a["delete"]?b.get("sync").call(b,b,"delete",a):(a.success(),a.complete&&a.complete());return b},load:function(a){var b=
this,a=a||{},c=a.success;a.success=function(e){if(e){var f=b.get("parse").call(b,e);f&&b.set(f,a)}b.__isModified=0;c&&c.apply(this,arguments)};b.get("sync").call(b,b,"read",a);return b},save:function(a){var b=this,a=a||{},c=a.success;a.success=function(e){if(e){var f=b.get("parse").call(b,e);f&&b.set(f,a)}b.__isModified=0;c&&c.apply(this,arguments)};b.get("sync").call(b,b,b.isNew()?"create":"update",a);return b},toJSON:function(){var a=this.getAttrVals();d.each(g,function(b){delete a[b]});return a}},
{ATTRS:{idAttribute:{value:"id"},clientId:{valueFn:function(){return d.guid("mvc-client")}},url:{value:function(){var a,b,c=this.collections;for(a in c)if(c.hasOwnProperty(a)){b=c[a];break}a=b;var e;a=(a&&(e=a.get("url"))?"string"==typeof e?e:e.call(a):e)||this.get("urlRoot");if(this.isNew())return a;a+="/"==a.charAt(a.length-1)?"":"/";return a+encodeURIComponent(this.getId())+"/"}},urlRoot:{value:""},sync:{value:function(){d.require("mvc").sync.apply(this,arguments)}},parse:{value:function(a){return a}}}});
return h},{requires:["base"]});
KISSY.add("mvc/collection",function(d,i,h){function g(){g.superclass.constructor.apply(this,arguments)}g.ATTRS={model:{value:i},models:{setter:function(a){this.remove(this.get("models"),{silent:1});this.add(a,{silent:1});return this.get("models")},value:[]},url:{value:""},comparator:{},sync:{value:function(){d.require("mvc").sync.apply(this,arguments)}},parse:{value:function(a){return a}}};d.extend(g,h,{sort:function(){var a=this.get("comparator");a&&this.get("models").sort(function(b,c){return a(b)-
a(c)})},toJSON:function(){return d.map(this.get("models"),function(a){return a.toJSON()})},add:function(a,b){var c=this,e=!0;if(d.isArray(a)){var f=[].concat(a);d.each(f,function(a){a=c._add(a,b);e=e&&a})}else e=c._add(a,b);return e},remove:function(a,b){var c=this;if(d.isArray(a)){var e=[].concat(a);d.each(e,function(a){c._remove(a,b)})}else a&&c._remove(a,b)},at:function(a){return this.get("models")[a]},_normModel:function(a){var b=!0;a instanceof i||(b=a,a=new (this.get("model")),b=a.set(b,{silent:1}));
return b&&a},load:function(a){var b=this,a=a||{},c=a.success;a.success=function(e){if(e){var f=b.get("parse").call(b,e);f&&b.set("models",f,a)}d.each(b.get("models"),function(a){a.__isModified=0});c&&c.apply(this,arguments)};b.get("sync").call(b,b,"read",a);return b},create:function(a,b){var c=this,b=b||{};if(a=this._normModel(a)){a.addToCollection(c);var e=b.success;b.success=function(){c.add(a,b);e&&e()};a.save(b)}return a},_add:function(a,b){if(a=this._normModel(a)){var b=b||{},c=this.get("models"),
e=this.get("comparator"),f=c.length;if(e)for(var d=e(a),f=0;f<c.length;f++){var g=e(c[f]);if(d<g)break}this.get("models").splice(f,0,a);a.addToCollection(this);b.silent||this.fire("add",{model:a})}return a},_remove:function(a,b){var b=b||{},c=d.indexOf(a,this.get("models"));-1!=c&&(this.get("models").splice(c,1),a.removeFromCollection(this));b.silent||this.fire("remove",{model:a})},getById:function(a){for(var b=this.get("models"),c=0;c<b.length;c++){var e=b[c];if(e.getId()===a)return e}return null},
getByCid:function(a){for(var b=this.get("models"),c=0;c<b.length;c++){var e=b[c];if(e.get("clientId")===a)return e}return null}});return g},{requires:["./model","base"]});
KISSY.add("mvc/view",function(d,i,h){function g(){g.superclass.constructor.apply(this,arguments);var a;(a=this.get("events"))&&this._afterEventsChange({newVal:a})}var a=i.all;g.ATTRS={el:{value:"<div />",getter:function(b){"string"==typeof b&&(b=a(b),this.setInternal("el",b));return b}},events:{}};d.extend(g,h,{_afterEventsChange:function(a){var c=a.prevVal;c&&this._removeEvents(c);this._addEvents(a.newVal)},_removeEvents:function(a){var c=this.get("el"),e;for(e in a){var f=a[e],d;for(d in f)c.undelegate(d,
e,"string"==typeof f[d]?this[f[d]]:f[d],this)}},_addEvents:function(a){var c=this.get("el"),e;for(e in a){var d=a[e],g;for(g in d)c.delegate(g,e,"string"==typeof d[g]?this[d[g]]:d[g],this)}},render:function(){return this},destroy:function(){this.get("el").remove()}});return g},{requires:["node","base"]});
KISSY.add("mvc/router",function(d,i,h){function g(a){var b,c;for(c=0;c<a.length;c++)if(b=a.charAt(c),"\\"==b)c++;else if("("==b)return c;throw Error("impossible to not to get capture group in kissy mvc route");}function a(a){a=a||location.href;if(j.nativeHistory&&n){var a=new d.Uri(a),b=a.getQuery().toString();return a.getPath().substr(j.urlRoot.length)+(b?"?"+b:"")}return(new d.Uri(a)).getFragment().replace(/^!/,"")}function b(a){d.endsWith(a,"/")&&(a=a.substring(0,a.length-1));return a}function c(a){a&&
(d.startsWith(a,"/")&&(a=a.substring(1)),a="/"+a);return a}function e(a,c){a=b(a);c=b(c);return a==c}function f(){var b,c,e=0,f=-1,j="",h=-1,i=0,t="";b=new d.Uri(a());var s=0;c=b.clone();c.query.reset();c=c.toString();l(k,function(a){var b=0;l(a[o],function(d){var r=d.regStr,n=d.paramNames,k=-1,m,o=d.name,p=d.callback;if(m=c.match(d.reg)){m.shift();var q=function(){if(n){var a={};l(m,function(b,c){a[n[c]]=b});return a}return[].concat(m)},d=function(){j=r;h=k;i=p;s=q();e=a;t=o;f=m.length};if(m.length)if(r)k=
g(r),k>h?d():k==h&&f>=m.length?m.length<f?d():r.length>j.length&&d():e||d();else return d(),b=1,!1;else return d(),b=1,!1}});if(b)return!1});s&&(b=b.query.get(),i.apply(e,[s,b,{path:c,url:location.href}]),b={name:t,paths:s,path:c,url:location.href,query:b},e.fire("route:"+t,b),e.fire("route",b))}function x(a,b,c){var e=b,f=[];return d.isFunction(c)?(b=d.escapeRegExp(b),b=b.replace(y,function(a,b,c,d,e){f.push(c||e);if(c)return"([^/]+)";if(e)return"(.*)"}),{name:e,paramNames:f,reg:RegExp("^"+b+"$"),
regStr:b,callback:c}):{name:e,reg:c.reg,callback:!d.isFunction(c.callback)&&"string"==typeof c.callback?a[c.callback]:c.callback}}function v(a){this[o]={};this.addRoutes(a.newVal)}function j(){j.superclass.constructor.apply(this,arguments);this.on("afterRoutesChange",v,this);v.call(this,{newVal:this.get("routes")});k.push(this)}var l=d.each,y=/(:([\w\d]+))|(\\\*([\w\d]+))/g,k=[],u=d.Env.host,z=i.all,p=z(u),w=u.document.documentMode||d.UA.ie,q=u.history,n=!(!q||!q.pushState),o="__routerMap";j.ATTRS=
{routes:{}};d.extend(j,h,{addRoutes:function(a){var b=this;l(a,function(a,c){b[o][c]=x(b,c,!d.isFunction(a)&&"string"==typeof a?b[a]:a)})}},{hasRoute:function(a){var b=0;l(k,function(c){l(c[o],function(c){if(a.match(c.reg))return b=1,!1});if(b)return!1});return!!b},removeRoot:function(a){return(new d.Uri(a)).getPath().substr(j.urlRoot.length)},navigate:function(d,e){var e=e||{},g=e.replaceHistory,h;a()!==d?j.nativeHistory&&n?(q[g?"replaceState":"pushState"]({},"",location.protocol+"//"+location.host+
b(j.urlRoot)+c(d)),f()):(h="#!"+d,g?location.replace(h+(w&&8>w?i.REPLACE_HISTORY:"")):location.hash=h):e&&e.triggerRoute&&f()},start:function(d){d=d||{};if(j.__started)return d.success&&d.success();d.urlRoot=(d.urlRoot||"").replace(/\/$/,"");var g,h=d.nativeHistory,i=location.pathname,k=a(),l=location.hash.match(/#!.+/);g=j.urlRoot=d.urlRoot;if(j.nativeHistory=h)if(n)l&&e(i,g)&&(q.replaceState({},"",location.protocol+"//"+location.host+b(j.urlRoot)+c(k)),d.triggerRoute=1);else if(!e(i,g)){location.replace(b(g)+
"/#!"+k);return}setTimeout(function(){if(h&&n)p.on("popstate",f);else p.on("hashchange",f),d.triggerRoute=1;d.triggerRoute&&f();d.success&&d.success()},100);j.__started=1},stop:function(){j.__started=0;p.detach("popstate",f);p.detach("hashchange",f);k=[]}});return j},{requires:["node","base"]});
KISSY.add("mvc/sync",function(d,i,h){var g={create:"POST",update:"POST","delete":"POST",read:"GET"};return function(a,b,c){var c=d.merge({type:g[b],dataType:"json"},c),e,f;e=c.data=c.data||{};e._method=b;c.url||(f=a.get("url"),c.url="string"==typeof f?f:f.call(a));if("create"==b||"update"==b)e.model=h.stringify(a.toJSON());return i(c)}},{requires:["io","json"]});
KISSY.add("mvc",function(d,i,h,g,a,b){return{sync:b,Model:i,View:g,Collection:h,Router:a}},{requires:["mvc/model","mvc/collection","mvc/view","mvc/router","mvc/sync"]});
