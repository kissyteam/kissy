/*
Copyright 2013, KISSY UI Library v1.40dev
MIT Licensed
build time: Jul 3 13:49
*/
KISSY.add("combobox/combobox-tpl",'<div id="ks-combobox-invalid-el-{{id}}" class="{{getBaseCssClasses "invalid-el"}}"> <div class="{{getBaseCssClasses "invalid-inner"}}"></div> </div> {{#if hasTrigger}} <div id="ks-combobox-trigger-{{id}}" class="{{getBaseCssClasses "trigger"}}"> <div class="{{getBaseCssClasses "trigger-inner"}}">&#x25BC;</div> </div> {{/if}} <div class="{{getBaseCssClasses "input-wrap"}}"> <input id="ks-combobox-input-{{id}}" aria-haspopup="true" aria-autocomplete="list" aria-haspopup="true" role="autocomplete" aria-expanded="false" {{#if disabled}} disabled {{/if}} autocomplete="off" class="{{getBaseCssClasses "input"}}" value="{{value}}" /> <label id="ks-combobox-placeholder-{{id}}" for="ks-combobox-input-{{id}}" style=\'display:{{#if value}}none{{else}}block{{/if}};\' class="{{getBaseCssClasses "placeholder"}}"> {{placeholder}} </label> </div>');
KISSY.add("combobox/render",function(k,i,l){var j=i.ATTRS.xrender.value.extend({beforeCreateDom:function(f,j){k.mix(j,{input:"#ks-combobox-input-{id}",trigger:"#ks-combobox-trigger-{id}",invalidEl:"#ks-combobox-invalid-el-{id}",placeholderEl:"#ks-combobox-placeholder-{id}"})},getKeyEventTarget:function(){return this.control.get("input")},_onSetCollapsed:function(f){this.control.get("input").attr("aria-expanded",!f)},_onSetDisabled:function(f){j.superclass._onSetDisabled.apply(this,arguments);this.control.get("input").attr("disabled",
f)}},{ATTRS:{contentTpl:{value:l}},HTML_PARSER:{value:function(f){return f.one("."+this.getBaseCssClass("input")).val()},input:function(f){return f.one("."+this.getBaseCssClass("input"))},trigger:function(f){return f.one("."+this.getBaseCssClass("trigger"))},invalidEl:function(f){return f.one("."+this.getBaseCssClass("invalid-el"))},placeholderEl:function(f){return f.one("."+this.getBaseCssClass("placeholder"))}}});return j},{requires:["component/control","./combobox-tpl"]});
KISSY.add("combobox/control",function(k,i,l,j,f,n){function e(b){for(var c=0;c<b.length;c++)if(!b[c].get("disabled"))return b[c];return null}function a(){r(this)}function c(){var b=this;setTimeout(function(){q(b)},0)}function g(){self.focus();q(this)}function t(){this.setValueFromAutocomplete(this.getValueForAutocomplete(),{force:1})}function h(b){b=b.target;b.isMenuItem&&(b=b.get("textContent"),this.setValueFromAutocomplete(b),this._savedValue=b,this.set("collapsed",!0))}function d(b,c){var s=b.$el,
a=b.view.getBaseCssClasses("invalid"),g=b.get("invalidEl");c?(s.addClass(a),g.attr("title",c),g.show()):(s.removeClass(a),g.hide())}function r(b){b._focusoutDismissTimer||(b._focusoutDismissTimer=setTimeout(function(){b._focusoutDismissTimer&&b.set("collapsed",!0)},50))}function q(b){var c;if(c=b._focusoutDismissTimer)clearTimeout(c),b._focusoutDismissTimer=null}function u(b){this.set("value",b.newVal,{data:{causedByTimer:1}})}function p(b){var c,a=[],g,d,a=this.get("menu"),b=this.normalizeData(b);
a.removeChildren(!0);(d=a.get("highlightedItem"))&&d.set("highlighted",!1);if(b&&b.length){for(d=0;d<b.length;d++)c=b[d],a.addChild(c);a=a.get("children");b=this.getValueForAutocomplete();if(this.get("highlightMatchItem"))for(d=0;d<a.length;d++)if(a[d].get("textContent")==b){a[d].set("highlighted",!0);g=!0;break}if(!g&&this.get("autoHighlightFirst"))for(d=0;d<a.length;d++)if(!a[d].get("disabled")){a[d].set("highlighted",!0);break}this.set("collapsed",!1)}else this.set("collapsed",!0)}var o,m=i.KeyCode;
return o=l.extend({_savedValue:null,normalizeData:function(b){var a,c,d;if(b&&b.length){b=b.slice(0,this.get("maxItemCount"));a=this.get("format")?this.get("format").call(this,this.getValueForAutocomplete(),b):[];for(d=0;d<b.length;d++)c=b[d],a[d]=k.mix({content:c,textContent:c,value:c},a[d])}return a},bindUI:function(){var b=this;b.get("input").on("valuechange",u,b);b.on("click",h,b);b.get("menu").onRendered(function(d){var h=b.get("input"),e=d.get("el"),d=d.get("contentEl");h.attr("aria-owns",e.attr("id"));
e.on("focusout",a,b);e.on("focusin",c,b);d.on("mouseover",g,b);d.on("mousedown",t,b)})},destructor:function(){this.get("menu").destroy()},getValueForAutocomplete:function(){return this.get("value")},setValueFromAutocomplete:function(b,a){this.set("value",b,a)},_onSetValue:function(b,a){var c;a.causedByTimer?(c=this.getValueForAutocomplete(),c===n?this.set("collapsed",!0):(this._savedValue=c,this.sendRequest(c))):this.get("input").val(b)},handleFocusInternal:function(){var b;this.get("invalidEl")&&
d(this,!1);(b=this.get("placeholderEl"))&&b.hide()},handleBlurInternal:function(){var b=this,c=b.get("placeholderEl");o.superclass.handleBlurInternal.apply(b,arguments);r(b);b.get("invalidEl")&&b.validate(function(c,a){c?!b.get("focused")&&a==b.get("value")&&d(b,c):d(b,!1)});c&&!b.get("value")&&c.show()},handleMouseDownInternal:function(b){var c,a;o.superclass.handleMouseDownInternal.apply(this,arguments);c=b.target;if((a=this.get("trigger"))&&(a[0]==c||a.contains(c)))this.get("collapsed")?(this.focus(),
this.sendRequest("")):this.set("collapsed",!0),b.preventDefault()},handleKeyDownInternal:function(b){var c,a=b.keyCode,d,g=this.get("menu");this.get("input");c=this.get("updateInputOnDownUp");if(g.get("visible")){d=g.get("highlightedItem");if(c&&d){var h=g.get("children");if(a==m.DOWN&&d==e(h.concat().reverse())||a==m.UP&&d==e(h))return this.setValueFromAutocomplete(this._savedValue),d.set("highlighted",!1),!0}b=g.handleKeyDownInternal(b);d=g.get("highlightedItem");if(a==m.ESC)return this.set("collapsed",
!0),c&&this.setValueFromAutocomplete(this._savedValue),!0;c&&k.inArray(a,[m.DOWN,m.UP])&&this.setValueFromAutocomplete(d.get("textContent"));return a==m.TAB&&d&&(d.handleClickInternal(),this.get("multiple"))?!0:b}if(a==m.DOWN||a==m.UP)c=this.getValueForAutocomplete(),c!==n&&this.sendRequest(c);return n},validate:function(b){var c=this.get("validator"),a=this.getValueForAutocomplete();c?c(a,function(c){b(c,a)}):b(!1,a)},sendRequest:function(b){this.get("dataSource").fetchData(b,p,this)},_onSetCollapsed:function(b){var c=
this.$el,a=this.get("menu");b?a.hide():(q(this),a.get("visible")||(this.get("matchElWidth")&&(a.render(),b=a.get("el"),b=(parseInt(b.css("borderLeftWidth"))||0)+(parseInt(b.css("borderRightWidth"))||0),a.set("width",c[0].offsetWidth-b)),a.show()))}},{ATTRS:{input:{},value:{value:"",sync:0,view:1},trigger:{},placeholder:{view:1},placeholderEl:{},validator:{},invalidEl:{},allowTextSelection:{value:!0},hasTrigger:{value:!0,view:1},menu:{value:{},getter:function(b){b.isControl||(b.xclass=b.xclass||"popupmenu",
b=this.createComponent(b),this.setInternal("menu",b));return b},setter:function(b){if(b.isControl){b.setInternal("parent",this);var c={node:this.$el,points:["bl","tl"],overflow:{adjustX:1,adjustY:1}};k.mix(b.get("align"),c,!1)}}},collapsed:{view:1,value:!0},dataSource:{},maxItemCount:{value:99999},matchElWidth:{value:!0},format:{},updateInputOnDownUp:{value:!0},autoHighlightFirst:{},highlightMatchItem:{value:!0},xrender:{value:j}},xclass:"combobox"})},{requires:["node","component/control","./render",
"menu"]});
KISSY.add("combobox/cursor",function(k,i){function l(a){var c=n;c||(c=j(f));"textarea"==""+a.type?c.css("width",a.css("width")):c.css("width",9999);k.each(e,function(g){c.css(g,a.css(g))});n||c.insertBefore(a[0].ownerDocument.body.firstChild);return n=c}var j=i.all,f="<div style='z-index:-9999;overflow:hidden;position: fixed;left:-9999px;top:-9999px;opacity:0;white-space:pre-wrap;word-wrap:break-word;'></div>",n,e="paddingLeft,paddingTop,paddingBottom,paddingRight,marginLeft,marginTop,marginBottom,marginRight,borderLeftStyle,borderTopStyle,borderBottomStyle,borderRightStyle,borderLeftWidth,borderTopWidth,borderBottomWidth,borderRightWidth,line-height,outline,height,fontFamily,fontSize,fontWeight,fontVariant,fontStyle".split(",");return function(a){var c=
j(a),a=c[0],g=a.ownerDocument,e=j(g),h=a.scrollTop,d=a.scrollLeft;if(g.selection)return a=g.selection.createRange(),{left:a.boundingLeft+d+e.scrollLeft(),top:a.boundingTop+h+a.boundingHeight+e.scrollTop()};e=c.offset();if("textarea"!=a.type)return e.top+=a.offsetHeight,e;g=l(c);c=a.selectionStart;g.html(k.escapeHtml(a.value.substring(0,c-1))+"<span>x</span>");g.offset(e);e=g.last();a=e.offset();a.top+=e.height();0<c&&(a.left+=e.width());a.top-=h;a.left-=d;return a}},{requires:["node"]});
KISSY.add("combobox/multi-value-combobox",function(k,i,l){function j(c,a){return a&&-1!=c.indexOf(a)}function f(a){a.newVal&&a.target==this.get("menu")&&this.alignWithCursor()}function n(c){var g=c.get("input"),f=c.get("value"),h=[],d=[],n=c.get("literal"),i=c.get("separator"),c=c.get("separatorType"),l=!1,k=c!=e,g=g.prop("selectionStart"),o,m,b=-1;for(o=0;o<f.length;o++)(m=f.charAt(o),n&&m==n&&(l=!l),l)?d.push(m):(o==g&&(b=h.length),k&&a.test(m))?(d.length&&h.push(d.join("")),d=[],d.push(m)):j(i,
m)?c==e?(d.push(m),d.length&&h.push(d.join("")),d=[]):(d.length&&h.push(d.join("")),d=[],d.push(m)):d.push(m);d.length&&h.push(d.join(""));h.length||h.push("");-1==b&&(c==e&&j(i,m)&&h.push(""),b=h.length-1);return{tokens:h,cursorPosition:g,tokenIndex:b}}var e="suffix",a=/\s|\xa0/;return l.extend({syncUI:function(){var a;this.get("alignWithCursor")&&(a=this.get("menu"),a.setInternal("align",null),a.on("beforeVisibleChange",f,this))},getValueForAutocomplete:function(){var a=n(this),g=a.tokens,f=a.tokenIndex,
a=this.get("separator"),h=this.get("separatorType"),g=g[f],f=g.length-1;if(h!=e)if(j(a,g.charAt(0)))g=g.slice(1);else return;else h==e&&j(a,g.charAt(f))&&(g=g.slice(0,f));return g},setValueFromAutocomplete:function(c,g){var f=this.get("input"),h=n(this),d=h.tokens,h=Math.max(0,h.tokenIndex),l=this.get("separator"),i;i=this.get("separatorType");var k=d[h+1]||"",p=d[h];if(i!=e){if(d[h]=p.charAt(0)+c,!k||!a.test(k.charAt(0)))c&&(d[h]+=" ")}else d[h]=c,i=p.length-1,j(l,p.charAt(i))?d[h]+=p.charAt(i):
1==l.length&&(d[h]+=l);h=d.slice(0,h+1).join("").length;this.set("value",d.join(""),g);f.prop("selectionStart",h);f.prop("selectionEnd",h)},alignWithCursor:function(){var a=this.get("menu"),e;e=this.get("input");e=i(e);a.move(e.left,e.top)}},{ATTRS:{separator:{value:",;"},separatorType:{value:e},literal:{value:'"'},alignWithCursor:{}},xclass:"multi-value-combobox"})},{requires:["./cursor","./control"]});
KISSY.add("combobox/filter-select",function(k,i){var l=i.extend({validate:function(j){var f=this;l.superclass.validate.call(f,function(i,e){i?j(i,e):f.get("dataSource").fetchData(e,function(a){a:{if(a=f.normalizeData(a))for(var c=0;c<a.length;c++)if(a[c].textContent==e){a=a[c];break a}a=!1}j(a?"":f.get("invalidMessage"),e,a)})})}},{ATTRS:{invalidMessage:{value:"invalid input"}}});return l},{requires:["./control"]});
KISSY.add("combobox/local-data-source",function(k){function i(){i.superclass.constructor.apply(this,arguments)}i.ATTRS={data:{value:[]},parse:{value:function(i,j){var f=[],n=0;if(!i)return j;k.each(j,function(e){-1!=e.indexOf(i)&&f.push(e);n++});return f}}};k.extend(i,k.Base,{fetchData:function(i,j,f){var k=this.get("parse"),e=this.get("data"),e=k(i,e);j.call(f,e)}});return i});
KISSY.add("combobox/remote-data-source",function(k,i){function l(){l.superclass.constructor.apply(this,arguments);this.io=null;this.caches={}}l.ATTRS={paramName:{value:"q"},allowEmpty:{},cache:{},parse:{},xhrCfg:{value:{}}};k.extend(l,k.Base,{fetchData:function(j,f,k){var e=this,a,c=e.get("paramName"),g=e.get("parse"),l=e.get("cache"),h=e.get("allowEmpty");e.io&&(e.io.abort(),e.io=null);if(!j&&!0!==h)return f.call(k,[]);if(l&&(a=e.caches[j]))return f.call(k,a);a=e.get("xhrCfg");a.data=a.data||{};
a.data[c]=j;a.success=function(a){g&&(a=g(j,a));e.setInternal("data",a);l&&(e.caches[j]=a);f.call(k,a)};e.io=i(a)}});return l},{requires:["io"]});KISSY.add("combobox",function(k,i,l,j,f,n){i.LocalDataSource=f;i.RemoteDataSource=n;i.FilterSelect=j;i.MultiValueComboBox=l;return i},{requires:["combobox/control","combobox/multi-value-combobox","combobox/filter-select","combobox/local-data-source","combobox/remote-data-source"]});
