/*
Copyright 2012, KISSY UI Library v1.40dev
MIT Licensed
build time: Aug 21 15:59
*/
KISSY.add("combobox/base",function(f,l,h,g,d,m,k){function i(a,b){if(b){var c=b.get("textContent"),e=a.get("separatorType");u(a,c+(e==p?"":" "));a._savedInputValue=c}}function v(a,b){var c=a.get("el"),e=a.get("prefixCls")+"combobox-invalid",j=a.get("invalidEl");b?(c.addClass(e),j.attr("title",b),j.show()):(c.removeClass(e),j.hide())}function o(a,b){var c=a.get("menu");if(c&&c.xclass)if(b)c=h.create(c,a),a.__set("menu",c);else return null;return c}function q(){var a=o(this);if(a&&a.get("visible"))if(this.get("multiple")&&
this.get("alignWithCursor")){var b=w(this),c=b.tokens,a=this.get("menu"),e=b.cursorPosition,j=b.tokenIndex,b=this.get("input"),c=c.slice(0,j).join("").length;0<c&&++c;b.prop("selectionStart",c);b.prop("selectionEnd",c);c=b.prop("KsCursorOffset");b.prop("selectionStart",e);b.prop("selectionEnd",e);a.set("xy",[c.left,c.top])}else a=this.get("menu"),e=f.clone(a.get("align")),e.node=this.get("el"),f.mix(e,C,!1),a.set("align",e)}function r(){var a=this;a._focusoutDismissTimer=setTimeout(function(){a.set("collapsed",
!0)},30)}function s(){var a;if(a=this._focusoutDismissTimer)clearTimeout(a),this._focusoutDismissTimer=null}function u(a,b){var c=a.get("input");if(a.get("multiple")){var e=w(a),j=e.tokens,e=Math.max(0,e.tokenIndex),d=a.get("separator"),i=a.get("separatorType"),f=j[e];j[e]=f&&-1!=d.indexOf(f.charAt(0))?f.charAt(0):"";j[e]+=b;f=j[e+1];if(i==p&&(!f||-1==d.indexOf(f.charAt(0))))j[e]+=d.charAt(0);e=j.slice(0,e+1).join("").length;c.val(j.join(""));c.prop("selectionStart",e);c.prop("selectionEnd",e)}else c.val(b)}
function t(a){var b=a.get("input").val();if(a.get("multiple")){var c=w(a),b=c.tokens,c=c.tokenIndex,e=a.get("separator"),a=a.get("separatorType");return(b=b[c]||"")&&-1!=e.indexOf(b.charAt(0))?b.substring(1):a==p&&(0==c||-1==c)?b:k}return b}function D(){if(!this._stopNotify){var a=t(this);a===k?this.set("collapsed",!0):(this._savedInputValue=a,this.sendRequest(a))}}function E(a){var b,c=[],e,j,d=o(this,1),a=this.normalizeData(a);d.removeChildren(!0);if(a&&a.length){for(j=0;j<a.length;j++)b=a[j],c.push(d.addChild(f.mix({xclass:"menuitem"},
b)));a=t(this);for(j=0;j<c.length;j++)if(c[j].get("textContent")==a){d.set("highlightedItem",c[j]);e=!0;break}if(!e&&this.get("autoHighlightFirst"))for(j=0;j<c.length;j++)if(!c[j].get("disabled")){d.set("highlightedItem",c[j]);break}this.set("collapsed",!1)}else this.set("collapsed",!0)}function y(){if(!this.get("disabled")){var a=this.get("input");this.get("collapsed")?(a[0].focus(),this.sendRequest("")):this.set("collapsed",!0)}}function z(a){a.preventDefault()}function w(a){for(var b=a.get("input"),
c=b.val(),e=[],d=[],i=a.get("literal"),f=a.get("separator"),m=!1,a=a.get("whitespace"),b=b.prop("selectionStart"),h=-1,g=0;g<c.length;g++){var k=c.charAt(g);g==b&&(h=e.length);if(!m&&(!a&&/\s|\xa0/.test(k)&&(e.push(d.join("")),d=[]),-1!=f.indexOf(k)))e.push(d.join("")),d=[];i&&k==i&&(m=!m);d.push(k)}d.length&&e.push(d.join(""));-1==h&&(h=e.length-1);return{tokens:e,cursorPosition:b,tokenIndex:h}}var x,d=l.all,n=l.KeyCodes,C={points:["bl","tl"],overflow:{adjustX:1,adjustY:1}},A=d(f.Env.host),p="suffix";
x=h.Controller.extend({_savedInputValue:null,_stopNotify:0,normalizeData:function(a){var b,c,e;if(a&&a.length){a=a.slice(0,this.get("maxItemCount"));b=this.get("format")?this.get("format").call(this,t(this),a):[];for(e=0;e<a.length;e++)c=a[e],b[e]=f.mix({content:c,textContent:c,value:c},b[e])}return b},bindUI:function(){this.get("input").on("valuechange",D,this)},handleFocus:function(){var a;v(this,!1);(a=this.get("placeholderEl"))&&a.hide()},handleBlur:function(){var a=this;x.superclass.handleBlur.apply(a,
arguments);r.call(a);var b,c=a.get("input");a.validate(function(b,d){b?!a.get("focused")&&d==c.val()&&v(a,b):v(a,!1)});(b=a.get("placeholderEl"))&&!c.val()&&b.show()},syncUI:function(){if(this.get("placeholder")){var a=this.get("input"),b=this.get("inputValue");b!=k&&a.val(b);a.val()||this.get("placeholderEl").show()}},validate:function(a){var b=this.get("validator"),c=this.get("input").val();b?b(c,function(b){a(b,c)}):a(!1,c)},bindMenu:function(){var a=this,b,c;c=a.get("menu");c.on("click",function(b){b=
b.target;a._stopNotify=1;i(a,b);a.set("collapsed",!0);setTimeout(function(){a._stopNotify=0},50)});A.on("resize",B,a);b=c.get("el");c=c.get("contentEl");b.on("focusout",r,a);b.on("focusin",s,a);c.on("mouseover",function(){a.get("input")[0].focus();s.call(a)});a.bindMenu=f.noop},_uiSetHasTrigger:function(a){var b=this.get("trigger");a?(b.on("click",y,this),b.on("mousedown",z)):(b.detach("click",y,this),b.detach("mousedown",z))},sendRequest:function(a){this.get("dataSource").fetchData(a,E,this)},_uiSetCollapsed:function(a){if(a)(a=
o(this))&&a.hide();else{var a=this.get("el"),b=o(this,1);s.call(this);b&&!b.get("visible")&&(b.render(),this.bindMenu(),this.get("matchElWidth")&&b.set("width",a.innerWidth()),b.show(),q.call(this),this.get("input").attr("aria-owns",b.get("el")[0].id))}},handleKeyEventInternal:function(a){this.get("input");var b=o(this);if(b){var c=this.get("updateInputOnDownUp");c&&(this._stopNotify=f.inArray(a.keyCode,[n.UP,n.DOWN,n.ESC])?1:0);var d;if(b.get("visible")){var i=b.handleKeydown(a);c&&f.inArray(a.keyCode,
[n.DOWN,n.UP])&&u(this,b.get("activeItem").get("textContent"));if(a.keyCode==n.ESC)return this.set("collapsed",!0),c&&u(this,this._savedInputValue),!0;if(a.keyCode==n.TAB&&(d=b.get("activeItem")))if(d.performActionInternal(),this.get("multiple"))return!0;return i}if(a.keyCode==n.DOWN||a.keyCode==n.UP)return this.sendRequest(t(this)),!0}},destructor:function(){A.detach("resize",B,this)}},{ATTRS:{input:{view:1},trigger:{view:1},placeholder:{view:1},placeholderEl:{view:1},validator:{},invalidEl:{view:1},
allowTextSelection:{value:!0},hasTrigger:{view:1},menu:{value:{xclass:"popupmenu"},setter:function(a){a instanceof h.Controller&&a.__set("parent",this)}},collapsed:{view:1},dataSource:{setter:function(a){return h.create(a)}},maxItemCount:{value:99999},matchElWidth:{value:!0},format:{},multiple:{},separator:{value:",;"},separatorType:{value:p},whitespace:{valueFn:function(){return this.get("separatorType")==p}},updateInputOnDownUp:{value:!0},literal:{value:'"'},alignWithCursor:{},autoHighlightFirst:{},
xrender:{value:g}}},{xclass:"combobox",priority:10});var B=f.buffer(q,50);return x},{requires:["node","component","./render","input-selection","menu"]});KISSY.add("combobox",function(f,l,h,g,d){l.LocalDataSource=g;l.RemoteDataSource=d;l.FilterSelect=h;return l},{requires:["combobox/base","combobox/filter-select","combobox/LocalDataSource","combobox/RemoteDataSource"]});
KISSY.add("combobox/filter-select",function(f,l){var h=l.extend({validate:function(f){var d=this;h.superclass.validate.call(this,function(m,h){m?f(m,h):d.get("dataSource").fetchData(h,function(i){a:{if(i=d.normalizeData(i))for(var m=0;m<i.length;m++)if(i[m].textContent==h){i=i[m];break a}i=!1}f(i?"":d.get("invalidMessage"),h,i)})})}},{ATTRS:{invalidMessage:{value:"invalid input"}}});return h},{requires:["./base"]});
KISSY.add("combobox/LocalDataSource",function(f,l){function h(){h.superclass.constructor.apply(this,arguments)}h.ATTRS={data:{value:[]},parse:{value:function(h,d){var m=[],k=0;if(!h)return d;f.each(d,function(d){-1!=d.indexOf(h)&&m.push(d);k++});return m}}};f.extend(h,f.Base,{fetchData:function(f,d,h){var k=this.get("parse"),i=this.get("data"),i=k(f,i);d.call(h,i)}});l.Manager.setConstructorByXClass("combobox-LocalDataSource",h);return h},{requires:["component"]});
KISSY.add("combobox/RemoteDataSource",function(f,l,h){function g(){g.superclass.constructor.apply(this,arguments);this.io=null;this.caches={}}g.ATTRS={paramName:{value:"q"},allowEmpty:{},cache:{},parse:{},xhrCfg:{value:{}}};f.extend(g,f.Base,{fetchData:function(d,f,h){var i=this,g,o=i.get("paramName"),q=i.get("parse"),r=i.get("cache"),s=i.get("allowEmpty");i.io&&(i.io.abort(),i.io=null);if(!d&&!0!==s)return f.call(h,[]);if(r&&(g=i.caches[d]))return f.call(h,g);g=i.get("xhrCfg");g.data=g.data||{};
g.data[o]=d;g.success=function(g){q&&(g=q(d,g));i.__set("data",g);r&&(i.caches[d]=g);f.call(h,g)};i.io=l(g)}});h.Manager.setConstructorByXClass("combobox-RemoteDataSource",g);return g},{requires:["ajax","component"]});
KISSY.add("combobox/render",function(f,l){var h=f.all,g=l.Render.extend({createDom:function(){var d,g=this.get("input"),k=this.get("el"),i=this.get("trigger");this.get("srcNode")||(k.append('<div class="ks-combobox-input-wrap"></div>'),d=k.one(".ks-combobox-input-wrap"),g=g||f.all('<input aria-haspopup="true" aria-autocomplete="list" aria-haspopup="true" role="autocomplete" autocomplete="off" class="ks-combobox-input" />'),d.append(g),this.__set("input",g));i||this.__set("trigger",f.all('<div class="ks-combobox-trigger"><div class="ks-combobox-trigger-inner">&#x25BC;</div></div>'));
this.get("trigger").unselectable();this.__set("invalidEl",h("<div class='ks-combobox-invalid-el'><div class='ks-combobox-invalid-inner'></div></div>").insertBefore(g.parent()));if(i=this.get("placeholder")){if(!(d=g.attr("id")))g.attr("id",d=f.guid("ks-combobox-input"));this.__set("placeholderEl",h('<label for="'+d+'" class="ks-combobox-placeholder">'+i+"</label>").appendTo(k))}},getKeyEventTarget:function(){return this.get("input")},_uiSetCollapsed:function(d){this.get("input").attr("aria-expanded",
d)},_uiSetHasTrigger:function(d){var f=this.get("trigger");d?this.get("el").prepend(f):f.remove()},_uiSetDisabled:function(d){g.superclass._uiSetDisabled.apply(this,arguments);this.get("input").attr("disabled",d)}},{ATTRS:{collapsed:{value:!0},hasTrigger:{value:!0},input:{},trigger:{},placeholder:{},placeholderEl:{},invalidEl:{}},HTML_PARSER:{input:function(d){return d.one(".ks-combobox-input")},trigger:function(d){return d.one(".ks-combobox-trigger")}}});return g},{requires:["component"]});
