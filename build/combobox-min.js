/*
Copyright 2012, KISSY UI Library v1.40dev
MIT Licensed
build time: Dec 11 12:52
*/
KISSY.add("combobox/base",function(h,e,l,m,c,k,i){function d(a,g){if(g){var f=g.get("textContent"),j=a.get("separatorType");q(a,f+(j==r?"":" "));a._savedInputValue=f}}function b(a,g){var f=a.get("el"),j=a.get("prefixCls")+"combobox-invalid",b=a.get("invalidEl");g?(f.addClass(j),b.attr("title",g),b.show()):(f.removeClass(j),b.hide())}function n(a,g){var f=a.get("menu");if(f&&!f.isController)if(g)f=m.create(f,a),a.setInternal("menu",f);else return null;return f}function v(){var a=n(this);if(a&&a.get("visible"))if(this.get("multiple")&&
this.get("alignWithCursor")){var g=t(this),f=g.tokens,a=this.get("menu"),j=g.cursorPosition,b=g.tokenIndex,g=this.get("input"),f=f.slice(0,b).join("").length;0<f&&++f;g.prop("selectionStart",f);g.prop("selectionEnd",f);f=e(g);g.prop("selectionStart",j);g.prop("selectionEnd",j);a.set("xy",[f.left,f.top])}else a=this.get("menu"),j=h.clone(a.get("align")),j.node=this.get("el"),h.mix(j,y,!1),a.set("align",j)}function w(){var a=this;a._focusoutDismissTimer=setTimeout(function(){a.set("collapsed",!0)},
30)}function o(){var a;if(a=this._focusoutDismissTimer)clearTimeout(a),this._focusoutDismissTimer=null}function q(a,g){var f=a.get("input");if(a.get("multiple")){var j=t(a),b=j.tokens,j=Math.max(0,j.tokenIndex),c=a.get("separator"),d=a.get("separatorType"),n=b[j];b[j]=n&&-1!=c.indexOf(n.charAt(0))?n.charAt(0):"";b[j]+=g;n=b[j+1];if(d==r&&(!n||-1==c.indexOf(n.charAt(0))))b[j]+=c.charAt(0);j=b.slice(0,j+1).join("").length;f.val(b.join(""));f.prop("selectionStart",j);f.prop("selectionEnd",j)}else f.val(g)}
function s(a){var g=a.get("input").val();if(a.get("multiple")){var f=t(a),g=f.tokens,f=f.tokenIndex,b=a.get("separator"),a=a.get("separatorType");return(g=g[f]||"")&&-1!=b.indexOf(g.charAt(0))?g.substring(1):a==r&&(0==f||-1==f)?g:i}return g}function z(){if(!this._stopNotify){var a=s(this);a===i?this.set("collapsed",!0):(this._savedInputValue=a,this.sendRequest(a))}}function A(a){var g,f=[],b,c,d=n(this,1),a=this.normalizeData(a);d.removeChildren(!0);if(a&&a.length){for(c=0;c<a.length;c++)g=a[c],f.push(d.addChild(g));
a=s(this);for(c=0;c<f.length;c++)if(f[c].get("textContent")==a){d.set("highlightedItem",f[c]);b=!0;break}if(!b&&this.get("autoHighlightFirst"))for(c=0;c<f.length;c++)if(!f[c].get("disabled")){d.set("highlightedItem",f[c]);break}this.set("collapsed",!1)}else this.set("collapsed",!0)}function t(a){for(var g=a.get("input"),f=g.val(),b=[],c=[],d=a.get("literal"),n=a.get("separator"),e=!1,a=a.get("whitespace"),g=g.prop("selectionStart"),h=-1,k=0;k<f.length;k++){var i=f.charAt(k);k==g&&(h=b.length);if(!e&&
(!a&&/\s|\xa0/.test(i)&&(b.push(c.join("")),c=[]),-1!=n.indexOf(i)))b.push(c.join("")),c=[];d&&i==d&&(e=!e);c.push(i)}c.length&&b.push(c.join(""));-1==h&&(h=b.length-1);return{tokens:b,cursorPosition:g,tokenIndex:h}}var u,k=l.all,p=l.KeyCodes,y={points:["bl","tl"],overflow:{adjustX:1,adjustY:1}},x=k(h.Env.host),r="suffix";return u=m.Controller.extend({_savedInputValue:null,_stopNotify:0,normalizeData:function(a){var b,f,c;if(a&&a.length){a=a.slice(0,this.get("maxItemCount"));b=this.get("format")?
this.get("format").call(this,s(this),a):[];for(c=0;c<a.length;c++)f=a[c],b[c]=h.mix({content:f,textContent:f,value:f},b[c])}return b},bindUI:function(){this.get("input").on("valuechange",z,this)},handleFocus:function(){var a;b(this,!1);(a=this.get("placeholderEl"))&&a.hide()},handleBlur:function(){var a=this;u.superclass.handleBlur.apply(a,arguments);w.call(a);var c,f=a.get("input");a.validate(function(c,g){c?!a.get("focused")&&g==f.val()&&b(a,c):b(a,!1)});(c=a.get("placeholderEl"))&&!f.val()&&c.show()},
handleMouseDown:function(a){u.superclass.handleMouseDown.apply(this,arguments);var b;b=a.target;var c=this.get("trigger");if(this.get("hasTrigger")&&(c[0]==b||c.contains(b)))b=this.get("input"),this.get("collapsed")?(b[0].focus(),this.sendRequest("")):this.set("collapsed",!0),a.preventDefault()},handleKeyEventInternal:function(a){this.get("input");var b=n(this);if(b){var c=this.get("updateInputOnDownUp");c&&(this._stopNotify=h.inArray(a.keyCode,[p.UP,p.DOWN,p.ESC])?1:0);var d;if(b.get("visible")){var e=
b.handleKeydown(a);c&&h.inArray(a.keyCode,[p.DOWN,p.UP])&&q(this,b.get("activeItem").get("textContent"));if(a.keyCode==p.ESC)return this.set("collapsed",!0),c&&q(this,this._savedInputValue),!0;if(a.keyCode==p.TAB&&(d=b.get("activeItem")))if(d.performActionInternal(),this.get("multiple"))return!0;return e}if(a.keyCode==p.DOWN||a.keyCode==p.UP)return this.sendRequest(s(this)),!0}},syncUI:function(){if(this.get("placeholder")){var a=this.get("input"),b=this.get("inputValue");b!=i&&a.val(b);a.val()||
this.get("placeholderEl").show()}},validate:function(a){var b=this.get("validator"),c=this.get("input").val();b?b(c,function(b){a(b,c)}):a(!1,c)},bindMenu:function(){var a=this,b,c;c=a.get("menu");c.on("click",function(b){b=b.target;a._stopNotify=1;d(a,b);a.set("collapsed",!0);setTimeout(function(){a._stopNotify=0},50)});a.__repositionBuffer=h.buffer(v,50);x.on("resize",a.__repositionBuffer,a);b=c.get("el");c=c.get("contentEl");b.on("focusout",w,a);b.on("focusin",o,a);c.on("mouseover",function(){a.get("input")[0].focus();
o.call(a)});a.bindMenu=h.noop},sendRequest:function(a){this.get("dataSource").fetchData(a,A,this)},_onSetCollapsed:function(a){if(a)(a=n(this))&&a.hide();else{var a=this.get("el"),b=n(this,1);o.call(this);b&&!b.get("visible")&&(b.render(),this.bindMenu(),this.get("matchElWidth")&&b.set("width",a.innerWidth()),b.show(),v.call(this),this.get("input").attr("aria-owns",b.get("el")[0].id))}},destructor:function(){x.detach("resize",this.__repositionBuffer,this);this.__repositionBuffer.stop()}},{ATTRS:{input:{view:1},
trigger:{view:1},placeholder:{view:1},placeholderEl:{view:1},validator:{},invalidEl:{view:1},allowTextSelection:{value:!0},hasTrigger:{view:1},menu:{value:{},setter:function(a){a&&a.isController&&a.setInternal("parent",this)}},defaultChildXClass:{value:"popupmenu"},collapsed:{view:1},dataSource:{setter:function(a){return m.create(a)}},maxItemCount:{value:99999},matchElWidth:{value:!0},format:{},multiple:{},separator:{value:",;"},separatorType:{value:r},whitespace:{valueFn:function(){return this.get("separatorType")==
r}},updateInputOnDownUp:{value:!0},literal:{value:'"'},alignWithCursor:{},autoHighlightFirst:{},xrender:{value:c}}},{xclass:"combobox",priority:10})},{requires:["./cursor","node","component/base","./render","menu"]});KISSY.add("combobox",function(h,e,l,m,c){e.LocalDataSource=m;e.RemoteDataSource=c;e.FilterSelect=l;return e},{requires:["combobox/base","combobox/filter-select","combobox/LocalDataSource","combobox/RemoteDataSource"]});
KISSY.add("combobox/cursor",function(h,e){function l(b){var d=c,i;d||(d=e.create(m));"textarea"==b.type?e.css(d,"width",e.css(b,"width")):e.css(d,"width",9999);h.each(k,function(c){e.css(d,c,e.css(b,c))});c||(i=b.ownerDocument.body,i.insertBefore(d,i.firstChild));return c=d}var m="<div style='z-index:-9999;overflow:hidden;position: fixed;left:-9999px;top:-9999px;opacity:0;white-space:pre-wrap;word-wrap:break-word;'></div>",c,k="paddingLeft,paddingTop,paddingBottom,paddingRight,marginLeft,marginTop,marginBottom,marginRight,borderLeftStyle,borderTopStyle,borderBottomStyle,borderRightStyle,borderLeftWidth,borderTopWidth,borderBottomWidth,borderRightWidth,line-height,outline,height,fontFamily,fontSize,fontWeight,fontVariant,fontStyle".split(","),
i,d;d=function(){var b=document,c=e.create("<input>");e.css(c,{width:1,position:"absolute",left:-9999,top:-9999});c.value="123456789";b.body.appendChild(c);c.focus();i=!!(0<c.scrollLeft);e.remove(c);d=h.noop};return function(b){var c=b.ownerDocument,k=b.scrollTop,m=b.scrollLeft;if(c.selection)return c=c.selection.createRange(),{left:c.boundingLeft+m+e.scrollLeft(),top:c.boundingTop+k+c.boundingHeight+e.scrollTop()};d();var o=e.offset(b);if(!i&&"textarea"!=b.type)return o.top+=b.offsetHeight,o;var q=
l(b),c=b.selectionStart;q.innerHTML=h.escapeHTML(b.value.substring(0,c-1))+"<span>x</span>";e.offset(q,o);o=q.lastChild;b=e.offset(o);b.top+=e.height(o);0<c&&(b.left+=e.width(o));b.top-=k;b.left-=m;return b}},{requires:["dom"]});
KISSY.add("combobox/filter-select",function(h,e){var l=e.extend({validate:function(e){var c=this;l.superclass.validate.call(c,function(k,i){k?e(k,i):c.get("dataSource").fetchData(i,function(d){a:{if(d=c.normalizeData(d))for(var b=0;b<d.length;b++)if(d[b].textContent==i){d=d[b];break a}d=!1}e(d?"":c.get("invalidMessage"),i,d)})})}},{ATTRS:{invalidMessage:{value:"invalid input"}}});return l},{requires:["./base"]});
KISSY.add("combobox/LocalDataSource",function(h,e){function l(){l.superclass.constructor.apply(this,arguments)}l.ATTRS={data:{value:[]},parse:{value:function(e,c){var k=[],i=0;if(!e)return c;h.each(c,function(c){-1!=c.indexOf(e)&&k.push(c);i++});return k}}};h.extend(l,h.Base,{fetchData:function(e,c,k){var i=this.get("parse"),d=this.get("data"),d=i(e,d);c.call(k,d)}});e.Manager.setConstructorByXClass("combobox-LocalDataSource",l);return l},{requires:["component/base"]});
KISSY.add("combobox/RemoteDataSource",function(h,e,l){function m(){m.superclass.constructor.apply(this,arguments);this.io=null;this.caches={}}m.ATTRS={paramName:{value:"q"},allowEmpty:{},cache:{},parse:{},xhrCfg:{value:{}}};h.extend(m,h.Base,{fetchData:function(c,k,i){var d=this,b,h=d.get("paramName"),l=d.get("parse"),m=d.get("cache"),o=d.get("allowEmpty");d.io&&(d.io.abort(),d.io=null);if(!c&&!0!==o)return k.call(i,[]);if(m&&(b=d.caches[c]))return k.call(i,b);b=d.get("xhrCfg");b.data=b.data||{};
b.data[h]=c;b.success=function(b){l&&(b=l(c,b));d.setInternal("data",b);m&&(d.caches[c]=b);k.call(i,b)};d.io=e(b)}});l.Manager.setConstructorByXClass("combobox-RemoteDataSource",m);return m},{requires:["ajax","component/base"]});
KISSY.add("combobox/render",function(h,e){var l=h.all,m=e.Render.extend({createDom:function(){var c,e=this.get("input"),i=this.get("prefixCls"),d=this.get("el"),b=this.get("trigger");this.get("srcNode")||(d.append(h.substitute('<div class="{prefixCls}combobox-input-wrap"></div>',{prefixCls:i})),c=d.one("."+i+"combobox-input-wrap"),e=e||h.all(h.substitute('<input aria-haspopup="true" aria-autocomplete="list" aria-haspopup="true" role="autocomplete" autocomplete="off" class="{prefixCls}combobox-input" />',
{prefixCls:i})),c.append(e),this.setInternal("input",e));b||this.setInternal("trigger",h.all(h.substitute('<div class="{prefixCls}combobox-trigger"><div class="{prefixCls}combobox-trigger-inner">&#x25BC;</div></div>',{prefixCls:i})));this.get("trigger").unselectable();this.setInternal("invalidEl",l("<div class='"+i+"combobox-invalid-el'><div class='"+i+"combobox-invalid-inner'></div></div>").insertBefore(e.parent()));if(b=this.get("placeholder")){if(!(c=e.attr("id")))e.attr("id",c=h.guid("ks-combobox-input"));
this.setInternal("placeholderEl",l('<label for="'+c+'" class="'+i+'combobox-placeholder">'+b+"</label>").appendTo(d))}},getKeyEventTarget:function(){return this.get("input")},_onSetCollapsed:function(c){this.get("input").attr("aria-expanded",c)},_onSetHasTrigger:function(c){var e=this.get("trigger");c?this.get("el").prepend(e):e.remove()},_onSetDisabled:function(c){m.superclass._onSetDisabled.apply(this,arguments);this.get("input").attr("disabled",c)}},{ATTRS:{collapsed:{value:!0},hasTrigger:{value:!0},
input:{},trigger:{},placeholder:{},placeholderEl:{},invalidEl:{}},HTML_PARSER:{input:function(c){return c.one("."+this.get("prefixCls")+"combobox-input")},trigger:function(c){return c.one("."+this.get("prefixCls")+"combobox-trigger")}}});return m},{requires:["component/base"]});
