/*
Copyright 2012, KISSY UI Library v1.40dev
MIT Licensed
build time: Dec 20 22:23
*/
KISSY.add("combobox/base",function(e,c,i,k,j,h){function b(){this.get("input")[0].focus();p.call(this)}function a(g,a){var b=g.get("el"),f=g.get("prefixCls")+"combobox-invalid",h=g.get("invalidEl");a?(b.addClass(f),h.attr("title",a),h.show()):(b.removeClass(f),h.hide())}function f(g,a){var b=g.get("menu");if(b&&!b.isController)if(a)b=i.create(b,g),g.setInternal("menu",b);else return null;return b}function d(){var g=f(this);g&&g.get("visible")&&this.alignInternal()}function l(){var g=this;g._focusoutDismissTimer=
setTimeout(function(){g.set("collapsed",!0)},30)}function p(){var g;if(g=this._focusoutDismissTimer)clearTimeout(g),this._focusoutDismissTimer=null}function s(){var g;this._stopNotify||(g=this.getValueInternal(),g===h?this.set("collapsed",!0):(this._savedInputValue=g,this.sendRequest(g)))}function r(g){var a,b=[],h,d,l=f(this,1),g=this.normalizeData(g);l.removeChildren(!0);l.set("highlightedItem",null);if(g&&g.length){for(d=0;d<g.length;d++)a=g[d],b.push(l.addChild(a));g=this.getValueInternal();for(d=
0;d<b.length;d++)if(b[d].get("textContent")==g){l.set("highlightedItem",b[d]);h=!0;break}if(!h&&this.get("autoHighlightFirst"))for(d=0;d<b.length;d++)if(!b[d].get("disabled")){l.set("highlightedItem",b[d]);break}this.set("collapsed",!1)}else this.set("collapsed",!0)}var n,j=c.all,o=c.KeyCodes,q={points:["bl","tl"],overflow:{adjustX:1,adjustY:1}},m=j(e.Env.host);return n=i.Controller.extend({_savedInputValue:null,_stopNotify:0,normalizeData:function(g){var a,b,f;if(g&&g.length){g=g.slice(0,this.get("maxItemCount"));
a=this.get("format")?this.get("format").call(this,this.getValueInternal(),g):[];for(f=0;f<g.length;f++)b=g[f],a[f]=e.mix({content:b,textContent:b,value:b},a[f])}return a},bindUI:function(){this.get("input").on("valuechange",s,this)},getValueInternal:function(){return this.get("input").val()},setValueInternal:function(g){this.get("input").val(g)},alignInternal:function(){var g=this.get("menu"),a=e.clone(g.get("align"));a.node=this.get("el");e.mix(a,q,!1);g.set("align",a)},handleFocus:function(){var g;
a(this,!1);(g=this.get("placeholderEl"))&&g.hide()},handleBlur:function(){var g=this,b=g.get("placeholderEl"),f;n.superclass.handleBlur.apply(g,arguments);l.call(g);f=g.get("input");g.validate(function(b,d){b?!g.get("focused")&&d==f.val()&&a(g,b):a(g,!1)});b&&!f.val()&&b.show()},handleMouseDown:function(g){var a,b;n.superclass.handleMouseDown.apply(this,arguments);a=g.target;b=this.get("trigger");if(this.get("hasTrigger")&&(b[0]==a||b.contains(a)))a=this.get("input"),this.get("collapsed")?(a[0].focus(),
this.sendRequest("")):this.set("collapsed",!0),g.preventDefault()},handleKeyEventInternal:function(a){var b,d,l;d=f(this);if(!d)return h;this.get("input");if(b=this.get("updateInputOnDownUp"))this._stopNotify=e.inArray(a.keyCode,[o.UP,o.DOWN,o.ESC])?1:0;if(d.get("visible")){l=d.handleKeydown(a);if(a.keyCode==o.ESC)return this.set("collapsed",!0),b&&this.setValueInternal(this._savedInputValue),!0;d=d.get("activeItem");b&&e.inArray(a.keyCode,[o.DOWN,o.UP])&&this.setValueInternal(d.get("textContent"));
return a.keyCode==o.TAB&&d&&(d.performActionInternal(),this.get("multiple"))?!0:l}return a.keyCode==o.DOWN||a.keyCode==o.UP?(this.sendRequest(this.getValueInternal()),!0):h},syncUI:function(){var a,b;this.get("placeholder")&&(a=this.get("input"),b=this.get("inputValue"),b!=h&&a.val(b),a.val()||this.get("placeholderEl").show())},validate:function(a){var b=this.get("validator"),f=this.get("input").val();b?b(f,function(b){a(b,f)}):a(!1,f)},bindMenu:function(){var a=this,f,h;h=a.get("menu");h.on("click",
function(b){b=b.target.get("textContent");a._stopNotify=1;a.setValueInternal(b);a._savedInputValue=b;a.set("collapsed",!0);setTimeout(function(){a._stopNotify=0},50)});m.on("resize",a.__repositionBuffer=e.buffer(d,50),a);f=h.get("el");h=h.get("contentEl");f.on("focusout",l,a);f.on("focusin",p,a);h.on("mouseover",b,a);a.bindMenu=e.noop},sendRequest:function(a){this.get("dataSource").fetchData(a,r,this)},_onSetCollapsed:function(a){if(a)(a=f(this))&&a.hide();else{var a=this.get("el"),b=f(this,1);p.call(this);
b&&!b.get("visible")&&(b.render(),this.bindMenu(),this.get("matchElWidth")&&b.set("width",a.innerWidth()),b.show(),d.call(this),this.get("input").attr("aria-owns",b.get("el").attr("id")))}},destructor:function(){var a=this.__repositionBuffer;m.detach("resize",a,this);a.stop()}},{ATTRS:{input:{view:1},inputValue:{view:1},trigger:{view:1},placeholder:{view:1},placeholderEl:{view:1},validator:{},invalidEl:{view:1},allowTextSelection:{value:!0},hasTrigger:{view:1},menu:{value:{},setter:function(a){a&&
a.isController&&a.setInternal("parent",this)}},defaultChildXClass:{value:"popupmenu"},collapsed:{view:1},dataSource:{},maxItemCount:{value:99999},matchElWidth:{value:!0},format:{},updateInputOnDownUp:{value:!0},autoHighlightFirst:{},xrender:{value:k}}},{xclass:"combobox",priority:10})},{requires:["node","component/base","./render","menu"]});
KISSY.add("combobox",function(e,c,i,k,j,h){c.LocalDataSource=j;c.RemoteDataSource=h;c.FilterSelect=k;c.MultiValueComboBox=i;return c},{requires:["combobox/base","combobox/multi-value-combobox","combobox/filter-select","combobox/LocalDataSource","combobox/RemoteDataSource"]});
KISSY.add("combobox/cursor",function(e,c){function i(b){var a=j,f;a||(a=c.create(k));"textarea"==""+b.type?c.css(a,"width",c.css(b,"width")):c.css(a,"width",9999);e.each(h,function(f){c.css(a,f,c.css(b,f))});j||(f=b.ownerDocument.body,f.insertBefore(a,f.firstChild));return j=a}var k="<div style='z-index:-9999;overflow:hidden;position: fixed;left:-9999px;top:-9999px;opacity:0;white-space:pre-wrap;word-wrap:break-word;'></div>",j,h="paddingLeft,paddingTop,paddingBottom,paddingRight,marginLeft,marginTop,marginBottom,marginRight,borderLeftStyle,borderTopStyle,borderBottomStyle,borderRightStyle,borderLeftWidth,borderTopWidth,borderBottomWidth,borderRightWidth,line-height,outline,height,fontFamily,fontSize,fontWeight,fontVariant,fontStyle".split(",");
return function(b){var b=c.get(b),a=b.ownerDocument,f,d,h=b.scrollTop,p=b.scrollLeft;if(a.selection)return a=a.selection.createRange(),{left:a.boundingLeft+p+c.scrollLeft(),top:a.boundingTop+h+a.boundingHeight+c.scrollTop()};f=c.offset(b);if("textarea"!=b.type)return f.top+=b.offsetHeight,f;d=i(b);a=b.selectionStart;d.innerHTML=e.escapeHTML(b.value.substring(0,a-1))+"<span>x</span>";c.offset(d,f);f=d.lastChild;b=c.offset(f);b.top+=c.height(f);0<a&&(b.left+=c.width(f));b.top-=h;b.left-=p;return b}},
{requires:["dom"]});KISSY.add("combobox/filter-select",function(e,c){var i=c.extend({validate:function(c){var e=this;i.superclass.validate.call(e,function(h,b){h?c(h,b):e.get("dataSource").fetchData(b,function(a){a:{if(a=e.normalizeData(a))for(var f=0;f<a.length;f++)if(a[f].textContent==b){a=a[f];break a}a=!1}c(a?"":e.get("invalidMessage"),b,a)})})}},{ATTRS:{invalidMessage:{value:"invalid input"}}});return i},{requires:["./base"]});
KISSY.add("combobox/LocalDataSource",function(e){function c(){c.superclass.constructor.apply(this,arguments)}c.ATTRS={data:{value:[]},parse:{value:function(c,k){var j=[],h=0;if(!c)return k;e.each(k,function(b){-1!=b.indexOf(c)&&j.push(b);h++});return j}}};e.extend(c,e.Base,{fetchData:function(c,e,j){var h=this.get("parse"),b=this.get("data"),b=h(c,b);e.call(j,b)}});return c},{requires:["component/base"]});
KISSY.add("combobox/multi-value-combobox",function(e,c,i){function k(a,b){return b&&-1!=a.indexOf(b)}function j(a){var f=a.get("input"),d=f.val(),c=[],e=[],j=a.get("literal"),i=a.get("separator"),a=a.get("separatorType"),n=!1,o=a!=h,f=f.prop("selectionStart"),q,m,g=-1;for(q=0;q<d.length;q++)(m=d.charAt(q),j&&m==j&&(n=!n),n)?e.push(m):(q==f&&(g=c.length),o&&b.test(m))?(e.length&&c.push(e.join("")),e=[],e.push(m)):k(i,m)?a==h?(e.push(m),e.length&&c.push(e.join("")),e=[]):(e.length&&c.push(e.join("")),
e=[],e.push(m)):e.push(m);e.length&&c.push(e.join(""));c.length||c.push("");-1==g&&(a==h&&k(i,m)&&c.push(""),g=c.length-1);return{tokens:c,cursorPosition:f,tokenIndex:g}}var h="suffix",b=/\s|\xa0/;return i.extend({getValueInternal:function(){this.get("input");var a=j(this),b=a.tokens,d=a.tokenIndex,a=this.get("separator"),c=this.get("separatorType"),b=b[d],d=b.length-1;if(c!=h)if(k(a,b.charAt(0)))b=b.slice(1);else return;else c==h&&k(a,b.charAt(d))&&(b=b.slice(0,d));return b},setValueInternal:function(a){var f=
this.get("input"),d=j(this),c=d.tokens,d=Math.max(0,d.tokenIndex),e=this.get("separator"),i=this.get("separatorType"),r=c[d+1]||"",n=c[d];if(i!=h){if(c[d]=n.charAt(0)+a,!r||!b.test(r.charAt(0)))c[d]+=" "}else c[d]=a,a=n.length-1,k(e,n.charAt(a))?c[d]+=n.charAt(a):1==e.length&&(c[d]+=e);a=c.slice(0,d+1).join("").length;f.val(c.join(""));f.prop("selectionStart",a);f.prop("selectionEnd",a)},alignInternal:function(){if(this.get("alignWithCursor")){var a=j(this),b=a.tokens,d=this.get("menu"),h=a.cursorPosition,
e=a.tokenIndex,a=this.get("input"),b=b.slice(0,e).join("").length;0<b&&++b;a.prop("selectionStart",b);a.prop("selectionEnd",b);b=c(a);a.prop("selectionStart",h);a.prop("selectionEnd",h);d.set("xy",[b.left,b.top])}else i.prototype.alignInternal.apply(this,arguments)}},{ATTRS:{separator:{value:",;"},separatorType:{value:h},literal:{value:'"'},alignWithCursor:{}}},{xclass:"multi-value-combobox",priority:20})},{requires:["./cursor","./base"]});
KISSY.add("combobox/RemoteDataSource",function(e,c){function i(){i.superclass.constructor.apply(this,arguments);this.io=null;this.caches={}}i.ATTRS={paramName:{value:"q"},allowEmpty:{},cache:{},parse:{},xhrCfg:{value:{}}};e.extend(i,e.Base,{fetchData:function(e,i,h){var b=this,a,f=b.get("paramName"),d=b.get("parse"),l=b.get("cache"),p=b.get("allowEmpty");b.io&&(b.io.abort(),b.io=null);if(!e&&!0!==p)return i.call(h,[]);if(l&&(a=b.caches[e]))return i.call(h,a);a=b.get("xhrCfg");a.data=a.data||{};a.data[f]=
e;a.success=function(a){d&&(a=d(e,a));b.setInternal("data",a);l&&(b.caches[e]=a);i.call(h,a)};b.io=c(a)}});return i},{requires:["ajax"]});
KISSY.add("combobox/render",function(e,c,i){var k=e.all,j=c.Render.extend({createDom:function(){var c,b=this.get("input"),a=this.get("prefixCls"),f=this.get("el"),d=this.get("trigger");this.get("srcNode")||(f.append(e.substitute('<div class="{prefixCls}combobox-input-wrap"></div>',{prefixCls:a})),c=f.one("."+a+"combobox-input-wrap"),b=b||e.all(e.substitute('<input aria-haspopup="true" aria-autocomplete="list" aria-haspopup="true" role="autocomplete" autocomplete="off" class="{prefixCls}combobox-input" />',{prefixCls:a})),
c.append(b),this.setInternal("input",b));d||this.setInternal("trigger",e.all(e.substitute('<div class="{prefixCls}combobox-trigger"><div class="{prefixCls}combobox-trigger-inner">&#x25BC;</div></div>',{prefixCls:a})));this.get("trigger").unselectable(i);this.setInternal("invalidEl",k("<div class='"+a+"combobox-invalid-el'><div class='"+a+"combobox-invalid-inner'></div></div>").insertBefore(b.parent(i,i),i));if(d=this.get("placeholder")){if(!(c=b.attr("id")))b.attr("id",c=e.guid("ks-combobox-input"));
this.setInternal("placeholderEl",k('<label for="'+c+'" class="'+a+'combobox-placeholder">'+d+"</label>").appendTo(f))}},getKeyEventTarget:function(){return this.get("input")},_onSetCollapsed:function(c){this.get("input").attr("aria-expanded",c)},_onSetHasTrigger:function(c){var b=this.get("trigger");c?this.get("el").prepend(b):b.remove()},_onSetDisabled:function(c){j.superclass._onSetDisabled.apply(this,arguments);this.get("input").attr("disabled",c)}},{ATTRS:{collapsed:{value:!0},hasTrigger:{value:!0},
input:{},trigger:{},placeholder:{},placeholderEl:{},invalidEl:{}},HTML_PARSER:{input:function(c){return c.one("."+this.get("prefixCls")+"combobox-input")},trigger:function(c){return c.one("."+this.get("prefixCls")+"combobox-trigger")}}});return j},{requires:["component/base"]});
