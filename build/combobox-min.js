/*
Copyright 2012, KISSY UI Library v1.40dev
MIT Licensed
build time: Nov 22 19:05
*/
KISSY.add("combobox/base",function(e,m,h,n,d,k,l){function g(a,b){if(b){var c=b.get("textContent"),f=a.get("separatorType");v(a,c+(f==p?"":" "));a._savedInputValue=c}}function j(a,b){var c=a.get("el"),f=a.get("prefixCls")+"combobox-invalid",i=a.get("invalidEl");b?(c.addClass(f),i.attr("title",b),i.show()):(c.removeClass(f),i.hide())}function q(a,b){var c=a.get("menu");if(c&&c.xclass)if(b)c=h.create(c,a),a.setInternal("menu",c);else return null;return c}function r(){var a=q(this);if(a&&a.get("visible"))if(this.get("multiple")&&
this.get("alignWithCursor")){var b=w(this),c=b.tokens,a=this.get("menu"),f=b.cursorPosition,i=b.tokenIndex,b=this.get("input"),c=c.slice(0,i).join("").length;0<c&&++c;b.prop("selectionStart",c);b.prop("selectionEnd",c);c=b.prop("KsCursorOffset");b.prop("selectionStart",f);b.prop("selectionEnd",f);a.set("xy",[c.left,c.top])}else a=this.get("menu"),f=e.clone(a.get("align")),f.node=this.get("el"),e.mix(f,z,!1),a.set("align",f)}function s(){var a=this;a._focusoutDismissTimer=setTimeout(function(){a.set("collapsed",
!0)},30)}function t(){var a;if(a=this._focusoutDismissTimer)clearTimeout(a),this._focusoutDismissTimer=null}function v(a,b){var c=a.get("input");if(a.get("multiple")){var f=w(a),i=f.tokens,f=Math.max(0,f.tokenIndex),d=a.get("separator"),g=a.get("separatorType"),e=i[f];i[f]=e&&-1!=d.indexOf(e.charAt(0))?e.charAt(0):"";i[f]+=b;e=i[f+1];if(g==p&&(!e||-1==d.indexOf(e.charAt(0))))i[f]+=d.charAt(0);f=i.slice(0,f+1).join("").length;c.val(i.join(""));c.prop("selectionStart",f);c.prop("selectionEnd",f)}else c.val(b)}
function u(a){var b=a.get("input").val();if(a.get("multiple")){var c=w(a),b=c.tokens,c=c.tokenIndex,f=a.get("separator"),a=a.get("separatorType");return(b=b[c]||"")&&-1!=f.indexOf(b.charAt(0))?b.substring(1):a==p&&(0==c||-1==c)?b:l}return b}function A(){if(!this._stopNotify){var a=u(this);a===l?this.set("collapsed",!0):(this._savedInputValue=a,this.sendRequest(a))}}function B(a){var b,c=[],f,i,d=q(this,1),a=this.normalizeData(a);d.removeChildren(!0);if(a&&a.length){for(i=0;i<a.length;i++)b=a[i],c.push(d.addChild(e.mix({xclass:"menuitem"},
b)));a=u(this);for(i=0;i<c.length;i++)if(c[i].get("textContent")==a){d.set("highlightedItem",c[i]);f=!0;break}if(!f&&this.get("autoHighlightFirst"))for(i=0;i<c.length;i++)if(!c[i].get("disabled")){d.set("highlightedItem",c[i]);break}this.set("collapsed",!1)}else this.set("collapsed",!0)}function w(a){for(var b=a.get("input"),c=b.val(),f=[],d=[],g=a.get("literal"),e=a.get("separator"),l=!1,a=a.get("whitespace"),b=b.prop("selectionStart"),k=-1,j=0;j<c.length;j++){var h=c.charAt(j);j==b&&(k=f.length);
if(!l&&(!a&&/\s|\xa0/.test(h)&&(f.push(d.join("")),d=[]),-1!=e.indexOf(h)))f.push(d.join("")),d=[];g&&h==g&&(l=!l);d.push(h)}d.length&&f.push(d.join(""));-1==k&&(k=f.length-1);return{tokens:f,cursorPosition:b,tokenIndex:k}}var x,d=m.all,o=m.KeyCodes,z={points:["bl","tl"],overflow:{adjustX:1,adjustY:1}},y=d(e.Env.host),p="suffix";return x=h.Controller.extend({_savedInputValue:null,_stopNotify:0,normalizeData:function(a){var b,c,f;if(a&&a.length){a=a.slice(0,this.get("maxItemCount"));b=this.get("format")?
this.get("format").call(this,u(this),a):[];for(f=0;f<a.length;f++)c=a[f],b[f]=e.mix({content:c,textContent:c,value:c},b[f])}return b},bindUI:function(){this.get("input").on("valuechange",A,this)},handleFocus:function(){var a;j(this,!1);(a=this.get("placeholderEl"))&&a.hide()},handleBlur:function(){var a=this;x.superclass.handleBlur.apply(a,arguments);s.call(a);var b,c=a.get("input");a.validate(function(b,d){b?!a.get("focused")&&d==c.val()&&j(a,b):j(a,!1)});(b=a.get("placeholderEl"))&&!c.val()&&b.show()},
handleMouseDown:function(a){x.superclass.handleMouseDown.apply(this,arguments);var b;b=a.target;var c=this.get("trigger");if(this.get("hasTrigger")&&(c[0]==b||c.contains(b)))b=this.get("input"),this.get("collapsed")?(b[0].focus(),this.sendRequest("")):this.set("collapsed",!0),a.preventDefault()},handleKeyEventInternal:function(a){this.get("input");var b=q(this);if(b){var c=this.get("updateInputOnDownUp");c&&(this._stopNotify=e.inArray(a.keyCode,[o.UP,o.DOWN,o.ESC])?1:0);var d;if(b.get("visible")){var g=
b.handleKeydown(a);c&&e.inArray(a.keyCode,[o.DOWN,o.UP])&&v(this,b.get("activeItem").get("textContent"));if(a.keyCode==o.ESC)return this.set("collapsed",!0),c&&v(this,this._savedInputValue),!0;if(a.keyCode==o.TAB&&(d=b.get("activeItem")))if(d.performActionInternal(),this.get("multiple"))return!0;return g}if(a.keyCode==o.DOWN||a.keyCode==o.UP)return this.sendRequest(u(this)),!0}},syncUI:function(){if(this.get("placeholder")){var a=this.get("input"),b=this.get("inputValue");b!=l&&a.val(b);a.val()||
this.get("placeholderEl").show()}},validate:function(a){var b=this.get("validator"),c=this.get("input").val();b?b(c,function(b){a(b,c)}):a(!1,c)},bindMenu:function(){var a=this,b,c;c=a.get("menu");c.on("click",function(b){b=b.target;a._stopNotify=1;g(a,b);a.set("collapsed",!0);setTimeout(function(){a._stopNotify=0},50)});a.__repositionBuffer=e.buffer(r,50);y.on("resize",a.__repositionBuffer,a);b=c.get("el");c=c.get("contentEl");b.on("focusout",s,a);b.on("focusin",t,a);c.on("mouseover",function(){a.get("input")[0].focus();
t.call(a)});a.bindMenu=e.noop},sendRequest:function(a){this.get("dataSource").fetchData(a,B,this)},_onSetCollapsed:function(a){if(a)(a=q(this))&&a.hide();else{var a=this.get("el"),b=q(this,1);t.call(this);b&&!b.get("visible")&&(b.render(),this.bindMenu(),this.get("matchElWidth")&&b.set("width",a.innerWidth()),b.show(),r.call(this),this.get("input").attr("aria-owns",b.get("el")[0].id))}},destructor:function(){y.detach("resize",this.__repositionBuffer,this);this.__repositionBuffer.stop()}},{ATTRS:{input:{view:1},
trigger:{view:1},placeholder:{view:1},placeholderEl:{view:1},validator:{},invalidEl:{view:1},allowTextSelection:{value:!0},hasTrigger:{view:1},menu:{value:{xclass:"popupmenu"},setter:function(a){a instanceof h.Controller&&a.setInternal("parent",this)}},collapsed:{view:1},dataSource:{setter:function(a){return h.create(a)}},maxItemCount:{value:99999},matchElWidth:{value:!0},format:{},multiple:{},separator:{value:",;"},separatorType:{value:p},whitespace:{valueFn:function(){return this.get("separatorType")==
p}},updateInputOnDownUp:{value:!0},literal:{value:'"'},alignWithCursor:{},autoHighlightFirst:{},xrender:{value:n}}},{xclass:"combobox",priority:10})},{requires:["node","component/base","./render","input-selection","menu"]});KISSY.add("combobox",function(e,m,h,n,d){m.LocalDataSource=n;m.RemoteDataSource=d;m.FilterSelect=h;return m},{requires:["combobox/base","combobox/filter-select","combobox/LocalDataSource","combobox/RemoteDataSource"]});
KISSY.add("combobox/filter-select",function(e,m){var h=m.extend({validate:function(e){var d=this;h.superclass.validate.call(this,function(k,l){k?e(k,l):d.get("dataSource").fetchData(l,function(g){a:{if(g=d.normalizeData(g))for(var k=0;k<g.length;k++)if(g[k].textContent==l){g=g[k];break a}g=!1}e(g?"":d.get("invalidMessage"),l,g)})})}},{ATTRS:{invalidMessage:{value:"invalid input"}}});return h},{requires:["./base"]});
KISSY.add("combobox/LocalDataSource",function(e,m){function h(){h.superclass.constructor.apply(this,arguments)}h.ATTRS={data:{value:[]},parse:{value:function(h,d){var k=[],l=0;if(!h)return d;e.each(d,function(d){-1!=d.indexOf(h)&&k.push(d);l++});return k}}};e.extend(h,e.Base,{fetchData:function(e,d,k){var h=this.get("parse"),g=this.get("data"),g=h(e,g);d.call(k,g)}});m.Manager.setConstructorByXClass("combobox-LocalDataSource",h);return h},{requires:["component/base"]});
KISSY.add("combobox/RemoteDataSource",function(e,m,h){function n(){n.superclass.constructor.apply(this,arguments);this.io=null;this.caches={}}n.ATTRS={paramName:{value:"q"},allowEmpty:{},cache:{},parse:{},xhrCfg:{value:{}}};e.extend(n,e.Base,{fetchData:function(d,e,h){var g=this,j,n=g.get("paramName"),r=g.get("parse"),s=g.get("cache"),t=g.get("allowEmpty");g.io&&(g.io.abort(),g.io=null);if(!d&&!0!==t)return e.call(h,[]);if(s&&(j=g.caches[d]))return e.call(h,j);j=g.get("xhrCfg");j.data=j.data||{};
j.data[n]=d;j.success=function(j){r&&(j=r(d,j));g.setInternal("data",j);s&&(g.caches[d]=j);e.call(h,j)};g.io=m(j)}});h.Manager.setConstructorByXClass("combobox-RemoteDataSource",n);return n},{requires:["ajax","component/base"]});
KISSY.add("combobox/render",function(e,m){var h=e.all,n=m.Render.extend({createDom:function(){var d,k=this.get("input"),l=this.get("prefixCls"),g=this.get("el"),j=this.get("trigger");this.get("srcNode")||(g.append(e.substitute('<div class="{prefixCls}combobox-input-wrap"></div>',{prefixCls:l})),d=g.one("."+l+"combobox-input-wrap"),k=k||e.all(e.substitute('<input aria-haspopup="true" aria-autocomplete="list" aria-haspopup="true" role="autocomplete" autocomplete="off" class="{prefixCls}combobox-input" />',
{prefixCls:l})),d.append(k),this.setInternal("input",k));j||this.setInternal("trigger",e.all(e.substitute('<div class="{prefixCls}combobox-trigger"><div class="{prefixCls}combobox-trigger-inner">&#x25BC;</div></div>',{prefixCls:l})));this.get("trigger").unselectable();this.setInternal("invalidEl",h("<div class='"+l+"combobox-invalid-el'><div class='"+l+"combobox-invalid-inner'></div></div>").insertBefore(k.parent()));if(j=this.get("placeholder")){if(!(d=k.attr("id")))k.attr("id",d=e.guid("ks-combobox-input"));
this.setInternal("placeholderEl",h('<label for="'+d+'" class="'+l+'combobox-placeholder">'+j+"</label>").appendTo(g))}},getKeyEventTarget:function(){return this.get("input")},_onSetCollapsed:function(d){this.get("input").attr("aria-expanded",d)},_onSetHasTrigger:function(d){var e=this.get("trigger");d?this.get("el").prepend(e):e.remove()},_onSetDisabled:function(d){n.superclass._onSetDisabled.apply(this,arguments);this.get("input").attr("disabled",d)}},{ATTRS:{collapsed:{value:!0},hasTrigger:{value:!0},
input:{},trigger:{},placeholder:{},placeholderEl:{},invalidEl:{}},HTML_PARSER:{input:function(d){return d.one("."+this.get("prefixCls")+"combobox-input")},trigger:function(d){return d.one("."+this.get("prefixCls")+"combobox-trigger")}}});return n},{requires:["component/base"]});
