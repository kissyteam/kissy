var KISSY=KISSY||{};(function(t){var c=YAHOO.util,b=c.Dom,y=c.Event,d=YAHOO.lang,e=document.getElementsByTagName("head")[0],p=YAHOO.env.ua.ie,h=(p===6),r="KISSY.Suggest.callback",m="suggest-style",v="text/css",l="text/javascript",n="beforeDataRequest",j="onDataReturn",f="beforeShow",s="onItemSelect",w="absolute",u="hidden",k="none",i="px",x="undefined",a="span",g="li",q="div",o={containerClassName:"suggest-container",containerWidth:"auto",keyElClassName:"suggest-key",resultElClassName:"suggest-result",resultFormat:"\u7ea6%result%\u6761\u7ed3\u679c",selectedItemClassName:"selected",bottomClassName:"suggest-bottom",showCloseBtn:false,closeBtnText:"\u5173\u95ed",closeBtnClassName:"suggest-close-btn",useShim:h,shimClassName:"suggest-shim",timerDelay:200,autoFocus:false,submitFormOnClickSelect:true};t.Suggest=function(A,B,z){this.textInput=b.get(A);this.dataSource=B;this.JSONDataSource=d.isObject(B)?B:null;this.returnedData=null;this.config=d.merge(o,z||{});this.container=null;this.query="";this.queryParams="";this._timer=null;this._isRunning=false;this.dataScript=null;this._dataCache={};this._latestScriptTime="";this._scriptDataIsOut=false;this._onKeyboardSelecting=false;this.selectedItem=null;this._init()};t.Suggest.prototype={_init:function(){this._initTextInput();this._initContainer();if(this.config.useShim){this._initShim()}this._initStyle();this.createEvent(n);this.createEvent(j);this.createEvent(f);this.createEvent(s);this._initResizeEvent()},_initTextInput:function(){var z=this;this.textInput.setAttribute("autocomplete","off");y.on(this.textInput,"focus",function(){z.start()});y.on(this.textInput,"blur",function(){z.stop();z.hide()});if(this.config.autoFocus){this.textInput.focus()}var A=0;y.on(this.textInput,"keydown",function(B){var C=B.charCode||B.keyCode;switch(C){case 27:z.hide();z.textInput.value=z.query;break;case 13:z.textInput.blur();if(z._onKeyboardSelecting){if(z.textInput.value==z._getSelectedItemKey()){z.fireEvent(s,z.textInput.value)}}z._submitForm();break;case 40:case 38:if(A++==0){if(z._isRunning){z.stop()}z._onKeyboardSelecting=true;z.selectItem(C==40)}else{if(A==3){A=0}}break}if(C!=40&&C!=38){if(!z._isRunning){z.start()}z._onKeyboardSelecting=false}});y.on(this.textInput,"keyup",function(){A=0})},_initContainer:function(){var z=document.createElement(q);z.className=this.config.containerClassName;z.style.position=w;z.style.visibility=u;this.container=z;this._setContainerRegion();this._initContainerEvent();document.body.insertBefore(z,document.body.firstChild)},_setContainerRegion:function(){var B=b.getRegion(this.textInput);var C=B.left,z=B.right-C-2;var A=document.documentMode;if(A===7&&(p===7||p===8)){C-=2}else{if(YAHOO.env.ua.gecko){C++}}this.container.style.left=C+i;this.container.style.top=B.bottom+i;if(this.config.containerWidth=="auto"){this.container.style.width=z+i}else{this.container.style.width=this.config.containerWidth}},_initContainerEvent:function(){var z=this;y.on(this.container,"mousemove",function(B){var C=y.getTarget(B);if(C.nodeName!="LI"){C=b.getAncestorByTagName(C,g)}if(b.isAncestor(z.container,C)){if(C!=z.selectedItem){z._removeSelectedItem();z._setSelectedItem(C)}}});var A=null;this.container.onmousedown=function(B){B=B||window.event;A=B.target||B.srcElement;z.textInput.onbeforedeactivate=function(){window.event.returnValue=false;z.textInput.onbeforedeactivate=null};return false};y.on(this.container,"mouseup",function(B){if(!z._isInContainer(y.getXY(B))){return}var C=y.getTarget(B);if(C!=A){return}if(C.className==z.config.closeBtnClassName){z.hide();return}if(C.nodeName!="LI"){C=b.getAncestorByTagName(C,g)}if(b.isAncestor(z.container,C)){z._updateInputFromSelectItem(C);z.fireEvent(s,z.textInput.value);z.textInput.blur();z._submitForm()}})},_submitForm:function(){if(this.config.submitFormOnClickSelect){var A=this.textInput.form;if(!A){return}if(document.createEvent){var z=document.createEvent("MouseEvents");z.initEvent("submit",true,false);A.dispatchEvent(z)}else{if(document.createEventObject){A.fireEvent("onsubmit")}}A.submit()}},_isInContainer:function(A){var z=b.getRegion(this.container);return A[0]>=z.left&&A[0]<=z.right&&A[1]>=z.top&&A[1]<=z.bottom},_initShim:function(){var z=document.createElement("iframe");z.src="about:blank";z.className=this.config.shimClassName;z.style.position=w;z.style.visibility=u;z.style.border=k;this.container.shim=z;this._setShimRegion();document.body.insertBefore(z,document.body.firstChild)},_setShimRegion:function(){var z=this.container,A=z.shim;if(A){A.style.left=(parseInt(z.style.left)-2)+i;A.style.top=z.style.top;A.style.width=(parseInt(z.style.width)+2)+i}},_initStyle:function(){var A=b.get(m);if(A){return}var z=".suggest-container{background:white;border:1px solid #999;z-index:99999}";z+=".suggest-shim{z-index:99998}";z+=".suggest-container li{color:#404040;padding:1px 0 2px;font-size:12px;line-height:18px;float:left;width:100%}";z+=".suggest-container li.selected{background-color:#39F;cursor:default}";z+=".suggest-key{float:left;text-align:left;padding-left:5px}";z+=".suggest-result{float:right;text-align:right;padding-right:5px;color:green}";z+=".suggest-container li.selected span{color:#FFF;cursor:default}";z+=".suggest-bottom{padding:0 5px 5px}";z+=".suggest-close-btn{float:right}";z+=".suggest-container li,.suggest-bottom{overflow:hidden;zoom:1;clear:both}";z+=".suggest-container{*margin-left:2px;_margin-left:-2px;_margin-top:-3px}";A=document.createElement("style");A.id=this.config.styleElId;A.type=v;e.appendChild(A);if(A.styleSheet){A.styleSheet.cssText=z}else{A.appendChild(document.createTextNode(z))}},_initResizeEvent:function(){var A=this,z;y.on(window,"resize",function(){if(z){clearTimeout(z)}z=setTimeout(function(){A._setContainerRegion();A._setShimRegion()},50)})},start:function(){t.Suggest.focusInstance=this;var z=this;z._timer=setTimeout(function(){z.updateData();z._timer=setTimeout(arguments.callee,z.config.timerDelay)},z.config.timerDelay);this._isRunning=true},stop:function(){t.Suggest.focusInstance=null;clearTimeout(this._timer);this._isRunning=false},show:function(){if(this.isVisible()){return}var z=this.container,B=z.shim;z.style.visibility="";if(B){if(!B.style.height){var A=b.getRegion(z);B.style.height=(A.bottom-A.top-2)+i}B.style.visibility=""}},hide:function(){if(!this.isVisible()){return}var z=this.container,A=z.shim;if(A){A.style.visibility=u}z.style.visibility=u},isVisible:function(){return this.container.style.visibility!=u},updateData:function(){if(!this._needUpdate()){return}this._updateQueryValueFromInput();var z=this.query;if(!d.trim(z).length){this._fillContainer("");this.hide();return}if(typeof this._dataCache[z]!=x){this.returnedData="using cache";this._fillContainer(this._dataCache[z]);this._displayContainer()}else{if(this.JSONDataSource){this.handleResponse(this.JSONDataSource[z])}else{this.requestData()}}},_needUpdate:function(){return this.textInput.value!=this.query},requestData:function(){if(!p){this.dataScript=null}if(!this.dataScript){var z=document.createElement("script");z.type=l;z.charset="utf-8";e.insertBefore(z,e.firstChild);this.dataScript=z;if(!p){var A=new Date().getTime();this._latestScriptTime=A;z.setAttribute("time",A);y.on(z,"load",function(){this._scriptDataIsOut=z.getAttribute("time")!=this._latestScriptTime},this,true)}}this.queryParams="q="+encodeURIComponent(this.query)+"&code=utf-8&callback="+r;this.fireEvent(n,this.query);this.dataScript.src=this.dataSource+"?"+this.queryParams},handleResponse:function(F){console.log("handle response");if(this._scriptDataIsOut){return}this.returnedData=F;this.fireEvent(j,F);this.returnedData=this.formatData(this.returnedData);var D="";var B=this.returnedData.length;if(B>0){var E=document.createElement("ol");for(var C=0;C<B;++C){var A=this.returnedData[C];var z=this.formatItem(A.key,A.result);z.setAttribute("key",A.key);E.appendChild(z)}D=E}this._fillContainer(D);if(B>0){this.appendBottom()}if(d.trim(this.container.innerHTML)){this.fireEvent(f,this.container)}this._dataCache[this.query]=this.container.innerHTML;this._displayContainer()},formatData:function(D){var A=[];if(!D){return A}if(d.isArray(D.result)){D=D.result}var z=D.length;if(!z){return A}var C;for(var B=0;B<z;++B){C=D[B];if(d.isString(C)){A[B]={key:C}}else{if(d.isArray(C)&&C.length>=2){A[B]={key:C[0],result:C[1]}}else{A[B]=C}}}return A},formatItem:function(B,A){var z=document.createElement(g);var D=document.createElement(a);D.className=this.config.keyElClassName;D.appendChild(document.createTextNode(B));z.appendChild(D);if(typeof A!=x){var C=this.config.resultFormat.replace("%result%",A);if(d.trim(C)){var E=document.createElement(a);E.className=this.config.resultElClassName;E.appendChild(document.createTextNode(C));z.appendChild(E)}}return z},appendBottom:function(){var z=document.createElement(q);z.className=this.config.bottomClassName;if(this.config.showCloseBtn){var A=document.createElement("a");A.href="javascript: void(0)";A.setAttribute("target","_self");A.className=this.config.closeBtnClassName;A.appendChild(document.createTextNode(this.config.closeBtnText));z.appendChild(A)}if(d.trim(z.innerHTML)){this.container.appendChild(z)}},_fillContainer:function(z){if(z.nodeType==1){this.container.innerHTML="";this.container.appendChild(z)}else{this.container.innerHTML=z}this.selectedItem=null},_displayContainer:function(){if(d.trim(this.container.innerHTML)){this.show()}else{this.hide()}},selectItem:function(B){var A=this.container.getElementsByTagName(g);if(A.length==0){return}if(!this.isVisible()){this.show();return}var z;if(!this.selectedItem){z=A[B?0:A.length-1]}else{z=b[B?"getNextSibling":"getPreviousSibling"](this.selectedItem);if(!z){this.textInput.value=this.query}}this._removeSelectedItem();if(z){this._setSelectedItem(z);this._updateInputFromSelectItem()}},_removeSelectedItem:function(){b.removeClass(this.selectedItem,this.config.selectedItemClassName);this.selectedItem=null},_setSelectedItem:function(z){b.addClass((z),this.config.selectedItemClassName);this.selectedItem=(z)},_getSelectedItemKey:function(){if(!this.selectedItem){return""}return this.selectedItem.getAttribute("key")},_updateQueryValueFromInput:function(){this.query=this.textInput.value},_updateInputFromSelectItem:function(){this.textInput.value=this._getSelectedItemKey(this.selectedItem)}};d.augmentProto(t.Suggest,c.EventProvider);t.Suggest.focusInstance=null;t.Suggest.callback=function(z){if(!t.Suggest.focusInstance){return}setTimeout(function(){t.Suggest.focusInstance.handleResponse(z)},0)}})(KISSY);
