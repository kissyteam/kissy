/*
Copyright 2010, KISSY UI Library v1.1.0
MIT Licensed
build time: Jul 27 11:06
*/
KISSY.add("suggest",function(e,m){function h(a,b,c){if(!(this instanceof h))return new h(a,b,c);this.textInput=e.get(a);this.dataSource=b;this.JSONDataSource=e.isPlainObject(b)?b:null;this.returnedData=null;this.config=e.merge(o,c||{});this.container=null;this.queryParams=this.query="";this._timer=null;this._isRunning=false;this.dataScript=null;this._dataCache={};this._latestScriptTime="";this._onKeyboardSelecting=this._scriptDataIsOut=false;this.selectedItem=null;this._init()}var g=e.DOM,i=e.Event,
k=window,d=document,n=d.getElementsByTagName("head")[0],l=e.UA.ie,o={containerCls:"",containerWidth:"",resultFormat:"\u7ea6%result%\u6761\u7ed3\u679c",showCloseBtn:false,closeBtnText:"\u5173\u95ed",useShim:l===6,timerDelay:200,autoFocus:false,submitFormOnClickSelect:true};e.augment(h,e.EventTarget,{_init:function(){this._initTextInput();this._initContainer();this.config.useShim&&this._initShim();this._initStyle();this._initResizeEvent()},_initTextInput:function(){var a=this;a.textInput.setAttribute("autocomplete",
"off");i.on(a.textInput,"blur",function(){a.stop();a.hide()});a.config.autoFocus&&a.textInput.focus();var b=0;i.on(a.textInput,"keydown",function(c){c=c.keyCode;switch(c){case 27:a.hide();a.textInput.value=a.query;a.query.length===0&&a.textInput.blur();break;case 13:a.textInput.blur();a._onKeyboardSelecting&&a.textInput.value==a._getSelectedItemKey()&&a.fire("itemSelect");a._submitForm();break;case 40:case 38:if(b++==0){a._isRunning&&a.stop();a._onKeyboardSelecting=true;a.selectItem(c===40)}else if(b==
3)b=0;break}if(c!=40&&c!=38){a._isRunning||a.start();a._onKeyboardSelecting=false}});i.on(a.textInput,"keyup",function(){b=0})},_initContainer:function(){var a=d.createElement("div"),b=this.config.containerCls;a.className="ks-suggest-container";if(b)a.className+=" "+b;a.style.position="absolute";a.style.visibility="hidden";this.container=a;this._setContainerRegion();this._initContainerEvent();d.body.insertBefore(a,d.body.firstChild)},_setContainerRegion:function(){var a=this.textInput,b=g.offset(a),
c=this.container;g.offset(c,{left:b.left,top:b.top+a.offsetHeight-1});g.width(c,this.config.containerWidth||a.offsetWidth-2)},_initContainerEvent:function(){var a=this;i.on(a.container,"mousemove",function(c){c=c.target;if(c.nodeName!=="LI")c=g.parent(c,".li");if(g.contains(a.container,c))if(c!==a.selectedItem){a._removeSelectedItem();a._setSelectedItem(c)}});var b=null;i.on(a.container,"mousedown",function(c){b=c.target;a.textInput.onbeforedeactivate=function(){k.event.returnValue=false;a.textInput.onbeforedeactivate=
null};return false});i.on(a.container,"mouseup",function(c){if(a._isInContainer([c.pageX,c.pageY])){c=c.target;if(c==b)if(c.className=="ks-suggest-close-btn")a.hide();else{if(c.nodeName!="LI")c=g.parent(c,".li");if(g.contains(a.container,c)){a._updateInputFromSelectItem(c);a.fire("itemSelect");a.textInput.blur();a._submitForm()}}}})},_submitForm:function(){if(this.config.submitFormOnClickSelect){var a=this.textInput.form;if(a){if(d.createEvent){var b=d.createEvent("MouseEvents");b.initEvent("submit",
true,false);a.dispatchEvent(b)}else d.createEventObject&&a.fireEvent("onsubmit");a.submit()}}},_isInContainer:function(a){var b=this._getContainerRegion();return a[0]>=b.left&&a[0]<=b.right&&a[1]>=b.top&&a[1]<=b.bottom},_initShim:function(){var a=d.createElement("iframe");a.src="about:blank";a.className="ks-suggest-shim";a.style.position="absolute";a.style.visibility="hidden";a.style.border="none";this.container.shim=a;this._setShimRegion();d.body.insertBefore(a,d.body.firstChild)},_setShimRegion:function(){var a=
this.container,b=a.shim;if(b){b.style.left=parseInt(a.style.left)-2+"px";b.style.top=a.style.top;b.style.width=parseInt(a.style.width)+2+"px"}},_initStyle:function(){e.get("#ks-suggest-style")||g.addStyleSheet(".ks-suggest-container{background:white;border:1px solid #999;z-index:99999}.ks-suggest-shim{z-index:99998}.ks-suggest-container li{color:#404040;padding:1px 0 2px;font-size:12px;line-height:18px;float:left;width:100%}.ks-suggest-container li.selected{background-color:#39F;cursor:default}.ks-suggest-key{float:left;text-align:left;padding-left:5px}.ks-suggest-result{float:right;text-align:right;padding-right:5px;color:green}.ks-suggest-container li.selected span{color:#FFF;cursor:default}.ks-suggest-bottom{padding:0 5px 5px}.ks-suggest-close-btn{float:right}.ks-suggest-container li,.suggest-bottom{overflow:hidden;zoom:1;clear:both}.ks-suggest-container{*margin-left:2px;_margin-left:-2px;_margin-top:-3px}",
"ks-suggest-style")},_initResizeEvent:function(){var a=this,b;i.on(k,"resize",function(){b&&clearTimeout(b);b=setTimeout(function(){a._setContainerRegion();a._setShimRegion()},50)})},start:function(){var a=this;h.focusInstance=a;a._timer=setTimeout(function(){a.updateContent();a._timer=setTimeout(arguments.callee,a.config.timerDelay)},a.config.timerDelay);a._isRunning=true},stop:function(){h.focusInstance=null;clearTimeout(this._timer);this._isRunning=false},show:function(){if(!this.isVisible()){var a=
this.container,b=a.shim;a.style.visibility="";if(b){if(!b.style.height)b.style.height=a.offsetHeight-2+"px";b.style.visibility=""}}},hide:function(){if(this.isVisible()){var a=this.container,b=a.shim;if(b)b.style.visibility="hidden";a.style.visibility="hidden"}},isVisible:function(){return this.container.style.visibility!="hidden"},updateContent:function(){if(this._needUpdate()){this._updateQueryValueFromInput();var a=this.query;if(e.trim(a).length)if(this._dataCache[a]!==m){this.returnedData="using cache";
this._fillContainer(this._dataCache[a]);this._displayContainer()}else this.JSONDataSource?this.handleResponse(this.JSONDataSource[a]):this.requestData();else{this._fillContainer("");this.hide()}}},_needUpdate:function(){return this.textInput.value!=this.query},requestData:function(){var a=this;if(!l)a.dataScript=null;if(!a.dataScript){var b=d.createElement("script");b.charset="utf-8";n.insertBefore(b,n.firstChild);a.dataScript=b;if(!l){var c=(new Date).getTime();a._latestScriptTime=c;b.setAttribute("time",
c);i.on(b,"load",function(){a._scriptDataIsOut=b.getAttribute("time")!=a._latestScriptTime})}}a.queryParams="q="+encodeURIComponent(a.query)+"&code=utf-8&callback=g_ks_suggest_callback";a.fire("dataRequest");a.dataScript.src=a.dataSource+"?"+a.queryParams},handleResponse:function(a){if(!this._scriptDataIsOut){this.returnedData=a;this.fire("dataReturn");this.returnedData=this.formatData(this.returnedData);var b="";a=this.returnedData.length;if(a>0){b=d.createElement("ol");for(var c=0;c<a;++c){var f=
this.returnedData[c],j=this.formatItem(f.key,f.result);j.setAttribute("key",f.key);g.addClass(j,c%2?"even":"odd");b.appendChild(j)}b=b}this._fillContainer(b);a>0&&this.appendBottom();e.trim(this.container.innerHTML)&&this.fire("show");this._dataCache[this.query]=this.container.innerHTML;this._displayContainer()}},formatData:function(a){var b=[];if(!a)return b;if(e.isArray(a.result))a=a.result;var c=a.length;if(!c)return b;for(var f,j=0;j<c;++j){f=a[j];b[j]=typeof f==="string"?{key:f}:e.isArray(f)&&
f.length>=2?{key:f[0],result:f[1]}:f}return b},formatItem:function(a,b){var c=d.createElement("li"),f=d.createElement("span");f.className="ks-suggest-key";f.appendChild(d.createTextNode(a));c.appendChild(f);if(b!==m){a=this.config.resultFormat.replace("%result%",b);if(e.trim(a)){b=d.createElement("span");b.className="ks-suggest-result";b.appendChild(d.createTextNode(a));c.appendChild(b)}}return c},appendBottom:function(){var a=d.createElement("div");a.className="ks-suggest-bottom";if(this.config.showCloseBtn){var b=
d.createElement("a");b.href="javascript: void(0)";b.setAttribute("target","_self");b.className="ks-suggest-close-btn";b.appendChild(d.createTextNode(this.config.closeBtnText));a.appendChild(b)}e.trim(a.innerHTML)&&this.container.appendChild(a)},_fillContainer:function(a){if(a.nodeType==1){this.container.innerHTML="";this.container.appendChild(a)}else this.container.innerHTML=a;this.selectedItem=null},_displayContainer:function(){e.trim(this.container.innerHTML)?this.show():this.hide()},selectItem:function(a){var b=
this.container.getElementsByTagName("li");if(b.length!=0)if(this.isVisible()){if(this.selectedItem){a=g[a?"next":"prev"](this.selectedItem);if(!a)this.textInput.value=this.query}else a=b[a?0:b.length-1];this._removeSelectedItem();if(a){this._setSelectedItem(a);this._updateInputFromSelectItem()}}else this.show()},_removeSelectedItem:function(){g.removeClass(this.selectedItem,"selected");this.selectedItem=null},_setSelectedItem:function(a){g.addClass(a,"selected");this.selectedItem=a},_getSelectedItemKey:function(){if(!this.selectedItem)return"";
return this.selectedItem.getAttribute("key")},_updateQueryValueFromInput:function(){this.query=this.textInput.value},_updateInputFromSelectItem:function(){this.textInput.value=this._getSelectedItemKey(this.selectedItem)},_getContainerRegion:function(){var a=this.container,b=g.offset(a),c=b.left;b=b.top;return{left:c,top:b,right:c+a.offsetWidth-1,bottom:b+a.offsetHeight-1}}});k.g_ks_suggest_callback=function(a){h.focusInstance&&setTimeout(function(){h.focusInstance.handleResponse(a)},0)};e.Suggest=
h});
