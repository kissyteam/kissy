/*
Copyright 2012, KISSY UI Library v1.40dev
MIT Licensed
build time: Nov 22 17:43
*/
KISSY.add("dd/base",function(e,j,l,h){e={Draggable:l,DDM:j,DraggableDelegate:h};return KISSY.DD=e},{requires:["./base/ddm","./base/draggable","./base/draggable-delegate"]});
KISSY.add("dd/base/ddm",function(e,j,l,h,g,s){function d(){d.superclass.constructor.apply(this,arguments)}function t(b,a,f){var q=f.get("mode"),c=b.get("validDrops"),i=0,d=0,g=k(f.get("node")),v=n(g);e.each(c,function(b){var c;if(c=b.getNodeFromTarget(a,f.get("dragNode")[0],f.get("node")[0]))if("point"==q)r(k(c),f.mousePos)&&(c=n(k(c)),i?c<d&&(i=b,d=c):(i=b,d=c));else if("intersect"==q)c=n(u(g,k(c))),c>d&&(d=c,i=b);else if("strict"==q&&(c=n(u(g,k(c))),c==v))return i=b,!1});if((c=b.get("activeDrop"))&&
c!=i)c._handleOut(a),f._handleOut(a);b.setInternal("activeDrop",i);i&&(c!=i?i._handleEnter(a):i._handleOver(a))}function o(b){b._shim=(new g('<div style="background-color:red;position:'+(i?"absolute":"fixed")+";left:0;width:100%;height:100%;top:0;cursor:"+m.get("dragCursor")+";z-index:"+B+';"></div>')).prependTo(f.body||f.documentElement).css("opacity",0);o=p;if(i)h.on(q,"resize scroll",w,b);p(b)}function p(b){var a=b.get("activeDrag").get("activeHandler"),c="auto";a&&(c=a.css("cursor"));"auto"==
c&&(c=b.get("dragCursor"));b._shim.css({cursor:c,display:"block"});i&&w.call(b)}function c(b){var a=b.get("drops");b.setInternal("validDrops",[]);e.each(a,function(b){b._active()})}function v(b){var a=b.get("drops");b.setInternal("validDrops",[]);e.each(a,function(b){b._deActive()})}function k(b){var a=b.offset();return{left:a.left,right:a.left+(b.__dd_cached_width||b.outerWidth()),top:a.top,bottom:a.top+(b.__dd_cached_height||b.outerHeight())}}function r(b,a){return b.left<=a.left&&b.right>=a.left&&
b.top<=a.top&&b.bottom>=a.top}function n(b){return b.top>=b.bottom||b.left>=b.right?0:(b.right-b.left)*(b.bottom-b.top)}function u(b,a){var c=Math.max(b.top,a.top),f=Math.min(b.right,a.right),q=Math.min(b.bottom,a.bottom);return{left:Math.max(b.left,a.left),right:f,top:c,bottom:q}}function a(b){b&&(b.__dd_cached_width=b.outerWidth(),b.__dd_cached_height=b.outerHeight())}var q=e.Env.host,f=q.document,i=6===j.ie,x=e.throttle(function(b){var a;if(b=m._normalEvent(b))if(b.preventDefault(),a=this.__activeToDrag)a._move(b);
else if(a=this.get("activeDrag"))a._move(b),t(this,b,a)},30),B=999999,y=h.Gesture,z=y.move,A=y.end;d.ATTRS={dragCursor:{value:"move"},clickPixelThresh:{value:3},bufferTime:{value:1},activeDrag:{},activeDrop:{},drops:{value:[]},validDrops:{value:[]}};var w=e.throttle(function(){var b;(b=this.get("activeDrag"))&&b.get("shim")&&this._shim.css({width:l.docWidth(),height:l.docHeight()})},30);e.extend(d,s,{__activeToDrag:0,_regDrop:function(b){this.get("drops").push(b)},_unRegDrop:function(b){b=e.indexOf(b,
this.get("drops"));-1!=b&&this.get("drops").splice(b,1)},_regToDrag:function(b){this.__activeToDrag=b;h.on(f,A,this._end,this);h.on(f,z,x,this);6===j.ie&&f.body.setCapture()},_start:function(){this.get("drops");var b=this.__activeToDrag;this.setInternal("activeDrag",b);this.__activeToDrag=0;b.get("shim")&&o(this);a(b.get("node"));c(this)},_addValidDrop:function(b){this.get("validDrops").push(b)},_end:function(){var b=this.get("activeDrag"),a=this.get("activeDrop");h.remove(f,z,x,this);h.remove(f,
A,this._end,this);6===j.ie&&f.body.releaseCapture();this.__activeToDrag&&(this.__activeToDrag._end(),this.__activeToDrag=0);this._shim&&this._shim.hide();b&&(b._end(),v(this),a&&a._end(),this.setInternal("activeDrag",null),this.setInternal("activeDrop",null))}});var m=new d;m.inRegion=r;m.region=k;m.area=n;m.cacheWH=a;m.PREFIX_CLS="ks-dd-";m._normalEvent=function(a){var c=a.touches;if(c){if(1!=c.length)return;c=c[0];a.target=a.target||c.target;a.currentTarget=a.currentTarget||c.currentTarget;a.which=
1;a.pageX=c.pageX;a.pageY=c.pageY}return a};return m},{requires:["ua","dom","event","node","base"]});
KISSY.add("dd/base/draggable-delegate",function(e,j,l,h,g,s){function d(){d.superclass.constructor.apply(this,arguments)}var t=j.PREFIX_CLS,o=s.Gesture.start,p=function(c){if(c=j._normalEvent(c)){var d,e;if(this._checkDragStartValid(c)){d=this.get("handlers");var h=new g(c.target);(d=d.length?this._getHandler(h):h)&&(e=this._getNode(d));e&&(this.setInternal("activeHandler",d),this.setInternal("node",e),this.setInternal("dragNode",e),this._prepare(c))}}};e.extend(d,l,{_onSetDisabledChange:function(c){this.get("container")[c?
"addClass":"removeClass"](t+"-disabled")},_init:function(){this.get("container").on(o,p,this).on("dragstart",this._fixDragStart)},_getHandler:function(c){for(var d=void 0,g=this.get("container"),j=this.get("handlers");c&&c[0]!==g[0];){e.each(j,function(e){if(h.test(c[0],e))return d=c,!1});if(d)break;c=c.parent()}return d},_getNode:function(c){return c.closest(this.get("selector"),this.get("container"))},destroy:function(){this.get("container").detach(o,p,this).detach("dragstart",this._fixDragStart);
this.detach()}},{ATTRS:{container:{setter:function(c){return g.one(c)}},selector:{},handlers:{value:[],getter:0}}});return d},{requires:["./ddm","./draggable","dom","node","event"]});
KISSY.add("dd/base/draggable",function(e,j,l,h,g,s){function d(){d.superclass.constructor.apply(this,arguments);this.addTarget(g);this.setInternal("dragNode",this.get("node"));this.on("afterDisabledChange",this._onSetDisabledChange,this);var a;(a=this.get("disabled"))&&this._onSetDisabledChange(a);this._init()}function t(){return!1}var o=e.each,p=s.Gesture.start,c=j.ie,v=e.Features,k=g.PREFIX_CLS,r=e.Env.host.document;d.ATTRS={node:{setter:function(a){if(!(a instanceof l))return l.one(a)}},clickPixelThresh:{valueFn:function(){return g.get("clickPixelThresh")}},
bufferTime:{valueFn:function(){return g.get("bufferTime")}},dragNode:{},shim:{value:!0},handlers:{value:[],getter:function(a){var c=this;a.length||(a[0]=c.get("node"));o(a,function(f,d){e.isFunction(f)&&(f=f.call(c));if("string"==typeof f||f.nodeType)f=l.one(f);a[d]=f});c.setInternal("handlers",a);return a}},activeHandler:{},dragging:{value:!1,setter:function(a){this.get("dragNode")[a?"addClass":"removeClass"](k+"dragging")}},mode:{value:"point"},disabled:{value:!1},move:{value:!1},primaryButtonOnly:{value:!0},
halt:{value:!0},groups:{value:{}},startMousePos:{},startNodePos:{},deltaPos:{},actualPos:{}};d.DropMode={POINT:"point",INTERSECT:"intersect",STRICT:"strict"};e.mix(d,d.DropMode);var n,u=function(a){if(a=g._normalEvent(a)){var c=a.target;this._checkDragStartValid(a)&&this._checkHandler(c)&&this._prepare(a)}};e.extend(d,h,{_bufferTimer:null,_onSetDisabledChange:function(a){this.get("dragNode")[a?"addClass":"removeClass"](k+"-disabled")},_init:function(){this.get("node").on(p,u,this).on("dragstart",
this._fixDragStart)},_fixDragStart:function(a){a.preventDefault()},_checkHandler:function(a){var c=this,f=c.get("handlers"),d=0;o(f,function(f){if(f.contains(a)||f[0]==a)return d=1,c.setInternal("activeHandler",f),!1});return d},_checkDragStartValid:function(a){return this.get("primaryButtonOnly")&&1!=a.which||this.get("disabled")?0:1},_prepare:function(a){if(a){var d=this;c&&(n=r.body.onselectstart,r.body.onselectstart=t);a.originalEvent.preventManipulation&&a.originalEvent.preventManipulation();
d.get("halt")&&a.stopPropagation();v.isTouchSupported()||a.preventDefault();var f=d.get("node"),e=a.pageX,a=a.pageY,f=f.offset();d.setInternal("startMousePos",d.mousePos={left:e,top:a});d.setInternal("startNodePos",f);d.setInternal("deltaPos",{left:e-f.left,top:a-f.top});g._regToDrag(d);if(e=d.get("bufferTime"))d._bufferTimer=setTimeout(function(){d._start()},1E3*e)}},_clearBufferTimer:function(){this._bufferTimer&&(clearTimeout(this._bufferTimer),this._bufferTimer=0)},_move:function(a){var c;c=a.pageX;
a=a.pageY;if(this.get("dragging")){var d=this.get("deltaPos"),e=c-d.left,d=a-d.top;this.mousePos={left:c,top:a};c={left:e,top:d,pageX:c,pageY:a,drag:this};this.setInternal("actualPos",{left:e,top:d});this.fire("dragalign",c);a=1;!1===this.fire("drag",c)&&(a=0);a&&this.get("move")&&this.get("node").offset(this.get("actualPos"))}else e=this.get("startMousePos"),d=this.get("clickPixelThresh"),(Math.abs(c-e.left)>=d||Math.abs(a-e.top)>=d)&&this._start()},stopDrag:function(){g._end()},_end:function(){var a;
this._clearBufferTimer();c&&(r.body.onselectstart=n);this.get("dragging")&&(this.get("node").removeClass(k+"drag-over"),(a=g.get("activeDrop"))?this.fire("dragdrophit",{drag:this,drop:a}):this.fire("dragdropmiss",{drag:this}),this.setInternal("dragging",0),this.fire("dragend",{drag:this}))},_handleOut:function(){this.get("node").removeClass(k+"drag-over");this.fire("dragexit",{drag:this,drop:g.get("activeDrop")})},_handleEnter:function(a){this.get("node").addClass(k+"drag-over");this.fire("dragenter",
a)},_handleOver:function(a){this.fire("dragover",a)},_start:function(){this._clearBufferTimer();this.setInternal("dragging",1);g._start();this.fire("dragstart",{drag:this})},destroy:function(){this.get("dragNode").detach(p,u,this).detach("dragstart",this._fixDragStart);this.detach()}});return d},{requires:["ua","node","base","./ddm","event"]});
