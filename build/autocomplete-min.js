/*
Copyright 2012, KISSY UI Library v1.30dev
MIT Licensed
build time: Apr 13 14:50
*/
KISSY.add("autocomplete/BasicComboBox",function(f,g,c,b){function j(b){var a=this.get("menu"),d=this.get("el")[0];a.get("visible")?a.hide():(d.focus(),this.sendRequest(""));b&&b.halt()}return g.create(c,{bindUI:function(){this.get("el");var b=this.get("container");this.get("button");b.on("click",j,this);var a=this.get("menuCfg");a.width||(a.width=b.width())}},{ATTRS:{container:{view:!0},button:{view:!0}},DefaultRender:b})},{requires:["uibase","./basic","./BasicComboBoxRender"]});
KISSY.add("autocomplete/BasicComboBoxRender",function(f,g,c,b){var j=b.all,i;return i=g.create(c,{createDom:function(){var a=j("<span class='"+this.get("prefixCls")+"combobox'></span>"),b=j("<a tabindex='-1' href='javascript:void(\"open\")'  onmousedown='return false;' class='"+this.get("prefixCls")+"combobox-button'>&#x25BC;</a>").unselectable();this.__set("container",a);this.__set("button",b)},renderUI:function(){var a=this.get("container"),b=this.get("button"),c=this.get("el").parent();a.appendTo(c).append(this.get("el")).append(b)},
_setFocused:function(a){i.superclass._setFocused.apply(this,arguments);this.get("container")[a?"addClass":"removeClass"](this.get("prefixCls")+"combobox-focused")},destructor:function(){this.get("container").remove()}},{ATTRS:{container:{},button:{}}})},{requires:["uibase","./inputRender","node"]});KISSY.add("autocomplete",function(f,g,c,b,j,i,a){c.Menu=g;c.LocalDataSource=b;c.RemoteDataSource=j;c.Basic=i;c.BasicComboBox=a;return c},{requires:"autocomplete/menu,autocomplete/input,autocomplete/localDataSource,autocomplete/remoteDataSource,autocomplete/basic,autocomplete/BasicComboBox".split(",")});
KISSY.add("autocomplete/basic",function(f,g,c,b,j,i){return g.create(c,[],{initializer:function(){var a,c;this.get("dataSource")||(a=(c=this.get("data"))?new j({data:c,dataSourceCfg:this.get("dataSourceCfg")}):new i({xhrCfg:this.get("xhrCfg"),dataSourceCfg:this.get("dataSourceCfg")}),this.__set("dataSource",a));this.get("menu")||(a=new b({prefixCls:this.get("prefixCls")}),this.__set("menu",a))}},{ATTRS:{destroyMenu:{value:!0},data:{},xhrCfg:{value:{}},dataSourceCfg:{value:{}}}},"AutoComplete_Basic")},
{requires:["uibase","./input","./menu","./localDataSource","./remoteDataSource"]});
KISSY.add("autocomplete/input",function(f,g,c,b,j,i,a,d){function k(e){if(e.get("multiple")&&e.get("alignWithCursor")){var a=e._getInputDesc(),b=a.tokens,c=e.get("menu"),d=a.cursorPosition,a=a.tokenIndex,e=e.get("el"),b=b.slice(0,a).join("").length;0<b&&++b;e.prop("selectionStart",b);e.prop("selectionEnd",b);b=e.prop("KsCursorOffset");e.prop("selectionStart",d);e.prop("selectionEnd",d);c.set("xy",[b.left,b.top])}else c=e.get("menu"),d=e.get("menuCfg")||{},c.set("align",f.merge({node:e.get("el")},
m,d.align))}var h,l=g.KeyCodes,m={points:["bl","tl"],overflow:{failX:1,failY:1,adjustX:1,adjustY:1}};h=c.create(b.Controller,[],{_savedInputValue:null,_stopNotify:0,bindUI:function(){this.get("el").on("valuechange",this._onValueChange,this)},sendRequest:function(e){this.get("dataSource").fetchData(e,this._renderData,this)},_onValueChange:function(){if(!this._stopNotify){var e=this._getValue();e===d?(e=this.get("menu"))&&e.hide():(this._savedInputValue=e,this.sendRequest(e))}},_handleBlur:function(){h.superclass._handleBlur.apply(this,
arguments);var e=this.get("menu");e&&e._hideForAutoComplete()},_renderData:function(e){var a=this.get("menu");a.removeChildren(!0);if(e&&e.length){var e=e.slice(0,this.get("maxItemCount")),b=this.get("menuCfg")||{};a.set("width",b.width===d?this.get("el").css("width"):b.width);var c;c=this.get("format")?this.get("format").call(this,this._getValue(),e):[];for(var h=0;h<e.length;h++)b=e[h],a.addChild(new j.Item(f.mix({prefixCls:this.get("prefixCls")+"autocomplete-",content:b,textContent:b,value:b},
c[h])));this._showMenu()}else a.hide()},_showMenu:function(){var e=this.get("menu");e._input=this;e._clearDismissTimer();k(this);e.show();for(var a=e.get("children"),b=this._getValue(),c=0;c<a.length;c++)if(a[c].get("textContent")==b){e.set("highlightedItem",a[c]);return}this.get("autoHighlight")&&a.length&&e.set("highlightedItem",a[0])},_onWindowResize:function(){k(this)},_handleKeyEventInternal:function(a){this.get("el");var b=this.get("menu");if(b){var c=this.get("updateInputOnDownUp");c&&(this._stopNotify=
f.inArray(a.keyCode,[l.UP,l.DOWN,l.ESC])?1:0);var d;if(b.get("visible")){var h=b._handleKeydown(a);c&&f.inArray(a.keyCode,[l.DOWN,l.UP])&&this._setValue(b.get("activeItem").get("textContent"));if(a.keyCode==l.ESC)return b.hide(),c&&this._setValue(this._savedInputValue),!0;if(a.keyCode==l.TAB&&(d=b.get("activeItem")))if(d._performInternal(),this.get("multiple"))return!0;return h}if((a.keyCode==l.DOWN||a.keyCode==l.UP)&&this.get("reFetchOnDownUp"))return this.sendRequest(this._getValue()),!0}},_uiSetSelectedItem:function(a){if(a){var b=
a.get("textContent");this._setValue(b);this._savedInputValue=b;this.fire("select",{value:a.get("value"),content:a.get("content"),textContent:b})}},_getValue:function(){var a=this.get("el").val();if(this.get("multiple")){var b=this._getInputDesc(),a=b.tokens,b=b.tokenIndex,c=this.get("separator");return(a=a[b]||"")&&-1!=c.indexOf(a.charAt(0))?a.substring(1):this.get("autoCompleteOnInitial")&&(0==b||-1==b)?a:d}return a},_setValue:function(a){var b=this.get("el");if(this.get("multiple")){var c=this._getInputDesc(),
d=c.tokens,c=c.tokenIndex,h=this.get("separator"),j=this.get("appendSeparatorOnComplete"),f=d[c];d[c]=-1!=h.indexOf(f.charAt(0))?f.charAt(0):"";d[c]+=a;a=d[c+1];if(j&&(!a||-1==h.indexOf(a.charAt(0))))d[c]+=h.charAt(0);a=d.slice(0,c+1).join("").length;b.val(d.join(""));b.prop("selectionStart",a);b.prop("selectionEnd",a)}else b.val(a)},_getInputDesc:function(){for(var a=this.get("el"),b=a.val(),c=[],d=[],h=this.get("literal"),f=this.get("separator"),j=!1,g=this.get("whitespace"),a=a.prop("selectionStart"),
i=-1,k=0;k<b.length;k++){var l=b.charAt(k);k==a&&(i=c.length);if(!j&&(!g&&/\s|\xa0/.test(l)&&(c.push(d.join("")),d=[]),-1!=f.indexOf(l)))c.push(d.join("")),d=[];h&&l==h&&(j=!j);d.push(l)}d.length&&c.push(d.join(""));-1==i&&(i=c.length-1);return{tokens:c,cursorPosition:a,tokenIndex:i}},destructor:function(){this.get("menu").detachInput(this,this.get("destroyMenu"));this.__set("menu",null)}},{ATTRS:{focusable:{value:!0},handleMouseEvents:{value:!1},allowTextSelection_:{value:!0},destroyMenu:{value:!1},
menu:{setter:function(a){a&&a.attachInput(this)}},ariaOwns:{view:!0},ariaExpanded:{view:!0},dataSource:{},maxItemCount:{value:99999},menuCfg:{value:{}},format:{},selectedItem:{},multiple:{},separator:{value:",;"},whitespace:{value:!0},appendSeparatorOnComplete:{value:!0},updateInputOnDownUp:{value:!0},reFetchOnDownUp:{value:!0},literal:{value:'"'},autoCompleteOnInitial:{value:!0},alignWithCursor:{},autoHighlight:{}},DefaultRender:i},"AutoComplete");b.UIStore.setUIByClass("autocomplete-input",{priority:b.UIStore.PRIORITY.LEVEL1,
ui:h});return h},{requires:"event,uibase,component,menu,./inputRender,input-selection".split(",")});
KISSY.add("autocomplete/inputRender",function(f,g,c){return g.create(c.Render,[],{renderUI:function(){this.get("el").attr({"aria-haspopup":!0,"aria-autocomplete":"list",autocomplete:"off",role:"combobox"})},_uiSetAriaOwns:function(b){this.get("el").attr("aria-owns",b)},_uiSetAriaExpanded:function(b){this.get("el").attr("aria-expanded",b)}},{ATTRS:{ariaOwns:{},ariaExpanded:{},elTagName:{value:"input"}}})},{requires:["uibase","component"]});
KISSY.add("autocomplete/localDataSource",function(f){function g(b){g.superclass.constructor.apply(this,arguments)}function c(b,c){var i=[],a=0;if(!b)return c;f.each(c,function(c){-1!=c.indexOf(b)&&i.push(c);a++});return i}g.ATTRS={data:{value:[]},dataSourceCfg:{value:{}}};f.extend(g,f.Base,{fetchData:function(b,f,i){var a=this.get("dataSourceCfg").parse||c,d=this.get("data"),d=a(b,d);f.call(i,d)}});return g});
KISSY.add("autocomplete/menu",function(f,g,c,b,j,i){c=c.create(j.PopupMenu,{_input:null,_inputs:null,attachInput:function(a){this._inputs=this._inputs||[];f.inArray(a,this._inputs)||this._inputs.push(a)},detachInput:function(a,b){var c=this._inputs,h=f.indexOf(a,c||[]);-1!=h&&c.splice(h,1);b&&(!c||0==c.length)&&this.destroy()},bindUI:function(){var a=this;a.on("show",function(){var b=a._input;b.set("ariaOwns",a.get("el").attr("id"));b.set("ariaExpanded",!0)});a.on("hide",function(){var b=a._input;
b.set("ariaOwns",a.get("el").attr("id"));b.set("ariaExpanded",!1)});a.on("click",function(b){var b=b.target,c=a._input;c._stopNotify=1;c.set("selectedItem",b);a.hide();setTimeout(function(){c._stopNotify=0},50)});var b=f.buffer(function(){var a=this._input;a&&this.get("visible")&&a._onWindowResize()},50);a.__reAlign=b;g.on(window,"resize",b,a);var b=a.get("el"),c=a.get("contentEl");b.on("focusin",function(){a._clearDismissTimer()});b.on("focusout",function(){a._hideForAutoComplete()});c.on("mouseover",
function(){a._input.get("el")[0].focus();a._clearDismissTimer()})},_clearDismissTimer:function(){this._dismissTimer&&(clearTimeout(this._dismissTimer),this._dismissTimer=null)},_hideForAutoComplete:function(){var a=this;a._dismissTimer=setTimeout(function(){a._immediateHideForAutoComplete()},30)},_immediateHideForAutoComplete:function(){this.removeChildren(!0);this.hide()},destructor:function(){g.remove(window,"resize",this.__reAlign,this);f.each(this._inputs,function(a){a.__set("menu",null)});this._inputs=
null}},{DefaultRender:i,ATTRS:{head:{view:!0},foot:{view:!0}}},"AutoComplete_Menu");b.UIStore.setUIByClass("autocomplete-menu",{priority:b.UIStore.PRIORITY.LEVEL1,ui:c});return c},{requires:["event","uibase","component","menu","./menuRender"]});
KISSY.add("autocomplete/menuRender",function(f,g,c){var b=f.all;return g.create(c.PopupMenu.Render,[],{createDom:function(){var c=this.get("el"),f=b("<div class='"+this.get("prefixCls")+"autocomplete-menu-header'></div>"),a=b("<div class='"+this.get("prefixCls")+"autocomplete-menu-footer'></div>");c.prepend(f);c.append(a);this.__set("head",f);this.__set("foot",a)}},{ATTRS:{head:{view:!0},foot:{view:!0}}})},{requires:["uibase","menu"]});
KISSY.add("autocomplete/remoteDataSource",function(f,g){function c(b){c.superclass.constructor.apply(this,arguments);this.io=null;this.caches={}}c.ATTRS={dataSourceCfg:{value:{}},xhrCfg:{value:{}}};f.extend(c,f.Base,{fetchData:function(b,c,f){var a=this,d,k=a.get("dataSourceCfg");a.io&&(a.io.abort(),a.io=null);if(!b&&!0!==k.allowEmpty)return c.call(f,[]);if(k.cache&&(d=a.caches[b]))return c.call(f,d);d=a.get("xhrCfg");d.data=d.data||{};d.data[k.paramName]=b;d.success=function(d){k.parse&&(d=k.parse(b,
d));a.__set("data",d);k.cache&&(a.caches[b]=d);c.call(f,d)};a.io=g(d)}});return c},{requires:["ajax"]});
