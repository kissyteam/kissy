/*
Copyright 2012, KISSY UI Library v1.30dev
MIT Licensed
build time: May 29 12:23
*/
KISSY.add("autocomplete/BasicComboBox",function(g,h,f){function j(a){var b=this.get("menu"),c=this.get("el")[0];b.get("visible")?b.hide():(c.focus(),this.sendRequest(""));a&&a.halt()}return h.extend({bindUI:function(){this.get("el");var a=this.get("container");this.get("button");a.on("click",j,this);var b=this.get("menuCfg");b.width||(b.width=a.width())}},{ATTRS:{container:{view:!0},button:{view:!0}},DefaultRender:f},{xclass:"autocomplete-combobox",priority:30})},{requires:["./basic","./BasicComboBoxRender"]});
KISSY.add("autocomplete/BasicComboBoxRender",function(g,h,f){var j=f.all,a;return a=h.extend({createDom:function(){var a=j("<span class='"+this.get("prefixCls")+"combobox'></span>"),c=j("<a tabindex='-1' href='javascript:void(\"open\")'  onmousedown='return false;' class='"+this.get("prefixCls")+"combobox-button'>&#x25BC;</a>").unselectable();this.__set("container",a);this.__set("button",c)},renderUI:function(){var a=this.get("container"),c=this.get("button"),d=this.get("el").parent();a.appendTo(d).append(this.get("el")).append(c)},
_uiSetFocused:function(b){a.superclass._uiSetFocused.apply(this,arguments);this.get("container")[b?"addClass":"removeClass"](this.get("prefixCls")+"combobox-focused")},destructor:function(){this.get("container").remove()}},{ATTRS:{container:{},button:{}}})},{requires:["./inputRender","node"]});KISSY.add("autocomplete",function(g,h,f,j,a,b,c){f.Menu=h;f.LocalDataSource=j;f.RemoteDataSource=a;f.Basic=b;f.BasicComboBox=c;return f},{requires:"autocomplete/menu,autocomplete/input,autocomplete/localDataSource,autocomplete/remoteDataSource,autocomplete/basic,autocomplete/BasicComboBox".split(",")});
KISSY.add("autocomplete/basic",function(g,h,f,j,a){return h.extend({initializer:function(){var b,c;this.get("dataSource")||(b=(c=this.get("data"))?new j({data:c,dataSourceCfg:this.get("dataSourceCfg")}):new a({xhrCfg:this.get("xhrCfg"),dataSourceCfg:this.get("dataSourceCfg")}),this.__set("dataSource",b));this.get("menu")||(b=new f({prefixCls:this.get("prefixCls")}),this.__set("menu",b))}},{ATTRS:{destroyMenu:{value:!0},data:{},xhrCfg:{value:{}},dataSourceCfg:{value:{}}}},{xclass:"autocomplete-basic",
priority:30})},{requires:["./input","./menu","./localDataSource","./remoteDataSource"]});
KISSY.add("autocomplete/input",function(g,h,f,j,a,b,c){function d(e){if(e.get("multiple")&&e.get("alignWithCursor")){var a=e._getInputDesc(),i=a.tokens,n=e.get("menu"),d=a.cursorPosition,a=a.tokenIndex,e=e.get("el"),i=i.slice(0,a).join("").length;0<i&&++i;e.prop("selectionStart",i);e.prop("selectionEnd",i);i=e.prop("KsCursorOffset");e.prop("selectionStart",d);e.prop("selectionEnd",d);n.set("xy",[i.left,i.top])}else n=e.get("menu"),d=e.get("menuCfg")||{},n.set("align",g.merge({node:e.get("el")},o,
d.align))}var l,k=h.KeyCodes,o={points:["bl","tl"],overflow:{adjustX:1,adjustY:1}};return l=f.Controller.extend({_savedInputValue:null,_stopNotify:0,bindUI:function(){this.get("el").on("valuechange",this._onValueChange,this)},sendRequest:function(e){this.get("dataSource").fetchData(e,this._renderData,this)},_onValueChange:function(){if(!this._stopNotify){var e=this._getValue();e===c?(e=this.get("menu"))&&e.hide():(this._savedInputValue=e,this.sendRequest(e))}},handleBlur:function(){l.superclass.handleBlur.apply(this,
arguments);var e=this.get("menu");e&&e._hideForAutoComplete()},_renderData:function(e){var a=this.get("menu");a.removeChildren(!0);if(e&&e.length){var e=e.slice(0,this.get("maxItemCount")),i=this.get("menuCfg")||{};a.set("width",i.width===c?this.get("el").css("width"):i.width);var d;d=this.get("format")?this.get("format").call(this,this._getValue(),e):[];for(var b=0;b<e.length;b++)i=e[b],a.addChild(new j.Item(g.mix({prefixCls:this.get("prefixCls")+"autocomplete-",content:i,textContent:i,value:i},
d[b])));this._showMenu()}else a.hide()},_showMenu:function(){var e=this.get("menu");e._input=this;e._clearDismissTimer();d(this);e.show();for(var a=e.get("children"),i=this._getValue(),b=0;b<a.length;b++)if(a[b].get("textContent")==i){e.set("highlightedItem",a[b]);return}if(this.get("autoHighlightFirst"))for(b=0;b<a.length;b++)if(!a[b].get("disabled")){e.set("highlightedItem",a[b]);break}},_onWindowResize:function(){d(this)},handleKeyEventInternal:function(e){this.get("el");var a=this.get("menu");
if(a){var b=this.get("updateInputOnDownUp");b&&(this._stopNotify=g.inArray(e.keyCode,[k.UP,k.DOWN,k.ESC])?1:0);var d;if(a.get("visible")){var c=a.handleKeydown(e);b&&g.inArray(e.keyCode,[k.DOWN,k.UP])&&this._setValue(a.get("activeItem").get("textContent"));if(e.keyCode==k.ESC)return a.hide(),b&&this._setValue(this._savedInputValue),!0;if(e.keyCode==k.TAB&&(d=a.get("activeItem")))if(d.performActionInternal(),this.get("multiple"))return!0;return c}if((e.keyCode==k.DOWN||e.keyCode==k.UP)&&this.get("reFetchOnDownUp"))return this.sendRequest(this._getValue()),
!0}},_uiSetSelectedItem:function(a){if(a){var b=a.get("textContent");this._setValue(b+this.get("strAppendedOnComplete"));this._savedInputValue=b;this.fire("select",{target:a})}},_getValue:function(){var a=this.get("el").val();if(this.get("multiple")){var b=this._getInputDesc(),a=b.tokens,b=b.tokenIndex,d=this.get("separator");return(a=a[b]||"")&&-1!=d.indexOf(a.charAt(0))?a.substring(1):this.get("autoCompleteOnInitial")&&(0==b||-1==b)?a:c}return a},_setValue:function(a){var b=this.get("el");if(this.get("multiple")){var d=
this._getInputDesc(),c=d.tokens,d=d.tokenIndex,f=this.get("separator"),j=this.get("appendSeparatorOnComplete"),g=c[d];c[d]=-1!=f.indexOf(g.charAt(0))?g.charAt(0):"";c[d]+=a;a=c[d+1];if(j&&(!a||-1==f.indexOf(a.charAt(0))))c[d]+=f.charAt(0);a=c.slice(0,d+1).join("").length;b.val(c.join(""));b.prop("selectionStart",a);b.prop("selectionEnd",a)}else b.val(a)},_getInputDesc:function(){for(var a=this.get("el"),b=a.val(),d=[],c=[],f=this.get("literal"),j=this.get("separator"),g=!1,h=this.get("whitespace"),
a=a.prop("selectionStart"),k=-1,l=0;l<b.length;l++){var m=b.charAt(l);l==a&&(k=d.length);if(!g&&(!h&&/\s|\xa0/.test(m)&&(d.push(c.join("")),c=[]),-1!=j.indexOf(m)))d.push(c.join("")),c=[];f&&m==f&&(g=!g);c.push(m)}c.length&&d.push(c.join(""));-1==k&&(k=d.length-1);return{tokens:d,cursorPosition:a,tokenIndex:k}},destructor:function(){this.get("menu").detachInput(this,this.get("destroyMenu"));this.__set("menu",null)}},{ATTRS:{handleMouseEvents:{value:!1},destroyMenu:{value:!1},menu:{setter:function(a){a&&
a.attachInput(this)}},ariaOwns:{view:!0},ariaExpanded:{view:!0},dataSource:{},maxItemCount:{value:99999},menuCfg:{value:{}},format:{},selectedItem:{},multiple:{},separator:{value:",;"},whitespace:{value:!0},appendSeparatorOnComplete:{value:!0},updateInputOnDownUp:{value:!0},reFetchOnDownUp:{value:!0},literal:{value:'"'},autoCompleteOnInitial:{value:!0},alignWithCursor:{},autoHighlightFirst:{},strAppendedOnComplete:{value:""}},DefaultRender:a},{xclass:"autocomplete-input",priority:10})},{requires:["event",
"component","menu","./inputRender","input-selection"]});KISSY.add("autocomplete/inputRender",function(g,h){return h.Render.extend({renderUI:function(){this.get("el").attr({"aria-haspopup":!0,"aria-autocomplete":"list",autocomplete:"off",role:"combobox"})},_uiSetAriaOwns:function(f){this.get("el").attr("aria-owns",f)},_uiSetAriaExpanded:function(f){this.get("el").attr("aria-expanded",f)}},{ATTRS:{ariaOwns:{},ariaExpanded:{},elTagName:{value:"input"}}})},{requires:["component"]});
KISSY.add("autocomplete/localDataSource",function(g){function h(f){h.superclass.constructor.apply(this,arguments)}function f(f,a){var b=[],c=0;if(!f)return a;g.each(a,function(a){-1!=a.indexOf(f)&&b.push(a);c++});return b}h.ATTRS={data:{value:[]},dataSourceCfg:{value:{}}};g.extend(h,g.Base,{fetchData:function(g,a,b){var c=this.get("dataSourceCfg").parse||f,d=this.get("data"),d=c(g,d);a.call(b,d)}});return h});
KISSY.add("autocomplete/menu",function(g,h,f,j){return f.PopupMenu.extend({_input:null,_inputs:null,attachInput:function(a){this._inputs=this._inputs||[];g.inArray(a,this._inputs)||this._inputs.push(a)},detachInput:function(a,b){var c=this._inputs,d=g.indexOf(a,c||[]);-1!=d&&c.splice(d,1);b&&(!c||0==c.length)&&this.destroy()},bindUI:function(){var a=this;a.on("show",function(){var b=a._input;b.set("ariaOwns",a.get("el").attr("id"));b.set("ariaExpanded",!0)});a.on("hide",function(){var b=a._input;
b.set("ariaOwns",a.get("el").attr("id"));b.set("ariaExpanded",!1)});a.on("click",function(b){var b=b.target,c=a._input;c._stopNotify=1;c.set("selectedItem",b);a.hide();setTimeout(function(){c._stopNotify=0},50)});var b=g.buffer(function(){var a=this._input;a&&this.get("visible")&&a._onWindowResize()},50);a.__reAlign=b;h.on(window,"resize",b,a);var b=a.get("el"),c=a.get("contentEl");b.on("focusin",function(){a._clearDismissTimer()});b.on("focusout",function(){a._hideForAutoComplete()});c.on("mouseover",
function(){a._input.get("el")[0].focus();a._clearDismissTimer()})},_clearDismissTimer:function(){this._dismissTimer&&(clearTimeout(this._dismissTimer),this._dismissTimer=null)},_hideForAutoComplete:function(){var a=this;a._dismissTimer=setTimeout(function(){a._immediateHideForAutoComplete()},30)},_immediateHideForAutoComplete:function(){this.removeChildren(!0);this.hide()},destructor:function(){h.remove(window,"resize",this.__reAlign,this);g.each(this._inputs,function(a){a.__set("menu",null)});this._inputs=
null}},{DefaultRender:j,ATTRS:{head:{view:!0},foot:{view:!0}}},{xclass:"autocomplete-menu",priority:40})},{requires:["event","menu","./menuRender"]});
KISSY.add("autocomplete/menuRender",function(g,h){var f=g.all;return h.PopupMenu.Render.extend({createDom:function(){var g=this.get("el"),a=f("<div class='"+this.get("prefixCls")+"autocomplete-menu-header'></div>"),b=f("<div class='"+this.get("prefixCls")+"autocomplete-menu-footer'></div>");g.prepend(a);g.append(b);this.__set("head",a);this.__set("foot",b)}},{ATTRS:{head:{view:!0},foot:{view:!0}}})},{requires:["menu"]});
KISSY.add("autocomplete/remoteDataSource",function(g,h){function f(g){f.superclass.constructor.apply(this,arguments);this.io=null;this.caches={}}f.ATTRS={dataSourceCfg:{value:{}},xhrCfg:{value:{}}};g.extend(f,g.Base,{fetchData:function(f,a,b){var c=this,d,g=c.get("dataSourceCfg");c.io&&(c.io.abort(),c.io=null);if(!f&&!0!==g.allowEmpty)return a.call(b,[]);if(g.cache&&(d=c.caches[f]))return a.call(b,d);d=c.get("xhrCfg");d.data=d.data||{};d.data[g.paramName]=f;d.success=function(d){g.parse&&(d=g.parse(f,
d));c.__set("data",d);g.cache&&(c.caches[f]=d);a.call(b,d)};c.io=h(d)}});return f},{requires:["ajax"]});
