/*
Copyright 2010, KISSY UI Library v1.0dev
MIT Licensed
build: 416 Jan 17 22:28
*/
KISSY.add("datalazyload",function(l){function n(a,b){var c=this;if(!(c instanceof arguments.callee))return new arguments.callee(a,b);if(typeof b==="undefined"){b=a;a=[s]}t.isArray(a)||(a=[h.get(a)||s]);c.containers=a;c.config=l.merge(x,b||{});c.callbacks={els:[],fns:[]};c._init()}var u=YAHOO.util,h=u.Dom,m=u.Event,t=YAHOO.lang,o=window,s=document,v={AUTO:"auto",MANUAL:"manual"},x={mod:v.MANUAL,diff:"default",placeholder:"http://a.tbcdn.cn/kissy/1.0.2/build/datalazyload/dot.gif"};l.mix(n.prototype,
{_init:function(){var a=this;a.threshold=a._getThreshold();a._filterItems();a._getItemsLength()&&a._initLoadEvent()},_initLoadEvent:function(){function a(){c||(c=setTimeout(function(){b();c=null},100))}function b(){f._loadItems();if(f._getItemsLength()===0){m.removeListener(o,"scroll",a);m.removeListener(o,"resize",a)}}var c,f=this;m.on(o,"scroll",a);m.on(o,"resize",function(){f.threshold=f._getThreshold();a()});f._getItemsLength()&&m.onDOMReady(function(){b()})},_filterItems:function(){var a=this,
b=a.containers,c=a.threshold,f=a.config.placeholder,e=a.config.mod===v.MANUAL,d,g,j,k,p,i,q,r=[],w=[];d=0;for(g=b.length;d<g;++d){j=b[d].getElementsByTagName("img");k=0;for(p=j.length;k<p;++k){i=j[k];q=i.getAttribute("data-lazyload-src");if(e){if(q){i.src=f;r.push(i)}}else if(h.getY(i)>c&&!q){i.setAttribute("data-lazyload-src",i.src);i.src=f;r.push(i)}}j=b[d].getElementsByTagName("textarea");k=0;for(p=j.length;k<p;++k){i=j[k];h.hasClass(i,"ks-datalazyload")&&w.push(i)}}a.images=r;a.areaes=w},_loadItems:function(){var a=
this;a._loadImgs();a._loadAreaes();a._fireCallbacks()},_loadImgs:function(){var a=this,b=a.images,c=h.getDocumentScrollTop();c=a.threshold+c;var f,e,d=[];for(f=0;e=b[f++];)h.getY(e)<=c?a._loadImgSrc(e):d.push(e);a.images=d},_loadImgSrc:function(a,b){b=b||"data-lazyload-src";var c=a.getAttribute(b);if(c&&a.src!=c){a.src=c;a.removeAttribute(b)}},_loadAreaes:function(){var a=this,b=a.areaes,c=h.getDocumentScrollTop();c=a.threshold+c;var f,e,d,g=[];for(f=0;e=b[f++];){d=e.parentNode;h.getY(d)<=c?a._loadDataFromArea(d,
e):g.push(e)}a.areaes=g},_loadDataFromArea:function(a,b){var c=document.createElement("DIV");c.innerHTML=b.value;b.style.display="none";b.className="";a.appendChild(c)},_fireCallbacks:function(){var a=this,b=a.callbacks,c=b.els,f=b.fns,e=h.getDocumentScrollTop();a=a.threshold+e;var d,g,j=[],k=[];for(e=0;(d=c[e])&&(g=f[e++]);)if(h.getY(d)<=a)g.call(d);else{j.push(d);k.push(g)}b.els=j;b.fns=k},addCallback:function(a,b){if((a=h.get(a))&&typeof b==="function"){this.callbacks.els.push(a);this.callbacks.fns.push(b)}},
_getThreshold:function(){var a=this.config.diff,b=h.getViewportHeight();return a==="default"?2*b:b+a},_getItemsLength:function(){var a=this;return a.images.length+a.areaes.length+a.callbacks.els.length},loadCustomLazyData:function(a,b,c){var f=this,e,d;t.isArray(a)||(a=[h.get(a)]);l.each(a,function(g){switch(b){case "textarea-data":if((e=g.getElementsByTagName("textarea")[0])&&h.hasClass(e,c||"ks-datalazyload-custom"))f._loadDataFromArea(g,e);break;default:d=g.nodeName==="IMG"?[g]:g.getElementsByTagName("img");
g=0;for(var j=d.length;g<j;g++)f._loadImgSrc(d[g],c||"data-lazyload-src-custom")}})}});l.mix(n,n.prototype,true,["loadCustomLazyData","_loadImgSrc","_loadDataFromArea"]);l.DataLazyload=n});
