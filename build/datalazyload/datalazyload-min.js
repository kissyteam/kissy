/*
Copyright 2010, KISSY UI Library v1.0.5
MIT Licensed
build: 522 Apr 5 22:24
*/
KISSY.add("datalazyload",function(g,w){function m(a,b){if(!(this instanceof m))return new m(a,b);if(b===w){b=a;a=[p]}g.isArray(a)||(a=[g.get(a)||p]);this.containers=a;this.config=g.merge(x,b||{});this.callbacks={els:[],fns:[]};this._init()}var s=g.DOM,n=g.Event,k=YAHOO.util.Dom,o=window,p=document,t={AUTO:"auto",MANUAL:"manual"},x={mod:t.MANUAL,diff:"default",placeholder:"http://a.tbcdn.cn/kissy/1.0.4/build/datalazyload/dot.gif"},u=m.prototype;g.mix(u,{_init:function(){this.threshold=this._getThreshold();
this._filterItems();this._getItemsLength()&&this._initLoadEvent()},_initLoadEvent:function(){function a(){c||(c=setTimeout(function(){b();c=null},100))}function b(){d._loadItems();if(d._getItemsLength()===0){n.remove(o,"scroll",a);n.remove(o,"resize",a)}}var c,d=this;n.on(o,"scroll",a);n.on(o,"resize",function(){d.threshold=d._getThreshold();a()});d._getItemsLength()&&g.ready(function(){b()})},_filterItems:function(){var a=this.containers,b=this.threshold,c=this.config.placeholder,d=this.config.mod===
t.MANUAL,e,h,f,i,l,j,q,r=[],v=[];e=0;for(h=a.length;e<h;++e){f=g.query("img",a[e]);i=0;for(l=f.length;i<l;++i){j=f[i];q=j.getAttribute("data-lazyload-src");if(d){if(q){j.src=c;r.push(j)}}else if(k.getY(j)>b&&!q){j.setAttribute("data-lazyload-src",j.src);j.src=c;r.push(j)}}f=g.query("textarea",a[e]);i=0;for(l=f.length;i<l;++i){j=f[i];s.hasClass(j,"ks-datalazyload")&&v.push(j)}}this.images=r;this.areaes=v},_loadItems:function(){this._loadImgs();this._loadAreaes();this._fireCallbacks()},_loadImgs:function(){var a=
this.images,b=this.threshold+k.getDocumentScrollTop(),c,d,e=[];for(c=0;d=a[c++];)k.getY(d)<=b?this._loadImgSrc(d):e.push(d);this.images=e},_loadImgSrc:function(a,b){b=b||"data-lazyload-src";var c=a.getAttribute(b);if(c&&a.src!=c){a.src=c;a.removeAttribute(b)}},_loadAreaes:function(){var a=this.areaes,b=this.threshold+k.getDocumentScrollTop(),c,d,e,h=[];for(c=0;d=a[c++];){e=d.parentNode;k.getY(e)<=b?this._loadDataFromArea(e,d):h.push(d)}this.areaes=h},_loadDataFromArea:function(a,b){var c=p.createElement("DIV");
c.innerHTML=b.value;b.style.display="none";b.className="";a.appendChild(c)},_fireCallbacks:function(){var a=this.callbacks,b=a.els,c=a.fns,d=this.threshold+k.getDocumentScrollTop(),e,h,f,i=[],l=[];for(e=0;(h=b[e])&&(f=c[e++]);)if(k.getY(h)<=d)f.call(h);else{i.push(h);l.push(f)}a.els=i;a.fns=l},addCallback:function(a,b){if((a=g.get(a))&&typeof b==="function"){this.callbacks.els.push(a);this.callbacks.fns.push(b)}},_getThreshold:function(){var a=this.config.diff,b=k.getViewportHeight();return a==="default"?
2*b:b+a},_getItemsLength:function(){return this.images.length+this.areaes.length+this.callbacks.els.length},loadCustomLazyData:function(a,b,c){var d=this,e,h;g.isArray(a)||(a=[g.get(a)]);g.each(a,function(f){switch(b){case "textarea-data":if((e=g.get("textarea",f))&&s.hasClass(e,c||"ks-datalazyload-custom"))d._loadDataFromArea(f,e);break;default:h=f.nodeName==="IMG"?[f]:g.query("img",f);f=0;for(var i=h.length;f<i;f++)d._loadImgSrc(h[f],c||"data-lazyload-src-custom")}})}});g.mix(m,u,true,["loadCustomLazyData",
"_loadImgSrc","_loadDataFromArea"]);g.DataLazyload=m});
