/*
Copyright 2013, KISSY UI Library v1.40dev
MIT Licensed
build time: Apr 17 00:23
*/
KISSY.add("waterfall/base",function(d,q,t){function h(){h.superclass.constructor.apply(this,arguments);var a=this.__onResize=d.buffer(u,e,this);u.call(this);n(w).on("resize",a)}function l(a,b,c,f){var j={},r,g;j.stop=function(){r&&(clearTimeout(r),g=[],a.each(function(a){a.stop()}))};j.start=function(){g=[].concat(d.makeArray(a));0<g.length?function(){var j=+new Date;do{var k=g.shift();b.call(c,k)}while(0<g.length&&50>+new Date-j);0<g.length?r=setTimeout(arguments.callee,25):f&&f.call(c,a)}():f&&
f.call(c,a)};return j}function u(){var a=this.get("colWidth"),b=this.get("container"),c=this._containerRegion||{};d.isFunction(a)&&(a=a(this));b[0].offsetWidth&&!(this._colWidth===a&&b.width()===c.width)&&(this._colWidth=a,this.adjust())}function s(){var a=this.get("container").width(),b=this._curColHeights||[];this._curColHeights=b;b.length=Math.max(Math.floor(a/this._colWidth),this.get("minColCount"));this._containerRegion={width:a};d.each(b,function(a,f){b[f]=0});this._colItems=[]}function p(a,
b,c,f){function j(c){d[i]+=g.outerHeight(!0);var b=a._colItems;b[i]=b[i]||[];b[i].push(g);g.attr("data-waterfall-col",i);b=g[0].className.replace(/\s*ks-waterfall-col-(?:first|last|\d+)/g,"");b+=" ks-waterfall-col-"+i;0==i?b+=" ks-waterfall-col-first":i==d.length-1&&(b+=" ks-waterfall-col-last");g[0].className=b;c||f&&f()}var r=a.get("effect"),g=n(c),o=a.get("align"),k,d=a._curColHeights,c=a.get("container"),e=a._colWidth,m=d.length,i=0,h=a._containerRegion;k=Number.MAX_VALUE;if(m){if(g.hasClass("ks-waterfall-fixed-left"))i=
0;else if(g.hasClass("ks-waterfall-fixed-right"))i=0<m?m-1:0;else for(var l=0;l<m;l++)d[l]<k&&(k=d[l],i=l);k="left"===o?0:Math.max(h.width-m*e,0);"center"===o&&(k/=2);"justify"===o&&1<m&&(k=0<i?Math.max((h.width-e)/(m-1)-e,0)*i:0);o={left:i*e+k,top:d[i]};b?(g.css(o),r&&r.effect&&g.css("visibility","hidden"),c.append(g),j()):(b=a.get("adjustEffect"))?(j(1),g.animate(o,b.duration,b.easing,f)):(g.css(o),j());return g}}function v(a){var a=p(this,!0,a),b=this.get("effect");a&&b&&b.effect&&(a.hide(),a.css("visibility",
""),a[b.effect](b.duration,0,b.easing))}var n=q.all,w=d.Env.host,e=50;h.ATTRS={container:{setter:function(a){return n(a)}},align:{value:"center"},minColCount:{value:1},effect:{value:{effect:"fadeIn",duration:1}},colWidth:{},adjustEffect:{}};d.extend(h,t,{isAdjusting:function(){return!!this._adjuster},isAdding:function(){return!!this._adder},adjustItem:function(a,b){function c(){i--;0>=i&&(f._adjuster=0,b.callback&&b.callback.call(f))}var f=this,b=b||{};if(!f.isAdjusting()){var j=a.outerHeight(!0),
d;b.process&&(d=b.process.call(f));void 0===d&&(d=a.outerHeight(!0));var g=d-j,e=f._curColHeights,k=parseInt(a.attr("data-waterfall-col")),h=f._colItems[k],j=[];d=Math.max.apply(Math,e);for(var n=0;n<h.length&&h[n][0]!==a[0];n++);for(n++;n<h.length;)j.push(h[n]),n++;e[k]+=g;e=Math.max.apply(Math,e);e!=d&&f.get("container").height(e);var m=b.effect,i=j.length;if(!i)return b.callback&&b.callback.call(f);void 0===m&&(m=f.get("adjustEffect"));f._adjuster=l(j,function(a){m?a.animate({top:parseInt(a.css("top"))+
g},m.duration,m.easing,c):(a.css("top",parseInt(a.css("top"))+g),c())});f._adjuster.start();return f._adjuster}},removeItem:function(a,b){var b=b||{},c=this,f=b.callback;c.adjustItem(a,d.mix(b,{process:function(){a.remove();return 0},callback:function(){for(var b=parseInt(a.attr("data-waterfall-col")),b=c._colItems[b],d=0;d<b.length;d++)if(b[d][0]==a[0]){b.splice(d,1);break}f&&f()}}))},adjust:function(a){function b(){e--;0>=e&&(c.get("container").height(Math.max.apply(Math,c._curColHeights)),c._adjuster=
0,a&&a.call(c),c.fire("adjustComplete",{items:d}))}var c=this,d=c.get("container").all(".ks-waterfall");c.isAdjusting()&&(c._adjuster.stop(),c._adjuster=0);s.call(c);var e=d.length;if(!e)return a&&a.call(c);c._adjuster=l(d,function(a){p(c,false,a,b)});c._adjuster.start();return c._adjuster},addItems:function(a,b){var c=this;c._adder=l(a,v,c,function(){c.get("container").height(Math.max.apply(Math,c._curColHeights));c._adder=0;b&&b.call(c);c.fire("addComplete",{items:a})});c._adder.start();return c._adder},
destroy:function(){var a=this.__onResize;n(w).detach("resize",a);a.stop();this.fire("destroy");this.__destroyed=1}});return h},{requires:["node","base"]});
KISSY.add("waterfall/loader",function(d,q,t){function h(){h.superclass.constructor.apply(this,arguments);this.__onScroll=d.buffer(l,v,this);this.start()}function l(){if(!this.__loading)if(this.isAdjusting())this.__onScroll();else{var d=this.get("container");if(d[0].offsetWidth){var d=d.offset().top,h=this.get("diff"),e=this._curColHeights;e.length&&(d+=Math.min.apply(Math,e));h+s(p).scrollTop()+s(p).height()>=d&&u.call(this)}}}function u(){function d(a,c){e.__loading=0;e.addItems(a,function(){c&&
c.apply(this,arguments);l.call(e)})}function h(){e.end()}var e=this;e.get("container");e.__loading=1;var a=e.get("load");a&&a(d,h)}var s=q.all,p=d.Env.host,v=50;h.ATTRS={diff:{value:0}};d.extend(h,t,{start:function(){this.resume()},end:function(){this.pause()},pause:function(){this.__destroyed||(s(p).detach("scroll",this.__onScroll),this.__onScroll.stop())},resume:function(){this.__destroyed||(s(p).on("scroll",this.__onScroll),this.__started=1,l.call(this))},destroy:function(){this.end();h.superclass.destroy.apply(this,
arguments)}});return h},{requires:["node","./base"]});KISSY.add("waterfall",function(d,q,t){q.Loader=t;return q},{requires:["waterfall/base","waterfall/loader"]});
