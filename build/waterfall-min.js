/*
Copyright 2012, KISSY UI Library v1.40dev
MIT Licensed
build time: Dec 20 22:28
*/
KISSY.add("waterfall/base",function(e,p,t){function h(){h.superclass.constructor.apply(this,arguments);this._init()}function q(a,b,c,f){var k={},r,g;k.stop=function(){r&&(clearTimeout(r),g=[],a.each(function(a){a.stop()}))};k.start=function(){g=[].concat(e.makeArray(a));0<g.length?function(){var k=+new Date;do{var n=g.shift();b.call(c,n)}while(0<g.length&&50>+new Date-k);0<g.length?r=setTimeout(arguments.callee,25):f&&f.call(c,a)}():f&&f.call(c,a)};return k}function u(){var a=this._containerRegion||
{};a&&this.get("container").width()===a.width||this.adjust()}function s(){var a=this.get("container").width(),b=this.get("curColHeights");b.length=Math.max(Math.floor(a/this.get("colWidth")),this.get("minColCount"));this._containerRegion={width:a};e.each(b,function(a,f){b[f]=0});this.set("colItems",[])}function j(a,b,c,f){function k(c){d[i]+=g.outerHeight(!0);var b=a.get("colItems");b[i]=b[i]||[];b[i].push(g);g.attr("data-waterfall-col",i);b=g[0].className.replace(/\s*ks-waterfall-col-(?:first|last|\d+)/g,
"");b+=" ks-waterfall-col-"+i;0==i?b+=" ks-waterfall-col-first":i==d.length-1&&(b+=" ks-waterfall-col-last");g[0].className=b;c||f&&f()}var r=a.get("effect"),g=m(c),o=a.get("align"),n,d=a.get("curColHeights"),c=a.get("container"),e=a.get("colWidth"),l=d.length,i=0,h=a._containerRegion;n=Number.MAX_VALUE;if(l){if(g.hasClass("ks-waterfall-fixed-left"))i=0;else if(g.hasClass("ks-waterfall-fixed-right"))i=0<l?l-1:0;else for(var j=0;j<l;j++)d[j]<n&&(n=d[j],i=j);n="left"===o?0:Math.max(h.width-l*a.get("colWidth"),
0);"center"===o&&(n/=2);"justify"===o&&1<l&&(n=0<i?Math.max((h.width-e)/(l-1)-e,0)*i:0);o={left:i*e+n,top:d[i]};b?(g.css(o),r&&r.effect&&g.css("visibility","hidden"),c.append(g),k()):(b=a.get("adjustEffect"))?(k(1),g.animate(o,b.duration,b.easing,f)):(g.css(o),k());return g}}function v(a){var a=j(this,!0,a),b=this.get("effect");b&&b.effect&&(a.hide(),a.css("visibility",""),a[b.effect](b.duration,0,b.easing))}var m=p.all,d=e.Env.host;h.ATTRS={container:{setter:function(a){return m(a)}},curColHeights:{value:[]},
align:{value:"center"},minColCount:{value:1},effect:{value:{effect:"fadeIn",duration:1}},colWidth:{},colItems:{value:[]},adjustEffect:{}};e.extend(h,t,{isAdjusting:function(){return!!this._adjuster},isAdding:function(){return!!this._adder},_init:function(){var a;a=this.__onResize=e.buffer(u,50,this);a();m(d).on("resize",a)},adjustItem:function(a,b){function c(){i--;0>=i&&(f._adjuster=0,b.callback&&b.callback.call(f))}var f=this,b=b||{};if(!f.isAdjusting()){var k=a.outerHeight(!0),d;b.process&&(d=
b.process.call(f));void 0===d&&(d=a.outerHeight(!0));var g=d-k,e=f.get("curColHeights"),h=parseInt(a.attr("data-waterfall-col")),j=f.get("colItems")[h],k=[];d=Math.max.apply(Math,e);for(var m=0;m<j.length&&j[m][0]!==a[0];m++);for(m++;m<j.length;)k.push(j[m]),m++;e[h]+=g;e=Math.max.apply(Math,e);e!=d&&f.get("container").height(e);var l=b.effect,i=k.length;if(!i)return b.callback&&b.callback.call(f);void 0===l&&(l=f.get("adjustEffect"));f._adjuster=q(k,function(a){l?a.animate({top:parseInt(a.css("top"))+
g},l.duration,l.easing,c):(a.css("top",parseInt(a.css("top"))+g),c())});f._adjuster.start();return f._adjuster}},removeItem:function(a,b){var b=b||{},c=this,f=b.callback;c.adjustItem(a,e.mix(b,{process:function(){a.remove();return 0},callback:function(){for(var b=parseInt(a.attr("data-waterfall-col")),b=c.get("colItems")[b],d=0;d<b.length;d++)if(b[d][0]==a[0]){b.splice(d,1);break}f&&f()}}))},adjust:function(a){function b(){e--;0>=e&&(c.get("container").height(Math.max.apply(Math,c.get("curColHeights"))),
c._adjuster=0,a&&a.call(c),c.fire("adjustComplete",{items:d}))}var c=this,d=c.get("container").all(".ks-waterfall");c.isAdjusting()&&(c._adjuster.stop(),c._adjuster=0);s.call(c);var e=d.length;if(!e)return a&&a.call(c);c._adjuster=q(d,function(a){j(c,false,a,b)});c._adjuster.start();return c._adjuster},addItems:function(a,b){var c=this;c._adder=q(a,v,c,function(){c.get("container").height(Math.max.apply(Math,c.get("curColHeights")));c._adder=0;b&&b.call(c);c.fire("addComplete",{items:a})});c._adder.start();
return c._adder},destroy:function(){var a=this.__onResize;m(d).detach("resize",a);a.stop()}});return h},{requires:["node","base"]});
KISSY.add("waterfall/loader",function(e,p,t){function h(){h.superclass.constructor.apply(this,arguments)}function q(){if(!this.__loading)if(this.isAdjusting())this.__onScroll();else{var e=this.get("container").offset().top,h=this.get("diff"),d=this.get("curColHeights");d.length&&(e+=Math.min.apply(Math,d));h+s(j).scrollTop()+s(j).height()>=e&&u.call(this)}}function u(){function e(a,c){d.__loading=0;d.addItems(a,function(){c&&c.apply(this,arguments);q.call(d)})}function h(){d.end()}var d=this;d.get("container");
d.__loading=1;var a=d.get("load");a&&a(e,h)}var s=p.all,j=e.Env.host;h.ATTRS={diff:{value:0}};e.extend(h,t,{_init:function(){h.superclass._init.apply(this,arguments);this.__onScroll=e.buffer(q,50,this);this.__onScroll();this.start()},start:function(){this.__started||(s(j).on("scroll",this.__onScroll),this.__started=1)},end:function(){s(j).detach("scroll",this.__onScroll);this.__onScroll.stop();this.__started=0},pause:function(){this.end()},resume:function(){this.start()},destroy:function(){h.superclass.destroy.apply(this,
arguments);this.end()}});return h},{requires:["node","./base"]});KISSY.add("waterfall",function(e,p,t){p.Loader=t;return p},{requires:["waterfall/base","waterfall/loader"]});
