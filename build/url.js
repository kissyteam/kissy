modulex.add("url",["querystring","path"],function(e,t,a){function r(e){return":"===e.slice(-1)&&(e=e.slice(0,-1)),"http"===e||"https"===e||"ftp"===e||"gopher"===e||"file"===e}function s(e){return 1===e.length?"0"+e:e}function h(e,t){return encodeURI(e).replace(t,function(e){return"%"+s(e.charCodeAt(0).toString(16))})}var o,n=e("querystring"),p=e("path"),c=/[#\/\?@]/g,u=/[#\?]/g,l=/#/g,i=new RegExp("^([\\w\\d+.-]+:)?(?://(?:([^/?#@]*)@)?([\\w\\d\\-\\u0100-\\uffff.+%]*|\\[[^\\]]+\\])(?::([0-9]+))?)?([^?#]+)?(\\?[^#]*)?(#.*)?$"),m={protocol:1,auth:2,hostname:3,port:4,pathname:5,search:6,hash:7},f={parse:function(e,t){var a=e.match(i)||[],s={};for(var h in m)s[h]=a[m[h]];s.protocol&&(s.protocol=s.protocol.toLowerCase()),s.hostname&&(s.hostname=s.hostname.toLowerCase());var o=s.protocol;if(o&&(s.slashes=-1!==e.lastIndexOf(o+"//")),o&&!r(o.slice(0,-1))){if(!s.slashes)return e=e.slice(0,o.length)+"//"+e.slice(o.length),s=f.parse(e,t),s.slashes=null,s}else s.hostname&&!s.pathname&&(s.pathname="/");return s.path=s.pathname,s.search&&(s.path+=s.search),s.host=s.hostname,s.port&&(s.host=s.hostname+":"+s.port),s.search&&(s.query=s.search.substring(1)),t&&s.query&&(s.query=n.parse(s.query)),s.href=f.format(s),s},format:function(e,t){var a=e.host;a===o&&e.hostname&&(a=encodeURIComponent(e.hostname),e.port&&(a+=":"+e.port));var s=e.search,p=e.query;s===o&&p!==o&&("string"!=typeof p&&(p=n.stringify(p,o,o,t)),p&&(s="?"+p)),s&&"?"!==s.charAt(0)&&(s="?"+s);var i=e.hash||"";i&&"#"!==i.charAt(0)&&(i="#"+i);var m,f,g=e.pathname||"",v=[];return(m=e.protocol)&&(":"!==m.slice(-1)&&(m+=":"),v.push(h(m,c))),a!==o&&((this.slashes||m&&r(m))&&v.push("//"),(f=e.auth)&&(v.push(h(f,c)),v.push("@")),v.push(a)),g&&v.push(h(g,u)),s&&v.push(s),i&&v.push("#"+h(i.substring(1),l)),v.join("")},resolve:function(e,t){var a,r=0,s=["protocol","auth","host","pathname","search","hash"],h={};e=f.parse(e),t=f.parse(t);for(var o=0;o<s.length;o++){var n=s[o];if(r)h[n]=t[n];else if(h[n]=e[n],"pathname"===n){var c=t.pathname;c&&(r=1,"/"!==c.charAt(0)&&(h.hostname&&!h.pathname?c="/"+c:h.pathname&&(("/."===c.slice(-2)||"/.."===c.slice(-3)||"."===c||".."===c)&&(c+="/"),a=h.pathname.lastIndexOf("/"),-1!==a&&(c=h.pathname.slice(0,a+1)+c))),h.pathname=p.normalize(c))}else"search"===n?t.search&&(h.search=t.search,r=1):t[n]&&(r=r||h[n]!==t[n],h[n]=t[n])}return f.format(h)}};f.stringify=f.format,a.exports=f});