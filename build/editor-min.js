/*
Copyright 2012, KISSY UI Library v1.40dev
MIT Licensed
build time: Jul 5 10:58
*/
/*
 thanks to CKSource's intelligent work on CKEditor
 @author yiminghe@gmail.com
*/
KISSY.add("editor/core/base",function(d,h,r){h=r.Controller.extend({initializer:function(){this.__commands={};this.__controls={}}},{Config:{},XHTML_DTD:h.DTD,ATTRS:{textarea:{},iframe:{},window:{},document:{},toolBarEl:{},statusBarEl:{},handleMouseEvents:{value:!1},focusable:{value:!1},mode:{value:1},data:{getter:function(){return this._getData()},setter:function(d){return this._setData(d)}},formatData:{getter:function(){return this._getData(1)},setter:function(d){return this._setData(d)}},customStyle:{value:""},
customLink:{value:[]}}},{xclass:"editor"});h.HTML_PARSER={textarea:function(d){return d.one(".ks-editor-textarea")}};d.mix(h,d.EventTarget);return KISSY.Editor=h},{requires:["htmlparser","component","core"]});
KISSY.add("editor/core/clipboard",function(d,h,r,s){function q(a){this.editor=a;this._init()}function i(a){if(k.ie&&"BackCompat"!=a.get("document")[0].compatMode){var c=a.getSelection(),g;if(c.getType()==s.SELECTION_ELEMENT&&(g=c.getSelectedElement())){var b=c.getRanges()[0],j=e(a.get("document")[0].createTextNode(""));j.insertBefore(g);b.setStartBefore(j);b.setEndAfter(g);c.selectRanges([b]);setTimeout(function(){g.parent()&&(j.remove(),c.selectElement(g))},0)}}}var e=d.all,k=d.UA,m=h.RANGE,n=d.Event;
d.augment(q,{_init:function(){var a=this.editor,e=a.get("document")[0].body;n.on(e,k.ie?"beforepaste":"paste",this._paste,this);n.on(e,"contextmenu",function(){c=1;setTimeout(function(){c=0},10)});a.addCommand("copy",new t("copy"));a.addCommand("cut",new t("cut"));a.addCommand("paste",new t("paste"))},_paste:function(){if(!c){var a=this.editor,p=a.get("document")[0];if(!p.getElementById("ke_pastebin")){var g=a.getSelection(),b=new r(p),j=e(k.webkit?"<body></body>":"<div></div>",null,p);j.attr("id",
"ke_pastebin");k.webkit&&j[0].appendChild(p.createTextNode("\u00a0"));p.body.appendChild(j[0]);j.css({position:"absolute",top:g.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});j.css("left","-1000px");var l=g.createBookmarks();b.setStartAt(j,m.POSITION_AFTER_START);b.setEndAt(j,m.POSITION_BEFORE_END);b.select(!0);setTimeout(function(){var b;j=k.webkit&&(b=j.first())&&b.hasClass("Apple-style-span")?b:j;g.selectBookmarks(l);j.remove();var c=j.html();if(c=d.trim(c.replace(/<span[^>]+_ke_bookmark[^<]*?<\/span>(&nbsp;)*/ig,
"")))b=a.fire("paste",{html:c,holder:j}),void 0!==b&&(c=b),/(class="?Mso|style="[^"]*\bmso\-|w:WordDocument)/.test(c)?d.use("editor/core/dynamic/wordFilter",function(j,b){a.insertHtml(b.toDataFormat(c,a))}):a.insertHtml(c)},0)}}}});var u=function(a,c){var g=a.get("document")[0],b=e(g.body),j=!1,l=function(){j=!0};b.on(c,l);(7<k.ie?g:g.selection.createRange()).execCommand(c);b.detach(c,l);return j},o=k.ie?function(a,c){return u(a,c)}:function(a,c){try{return a.get("document")[0].execCommand(c)}catch(g){return!1}},
w={cut:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u526a\u5207\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+X)\u6765\u5b8c\u6210",copy:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u590d\u5236\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+C)\u6765\u5b8c\u6210",paste:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u7c98\u8d34\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+V)\u6765\u5b8c\u6210"},t=function(a){this.type=a};t.prototype={exec:function(a){"cut"==this.type&&i(a);(a=o(a,this.type))||alert(w[this.type]);return a}};var a={copy:"\u590d\u5236",paste:"\u7c98\u8d34",cut:"\u526a\u5207"},c;return{init:function(c){c.docReady(function(){new q(c)});var e={copy:1,cut:1,paste:1};c.on("contextmenu",function(g){g=g.contextmenu;if(!g.__copy_fix){g.__copy_fix=
1;for(var b in e)e.hasOwnProperty(b)&&g.addChild({xclass:"menuitem",content:a[b],value:b});g.on("click",function(a){var b=a.target.get("value");e[b]&&(this.hide(),setTimeout(function(){c.execCommand(b)},30))})}})}}},{requires:["./base","./range","./selection"]});
KISSY.add("editor/core/dom",function(d,h,r){function s(a,c){var f=a[c?"next":"prev"](q,1);if(f&&f[0].nodeType==e.ELEMENT_NODE){for(var p=[];f.attr("_ke_bookmark")||f._4e_isEmptyInlineRemovable(q);)if(p.push(f),f=c?f.next(q,1):f.prev(q,1),!f)return;if(a._4e_isIdentical(f,q)){for(var g=new m(c?a[0].lastChild:a[0].firstChild);p.length;)p.shift()._4e_move(a,!c,q);f._4e_moveChildren(a,!c,q);f.remove();g[0]&&g[0].nodeType==e.ELEMENT_NODE&&g._4e_mergeSiblings()}}}var q=q,i=h.XHTML_DTD,e=d.DOM,k=d.UA,m=d.Node,
n={a:1,abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};h.POSITION={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};var u=h.POSITION,o={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,
"table-cell":1,"table-caption":1},w={hr:1},t=function(a){return a&&(a[0]||a)};r.injectDom({_4e_sameLevel:function(a,c){var c=t(c),f=a.parentNode;return f&&f==c.parentNode},_4e_isBlockBoundary:function(a,c){var f=d.merge(w,c);return!(!o[e.css(a,"display")]&&!f[e.nodeName(a)])},_4e_index:function(a,c){for(var f=a.parentNode.childNodes,e,g=-1,b=0;b<f.length;b++)if(e=f[b],!c||!(3==e.nodeType&&e.previousSibling&&3==e.previousSibling.nodeType))if(g++,e===a)return g;return-1},_4e_move:function(a,c,f){c=
t(c);f?c.insertBefore(a,c.firstChild):c.appendChild(a)},_4e_isIdentical:function(a,c){if(!c)return!1;c=t(c);if(e.nodeName(a)!=e.nodeName(c))return!1;var f=a.attributes,p=c.attributes,g=f.length,b=p.length;if(g!=b)return!1;for(var j=0;j<g;j++){var l=f[j],v=l.name;if(l.specified&&e.attr(a,v)!=e.attr(c,v))return!1}if(8>r.ieEngine)for(j=0;j<b;j++)if(l=p[j],v=l.name,l.specified&&e.attr(a,v)!=e.attr(c,v))return!1;return!0},_4e_isEmptyInlineRemovable:function(a){if(!i.$removeEmpty[e.nodeName(a)])return!1;
for(var a=a.childNodes,c=0,f=a.length;c<f;c++){var p=a[c],g=p.nodeType;if(!(g==e.ELEMENT_NODE&&p.getAttribute("_ke_bookmark"))&&(g==e.ELEMENT_NODE&&!e._4e_isEmptyInlineRemovable(p)||g==e.TEXT_NODE&&d.trim(p.nodeValue)))return!1}return!0},_4e_moveChildren:function(a,c,f){c=t(c);if(a!=c)if(f)for(;f=a.lastChild;)c.insertBefore(a.removeChild(f),c.firstChild);else for(;f=a.firstChild;)c.appendChild(a.removeChild(f))},_4e_mergeSiblings:function(a){a=new m(a);n[a.nodeName()]&&(s(a,!0),s(a))},_4e_splitText:function(a,
c){var f=a.ownerDocument;if(a.nodeType==e.TEXT_NODE){if(k.ie&&c==a.nodeValue.length){var p=f.createTextNode("");e.insertAfter(p,a);return p}p=a.splitText(c);f.documentMode&&(f=f.createTextNode(""),e.insertAfter(f,p),e.remove(f));return p}},_4e_parents:function(a,c){var f=[];f.__IS_NODELIST=1;do f[c?"push":"unshift"](a);while(a=a.parentNode);return f},_4e_nextSourceNode:function(a,c,f,p){if(p&&!p.call)var g=t(p),p=function(a){return a!==g};var c=!c&&a.firstChild,b=a;if(!c){if(a.nodeType==e.ELEMENT_NODE&&
p&&!1===p(a,!0))return null;c=a.nextSibling}for(;!c&&(b=b.parentNode);){if(p&&!1===p(b,!0))return null;c=b.nextSibling}return!c||p&&!1===p(c)?null:f&&f!=c.nodeType?e._4e_nextSourceNode(c,!1,f,p):c},_4e_previousSourceNode:function(a,c,f,p){if(p&&!p.call)var g=t(p),p=function(a){return a!==g};var c=!c&&a.lastChild,b=a;if(!c){if(a.nodeType==e.ELEMENT_NODE&&p&&!1===p(a,!0))return null;c=a.previousSibling}for(;!c&&(b=b.parentNode);){if(p&&!1===p(b,!0))return null;c=b.previousSibling}return!c||p&&!1===
p(c)?null:f&&c.nodeType!=f?e._4e_previousSourceNode(c,!1,f,p):c},_4e_commonAncestor:function(a,c){c=t(c);if(a===c)return a;if(e.contains(c,a))return c;var f=a;do if(e.contains(f,c))return f;while(f=f.parentNode);return null},_4e_hasAttributes:9>r.ieEngine?function(a){for(var c=a.attributes,f=0;f<c.length;f++){var e=c[f];switch(e.name){case "class":if(a.getAttribute("class"))return!0;break;default:if(e.specified)return!0}}return!1}:function(a){k.gecko&&a.removeAttribute("_moz_dirty");return a.hasAttributes()},
_4e_position:function(a,c){var f=t(c);if(a.compareDocumentPosition)return a.compareDocumentPosition(f);if(a==f)return u.POSITION_IDENTICAL;if(a.nodeType==e.ELEMENT_NODE&&f.nodeType==e.ELEMENT_NODE){if(e.contains(a,f))return u.POSITION_CONTAINS+u.POSITION_PRECEDING;if(e.contains(f,a))return u.POSITION_IS_CONTAINED+u.POSITION_FOLLOWING;if("sourceIndex"in a)return 0>a.sourceIndex||0>f.sourceIndex?u.POSITION_DISCONNECTED:a.sourceIndex<f.sourceIndex?u.POSITION_PRECEDING:u.POSITION_FOLLOWING}for(var d=
e._4e_address(a),f=e._4e_address(f),g=Math.min(d.length,f.length),b=0;b<=g-1;b++)if(d[b]!=f[b])return d[b]<f[b]?u.POSITION_PRECEDING:u.POSITION_FOLLOWING;return d.length<f.length?u.POSITION_CONTAINS+u.POSITION_PRECEDING:u.POSITION_IS_CONTAINED+u.POSITION_FOLLOWING},_4e_address:function(a,c){for(var f=[],d=a.ownerDocument.documentElement,g=a;g&&g!=d;)f.unshift(e._4e_index(g,c)),g=g.parentNode;return f},_4e_remove:function(a,c){var f=a.parentNode;if(f){if(c)for(var e;e=a.firstChild;)f.insertBefore(a.removeChild(e),
a);f.removeChild(a)}return a},_4e_trim:function(a){e._4e_ltrim(a);e._4e_rtrim(a)},_4e_ltrim:function(a){for(var c;c=a.firstChild;){if(c.nodeType==e.TEXT_NODE){var f=r.ltrim(c.nodeValue),d=c.nodeValue.length;if(f)f.length<d&&(e._4e_splitText(c,d-f.length),a.removeChild(a.firstChild));else{a.removeChild(c);continue}}break}},_4e_rtrim:function(a){for(var c;c=a.lastChild;){if(c.type==e.TEXT_NODE){var f=r.rtrim(c.nodeValue),d=c.nodeValue.length;if(f)f.length<d&&(e._4e_splitText(c,f.length),a.removeChild(a.lastChild));
else{a.removeChild(c);continue}}break}!k.ie&&!k.opera&&(c=a.lastChild)&&1==c.nodeType&&"br"==e.nodeName(c)&&a.removeChild(c)},_4e_appendBogus:function(a){for(var c=a.lastChild;c&&c.nodeType==e.TEXT_NODE&&!d.trim(c.nodeValue);)c=c.previousSibling;if(!c||c.nodeType==e.TEXT_NODE||"br"!==e.nodeName(c))c=k.opera?a.ownerDocument.createTextNode(""):a.ownerDocument.createElement("br"),k.gecko&&c.setAttribute("type","_moz"),a.appendChild(c)},_4e_outerHtml:function(a){if(a.outerHTML)return a.outerHTML.replace(/<\?[^>]*>/,
"");var c=a.ownerDocument.createElement("div");c.appendChild(a.cloneNode(!0));return c.innerHTML},_4e_setMarker:function(a,c,f,e){var a=new m(a),g=a.data("list_marker_id")||a.data("list_marker_id",d.guid()).data("list_marker_id"),b=a.data("list_marker_names")||a.data("list_marker_names",{}).data("list_marker_names");c[g]=a;b[f]=1;return a.data(f,e)},_4e_clearMarkers:function(a,c,f){var a=new m(a),e=a.data("list_marker_names"),g=a.data("list_marker_id"),b;for(b in e)e.hasOwnProperty(b)&&a.removeData(b);
a.removeData("list_marker_names");f&&(a.removeData("list_marker_id"),delete c[g])},_4e_copyAttributes:function(a,c,f){for(var c=new m(c),d=a.attributes,f=f||{},g=0;g<d.length;g++){var b=d[g],j=b.name.toLowerCase(),l;if(!(j in f))if("checked"==j&&(l=e.attr(a,j)))c.attr(j,l);else if(b.specified||k.ie&&b.value&&"value"==j)l=e.attr(a,j),null===l&&(l=b.nodeValue),c.attr(j,l)}""!==a.style.cssText&&(c[0].style.cssText=a.style.cssText)},_4e_isEditable:function(a){a=e.nodeName(a);return(a=!i.$nonEditable[a]&&
(i[a]||i.span))&&a["#text"]},_4e_getByAddress:function(a,c,f){for(var a=a.documentElement,e=0;a&&e<c.length;e++){var g=c[e];if(f)for(var b=-1,j=0;j<a.childNodes.length;j++){var l=a.childNodes[j];if(!(!0===f&&3==l.nodeType&&l.previousSibling&&3==l.previousSibling.nodeType)&&(b++,b==g)){a=l;break}}else a=a.childNodes[g]}return a}})},{requires:["./base","./utils"]});
KISSY.add("editor/core/domIterator",function(d){function h(e){1>arguments.length||(this.range=e,this.forceBrBreak=s,this.enlargeBr=r,this.enforceRealBlocks=s,this._||(this._={}))}var r=!0,s=!1,q=d.Editor,i=d.UA,e=q.Walker,k=q.Range,m=q.RANGE,n=q.ElementPath,u=d.Node,o=d.DOM,w=/^[\r\n\t ]*$/;d.augment(h,{getNextParagraph:function(h){var a,c,f,p,g;if(!this._.lastNode){c=this.range.clone();c.shrink(m.SHRINK_ELEMENT,r);c.enlarge(this.forceBrBreak||!this.enlargeBr?m.ENLARGE_LIST_ITEM_CONTENTS:m.ENLARGE_BLOCK_CONTENTS);
var b=new e(c),j=e.bookmark(r,r);b.evaluator=j;this._.nextNode=b.next();b=new e(c);b.evaluator=j;b=b.previous();this._.lastNode=b._4e_nextSourceNode(r);this._.lastNode&&this._.lastNode[0].nodeType==o.TEXT_NODE&&!d.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()&&(j=new k(c.document),j.moveToPosition(this._.lastNode,m.POSITION_AFTER_END),j.checkEndOfBlock()&&(j=new n(j.endContainer),this._.lastNode=(j.block||j.blockLimit)._4e_nextSourceNode(r)));this._.lastNode||
(this._.lastNode=this._.docEndMarker=new u(c.document.createTextNode("")),o.insertAfter(this._.lastNode[0],b[0]));c=null}j=this._.nextNode;b=this._.lastNode;for(this._.nextNode=null;j;){var l=s,v=j[0].nodeType!=o.ELEMENT_NODE,x=s;if(v)j[0].nodeType==o.TEXT_NODE&&w.test(j[0].nodeValue)&&(v=s);else{var y=j.nodeName();if(j._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if("br"==y)v=r;else if(!c&&!j[0].childNodes.length&&"hr"!=y){a=j;f=j.equals(b);break}c&&(c.setEndAt(j,m.POSITION_BEFORE_START),"br"!=
y&&(this._.nextNode=j));l=r}else{if(j[0].firstChild){c||(c=new k(this.range.document),c.setStartAt(j,m.POSITION_BEFORE_START));j=new u(j[0].firstChild);continue}v=r}}v&&!c&&(c=new k(this.range.document),c.setStartAt(j,m.POSITION_BEFORE_START));f=(!l||v)&&j.equals(b);if(c&&!l)for(;!j[0].nextSibling&&!f;){y=j.parent();if(y._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){l=r;f||y.equals(b);break}j=y;v=r;f=j.equals(b);x=r}v&&c.setEndAt(j,m.POSITION_AFTER_END);j=j._4e_nextSourceNode(x,null,b);if((f=!j)||
l&&c)break}if(!a){if(!c)return this._.docEndMarker&&this._.docEndMarker._4e_remove(),this._.nextNode=null;a=new n(c.startContainer);j=a.blockLimit;l={div:1,th:1,td:1};a=a.block;if((!a||!a[0])&&!this.enforceRealBlocks&&l[j.nodeName()]&&c.checkStartOfBlock()&&c.checkEndOfBlock())a=j;else if(!a||this.enforceRealBlocks&&"li"==a.nodeName())a=new u(this.range.document.createElement(h||"p")),a[0].appendChild(c.extractContents()),a._4e_trim(),c.insertNode(a),p=g=r;else if("li"!=a.nodeName()){if(!c.checkStartOfBlock()||
!c.checkEndOfBlock())a=a.clone(s),a[0].appendChild(c.extractContents()),a._4e_trim(),g=c.splitBlock(),p=!g.wasStartOfBlock,g=!g.wasEndOfBlock,c.insertNode(a)}else f||(this._.nextNode=a.equals(b)?null:c.getBoundaryNodes().endNode._4e_nextSourceNode(r,null,b))}p&&(c=new u(a[0].previousSibling),c[0]&&c[0].nodeType==o.ELEMENT_NODE&&("br"==c.nodeName()?c._4e_remove():c[0].lastChild&&"br"==o.nodeName(c[0].lastChild)&&o._4e_remove(c[0].lastChild)));g&&(c=e.bookmark(s,r),p=new u(a[0].lastChild),p[0]&&p[0].nodeType==
o.ELEMENT_NODE&&"br"==p.nodeName()&&(i.ie||p.prev(c,1)||p.next(c,1))&&p.remove());this._.nextNode||(this._.nextNode=f||a.equals(b)?null:a._4e_nextSourceNode(r,null,b));return a}});k.prototype.createIterator=function(){return new h(this)};return h},{requires:["./base","./range","./elementPath","./walker"]});
KISSY.add("editor/core/elementPath",function(d){function h(d){for(var n=i,h=i,o=[];d;){if(d[0].nodeType==s.ELEMENT_NODE){this.lastElement||(this.lastElement=d);var w=d.nodeName();if(!h&&(!n&&e[w]&&(n=d),k[w])){var t;if(t=!n)if(t="div"==w){a:{t=d[0].childNodes;for(var a=0,c=t.length;a<c;a++){var f=t[a];if(f.nodeType==s.ELEMENT_NODE&&q.$block[f.nodeName.toLowerCase()]){t=!0;break a}}t=!1}t=!t}t?n=d:h=d}o.push(d);if("body"==w)break}d=d.parent()}this.block=n;this.blockLimit=h;this.elements=o}var r=d.Editor,
s=d.DOM,q=r.XHTML_DTD,i=null,e={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},k={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};h.prototype={compare:function(e){var d=this.elements,e=e&&e.elements;if(!e||d.length!=e.length)return!1;for(var i=0;i<d.length;i++)if(!s.equals(d[i],e[i]))return!1;return!0},contains:function(e){for(var d=this.elements,k=0;k<d.length;k++)if(d[k].nodeName()in e)return d[k];return i},toString:function(){var e=this.elements,
d,i=[];for(d=0;d<e.length;d++)i.push(e[d].nodeName());return i.toString()}};return r.ElementPath=h},{requires:["./base","./dom"]});
KISSY.add("editor/core/enterKey",function(d,h,r,s){function q(i){var h;h=i.getSelection().getRanges();for(var t=h.length-1;0<t;t--)h[t].deleteContents();h=h[0];t=h.document;if(h.checkStartOfBlock()&&h.checkEndOfBlock()){var a=(new s(h.startContainer)).block;if(a&&("li"==a.nodeName()||"li"==a.parent().nodeName()))return i.hasCommand("outdent")?(i.execCommand("save"),i.execCommand("outdent"),i.execCommand("save"),!0):!1}var c=h.splitBlock("p");if(!c)return!0;var i=c.previousBlock,a=c.nextBlock,f=c.wasStartOfBlock,
p=c.wasEndOfBlock,g;if(a)g=a.parent(),"li"==g.nodeName()&&(a._4e_breakParent(g),a._4e_move(a.next(),!0));else if(i&&(g=i.parent())&&"li"==g.nodeName())i._4e_breakParent(g),h.moveToElementEditablePosition(i.next()),i._4e_move(i.prev());if(!f&&!p){if("li"==a.nodeName()&&(g=a.first(r.invisible(!0)))&&d.inArray(g.nodeName(),["ul","ol"]))(e.ie?new n(t.createTextNode("\u00a0")):new n(t.createElement("br"))).insertBefore(g);a&&h.moveToElementEditablePosition(a)}else{var b;if(i){if("li"==i.nodeName()||!k.test(i.nodeName()))b=
i.clone()}else a&&(b=a.clone());b||(b=new n("<p>",null,t));if(g=c.elementPath)for(var c=0,j=g.elements.length;c<j;c++){var l=g.elements[c];if(l.equals(g.block)||l.equals(g.blockLimit))break;m.$removeEmpty[l.nodeName()]&&(l=l.clone(),b._4e_moveChildren(l),b.append(l))}e.ie||b._4e_appendBogus();h.insertNode(b);if(e.ie&&f&&(!p||!i[0].childNodes.length))h.moveToElementEditablePosition(p?i:b),h.select();h.moveToElementEditablePosition(f&&!p?a:b)}e.ie||(a?(b=new n(t.createElement("span")),b.html("&nbsp;"),
h.insertNode(b),b.scrollIntoView(void 0,!1),h.deleteContents()):b.scrollIntoView(void 0,!1));h.select();return!0}function i(e){var d=e.get("document")[0];u.on(d,"keydown",function(d){if(13===d.keyCode&&!d.shiftKey&&!d.ctrlKey&&!d.metaKey){e.execCommand("save");var a=e.execCommand("enterBlock");e.execCommand("save");!1!==a&&d.preventDefault()}})}var e=d.UA,k=/^h[1-6]$/,m=h.XHTML_DTD,n=d.Node,u=d.Event;return{init:function(e){e.addCommand("enterBlock",{exec:q});e.docReady(function(){i(e)})}}},{requires:["./base",
"./walker","./elementPath"]});
KISSY.add("editor/core/focusManager",function(d){function h(){var e=this;e.__iframeFocus=n;m=e;k&&clearTimeout(k);k=setTimeout(function(){e.fire("focus")},100)}function r(){var e=this;e.__iframeFocus=u;m=o;k&&clearTimeout(k);k=setTimeout(function(){e.fire("blur")},100)}var s=d.Editor,q=d.DOM,i=d.Event,e={},k,m,d={refreshAll:function(){for(var d in e)if(e.hasOwnProperty(d)){var i=e[d].get("document")[0];i.designMode="off";i.designMode="on"}},currentInstance:function(){return m},getInstance:function(d){return e[d]},
add:function(e){var d=q._getWin(e.get("document")[0]);i.on(d,"focus",h,e);i.on(d,"blur",r,e)},register:function(d){e[d._UUID]=d},remove:function(d){delete e[d._UUID];var k=q._getWin(d.get("document")[0]);i.remove(k,"focus",h,d);i.remove(k,"blur",r,d)}},n=!0,u=!1,o=null;d.refreshAll=d.refreshAll;s.focusManager=d;s.getInstances=function(){return e};return d},{requires:["./base","./dom"]});
KISSY.add("editor/core/htmlDataProcessor",function(d,h){return{init:function(r){function s(a){if((a.getAttribute("class")+"").match(/Apple-\w+-span/)||!a.attributes.length)a.setTagName(null);else if(!a.childNodes.length&&!a.attributes.length)return!1}function q(a){return a.replace(w,function(a,b,c){return"<"+b+c.replace(t,function(a,b){return-1==c.indexOf("_ke_saved_"+b)?" _ke_saved_"+a+" "+a:a})+">"})}function i(a){return a.replace(c,function(a){return"<ke:encoded>"+encodeURIComponent(a)+"</ke:encoded>"})}
function e(a){return a.replace(f,function(a,b){return decodeURIComponent(b)})}var k=d.Node,m=d.UA,n=d.require("htmlparser"),u=new n.Filter,o=new n.Filter;(function(){function b(c){c=n.serialize(c);return new n.Comment(a+encodeURIComponent(c).replace(/--/g,"%2D%2D"))}var c={tagNames:[[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],attributeNames:[[/^on/,"ke_on"],[/^lang$/,""]],tags:{script:b,noscript:b,span:s}},f={tagNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],tags:{$:function(a){if(a.attributes.length)for(var b=
["name","href","src"],c,f=0;f<b.length;f++)c="_ke_saved_"+b[f],a.getAttribute(c)&&a.removeAttribute(b[f]);return a},embed:function(a){var b=a.parentNode;if(b&&"object"==b.nodeName){var c=b.getAttribute("width"),b=b.getAttribute("height");c&&a.setAttribute("width",c);b&&a.setAttribute("width",b)}},a:function(a){if(!a.childNodes.length&&!a.attributes.length)return!1},span:s},attributes:{style:function(a){if(!d.trim(a))return!1}},attributeNames:[[/^_ke_saved_/,""],[/^ke_on/,"on"],[/^_ke.*/,""],[/^ke:.*$/,
""],[/^_ks.*/,""]],comment:function(b){if(b.substr(0,a.length)==a)return b=d.trim(decodeURIComponent(b.substr(a.length))),n.parse(b).childNodes[0]}};m.ie&&(f.attributes.style=function(a){return a.replace(/(^|;)([^:]+)/g,function(a){return a.toLowerCase()})});u.addRules(f);o.addRules(c)})();(function(){function a(b){for(var b=b.childNodes,c=b.length,B=b[c-1];B&&3==B.nodeType&&!d.trim(B.nodeValue);)B=b[--c];return B}function b(B,c){var f=a(B);f&&((c||!m.ie)&&1==f.nodeType&&"br"==f.nodeName?B.removeChild(f):
3==f.nodeType&&g.test(f.nodeValue)&&B.removeChild(f))}function c(b){var B=a(b);return!B||1==B.nodeType&&"br"==B.nodeName||"form"==b.nodeName&&"input"==B.nodeName}function f(a){b(a,!0);c(a)&&(m.ie?a.appendChild(new n.Text("\u00a0")):(a.appendChild(new n.Text("&nbsp;")),a.appendChild(new n.Tag("br"))))}function e(a){b(a,!1);c(a)&&a.appendChild(new n.Text("\u00a0"))}var g=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,i=h.XHTML_DTD,B=d.merge(i.$block,i.$listItem,i.$tableContent),z;for(z in B)B.hasOwnProperty(z)&&("br"in i[z]||
delete B[z]);delete B.td;delete B.pre;var i={tags:{}},G={tags:{}};for(z in B)B.hasOwnProperty(z)&&(i.tags[z]=f,G.tags[z]=e);o.addRules(i);u.addRules(G)})();u.addRules({text:function(a){return a.replace(/\xa0/g,"&nbsp;")}});var w=/<(a|area|img|input)\b([^>]*)>/gi,t=/\b(href|src|name)\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|(?:[^ "'>]+))/gi,a="{ke_protected}",c=/(?:<style[^>]*>[\s\S]*<\/style>)|(?:<(:?link|meta|base)[^>]*>)/gi,f=/<ke:encoded>([^<]*)<\/ke:encoded>/gi,p=/(<\/?)((?:object|embed|param|html|body|head|title|script|noscript)[^>]*>)/gi,
g=/(<\/?)ke:((?:object|embed|param|html|body|head|title|script|noscript)[^>]*>)/gi,b=/<ke:(param|embed)([^>]*?)\/?>(?!\s*<\/ke:\1)/gi;r.htmlDataProcessor={dataFilter:o,htmlFilter:u,toHtml:function(a){var b=new n.BeautifyWriter;(new n.Parser(a)).parse().writeHtml(b,u);return a=b.getHtml()},toDataFormat:function(a,c){var c=c||o,a=q(a),a=i(a),a=a.replace(p,"$1ke:$2"),a=a.replace(b,"<ke:$1$2></ke:$1>"),f=new k("<div>");f.html("a"+a);a=f.html().substr(1);a=a.replace(g,"$1$2");a=e(a);f=new n.BasicWriter;
(new n.Parser(a)).parse().writeHtml(f,c);return a=f.getHtml()},toServer:function(a){var b=new n.MinifyWriter;(new n.Parser(a)).parse().writeHtml(b,u);return b.getHtml()}}}}},{requires:["./base"]});
KISSY.add("editor/core/meta",function(){var d={backColor:["../color/btn","./cmd"],localStorage:["../flashBridge/"],bold:["../font/ui","./cmd"],draft:["../localStorage/","../menubutton/"],flash:["../flashCommon/baseClass","../flashCommon/utils"],fontFamily:["../font/ui","./cmd"],fontSize:["../font/ui","./cmd"],foreColor:["../color/btn","./cmd"],heading:["./cmd"],image:["../button/","../bubble/","../contextmenu/","../dialogLoader/"],indent:["./cmd"],orderedList:["../listUtils/btn","./cmd"],unorderedList:["../listUtils/btn",
"./cmd"],italic:["../font/ui","./cmd"],justifyCenter:["./cmd"],justifyLeft:["./cmd"],justifyRight:["./cmd"],link:["../bubble/","./utils","../dialogLoader/"],maximize:["./cmd"],multipleUpload:["../dialogLoader/"],outdent:["./cmd"],overlay:["dd","../focusFix/"],pageBreak:["../fakeObjects/"],removeFormat:["./cmd","../button/"],resize:["dd"],menubutton:["menubutton"],smiley:["../overlay/"],sourceArea:["../button/"],strikeThrough:["../font/ui","./cmd"],table:["../dialogLoader/","../contextmenu/"],underline:["../font/ui",
"./cmd"],undo:["./btn","./cmd"],contextmenu:["menu","../focusFix/"],video:["../flashCommon/utils","../flashCommon/baseClass"],xiamiMusic:["../flashCommon/baseClass","../flashCommon/utils"]},h,r,s={"backColor/cmd":["../color/cmd"],"bold/cmd":["../font/cmd"],"color/btn":["../button/","../overlay/","../dialogLoader/"],"color/colorPicker/dialog":["../../overlay/"],"dentUtils/cmd":["../listUtils/"],"flash/dialog":["../flashCommon/utils","../overlay/","../menubutton/"],"flashCommon/baseClass":["../contextmenu/",
"../bubble/","../dialogLoader/","./utils"],"font/ui":["../button/","../menubutton/"],"fontFamily/cmd":["../font/cmd"],"fontSize/cmd":["../font/cmd"],"foreColor/cmd":["../color/cmd"],"image/dialog":["../overlay/","switchable","../menubutton/"],"indent/cmd":["../dentUtils/cmd"],"orderedList/cmd":["../listUtils/cmd"],"unorderedList/cmd":["../listUtils/cmd"],"italic/cmd":["../font/cmd"],"justifyCenter/cmd":["../justifyUtils/cmd"],"justifyLeft/cmd":["../justifyUtils/cmd"],"justifyRight/cmd":["../justifyUtils/cmd"],
"link/dialog":["../overlay/","./utils"],"listUtils/btn":["../button/"],"listUtils/cmd":["../listUtils/"],"multipleUpload/dialog":["../progressbar/","../overlay/","../flashBridge/","../localStorage/"],"outdent/cmd":["../dentUtils/cmd"],"strikeThrough/cmd":["../font/cmd"],"table/dialog":["../overlay/","../menubutton/"],"underline/cmd":["../font/cmd"],"undo/btn":["../button/"],"video/dialog":["../flash/dialog","../menubutton/"],"xiamiMusic/dialog":["../flash/dialog","../menubutton/"]},q={};for(h in d)r=
"editor/plugin/"+h+"/index",q[r]={requires:d[h]};for(h in s)r="editor/plugin/"+h,q[r]={requires:s[h]};KISSY.add(q)});
KISSY.add("editor/core/range",function(d,h,r,s,q){function i(a){var b=a.nodeType!=f.TEXT_NODE&&f.nodeName(a)in g.$removeEmpty,c=a.nodeType==f.TEXT_NODE&&!d.trim(a.nodeValue),a=!!a.parentNode.getAttribute("_ke_bookmark");return b||c||a}function e(a){return!v(a)&&!x(a)}function k(a){var b=w;return function(c){if(x(c))return o;if(c.nodeType==f.TEXT_NODE){if(d.trim(c.nodeValue).length)return w}else if(c.nodeType==f.ELEMENT_NODE&&(c=f.nodeName(c),!H[c]))if(!a&&!p.ie&&"br"==c&&!b)b=o;else return w;return o}}
function m(a,c){var e=a.startContainer,g=a.endContainer,C=a.startOffset,j=a.endOffset,d,l=w,i=w,v=void 0,k=a.document,P;0<c&&(v=k.createDocumentFragment());if(a.collapsed)return v;a.optimizeBookmark();g[0].nodeType==f.TEXT_NODE?(i=o,g=g._4e_splitText(j)):0<g[0].childNodes.length&&(j>=g[0].childNodes.length?(g=new b(g[0].appendChild(k.createTextNode(""))),P=o):g=new b(g[0].childNodes[j]));e[0].nodeType==f.TEXT_NODE?(l=o,e._4e_splitText(C)):C?C>=e[0].childNodes.length?(e=new b(e[0].appendChild(k.createTextNode(""))),
d=o):e=new b(e[0].childNodes[C].previousSibling):(d=new b(k.createTextNode("")),e.prepend(d),e=d,d=o);var J=e._4e_parents(),K=g._4e_parents();J.each(function(a,b){J[b]=a});K.each(function(a,b){K[b]=a});for(var E,M,k=0;k<J.length&&!(E=J[k],M=K[k],!E.equals(M));k++);for(var C=v,h,p,x=k;x<J.length;x++){h=J[x];j=0<c&&!h.equals(e)?C.appendChild(h.clone()[0]):null;h=h[0].nextSibling;p=K[x];for(var m=g[0],y=p&&p[0];h&&!(y==h||m==h);)p=h.nextSibling,2==c?C.appendChild(h.cloneNode(o)):(f._4e_remove(h),1==
c&&C.appendChild(h)),h=p;j&&(C=j)}for(C=v;k<K.length;k++){h=K[k];j=0<c&&!h.equals(g)?C.appendChild(h.clone()[0]):null;if(!J[k]||!h._4e_sameLevel(J[k]))for(h=h[0].previousSibling;h;)p=h.previousSibling,2==c?C.insertBefore(h.cloneNode(o),C.firstChild):(f._4e_remove(h),1==c&&C.insertBefore(h,C.firstChild)),h=p;j&&(C=j)}if(2==c){if(l&&(E=e[0],E.nodeType==f.TEXT_NODE&&E.nextSibling&&E.nextSibling.nodeType==f.TEXT_NODE&&(E.data+=E.nextSibling.data,E.parentNode.removeChild(E.nextSibling))),i)i=g[0],i.nodeType==
f.TEXT_NODE&&i.previousSibling&&i.previousSibling.nodeType==f.TEXT_NODE&&(i.previousSibling.data+=i.data,i.parentNode.removeChild(i))}else{if(E&&M&&(!e._4e_sameLevel(E)||!g._4e_sameLevel(M)))i=E._4e_index(),d&&E._4e_sameLevel(e)&&i--,a.setStart(E.parent(),i+1);a.collapse(o)}d&&e.remove();P&&g.remove();return v}function n(a){a.collapsed=a.startContainer&&a.endContainer&&a.startContainer[0]==a.endContainer[0]&&a.startOffset==a.endOffset}function u(a){this.endOffset=this.endContainer=this.startOffset=
this.startContainer=t;this.collapsed=o;this.document=a}h.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var o=!0,w=!1,t=null,a=h.RANGE,c=h.POSITION,f=d.DOM,p=d.UA,g=h.XHTML_DTD,b=d.Node,j=b.all,l={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},v=new s.whitespaces,x=new s.bookmark,y=s.whitespaces(o),A=s.bookmark(!1,
!0),H={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};d.augment(u,{toString:function(){var a=[],b=this.startContainer[0],c=this.endContainer[0];a.push((b.id||b.nodeName)+":"+this.startOffset);a.push((c.id||c.nodeName)+":"+this.endOffset);return a.join("<br/>")},optimize:function(){var a=this.startContainer,b=this.startOffset;a[0].nodeType!=f.ELEMENT_NODE&&(b?b>=a[0].nodeValue.length&&
this.setStartAfter(a):this.setStartBefore(a));a=this.endContainer;b=this.endOffset;a[0].nodeType!=f.ELEMENT_NODE&&(b?b>=a[0].nodeValue.length&&this.setEndAfter(a):this.setEndBefore(a))},setStartAfter:function(a){this.setStart(a.parent(),a._4e_index()+1)},setStartBefore:function(a){this.setStart(a.parent(),a._4e_index())},setEndAfter:function(a){this.setEnd(a.parent(),a._4e_index()+1)},setEndBefore:function(a){this.setEnd(a.parent(),a._4e_index())},optimizeBookmark:function(){var a=this.startContainer,
b=this.endContainer;a&&"span"==a.nodeName()&&a.attr("_ke_bookmark")&&this.setStartBefore(a);b&&"span"==b.nodeName()&&b.attr("_ke_bookmark")&&this.setEndAfter(b)},setStart:function(a,b){a[0].nodeType==f.ELEMENT_NODE&&l[a.nodeName()]&&(a=a.parent(),b=a._4e_index());this.startContainer=a;this.startOffset=b;this.endContainer||(this.endContainer=a,this.endOffset=b);n(this)},setEnd:function(a,b){a[0].nodeType==f.ELEMENT_NODE&&l[a.nodeName()]&&(a=a.parent(),b=a._4e_index()+1);this.endContainer=a;this.endOffset=
b;this.startContainer||(this.startContainer=a,this.startOffset=b);n(this)},setStartAt:function(b,c){switch(c){case a.POSITION_AFTER_START:this.setStart(b,0);break;case a.POSITION_BEFORE_END:b[0].nodeType==f.TEXT_NODE?this.setStart(b,b[0].nodeValue.length):this.setStart(b,b[0].childNodes.length);break;case a.POSITION_BEFORE_START:this.setStartBefore(b);break;case a.POSITION_AFTER_END:this.setStartAfter(b)}n(this)},setEndAt:function(b,c){switch(c){case a.POSITION_AFTER_START:this.setEnd(b,0);break;
case a.POSITION_BEFORE_END:b[0].nodeType==f.TEXT_NODE?this.setEnd(b,b[0].nodeValue.length):this.setEnd(b,b[0].childNodes.length);break;case a.POSITION_BEFORE_START:this.setEndBefore(b);break;case a.POSITION_AFTER_END:this.setEndAfter(b)}n(this)},cloneContents:function(){return m(this,2)},deleteContents:function(){return m(this,0)},extractContents:function(){return m(this,1)},collapse:function(a){a?(this.endContainer=this.startContainer,this.endOffset=this.startOffset):(this.startContainer=this.endContainer,
this.startOffset=this.endOffset);this.collapsed=o},clone:function(){var a=new u(this.document);a.startContainer=this.startContainer;a.startOffset=this.startOffset;a.endContainer=this.endContainer;a.endOffset=this.endOffset;a.collapsed=this.collapsed;return a},getEnclosedNode:function(){var a=this.clone();a.optimize();if(a.startContainer[0].nodeType!=f.ELEMENT_NODE||a.endContainer[0].nodeType!=f.ELEMENT_NODE)return t;var b=new s(a);b.evaluator=function(a){return y(a)&&A(a)};a=b.next();b.reset();b=
b.previous();return a&&a.equals(b)?a:t},shrink:function(b,c){if(!this.collapsed){var b=b||a.SHRINK_TEXT,e=this.clone(),g=this.startContainer,j=this.endContainer,d=this.startOffset,l=this.endOffset,i=o,k,v,h=o;g&&g[0].nodeType==f.TEXT_NODE&&(d?d>=g[0].nodeValue.length?e.setStartAfter(g):(e.setStartBefore(g),i=w):e.setStartBefore(g));j&&j[0].nodeType==f.TEXT_NODE&&(l?l>=j[0].nodeValue.length?e.setEndAfter(j):(e.setEndAfter(j),h=w):e.setEndBefore(j));if(i||h)v=new s(e),v.evaluator=function(c){return c.nodeType==
(b==a.SHRINK_ELEMENT?f.ELEMENT_NODE:f.TEXT_NODE)},v.guard=function(c,e){if(b==a.SHRINK_ELEMENT&&c.nodeType==f.TEXT_NODE||e&&c==k)return w;!e&&c.nodeType==f.ELEMENT_NODE&&(k=c);return o};i&&(e=v[b==a.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(e,c?a.POSITION_AFTER_START:a.POSITION_BEFORE_START);h&&(v.reset(),(v=v[b==a.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(v,c?a.POSITION_BEFORE_END:a.POSITION_AFTER_END));return i||h}},createBookmark2:function(a){var c=this.startContainer,
e=this.endContainer,g=this.startOffset,j=this.endOffset,d,l;if(!c||!e)return{start:0,end:0};if(a){if(c[0].nodeType==f.ELEMENT_NODE&&(d=new b(c[0].childNodes[g]))&&d[0]&&d[0].nodeType==f.TEXT_NODE&&0<g&&d[0].previousSibling.nodeType==f.TEXT_NODE)c=d,g=0;for(;c[0].nodeType==f.TEXT_NODE&&(l=c.prev(void 0,1))&&l[0].nodeType==f.TEXT_NODE;)c=l,g+=l[0].nodeValue.length;if(!this.collapsed){if(e[0].nodeType==f.ELEMENT_NODE&&(d=new b(e[0].childNodes[j]))&&d[0]&&d[0].nodeType==f.TEXT_NODE&&0<j&&d[0].previousSibling.nodeType==
f.TEXT_NODE)e=d,j=0;for(;e[0].nodeType==f.TEXT_NODE&&(l=e.prev(void 0,1))&&l[0].nodeType==f.TEXT_NODE;)e=l,j+=l[0].nodeValue.length}}return{start:c._4e_address(a),end:this.collapsed?t:e._4e_address(a),startOffset:g,endOffset:j,normalized:a,is2:o}},createBookmark:function(c){var e,g,f,j,l=this.collapsed;e=new b("<span>",t,this.document);e.attr("_ke_bookmark",1);e.css("display","none");e.html("&nbsp;");c&&(f=d.guid("ke_bm_"),e.attr("id",f+"S"));l||(g=e.clone(),g.html("&nbsp;"),c&&g.attr("id",f+"E"),
j=this.clone(),j.collapse(),j.insertNode(g));j=this.clone();j.collapse(o);j.insertNode(e);g?(this.setStartAfter(e),this.setEndBefore(g)):this.moveToPosition(e,a.POSITION_AFTER_END);return{startNode:c?f+"S":e,endNode:c?f+"E":g,serializable:c,collapsed:l}},moveToPosition:function(a,b){this.setStartAt(a,b);this.collapse(o)},trim:function(a,b){var c=this.startContainer,e=this.startOffset,g=this.collapsed;if((!a||g)&&c[0]&&c[0].nodeType==f.TEXT_NODE){if(e)if(e>=c[0].nodeValue.length)e=c._4e_index()+1,
c=c.parent();else{var j=c._4e_splitText(e),e=c._4e_index()+1,c=c.parent();f.equals(this.startContainer,this.endContainer)?this.setEnd(j,this.endOffset-this.startOffset):f.equals(c,this.endContainer)&&(this.endOffset+=1)}else e=c._4e_index(),c=c.parent();this.setStart(c,e);if(g){this.collapse(o);return}}c=this.endContainer;e=this.endOffset;!b&&!g&&c[0]&&c[0].nodeType==f.TEXT_NODE&&(e?(e>=c[0].nodeValue.length||c._4e_splitText(e),e=c._4e_index()+1):e=c._4e_index(),c=c.parent(),this.setEnd(c,e))},insertNode:function(a){this.optimizeBookmark();
this.trim(w,o);var b=this.startContainer;b[0].insertBefore(a[0],b[0].childNodes[this.startOffset]||null);b[0]==this.endContainer[0]&&this.endOffset++;this.setStartBefore(a)},moveToBookmark:function(a){var b=j(this.document);if(a.is2){var c=b._4e_getByAddress(a.start,a.normalized),e=a.startOffset,b=a.end&&b._4e_getByAddress(a.end,a.normalized),a=a.endOffset;this.setStart(c,e);b?this.setEnd(b,a):this.collapse(o)}else c=(e=a.serializable)?d.one("#"+a.startNode,b):a.startNode,a=e?d.one("#"+a.endNode,
b):a.endNode,this.setStartBefore(c),c._4e_remove(),a&&a[0]?(this.setEndBefore(a),a._4e_remove()):this.collapse(o)},getCommonAncestor:function(a,c){var e=this.startContainer,g=this.endContainer,e=e[0]==g[0]?a&&e[0].nodeType==f.ELEMENT_NODE&&this.startOffset==this.endOffset-1?new b(e[0].childNodes[this.startOffset]):e:e._4e_commonAncestor(g);return c&&e[0].nodeType==f.TEXT_NODE?e.parent():e},enlarge:function(){function c(a,b,e,g){var d=a[b?"startContainer":"endContainer"],l,i=b?0:1,k=0,h=b?"previousSibling":
"nextSibling";l=a[b?"startOffset":"endOffset"];if(d[0].nodeType==f.TEXT_NODE){if(b){if(l)return}else if(l<d[0].nodeValue.length)return;l=d[0][h];d=d[0].parentNode}else l=d[0].childNodes[l+(b?-1:1)]||null,d=d[0];for(;d;){for(;l;)if(v(l)||x(l))l=l[h];else break;if(l){if(!k)a[b?"setStartAfter":"setEndBefore"](j(l));break}d=j(d);if("body"==d.nodeName())break;if(k||d.equals(g))e[i]=d,k=1;else a[b?"setStartBefore":"setEndAfter"](d);l=d[0][h];d=d[0].parentNode}}return function(e){switch(e){case a.ENLARGE_ELEMENT:if(this.collapsed)break;
var e=this.getCommonAncestor(),g=[];c(this,1,g,e);c(this,0,g,e);g[0]&&g[1]&&(e=g[0].contains(g[1])?g[1]:g[0],this.setStartBefore(e),this.setEndAfter(e));break;case a.ENLARGE_BLOCK_CONTENTS:case a.ENLARGE_LIST_ITEM_CONTENTS:var d=new u(this.document),g=new b(this.document.body);d.setStartAt(g,a.POSITION_AFTER_START);d.setEnd(this.startContainer,this.startOffset);var d=new s(d),l,i,k=s.blockBoundary(e==a.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:t),v=function(a){var b=k(a);b||(l=j(a));return b},h=function(a){var b=
v(a);!b&&"br"==f.nodeName(a)&&(i=j(a));return b};d.guard=v;d=d.lastBackward();l=l||g;this.setStartAt(l,"br"!=l.nodeName()&&(!d&&this.checkStartOfBlock()||d&&l.contains(d))?a.POSITION_AFTER_START:a.POSITION_AFTER_END);d=this.clone();d.collapse();d.setEndAt(g,a.POSITION_BEFORE_END);d=new s(d);d.guard=e==a.ENLARGE_LIST_ITEM_CONTENTS?h:v;l=t;d=d.lastForward();l=l||g;this.setEndAt(l,!d&&this.checkEndOfBlock()||d&&l.contains(d)?a.POSITION_BEFORE_END:a.POSITION_BEFORE_START);i&&this.setEndAfter(i)}}}(),
checkStartOfBlock:function(){var b=this.startContainer,c=this.startOffset;if(c&&b[0].nodeType==f.TEXT_NODE&&d.trim(b[0].nodeValue.substring(0,c)).length)return w;this.trim();b=new q(this.startContainer);c=this.clone();c.collapse(o);c.setStartAt(b.block||b.blockLimit,a.POSITION_AFTER_START);b=new s(c);b.evaluator=k(o);return b.checkBackward()},checkEndOfBlock:function(){var b=this.endContainer,c=this.endOffset;if(b[0].nodeType==f.TEXT_NODE&&d.trim(b[0].nodeValue.substring(c)).length)return w;this.trim();
b=new q(this.endContainer);c=this.clone();c.collapse(w);c.setEndAt(b.block||b.blockLimit,a.POSITION_BEFORE_END);b=new s(c);b.evaluator=k(w);return b.checkForward()},checkBoundaryOfElement:function(b,c){var e=this.clone();e[c==a.START?"setStartAt":"setEndAt"](b,c==a.START?a.POSITION_AFTER_START:a.POSITION_BEFORE_END);e=new s(e);e.evaluator=i;return e[c==a.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var a=this.startContainer,b=this.endContainer,e=this.startOffset,g=this.endOffset,
d;if(a[0].nodeType==f.ELEMENT_NODE)if(d=a[0].childNodes.length,d>e)a=j(a[0].childNodes[e]);else if(0==d)a=a._4e_previousSourceNode();else{for(a=a[0];a.lastChild;)a=a.lastChild;a=j(a);a=a._4e_nextSourceNode()||a}if(b[0].nodeType==f.ELEMENT_NODE)if(d=b[0].childNodes.length,d>g)b=j(b[0].childNodes[g])._4e_previousSourceNode(o);else if(0==d)b=b._4e_previousSourceNode();else{for(b=b[0];b.lastChild;)b=b.lastChild;b=j(b)}a._4e_position(b)&c.POSITION_FOLLOWING&&(a=b);return{startNode:a,endNode:b}},fixBlock:function(b,
c){var e=this.createBookmark(),g=j(this.document.createElement(c));this.collapse(b);this.enlarge(a.ENLARGE_BLOCK_CONTENTS);g[0].appendChild(this.extractContents());g._4e_trim();p.ie||g._4e_appendBogus();this.insertNode(g);this.moveToBookmark(e);return g},splitBlock:function(b){var c=new q(this.startContainer),e=new q(this.endContainer),g=c.block,f=e.block,l=t;if(!c.blockLimit.equals(e.blockLimit))return t;"br"!=b&&(g||(g=this.fixBlock(o,b),f=(new q(this.endContainer)).block),f||(f=this.fixBlock(w,
b)));b=g&&this.checkStartOfBlock();c=f&&this.checkEndOfBlock();this.deleteContents();g&&g[0]==f[0]&&(c?(l=new q(this.startContainer),this.moveToPosition(f,a.POSITION_AFTER_END),f=t):b?(l=new q(this.startContainer),this.moveToPosition(g,a.POSITION_BEFORE_START),g=t):(f=this.splitElement(g),!p.ie&&!d.inArray(g.nodeName(),["ul","ol"])&&g._4e_appendBogus()));return{previousBlock:g,nextBlock:f,wasStartOfBlock:b,wasEndOfBlock:c,elementPath:l}},splitElement:function(b){if(!this.collapsed)return t;this.setEndAt(b,
a.POSITION_BEFORE_END);var c=this.extractContents(),e=b.clone(w);e[0].appendChild(c);e.insertAfter(b);this.moveToPosition(b,a.POSITION_AFTER_END);return e},moveToElementEditablePosition:function(b,c){for(var g=0;b;){if(b[0].nodeType==f.TEXT_NODE){this.moveToPosition(b,c?a.POSITION_AFTER_END:a.POSITION_BEFORE_START);g=1;break}b[0].nodeType==f.ELEMENT_NODE&&b._4e_isEditable()&&(this.moveToPosition(b,c?a.POSITION_BEFORE_END:a.POSITION_AFTER_START),g=1);var d=b,l=g,j=void 0;d[0].nodeType==f.ELEMENT_NODE&&
d._4e_isEditable()&&(j=d[c?"last":"first"](e,1));!l&&!j&&(j=d[c?"prev":"next"](e,1));b=j}return!!g},selectNodeContents:function(a){var b=a[0];this.setStart(a,0);this.setEnd(a,b.nodeType==f.TEXT_NODE?b.nodeValue.length:b.childNodes.length)},insertNodeByDtd:function(a){var b,c,e,d=a.nodeName();b=g.$block[d];this.deleteContents();if(b){for(b=this.getCommonAncestor(w,o);(c=g[b.nodeName()])&&(!c||!c[d]);){var f=b.parent();this.checkStartOfBlock()&&this.checkEndOfBlock()?(this.setStartBefore(b),this.collapse(o),
b.remove()):e=b;b=f}e&&this.splitElement(e)}this.insertNode(a)}});r.injectDom({_4e_breakParent:function(a,b){var b=j(b),a=j(a),c,e=new h.Range(a[0].ownerDocument);e.setStartAfter(a);e.setEndAfter(b);c=e.extractContents();e.insertNode(a.remove());a.after(c)}});return h.Range=u},{requires:["./base","./utils","./walker","./elementPath","./dom"]});
KISSY.add("editor/core/selection",function(d){function h(a){this.document=a;this._={cache:{}};if(o)try{var b=this.getNative().createRange();if(!b||b.item&&b.item(0).ownerDocument!=a||b.parentElement&&b.parentElement().ownerDocument!=a)this.isInvalid=q}catch(c){this.isInvalid=q}}function r(a){a=new h(a);return!a||a.isInvalid?i:a}var s=d.Editor;s.SELECTION={SELECTION_NONE:1,SELECTION_TEXT:2,SELECTION_ELEMENT:3};var q=!0,i=null,e=d.UA,k=d.DOM,m=d.Node,n=s.SELECTION,u=s.RANGE,o=e.ie,w=s.Walker,t=s.Range,
a={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};d.augment(h,{getNative:!o?function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=k._getWin(this.document).getSelection())}:function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=this.document.selection)},getType:!o?function(){var c=this._.cache;if(c.type)return c.type;var b=n.SELECTION_TEXT,e=this.getNative();if(e){if(1==e.rangeCount){var e=
e.getRangeAt(0),d=e.startContainer;d==e.endContainer&&d.nodeType==k.ELEMENT_NODE&&1==Number(e.endOffset-e.startOffset)&&a[d.childNodes[e.startOffset].nodeName.toLowerCase()]&&(b=n.SELECTION_ELEMENT)}}else b=n.SELECTION_NONE;return c.type=b}:function(){var a=this._.cache;if(a.type)return a.type;var b=n.SELECTION_NONE;try{var c=this.getNative(),e=c.type;"Text"==e&&(b=n.SELECTION_TEXT);"Control"==e&&(b=n.SELECTION_ELEMENT);c.createRange().parentElement&&(b=n.SELECTION_TEXT)}catch(d){}return a.type=b},
getRanges:o?function(){var a=function(a,c){a=a.duplicate();a.collapse(c);for(var e=a.parentElement(),g=e.childNodes,d,f=0;f<g.length;f++){var h=g[f];if(h.nodeType==k.ELEMENT_NODE){d=a.duplicate();d.moveToElementText(h);var h=d.compareEndPoints("StartToStart",a),p=d.compareEndPoints("EndToStart",a);d.collapse();if(0<h)break;else{if(!h||1==p&&-1==h)return{container:e,offset:f};if(!p)return{container:e,offset:f+1}}d=i}}d||(d=a.duplicate(),d.moveToElementText(e),d.collapse(!1));d.setEndPoint("StartToStart",
a);d=(""+d.text).replace(/\r\n|\r/g,"\n").length;try{for(;0<d;)d-=g[--f].nodeValue.length}catch(m){d=0}return 0===d?{container:e,offset:f}:{container:g[f],offset:-d}};return function(b){var c=this._.cache;if(c.ranges&&!b)return c.ranges;var e=this.getNative(),b=e&&e.createRange(),d=this.getType();if(!e)return[];if(d==n.SELECTION_TEXT)return e=new t(this.document),d=a(b,q),e.setStart(new m(d.container),d.offset),d=a(b),e.setEnd(new m(d.container),d.offset),c.ranges=[e];if(d==n.SELECTION_ELEMENT){c=
c.ranges=[];for(d=0;d<b.length;d++){for(var f=b.item(d),i=f.parentNode,h=0,e=new t(this.document);h<i.childNodes.length&&i.childNodes[h]!=f;h++);e.setStart(new m(i),h);e.setEnd(new m(i),h+1);c.push(e)}return c}return c.ranges=[]}}():function(a){var b=this._.cache;if(b.ranges&&!a)return b.ranges;var a=[],c=this.getNative();if(!c)return[];for(var e=0;e<c.rangeCount;e++){var d=c.getRangeAt(e),f=new t(this.document);f.setStart(new m(d.startContainer),d.startOffset);f.setEnd(new m(d.endContainer),d.endOffset);
a.push(f)}return b.ranges=a},getStartElement:function(){var a=this._.cache;if(void 0!==a.startElement)return a.startElement;var b,c=this.getNative();switch(this.getType()){case n.SELECTION_ELEMENT:return this.getSelectedElement();case n.SELECTION_TEXT:var e=this.getRanges()[0];if(e&&!e.collapsed){for(e.optimize();q;)if(b=e.startContainer,e.startOffset==(b[0].nodeType===k.ELEMENT_NODE?b[0].childNodes.length:b[0].nodeValue.length)&&!b._4e_isBlockBoundary())e.setStartAfter(b);else break;b=e.startContainer;
if(b[0].nodeType!=k.ELEMENT_NODE)return b.parent();b=new m(b[0].childNodes[e.startOffset]);if(!b[0]||b[0].nodeType!=k.ELEMENT_NODE)return e.startContainer;for(e=b[0].firstChild;e&&e.nodeType==k.ELEMENT_NODE;)b=new m(e),e=e.firstChild;return b}if(o)e=c.createRange(),e.collapse(q),b=new m(e.parentElement());else{if((b=c.anchorNode)&&b.nodeType!=k.ELEMENT_NODE)b=b.parentNode;b&&(b=new m(b))}}return a.startElement=b},getSelectedElement:function(){var c,b=this._.cache;if(void 0!==b.selectedElement)return b.selectedElement;
o&&(c=this.getNative().createRange(),c=c.item&&c.item(0));var e;if(c)e=new m(c);else{c=this.getRanges()[0];for(var d,f=2;f&&(!(e=c.getEnclosedNode())||!(e[0].nodeType==k.ELEMENT_NODE&&a[e.nodeName()]&&(d=e)));f--)c.shrink(u.SHRINK_ELEMENT);e=d}return b.selectedElement=e},reset:function(){this._.cache={}},selectElement:function(a){var b,c=this.document;if(o)try{b=c.body.createControlRange(),b.addElement(a[0]),b.select()}catch(e){b=c.body.createTextRange(),b.moveToElementText(a[0]),b.select()}finally{}else b=
c.createRange(),b.selectNode(a[0]),a=this.getNative(),a.removeAllRanges(),a.addRange(b);this.reset()},selectRanges:function(a){if(o){if(1<a.length){var b=a[a.length-1];a[0].setEnd(b.endContainer,b.endOffset);a.length=1}a[0]&&a[0].select()}else{b=this.getNative();if(!b)return;b.removeAllRanges();for(var c=0;c<a.length;c++){var d=a[c],f=this.document.createRange(),i=d.startContainer;if(d.collapsed&&(e.gecko&&1.09>e.gecko||e.opera||e.webkit)&&i[0].nodeType==k.ELEMENT_NODE&&!i[0].childNodes.length)i[0].appendChild(this.document.createTextNode(e.webkit?
"\u200b":"")),d.startOffset++,d.endOffset++;f.setStart(i[0],d.startOffset);f.setEnd(d.endContainer[0],d.endOffset);b.addRange(f)}}this.reset()},createBookmarks2:function(a){for(var b=[],c=this.getRanges(),e=0;e<c.length;e++)b.push(c[e].createBookmark2(a));return b},createBookmarks:function(a,b){for(var c=[],e=this.document,f,b=b||this.getRanges(),i=b.length,h=0;h<i;h++){c.push(f=b[h].createBookmark(a,q));var p=(a=f.serializable)?d.one("#"+f.startNode,e):f.startNode;f=a?d.one("#"+f.endNode,e):f.endNode;
for(var m=h+1;m<i;m++){var n=b[m],o=n.startContainer,r=n.endContainer;k.equals(o,p.parent())&&n.startOffset++;k.equals(o,f.parent())&&n.startOffset++;k.equals(r,p.parent())&&n.endOffset++;k.equals(r,f.parent())&&n.endOffset++}}return c},selectBookmarks:function(a){for(var b=[],c=0;c<a.length;c++){var e=new t(this.document);e.moveToBookmark(a[c]);b.push(e)}this.selectRanges(b);return this},getCommonAncestor:function(){var a=this.getRanges();return a[0].startContainer._4e_commonAncestor(a[a.length-
1].endContainer)},scrollIntoView:function(){var a=this.getStartElement();a&&a.scrollIntoView(void 0,!1)},removeAllRanges:function(){var a=this.getNative();o?a&&a.clear():a&&a.removeAllRanges()}});var c={table:1,tbody:1,tr:1},f=w.whitespaces(q),p=/\ufeff|\u00a0/;t.prototype.select=t.prototype.select=!o?function(){var a=this.startContainer;this.collapsed&&a[0].nodeType==k.ELEMENT_NODE&&!a[0].childNodes.length&&a[0].appendChild(this.document.createTextNode(""));var b=this.document.createRange();b.setStart(a[0],
this.startOffset);try{b.setEnd(this.endContainer[0],this.endOffset)}catch(c){if(0<=c.toString().indexOf("NS_ERROR_ILLEGAL_VALUE"))this.collapse(q),b.setEnd(this.endContainer[0],this.endOffset);else throw c;}a=r(this.document).getNative();a.removeAllRanges();a.addRange(b)}:function(a){var b=this.collapsed,e,d;if(this.startContainer[0]===this.endContainer[0]&&1==this.endOffset-this.startOffset){var i=this.startContainer[0].childNodes[this.startOffset];if(i.nodeType==k.ELEMENT_NODE){(new h(this.document)).selectElement(new m(i));
return}}(this.startContainer[0].nodeType==k.ELEMENT_NODE&&this.startContainer.nodeName()in c||this.endContainer[0].nodeType==k.ELEMENT_NODE&&this.endContainer.nodeName()in c)&&this.shrink(u.SHRINK_ELEMENT,q);var n=this.createBookmark(),i=n.startNode,o;b||(o=n.endNode);n=this.document.body.createTextRange();n.moveToElementText(i[0]);n.moveStart("character",1);if(o)a=this.document.body.createTextRange(),a.moveToElementText(o[0]),n.setEndPoint("EndToEnd",a),n.moveEnd("character",-1);else{for(e=i[0].nextSibling;e&&
!f(e);)e=e.nextSibling;e=!(e&&e.nodeValue&&e.nodeValue.match(p))&&(a||!i[0].previousSibling||i[0].previousSibling&&"br"==k.nodeName(i[0].previousSibling));d=new m(this.document.createElement("span"));d.html("&#65279;");d.insertBefore(i);e&&k.insertBefore(this.document.createTextNode("\ufeff"),i[0]||i)}this.setStartBefore(i);i._4e_remove();if(b){if(e?(n.moveStart("character",-1),n.select(),this.document.selection.clear()):n.select(),d)this.moveToPosition(d,u.POSITION_BEFORE_START),d._4e_remove()}else this.setEndBefore(o),
o._4e_remove(),n.select()};h.getSelection=r;return s.Selection=h},{requires:["./base","./walker","./range","./dom"]});
KISSY.add("editor/core/selectionFix",function(d,h){function r(a){function c(a,b){var c=j.body.createTextRange();try{c.moveToPoint(a,b)}catch(e){c=m}return c}function e(){var a=j.selection.createRange();l&&!a.item&&0===a.compareEndPoints("StartToEnd",a)&&l.select();u.remove(j,"mouseup",e);u.remove(j,"mousemove",d);l=i=0}function d(a){if(a.button){if(a=c(a.pageX,a.pageY))0<a.compareEndPoints("StartToStart",l)?a.setEndPoint("StartToStart",l):a.setEndPoint("EndToEnd",l),a.select()}else e()}var i,b=a.get("window")[0],
j=a.get("document")[0],l;u.on(j,"mousedown contextmenu",function(a){var h=j.documentElement;if(a.target===h&&(i&&e(),!(h.scrollHeight>h.clientHeight)&&(i=1,l=c(a.pageX,a.pageY))))u.on(j,"mouseup",e),u.on(j,"mousemove",d),b.focus(),l.select()})}function s(a){function c(i){if(j){var g=a.getSelection(),l=g&&g.getType(),h=g&&d.selection;if(i&&h&&l==t.SELECTION_NONE&&!d.queryCommandEnabled("InsertImage"))setTimeout(function(){c(e)},50);else{var k;if(!h||!h.type||!("Control"!=h.type&&(k=h.createRange())&&
(k=k.parentElement())&&(k=k.nodeName)&&k.toLowerCase()in{input:1,textarea:1}))b=h&&g.getRanges()[0],a.checkSelectionChange()}}}var d=a.get("document")[0],i=new w(d.body),g=new w(d.documentElement);if(8>h.Utils.ieEngine)g.on("click",function(b){"html"===(new w(b.target)).nodeName()&&a.getSelection().getNative().createRange().select()});var b,j,l=e;g.on("mousedown",function(){l=k});g.on("mouseup",function(){l=e});i.on("focusin",function(a){if("body"==(new w(a.target)).nodeName()&&b){try{l&&b.select()}catch(c){}b=
m}});i.on("focus",function(){j=e;c()});i.on("beforedeactivate",function(a){a.relatedTarget||(j=k,l=e)});i.on("mousedown",function(){j=k});i.on("mouseup",function(){j=e;setTimeout(function(){c(e)},0)});i.on("keydown",function(){j=k});i.on("keyup",function(){j=e;setTimeout(function(){c()},0)})}function q(a){var c=a.get("document")[0];u.on(c,"mouseup keyup",function(){a.checkSelectionChange()})}function i(a){function c(a){var b=h.XHTML_DTD;return a._4e_isBlockBoundary()&&b.$empty[a.nodeName()]}function d(a){return g(a)&&
b(a)}var i=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;|(<\!--[\s\S]*?--\>))?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,g=h.Walker.whitespaces(e),b=h.Walker.bookmark(k,e),j=function(a){return g(a)&&8!=a.nodeType};a.on("selectionChange",function(b){var g=b.path,m=new w(a.get("document")[0].body),b=(b=b.selection)&&b.getRanges()[0],r=g.blockLimit;if(n.gecko){var q=g.block||g.blockLimit,s=q&&q.last(d);q&&q._4e_isBlockBoundary()&&(!s||!(1==s[0].nodeType&&s._4e_isBlockBoundary()))&&
"pre"!=q.nodeName()&&!q._4e_getBogus()&&q._4e_appendBogus()}if(b&&b.collapsed&&!g.block){if("body"==r.nodeName()){if((g=b.fixBlock(e,"p"))&&g[0]!=m[0].lastChild&&g._4e_outerHtml().match(i))if((r=g.next(j,1))&&r[0].nodeType==o.ELEMENT_NODE&&!c[r])b.moveToElementEditablePosition(r),g._4e_remove();else if((r=g.prev(j,1))&&r[0].nodeType==o.ELEMENT_NODE&&!c[r])b.moveToElementEditablePosition(r,r._4e_outerHtml().match(i)?k:e),g._4e_remove();b.select();a.notifySelectionChange()}g=a.get("document")[0];b=
new h.Range(g);b.moveToElementEditablePosition(m,e);"body"!==(new h.ElementPath(b.startContainer)).blockLimit.nodeName()&&(m=(new w(g.createElement("p"))).appendTo(m),n.ie||m._4e_appendBogus())}})}var e=!0,k=!1,m=null,n=d.UA,u=d.Event,o=d.DOM,w=d.Node,t=h.SELECTION;return{init:function(a){a.docReady(function(){n.ie?(r(a),s(a)):q(a)});i(a)}}},{requires:["./base","./selection"]});
KISSY.add("editor/core/styles",function(d,h){function r(a){return!y.attr(a,"_ke_bookmark")}function s(a,b){for(var c in a)a.hasOwnProperty(c)&&(d.isString(a[c])?a[c]=a[c].replace(Q,function(a,c){return b[c]}):s(a[c],b))}function q(a,b){b&&(a=d.clone(a),s(a,b));var c=this.element=this.element=(a.element||"*").toLowerCase();this.type=this.type="#text"==c||I[c]?A.STYLE_BLOCK:N[c]?A.STYLE_OBJECT:A.STYLE_INLINE;this._={definition:a}}function i(a,b){var c=b?this.removeFromRange:this.applyToRange;a.body.focus();
for(var e=new B(a),d=e.getRanges(),f=0;f<d.length;f++)c.call(this,d[f]);e.selectRanges(d)}function e(a,b,c){var e=a.element;"*"==e&&(e="span");b=new F(b.createElement(e));c&&c._4e_copyAttributes(b);c=a._.definition;a=c.attributes;c=q.getStyleText(c);if(a)for(var d in a)a.hasOwnProperty(d)&&b.attr(d,a[d]);c&&(b[0].style.cssText=c);return b}function k(a){var b=a.createBookmark(l),c=a.createIterator();c.enforceRealBlocks=l;c.enlargeBr=l;for(var d,f=a.document;d=c.getNextParagraph();){var i=e(this,f,
d),g=i,i="pre"==g.nodeName,h="pre"==d.nodeName,j=!i&&h;i&&!h?(h=d,j=h.html(),j=m(j,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,""),j=j.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1"),j=j.replace(/([ \t\n\r]+|&nbsp;)/g," "),j=j.replace(/<br\b[^>]*>/gi,"\n"),C.ie?(h=h[0].ownerDocument.createElement("div"),h.appendChild(g[0]),g[0].outerHTML="<pre>"+j+"</pre>",g=new F(h.firstChild),g._4e_remove()):g.html(j)):j?g=u(n(d),g):d._4e_moveChildren(g);d[0].parentNode.replaceChild(g[0],d[0]);if(i&&(d=g,i=void 0,(i=d._4e_previousSourceNode(l,
y.ELEMENT_NODE))&&"pre"==i.nodeName()))g=m(i.html(),/\n$/,"")+"\n\n"+m(d.html(),/^\n/,""),C.ie?d[0].outerHTML="<pre>"+g+"</pre>":d.html(g),i._4e_remove()}a.moveToBookmark(b)}function m(a,b,c){var e="",d="",a=a.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(a,b,c){b&&(e=b);c&&(d=c);return""});return e+a.replace(b,c)+d}function n(a){var b=[];m(a._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,function(a,b,c){return b+"</pre>"+
c+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(a,c){b.push(c)});return b}function u(a,b){for(var c=b[0].ownerDocument.createDocumentFragment(),e=0;e<a.length;e++){var d=a[e],d=d.replace(/(\r\n|\r)/g,"\n"),d=m(d,/^[ \t]*\n/,""),d=m(d,/\n$/,""),d=m(d,/^[ \t]+|[ \t]+$/g,function(a,b){return 1==a.length?"&nbsp;":b?" "+Array(a.length).join("&nbsp;"):Array(a.length).join("&nbsp;")+" "}),d=d.replace(/\n/g,"<br>"),d=d.replace(/[ \t]{2,}/g,function(a){return Array(a.length).join("&nbsp;")+" "}),
f=b.clone();f.html(d);c.appendChild(f[0])}return c}function o(a){var b=a.document;if(a.collapsed)b=e(this,b,void 0),a.insertNode(b),a.moveToPosition(b,H.POSITION_BEFORE_END);else{var c=this.element,d=this._.definition,f,i=L[c];i||(f=l,i=L.span);var h=a.createBookmark();a.enlarge(H.ENLARGE_ELEMENT);a.trim();for(var j=a.createBookmark(),k=j.startNode,j=j.endNode,D=k,p;D&&D[0];){var m=v;if(y.equals(D,j))D=x,m=l;else{var n=D[0].nodeType,I=n==y.ELEMENT_NODE?D.nodeName():x;if(I&&D.attr("_ke_bookmark")){D=
D._4e_nextSourceNode(l);continue}if(!I||i[I]&&(D._4e_position(j)|z.POSITION_PRECEDING|z.POSITION_IDENTICAL|z.POSITION_IS_CONTAINED)==z.POSITION_PRECEDING+z.POSITION_IDENTICAL+z.POSITION_IS_CONTAINED&&(!d.childRule||d.childRule(D))){var o=D.parent();if(o&&"a"==c&&o.nodeName()==c)n=e(this,b,void 0),o._4e_moveChildren(n),o[0].parentNode.replaceChild(n[0],o[0]),n._4e_mergeSiblings();else if(o&&o[0]&&((L[o.nodeName()]||L.span)[c]||f)&&(!d.parentRule||d.parentRule(o))){if(!p&&(!I||!L.$removeEmpty[I]||(D._4e_position(j)|
z.POSITION_PRECEDING|z.POSITION_IDENTICAL|z.POSITION_IS_CONTAINED)==z.POSITION_PRECEDING+z.POSITION_IDENTICAL+z.POSITION_IS_CONTAINED))p=new G(b),p.setStartBefore(D);if(n==y.TEXT_NODE||n==y.ELEMENT_NODE&&!D[0].childNodes.length){o=D;for(n=null;(m=!o.next(r,1))&&(n=o.parent())&&i[n.nodeName()]&&(n._4e_position(k)|z.POSITION_FOLLOWING|z.POSITION_IDENTICAL|z.POSITION_IS_CONTAINED)==z.POSITION_FOLLOWING+z.POSITION_IDENTICAL+z.POSITION_IS_CONTAINED&&(!d.childRule||d.childRule(n));)o=n;p.setEndAfter(o)}}else m=
l}else m=l;D=D._4e_nextSourceNode()}if(m&&p&&!p.collapsed){for(var m=e(this,b,void 0),o=p.getCommonAncestor(),n={},I={},q,s=null,t;m&&o&&m[0]&&o[0];){if(o.nodeName()==c){for(q in d.attributes)if(d.attributes.hasOwnProperty(q)&&!I[q]&&(t=o.attr(s)))m.attr(q)==t?m.removeAttr(q):I[q]=1;for(s in d.styles)if(d.styles.hasOwnProperty(s)&&!n[s]&&(t=o.style(s)))m.style(s)==t?m.style(s,""):n[s]=1;if(!m._4e_hasAttributes()){m=x;break}}o=o.parent()}m?(m[0].appendChild(p.extractContents()),g(this,m),p.insertNode(m),
m._4e_mergeSiblings(),C.ie||m[0].normalize()):(m=new F(b.createElement("span")),m[0].appendChild(p.extractContents()),p.insertNode(m),g(this,m),m._4e_remove(!0));p=x}}k._4e_remove();j._4e_remove();a.moveToBookmark(h);a.shrink(H.SHRINK_TEXT)}}function w(a){a.enlarge(H.ENLARGE_ELEMENT);var e=a.createBookmark(),d=e.startNode;if(a.collapsed){for(var i=new D(d.parent()),g,j=0,h;j<i.elements.length&&(h=i.elements[j])&&!(h==i.block||h==i.blockLimit);j++)if(this.checkElementRemovable(h)){var k=a.checkBoundaryOfElement(h,
H.END),l=!k&&a.checkBoundaryOfElement(h,H.START);l||k?(g=h,g.match=l?"start":"end"):(h._4e_mergeSiblings(),h.nodeName()!=this.element?(k=c(this),b(h,k[h.nodeName()]||k["*"])):f(this,h))}if(g){h=d;for(j=0;;j++){k=i.elements[j];if(y.equals(k,g))break;else if(k.match)continue;else k=k.clone();k[0].appendChild(h[0]);h=k}h["start"==g.match?"insertBefore":"insertAfter"](g)}}else{var C=e.endNode,m=this,i=function(){for(var a=new D(d.parent()),b=new D(C.parent()),c=x,e=x,f=0;f<a.elements.length;f++){var g=
a.elements[f];if(g==a.block||g==a.blockLimit)break;m.checkElementRemovable(g)&&(c=g)}for(f=0;f<b.elements.length;f++){g=b.elements[f];if(g==b.block||g==b.blockLimit)break;m.checkElementRemovable(g)&&(e=g)}e&&C._4e_breakParent(e);c&&d._4e_breakParent(c)};i();for(g=new F(d[0].nextSibling);g[0]!==C[0];){j=g._4e_nextSourceNode();if(g[0]&&g[0].nodeType==y.ELEMENT_NODE&&this.checkElementRemovable(g)&&(g.nodeName()==this.element?f(this,g):(h=c(this),b(g,h[g.nodeName()]||h["*"])),j[0].nodeType==y.ELEMENT_NODE&&
j.contains(d)))i(),j=new F(d[0].nextSibling);g=j}}a.moveToBookmark(e)}function t(a){var b={};(""+a).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(a,c,e){b[c]=e});return b}function a(a,b){var c="";b!==v?(c=document.createElement("span"),c.style.cssText=a,c=c.style.cssText||""):c=a;return c.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function c(a){if(a._.overrides)return a._.overrides;var b=a._.overrides={},c=a._.definition.overrides;
if(c){d.isArray(c)||(c=[c]);for(var e=0;e<c.length;e++){var f=c[e],g,i,h;"string"==typeof f?g=f.toLowerCase():(g=f.element?f.element.toLowerCase():a.element,i=f.attributes,h=f.styles);f=b[g]||(b[g]={});if(i){g=f.attributes=f.attributes||[];for(var j in i)i.hasOwnProperty(j)&&g.push([j.toLowerCase(),i[j]])}if(h){var f=f.styles=f.styles||[],k;for(k in h)h.hasOwnProperty(k)&&f.push([k.toLowerCase(),h[k]])}}}return b}function f(a,b){var e=a._.definition,f=c(a),g=d.merge(e.attributes,(f[b.nodeName()]||
f["*"]||{}).attributes),e=d.merge(e.styles,(f[b.nodeName()]||f["*"]||{}).styles),f=d.isEmptyObject(g)&&d.isEmptyObject(e),i;for(i in g)if(g.hasOwnProperty(i)&&!(("class"==i||a._.definition.fullMatch)&&b.attr(i)!=p(i,g[i])))f=f||!!b.hasAttr(i),b.removeAttr(i);for(var h in e)e.hasOwnProperty(h)&&!(a._.definition.fullMatch&&b.style(h)!=p(h,e[h],l))&&(f=f||!!b.style(h),b.style(h,""));j(b)}function p(a,b,c){var e=new F("<span>");e[c?"style":"attr"](a,b);return e[c?"style":"attr"](a)}function g(a,e){for(var d=
c(a),g=e.all(a.element),i=g.length;0<=--i;)f(a,new F(g[i]));for(var h in d)if(d.hasOwnProperty(h)&&h!=a.element){g=e.all(h);for(i=g.length-1;0<=i;i--){var j=new F(g[i]);b(j,d[h])}}}function b(a,b){var c,e=b&&b.attributes;if(e)for(c=0;c<e.length;c++){var d=e[c][0],f;if(f=a.attr(d)){var g=e[c][1];(g===x||g.test&&g.test(f)||"string"==typeof g&&f==g)&&a[0].removeAttribute(d)}}if(e=b&&b.styles)for(c=0;c<e.length;c++)if(d=e[c][0],g=a.css(d)){var i=e[c][1];(i===x||i.test&&i.test(f)||"string"==typeof i&&
g==i)&&a.css(d,"")}j(a)}function j(a){if(!a._4e_hasAttributes()){var b=a[0].firstChild,c=a[0].lastChild;a._4e_remove(l);b&&(b.nodeType==y.ELEMENT_NODE&&y._4e_mergeSiblings(b),c&&b!=c&&c.nodeType==y.ELEMENT_NODE&&y._4e_mergeSiblings(c))}}var l=!0,v=!1,x=null,y=d.DOM,A={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3},H=h.RANGE,B=h.Selection,z=h.POSITION,G=h.Range,F=d.Node,C=d.UA,D=h.ElementPath,I={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},L=h.XHTML_DTD,N={embed:1,hr:1,img:1,li:1,object:1,
ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},O=/\s*(?:;\s*|$)/g,Q=/#\((.+?)\)/g;h.STYLE=A;q.prototype={apply:function(a){i.call(this,a,v)},remove:function(a){i.call(this,a,l)},applyToRange:function(a){return(this.applyToRange=this.type==A.STYLE_INLINE?o:this.type==A.STYLE_BLOCK?k:x).call(this,a)},removeFromRange:function(a){return(this.removeFromRange=this.type==A.STYLE_INLINE?w:x).call(this,a)},checkElementRemovable:function(b,e){if(!b)return v;var d=this._.definition,f;if(b.nodeName()==
this.element){if(!e&&!b._4e_hasAttributes())return l;var g=d._AC;if(g)d=g;else{var g={},i=0,h=d.attributes;if(h)for(var j in h)h.hasOwnProperty(j)&&(i++,g[j]=h[j]);if(h=q.getStyleText(d))g.style||i++,g.style=h;g._length=i;d=d._AC=g}if(d._length){for(var k in d)if("_length"!=k&&d.hasOwnProperty(k)){i=b.attr(k)||"";if("style"==k)a:{g=d[k];i=a(i,v);"string"==typeof g&&(g=t(g));"string"==typeof i&&(i=t(i));h=void 0;for(h in g)if(g.hasOwnProperty(h)&&!(h in i&&(i[h]==g[h]||"inherit"==g[h]||"inherit"==
i[h]))){g=v;break a}g=l}else g=d[k]==i;if(g){if(!e)return l}else if(e)return v}if(e)return l}else return l}k=c(this);if(k=k[b.nodeName()]||k["*"]){if(!(d=k.attributes)&&!(f=k.styles))return l;if(d)for(g=0;g<d.length;g++)if(k=d[g][0],k=b.attr(k))if(i=d[g][1],i===x||"string"==typeof i&&k==i||i.test&&i.test(k))return l;if(f)for(g=0;g<f.length;g++)if(k=b.css(f[g][0]))if(d=f[g][1],d===x||"string"==typeof d&&k==d||d.test&&d.test(k))return l}return v},checkActive:function(a){switch(this.type){case A.STYLE_BLOCK:return this.checkElementRemovable(a.block||
a.blockLimit,l);case A.STYLE_OBJECT:case A.STYLE_INLINE:for(var b=a.elements,c=0,e;c<b.length;c++)if(e=b[c],!(this.type==A.STYLE_INLINE&&(y.equals(e,a.block)||y.equals(e,a.blockLimit))))if((this.type!=A.STYLE_OBJECT||e.nodeName()in N)&&this.checkElementRemovable(e,l))return l}return v}};q.getStyleText=function(b){var c=b._ST;if(c)return c;var c=b.styles,e=b.attributes&&b.attributes.style||"",d="";e.length&&(e=e.replace(O,";"));for(var f in c)if(c.hasOwnProperty(f)){var g=c[f],i=(f+":"+g).replace(O,
";");"inherit"==g?d+=i:e+=i}e.length&&(e=a(e));return b._ST=e+d};return h.Style=q},{requires:["./base","./range","./selection","./domIterator","./elementPath"]});
KISSY.add("editor/core/utils",function(d){var h=d.Node,r=d.DOM,s=d.UA,q={debugUrl:function(i){var e=d.Config;e.debug||(i=i.replace(/\.(js|css)/i,"-min.$1"));-1==i.indexOf("?t")&&(i=-1!=i.indexOf("?")?i+"&":i+"?",i+="t="+encodeURIComponent(e.tag));return e.base+"editor/"+i},lazyRun:function(d,e,h){var m=d[e],n=d[h];d[e]=function(){m.apply(this,arguments);d[e]=d[h];return n.apply(this,arguments)}},getXY:function(d,e,h,m){h=h.defaultView||h.parentWindow;d-=r.scrollLeft(h);e-=r.scrollTop(h);m&&(m=m.defaultView||
m.parentWindow,h!=m&&h.frameElement&&(m=r.offset(h.frameElement,void 0,m),d+=m.left,e+=m.top));return{left:d,top:e}},tryThese:function(d){for(var e,h=0,m=arguments.length;h<m;h++){var n=arguments[h];try{e=n();break}catch(q){}}return e},arrayCompare:function(d,e){if(!d&&!e)return!0;if(!d||!e||d.length!=e.length)return!1;for(var h=0;h<d.length;h++)if(d[h]!==e[h])return!1;return!0},clearAllMarkers:function(d){for(var e in d)d.hasOwnProperty(e)&&d[e]._4e_clearMarkers(d,!0,void 0)},ltrim:function(d){return d.replace(/^\s+/,
"")},rtrim:function(d){return d.replace(/\s+$/,"")},isNumber:function(i){return/^\d+(.\d+)?$/.test(d.trim(i))},verifyInputs:function(i){for(var e=0;e<i.length;e++){var k=new h(i[e]),m=d.trim(q.valInput(k)),n=k.attr("data-verify"),k=k.attr("data-warning");if(n&&!RegExp(n).test(m))return alert(k),!1}return!0},sourceDisable:function(d,e){d.on("sourceMode",e.disable,e);d.on("wysiwygMode",e.enable,e)},resetInput:function(d){var e=d.attr("placeholder");e&&s.ie?(d.addClass("ks-editor-input-tip"),d.val(e)):
s.ie||d.val("")},valInput:function(d,e){if(void 0===e)return d.hasClass("ks-editor-input-tip")?"":d.val();d.removeClass("ks-editor-input-tip");d.val(e)},placeholder:function(i,e){i.attr("placeholder",e);s.ie&&(i.on("blur",function(){d.trim(i.val())||(i.addClass("ks-editor-input-tip"),i.val(e))}),i.on("focus",function(){i.removeClass("ks-editor-input-tip");d.trim(i.val())==e&&i.val("")}))},htmlEncode:function(d){return!d?d:(""+d).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,
"&quot;")},normParams:function(i){var i=d.clone(i),e;for(e in i)if(i.hasOwnProperty(e)){var h=i[e];d.isFunction(h)&&(i[e]=h())}return i},map:function(d,e){for(var h=0;h<d.length;h++)d[h]=e(d[h]);return d},ieEngine:document.documentMode||s.ie,preventFocus:function(d){s.ie?d.unselectable(void 0):d.attr("onmousedown","return false;")},injectDom:function(i){d.mix(r,i);for(var e in i)i.hasOwnProperty(e)&&function(e){h.prototype[e]=function(){var m=[].slice.call(arguments,0);m.unshift(this[0]);return(m=
i[e].apply(null,m))&&(m.nodeType||d.isWindow(m))?new h(m):d.isArray(m)&&(m.__IS_NODELIST||m[0]&&m[0].nodeType)?new h(m):m}}(e)},addRes:function(){var h=this.__res=this.__res||[];h.push.apply(h,d.makeArray(arguments))},destroyRes:function(){for(var h=this.__res||[],e=0;e<h.length;e++){var k=h[e];d.isFunction(k)?k():k.destroy?k.destroy():k.remove&&k.remove()}this.__res=[]},getQueryCmd:function(d){return"query"+("-"+d).replace(/-(\w)/g,function(e,d){return d.toUpperCase()})+"Value"}};return d.Editor.Utils=
q},{requires:["./base"]});
KISSY.add("editor/core/walker",function(d,h){function r(a,c){if(this._.end)return k;var d,b=this.range,h,l=this.guard,m=this.type,q=a?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start&&(this._.start=1,b.trim(),b.collapsed))return this.end(),k;if(!a&&!this._.guardLTR){var r=b.endContainer[0],s=r.childNodes[b.endOffset];this._.guardLTR=function(a,b){return b&&(r==a||"body"==n.nodeName(a))?!1:a!=s}}if(a&&!this._.guardRTL){var t=b.startContainer[0],u=0<b.startOffset&&t.childNodes[b.startOffset-
1]||null;this._.guardRTL=function(a,b){return b&&(t==a||"body"==n.nodeName(a))?!1:a!=u}}var w=a?this._.guardRTL:this._.guardLTR;h=l?function(a,b){return w(a,b)===e?e:l(a,b)}:w;this.current?d=this.current[q](e,m,h):a?(d=b.endContainer,0<b.endOffset?(d=new o(d[0].childNodes[b.endOffset-1]),h(d[0])===e&&(d=k)):d=h(d,i)===e?k:d._4e_previousSourceNode(i,m,h,void 0)):(d=b.startContainer,d=new o(d[0].childNodes[b.startOffset]),d.length?h(d[0])===e&&(d=k):d=h(b.startContainer,i)===e?k:b.startContainer._4e_nextSourceNode(i,
m,h,void 0));for(;d&&!this._.end;){this.current=d;if(!this.evaluator||this.evaluator(d[0])!==e){if(!c)return d}else if(c&&this.evaluator)return e;d=d[q](e,m,h)}this.end();return this.current=k}function s(a){for(var c,d=k;c=r.call(this,a);)d=c;return d}function q(a){this.range=a;this.guard=this.evaluator=k;this._={}}var i=!0,e=!1,k=null,m=d.UA,n=d.DOM,u=h.XHTML_DTD,o=d.Node;d.augment(q,{end:function(){this._.end=1},next:function(){return r.call(this)},previous:function(){return r.call(this,i)},checkForward:function(){return r.call(this,
e,i)!==e},checkBackward:function(){return r.call(this,i,i)!==e},lastForward:function(){return s.call(this)},lastBackward:function(){return s.call(this,i)},reset:function(){delete this.current;this._={}},_iterator:r});d.mix(q,{blockBoundary:function(a){return function(c){return!(c.nodeType==n.ELEMENT_NODE&&n._4e_isBlockBoundary(c,a))}},bookmark:function(a,c){function d(a){return"span"==n.nodeName(a)&&n.attr(a,"_ke_bookmark")}return function(b){var e,h;e=b.nodeType==n.TEXT_NODE&&(h=b.parentNode)&&d(h);
e=a?e:e||d(b);return!!(c^e)}},whitespaces:function(a){return function(c){c=c.nodeType==n.TEXT_NODE&&!d.trim(c.nodeValue);return!!(a^c)}},invisible:function(a){var c=q.whitespaces();return function(d){d=c(d)||d.nodeType==n.ELEMENT_NODE&&!d.offsetHeight;return!!(a^d)}}});var w=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,t=q.whitespaces(),a=q.bookmark(),c=function(c){var d=n.nodeName(c);return a(c)||t(c)||1==c.nodeType&&d in u.$inline&&!(d in u.$empty)};h.Utils.injectDom({_4e_getBogus:function(a){a=new o(a);do a=
a._4e_previousSourceNode();while(a&&c(a[0]));return a&&(!m.ie?"br"==a.nodeName():3==a[0].nodeType&&w.test(a.text()))?a[0]:!1}});return h.Walker=q},{requires:["./base","./utils","./dom"]});KISSY.add("editor/core/zIndexManager",function(d){var h=d.Editor,d=h.zIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,STORE_FLASH_SHOW:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};h.baseZIndex=function(d){return(h.Config.baseZIndex||1E4)+d};return d},{requires:["./base"]});
KISSY.add("editor",function(d,h,r,s,q,i,e,k,m,n,u){function o(a,c){var d=a.body;H(function(){a.designMode="on";setTimeout(function(){a.designMode="off";d.focus();arguments.callee.retry||(arguments.callee.retry=f)},50)},function(){a.designMode="off";x.attr(d,"contentEditable",b);x.attr(d,"contentEditable",f);!c&&o(a,1)})}function w(a){a.get("iframe");var c=a.get("textarea")[0],e=a.get("window")[0],f=a.get("document")[0];l.webkit&&(A.on(f,"click",function(a){var b=new y(a.target);d.inArray(b.nodeName(),
["input","select"])&&a.preventDefault()}),A.on(f,"mouseup",function(a){var b=new y(a.target);d.inArray(b.nodeName(),["input","textarea"])&&a.preventDefault()}));if(l.gecko||v||l.opera){var g;g=(new y('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>')).insertAfter(c);g.on("focus",function(){a.focus()});a.activateGecko=function(){l.gecko&&a.__iframeFocus&&g[0].focus()};a.on("destroy",function(){g.detach();g.remove()})}A.on(e,"focus",function(){l.gecko?o(f,b):l.opera&&
f.body.focus();a.notifySelectionChange()});if(l.gecko)A.on(f,"mousedown",function(){a.__iframeFocus||o(f,b)});if(v&&(A.on(f,"keydown",function(b){if(b.keyCode in{8:1,46:1}){var c=a.getSelection(),d=c.getSelectedElement();if(d){a.execCommand("save");var e=c.getRanges()[0].createBookmark();d.remove();c.selectBookmarks([e]);a.execCommand("save");b.preventDefault()}}}),"CSS1Compat"==f.compatMode)){var h={33:1,34:1};A.on(f,"keydown",function(b){b.keyCode in h&&setTimeout(function(){a.getSelection().scrollIntoView()},
0)})}if(l.webkit)A.on(f,"mousedown",function(b){b=new y(b.target);d.inArray(b.nodeName(),["img","hr","input","textarea","select"])&&a.getSelection().selectElement(b)});if(l.gecko)A.on(f,"dragstart",function(a){var b=new y(a.target);b.nodeName()==="img"&&/ke_/.test(b[0].className)&&a.preventDefault()});s.add(a)}function t(a,b,c,e){var f="",g,h=r.debugUrl("theme/editor-iframe.css");for(g=0;g<c.length;g++)f+=d.substitute('<link href="{href}" rel="stylesheet" />',{href:c[g]});return d.substitute(B,{doctype:8===
j.documentMode?'<meta http-equiv="X-UA-Compatible" content="IE=7" />':"",title:"${title}",href:h,style:b,data:e||"&nbsp;",script:a?'<script id="ke_active_script">'+(x.isCustomDomain()?'document.domain="'+j.domain+'";':"")+'parent.KISSY.Editor._initIFrame("'+a+'");<\/script>':""})}function a(a,b){function c(){h=g.document;a.__set("document",new y(h));a.__set("window",new y(g));d.detach();h.open("text/html","replace");h.write(e);h.close()}var d=a.get("iframe"),e=t(a._UUID,a.get("customStyle"),a.get("customLink"),
b),f=d[0],g=f.contentWindow,h;d.__loaded=1;try{h=g.document}catch(i){if(f.src=f.src,7>v){setTimeout(c,10);return}}c()}function c(b,c){var d=new y(z),e=b.get("textarea");e.hasAttr("tabindex")&&d.attr("tabIndex",l.webkit?-1:e.attr("tabIndex"));e.parent().prepend(d);b.set("iframe",d);b.__docReady=0;if(l.gecko&&!d.__loaded)d.on("load",function(){a(b,c)},b);else a(b,c)}var f=!0,p=p,g=d.all,b=!1,j=document,l=d.UA,v=l.ie,x=d.DOM,y=d.Node,A=d.Event,H=r.tryThese,B="<!doctype html><html><head>{doctype}<title>{title}</title><link href='{href}' rel='stylesheet' /><style>{style}</style>{links}</head><body class='ks-editor'>{data}{script}</body></html>",
q=x.getEmptyIframeSrc(),z='<iframe style="width:100%;height:100%;border:none;"  frameborder="0"  title="kissy-editor"  allowTransparency="true" '+(q?' src="'+q+'"':"")+"></iframe>";d.mix(h,{SOURCE_MODE:0,WYSIWYG_MODE:1});var G=h.WYSIWYG_MODE;d.augment(h,{createDom:function(){var a,b=this.get("textarea"),c;b||this.set("textarea",b=g("<textarea class='ks-editor-textarea'></textarea>"));c=this.get("el");c.html('<div class="ks-editor-tools"></div><div class="ks-editor-textarea-wrap"></div><div class=\'ks-editor-status\'></div>');
a=c.one(".ks-editor-textarea-wrap");this._UUID=d.guid();this.set({toolBarEl:c.one(".ks-editor-tools"),statusBarEl:c.one(".ks-editor-status")},{silent:1});b.css("width","100%");b.css("display","none");a.append(b);s.register(this)},renderUI:function(){k.init(this);m.init(this);n.init(this);u.init(this)},bindUI:function(){function a(){b.detach("docReady",a);if(b.get("focused"))b.focus();else{var c=b.getSelection();c&&c.removeAllRanges()}}var b=this,c,d=b.get("prefixCls"),e=b.get("textarea");if(b.get("attachForm")&&
(c=e[0].form))x.on(c,"submit",b.sync,b),b.on("destroy",function(){x.detach(c,"submit",b.sync,b)});b.on("docReady",a);b.on("blur",function(){b.get("el").removeClass(d+"editor-focused")});b.on("focus",function(){b.get("el").addClass(d+"editor-focused")})},_uiSetHeight:function(a){var b=this.get("textarea"),c=this.get("toolBarEl"),d=this.get("statusBarEl"),a=parseInt(a,10),a=a-((c&&c.outerHeight()||0)+(d&&d.outerHeight()||0));b.parent().css("height",a);b.css("height",a)},_uiSetMode:function(a){var b=
this,c,d=b.get("render"),e=b.get("iframe"),f=b.get("textarea");a==G?(d&&b.execCommand("save"),b.on("docReady",c=function(){d&&b.execCommand("save");b.detach("docReady",c)}),b._setData(f.val()),b.fire("wysiwygMode")):(f.val(b._getData(1,G)),f.show(),e.hide(),b.fire("sourceMode"))},_uiSetFocused:function(a){a&&this.__docReady&&this.focus()},destructor:function(){var a=this.get("document")[0],b=this.get("window");this.sync();s.remove(this);A.remove([a,a.documentElement,a.body,b[0]]);d.each(this.__controls,
function(a){a.destroy&&a.destroy()});this.__commands={};this.__controls={}},getControl:function(a){return this.__controls[a]},getControls:function(){return this.__controls},addControl:function(a,b){this.__controls[a]=b},showDialog:function(a,b){var a=a+"/dialog",c=this.__controls[a];c.show(b);this.fire("dialogShow",{dialog:c.dialog,pluginDialog:c,dialogName:a})},addCommand:function(a,b){this.__commands[a]=b},hasCommand:function(a){return this.__commands[a]},execCommand:function(a){var b=this.__commands[a],
c=d.makeArray(arguments);c.shift();c.unshift(this);if(b)return b.exec.apply(b,c)},queryCommandValue:function(a){return this.execCommand(r.getQueryCmd(a))},_getData:function(a,b){var c=this.htmlDataProcessor,e;b==p&&(b=this.get("mode"));e=b==G?this.get("document")[0].body.innerHTML:c.toDataFormat(this.get("textarea").val());e=a?c.toHtml(e):c.toServer(e);e=d.trim(e);/^(?:<(p)>)?(?:(?:&nbsp;)|\s)*(?:<\/\1>)?$/.test(e)&&(e="");return e},_setData:function(a){var b,d=a;if(this.get("mode")!=G)this.get("textarea").val(a);
else{if(b=this.htmlDataProcessor)d=b.toDataFormat(a);if(this.get("iframe")){a=this.get("iframe");b=this.get("window")[0];var e=this.get("document")[0];A.remove([e,e.documentElement,e.body,b]);a.remove()}c(this,d)}},sync:function(){this.get("textarea").val(this.get("data"))},getDocHtml:function(){return t(0,this.get("customStyle"),this.get("customLink"),this.get("formatData"))},getSelection:function(){return h.Selection.getSelection(this.get("document")[0])},focus:function(){var a=this.get("document")[0],
b=x._getWin(a);l.ie||b&&b.parent&&b.parent.focus();b&&b.focus();a.body.focus();this.notifySelectionChange()},blur:function(){x._getWin(this.get("document")[0]).blur();this.get("document")[0].body.blur()},addCustomStyle:function(a,b){var c=this.get("customStyle")||"",c=c+("\n"+a);this.set("customStyle",c);x.addStyleSheet(this.get("window"),c,b)},removeCustomStyle:function(a){x.remove(x.get("#"+a,this.get("window")[0]))},addCustomLink:function(a){var b=this.get("customLink")||[],c=this.get("document")[0];
b.push(a);this.set("customLink",b);b=c.createElement("link");b.rel="stylesheet";c.getElementsByTagName("head")[0].appendChild(b);b.href=a},removeCustomLink:function(a){for(var b=this.get("document")[0],b=x.query("link",b),c=0;c<b.length;c++)x.attr(b[c],"href")==a&&x.remove(b[c]);b=this.get("customLink")||[];a=d.indexOf(a,b);-1!=a&&b.splice(a,1)},docReady:function(a){this.on("docReady",a);this.__docReady&&a.call(this)},checkSelectionChange:function(){var a=this;a.__checkSelectionChangeId&&clearTimeout(a.__checkSelectionChangeId);
a.__checkSelectionChangeId=setTimeout(function(){var b=a.getSelection();if(b&&!b.isInvalid){var c=b.getStartElement(),d=new h.ElementPath(c);if(!a.__previousPath||!a.__previousPath.compare(d))a.__previousPath=d,a.fire("selectionChange",{selection:b,path:d,element:c})}},100)},notifySelectionChange:function(){this.__previousPath=null;this.checkSelectionChange()},insertElement:function(a){if(this.get("mode")===G){this.focus();var b,c=a.nodeName(),d=h.XHTML_DTD,e=d.$block[c],g=h.RANGE,i=(c=this.getSelection())&&
c.getRanges(),j,k,l;if(i&&0!=i.length){this.execCommand("save");for(k=i.length-1;0<=k;k--)j=i[k],b=!k&&a||a.clone(f),j.insertNodeByDtd(b),l||(l=b);if(l)return j.moveToPosition(l,g.POSITION_AFTER_END),e&&(a=h.Walker.whitespaces(!0),(a=(l=l.next(a,1))&&l[0].nodeType==x.ELEMENT_NODE&&l.nodeName())&&d.$block[a]&&d[a]["#text"]&&j.moveToElementEditablePosition(l)),c.selectRanges([j]),this.focus(),b&&1==b[0].nodeType&&b.scrollIntoView(p,!1),F.call(this),b}}},insertHtml:function(a,c){var d=this,e,f=d.get("document")[0];
if(d.get("mode")===G){if(e=d.htmlDataProcessor)a=e.toDataFormat(a,c);d.focus();d.execCommand("save");if(v){e=f.selection;"Control"==e.type&&e.clear();try{e.createRange().pasteHTML(a)}catch(g){}}else try{f.execCommand("inserthtml",b,a)}catch(i){setTimeout(function(){if(0==d.getSelection().getRanges().length){var c=new h.Range(f),e=x.first(f.body,function(a){return 1==a.nodeType&&"br"!=x.nodeName(a)});e||(e=new y(f.createElement("p")),e._4e_appendBogus(p),f.body.appendChild(e[0]));c.setStartAt(e,h.RANGE.POSITION_AFTER_START);
c.select()}f.execCommand("inserthtml",b,a)},50)}setTimeout(function(){d.getSelection().scrollIntoView()},50);F.call(d)}}});h._initIFrame=function(a){var c=s.getInstance(a),d=c.get("document")[0],a=d.getElementById("ke_active_script");x.remove(a);w(c);var e=d.body;v?(e.hideFocus=f,e.disabled=f,e.contentEditable=f,e.removeAttribute("disabled")):setTimeout(function(){l.gecko||l.opera?e.contentEditable=f:l.webkit?e.parentNode.contentEditable=f:d.designMode="on"},0);if(l.gecko||l.opera){var g=d.documentElement;
A.on(g,"mousedown",function(a){if(a.target==g){l.gecko&&o(d,b);c.activateGecko()}})}setTimeout(function(){v&&setTimeout(function(){if(d){e.runtimeStyle.marginBottom="0px";e.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){c.__docReady=1;c.fire("docReady");var a=c.get("disableObjectResizing"),f=c.get("disableInlineTableEditing");if(a||f)try{d.execCommand("enableObjectResizing",b,!a);d.execCommand("enableInlineTableEditing",b,!f)}catch(g){A.on(e,v?"resizestart":"resize",function(b){var c=
new y(b.target);(a||c.nodeName()==="table"&&f)&&b.preventDefault()})}},10)};var F=d.buffer(function(){this.execCommand("save")},50);return h},{requires:"editor/core/base,editor/core/utils,editor/core/focusManager,editor/core/styles,editor/core/zIndexManager,editor/core/meta,editor/core/clipboard,editor/core/enterKey,editor/core/htmlDataProcessor,editor/core/selectionFix".split(",")});
