/*
Copyright 2013, KISSY UI Library v1.40dev
MIT Licensed
build time: Jul 25 22:23
*/
/*
 thanks to CKSource's intelligent work on CKEditor
 @author yiminghe@gmail.com
*/
KISSY.add("editor/iframe-content-tpl",'<!doctype html> <html> <head>{doctype} <title>{title}</title> <style> {style} </style> {links} </head> <body class="ks-editor"> {data} {script} </body> </html>');KISSY.add("editor/render-tpl",'<div class="{{prefixCls}}editor-tools" id="ks-editor-tools-{{id}}"> </div> <\!-- http://johanbrook.com/browsers/native-momentum-scrolling-ios-5/ ios \u4e0d\u80fd\u653e\u5728 iframe \u4e0a\uff01 --\> <div class="{{prefixCls}}editor-textarea-wrap" {{#if mobile}} style="overflow:scroll;-webkit-overflow-scrolling:touch;" {{/if}} id="ks-editor-textarea-wrap-{{id}}" > <textarea id="ks-editor-textarea-{{id}}" class="{{prefixCls}}editor-textarea" {{#each textareaAttrs}} {{xkey}}="{{.}}" {{/each}} {{#if mode}} style="display:none" {{/if}} >{{data}}</textarea> </div> <div class="{{prefixCls}}editor-status" id="ks-editor-status-{{id}}"> </div>');
KISSY.add("editor/render",function(a,r,s){return r.getDefaultRender().extend({beforeCreateDom:function(o,l){a.mix(o,{mobile:a.UA.mobile});a.mix(l,{textarea:"#ks-editor-textarea-{id}",toolBarEl:"#ks-editor-tools-{id}",statusBarEl:"#ks-editor-status-{id}"})}},{ATTRS:{contentTpl:{value:s}}})},{requires:["component/control","./render-tpl"]});
KISSY.add("editor/base",function(a,r,s,o){return s.extend({},{Config:{},XHTML_DTD:r.DTD,ATTRS:{textarea:{},textareaAttrs:{view:1},iframe:{},window:{},document:{},toolBarEl:{},statusBarEl:{},handleMouseEvents:{value:!1},focusable:{value:!1},mode:{value:1},data:{view:1},customStyle:{value:""},customLink:{value:[]},xrender:{value:o}},xclass:"editor",name:"EditorRender"})},{requires:["html-parser","component/control","./render"]});
KISSY.add("editor/utils",function(a,r){var s=a.Node,o=a.DOM,l=a.UA,v={debugUrl:function(e){var i=a.Config;i.debug||(e=e.replace(/\.(js|css)/i,"-min.$1"));-1==e.indexOf("?t")&&(e=-1!=e.indexOf("?")?e+"&":e+"?",e+="t="+encodeURIComponent(i.tag));return i.base+"editor/"+e},lazyRun:function(a,i,n){var p=a[i],l=a[n];a[i]=function(){p.apply(this,arguments);a[i]=a[n];return l.apply(this,arguments)}},getXY:function(a,i){var n=a.left,p=a.top,l=i.get("window")[0],n=n-o.scrollLeft(l),p=p-o.scrollTop(l),l=i.get("iframe").offset(),
n=n+l.left,p=p+l.top;return{left:n,top:p}},tryThese:function(a){for(var i,n=0,p=arguments.length;n<p;n++){var l=arguments[n];try{i=l();break}catch(k){}}return i},arrayCompare:function(a,i){if(!a&&!i)return!0;if(!a||!i||a.length!=i.length)return!1;for(var n=0;n<a.length;n++)if(a[n]!==i[n])return!1;return!0},clearAllMarkers:function(a){for(var i in a)a[i]._4e_clearMarkers(a,!0,void 0)},ltrim:function(a){return a.replace(/^\s+/,"")},rtrim:function(a){return a.replace(/\s+$/,"")},isNumber:function(e){return/^\d+(.\d+)?$/.test(a.trim(e))},
verifyInputs:function(e){for(var i=0;i<e.length;i++){var n=new s(e[i]),p=a.trim(v.valInput(n)),l=n.attr("data-verify"),n=n.attr("data-warning");if(l&&!RegExp(l).test(p))return alert(n),!1}return!0},sourceDisable:function(a,i){a.on("sourceMode",i.disable,i);a.on("wysiwygMode",i.enable,i)},resetInput:function(a){var i=a.attr("placeholder");i&&l.ie?(a.addClass("ks-editor-input-tip"),a.val(i)):l.ie||a.val("")},valInput:function(a,i){if(void 0===i)return a.hasClass("ks-editor-input-tip")?"":a.val();a.removeClass("ks-editor-input-tip");
a.val(i)},placeholder:function(e,i){e.attr("placeholder",i);l.ie&&(e.on("blur",function(){a.trim(e.val())||(e.addClass("ks-editor-input-tip"),e.val(i))}),e.on("focus",function(){e.removeClass("ks-editor-input-tip");a.trim(e.val())==i&&e.val("")}))},htmlEncode:function(a){return!a?a:(""+a).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")},normParams:function(e){var e=a.clone(e),i;for(i in e){var n=e[i];"function"===typeof n&&(e[i]=n())}return e},map:function(a,
i){for(var n=0;n<a.length;n++)a[n]=i(a[n]);return a},ieEngine:document.documentMode||l.ie,preventFocus:function(a){l.ie?a.unselectable():a.attr("onmousedown","return false;")},injectDom:function(e){a.mix(o,e);for(var i in e)(function(i){s.prototype[i]=function(){var p=[].slice.call(arguments,0);p.unshift(this[0]);return(p=e[i].apply(null,p))&&(p.nodeType||a.isWindow(p))?new s(p):a.isArray(p)&&(p.__IS_NODELIST||p[0]&&p[0].nodeType)?new s(p):p}})(i)},addRes:function(){var e=this.__res=this.__res||[];
e.push.apply(e,a.makeArray(arguments))},destroyRes:function(){for(var a=this.__res||[],i=0;i<a.length;i++){var n=a[i];"function"===typeof n?n():n.destroy?n.destroy():n.remove&&n.remove()}this.__res=[]},getQueryCmd:function(a){return"query"+("-"+a).replace(/-(\w)/g,function(a,e){return e.toUpperCase()})+"Value"}};return r.Utils=v},{requires:["./base","node"]});
KISSY.add("editor/dom",function(a,r,s){function o(j,f){var a=j[f?"next":"prev"](l,1);if(a&&a[0].nodeType==i.ELEMENT_NODE){for(var b=[];a.attr("_ke_bookmark")||a._4e_isEmptyInlineRemovable(l);)if(b.push(a),a=f?a.next(l,1):a.prev(l,1),!a)return;if(j._4e_isIdentical(a,l)){for(var h=new p(f?j[0].lastChild:j[0].firstChild);b.length;)b.shift()._4e_move(j,!f,l);a._4e_moveChildren(j,!f,l);a.remove();h[0]&&h[0].nodeType==i.ELEMENT_NODE&&h._4e_mergeSiblings()}}}var l=l,v=r.XHTML_DTD,e=a.DOM,i=e.NodeType,n=
a.UA,p=a.Node,x={a:1,abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};r.POSITION={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};var k=r.POSITION,w={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,
"table-column":1,"table-cell":1,"table-caption":1},y={hr:1},c=function(a){return a&&(a[0]||a)};s.injectDom({_4e_sameLevel:function(a,f){var f=c(f),t=a.parentNode;return t&&t==f.parentNode},_4e_isBlockBoundary:function(j,f){var c=a.merge(y,f);return!(!w[e.css(j,"display")]&&!c[e.nodeName(j)])},_4e_index:function(a,f){for(var c=a.parentNode.childNodes,b,h=-1,d=0;d<c.length;d++)if(b=c[d],!f||!(3==b.nodeType&&b.previousSibling&&3==b.previousSibling.nodeType))if(h++,b===a)return h;return-1},_4e_move:function(a,
f,t){f=c(f);t?f.insertBefore(a,f.firstChild):f.appendChild(a)},_4e_isIdentical:function(a,f){if(!f)return!1;f=c(f);if(e.nodeName(a)!=e.nodeName(f))return!1;var t=a.attributes,b=f.attributes,h=t.length,d=b.length;if(h!=d)return!1;for(var g=0;g<h;g++){var m=t[g],u=m.name;if(m.specified&&e.attr(a,u)!=e.attr(f,u))return!1}if(8>s.ieEngine)for(g=0;g<d;g++)if(m=b[g],u=m.name,m.specified&&e.attr(a,u)!=e.attr(f,u))return!1;return!0},_4e_isEmptyInlineRemovable:function(j){if(!v.$removeEmpty[e.nodeName(j)])return!1;
for(var j=j.childNodes,f=0,c=j.length;f<c;f++){var b=j[f],h=b.nodeType;if(!(h==i.ELEMENT_NODE&&b.getAttribute("_ke_bookmark"))&&(h==i.ELEMENT_NODE&&!e._4e_isEmptyInlineRemovable(b)||h==e.NodeType.TEXT_NODE&&a.trim(b.nodeValue)))return!1}return!0},_4e_moveChildren:function(a,f,t){f=c(f);if(a!=f)if(t)for(;t=a.lastChild;)f.insertBefore(a.removeChild(t),f.firstChild);else for(;t=a.firstChild;)f.appendChild(a.removeChild(t))},_4e_mergeSiblings:function(a){a=new p(a);x[a.nodeName()]&&(o(a,!0),o(a))},_4e_splitText:function(a,
f){var c=a.ownerDocument;if(a.nodeType==e.NodeType.TEXT_NODE){if(n.ie&&f==a.nodeValue.length){var b=c.createTextNode("");e.insertAfter(b,a);return b}b=a.splitText(f);c.documentMode&&(c=c.createTextNode(""),e.insertAfter(c,b),e.remove(c));return b}},_4e_parents:function(a,f){var c=[];c.__IS_NODELIST=1;do c[f?"push":"unshift"](a);while(a=a.parentNode);return c},_4e_nextSourceNode:function(a,f,t,b){if(b&&!b.call)var h=c(b),b=function(a){return a!==h};var f=!f&&a.firstChild,d=a;if(!f){if(a.nodeType==
i.ELEMENT_NODE&&b&&!1===b(a,!0))return null;f=a.nextSibling}for(;!f&&(d=d.parentNode);){if(b&&!1===b(d,!0))return null;f=d.nextSibling}return!f||b&&!1===b(f)?null:t&&t!=f.nodeType?e._4e_nextSourceNode(f,!1,t,b):f},_4e_previousSourceNode:function(a,f,t,b){if(b&&!b.call)var h=c(b),b=function(a){return a!==h};var f=!f&&a.lastChild,d=a;if(!f){if(a.nodeType==i.ELEMENT_NODE&&b&&!1===b(a,!0))return null;f=a.previousSibling}for(;!f&&(d=d.parentNode);){if(b&&!1===b(d,!0))return null;f=d.previousSibling}return!f||
b&&!1===b(f)?null:t&&f.nodeType!=t?e._4e_previousSourceNode(f,!1,t,b):f},_4e_commonAncestor:function(a,f){f=c(f);if(a===f)return a;if(e.contains(f,a))return f;var t=a;do if(e.contains(t,f))return t;while(t=t.parentNode);return null},_4e_hasAttributes:9>s.ieEngine?function(a){for(var f=a.attributes,c=0;c<f.length;c++){var b=f[c];switch(b.name){case "class":if(a.getAttribute("class"))return!0;break;default:if(b.specified)return!0}}return!1}:function(a){n.gecko&&a.removeAttribute("_moz_dirty");return a.hasAttributes()},
_4e_position:function(a,f){var t=c(f);if(a.compareDocumentPosition)return a.compareDocumentPosition(t);if(a==t)return k.POSITION_IDENTICAL;if(a.nodeType==i.ELEMENT_NODE&&t.nodeType==i.ELEMENT_NODE){if(e.contains(a,t))return k.POSITION_CONTAINS+k.POSITION_PRECEDING;if(e.contains(t,a))return k.POSITION_IS_CONTAINED+k.POSITION_FOLLOWING;if("sourceIndex"in a)return 0>a.sourceIndex||0>t.sourceIndex?k.POSITION_DISCONNECTED:a.sourceIndex<t.sourceIndex?k.POSITION_PRECEDING:k.POSITION_FOLLOWING}for(var b=
e._4e_address(a),t=e._4e_address(t),h=Math.min(b.length,t.length),d=0;d<=h-1;d++)if(b[d]!=t[d])return b[d]<t[d]?k.POSITION_PRECEDING:k.POSITION_FOLLOWING;return b.length<t.length?k.POSITION_CONTAINS+k.POSITION_PRECEDING:k.POSITION_IS_CONTAINED+k.POSITION_FOLLOWING},_4e_address:function(a,f){for(var c=[],b=a.ownerDocument.documentElement,h=a;h&&h!=b;)c.unshift(e._4e_index(h,f)),h=h.parentNode;return c},_4e_remove:function(a,f){var c=a.parentNode;if(c){if(f)for(var b;b=a.firstChild;)c.insertBefore(a.removeChild(b),
a);c.removeChild(a)}return a},_4e_trim:function(a){e._4e_ltrim(a);e._4e_rtrim(a)},_4e_ltrim:function(a){for(var f;f=a.firstChild;){if(f.nodeType==e.NodeType.TEXT_NODE){var c=s.ltrim(f.nodeValue),b=f.nodeValue.length;if(c)c.length<b&&(e._4e_splitText(f,b-c.length),a.removeChild(a.firstChild));else{a.removeChild(f);continue}}break}},_4e_rtrim:function(a){for(var f;f=a.lastChild;){if(f.type==e.NodeType.TEXT_NODE){var c=s.rtrim(f.nodeValue),b=f.nodeValue.length;if(c)c.length<b&&(e._4e_splitText(f,c.length),
a.removeChild(a.lastChild));else{a.removeChild(f);continue}}break}!n.ie&&!n.opera&&(f=a.lastChild)&&1==f.nodeType&&"br"==e.nodeName(f)&&a.removeChild(f)},_4e_appendBogus:function(c){for(var f=c.lastChild;f&&f.nodeType==e.NodeType.TEXT_NODE&&!a.trim(f.nodeValue);)f=f.previousSibling;if(!f||f.nodeType==e.NodeType.TEXT_NODE||"br"!==e.nodeName(f))f=n.opera?c.ownerDocument.createTextNode(""):c.ownerDocument.createElement("br"),c.appendChild(f)},_4e_setMarker:function(c,f,e,b){var c=new p(c),h=c.data("list_marker_id")||
c.data("list_marker_id",a.guid()).data("list_marker_id"),d=c.data("list_marker_names")||c.data("list_marker_names",{}).data("list_marker_names");f[h]=c;d[e]=1;return c.data(e,b)},_4e_clearMarkers:function(a,f,c){var a=new p(a),b=a.data("list_marker_names"),h=a.data("list_marker_id"),d;for(d in b)a.removeData(d);a.removeData("list_marker_names");c&&(a.removeData("list_marker_id"),delete f[h])},_4e_copyAttributes:function(a,f,c){for(var f=new p(f),b=a.attributes,c=c||{},h=0;h<b.length;h++){var d=b[h],
g=d.name.toLowerCase(),m;if(!(g in c))if("checked"==g&&(m=e.attr(a,g)))f.attr(g,m);else if(d.specified||n.ie&&d.value&&"value"==g)m=e.attr(a,g),null===m&&(m=d.nodeValue),f.attr(g,m)}""!==a.style.cssText&&(f[0].style.cssText=a.style.cssText)},_4e_isEditable:function(a){a=e.nodeName(a);return(a=!v.$nonEditable[a]&&(v[a]||v.span))&&a["#text"]},_4e_getByAddress:function(a,f,c){for(var a=a.documentElement,b=0;a&&b<f.length;b++){var h=f[b];if(c)for(var d=-1,g=0;g<a.childNodes.length;g++){var m=a.childNodes[g];
if(!(!0===c&&3==m.nodeType&&m.previousSibling&&3==m.previousSibling.nodeType)&&(d++,d==h)){a=m;break}}else a=a.childNodes[h]}return a}})},{requires:["./base","./utils","node"]});
KISSY.add("editor/focusManager",function(a,r){function s(){var a=this;a.__iframeFocus=n;e=a;v&&clearTimeout(v);v=setTimeout(function(){a.fire("focus")},30)}function o(){var a=this;a.__iframeFocus=p;e=x;v&&clearTimeout(v);v=setTimeout(function(){a.fire("blur")},30)}var l={},v,e,i={refreshAll:function(){for(var a in l){var e=l[a].get("document")[0];e.designMode="off";e.designMode="on"}},currentInstance:function(){return e},getInstance:function(a){return l[a]},add:function(a){a.get("window").on("focus",
s,a).on("blur",o,a)},register:function(a){l[a.get("id")]=a},remove:function(a){delete l[a.get("id")];a.get("window").detach("focus",s,a).detach("blur",o,a)}},n=!0,p=!1,x=null;i.refreshAll=i.refreshAll;r.focusManager=i;r.getInstances=function(){return l};return i},{requires:["./base","./dom"]});
KISSY.add("editor/walker",function(a,r){function s(a,c){if(this._.end)return i;var b,h=this.range,d,g=this.guard,m=this.type,u=a?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start&&(this._.start=1,h.trim(),h.collapsed))return this.end(),i;if(!a&&!this._.guardLTR){var j=h.endContainer[0],n=j.childNodes[h.endOffset];this._.guardLTR=function(a,b){return b&&(j==a||"body"==p.nodeName(a))?!1:a!=n}}if(a&&!this._.guardRTL){var l=h.startContainer[0],G=0<h.startOffset&&l.childNodes[h.startOffset-
1]||null;this._.guardRTL=function(a,b){return b&&(l==a||"body"==p.nodeName(a))?!1:a!=G}}var J=a?this._.guardRTL:this._.guardLTR;d=g?function(a,b){return J(a,b)===e?e:g(a,b)}:J;this.current?b=this.current[u](e,m,d):a?(b=h.endContainer,0<h.endOffset?(b=new k(b[0].childNodes[h.endOffset-1]),d(b[0])===e&&(b=i)):b=d(b,v)===e?i:b._4e_previousSourceNode(v,m,d,void 0)):(b=h.startContainer,b=new k(b[0].childNodes[h.startOffset]),b.length?d(b[0])===e&&(b=i):b=d(h.startContainer,v)===e?i:h.startContainer._4e_nextSourceNode(v,
m,d,void 0));for(;b&&!this._.end;){this.current=b;if(!this.evaluator||this.evaluator(b[0])!==e){if(!c)return b}else if(c&&this.evaluator)return e;b=b[u](e,m,d)}this.end();return this.current=i}function o(a){for(var c,b=i;c=s.call(this,a);)b=c;return b}function l(a){this.range=a;this.guard=this.evaluator=i;this._={}}var v=!0,e=!1,i=null,n=a.UA,p=a.DOM,x=r.XHTML_DTD,k=a.Node;a.augment(l,{end:function(){this._.end=1},next:function(){return s.call(this)},previous:function(){return s.call(this,v)},checkForward:function(){return s.call(this,
e,v)!==e},checkBackward:function(){return s.call(this,v,v)!==e},lastForward:function(){return o.call(this)},lastBackward:function(){return o.call(this,v)},reset:function(){delete this.current;this._={}},_iterator:s});a.mix(l,{blockBoundary:function(a){return function(c){return!(c.nodeType==p.NodeType.ELEMENT_NODE&&p._4e_isBlockBoundary(c,a))}},bookmark:function(a,c){function b(a){return"span"==p.nodeName(a)&&p.attr(a,"_ke_bookmark")}return function(h){var d,g;d=h.nodeType==p.NodeType.TEXT_NODE&&(g=
h.parentNode)&&b(g);d=a?d:d||b(h);return!!(c^d)}},whitespaces:function(c){return function(e){e=e.nodeType==p.NodeType.TEXT_NODE&&!a.trim(e.nodeValue);return!!(c^e)}},invisible:function(a){var c=l.whitespaces();return function(b){b=c(b)||b.nodeType==p.NodeType.ELEMENT_NODE&&!b.offsetHeight;return!!(a^b)}}});var w=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,y=l.whitespaces(),c=l.bookmark(),j=function(a){var e=p.nodeName(a);return c(a)||y(a)||1==a.nodeType&&e in x.$inline&&!(e in x.$empty)};r.Utils.injectDom({_4e_getBogus:function(a){a=
new k(a);do a=a._4e_previousSourceNode();while(a&&j(a[0]));return a&&(!n.ie?"br"==a.nodeName():3==a[0].nodeType&&w.test(a.text()))?a[0]:!1}});return r.Walker=l},{requires:["./base","./utils","./dom","node"]});
KISSY.add("editor/elementPath",function(a,r){function s(a){for(var p=v,r=v,k=[];a;){if(a[0].nodeType==o.NodeType.ELEMENT_NODE){this.lastElement||(this.lastElement=a);var w=a.nodeName();if(!r&&(!p&&e[w]&&(p=a),i[w])){var s;if(s=!p)if(s="div"==w){a:{s=a[0].childNodes;for(var c=0,j=s.length;c<j;c++){var f=s[c];if(f.nodeType==o.NodeType.ELEMENT_NODE&&l.$block[f.nodeName.toLowerCase()]){s=!0;break a}}s=!1}s=!s}s?p=a:r=a}k.push(a);if("body"==w)break}a=a.parent()}this.block=p;this.blockLimit=r;this.elements=
k}var o=a.DOM,l=r.XHTML_DTD,v=null,e={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},i={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};s.prototype={constructor:s,compare:function(a){var e=this.elements,a=a&&a.elements;if(!a||e.length!=a.length)return!1;for(var i=0;i<e.length;i++)if(!o.equals(e[i],a[i]))return!1;return!0},contains:function(a){for(var e=this.elements,i=0;i<e.length;i++)if(e[i].nodeName()in a)return e[i];return v},toString:function(){var a=
this.elements,e,i=[];for(e=0;e<a.length;e++)i.push(a[e].nodeName());return i.toString()}};return r.ElementPath=s},{requires:["./base","./dom","node"]});
KISSY.add("editor/range",function(a,r,s,o,l){function v(c){var d=c.nodeType!=f.NodeType.TEXT_NODE&&f.nodeName(c)in b.$removeEmpty,h=c.nodeType==f.NodeType.TEXT_NODE&&!a.trim(c.nodeValue),c=!!c.parentNode.getAttribute("_ke_bookmark");return d||h||c}function e(a){return!m(a)&&!u(a)}function i(b){var c=w;return function(d){if(u(d))return k;if(d.nodeType==f.NodeType.TEXT_NODE){if(a.trim(d.nodeValue).length)return w}else if(d.nodeType==f.NodeType.ELEMENT_NODE&&(d=f.nodeName(d),!A[d]))if(!b&&!t.ie&&"br"==
d&&!c)c=k;else return w;return k}}function n(a,b){var c=a.startContainer,d=a.endContainer,q=a.startOffset,g=a.endOffset,m,e=w,u=w,i=void 0,j=a.document,t;0<b&&(i=j.createDocumentFragment());if(a.collapsed)return i;a.optimizeBookmark();d[0].nodeType==f.NodeType.TEXT_NODE?(u=k,d=d._4e_splitText(g)):0<d[0].childNodes.length&&(g>=d[0].childNodes.length?(d=new h(d[0].appendChild(j.createTextNode(""))),t=k):d=new h(d[0].childNodes[g]));c[0].nodeType==f.NodeType.TEXT_NODE?(e=k,c._4e_splitText(q)):q?q>=c[0].childNodes.length?
(c=new h(c[0].appendChild(j.createTextNode(""))),m=k):c=new h(c[0].childNodes[q].previousSibling):(m=new h(j.createTextNode("")),c.prepend(m),c=m,m=k);var H=c._4e_parents(),K=d._4e_parents();H.each(function(a,b){H[b]=a});K.each(function(a,b){K[b]=a});for(var F,O,j=0;j<H.length&&!(F=H[j],O=K[j],!F.equals(O));j++);for(var q=i,B,l,n=j;n<H.length;n++){B=H[n];g=0<b&&!B.equals(c)?q.appendChild(B.clone()[0]):null;B=B[0].nextSibling;l=K[n];for(var p=d[0],D=l&&l[0];B&&!(D==B||p==B);)l=B.nextSibling,2==b?q.appendChild(B.cloneNode(k)):
(f._4e_remove(B),1==b&&q.appendChild(B)),B=l;g&&(q=g)}for(q=i;j<K.length;j++){B=K[j];g=0<b&&!B.equals(d)?q.appendChild(B.clone()[0]):null;if(!H[j]||!B._4e_sameLevel(H[j]))for(B=B[0].previousSibling;B;)l=B.previousSibling,2==b?q.insertBefore(B.cloneNode(k),q.firstChild):(f._4e_remove(B),1==b&&q.insertBefore(B,q.firstChild)),B=l;g&&(q=g)}if(2==b){if(e&&(F=c[0],F.nodeType==f.NodeType.TEXT_NODE&&F.nextSibling&&F.nextSibling.nodeType==f.NodeType.TEXT_NODE&&(F.data+=F.nextSibling.data,F.parentNode.removeChild(F.nextSibling))),
u)u=d[0],u.nodeType==f.NodeType.TEXT_NODE&&u.previousSibling&&u.previousSibling.nodeType==f.NodeType.TEXT_NODE&&(u.previousSibling.data+=u.data,u.parentNode.removeChild(u))}else{if(F&&O&&(!c._4e_sameLevel(F)||!d._4e_sameLevel(O)))u=F._4e_index(),m&&F._4e_sameLevel(c)&&u--,a.setStart(F.parent(),u+1);a.collapse(k)}m&&c.remove();t&&d.remove();return i}function p(a){a.collapsed=a.startContainer&&a.endContainer&&a.startContainer[0]==a.endContainer[0]&&a.startOffset==a.endOffset}function x(a){this.endOffset=
this.endContainer=this.startOffset=this.startContainer=y;this.collapsed=k;this.document=a}r.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var k=!0,w=!1,y=null,c=r.RANGE,j=r.POSITION,f=a.DOM,t=a.UA,b=r.XHTML_DTD,h=a.Node,d=h.all,g={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},m=new o.whitespaces,u=new o.bookmark,
D=o.whitespaces(k),E=o.bookmark(!1,!0),A={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};a.augment(x,{toString:function(){var a=[],b=this.startContainer[0],c=this.endContainer[0];a.push((b.id||b.nodeName)+":"+this.startOffset);a.push((c.id||c.nodeName)+":"+this.endOffset);return a.join("<br/>")},optimize:function(){var a=this.startContainer,b=this.startOffset;a[0].nodeType!=f.NodeType.ELEMENT_NODE&&
(b?b>=a[0].nodeValue.length&&this.setStartAfter(a):this.setStartBefore(a));a=this.endContainer;b=this.endOffset;a[0].nodeType!=f.NodeType.ELEMENT_NODE&&(b?b>=a[0].nodeValue.length&&this.setEndAfter(a):this.setEndBefore(a))},setStartAfter:function(a){this.setStart(a.parent(),a._4e_index()+1)},setStartBefore:function(a){this.setStart(a.parent(),a._4e_index())},setEndAfter:function(a){this.setEnd(a.parent(),a._4e_index()+1)},setEndBefore:function(a){this.setEnd(a.parent(),a._4e_index())},optimizeBookmark:function(){var a=
this.startContainer,b=this.endContainer;a&&"span"==a.nodeName()&&a.attr("_ke_bookmark")&&this.setStartBefore(a);b&&"span"==b.nodeName()&&b.attr("_ke_bookmark")&&this.setEndAfter(b)},setStart:function(a,b){a[0].nodeType==f.NodeType.ELEMENT_NODE&&g[a.nodeName()]&&(a=a.parent(),b=a._4e_index());this.startContainer=a;this.startOffset=b;this.endContainer||(this.endContainer=a,this.endOffset=b);p(this)},setEnd:function(a,b){a[0].nodeType==f.NodeType.ELEMENT_NODE&&g[a.nodeName()]&&(a=a.parent(),b=a._4e_index()+
1);this.endContainer=a;this.endOffset=b;this.startContainer||(this.startContainer=a,this.startOffset=b);p(this)},setStartAt:function(a,b){switch(b){case c.POSITION_AFTER_START:this.setStart(a,0);break;case c.POSITION_BEFORE_END:a[0].nodeType==f.NodeType.TEXT_NODE?this.setStart(a,a[0].nodeValue.length):this.setStart(a,a[0].childNodes.length);break;case c.POSITION_BEFORE_START:this.setStartBefore(a);break;case c.POSITION_AFTER_END:this.setStartAfter(a)}p(this)},setEndAt:function(a,b){switch(b){case c.POSITION_AFTER_START:this.setEnd(a,
0);break;case c.POSITION_BEFORE_END:a[0].nodeType==f.NodeType.TEXT_NODE?this.setEnd(a,a[0].nodeValue.length):this.setEnd(a,a[0].childNodes.length);break;case c.POSITION_BEFORE_START:this.setEndBefore(a);break;case c.POSITION_AFTER_END:this.setEndAfter(a)}p(this)},cloneContents:function(){return n(this,2)},deleteContents:function(){return n(this,0)},extractContents:function(){return n(this,1)},collapse:function(a){a?(this.endContainer=this.startContainer,this.endOffset=this.startOffset):(this.startContainer=
this.endContainer,this.startOffset=this.endOffset);this.collapsed=k},clone:function(){var a=new x(this.document);a.startContainer=this.startContainer;a.startOffset=this.startOffset;a.endContainer=this.endContainer;a.endOffset=this.endOffset;a.collapsed=this.collapsed;return a},getEnclosedNode:function(){var a=this.clone();a.optimize();if(a.startContainer[0].nodeType!=f.NodeType.ELEMENT_NODE||a.endContainer[0].nodeType!=f.NodeType.ELEMENT_NODE)return y;var b=new o(a);b.evaluator=function(a){return D(a)&&
E(a)};a=b.next();b.reset();b=b.previous();return a&&a.equals(b)?a:y},shrink:function(a,b){if(!this.collapsed){var a=a||c.SHRINK_TEXT,d=this.clone(),h=this.startContainer,q=this.endContainer,g=this.startOffset,m=this.endOffset,e=k,u,j,i=k;h&&h[0].nodeType==f.NodeType.TEXT_NODE&&(g?g>=h[0].nodeValue.length?d.setStartAfter(h):(d.setStartBefore(h),e=w):d.setStartBefore(h));q&&q[0].nodeType==f.NodeType.TEXT_NODE&&(m?m>=q[0].nodeValue.length?d.setEndAfter(q):(d.setEndAfter(q),i=w):d.setEndBefore(q));if(e||
i)j=new o(d),j.evaluator=function(b){return b.nodeType==(a==c.SHRINK_ELEMENT?f.NodeType.ELEMENT_NODE:f.NodeType.TEXT_NODE)},j.guard=function(b,d){if(a==c.SHRINK_ELEMENT&&b.nodeType==f.NodeType.TEXT_NODE||d&&b==u)return w;!d&&b.nodeType==f.NodeType.ELEMENT_NODE&&(u=b);return k};e&&(d=j[a==c.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(d,b?c.POSITION_AFTER_START:c.POSITION_BEFORE_START);i&&(j.reset(),(j=j[a==c.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(j,b?c.POSITION_BEFORE_END:
c.POSITION_AFTER_END));return e||i}},createBookmark2:function(a){var b=this.startContainer,c=this.endContainer,d=this.startOffset,q=this.endOffset,g,m;if(!b||!c)return{start:0,end:0};if(a){if(b[0].nodeType==f.NodeType.ELEMENT_NODE&&(g=new h(b[0].childNodes[d]))&&g[0]&&g[0].nodeType==f.NodeType.TEXT_NODE&&0<d&&g[0].previousSibling.nodeType==f.NodeType.TEXT_NODE)b=g,d=0;for(;b[0].nodeType==f.NodeType.TEXT_NODE&&(m=b.prev(void 0,1))&&m[0].nodeType==f.NodeType.TEXT_NODE;)b=m,d+=m[0].nodeValue.length;
if(!this.collapsed){if(c[0].nodeType==f.NodeType.ELEMENT_NODE&&(g=new h(c[0].childNodes[q]))&&g[0]&&g[0].nodeType==f.NodeType.TEXT_NODE&&0<q&&g[0].previousSibling.nodeType==f.NodeType.TEXT_NODE)c=g,q=0;for(;c[0].nodeType==f.NodeType.TEXT_NODE&&(m=c.prev(void 0,1))&&m[0].nodeType==f.NodeType.TEXT_NODE;)c=m,q+=m[0].nodeValue.length}}return{start:b._4e_address(a),end:this.collapsed?y:c._4e_address(a),startOffset:d,endOffset:q,normalized:a,is2:k}},createBookmark:function(b){var d,g,f,q,m=this.collapsed;
d=new h("<span>",y,this.document);d.attr("_ke_bookmark",1);d.css("display","none");d.html("&nbsp;");b&&(f=a.guid("ke_bm_"),d.attr("id",f+"S"));m||(g=d.clone(),g.html("&nbsp;"),b&&g.attr("id",f+"E"),q=this.clone(),q.collapse(),q.insertNode(g));q=this.clone();q.collapse(k);q.insertNode(d);g?(this.setStartAfter(d),this.setEndBefore(g)):this.moveToPosition(d,c.POSITION_AFTER_END);return{startNode:b?f+"S":d,endNode:b?f+"E":g,serializable:b,collapsed:m}},moveToPosition:function(a,b){this.setStartAt(a,b);
this.collapse(k)},trim:function(a,b){var d=this.startContainer,c=this.startOffset,q=this.collapsed;if((!a||q)&&d[0]&&d[0].nodeType==f.NodeType.TEXT_NODE){if(c)if(c>=d[0].nodeValue.length)c=d._4e_index()+1,d=d.parent();else{var h=d._4e_splitText(c),c=d._4e_index()+1,d=d.parent();f.equals(this.startContainer,this.endContainer)?this.setEnd(h,this.endOffset-this.startOffset):f.equals(d,this.endContainer)&&(this.endOffset+=1)}else c=d._4e_index(),d=d.parent();this.setStart(d,c);if(q){this.collapse(k);
return}}d=this.endContainer;c=this.endOffset;!b&&!q&&d[0]&&d[0].nodeType==f.NodeType.TEXT_NODE&&(c?(c>=d[0].nodeValue.length||d._4e_splitText(c),c=d._4e_index()+1):c=d._4e_index(),d=d.parent(),this.setEnd(d,c))},insertNode:function(a){this.optimizeBookmark();this.trim(w,k);var b=this.startContainer;b[0].insertBefore(a[0],b[0].childNodes[this.startOffset]||null);b[0]==this.endContainer[0]&&this.endOffset++;this.setStartBefore(a)},moveToBookmark:function(b){var c=d(this.document);if(b.is2){var h=c._4e_getByAddress(b.start,
b.normalized),g=b.startOffset,c=b.end&&c._4e_getByAddress(b.end,b.normalized),b=b.endOffset;this.setStart(h,g);c?this.setEnd(c,b):this.collapse(k)}else h=(g=b.serializable)?a.one("#"+b.startNode,c):b.startNode,b=g?a.one("#"+b.endNode,c):b.endNode,this.setStartBefore(h),h._4e_remove(),b&&b[0]?(this.setEndBefore(b),b._4e_remove()):this.collapse(k)},getCommonAncestor:function(a,b){var d=this.startContainer,c=this.endContainer,d=d[0]==c[0]?a&&d[0].nodeType==f.NodeType.ELEMENT_NODE&&this.startOffset==
this.endOffset-1?new h(d[0].childNodes[this.startOffset]):d:d._4e_commonAncestor(c);return b&&d[0].nodeType==f.NodeType.TEXT_NODE?d.parent():d},enlarge:function(){function a(b,c,h,q){var g=b[c?"startContainer":"endContainer"],e,j=c?0:1,i=0,k=c?"previousSibling":"nextSibling";e=b[c?"startOffset":"endOffset"];if(g[0].nodeType==f.NodeType.TEXT_NODE){if(c){if(e)return}else if(e<g[0].nodeValue.length)return;e=g[0][k];g=g[0].parentNode}else e=g[0].childNodes[e+(c?-1:1)]||null,g=g[0];for(;g;){for(;e;)if(m(e)||
u(e))e=e[k];else break;if(e){if(!i)b[c?"setStartAfter":"setEndBefore"](d(e));break}g=d(g);if("body"==g.nodeName())break;if(i||g.equals(q))h[j]=g,i=1;else b[c?"setStartBefore":"setEndAfter"](g);e=g[0][k];g=g[0].parentNode}}return function(b){switch(b){case c.ENLARGE_ELEMENT:if(this.collapsed)break;var b=this.getCommonAncestor(),g=[];a(this,1,g,b);a(this,0,g,b);g[0]&&g[1]&&(b=g[0].contains(g[1])?g[1]:g[0],this.setStartBefore(b),this.setEndAfter(b));break;case c.ENLARGE_BLOCK_CONTENTS:case c.ENLARGE_LIST_ITEM_CONTENTS:var m=
new x(this.document),g=new h(this.document.body);m.setStartAt(g,c.POSITION_AFTER_START);m.setEnd(this.startContainer,this.startOffset);var m=new o(m),q,e,u=o.blockBoundary(b==c.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:y),j=function(a){var b=u(a);b||(q=d(a));return b},i=function(a){var b=j(a);!b&&"br"==f.nodeName(a)&&(e=d(a));return b};m.guard=j;m=m.lastBackward();q=q||g;this.setStartAt(q,"br"!=q.nodeName()&&(!m&&this.checkStartOfBlock()||m&&q.contains(m))?c.POSITION_AFTER_START:c.POSITION_AFTER_END);m=this.clone();
m.collapse();m.setEndAt(g,c.POSITION_BEFORE_END);m=new o(m);m.guard=b==c.ENLARGE_LIST_ITEM_CONTENTS?i:j;q=y;m=m.lastForward();q=q||g;this.setEndAt(q,!m&&this.checkEndOfBlock()||m&&q.contains(m)?c.POSITION_BEFORE_END:c.POSITION_BEFORE_START);e&&this.setEndAfter(e)}}}(),checkStartOfBlock:function(){var b=this.startContainer,d=this.startOffset;if(d&&b[0].nodeType==f.NodeType.TEXT_NODE&&a.trim(b[0].nodeValue.substring(0,d)).length)return w;this.trim();b=new l(this.startContainer);d=this.clone();d.collapse(k);
d.setStartAt(b.block||b.blockLimit,c.POSITION_AFTER_START);b=new o(d);b.evaluator=i(k);return b.checkBackward()},checkEndOfBlock:function(){var b=this.endContainer,d=this.endOffset;if(b[0].nodeType==f.NodeType.TEXT_NODE&&a.trim(b[0].nodeValue.substring(d)).length)return w;this.trim();b=new l(this.endContainer);d=this.clone();d.collapse(w);d.setEndAt(b.block||b.blockLimit,c.POSITION_BEFORE_END);b=new o(d);b.evaluator=i(w);return b.checkForward()},checkBoundaryOfElement:function(a,b){var d=this.clone();
d[b==c.START?"setStartAt":"setEndAt"](a,b==c.START?c.POSITION_AFTER_START:c.POSITION_BEFORE_END);d=new o(d);d.evaluator=v;return d[b==c.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var a=this.startContainer,b=this.endContainer,c=this.startOffset,g=this.endOffset,h;if(a[0].nodeType==f.NodeType.ELEMENT_NODE)if(h=a[0].childNodes.length,h>c)a=d(a[0].childNodes[c]);else if(0==h)a=a._4e_previousSourceNode();else{for(a=a[0];a.lastChild;)a=a.lastChild;a=d(a);a=a._4e_nextSourceNode()||
a}if(b[0].nodeType==f.NodeType.ELEMENT_NODE)if(h=b[0].childNodes.length,h>g)b=d(b[0].childNodes[g])._4e_previousSourceNode(k);else if(0==h)b=b._4e_previousSourceNode();else{for(b=b[0];b.lastChild;)b=b.lastChild;b=d(b)}a._4e_position(b)&j.POSITION_FOLLOWING&&(a=b);return{startNode:a,endNode:b}},fixBlock:function(a,b){var g=this.createBookmark(),h=d(this.document.createElement(b));this.collapse(a);this.enlarge(c.ENLARGE_BLOCK_CONTENTS);h[0].appendChild(this.extractContents());h._4e_trim();t.ie||h._4e_appendBogus();
this.insertNode(h);this.moveToBookmark(g);return h},splitBlock:function(b){var d=new l(this.startContainer),g=new l(this.endContainer),h=d.block,q=g.block,f=y;if(!d.blockLimit.equals(g.blockLimit))return y;"br"!=b&&(h||(h=this.fixBlock(k,b),q=(new l(this.endContainer)).block),q||(q=this.fixBlock(w,b)));b=h&&this.checkStartOfBlock();d=q&&this.checkEndOfBlock();this.deleteContents();h&&h[0]==q[0]&&(d?(f=new l(this.startContainer),this.moveToPosition(q,c.POSITION_AFTER_END),q=y):b?(f=new l(this.startContainer),
this.moveToPosition(h,c.POSITION_BEFORE_START),h=y):(q=this.splitElement(h),!t.ie&&!a.inArray(h.nodeName(),["ul","ol"])&&h._4e_appendBogus()));return{previousBlock:h,nextBlock:q,wasStartOfBlock:b,wasEndOfBlock:d,elementPath:f}},splitElement:function(a){if(!this.collapsed)return y;this.setEndAt(a,c.POSITION_BEFORE_END);var b=this.extractContents(),d=a.clone(w);d[0].appendChild(b);d.insertAfter(a);this.moveToPosition(a,c.POSITION_AFTER_END);return d},moveToElementEditablePosition:function(a,b){for(var d=
0;a;){if(a[0].nodeType==f.NodeType.TEXT_NODE){this.moveToPosition(a,b?c.POSITION_AFTER_END:c.POSITION_BEFORE_START);d=1;break}a[0].nodeType==f.NodeType.ELEMENT_NODE&&a._4e_isEditable()&&(this.moveToPosition(a,b?c.POSITION_BEFORE_END:c.POSITION_AFTER_START),d=1);var g=a,h=d,m=void 0;g[0].nodeType==f.NodeType.ELEMENT_NODE&&g._4e_isEditable()&&(m=g[b?"last":"first"](e,1));!h&&!m&&(m=g[b?"prev":"next"](e,1));a=m}return!!d},selectNodeContents:function(a){var b=a[0];this.setStart(a,0);this.setEnd(a,b.nodeType==
f.NodeType.TEXT_NODE?b.nodeValue.length:b.childNodes.length)},insertNodeByDtd:function(a){var d,c,g,h=a.nodeName();d=b.$block[h];this.deleteContents();if(d){for(d=this.getCommonAncestor(w,k);(c=b[d.nodeName()])&&(!c||!c[h]);){var f=d.parent();this.checkStartOfBlock()&&this.checkEndOfBlock()?(this.setStartBefore(d),this.collapse(k),d.remove()):g=d;d=f}g&&this.splitElement(g)}this.insertNode(a)}});s.injectDom({_4e_breakParent:function(a,b){var b=d(b),a=d(a),c,g=new r.Range(a[0].ownerDocument);g.setStartAfter(a);
g.setEndAfter(b);c=g.extractContents();g.insertNode(a.remove());a.after(c)}});return r.Range=x},{requires:"./base,./utils,./walker,./elementPath,./dom,node".split(",")});
KISSY.add("editor/selection",function(a,r){function s(a){this.document=a;this._={cache:{}};if(k)try{var c=this.getNative().createRange();if(!c||c.item&&c.item(0).ownerDocument!=a||c.parentElement&&c.parentElement().ownerDocument!=a)this.isInvalid=l}catch(d){this.isInvalid=l}}function o(a){a=new s(a);return!a||a.isInvalid?v:a}r.SELECTION={SELECTION_NONE:1,SELECTION_TEXT:2,SELECTION_ELEMENT:3};var l=!0,v=null,e=a.UA,i=a.DOM,n=a.Node,p=r.SELECTION,x=r.RANGE,k=e.ie,w=r.Walker,y=r.Range,c={img:1,hr:1,
li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};a.augment(s,{getNative:!k?function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=i.getWindow(this.document).getSelection())}:function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=this.document.selection)},getType:!k?function(){var a=this._.cache;if(a.type)return a.type;var h=p.SELECTION_TEXT,d=this.getNative();if(d){if(1==d.rangeCount){var d=d.getRangeAt(0),
g=d.startContainer;g==d.endContainer&&g.nodeType==i.NodeType.ELEMENT_NODE&&1==Number(d.endOffset-d.startOffset)&&c[g.childNodes[d.startOffset].nodeName.toLowerCase()]&&(h=p.SELECTION_ELEMENT)}}else h=p.SELECTION_NONE;return a.type=h}:function(){var a=this._.cache;if(a.type)return a.type;var c=p.SELECTION_NONE;try{var d=this.getNative(),g=d.type;"Text"==g&&(c=p.SELECTION_TEXT);"Control"==g&&(c=p.SELECTION_ELEMENT);d.createRange().parentElement&&(c=p.SELECTION_TEXT)}catch(f){}return a.type=c},getRanges:k?
function(){var a=function(a,b){a=a.duplicate();a.collapse(b);for(var c=a.parentElement(),f=c.childNodes,e,j=0;j<f.length;j++){var k=f[j];if(k.nodeType==i.NodeType.ELEMENT_NODE){e=a.duplicate();e.moveToElementText(k);var k=e.compareEndPoints("StartToStart",a),l=e.compareEndPoints("EndToStart",a);e.collapse();if(0<k)break;else{if(!k||1==l&&-1==k)return{container:c,offset:j};if(!l)return{container:c,offset:j+1}}e=v}}e||(e=a.duplicate(),e.moveToElementText(c),e.collapse(!1));e.setEndPoint("StartToStart",
a);e=(""+e.text).replace(/\r\n|\r/g,"\n").length;try{for(;0<e;)e-=f[--j].nodeValue.length}catch(t){e=0}return 0===e?{container:c,offset:j}:{container:f[j],offset:-e}};return function(c){var d=this._.cache;if(d.ranges&&!c)return d.ranges;var g=this.getNative(),c=g&&g.createRange(),f=this.getType();if(!g)return[];if(f==p.SELECTION_TEXT)return g=new y(this.document),f=a(c,l),g.setStart(new n(f.container),f.offset),f=a(c),g.setEnd(new n(f.container),f.offset),d.ranges=[g];if(f==p.SELECTION_ELEMENT){d=
d.ranges=[];for(f=0;f<c.length;f++){for(var e=c.item(f),j=e.parentNode,i=0,g=new y(this.document);i<j.childNodes.length&&j.childNodes[i]!=e;i++);g.setStart(new n(j),i);g.setEnd(new n(j),i+1);d.push(g)}return d}return d.ranges=[]}}():function(a){var c=this._.cache;if(c.ranges&&!a)return c.ranges;var a=[],d=this.getNative();if(!d)return[];for(var g=0;g<d.rangeCount;g++){var f=d.getRangeAt(g),e=new y(this.document);e.setStart(new n(f.startContainer),f.startOffset);e.setEnd(new n(f.endContainer),f.endOffset);
a.push(e)}return c.ranges=a},getStartElement:function(){var a=this._.cache;if(void 0!==a.startElement)return a.startElement;var c,d=this.getNative();switch(this.getType()){case p.SELECTION_ELEMENT:return this.getSelectedElement();case p.SELECTION_TEXT:var g=this.getRanges()[0];if(g&&!g.collapsed){for(g.optimize();l;)if(c=g.startContainer,g.startOffset==(c[0].nodeType===i.NodeType.ELEMENT_NODE?c[0].childNodes.length:c[0].nodeValue.length)&&!c._4e_isBlockBoundary())g.setStartAfter(c);else break;c=g.startContainer;
if(c[0].nodeType!=i.NodeType.ELEMENT_NODE)return c.parent();c=new n(c[0].childNodes[g.startOffset]);if(!c[0]||c[0].nodeType!=i.NodeType.ELEMENT_NODE)return g.startContainer;for(g=c[0].firstChild;g&&g.nodeType==i.NodeType.ELEMENT_NODE;)c=new n(g),g=g.firstChild;return c}if(k)g=d.createRange(),g.collapse(l),c=new n(g.parentElement());else{if((c=d.anchorNode)&&c.nodeType!=i.NodeType.ELEMENT_NODE)c=c.parentNode;c&&(c=new n(c))}}return a.startElement=c},getSelectedElement:function(){var a,f=this._.cache;
if(void 0!==f.selectedElement)return f.selectedElement;k&&(a=this.getNative().createRange(),a=a.item&&a.item(0));var d;if(a)d=new n(a);else{a=this.getRanges()[0];for(var g,e=2;e&&(!(d=a.getEnclosedNode())||!(d[0].nodeType==i.NodeType.ELEMENT_NODE&&c[d.nodeName()]&&(g=d)));e--)a.shrink(x.SHRINK_ELEMENT);d=g}return f.selectedElement=d},reset:function(){this._.cache={}},selectElement:function(a){var c,d=this.document;if(k)try{c=d.body.createControlRange(),c.addElement(a[0]),c.select()}catch(g){c=d.body.createTextRange(),
c.moveToElementText(a[0]),c.select()}finally{}else c=d.createRange(),c.selectNode(a[0]),a=this.getNative(),a.removeAllRanges(),a.addRange(c);this.reset()},selectRanges:function(a){if(k){if(1<a.length){var c=a[a.length-1];a[0].setEnd(c.endContainer,c.endOffset);a.length=1}a[0]&&a[0].select()}else{c=this.getNative();if(!c)return;c.removeAllRanges();for(var d=0;d<a.length;d++){var g=a[d],f=this.document.createRange(),j=g.startContainer;if(g.collapsed&&(e.gecko&&1.09>e.gecko||e.opera||e.webkit)&&j[0].nodeType==
i.NodeType.ELEMENT_NODE&&!j[0].childNodes.length)j[0].appendChild(this.document.createTextNode(e.webkit?"\u200b":"")),g.startOffset++,g.endOffset++;f.setStart(j[0],g.startOffset);f.setEnd(g.endContainer[0],g.endOffset);c.addRange(f)}}this.reset()},createBookmarks2:function(a){for(var c=[],d=this.getRanges(),g=0;g<d.length;g++)c.push(d[g].createBookmark2(a));return c},createBookmarks:function(c,f){for(var d=[],g=this.document,e,f=f||this.getRanges(),j=f.length,k=0;k<j;k++){d.push(e=f[k].createBookmark(c,
l));var t=(c=e.serializable)?a.one("#"+e.startNode,g):e.startNode;e=c?a.one("#"+e.endNode,g):e.endNode;for(var n=k+1;n<j;n++){var p=f[n],r=p.startContainer,o=p.endContainer;i.equals(r,t.parent())&&p.startOffset++;i.equals(r,e.parent())&&p.startOffset++;i.equals(o,t.parent())&&p.endOffset++;i.equals(o,e.parent())&&p.endOffset++}}return d},selectBookmarks:function(a){for(var c=[],d=0;d<a.length;d++){var g=new y(this.document);g.moveToBookmark(a[d]);c.push(g)}this.selectRanges(c);return this},getCommonAncestor:function(){var a=
this.getRanges();return a[0].startContainer._4e_commonAncestor(a[a.length-1].endContainer)},scrollIntoView:function(){var a=this.getStartElement();a&&a.scrollIntoView(void 0,{alignWithTop:!1,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0})},removeAllRanges:function(){var a=this.getNative();k?a&&a.clear():a&&a.removeAllRanges()}});var j={table:1,tbody:1,tr:1},f=w.whitespaces(l),t=/\ufeff|\u00a0/;y.prototype.select=y.prototype.select=!k?function(){var a=this.startContainer;this.collapsed&&a[0].nodeType==
i.NodeType.ELEMENT_NODE&&!a[0].childNodes.length&&(a[0].appendChild(this.document.createTextNode(e.webkit?"\u200b":"")),this.startOffset++,this.endOffset++);var c=this.document.createRange();c.setStart(a[0],this.startOffset);try{c.setEnd(this.endContainer[0],this.endOffset)}catch(d){if(0<=d.toString().indexOf("NS_ERROR_ILLEGAL_VALUE"))this.collapse(l),c.setEnd(this.endContainer[0],this.endOffset);else throw d;}a=o(this.document).getNative();a.removeAllRanges();a.addRange(c)}:function(a){var c=this.collapsed,
d,g;if(this.startContainer[0]===this.endContainer[0]&&1==this.endOffset-this.startOffset){var e=this.startContainer[0].childNodes[this.startOffset];if(e.nodeType==i.NodeType.ELEMENT_NODE){(new s(this.document)).selectElement(new n(e));return}}(this.startContainer[0].nodeType==i.NodeType.ELEMENT_NODE&&this.startContainer.nodeName()in j||this.endContainer[0].nodeType==i.NodeType.ELEMENT_NODE&&this.endContainer.nodeName()in j)&&this.shrink(x.SHRINK_ELEMENT,l);var u=this.createBookmark(),e=u.startNode,
k;c||(k=u.endNode);u=this.document.body.createTextRange();u.moveToElementText(e[0]);u.moveStart("character",1);if(k)a=this.document.body.createTextRange(),a.moveToElementText(k[0]),u.setEndPoint("EndToEnd",a),u.moveEnd("character",-1);else{for(d=e[0].nextSibling;d&&!f(d);)d=d.nextSibling;d=!(d&&d.nodeValue&&d.nodeValue.match(t))&&(a||!e[0].previousSibling||e[0].previousSibling&&"br"==i.nodeName(e[0].previousSibling));g=new n(this.document.createElement("span"));g.html("&#65279;");g.insertBefore(e);
d&&i.insertBefore(this.document.createTextNode("\ufeff"),e[0]||e)}this.setStartBefore(e);e._4e_remove();if(c){if(d?(u.moveStart("character",-1),u.select(),this.document.selection.clear()):u.select(),g)this.moveToPosition(g,x.POSITION_BEFORE_START),g._4e_remove()}else this.setEndBefore(k),k._4e_remove(),u.select()};s.getSelection=o;return r.Selection=s},{requires:["./base","./walker","./range","./dom","node"]});
KISSY.add("editor/domIterator",function(a,r){function s(a){1>arguments.length||(this.range=a,this.forceBrBreak=l,this.enlargeBr=o,this.enforceRealBlocks=l,this._||(this._={}))}var o=!0,l=!1,v=a.UA,e=r.Walker,i=r.Range,n=r.RANGE,p=r.ElementPath,x=a.Node,k=a.DOM,w=/^[\r\n\t ]*$/;a.augment(s,{getNextParagraph:function(r){var c,j,f,t,b;if(!this._.lastNode){j=this.range.clone();j.shrink(n.SHRINK_ELEMENT,o);j.enlarge(this.forceBrBreak||!this.enlargeBr?n.ENLARGE_LIST_ITEM_CONTENTS:n.ENLARGE_BLOCK_CONTENTS);
var h=new e(j),d=e.bookmark(o,o);h.evaluator=d;this._.nextNode=h.next();h=new e(j);h.evaluator=d;h=h.previous();this._.lastNode=h._4e_nextSourceNode(o);this._.lastNode&&this._.lastNode[0].nodeType==k.NodeType.TEXT_NODE&&!a.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()&&(d=new i(j.document),d.moveToPosition(this._.lastNode,n.POSITION_AFTER_END),d.checkEndOfBlock()&&(d=new p(d.endContainer),this._.lastNode=(d.block||d.blockLimit)._4e_nextSourceNode(o)));this._.lastNode||
(this._.lastNode=this._.docEndMarker=new x(j.document.createTextNode("")),k.insertAfter(this._.lastNode[0],h[0]));j=null}d=this._.nextNode;h=this._.lastNode;for(this._.nextNode=null;d;){var g=l,m=d[0].nodeType!=k.NodeType.ELEMENT_NODE,u=l;if(m)d[0].nodeType==k.NodeType.TEXT_NODE&&w.test(d[0].nodeValue)&&(m=l);else{var s=d.nodeName();if(d._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if("br"==s)m=o;else if(!j&&!d[0].childNodes.length&&"hr"!=s){c=d;f=d.equals(h);break}j&&(j.setEndAt(d,n.POSITION_BEFORE_START),
"br"!=s&&(this._.nextNode=d));g=o}else{if(d[0].firstChild){j||(j=new i(this.range.document),j.setStartAt(d,n.POSITION_BEFORE_START));d=new x(d[0].firstChild);continue}m=o}}m&&!j&&(j=new i(this.range.document),j.setStartAt(d,n.POSITION_BEFORE_START));f=(!g||m)&&d.equals(h);if(j&&!g)for(;!d[0].nextSibling&&!f;){s=d.parent();if(s._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){g=o;f||s.equals(h);break}d=s;m=o;f=d.equals(h);u=o}m&&j.setEndAt(d,n.POSITION_AFTER_END);d=d._4e_nextSourceNode(u,null,h);if((f=
!d)||g&&j)break}if(!c){if(!j)return this._.docEndMarker&&this._.docEndMarker._4e_remove(),this._.nextNode=null;c=new p(j.startContainer);d=c.blockLimit;g={div:1,th:1,td:1};c=c.block;if((!c||!c[0])&&!this.enforceRealBlocks&&g[d.nodeName()]&&j.checkStartOfBlock()&&j.checkEndOfBlock())c=d;else if(!c||this.enforceRealBlocks&&"li"==c.nodeName())c=new x(this.range.document.createElement(r||"p")),c[0].appendChild(j.extractContents()),c._4e_trim(),j.insertNode(c),t=b=o;else if("li"!=c.nodeName()){if(!j.checkStartOfBlock()||
!j.checkEndOfBlock())c=c.clone(l),c[0].appendChild(j.extractContents()),c._4e_trim(),b=j.splitBlock(),t=!b.wasStartOfBlock,b=!b.wasEndOfBlock,j.insertNode(c)}else f||(this._.nextNode=c.equals(h)?null:j.getBoundaryNodes().endNode._4e_nextSourceNode(o,null,h))}t&&(j=new x(c[0].previousSibling),j[0]&&j[0].nodeType==k.NodeType.ELEMENT_NODE&&("br"==j.nodeName()?j._4e_remove():j[0].lastChild&&"br"==k.nodeName(j[0].lastChild)&&k._4e_remove(j[0].lastChild)));b&&(j=e.bookmark(l,o),t=new x(c[0].lastChild),
t[0]&&t[0].nodeType==k.NodeType.ELEMENT_NODE&&"br"==t.nodeName()&&(v.ie||t.prev(j,1)||t.next(j,1))&&t.remove());this._.nextNode||(this._.nextNode=f||c.equals(h)?null:c._4e_nextSourceNode(o,null,h));return c}});i.prototype.createIterator=function(){return new s(this)};return s},{requires:["./base","./range","./elementPath","./walker","node"]});
KISSY.add("editor/styles",function(a,r){function s(a){return!E.attr(a,"_ke_bookmark")}function o(a,c){for(var d in a)"string"==typeof a[d]?a[d]=a[d].replace(R,function(a,d){return c[d]}):o(a[d],c)}function l(c,d){d&&(c=a.clone(c),o(c,d));var b=this.element=this.element=(c.element||"*").toLowerCase();this.type=this.type="#text"==b||I[b]?A.STYLE_BLOCK:P[b]?A.STYLE_OBJECT:A.STYLE_INLINE;this._={definition:c}}function v(a,c){var d=c?this.removeFromRange:this.applyToRange;a.body.focus();for(var b=new J(a),
g=b.getRanges(),f=0;f<g.length;f++)d.call(this,g[f]);b.selectRanges(g)}function e(a,c,d){var b=a.element;"*"==b&&(b="span");c=new q(c.createElement(b));d&&d._4e_copyAttributes(c);d=a._.definition;a=d.attributes;d=l.getStyleText(d);if(a)for(var g in a)c.attr(g,a[g]);d&&(c[0].style.cssText=d);return c}function i(a){var c=a.createBookmark(g),d=a.createIterator();d.enforceRealBlocks=g;d.enlargeBr=g;for(var b,f=a.document;b=d.getNextParagraph();){var h=e(this,f,b),j=h,h="pre"==j.nodeName,m="pre"==b.nodeName,
i=!h&&m;h&&!m?(m=b,i=m.html(),i=n(i,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,""),i=i.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1"),i=i.replace(/([ \t\n\r]+|&nbsp;)/g," "),i=i.replace(/<br\b[^>]*>/gi,"\n"),N.ie?(m=m[0].ownerDocument.createElement("div"),m.appendChild(j[0]),j.outerHtml("<pre>"+i+"</pre>"),j=new q(m.firstChild),j._4e_remove()):j.html(i)):i?j=x(p(b),j):b._4e_moveChildren(j);b[0].parentNode.replaceChild(j[0],b[0]);if(h&&(b=j,h=void 0,(h=b._4e_previousSourceNode(g,E.NodeType.ELEMENT_NODE))&&
"pre"==h.nodeName()))j=n(h.html(),/\n$/,"")+"\n\n"+n(b.html(),/^\n/,""),N.ie?b.outerHtml("<pre>"+j+"</pre>"):b.html(j),h._4e_remove()}a.moveToBookmark(c)}function n(a,c,d){var b="",g="",a=a.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(a,c,d){c&&(b=c);d&&(g=d);return""});return b+a.replace(c,d)+g}function p(a){var c=[];n(a.outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,function(a,c,d){return c+"</pre>"+d+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,
function(a,d){c.push(d)});return c}function x(a,c){for(var d=c[0].ownerDocument.createDocumentFragment(),b=0;b<a.length;b++){var g=a[b],g=g.replace(/(\r\n|\r)/g,"\n"),g=n(g,/^[ \t]*\n/,""),g=n(g,/\n$/,""),g=n(g,/^[ \t]+|[ \t]+$/g,function(a,c){return 1==a.length?"&nbsp;":c?" "+Array(a.length).join("&nbsp;"):Array(a.length).join("&nbsp;")+" "}),g=g.replace(/\n/g,"<br>"),g=g.replace(/[ \t]{2,}/g,function(a){return Array(a.length).join("&nbsp;")+" "}),f=c.clone();f.html(g);d.appendChild(f[0])}return d}
function k(a){var c=a.document;if(a.collapsed)c=e(this,c,void 0),a.insertNode(c),a.moveToPosition(c,G.POSITION_BEFORE_END);else{var d=this.element,f=this._.definition,h,j=L[d];j||(h=g,j=L.span);var i=a.createBookmark();a.enlarge(G.ENLARGE_ELEMENT);a.trim();for(var k=a.createBookmark(),t=k.startNode,k=k.endNode,l=t,n;l&&l[0];){var z=m;if(E.equals(l,k))l=u,z=g;else{var p=l[0].nodeType,r=p==E.NodeType.ELEMENT_NODE?l.nodeName():u;if(r&&l.attr("_ke_bookmark")){l=l._4e_nextSourceNode(g);continue}if(!r||
j[r]&&(l._4e_position(k)|C.POSITION_PRECEDING|C.POSITION_IDENTICAL|C.POSITION_IS_CONTAINED)==C.POSITION_PRECEDING+C.POSITION_IDENTICAL+C.POSITION_IS_CONTAINED&&(!f.childRule||f.childRule(l))){var o=l.parent();if(o&&"a"==d&&o.nodeName()==d)p=e(this,c,void 0),o._4e_moveChildren(p),o[0].parentNode.replaceChild(p[0],o[0]),p._4e_mergeSiblings();else if(o&&o[0]&&((L[o.nodeName()]||L.span)[d]||h)&&(!f.parentRule||f.parentRule(o))){if(!n&&(!r||!L.$removeEmpty[r]||(l._4e_position(k)|C.POSITION_PRECEDING|C.POSITION_IDENTICAL|
C.POSITION_IS_CONTAINED)==C.POSITION_PRECEDING+C.POSITION_IDENTICAL+C.POSITION_IS_CONTAINED))n=new M(c),n.setStartBefore(l);if(p==E.NodeType.TEXT_NODE||p==E.NodeType.ELEMENT_NODE&&!l[0].childNodes.length){o=l;for(p=null;(z=!o.next(s,1))&&(p=o.parent())&&j[p.nodeName()]&&(p._4e_position(t)|C.POSITION_FOLLOWING|C.POSITION_IDENTICAL|C.POSITION_IS_CONTAINED)==C.POSITION_FOLLOWING+C.POSITION_IDENTICAL+C.POSITION_IS_CONTAINED&&(!f.childRule||f.childRule(p));)o=p;n.setEndAfter(o)}}else z=g}else z=g;l=l._4e_nextSourceNode()}if(z&&
n&&!n.collapsed){for(var z=e(this,c,void 0),o=n.getCommonAncestor(),p={},r={},I,w=null,D;z&&o&&z[0]&&o[0];){if(o.nodeName()==d){for(I in f.attributes)if(!r[I]&&(D=o.attr(w)))z.attr(I)==D?z.removeAttr(I):r[I]=1;for(w in f.styles)if(!p[w]&&(D=o.style(w)))z.style(w)==D?z.style(w,""):p[w]=1;if(!z._4e_hasAttributes()){z=u;break}}o=o.parent()}z?(z[0].appendChild(n.extractContents()),b(this,z),n.insertNode(z),z._4e_mergeSiblings(),N.ie||z[0].normalize()):(z=new q(c.createElement("span")),z[0].appendChild(n.extractContents()),
n.insertNode(z),b(this,z),z._4e_remove(!0));n=u}}t._4e_remove();k._4e_remove();a.moveToBookmark(i);a.shrink(G.SHRINK_TEXT)}}function w(a){a.enlarge(G.ENLARGE_ELEMENT);var c=a.createBookmark(),d=c.startNode;if(a.collapsed){for(var b=new z(d.parent()),g,e=0,m;e<b.elements.length&&(m=b.elements[e])&&!(m==b.block||m==b.blockLimit);e++)if(this.checkElementRemovable(m)){var i=a.checkBoundaryOfElement(m,G.END),k=!i&&a.checkBoundaryOfElement(m,G.START);k||i?(g=m,g.match=k?"start":"end"):(m._4e_mergeSiblings(),
m.nodeName()!=this.element?(i=j(this),h(m,i[m.nodeName()]||i["*"])):f(this,m))}if(g){m=d;for(e=0;;e++){i=b.elements[e];if(i.equals(g))break;else if(i.match)continue;else i=i.clone();i[0].appendChild(m[0]);m=i}m["start"==g.match?"insertBefore":"insertAfter"](g);b=g.html();!b||"\u200b"==b?g.remove():N.webkit&&D(a.document.createTextNode("\u200b")).insertBefore(m)}}else{var l=c.endNode,n=this;g=function(){for(var a=new z(d.parent()),c=new z(l.parent()),b=u,g=u,f=0;f<a.elements.length;f++){var e=a.elements[f];
if(e==a.block||e==a.blockLimit)break;n.checkElementRemovable(e)&&(b=e)}for(f=0;f<c.elements.length;f++){e=c.elements[f];if(e==c.block||e==c.blockLimit)break;n.checkElementRemovable(e)&&(g=e)}g&&l._4e_breakParent(g);b&&d._4e_breakParent(b)};g();for(b=new q(d[0].nextSibling);b[0]!==l[0];){e=b._4e_nextSourceNode();if(b[0]&&b[0].nodeType==E.NodeType.ELEMENT_NODE&&this.checkElementRemovable(b)&&(b.nodeName()==this.element?f(this,b):(m=j(this),h(b,m[b.nodeName()]||m["*"])),e[0].nodeType==E.NodeType.ELEMENT_NODE&&
e.contains(d)))g(),e=new q(d[0].nextSibling);b=e}}a.moveToBookmark(c)}function y(a){var c={};(""+a).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(a,d,b){c[d]=b});return c}function c(a,c){var d="";c!==m?(d=document.createElement("span"),d.style.cssText=a,d=d.style.cssText||""):d=a;return d.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function j(c){if(c._.overrides)return c._.overrides;var d=c._.overrides={},b=c._.definition.overrides;
if(b){a.isArray(b)||(b=[b]);for(var g=0;g<b.length;g++){var f=b[g],e,q,j;"string"==typeof f?e=f.toLowerCase():(e=f.element?f.element.toLowerCase():c.element,q=f.attributes,j=f.styles);f=d[e]||(d[e]={});if(q){e=f.attributes=f.attributes||[];for(var h in q)e.push([h.toLowerCase(),q[h]])}if(j){var f=f.styles=f.styles||[],m;for(m in j)f.push([m.toLowerCase(),j[m]])}}}return d}function f(c,b){var f=c._.definition,e=j(c),q=a.merge(f.attributes,(e[b.nodeName()]||e["*"]||{}).attributes),f=a.merge(f.styles,
(e[b.nodeName()]||e["*"]||{}).styles),e=a.isEmptyObject(q)&&a.isEmptyObject(f),h;for(h in q)("class"==h||c._.definition.fullMatch)&&b.attr(h)!=t(h,q[h])||(e=e||!!b.hasAttr(h),b.removeAttr(h));for(var m in f)c._.definition.fullMatch&&b.style(m)!=t(m,f[m],g)||(e=e||!!b.style(m),b.style(m,""));d(b)}function t(a,c,b){var d=new q("<span>");d[b?"style":"attr"](a,c);return d[b?"style":"attr"](a)}function b(a,c){for(var b=j(a),d=c.all(a.element),g=d.length;0<=--g;)f(a,new q(d[g]));for(var e in b)if(e!=a.element){d=
c.all(e);for(g=d.length-1;0<=g;g--){var m=new q(d[g]);h(m,b[e])}}}function h(a,c){var b,g=c&&c.attributes;if(g)for(b=0;b<g.length;b++){var f=g[b][0],e;if(e=a.attr(f)){var q=g[b][1];(q===u||q.test&&q.test(e)||"string"==typeof q&&e==q)&&a[0].removeAttribute(f)}}if(g=c&&c.styles)for(b=0;b<g.length;b++)if(f=g[b][0],q=a.css(f)){var h=g[b][1];(h===u||h.test&&h.test(e)||"string"==typeof h&&q==h)&&a.css(f,"")}d(a)}function d(a){if(!a._4e_hasAttributes()){var c=a[0].firstChild,b=a[0].lastChild;a._4e_remove(g);
c&&(c.nodeType==E.NodeType.ELEMENT_NODE&&E._4e_mergeSiblings(c),b&&c!=b&&b.nodeType==E.NodeType.ELEMENT_NODE&&E._4e_mergeSiblings(b))}}var g=!0,m=!1,u=null,D=a.all,E=a.DOM,A={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3},G=r.RANGE,J=r.Selection,C=r.POSITION,M=r.Range,q=a.Node,N=a.UA,z=r.ElementPath,I={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},L=r.XHTML_DTD,P={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},Q=/\s*(?:;\s*|$)/g,R=/#\((.+?)\)/g;r.STYLE=
A;l.prototype={constructor:l,apply:function(a){v.call(this,a,m)},remove:function(a){v.call(this,a,g)},applyToRange:function(a){return(this.applyToRange=this.type==A.STYLE_INLINE?k:this.type==A.STYLE_BLOCK?i:u).call(this,a)},removeFromRange:function(a){return(this.removeFromRange=this.type==A.STYLE_INLINE?w:u).call(this,a)},checkElementRemovable:function(a,b){if(!a)return m;var d=this._.definition,f;if(a.nodeName()==this.element){if(!b&&!a._4e_hasAttributes())return g;var e=d._AC;if(e)d=e;else{var e=
{},q=0,h=d.attributes;if(h)for(var i in h)q++,e[i]=h[i];if(h=l.getStyleText(d))e.style||q++,e.style=h;e._length=q;d=d._AC=e}if(d._length){for(var k in d)if("_length"!=k){q=a.attr(k)||"";if("style"==k)a:{e=d[k];q=c(q,m);"string"==typeof e&&(e=y(e));"string"==typeof q&&(q=y(q));h=void 0;for(h in e)if(!(h in q&&(q[h]==e[h]||"inherit"==e[h]||"inherit"==q[h]))){e=m;break a}e=g}else e=d[k]==q;if(e){if(!b)return g}else if(b)return m}if(b)return g}else return g}k=j(this);if(k=k[a.nodeName()]||k["*"]){if(!(d=
k.attributes)&&!(f=k.styles))return g;if(d)for(e=0;e<d.length;e++)if(k=d[e][0],k=a.attr(k))if(q=d[e][1],q===u||"string"==typeof q&&k==q||q.test&&q.test(k))return g;if(f)for(e=0;e<f.length;e++)if(k=a.css(f[e][0]))if(d=f[e][1],d===u||"string"==typeof d&&k==d||d.test&&d.test(k))return g}return m},checkActive:function(a){switch(this.type){case A.STYLE_BLOCK:return this.checkElementRemovable(a.block||a.blockLimit,g);case A.STYLE_OBJECT:case A.STYLE_INLINE:for(var c=a.elements,d=0,b;d<c.length;d++)if(b=
c[d],!(this.type==A.STYLE_INLINE&&(E.equals(b,a.block)||E.equals(b,a.blockLimit))))if((this.type!=A.STYLE_OBJECT||b.nodeName()in P)&&this.checkElementRemovable(b,g))return g}return m}};l.getStyleText=function(a){var d=a._ST;if(d)return d;var d=a.styles,b=a.attributes&&a.attributes.style||"",g="";b.length&&(b=b.replace(Q,";"));for(var f in d){var e=d[f],q=(f+":"+e).replace(Q,";");"inherit"==e?g+=q:b+=q}b.length&&(b=c(b));return a._ST=b+g};return r.Style=l},{requires:"./base,./range,./selection,./domIterator,./elementPath,node".split(",")});
KISSY.add("editor/zIndexManager",function(a,r){var s=r.zIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,STORE_FLASH_SHOW:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};r.baseZIndex=function(a){return(r.Config.baseZIndex||1E4)+a};return s},{requires:["./base"]});
KISSY.add("editor/clipboard",function(a,r,s,o){function l(a){this.editor=a;this._init()}function v(a){var j=a.get("document")[0],f=a.getSelection(),i;if(f.getType()==o.SELECTION_ELEMENT&&(i=f.getSelectedElement())){var a=f.getRanges()[0],b=e(j.createTextNode(""));b.insertBefore(i);a.setStartBefore(b);a.setEndAfter(i);f.selectRanges([a]);setTimeout(function(){i.parent()&&(b.remove(),f.selectElement(i))},0)}}var e=a.all,i=a.UA,n=i.ie?"beforepaste":"paste",p=r.RANGE;a.augment(l,{_init:function(){var a=
this,e=a.editor,f=e.get("document"),l=f.one("body"),b=function(a){this.type=a};b.prototype={exec:function(b){var d=this.type;b.focus();setTimeout(function(){i.ie&&("cut"==d?v(b):"paste"==d&&(a._preventPasteEvent(),a._getClipboardDataFromPasteBin()));k(b,d)||alert(w[d])},0)}};l.on(n,a._getClipboardDataFromPasteBin,a);i.ie&&(l.on("paste",a._iePaste,a),f.on("keydown",a._onKeyDown,a),f.on("contextmenu",function(){a._isPreventBeforePaste=1;setTimeout(function(){a._isPreventBeforePaste=0},0)}));e.addCommand("copy",
new b("copy"));e.addCommand("cut",new b("cut"));e.addCommand("paste",new b("paste"))},_onKeyDown:function(a){this.editor.get("mode")==r.Mode.WYSIWYG_MODE&&(a.ctrlKey&&86==a.keyCode||a.shiftKey&&45==a.keyCode)&&this._preventPasteEvent()},_stateFromNamedCommand:function(a){var e,f=this.editor;if("paste"==a){this._isPreventBeforePaste=1;try{e=f.get("document")[0].queryCommandEnabled(a)}catch(i){}this._isPreventBeforePaste=0}else e=(a=(a=f.getSelection())&&a.getRanges())&&!(1==a.length&&a[0].collapsed);
return e},_preventPasteEvent:function(){var a=this;a._preventPasteTimer&&clearTimeout(a._preventPasteTimer);a._isPreventPaste=1;a._preventPasteTimer=setTimeout(function(){a._isPreventPaste=0},70)},_iePaste:function(a){var e=this.editor;this._isPreventPaste||(a.preventDefault(),e.execCommand("paste"))},_getClipboardDataFromPasteBin:function(){if(!this._isPreventBeforePaste){var c=this.editor,j=c.get("document")[0];if(!j.getElementById("ke_pastebin")){var f=c.getSelection(),k=new s(j),b=e(i.webkit?
"<body></body>":"<div></div>",j);b.attr("id","ke_pastebin");i.webkit&&b[0].appendChild(j.createTextNode("\u200b"));j.body.appendChild(b[0]);b.css({position:"absolute",top:f.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});b.css("left","-1000px");var h=f.createBookmarks();k.setStartAt(b,p.POSITION_AFTER_START);k.setEndAt(b,p.POSITION_BEFORE_END);k.select(!0);setTimeout(function(){var d,g=b;b=i.webkit&&(d=b.first())&&d.hasClass("Apple-style-span")?d:b;f.selectBookmarks(h);
var e=b.html();g.remove();if(e=a.trim(e.replace(/<span[^>]+_ke_bookmark[^<]*?<\/span>(&nbsp;)*/ig,"")))d=c.fire("paste",{html:e}),!1!==d&&(void 0!==d&&(e=d),/(class="?Mso|style="[^"]*\bmso\-|w:WordDocument)/.test(e)?a.use("editor/plugin/word-filter",function(a,b){c.insertHtml(b.toDataFormat(e,c))}):c.insertHtml(e))},0)}}}});var x=function(a,j){var f=a.get("document")[0],k=e(f.body),b=!1,h=function(){b=!0};k.on(j,h);(7<i.ie?f:f.selection.createRange()).execCommand(j);k.detach(j,h);return b},k=i.ie?
function(a,e){return x(a,e)}:function(a,e){try{return a.get("document")[0].execCommand(e)}catch(f){return!1}},w={cut:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u526a\u5207\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+X)\u6765\u5b8c\u6210",copy:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u590d\u5236\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+C)\u6765\u5b8c\u6210",paste:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u7c98\u8d34\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+V)\u6765\u5b8c\u6210"},y={copy:"\u590d\u5236",paste:"\u7c98\u8d34",cut:"\u526a\u5207"};return{init:function(a){var e;a.docReady(function(){e=new l(a)});var f={copy:1,cut:1,paste:1},i=["copy","cut","paste"];a.on("contextmenu",function(b){var h=b.contextmenu;if(!h.__copy_fix){h.__copy_fix=
1;for(b=0;b<i.length;b++)h.addChild({content:y[i[b]],value:i[b]});h.on("click",function(b){var d=b.target.get("value");f[d]&&(h.hide(),setTimeout(function(){a.execCommand("save");a.execCommand(d);setTimeout(function(){a.execCommand("save")},10)},30))})}for(var d=h.get("children"),b=d.length-1;b--;0<=b){var g=d[b],m;m=g.get?g.get("value"):g.value;f[m]&&(m=!e._stateFromNamedCommand(m),g.set?g.set("disabled",m):g.disabled=m)}})}}},{requires:["./base","./range","./selection","node"]});
KISSY.add("editor/enterKey",function(a,r,s,o){function l(k){var l;l=k.getSelection().getRanges();for(var r=l.length-1;0<r;r--)l[r].deleteContents();l=l[0];r=l.document;if(l.checkStartOfBlock()&&l.checkEndOfBlock()){var c=(new o(l.startContainer)).block;if(c&&("li"==c.nodeName()||"li"==c.parent().nodeName()))return k.hasCommand("outdent")?(k.execCommand("save"),k.execCommand("outdent"),k.execCommand("save"),!0):!1}var j=l.splitBlock("p");if(!j)return!0;var k=j.previousBlock,c=j.nextBlock,f=j.wasStartOfBlock,
t=j.wasEndOfBlock,b;if(c)b=c.parent(),"li"==b.nodeName()&&(c._4e_breakParent(b),c._4e_move(c.next(),!0));else if(k&&(b=k.parent())&&"li"==b.nodeName())k._4e_breakParent(b),l.moveToElementEditablePosition(k.next()),k._4e_move(k.prev());if(!f&&!t){if("li"==c.nodeName()&&(b=c.first(s.invisible(!0)))&&a.inArray(b.nodeName(),["ul","ol"]))(e.ie?new p(r.createTextNode("\u00a0")):new p(r.createElement("br"))).insertBefore(b);c&&l.moveToElementEditablePosition(c)}else{var h;if(k){if("li"==k.nodeName()||!i.test(k.nodeName()))h=
k.clone()}else c&&(h=c.clone());h||(h=new p("<p>",null,r));if(b=j.elementPath)for(var j=0,d=b.elements.length;j<d;j++){var g=b.elements[j];if(g.equals(b.block)||g.equals(b.blockLimit))break;n.$removeEmpty[g.nodeName()]&&(g=g.clone(),h._4e_moveChildren(g),h.append(g))}e.ie||h._4e_appendBogus();l.insertNode(h);if(e.ie&&f&&(!t||!k[0].childNodes.length))l.moveToElementEditablePosition(t?k:h),l.select();l.moveToElementEditablePosition(f&&!t?c:h)}e.ie||(c?(h=new p(r.createElement("span")),h.html("&nbsp;"),
l.insertNode(h),h.scrollIntoView(void 0,{alignWithTop:!1,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0}),l.deleteContents()):h.scrollIntoView(void 0,{alignWithTop:!1,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0}));l.select();return!0}function v(a){var e=a.get("document")[0];x.on(e,"keydown",function(e){if(13===e.keyCode&&!e.shiftKey&&!e.ctrlKey&&!e.metaKey){a.execCommand("save");var c=a.execCommand("enterBlock");a.execCommand("save");!1!==c&&e.preventDefault()}})}var e=a.UA,i=/^h[1-6]$/,n=r.XHTML_DTD,
p=a.Node,x=a.Event;return{init:function(a){a.addCommand("enterBlock",{exec:l});a.docReady(function(){v(a)})}}},{requires:["./base","./walker","./elementPath","node"]});
KISSY.add("editor/htmlDataProcessor",function(a,r,s){return{init:function(o){function l(b){var b=b.childNodes,c,e,f,h=b.length;if(h){f=1;for(c=0;c<h;c++)if(e=b[c],e.nodeType!=a.DOM.NodeType.TEXT_NODE||e.nodeValue){f=0;break}return f?!1:void 0}return!1}function v(a){return a.replace(w,function(a,b,d){return"<"+b+d.replace(y,function(a,b){return-1==d.indexOf("_ke_saved_"+b)?" _ke_saved_"+a+" "+a:a})+">"})}function e(a){return a.replace(j,function(a){return"<ke:encoded>"+encodeURIComponent(a)+"</ke:encoded>"})}
function i(b){return b.replace(f,function(b,d){return a.urlDecode(d)})}var n=a.Node,p=a.UA,x=new s.Filter,k=new s.Filter;(function(){function b(a){a=s.serialize(a);return new s.Comment(c+encodeURIComponent(a).replace(/--/g,"%2D%2D"))}var e={tagNames:[[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],attributeNames:[[/^on/,"ke_on"],[/^lang$/,""]],tags:{script:b,noscript:b,span:l}},f={tagNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],tags:{$:function(a){if(a.attributes.length)for(var b=["name","href","src"],
d,c=0;c<b.length;c++)d="_ke_saved_"+b[c],a.getAttribute(d)&&a.removeAttribute(b[c]);return a},embed:function(a){var b=a.parentNode;if(b&&"object"==b.nodeName){var d=b.getAttribute("width"),b=b.getAttribute("height");d&&a.setAttribute("width",d);b&&a.setAttribute("width",b)}},a:function(a){if(!a.childNodes.length&&!a.attributes.length)return!1},span:l,strong:l,em:l,del:l,u:l},attributes:{style:function(b){if(!a.trim(b))return!1}},attributeNames:[[/^_ke_saved_/,""],[/^ke_on/,"on"],[/^_ke.*/,""],[/^ke:.*$/,
""],[/^_ks.*/,""]],comment:function(b){if(b.substr(0,c.length)==c)return b=a.trim(a.urlDecode(b.substr(c.length))),s.parse(b).childNodes[0]}};p.ie&&(f.attributes.style=function(a){return a.replace(/(^|;)([^:]+)/g,function(a){return a.toLowerCase()})});x.addRules(f);k.addRules(e)})();(function(){function b(d){for(var d=d.childNodes,c=d.length,e=d[c-1];e&&3==e.nodeType&&!a.trim(e.nodeValue);)e=d[--c];return e}function c(a){var e=b(a);e&&(1==e.nodeType&&"br"==e.nodeName?a.removeChild(e):3==e.nodeType&&
i.test(e.nodeValue)&&a.removeChild(e))}function e(a){var c=b(a);return!c||"form"==a.nodeName&&"input"==c.nodeName}function f(a){c(a);e(a)&&(p.ie||a.appendChild(new s.Tag("br")))}function h(a){c(a);e(a)&&a.appendChild(new s.Text("\u00a0"))}var i=/^[\t\r\n ]*(?:&nbsp;|\xa0)[\t\r\n ]*$/,j=r.XHTML_DTD,l=a.merge(j.$block,j.$listItem,j.$tableContent),n;for(n in l)"br"in j[n]||delete l[n];delete l.pre;var j={tags:{}},o={tags:{}};for(n in l)j.tags[n]=f,o.tags[n]=h;k.addRules(j);x.addRules(o)})();x.addRules({text:function(a){return a.replace(/\xa0/g,
"&nbsp;")}});var w=/<(a|area|img|input)\b([^>]*)>/gi,y=/\b(href|src|name)\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|(?:[^ "'>]+))/gi,c="{ke_protected}",j=/(?:<textarea[^>]*>[\s\S]*<\/textarea>)|(?:<style[^>]*>[\s\S]*<\/style>)|(?:<(:?link|meta|base)[^>]*>)/gi,f=/<ke:encoded>([^<]*)<\/ke:encoded>/gi,t=/(<\/?)((?:object|embed|param|html|body|head|title|script|noscript)[^>]*>)/gi,b=/(<\/?)ke:((?:object|embed|param|html|body|head|title|script|noscript)[^>]*>)/gi,h=/<ke:(param|embed)([^>]*?)\/?>(?!\s*<\/ke:\1)/gi;
o.htmlDataProcessor={dataFilter:k,htmlFilter:x,toHTML:function(a){p.webkit&&(a=a.replace(/\u200b/g,""));var b=new s.BeautifyWriter;(new s.Parser(a)).parse().writeHtml(b,x);return a=b.getHtml()},toDataFormat:function(a,c){var c=c||k,a=e(a),a=v(a),a=a.replace(t,"$1ke:$2"),a=a.replace(h,"<ke:$1$2></ke:$1>"),f=new n("<div>");f.html("a"+a);a=f.html().substr(1);a=a.replace(b,"$1$2");a=i(a);f=new s.BasicWriter;(new s.Parser(a)).parse().writeHtml(f,c);return a=f.getHtml()},toServer:function(a){var b=new s.MinifyWriter;
(new s.Parser(a)).parse().writeHtml(b,x);return b.getHtml()}}}}},{requires:["./base","html-parser"]});
KISSY.add("editor/selectionFix",function(a,r){function s(a){function e(a,b){var c=d.body.createTextRange();try{c.moveToPoint(a,b)}catch(f){c=n}return c}function f(){var a=d.selection.createRange();g&&!a.item&&0===a.compareEndPoints("StartToEnd",a)&&g.select();x.remove(d,"mouseup",f);x.remove(d,"mousemove",i);g=b=0}function i(a){if(a.button){if(a=e(a.pageX,a.pageY))0<a.compareEndPoints("StartToStart",g)?a.setEndPoint("StartToStart",g):a.setEndPoint("EndToEnd",g),a.select()}else f()}var b,h=a.get("window")[0],
d=a.get("document")[0],g;x.on(d,"mousedown contextmenu",function(a){var c=d.documentElement;if(a.target===c&&(b&&f(),!(c.scrollHeight>c.clientHeight)&&(b=1,g=e(a.pageX,a.pageY))))x.on(d,"mouseup",f),x.on(d,"mousemove",i),h.focus(),g.select()})}function o(a){function j(b){if(d){var g=a.getSelection(),i=g&&g.getType(),k=g&&f.selection;if(b&&k&&i==y.SELECTION_NONE&&!f.queryCommandEnabled("InsertImage"))setTimeout(function(){j(e)},50);else{var l;if(!k||!k.type||!("Control"!=k.type&&(l=k.createRange())&&
(l=l.parentElement())&&(l=l.nodeName)&&l.toLowerCase()in{input:1,textarea:1}))h=k&&g.getRanges()[0],a.checkSelectionChange()}}}var f=a.get("document")[0],k=new w(f.body),b=new w(f.documentElement);if(8>r.Utils.ieEngine)b.on("click",function(b){"html"===(new w(b.target)).nodeName()&&a.getSelection().getNative().createRange().select()});var h,d,g=e;b.on("mousedown",function(){g=i});b.on("mouseup",function(){g=e});k.on("focusin",function(a){if("body"==(new w(a.target)).nodeName()&&h){try{g&&h.select()}catch(b){}h=
n}});k.on("focus",function(){d=e;j()});k.on("beforedeactivate",function(a){a.relatedTarget||(d=i,g=e)});k.on("mousedown",function(){d=i});k.on("mouseup",function(){d=e;setTimeout(function(){j(e)},0)});k.on("keydown",function(){d=i});k.on("keyup",function(){d=e;setTimeout(function(){j()},0)})}function l(a){var e=a.get("document")[0];x.on(e,"mouseup keyup selectionchange",function(){a.checkSelectionChange()})}function v(a){function j(a){var b=r.XHTML_DTD;return a._4e_isBlockBoundary()&&b.$empty[a.nodeName()]}
function f(a){return b(a)&&h(a)}var l=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;|(<\!--[\s\S]*?--\>))?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,b=r.Walker.whitespaces(e),h=r.Walker.bookmark(i,e),d=function(a){return b(a)&&8!=a.nodeType};a.on("selectionChange",function(b){var h=b.path,n=new w(a.get("document")[0].body),b=(b=b.selection)&&b.getRanges()[0],o=h.blockLimit;if(p.gecko){var s=h.block||h.blockLimit,v=s&&s.last(f);s&&s._4e_isBlockBoundary()&&(!v||!(1==v[0].nodeType&&
v._4e_isBlockBoundary()))&&"pre"!=s.nodeName()&&!s._4e_getBogus()&&s._4e_appendBogus()}if(b&&b.collapsed&&!h.block){if("body"==o.nodeName()){if((h=b.fixBlock(e,"p"))&&h[0]!=n[0].lastChild&&h.outerHtml().match(l))if((o=h.next(d,1))&&o[0].nodeType==k.NodeType.ELEMENT_NODE&&!j[o])b.moveToElementEditablePosition(o),h._4e_remove();else if((o=h.prev(d,1))&&o[0].nodeType==k.NodeType.ELEMENT_NODE&&!j[o])b.moveToElementEditablePosition(o,o.outerHtml().match(l)?i:e),h._4e_remove();b.select();a.notifySelectionChange()}h=
a.get("document")[0];b=new r.Range(h);b.moveToElementEditablePosition(n,e);"body"!==(new r.ElementPath(b.startContainer)).blockLimit.nodeName()&&(n=(new w(h.createElement("p"))).appendTo(n),p.ie||n._4e_appendBogus())}})}var e=!0,i=!1,n=null,p=a.UA,x=a.Event,k=a.DOM,w=a.Node,y=r.SELECTION;return{init:function(a){a.docReady(function(){p.ie?(s(a),o(a)):l(a)});v(a)}}},{requires:["./base","./selection","node"]});
KISSY.add("editor/plugin-meta",function(){(function(a){a({"editor/plugin/back-color":{requires:["editor","editor/plugin/color/btn","editor/plugin/back-color/cmd"]}});a({"editor/plugin/back-color/cmd":{requires:["editor/plugin/color/cmd"]}});a({"editor/plugin/bold":{requires:["editor","editor/plugin/font/ui","editor/plugin/bold/cmd"]}});a({"editor/plugin/bold/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/bubble":{requires:["overlay","editor"]}});a({"editor/plugin/button":{requires:["editor",
"button"]}});a({"editor/plugin/checkbox-source-area":{requires:["editor"]}});a({"editor/plugin/code":{requires:["editor","editor/plugin/dialog-loader"]}});a({"editor/plugin/code/dialog":{requires:["editor","editor/plugin/dialog","menubutton"]}});a({"editor/plugin/color/btn":{requires:["editor","editor/plugin/button","editor/plugin/overlay","editor/plugin/dialog-loader"]}});a({"editor/plugin/color/cmd":{requires:["editor"]}});a({"editor/plugin/color/dialog":{requires:["editor","editor/plugin/dialog"]}});
a({"editor/plugin/contextmenu":{requires:["editor","menu","editor/plugin/focus-fix"]}});a({"editor/plugin/dent-cmd":{requires:["editor","editor/plugin/list-utils"]}});a({"editor/plugin/dialog-loader":{requires:["overlay","editor"]}});a({"editor/plugin/dialog":{requires:["editor","overlay","editor/plugin/focus-fix","dd/plugin/constrain","component/plugin/drag"]}});a({"editor/plugin/draft":{requires:["editor","editor/plugin/local-storage","overlay","editor/plugin/menubutton"]}});a({"editor/plugin/drag-upload":{requires:["editor"]}});
a({"editor/plugin/element-path":{requires:["editor"]}});a({"editor/plugin/fake-objects":{requires:["editor","html-parser"]}});a({"editor/plugin/flash-bridge":{requires:["swf","editor"]}});a({"editor/plugin/flash-common/base-class":{requires:["editor","editor/plugin/contextmenu","editor/plugin/bubble","editor/plugin/dialog-loader","editor/plugin/flash-common/utils"]}});a({"editor/plugin/flash-common/utils":{requires:["swf"]}});a({"editor/plugin/flash":{requires:["editor","editor/plugin/flash-common/base-class",
"editor/plugin/flash-common/utils","editor/plugin/fake-objects"]}});a({"editor/plugin/flash/dialog":{requires:["editor","editor/plugin/flash-common/utils","editor/plugin/dialog","editor/plugin/menubutton"]}});a({"editor/plugin/focus-fix":{requires:["editor"]}});a({"editor/plugin/font-family":{requires:["editor","editor/plugin/font/ui","editor/plugin/font-family/cmd"]}});a({"editor/plugin/font-family/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/font-size":{requires:["editor",
"editor/plugin/font/ui","editor/plugin/font-size/cmd"]}});a({"editor/plugin/font-size/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/font/cmd":{requires:["editor"]}});a({"editor/plugin/font/ui":{requires:["editor","editor/plugin/button","editor/plugin/menubutton"]}});a({"editor/plugin/fore-color":{requires:["editor","editor/plugin/color/btn","editor/plugin/fore-color/cmd"]}});a({"editor/plugin/fore-color/cmd":{requires:["editor/plugin/color/cmd"]}});a({"editor/plugin/heading":{requires:["editor",
"editor/plugin/heading/cmd"]}});a({"editor/plugin/heading/cmd":{requires:["editor"]}});a({"editor/plugin/image":{requires:["editor","editor/plugin/button","editor/plugin/bubble","editor/plugin/contextmenu","editor/plugin/dialog-loader"]}});a({"editor/plugin/image/dialog":{requires:["io","editor","editor/plugin/dialog","tabs","editor/plugin/menubutton"]}});a({"editor/plugin/indent":{requires:["editor","editor/plugin/indent/cmd"]}});a({"editor/plugin/indent/cmd":{requires:["editor","editor/plugin/dent-cmd"]}});
a({"editor/plugin/italic":{requires:["editor","editor/plugin/font/ui","editor/plugin/italic/cmd"]}});a({"editor/plugin/italic/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/justify-center":{requires:["editor","editor/plugin/justify-center/cmd"]}});a({"editor/plugin/justify-center/cmd":{requires:["editor/plugin/justify-cmd"]}});a({"editor/plugin/justify-cmd":{requires:["editor"]}});a({"editor/plugin/justify-left":{requires:["editor","editor/plugin/justify-left/cmd"]}});a({"editor/plugin/justify-left/cmd":{requires:["editor/plugin/justify-cmd"]}});
a({"editor/plugin/justify-right":{requires:["editor","editor/plugin/justify-right/cmd"]}});a({"editor/plugin/justify-right/cmd":{requires:["editor/plugin/justify-cmd"]}});a({"editor/plugin/link":{requires:["editor","editor/plugin/bubble","editor/plugin/link/utils","editor/plugin/dialog-loader","editor/plugin/button"]}});a({"editor/plugin/link/dialog":{requires:["editor","editor/plugin/dialog","editor/plugin/link/utils"]}});a({"editor/plugin/link/utils":{requires:["editor"]}});a({"editor/plugin/list-utils":{requires:["editor"]}});
a({"editor/plugin/list-utils/btn":{requires:["editor","editor/plugin/button","editor/plugin/menubutton"]}});a({"editor/plugin/list-utils/cmd":{requires:["editor","editor/plugin/list-utils"]}});a({"editor/plugin/local-storage":{requires:["editor","overlay","editor/plugin/flash-bridge"]}});a({"editor/plugin/maximize":{requires:["editor","editor/plugin/maximize/cmd"]}});a({"editor/plugin/maximize/cmd":{requires:["editor"]}});a({"editor/plugin/menubutton":{requires:["editor","menubutton"]}});a({"editor/plugin/multiple-upload":{requires:["editor",
"editor/plugin/dialog-loader"]}});a({"editor/plugin/multiple-upload/dialog":{requires:"editor,overlay,component/plugin/drag,editor/plugin/progressbar,editor/plugin/dialog,editor/plugin/flash-bridge,editor/plugin/local-storage,swf".split(",")}});a({"editor/plugin/ordered-list":{requires:["editor","editor/plugin/list-utils/btn","editor/plugin/ordered-list/cmd"]}});a({"editor/plugin/ordered-list/cmd":{requires:["editor","editor/plugin/list-utils/cmd"]}});a({"editor/plugin/outdent":{requires:["editor",
"editor/plugin/outdent/cmd"]}});a({"editor/plugin/outdent/cmd":{requires:["editor","editor/plugin/dent-cmd"]}});a({"editor/plugin/overlay":{requires:["editor","overlay","editor/plugin/focus-fix"]}});a({"editor/plugin/page-break":{requires:["editor","editor/plugin/fake-objects"]}});a({"editor/plugin/remove-format":{requires:["editor","editor/plugin/remove-format/cmd","editor/plugin/button"]}});a({"editor/plugin/remove-format/cmd":{requires:["editor"]}});a({"editor/plugin/resize":{requires:["editor",
"dd"]}});a({"editor/plugin/separator":{requires:["editor"]}});a({"editor/plugin/smiley":{requires:["editor","editor/plugin/overlay"]}});a({"editor/plugin/source-area":{requires:["editor","editor/plugin/button"]}});a({"editor/plugin/strike-through":{requires:["editor","editor/plugin/font/ui","editor/plugin/strike-through/cmd"]}});a({"editor/plugin/strike-through/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/table":{requires:["editor","editor/plugin/dialog-loader","editor/plugin/contextmenu"]}});
a({"editor/plugin/table/dialog":{requires:["editor","editor/plugin/dialog","editor/plugin/menubutton"]}});a({"editor/plugin/underline":{requires:["editor","editor/plugin/font/ui","editor/plugin/underline/cmd"]}});a({"editor/plugin/underline/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/undo":{requires:["editor","editor/plugin/undo/btn","editor/plugin/undo/cmd"]}});a({"editor/plugin/undo/btn":{requires:["editor","editor/plugin/button"]}});a({"editor/plugin/undo/cmd":{requires:["editor"]}});
a({"editor/plugin/unordered-list":{requires:["editor","editor/plugin/list-utils/btn","editor/plugin/unordered-list/cmd"]}});a({"editor/plugin/unordered-list/cmd":{requires:["editor","editor/plugin/list-utils/cmd"]}});a({"editor/plugin/video":{requires:["editor","editor/plugin/flash-common/utils","editor/plugin/flash-common/base-class","editor/plugin/fake-objects"]}});a({"editor/plugin/video/dialog":{requires:["editor","editor/plugin/flash/dialog","editor/plugin/menubutton"]}});a({"editor/plugin/word-filter":{requires:["html-parser"]}});
a({"editor/plugin/xiami-music":{requires:["editor","editor/plugin/flash-common/base-class","editor/plugin/flash-common/utils","editor/plugin/fake-objects"]}});a({"editor/plugin/xiami-music/dialog":{requires:["editor","editor/plugin/flash/dialog","editor/plugin/menubutton"]}})})(function(a){KISSY.config("modules",a)},KISSY.Features,KISSY.UA)});
KISSY.add("editor",function(a,r,s,o,l,v,e,i,n,p,x,k){function w(a,c){var d=a.body;G(function(){a.designMode="on";setTimeout(function(){a.designMode="off";d.focus();arguments.callee.retry||(arguments.callee.retry=b)},50)},function(){a.designMode="off";d.setAttribute("contentEditable",!1);d.setAttribute("contentEditable",!0);!c&&w(a,1)})}function y(b){b.get("iframe");var c=b.get("textarea")[0],e=b.get("window"),f=b.get("document"),g=f[0];u.webkit&&(f.on("click",function(b){var c=new r(b.target);a.inArray(c.nodeName(),
["input","select"])&&b.preventDefault()}),f.on("mouseup",function(b){var c=new r(b.target);a.inArray(c.nodeName(),["input","textarea"])&&b.preventDefault()}));if(u.gecko||D||u.opera){var h;h=(new r('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>')).insertAfter(c);h.on("focus",function(){b.focus()});b.activateGecko=function(){u.gecko&&b.__iframeFocus&&h[0].focus()};b.on("destroy",function(){h.detach();h.remove()})}e.on("focus",function(){u.gecko?w(g,d):u.opera&&
g.body.focus();b.notifySelectionChange()});if(u.gecko)f.on("mousedown",function(){b.__iframeFocus||w(g,d)});if(D&&(f.on("keydown",function(a){if(a.keyCode in{8:1,46:1}){var c=b.getSelection(),d=c.getSelectedElement();if(d){b.execCommand("save");var e=c.getRanges()[0].createBookmark();d.remove();c.selectBookmarks([e]);b.execCommand("save");a.preventDefault()}}}),"CSS1Compat"==g.compatMode)){var i={33:1,34:1};f.on("keydown",function(a){a.keyCode in i&&setTimeout(function(){b.getSelection().scrollIntoView()},
0)})}if(u.webkit)f.on("mousedown",function(c){c=new r(c.target);a.inArray(c.nodeName(),["img","hr","input","textarea","select"])&&b.getSelection().selectElement(c)});if(u.gecko)f.on("dragstart",function(a){var b=new r(a.target);b.nodeName()==="img"&&/ke_/.test(b[0].className)&&a.preventDefault()});v.add(b)}function c(b,c,d,e){var f="",h;h=l.debugUrl("theme/editor-iframe.css");d=d.concat([]);d.unshift(h);for(h=0;h<d.length;h++)f+=a.substitute('<link href="{href}" rel="stylesheet" />',{href:d[h]});
return a.substitute(s,{doctype:8===m.documentMode?'<meta http-equiv="X-UA-Compatible" content="IE=7" />':"",title:"${title}",links:f,style:c,data:e||"",script:b?'<script id="ke_active_script">'+(A(g).isCustomDomain()?'document.domain="'+m.domain+'";':"")+'parent.KISSY.require("editor")._initIframe("'+b+'");<\/script>':""})}function j(a,b){function d(){i=h.document;a.setInternal("document",new r(i));a.setInternal("window",new r(h));e.detach();i.open("text/html","replace");i.write(f);i.close()}var e=
a.get("iframe"),f=c(a.get("id"),a.get("customStyle"),a.get("customLink"),b),g=e[0],h=g.contentWindow,i;e.__loaded=1;try{i=h.document}catch(j){if(g.src=g.src,7>D){setTimeout(d,10);return}}d()}function f(b,c){var d=A(g).getEmptyIframeSrc()||"";d&&(d=' src="'+d+'" ');var d=new r(a.substitute(J,{iframeSrc:d,prefixCls:b.get("prefixCls")})),e=b.get("textarea");e.hasAttr("tabindex")&&d.attr("tabindex",u.webkit?-1:e.attr("tabindex"));e.parent().prepend(d);b.set("iframe",d);b.__docReady=0;if(u.gecko&&!d.__loaded)d.on("load",
function(){j(b,c)},b);else j(b,c)}function t(b){if(b.get("iframe")){var c=b.get("iframe"),d=b.get("window"),b=b.get("document"),e=b[0],f=A(e.documentElement),e=A(e.body);a.each([b,f,e,d],function(a){a.detach()});c.remove()}}var b=!0,h=h,d=!1,g=a.Env.host,m=g.document,u=a.UA,D=u.ie,E=r.NodeType,A=r.all,G=l.tryThese,J='<iframe class="{prefixCls}editor-iframe" frameborder="0"  title="kissy-editor"  allowTransparency="true"  {iframeSrc} ></iframe>',C=/^(?:<(p)>)?(?:(?:&nbsp;)|\s|<br[^>]*>)*(?:<\/\1>)?$/i;
o.Mode={SOURCE_MODE:0,WYSIWYG_MODE:1};a.augment(o,{initializer:function(){this.__commands={};this.__controls={};v.register(this)},renderUI:function(){n.init(this);p.init(this);x.init(this);k.init(this)},bindUI:function(){function a(){b.detach("docReady",a);if(b.get("focused"))b.focus();else{var c=b.getSelection();c&&c.removeAllRanges()}}var b=this,c,d=b.get("prefixCls"),e=b.get("textarea");if(b.get("attachForm")&&(c=e[0].form)&&(c=A(c)))c.on("submit",b.sync,b);b.on("docReady",a);b.on("blur",function(){b.$el.removeClass(d+
"editor-focused")});b.on("focus",function(){b.$el.addClass(d+"editor-focused")})},_onSetHeight:function(a){var b=this.get("textarea"),c=this.get("toolBarEl"),d=this.get("statusBarEl"),a=parseInt(a,10),a=a-((c&&c.outerHeight()||0)+(d&&d.outerHeight()||0));b.parent().css("height",a);b.css("height",a)},_onSetMode:function(a){var b=this.get("iframe"),c=this.get("textarea");1==a?(this.setData(c.val()),c.hide(),this.fire("wysiwygMode")):(b&&(c.val(this.getFormatData(1)),b.hide()),c.show(),this.fire("sourceMode"))},
_onSetFocused:function(a){a&&this.__docReady&&this.focus()},setData:function(a){var b,c=a;if(1!=this.get("mode"))this.get("textarea").val(a);else{if(b=this.htmlDataProcessor)c=b.toDataFormat(a);t(this);f(this,c)}},destructor:function(){var b,c=this.get("textarea"),d=this.get("document");this.get("attachForm")&&(b=c[0].form)&&(b=A(b))&&b.detach("submit",this.sync,this);if(d){b=A(d[0].body);var c=A(d[0].documentElement),e=this.get("window");v.remove(this);d.detach();c.detach();b.detach();e.detach()}a.each(this.__controls,
function(a){a.destroy&&a.destroy()});this.__commands={};this.__controls={}},getControl:function(a){return this.__controls[a]},getControls:function(){return this.__controls},addControl:function(a,b){this.__controls[a]=b},showDialog:function(a,b){var a=a+"/dialog",c=this.__controls[a];c.show(b);this.fire("dialogShow",{dialog:c.dialog,pluginDialog:c,dialogName:a})},addCommand:function(a,b){this.__commands[a]=b},hasCommand:function(a){return this.__commands[a]},execCommand:function(b){var c=this.__commands[b],
d=a.makeArray(arguments);d.shift();d.unshift(this);return c?c.exec.apply(c,d):h},queryCommandValue:function(a){return this.execCommand(l.getQueryCmd(a))},getData:function(b,c){var d=this.htmlDataProcessor,e;c==h&&(c=this.get("mode"));e=1==c&&this.isDocReady()?this.get("document")[0].body.innerHTML:d.toDataFormat(this.get("textarea").val());e=b?d.toHTML(e):d.toServer(e);e=a.trim(e);C.test(e)&&(e="");return e},getFormatData:function(a){return this.getData(1,a)},getDocHtml:function(){return c(0,this.get("customStyle"),
this.get("customLink"),this.getFormatData())},getSelection:function(){return o.Selection.getSelection(this.get("document")[0])},getSelectedHtml:function(){var a=this.getSelection().getRanges()[0],b;a&&(a=a.cloneContents(),b=this.get("document")[0].createElement("div"),b.appendChild(a),b=b.innerHTML);return b},focus:function(){var a=this.get("window");if(a){var b=this.get("document")[0],a=a[0];u.ie||a&&a.parent&&a.parent.focus();a&&a.focus();try{b.body.focus()}catch(c){}this.notifySelectionChange()}},
blur:function(){this.get("window")[0].blur();this.get("document")[0].body.blur()},addCustomStyle:function(a,b){var c=this.get("window"),d=this.get("customStyle")||"";this.set("customStyle",d+("\n"+a));c&&c.addStyleSheet(c,a,b)},removeCustomStyle:function(a){this.get("document").on("#"+a).remove()},addCustomLink:function(a){var b=this.get("customLink"),c=this.get("document")[0];b.push(a);this.set("customLink",b);b=c.createElement("link");b.rel="stylesheet";c.getElementsByTagName("head")[0].appendChild(b);
b.href=a},removeCustomLink:function(b){this.get("document").all("link").each(function(a){a.attr("href")==b&&a.remove()});var c=this.get("customLink"),d=a.indexOf(b,c);-1!=d&&c.splice(d,1)},docReady:function(a){this.on("docReady",a);this.__docReady&&a.call(this)},isDocReady:function(){return this.__docReady},checkSelectionChange:function(){var a=this;a.__checkSelectionChangeId&&clearTimeout(a.__checkSelectionChangeId);a.__checkSelectionChangeId=setTimeout(function(){var b=a.getSelection();if(b&&!b.isInvalid){var c=
b.getStartElement(),d=new o.ElementPath(c);if(!a.__previousPath||!a.__previousPath.compare(d))a.__previousPath=d,a.fire("selectionChange",{selection:b,path:d,element:c})}},100)},notifySelectionChange:function(){this.__previousPath=null;this.checkSelectionChange()},insertElement:function(a){if(1!==this.get("mode"))return h;this.focus();var c,d=a.nodeName(),e=o.XHTML_DTD,f=e.$block[d],g=o.RANGE,i=(d=this.getSelection())&&d.getRanges(),j,k,l;if(!i||0==i.length)return h;this.execCommand("save");for(k=
i.length-1;0<=k;k--)j=i[k],c=!k&&a||a.clone(b),j.insertNodeByDtd(c),l||(l=c);if(!l)return h;j.moveToPosition(l,g.POSITION_AFTER_END);f&&(a=o.Walker.whitespaces(!0),(a=(l=l.next(a,1))&&l[0].nodeType==E.ELEMENT_NODE&&l.nodeName())&&e.$block[a]&&e[a]["#text"]&&j.moveToElementEditablePosition(l));d.selectRanges([j]);this.focus();c&&1==c[0].nodeType&&c.scrollIntoView(h,{alignWithTop:!1,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0});M.call(this);return c},insertHtml:function(a,b){var c=this,e,f=c.get("document")[0];
if(1===c.get("mode")){if(e=c.htmlDataProcessor)a=e.toDataFormat(a,b);c.focus();c.execCommand("save");if(D){e=f.selection;"Control"==e.type&&e.clear();try{e.createRange().pasteHTML(a)}catch(g){}}else try{f.execCommand("inserthtml",d,a)}catch(h){setTimeout(function(){if(0==c.getSelection().getRanges().length){var b=new o.Range(f),e=A(f.body).first(function(a){return 1==a.nodeType&&"br"!=a.nodeName.toLowerCase()});e||(e=A(f.createElement("p")),e._4e_appendBogus().appendTo(f.body));b.setStartAt(e,o.RANGE.POSITION_AFTER_START);
b.select()}f.execCommand("inserthtml",d,a)},50)}setTimeout(function(){c.getSelection().scrollIntoView()},50);M.call(c)}}});o.decorate=function(a,b){var b=b||{},a=A(a),c=b.textareaAttrs=b.textareaAttrs||{},d=a.style("width"),e=a.style("height"),f=a.attr("name");d&&(b.width=b.width||d);e&&(b.height=b.height||e);f&&(c.name=f);b.data=b.data||a.val();b.elBefore=a;c=(new o(b)).render();a.remove();return c};o._initIframe=function(a){var c=v.getInstance(a),a=c.get("document"),e=a[0];a.one("#ke_active_script").remove();
y(c);var f=e.body,g=A(f);D?(f.hideFocus=b,f.disabled=b,f.contentEditable=b,f.removeAttribute("disabled")):setTimeout(function(){u.gecko||u.opera?f.contentEditable=b:u.webkit?f.parentNode.contentEditable=b:e.designMode="on"},0);if(u.gecko||u.opera){var h=e.documentElement;A(h).on("mousedown",function(a){if(a.target==h){u.gecko&&w(e,d);c.activateGecko()}})}setTimeout(function(){D&&setTimeout(function(){if(e){f.runtimeStyle.marginBottom="0px";f.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){c.__docReady=
1;c.fire("docReady");var a=c.get("disableObjectResizing"),b=c.get("disableInlineTableEditing");if(a||b)try{e.execCommand("enableObjectResizing",d,!a);e.execCommand("enableInlineTableEditing",d,!b)}catch(f){g.on(D?"resizestart":"resize",function(c){var d=new r(c.target);(a||d.nodeName()==="table"&&b)&&c.preventDefault()})}},10)};var M=a.buffer(function(){this.execCommand("save")},50);return o},{requires:"node,editor/iframe-content-tpl,editor/base,editor/utils,editor/focusManager,editor/styles,editor/zIndexManager,editor/clipboard,editor/enterKey,editor/htmlDataProcessor,editor/selectionFix,editor/plugin-meta".split(",")});
