/*
Copyright 2012, KISSY UI Library v1.30dev
MIT Licensed
build time: Jun 13 14:40
*/
/*
 thanks to CKSource's intelligent work on CKEditor
 @author yiminghe@gmail.com
*/
KISSY.add("editor/core/base",function(g,o,u){o=u.Controller.extend({initializer:function(){this.__commands={};this.__controls={}},use:function(m,o){var c=this,d=c.__CORE_PLUGINS||["htmlDataProcessor","enterKey","clipboard","selection"];g.isString(m)&&(m=m.split(","));for(var k=m.length-1;0<=k;k--)m[k]||m.splice(k,1);for(k=0;k<d.length;k++){var t=d[k];g.inArray(t,m)||m.unshift(t)}g.each(m,function(d,c){m[c]&&(m[c]="editor/plugin/"+d+"/")});g.use(m,function(){var d=g.makeArray(arguments);d.shift();
for(var k=0;k<d.length;k++)d[k]&&d[k].init(c);o&&o.call(c);c.adjustHeight()});c.__CORE_PLUGINS=[];return c}},{Config:{},XHTML_DTD:o.DTD,ATTRS:{textarea:{},iframe:{},window:{},document:{},iframeWrapEl:{},toolBarEl:{},statusBarEl:{},handleMouseEvents:{value:!1},focusable:{value:!1},mode:{value:1},data:{getter:function(){return this._getData()},setter:function(g){return this._setData(g)}},formatData:{getter:function(){return this._getData(1)},setter:function(g){return this._setData(g)}},customStyle:{value:""},
customLink:{value:[]}}},{xclass:"editor"});o.HTML_PARSER={textarea:function(g){return g.one(this.get("prefixCls")+".editor-textarea")}};g.mix(o,g.EventTarget);return KISSY.Editor=o},{requires:["htmlparser","component","core"]});
KISSY.add("editor/plugin/clipboard/index",function(g){function o(e){this.editor=e;this._init()}function u(e){if(c.ie&&"BackCompat"!=e.get("document")[0].compatMode){var a=e.getSelection(),h;if(a.getType()==w.SELECTION_ELEMENT&&(h=a.getSelectedElement())){var f=a.getRanges()[0],j=r(e.get("document")[0].createTextNode(""));j.insertBefore(h);f.setStartBefore(j);f.setEndAfter(h);a.selectRanges([f]);setTimeout(function(){h.parent()&&(j.remove(),a.selectElement(h))},0)}}}var m=g.Editor,r=g.all,c=g.UA,d=
m.Range,k=m.RANGE,t=g.Event;g.augment(o,{_init:function(){var a=this.editor;t.on(a.get("document")[0].body,c.webkit?"paste":c.gecko?"paste":"beforepaste",this._paste,this);t.on(a.get("document")[0].body,"contextmenu",function(){b=1;setTimeout(function(){b=0},10)});a.addCommand("copy",new q("copy"));a.addCommand("cut",new q("cut"));a.addCommand("paste",new q("paste"))},_paste:function(){if(!b){var a=this.editor,i=a.get("document")[0];if(!i.getElementById("ke_pastebin")){var h=a.getSelection(),f=new d(i),
j=r(c.webkit?"<body></body>":"<div></div>",null,i);j.attr("id","ke_pastebin");c.webkit&&j[0].appendChild(i.createTextNode("\u00a0"));i.body.appendChild(j[0]);j.css({position:"absolute",top:h.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});j.css("left","-1000px");var s=h.createBookmarks();f.setStartAt(j,k.POSITION_AFTER_START);f.setEndAt(j,k.POSITION_BEFORE_END);f.select(!0);setTimeout(function(){j.remove();var f;j=c.webkit&&(f=j.first())&&f.hasClass("Apple-style-span")?
f:j;h.selectBookmarks(s);f=j.html();if(f=g.trim(f.replace(/<span[^>]+_ke_bookmark[^<]*?<\/span>(&nbsp;)*/ig,""))){var b=a.fire("paste",{html:f,holder:j});void 0!==b&&(f=b);b=null;/(class="?Mso|style="[^"]*\bmso\-|w:WordDocument)/.test(f)&&(b=a.htmlDataProcessor.wordFilter);a.insertHtml(f,b)}},0)}}}});var p=function(a,b){var h=a.get("document")[0],f=r(h.body),j=!1,s=function(){j=!0};f.on(b,s);(7<c.ie?h:h.selection.createRange()).execCommand(b);f.detach(b,s);return j},v=c.ie?function(a,b){return p(a,
b)}:function(a,b){try{return a.get("document")[0].execCommand(b)}catch(h){return!1}},n={cut:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u526a\u5207\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+X)\u6765\u5b8c\u6210",copy:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u590d\u5236\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+C)\u6765\u5b8c\u6210",paste:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u7c98\u8d34\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+V)\u6765\u5b8c\u6210"},q=function(a){this.type=a};q.prototype={exec:function(a){"cut"==this.type&&u(a);(a=v(a,this.type))||alert(n[this.type]);return a}};var w=m.Selection,a={copy:"\u590d\u5236",paste:"\u7c98\u8d34",cut:"\u526a\u5207"},b;m.on("contextmenu",function(e){e=e.contextmenu;if(!e.__copy_fix){e.__copy_fix=
1;var b=e.get("editor"),h={copy:1,cut:1,paste:1},f;for(f in h)h.hasOwnProperty(f)&&e.addChild({xclass:"menuitem",content:a[f],value:f});e.on("click",function(a){var f=a.target.get("value");h[f]&&(this.hide(),setTimeout(function(){b.execCommand(f)},30))})}});return{init:function(a){a.docReady(function(){new o(a)})}}},{requires:["editor"]});
KISSY.add("editor/core/dom",function(g,o,u){function m(a,b){var e=a[b?"next":"prev"](r,1);if(e&&e[0].nodeType==d.ELEMENT_NODE){for(var i=[];e.attr("_ke_bookmark")||e._4e_isEmptyInlineRemovable(r);)if(i.push(e),e=b?e.next(r,1):e.prev(r,1),!e)return;if(a._4e_isIdentical(e,r)){for(var h=new t(b?a[0].lastChild:a[0].firstChild);i.length;)i.shift()._4e_move(a,!b,r);e._4e_moveChildren(a,!b,r);e.remove();h[0]&&h[0].nodeType==d.ELEMENT_NODE&&h._4e_mergeSiblings()}}}var r=r,c=o.XHTML_DTD,d=g.DOM,k=g.UA,t=g.Node,
p={a:1,abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};o.POSITION={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};var v=o.POSITION,n={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,
"table-cell":1,"table-caption":1},q={hr:1},w=function(a){return a&&(a[0]||a)};u.injectDom({_4e_sameLevel:function(a,b){var b=w(b),e=a.parentNode;return e&&e==b.parentNode},_4e_isBlockBoundary:function(a,b){var e=g.merge(q,b);return!(!n[d.css(a,"display")]&&!e[d.nodeName(a)])},_4e_index:function(a,b){for(var e=a.parentNode.childNodes,i,h=-1,f=0;f<e.length;f++)if(i=e[f],!b||!(3==i.nodeType&&i.previousSibling&&3==i.previousSibling.nodeType))if(h++,i===a)return h;return-1},_4e_move:function(a,b,e){b=
w(b);e?b.insertBefore(a,b.firstChild):b.appendChild(a)},_4e_isIdentical:function(a,b){if(!b)return!1;b=w(b);if(d.nodeName(a)!=d.nodeName(b))return!1;var e=a.attributes,i=b.attributes,h=e.length,f=i.length;if(h!=f)return!1;for(var j=0;j<h;j++){var s=e[j],c=s.name;if(s.specified&&d.attr(a,c)!=d.attr(b,c))return!1}if(8>u.ieEngine)for(j=0;j<f;j++)if(s=i[j],c=s.name,s.specified&&d.attr(a,c)!=d.attr(b,c))return!1;return!0},_4e_isEmptyInlineRemovable:function(a){if(!c.$removeEmpty[d.nodeName(a)])return!1;
for(var a=a.childNodes,b=0,e=a.length;b<e;b++){var i=a[b],h=i.nodeType;if(!(h==d.ELEMENT_NODE&&i.getAttribute("_ke_bookmark"))&&(h==d.ELEMENT_NODE&&!d._4e_isEmptyInlineRemovable(i)||h==d.TEXT_NODE&&g.trim(i.nodeValue)))return!1}return!0},_4e_moveChildren:function(a,b,e){b=w(b);if(a!=b)if(e)for(;e=a.lastChild;)b.insertBefore(a.removeChild(e),b.firstChild);else for(;e=a.firstChild;)b.appendChild(a.removeChild(e))},_4e_mergeSiblings:function(a){a=new t(a);p[a.nodeName()]&&(m(a,!0),m(a))},_4e_splitText:function(a,
b){var e=a.ownerDocument;if(a.nodeType==d.TEXT_NODE){if(k.ie&&b==a.nodeValue.length){var i=e.createTextNode("");d.insertAfter(i,a);return i}i=a.splitText(b);e.documentMode&&(e=e.createTextNode(""),d.insertAfter(e,i),d.remove(e));return i}},_4e_parents:function(a,b){var e=[];e.__IS_NODELIST=1;do e[b?"push":"unshift"](a);while(a=a.parentNode);return e},_4e_nextSourceNode:function(a,b,e,i){if(i&&!i.call)var h=w(i),i=function(a){return a!==h};var b=!b&&a.firstChild,f=a;if(!b){if(a.nodeType==d.ELEMENT_NODE&&
i&&!1===i(a,!0))return null;b=a.nextSibling}for(;!b&&(f=f.parentNode);){if(i&&!1===i(f,!0))return null;b=f.nextSibling}return!b||i&&!1===i(b)?null:e&&e!=b.nodeType?d._4e_nextSourceNode(b,!1,e,i):b},_4e_previousSourceNode:function(a,b,e,i){if(i&&!i.call)var h=w(i),i=function(a){return a!==h};var b=!b&&a.lastChild,f=a;if(!b){if(a.nodeType==d.ELEMENT_NODE&&i&&!1===i(a,!0))return null;b=a.previousSibling}for(;!b&&(f=f.parentNode);){if(i&&!1===i(f,!0))return null;b=f.previousSibling}return!b||i&&!1===
i(b)?null:e&&b.nodeType!=e?d._4e_previousSourceNode(b,!1,e,i):b},_4e_commonAncestor:function(a,b){b=w(b);if(a===b)return a;if(d.contains(b,a))return b;var e=a;do if(d.contains(e,b))return e;while(e=e.parentNode);return null},_4e_hasAttributes:9>u.ieEngine?function(a){for(var b=a.attributes,e=0;e<b.length;e++){var i=b[e];switch(i.name){case "class":if(a.getAttribute("class"))return!0;break;default:if(i.specified)return!0}}return!1}:function(a){k.gecko&&a.removeAttribute("_moz_dirty");return a.hasAttributes()},
_4e_position:function(a,b){var e=w(b);if(a.compareDocumentPosition)return a.compareDocumentPosition(e);if(a==e)return v.POSITION_IDENTICAL;if(a.nodeType==d.ELEMENT_NODE&&e.nodeType==d.ELEMENT_NODE){if(d.contains(a,e))return v.POSITION_CONTAINS+v.POSITION_PRECEDING;if(d.contains(e,a))return v.POSITION_IS_CONTAINED+v.POSITION_FOLLOWING;if("sourceIndex"in a)return 0>a.sourceIndex||0>e.sourceIndex?v.POSITION_DISCONNECTED:a.sourceIndex<e.sourceIndex?v.POSITION_PRECEDING:v.POSITION_FOLLOWING}for(var i=
d._4e_address(a),e=d._4e_address(e),h=Math.min(i.length,e.length),f=0;f<=h-1;f++)if(i[f]!=e[f])return i[f]<e[f]?v.POSITION_PRECEDING:v.POSITION_FOLLOWING;return i.length<e.length?v.POSITION_CONTAINS+v.POSITION_PRECEDING:v.POSITION_IS_CONTAINED+v.POSITION_FOLLOWING},_4e_address:function(a,b){for(var e=[],i=a.ownerDocument.documentElement,h=a;h&&h!=i;)e.unshift(d._4e_index(h,b)),h=h.parentNode;return e},_4e_remove:function(a,b){var e=a.parentNode;if(e){if(b)for(var i;i=a.firstChild;)e.insertBefore(a.removeChild(i),
a);e.removeChild(a)}return a},_4e_trim:function(a){d._4e_ltrim(a);d._4e_rtrim(a)},_4e_ltrim:function(a){for(var b;b=a.firstChild;){if(b.nodeType==d.TEXT_NODE){var e=u.ltrim(b.nodeValue),i=b.nodeValue.length;if(e)e.length<i&&(d._4e_splitText(b,i-e.length),a.removeChild(a.firstChild));else{a.removeChild(b);continue}}break}},_4e_rtrim:function(a){for(var b;b=a.lastChild;){if(b.type==d.TEXT_NODE){var e=u.rtrim(b.nodeValue),i=b.nodeValue.length;if(e)e.length<i&&(d._4e_splitText(b,e.length),a.removeChild(a.lastChild));
else{a.removeChild(b);continue}}break}!k.ie&&!k.opera&&(b=a.lastChild)&&1==b.nodeType&&"br"==d.nodeName(b)&&a.removeChild(b)},_4e_appendBogus:function(a){for(var b=a.lastChild;b&&b.nodeType==d.TEXT_NODE&&!g.trim(b.nodeValue);)b=b.previousSibling;if(!b||b.nodeType==d.TEXT_NODE||"br"!==d.nodeName(b))b=k.opera?a.ownerDocument.createTextNode(""):a.ownerDocument.createElement("br"),k.gecko&&b.setAttribute("type","_moz"),a.appendChild(b)},_4e_outerHtml:function(a){if(a.outerHTML)return a.outerHTML.replace(/<\?[^>]*>/,
"");var b=a.ownerDocument.createElement("div");b.appendChild(a.cloneNode(!0));return b.innerHTML},_4e_setMarker:function(a,b,e,i){var a=new t(a),h=a.data("list_marker_id")||a.data("list_marker_id",g.guid()).data("list_marker_id"),f=a.data("list_marker_names")||a.data("list_marker_names",{}).data("list_marker_names");b[h]=a;f[e]=1;return a.data(e,i)},_4e_clearMarkers:function(a,b,e){var a=new t(a),i=a.data("list_marker_names"),h=a.data("list_marker_id"),f;for(f in i)i.hasOwnProperty(f)&&a.removeData(f);
a.removeData("list_marker_names");e&&(a.removeData("list_marker_id"),delete b[h])},_4e_copyAttributes:function(a,b,e){for(var b=new t(b),i=a.attributes,e=e||{},h=0;h<i.length;h++){var f=i[h],j=f.name.toLowerCase(),s;if(!(j in e))if("checked"==j&&(s=d.attr(a,j)))b.attr(j,s);else if(f.specified||k.ie&&f.value&&"value"==j)s=d.attr(a,j),null===s&&(s=f.nodeValue),b.attr(j,s)}""!==a.style.cssText&&(b[0].style.cssText=a.style.cssText)},_4e_isEditable:function(a){a=d.nodeName(a);return(a=!c.$nonEditable[a]&&
(c[a]||c.span))&&a["#"]},_4e_getByAddress:function(a,b,e){for(var a=a.documentElement,i=0;a&&i<b.length;i++){var h=b[i];if(e)for(var f=-1,j=0;j<a.childNodes.length;j++){var s=a.childNodes[j];if(!(!0===e&&3==s.nodeType&&s.previousSibling&&3==s.previousSibling.nodeType)&&(f++,f==h)){a=s;break}}else a=a.childNodes[h]}return a}})},{requires:["./base","./utils"]});
KISSY.add("editor/core/domIterator",function(g){function o(d){1>arguments.length||(this.range=d,this.forceBrBreak=m,this.enlargeBr=u,this.enforceRealBlocks=m,this._||(this._={}))}var u=!0,m=!1,r=g.Editor,c=g.UA,d=r.Walker,k=r.Range,t=r.RANGE,p=r.ElementPath,v=g.Node,n=g.DOM,q=/^[\r\n\t ]*$/;g.augment(o,{getNextParagraph:function(w){var a,b,e,i,h;if(!this._.lastNode){b=this.range.clone();b.shrink(t.SHRINK_ELEMENT,u);b.enlarge(this.forceBrBreak||!this.enlargeBr?t.ENLARGE_LIST_ITEM_CONTENTS:t.ENLARGE_BLOCK_CONTENTS);
var f=new d(b),j=d.bookmark(u,u);f.evaluator=j;this._.nextNode=f.next();f=new d(b);f.evaluator=j;f=f.previous();this._.lastNode=f._4e_nextSourceNode(u);this._.lastNode&&this._.lastNode[0].nodeType==n.TEXT_NODE&&!g.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()&&(j=new k(b.document),j.moveToPosition(this._.lastNode,t.POSITION_AFTER_END),j.checkEndOfBlock()&&(j=new p(j.endContainer),this._.lastNode=(j.block||j.blockLimit)._4e_nextSourceNode(u)));this._.lastNode||
(this._.lastNode=this._.docEndMarker=new v(b.document.createTextNode("")),n.insertAfter(this._.lastNode[0],f[0]));b=null}j=this._.nextNode;f=this._.lastNode;for(this._.nextNode=null;j;){var s=m,A=j[0].nodeType!=n.ELEMENT_NODE,z=m;if(A)j[0].nodeType==n.TEXT_NODE&&q.test(j[0].nodeValue)&&(A=m);else{var B=j.nodeName();if(j._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if("br"==B)A=u;else if(!b&&!j[0].childNodes.length&&"hr"!=B){a=j;e=j.equals(f);break}b&&(b.setEndAt(j,t.POSITION_BEFORE_START),"br"!=
B&&(this._.nextNode=j));s=u}else{if(j[0].firstChild){b||(b=new k(this.range.document),b.setStartAt(j,t.POSITION_BEFORE_START));j=new v(j[0].firstChild);continue}A=u}}A&&!b&&(b=new k(this.range.document),b.setStartAt(j,t.POSITION_BEFORE_START));e=(!s||A)&&j.equals(f);if(b&&!s)for(;!j[0].nextSibling&&!e;){B=j.parent();if(B._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){s=u;e||B.equals(f);break}j=B;A=u;e=j.equals(f);z=u}A&&b.setEndAt(j,t.POSITION_AFTER_END);j=j._4e_nextSourceNode(z,null,f);if((e=!j)||
s&&b)break}if(!a){if(!b)return this._.docEndMarker&&this._.docEndMarker._4e_remove(),this._.nextNode=null;a=new p(b.startContainer);j=a.blockLimit;s={div:1,th:1,td:1};a=a.block;if((!a||!a[0])&&!this.enforceRealBlocks&&s[j.nodeName()]&&b.checkStartOfBlock()&&b.checkEndOfBlock())a=j;else if(!a||this.enforceRealBlocks&&"li"==a.nodeName())a=new v(this.range.document.createElement(w||"p")),a[0].appendChild(b.extractContents()),a._4e_trim(),b.insertNode(a),i=h=u;else if("li"!=a.nodeName()){if(!b.checkStartOfBlock()||
!b.checkEndOfBlock())a=a.clone(m),a[0].appendChild(b.extractContents()),a._4e_trim(),h=b.splitBlock(),i=!h.wasStartOfBlock,h=!h.wasEndOfBlock,b.insertNode(a)}else e||(this._.nextNode=a.equals(f)?null:b.getBoundaryNodes().endNode._4e_nextSourceNode(u,null,f))}i&&(b=new v(a[0].previousSibling),b[0]&&b[0].nodeType==n.ELEMENT_NODE&&("br"==b.nodeName()?b._4e_remove():b[0].lastChild&&"br"==n.nodeName(b[0].lastChild)&&n._4e_remove(b[0].lastChild)));h&&(b=d.bookmark(m,u),i=new v(a[0].lastChild),i[0]&&i[0].nodeType==
n.ELEMENT_NODE&&"br"==i.nodeName()&&(c.ie||i.prev(b,1)||i.next(b,1))&&i.remove());this._.nextNode||(this._.nextNode=e||a.equals(f)?null:a._4e_nextSourceNode(u,null,f));return a}});k.prototype.createIterator=function(){return new o(this)}},{requires:["./base","./range","./elementPath","./walker"]});
KISSY.add("editor/core/elementPath",function(g){function o(g){for(var p=c,o=c,n=[];g;){if(g[0].nodeType==m.ELEMENT_NODE){this.lastElement||(this.lastElement=g);var q=g.nodeName();if(!o&&(!p&&d[q]&&(p=g),k[q])){var w;if(w=!p)if(w="div"==q){a:{w=g[0].childNodes;for(var a=0,b=w.length;a<b;a++){var e=w[a];if(e.nodeType==m.ELEMENT_NODE&&r.$block[e.nodeName.toLowerCase()]){w=!0;break a}}w=!1}w=!w}w?p=g:o=g}n.push(g);if("body"==q)break}g=g.parent()}this.block=p;this.blockLimit=o;this.elements=n}var u=g.Editor,
m=g.DOM,r=u.XHTML_DTD,c=null,d={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},k={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};o.prototype={compare:function(d){var c=this.elements,d=d&&d.elements;if(!d||c.length!=d.length)return!1;for(var g=0;g<c.length;g++)if(!m.equals(c[g],d[g]))return!1;return!0},contains:function(d){for(var g=this.elements,k=0;k<g.length;k++)if(g[k].nodeName()in d)return g[k];return c},toString:function(){var d=this.elements,
c,g=[];for(c=0;c<d.length;c++)g.push(d[c].nodeName());return g.toString()}};return u.ElementPath=o},{requires:["./base","./dom"]});
KISSY.add("editor/plugin/enterKey/index",function(g){function o(n){var q;q=n.getSelection().getRanges();for(var o=q.length-1;0<o;o--)q[o].deleteContents();q=q[0];o=q.document;if(q.checkStartOfBlock()&&q.checkEndOfBlock()){var a=(new v(q.startContainer)).block;if(a&&("li"==a.nodeName()||"li"==a.parent().nodeName()))return n.hasCommand("outdent")?(n.execCommand("save"),n.execCommand("outdent"),n.execCommand("save"),!0):!1}var b=q.splitBlock("p");if(!b)return!0;var n=b.previousBlock,a=b.nextBlock,e=
b.wasStartOfBlock,i=b.wasEndOfBlock,h;if(a)h=a.parent(),"li"==h.nodeName()&&(a._4e_breakParent(h),a._4e_move(a.next(),!0));else if(n&&(h=n.parent())&&"li"==h.nodeName())n._4e_breakParent(h),q.moveToElementEditablePosition(n.next()),n._4e_move(n.prev());if(!e&&!i){if("li"==a.nodeName()&&(h=a.first(p.invisible(!0)))&&g.inArray(h.nodeName(),["ul","ol"]))(r.ie?new k(o.createTextNode("\u00a0")):new k(o.createElement("br"))).insertBefore(h);a&&q.moveToElementEditablePosition(a)}else{var f;if(n){if("li"==n.nodeName()||
!c.test(n.nodeName()))f=n.clone()}else a&&(f=a.clone());f||(f=new k("<p>",null,o));if(h=b.elementPath)for(var b=0,j=h.elements.length;b<j;b++){var s=h.elements[b];if(s.equals(h.block)||s.equals(h.blockLimit))break;d.$removeEmpty[s.nodeName()]&&(s=s.clone(),f._4e_moveChildren(s),f.append(s))}r.ie||f._4e_appendBogus();q.insertNode(f);if(r.ie&&e&&(!i||!n[0].childNodes.length))q.moveToElementEditablePosition(i?n:f),q.select();q.moveToElementEditablePosition(e&&!i?a:f)}r.ie||(a?(f=new k(o.createElement("span")),
f.html("&nbsp;"),q.insertNode(f),f.scrollIntoView(void 0,!1),q.deleteContents()):f.scrollIntoView(void 0,!1));q.select();return!0}function u(d){var c=d.get("document")[0];t.on(c,"keydown",function(c){if(13===c.keyCode&&!c.shiftKey&&!c.ctrlKey&&!c.metaKey){d.execCommand("save");var a=d.execCommand("enterBlock");d.execCommand("save");!1!==a&&c.preventDefault()}})}var m=g.Editor,r=g.UA,c=/^h[1-6]$/,d=m.XHTML_DTD,k=g.Node,t=g.Event,p=m.Walker,v=m.ElementPath;return{init:function(d){d.addCommand("enterBlock",
{exec:o});d.docReady(function(){u(d)})}}},{requires:["editor"]});
KISSY.add("editor/core/focusManager",function(g){function o(){var d=this;d.__iframeFocus=p;t=d;k&&clearTimeout(k);k=setTimeout(function(){d.fire("focus")},100)}function u(){var d=this;d.__iframeFocus=v;t=n;k&&clearTimeout(k);k=setTimeout(function(){d.fire("blur")},100)}var m=g.Editor,r=g.DOM,c=g.Event,d={},k,t,g={refreshAll:function(){for(var c in d)if(d.hasOwnProperty(c)){var g=d[c].get("document")[0];g.designMode="off";g.designMode="on"}},currentInstance:function(){return t},getInstance:function(c){return d[c]},
add:function(d){var g=r._getWin(d.get("document")[0]);c.on(g,"focus",o,d);c.on(g,"blur",u,d)},register:function(c){d[c._UUID]=c},remove:function(g){delete d[g._UUID];var k=r._getWin(g.get("document")[0]);c.remove(k,"focus",o,g);c.remove(k,"blur",u,g)}},p=!0,v=!1,n=null;g.refreshAll=g.refreshAll;m.focusManager=g;m.getInstances=function(){return d};return g},{requires:["./base","./dom"]});
KISSY.add("editor/plugin/htmlDataProcessor/index",function(g){return{init:function(o){function u(e){return e.replace(w,function(e,b,f){return"<"+b+f.replace(a,function(a,e){return-1==f.indexOf("_ke_saved_"+e)?" _ke_saved_"+a+" "+a:a})+">"})}function m(a){return a.replace(/<\!--(?!{ke_protected})[\s\S]+?--\>/g,function(a){return"<\!--"+b+"{C}"+encodeURIComponent(a).replace(/--/g,"%2D%2D")+"--\>"})}function r(a){return a.replace(/<\!--\{ke_protected\}\{C\}([\s\S]+?)--\>/g,function(a,e){return decodeURIComponent(e)})}
var c=c,d=g.Editor,k=g.Node,t=g.UA,p=g.require("htmlparser"),v=new p.Filter,n=new p.Filter,q=new p.Filter;(function(){var a=function(a,e){return function(b,h){var d=[];(""+b).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(b,c,x){c=c.toLowerCase();"font-family"==c&&(x=x.replace(/["']/g,""));for(var y,F,g,i=0;i<a.length;i++)if(a[i]&&(b=a[i][0],y=a[i][1],F=a[i][2],g=a[i][3],c.match(b)&&(!y||x.match(y)))){c=g||c;e&&(F=F||x);"function"==typeof F&&(F=F(x,h,c));F&&F.push&&
(c=F[0],F=F[1]);"string"==typeof F&&d.push([c,F]);return}!e&&d.push([c,x])});for(var c=0;c<d.length;c++)d[c]=d[c].join(":");return d.length?d.join(";")+";":!1}}([[/mso/i],[/w:WordDocument/i],[/^-ms/i],[/^-moz/i],[/^-webkit/i]],c),d={tagNames:[[/^script$/i,""],[/^iframe$/i,""],[/^style$/i,""],[/^link$/i,""],[/^meta$/i,""],[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],root:function(a){a.filterChildren()},tags:{p:function(a){a.filterChildren()},$:function(a){var e=a.nodeName||"";if(-1!=e.indexOf(":")&&
!/^ke/.test(e))if("v:imagedata"==e){if(e=a.getAttribute("o:href"))a.setAttribute("src",e),a.removeAttribute("o:href");if(e=a.getAttribute("o:title"))a.setAttribute("title",e),a.removeAttribute("o:title");a.setTagName("img")}else a.setTagName("")}},attributes:{"class":function(a){return!a||/(^|\s+)Mso/.test(a)?!1:a},style:function(f){f=a(f);return!f?!1:f}},attributeNames:[[/^on/,"ke_on"],[/^lang$/,""]]},h={tagNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],tags:{$:function(a){if(a.attributes.length)for(var e=
["name","href","src"],b,h=0;h<e.length;h++)b="_ke_saved_"+e[h],a.getAttribute(b)&&a.removeAttribute(e[h]);return a},embed:function(a){var e=a.parentNode;if(e&&"object"==e.nodeName){var b=e.getAttribute("width"),e=e.getAttribute("height");b&&a.setAttribute("width",b);e&&a.setAttribute("width",e)}},a:function(a){if(!a.childNodes.length&&!a.attributes.length)return!1},span:function(a){if(!a.childNodes.length&&!a.attributes.length)return!1}},attributes:{style:function(a){if(!g.trim(a))return!1}},attributeNames:[[/^_ke_saved_/,
""],[/^ke_on/,"on"],[/^_ke.*/,""],[/^_ks.*/,""],[/^ke:.*$/,""]],comment:function(a){return a.substr(0,b.length)==b?(a="{C}"==a.substr(b.length,3)?a.substr(b.length+3):a.substr(b.length),new p.CData(decodeURIComponent(a))):a}};t.ie&&(h.attributes.style=function(a){return a.replace(/(^|;)([^:]+)/g,function(a){return a.toLowerCase()})});v.addRules(h);n.addRules(d);q.addRules(d)})();(function(){function a(e){for(var e=e.childNodes,x=e.length,y=e[x-1];y&&3==y.nodeType&&!g.trim(y.nodeValue);)y=e[--x];return y}
function b(f,x){var y=a(f);y&&((x||!t.ie)&&1==y.nodeType&&"br"==y.nodeName?f.removeChild(y):3==y.nodeType&&c.test(y.nodeValue)&&f.removeChild(y))}function h(f){var x=a(f);return!x||1==x.nodeType&&"br"==x.nodeName||"form"==f.nodeName&&"input"==x.nodeName}function f(a){b(a,!0);h(a)&&(t.ie?a.appendChild(new p.Text("\u00a0")):(a.appendChild(new p.Text("&nbsp;")),a.appendChild(new p.Tag("br"))))}function j(a){b(a,!1);h(a)&&a.appendChild(new p.Text("\u00a0"))}var c=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,k=d.XHTML_DTD,z=g.merge(k.$block,
k.$listItem,k.$tableContent),o;for(o in z)z.hasOwnProperty(o)&&("br"in k[o]||delete z[o]);delete z.td;delete z.pre;var k={tags:{}},l={tags:{}};for(o in z)z.hasOwnProperty(o)&&(k.tags[o]=f,l.tags[o]=j);n.addRules(k);v.addRules(l);q.addRules(k)})();(function(){v.addRules({text:function(a){return a.replace(/\xa0/g,"&nbsp;")}})})();var w=/<(a|area|img|input)\b([^>]*)>/gi,a=/\b(href|src|name)\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|(?:[^ "'>]+))/gi,b="{ke_protected}";o.htmlDataProcessor={wordFilter:q,dataFilter:n,
htmlFilter:v,toHtml:function(a){var b=new p.BeautifyWriter;(new p.Parser(a)).parse().writeHtml(b,v);return b.getHtml()},toDataFormat:function(a,b,h){h=h||n;t.gecko&&(a=a.replace(/(<\!--\[if[^<]*?\])--\>([\S\s]*?)<\!--(\[endif\]--\>)/gi,"$1$2$3"));a=u(a);b=new k("<div>");b.html("a"+a);a=b.html().substr(1);a=r(a);b=new p.BeautifyWriter;(new p.Parser(a)).parse().writeHtml(b,h);a=b.getHtml();return a=m(a)},toServer:function(a){var b=new p.MinifyWriter;(new p.Parser(a)).parse().writeHtml(b,v);return b.getHtml()}}}}},
{requires:["editor"]});
KISSY.add("editor/core/meta",function(){var g={backColor:["../color/btn","./cmd"],localStorage:["../flashBridge/"],bold:["../font/ui","./cmd"],draft:["../localStorage/","../menubutton/"],flash:["../flashCommon/baseClass","../flashCommon/utils"],fontFamily:["../font/ui","./cmd"],fontSize:["../font/ui","./cmd"],foreColor:["../color/btn","./cmd"],heading:["./cmd"],image:["../button/","../bubble/","../contextmenu/","../dialogLoader/"],indent:["./cmd"],orderedList:["../listUtils/btn","./cmd"],unorderedList:["../listUtils/btn",
"./cmd"],italic:["../font/ui","./cmd"],justifyCenter:["./cmd"],justifyLeft:["./cmd"],justifyRight:["./cmd"],link:["../bubble/","./utils","../dialogLoader/"],maximize:["./cmd"],multipleUpload:["../dialogLoader/"],outdent:["./cmd"],overlay:["dd","../focusFix/"],pageBreak:["../fakeObjects/"],removeFormat:["./cmd","../button/"],resize:["dd"],menubutton:["menubutton"],smiley:["../overlay/"],sourceArea:["../button/"],strikeThrough:["../font/ui","./cmd"],table:["../dialogLoader/","../contextmenu/"],underline:["../font/ui",
"./cmd"],undo:["./btn","./cmd"],contextmenu:["menu","../focusFix/"],video:["../flashCommon/utils","../flashCommon/baseClass"],xiamiMusic:["../flashCommon/baseClass","../flashCommon/utils"]},o,u,m={"backColor/cmd":["../color/cmd"],"bold/cmd":["../font/cmd"],"color/btn":["../button/","../overlay/","../dialogLoader/"],"color/colorPicker/dialog":["../../overlay/"],"dentUtils/cmd":["../listUtils/"],"flash/dialog":["../flashCommon/utils","../overlay/","../menubutton/"],"flashCommon/baseClass":["../contextmenu/",
"../bubble/","../dialogLoader/","./utils"],"font/ui":["../button/","../menubutton/"],"fontFamily/cmd":["../font/cmd"],"fontSize/cmd":["../font/cmd"],"foreColor/cmd":["../color/cmd"],"image/dialog":["../overlay/","switchable","../menubutton/"],"indent/cmd":["../dentUtils/cmd"],"orderedList/cmd":["../listUtils/cmd"],"unorderedList/cmd":["../listUtils/cmd"],"italic/cmd":["../font/cmd"],"justifyCenter/cmd":["../justifyUtils/cmd"],"justifyLeft/cmd":["../justifyUtils/cmd"],"justifyRight/cmd":["../justifyUtils/cmd"],
"link/dialog":["../overlay/","./utils"],"listUtils/btn":["../button/"],"listUtils/cmd":["../listUtils/"],"multipleUpload/dialog":["../progressbar/","../overlay/","../flashBridge/","../localStorage/"],"outdent/cmd":["../dentUtils/cmd"],"strikeThrough/cmd":["../font/cmd"],"table/dialog":["../overlay/","../menubutton/"],"underline/cmd":["../font/cmd"],"undo/btn":["../button/"],"video/dialog":["../flash/dialog","../menubutton/"],"xiamiMusic/dialog":["../flash/dialog","../menubutton/"]},r={};for(o in g)u=
"editor/plugin/"+o+"/index",r[u]={requires:g[o]};for(o in m)u="editor/plugin/"+o,r[u]={requires:m[o]};KISSY.add(r)});
KISSY.add("editor/core/range",function(g,o,u,m,r){function c(a){var b=a.nodeType!=e.TEXT_NODE&&e.nodeName(a)in h.$removeEmpty,f=a.nodeType==e.TEXT_NODE&&!g.trim(a.nodeValue),a=!!a.parentNode.getAttribute("_ke_bookmark");return b||f||a}function d(a){return!A(a)&&!z(a)}function k(a){var b=q;return function(f){if(z(f))return n;if(f.nodeType==e.TEXT_NODE){if(g.trim(f.nodeValue).length)return q}else if(f.nodeType==e.ELEMENT_NODE&&(f=e.nodeName(f),!C[f]))if(!a&&!i.ie&&"br"==f&&!b)b=n;else return q;return n}}
function t(a,b){var h=a.startContainer,d=a.endContainer,j=a.startOffset,c=a.endOffset,l,g=q,i=q,s=void 0,k=a.document,C;0<b&&(s=k.createDocumentFragment());if(a.collapsed)return s;a.optimizeBookmark();d[0].nodeType==e.TEXT_NODE?(i=n,d=d._4e_splitText(c)):0<d[0].childNodes.length&&(c>=d[0].childNodes.length?(d=new f(d[0].appendChild(k.createTextNode(""))),C=n):d=new f(d[0].childNodes[c]));h[0].nodeType==e.TEXT_NODE?(g=n,h._4e_splitText(j)):j?j>=h[0].childNodes.length?(h=new f(h[0].appendChild(k.createTextNode(""))),
l=n):h=new f(h[0].childNodes[j].previousSibling):(l=new f(k.createTextNode("")),h.prepend(l),h=l,l=n);var A=h._4e_parents(),H=d._4e_parents();A.each(function(a,x){A[x]=a});H.each(function(a,x){H[x]=a});for(var E,J,k=0;k<A.length&&!(E=A[k],J=H[k],!E.equals(J));k++);for(var j=s,D,z,o=k;o<A.length;o++){D=A[o];c=0<b&&!D.equals(h)?j.appendChild(D.clone()[0]):null;D=D[0].nextSibling;z=H[o];for(var t=d[0],m=z&&z[0];D&&!(m==D||t==D);)z=D.nextSibling,2==b?j.appendChild(D.cloneNode(n)):(e._4e_remove(D),1==
b&&j.appendChild(D)),D=z;c&&(j=c)}for(j=s;k<H.length;k++){D=H[k];c=0<b&&!D.equals(d)?j.appendChild(D.clone()[0]):null;if(!A[k]||!D._4e_sameLevel(A[k]))for(D=D[0].previousSibling;D;)z=D.previousSibling,2==b?j.insertBefore(D.cloneNode(n),j.firstChild):(e._4e_remove(D),1==b&&j.insertBefore(D,j.firstChild)),D=z;c&&(j=c)}if(2==b){if(g&&(E=h[0],E.nodeType==e.TEXT_NODE&&E.nextSibling&&E.nextSibling.nodeType==e.TEXT_NODE&&(E.data+=E.nextSibling.data,E.parentNode.removeChild(E.nextSibling))),i)i=d[0],i.nodeType==
e.TEXT_NODE&&i.previousSibling&&i.previousSibling.nodeType==e.TEXT_NODE&&(i.previousSibling.data+=i.data,i.parentNode.removeChild(i))}else{if(E&&J&&(!h._4e_sameLevel(E)||!d._4e_sameLevel(J)))i=E._4e_index(),l&&E._4e_sameLevel(h)&&i--,a.setStart(E.parent(),i+1);a.collapse(n)}l&&h.remove();C&&d.remove();return s}function p(a){a.collapsed=a.startContainer&&a.endContainer&&a.startContainer[0]==a.endContainer[0]&&a.startOffset==a.endOffset}function v(a){this.endOffset=this.endContainer=this.startOffset=
this.startContainer=w;this.collapsed=n;this.document=a}o.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var n=!0,q=!1,w=null,a=o.RANGE,b=o.POSITION,e=g.DOM,i=g.UA,h=o.XHTML_DTD,f=g.Node,j=f.all,s={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},A=new m.whitespaces,z=new m.bookmark,B=m.whitespaces(n),l=m.bookmark(!1,
!0),C={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};g.augment(v,{toString:function(){var a=[],b=this.startContainer[0],f=this.endContainer[0];a.push((b.id||b.nodeName)+":"+this.startOffset);a.push((f.id||f.nodeName)+":"+this.endOffset);return a.join("<br/>")},optimize:function(){var a=this.startContainer,b=this.startOffset;a[0].nodeType!=e.ELEMENT_NODE&&(b?b>=a[0].nodeValue.length&&
this.setStartAfter(a):this.setStartBefore(a));a=this.endContainer;b=this.endOffset;a[0].nodeType!=e.ELEMENT_NODE&&(b?b>=a[0].nodeValue.length&&this.setEndAfter(a):this.setEndBefore(a))},setStartAfter:function(a){this.setStart(a.parent(),a._4e_index()+1)},setStartBefore:function(a){this.setStart(a.parent(),a._4e_index())},setEndAfter:function(a){this.setEnd(a.parent(),a._4e_index()+1)},setEndBefore:function(a){this.setEnd(a.parent(),a._4e_index())},optimizeBookmark:function(){var a=this.startContainer,
b=this.endContainer;a&&"span"==a.nodeName()&&a.attr("_ke_bookmark")&&this.setStartBefore(a);b&&"span"==b.nodeName()&&b.attr("_ke_bookmark")&&this.setEndAfter(b)},setStart:function(a,b){a[0].nodeType==e.ELEMENT_NODE&&s[a.nodeName()]&&(a=a.parent(),b=a._4e_index());this.startContainer=a;this.startOffset=b;this.endContainer||(this.endContainer=a,this.endOffset=b);p(this)},setEnd:function(a,b){a[0].nodeType==e.ELEMENT_NODE&&s[a.nodeName()]&&(a=a.parent(),b=a._4e_index()+1);this.endContainer=a;this.endOffset=
b;this.startContainer||(this.startContainer=a,this.startOffset=b);p(this)},setStartAt:function(b,f){switch(f){case a.POSITION_AFTER_START:this.setStart(b,0);break;case a.POSITION_BEFORE_END:b[0].nodeType==e.TEXT_NODE?this.setStart(b,b[0].nodeValue.length):this.setStart(b,b[0].childNodes.length);break;case a.POSITION_BEFORE_START:this.setStartBefore(b);break;case a.POSITION_AFTER_END:this.setStartAfter(b)}p(this)},setEndAt:function(b,f){switch(f){case a.POSITION_AFTER_START:this.setEnd(b,0);break;
case a.POSITION_BEFORE_END:b[0].nodeType==e.TEXT_NODE?this.setEnd(b,b[0].nodeValue.length):this.setEnd(b,b[0].childNodes.length);break;case a.POSITION_BEFORE_START:this.setEndBefore(b);break;case a.POSITION_AFTER_END:this.setEndAfter(b)}p(this)},cloneContents:function(){return t(this,2)},deleteContents:function(){return t(this,0)},extractContents:function(){return t(this,1)},collapse:function(a){a?(this.endContainer=this.startContainer,this.endOffset=this.startOffset):(this.startContainer=this.endContainer,
this.startOffset=this.endOffset);this.collapsed=n},clone:function(){var a=new v(this.document);a.startContainer=this.startContainer;a.startOffset=this.startOffset;a.endContainer=this.endContainer;a.endOffset=this.endOffset;a.collapsed=this.collapsed;return a},getEnclosedNode:function(){var a=this.clone();a.optimize();if(a.startContainer[0].nodeType!=e.ELEMENT_NODE||a.endContainer[0].nodeType!=e.ELEMENT_NODE)return w;var b=new m(a);b.evaluator=function(a){return B(a)&&l(a)};a=b.next();b.reset();b=
b.previous();return a&&a.equals(b)?a:w},shrink:function(b,f){if(!this.collapsed){var b=b||a.SHRINK_TEXT,h=this.clone(),d=this.startContainer,j=this.endContainer,c=this.startOffset,l=this.endOffset,g=n,i,k,s=n;d&&d[0].nodeType==e.TEXT_NODE&&(c?c>=d[0].nodeValue.length?h.setStartAfter(d):(h.setStartBefore(d),g=q):h.setStartBefore(d));j&&j[0].nodeType==e.TEXT_NODE&&(l?l>=j[0].nodeValue.length?h.setEndAfter(j):(h.setEndAfter(j),s=q):h.setEndBefore(j));if(g||s)k=new m(h),k.evaluator=function(f){return f.nodeType==
(b==a.SHRINK_ELEMENT?e.ELEMENT_NODE:e.TEXT_NODE)},k.guard=function(f,h){if(b==a.SHRINK_ELEMENT&&f.nodeType==e.TEXT_NODE||h&&f==i)return q;!h&&f.nodeType==e.ELEMENT_NODE&&(i=f);return n};g&&(h=k[b==a.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(h,f?a.POSITION_AFTER_START:a.POSITION_BEFORE_START);s&&(k.reset(),(k=k[b==a.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(k,f?a.POSITION_BEFORE_END:a.POSITION_AFTER_END));return g||s}},createBookmark2:function(a){var b=this.startContainer,
h=this.endContainer,d=this.startOffset,j=this.endOffset,c,l;if(!b||!h)return{start:0,end:0};if(a){if(b[0].nodeType==e.ELEMENT_NODE&&(c=new f(b[0].childNodes[d]))&&c[0]&&c[0].nodeType==e.TEXT_NODE&&0<d&&c[0].previousSibling.nodeType==e.TEXT_NODE)b=c,d=0;for(;b[0].nodeType==e.TEXT_NODE&&(l=b.prev(void 0,1))&&l[0].nodeType==e.TEXT_NODE;)b=l,d+=l[0].nodeValue.length;if(!this.collapsed){if(h[0].nodeType==e.ELEMENT_NODE&&(c=new f(h[0].childNodes[j]))&&c[0]&&c[0].nodeType==e.TEXT_NODE&&0<j&&c[0].previousSibling.nodeType==
e.TEXT_NODE)h=c,j=0;for(;h[0].nodeType==e.TEXT_NODE&&(l=h.prev(void 0,1))&&l[0].nodeType==e.TEXT_NODE;)h=l,j+=l[0].nodeValue.length}}return{start:b._4e_address(a),end:this.collapsed?w:h._4e_address(a),startOffset:d,endOffset:j,normalized:a,is2:n}},createBookmark:function(b){var h,e,d,j,c=this.collapsed;h=new f("<span>",w,this.document);h.attr("_ke_bookmark",1);h.css("display","none");h.html("&nbsp;");b&&(d=g.guid("ke_bm_"),h.attr("id",d+"S"));c||(e=h.clone(),e.html("&nbsp;"),b&&e.attr("id",d+"E"),
j=this.clone(),j.collapse(),j.insertNode(e));j=this.clone();j.collapse(n);j.insertNode(h);e?(this.setStartAfter(h),this.setEndBefore(e)):this.moveToPosition(h,a.POSITION_AFTER_END);return{startNode:b?d+"S":h,endNode:b?d+"E":e,serializable:b,collapsed:c}},moveToPosition:function(a,b){this.setStartAt(a,b);this.collapse(n)},trim:function(a,b){var f=this.startContainer,h=this.startOffset,d=this.collapsed;if((!a||d)&&f[0]&&f[0].nodeType==e.TEXT_NODE){if(h)if(h>=f[0].nodeValue.length)h=f._4e_index()+1,
f=f.parent();else{var j=f._4e_splitText(h),h=f._4e_index()+1,f=f.parent();e.equals(this.startContainer,this.endContainer)?this.setEnd(j,this.endOffset-this.startOffset):e.equals(f,this.endContainer)&&(this.endOffset+=1)}else h=f._4e_index(),f=f.parent();this.setStart(f,h);if(d){this.collapse(n);return}}f=this.endContainer;h=this.endOffset;!b&&!d&&f[0]&&f[0].nodeType==e.TEXT_NODE&&(h?(h>=f[0].nodeValue.length||f._4e_splitText(h),h=f._4e_index()+1):h=f._4e_index(),f=f.parent(),this.setEnd(f,h))},insertNode:function(a){this.optimizeBookmark();
this.trim(q,n);var b=this.startContainer;b[0].insertBefore(a[0],b[0].childNodes[this.startOffset]||null);b[0]==this.endContainer[0]&&this.endOffset++;this.setStartBefore(a)},moveToBookmark:function(a){var b=j(this.document);if(a.is2){var f=b._4e_getByAddress(a.start,a.normalized),h=a.startOffset,b=a.end&&b._4e_getByAddress(a.end,a.normalized),a=a.endOffset;this.setStart(f,h);b?this.setEnd(b,a):this.collapse(n)}else f=(h=a.serializable)?g.one("#"+a.startNode,b):a.startNode,a=h?g.one("#"+a.endNode,
b):a.endNode,this.setStartBefore(f),f._4e_remove(),a&&a[0]?(this.setEndBefore(a),a._4e_remove()):this.collapse(n)},getCommonAncestor:function(a,b){var h=this.startContainer,d=this.endContainer,h=h[0]==d[0]?a&&h[0].nodeType==e.ELEMENT_NODE&&this.startOffset==this.endOffset-1?new f(h[0].childNodes[this.startOffset]):h:h._4e_commonAncestor(d);return b&&h[0].nodeType==e.TEXT_NODE?h.parent():h},enlarge:function(){function b(a,f,h,d){var c=a[f?"startContainer":"endContainer"],l,x=f?0:1,g=0,i=f?"previousSibling":
"nextSibling";l=a[f?"startOffset":"endOffset"];if(c[0].nodeType==e.TEXT_NODE){if(f){if(l)return}else if(l<c[0].nodeValue.length)return;l=c[0][i];c=c[0].parentNode}else l=c[0].childNodes[l+(f?-1:1)]||null,c=c[0];for(;c;){for(;l;)if(A(l)||z(l))l=l[i];else break;if(l){if(!g)a[f?"setStartAfter":"setEndBefore"](j(l));break}c=j(c);if("body"==c.nodeName())break;if(g||c.equals(d))h[x]=c,g=1;else a[f?"setStartBefore":"setEndAfter"](c);l=c[0][i];c=c[0].parentNode}}return function(h){switch(h){case a.ENLARGE_ELEMENT:if(this.collapsed)break;
var h=this.getCommonAncestor(),d=[];b(this,1,d,h);b(this,0,d,h);d[0]&&d[1]&&(h=d[0].contains(d[1])?d[1]:d[0],this.setStartBefore(h),this.setEndAfter(h));break;case a.ENLARGE_BLOCK_CONTENTS:case a.ENLARGE_LIST_ITEM_CONTENTS:var c=new v(this.document),d=new f(this.document.body);c.setStartAt(d,a.POSITION_AFTER_START);c.setEnd(this.startContainer,this.startOffset);var c=new m(c),l,g,i=m.blockBoundary(h==a.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:w),k=function(a){var b=i(a);b||(l=j(a));return b},s=function(a){var b=
k(a);!b&&"br"==e.nodeName(a)&&(g=j(a));return b};c.guard=k;c=c.lastBackward();l=l||d;this.setStartAt(l,"br"!=l.nodeName()&&(!c&&this.checkStartOfBlock()||c&&l.contains(c))?a.POSITION_AFTER_START:a.POSITION_AFTER_END);c=this.clone();c.collapse();c.setEndAt(d,a.POSITION_BEFORE_END);c=new m(c);c.guard=h==a.ENLARGE_LIST_ITEM_CONTENTS?s:k;l=w;c=c.lastForward();l=l||d;this.setEndAt(l,!c&&this.checkEndOfBlock()||c&&l.contains(c)?a.POSITION_BEFORE_END:a.POSITION_BEFORE_START);g&&this.setEndAfter(g)}}}(),
checkStartOfBlock:function(){var b=this.startContainer,f=this.startOffset;if(f&&b[0].nodeType==e.TEXT_NODE&&g.trim(b[0].nodeValue.substring(0,f)).length)return q;this.trim();b=new r(this.startContainer);f=this.clone();f.collapse(n);f.setStartAt(b.block||b.blockLimit,a.POSITION_AFTER_START);b=new m(f);b.evaluator=k(n);return b.checkBackward()},checkEndOfBlock:function(){var b=this.endContainer,f=this.endOffset;if(b[0].nodeType==e.TEXT_NODE&&g.trim(b[0].nodeValue.substring(f)).length)return q;this.trim();
b=new r(this.endContainer);f=this.clone();f.collapse(q);f.setEndAt(b.block||b.blockLimit,a.POSITION_BEFORE_END);b=new m(f);b.evaluator=k(q);return b.checkForward()},checkBoundaryOfElement:function(b,f){var h=this.clone();h[f==a.START?"setStartAt":"setEndAt"](b,f==a.START?a.POSITION_AFTER_START:a.POSITION_BEFORE_END);h=new m(h);h.evaluator=c;return h[f==a.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var a=this.startContainer,f=this.endContainer,h=this.startOffset,d=this.endOffset,
c;if(a[0].nodeType==e.ELEMENT_NODE)if(c=a[0].childNodes.length,c>h)a=j(a[0].childNodes[h]);else if(0==c)a=a._4e_previousSourceNode();else{for(a=a[0];a.lastChild;)a=a.lastChild;a=j(a);a=a._4e_nextSourceNode()||a}if(f[0].nodeType==e.ELEMENT_NODE)if(c=f[0].childNodes.length,c>d)f=j(f[0].childNodes[d])._4e_previousSourceNode(n);else if(0==c)f=f._4e_previousSourceNode();else{for(f=f[0];f.lastChild;)f=f.lastChild;f=j(f)}a._4e_position(f)&b.POSITION_FOLLOWING&&(a=f);return{startNode:a,endNode:f}},fixBlock:function(b,
f){var h=this.createBookmark(),e=j(this.document.createElement(f));this.collapse(b);this.enlarge(a.ENLARGE_BLOCK_CONTENTS);e[0].appendChild(this.extractContents());e._4e_trim();i.ie||e._4e_appendBogus();this.insertNode(e);this.moveToBookmark(h);return e},splitBlock:function(b){var f=new r(this.startContainer),h=new r(this.endContainer),e=f.block,c=h.block,d=w;if(!f.blockLimit.equals(h.blockLimit))return w;"br"!=b&&(e||(e=this.fixBlock(n,b),c=(new r(this.endContainer)).block),c||(c=this.fixBlock(q,
b)));b=e&&this.checkStartOfBlock();f=c&&this.checkEndOfBlock();this.deleteContents();e&&e[0]==c[0]&&(f?(d=new r(this.startContainer),this.moveToPosition(c,a.POSITION_AFTER_END),c=w):b?(d=new r(this.startContainer),this.moveToPosition(e,a.POSITION_BEFORE_START),e=w):(c=this.splitElement(e),!i.ie&&!g.inArray(e.nodeName(),["ul","ol"])&&e._4e_appendBogus()));return{previousBlock:e,nextBlock:c,wasStartOfBlock:b,wasEndOfBlock:f,elementPath:d}},splitElement:function(b){if(!this.collapsed)return w;this.setEndAt(b,
a.POSITION_BEFORE_END);var f=this.extractContents(),h=b.clone(q);h[0].appendChild(f);h.insertAfter(b);this.moveToPosition(b,a.POSITION_AFTER_END);return h},moveToElementEditablePosition:function(b,f){for(var h=0;b;){if(b[0].nodeType==e.TEXT_NODE){this.moveToPosition(b,f?a.POSITION_AFTER_END:a.POSITION_BEFORE_START);h=1;break}b[0].nodeType==e.ELEMENT_NODE&&b._4e_isEditable()&&(this.moveToPosition(b,f?a.POSITION_BEFORE_END:a.POSITION_AFTER_START),h=1);var c=b,j=h,l=void 0;c[0].nodeType==e.ELEMENT_NODE&&
c._4e_isEditable()&&(l=c[f?"last":"first"](d,1));!j&&!l&&(l=c[f?"prev":"next"](d,1));b=l}return!!h},selectNodeContents:function(a){var b=a[0];this.setStart(a,0);this.setEnd(a,b.nodeType==e.TEXT_NODE?b.nodeValue.length:b.childNodes.length)},insertNodeByDtd:function(a){var b,f,e,c=a.nodeName();b=h.$block[c];this.deleteContents();if(b){for(b=this.getCommonAncestor(q,n);(f=h[b.nodeName()])&&(!f||!f[c]);){var d=b.parent();this.checkStartOfBlock()&&this.checkEndOfBlock()?(this.setStartBefore(b),this.collapse(n),
b.remove()):e=b;b=d}e&&this.splitElement(e)}this.insertNode(a)}});u.injectDom({_4e_breakParent:function(a,b){var b=j(b),a=j(a),f,h=new o.Range(a[0].ownerDocument);h.setStartAfter(a);h.setEndAfter(b);f=h.extractContents();h.insertNode(a.remove());a.after(f)}});o.Range=v},{requires:["./base","./utils","./walker","./elementPath","./dom"]});
KISSY.add("editor/core/selection",function(g){function o(a){this.document=a;this._={cache:{}};if(n){var b=this.getNative().createRange();if(!b||b.item&&b.item(0).ownerDocument!=a||b.parentElement&&b.parentElement().ownerDocument!=a)this.isInvalid=r}}function u(a){a=new o(a);return!a||a.isInvalid?c:a}var m=g.Editor;m.SELECTION={SELECTION_NONE:1,SELECTION_TEXT:2,SELECTION_ELEMENT:3};var r=!0,c=null,d=g.UA,k=g.DOM,t=g.Node,p=m.SELECTION,v=m.RANGE,n=d.ie,q=m.Walker,w=m.Range,a={img:1,hr:1,li:1,table:1,
tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};g.augment(o,{getNative:!n?function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=k._getWin(this.document).getSelection())}:function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=this.document.selection)},getType:!n?function(){var b=this._.cache;if(b.type)return b.type;var f=p.SELECTION_TEXT,e=this.getNative();if(e){if(1==e.rangeCount){var e=e.getRangeAt(0),c=e.startContainer;
c==e.endContainer&&c.nodeType==k.ELEMENT_NODE&&1==Number(e.endOffset-e.startOffset)&&a[c.childNodes[e.startOffset].nodeName.toLowerCase()]&&(f=p.SELECTION_ELEMENT)}}else f=p.SELECTION_NONE;return b.type=f}:function(){var a=this._.cache;if(a.type)return a.type;var b=p.SELECTION_NONE;try{var e=this.getNative(),c=e.type;"Text"==c&&(b=p.SELECTION_TEXT);"Control"==c&&(b=p.SELECTION_ELEMENT);e.createRange().parentElement&&(b=p.SELECTION_TEXT)}catch(d){}return a.type=b},getRanges:n?function(){var a=function(a,
b){a=a.duplicate();a.collapse(b);for(var h=a.parentElement(),e=h.childNodes,d,g=0;g<e.length;g++){var l=e[g];if(l.nodeType==k.ELEMENT_NODE){d=a.duplicate();d.moveToElementText(l);var l=d.compareEndPoints("StartToStart",a),i=d.compareEndPoints("EndToStart",a);d.collapse();if(0<l)break;else{if(!l||1==i&&-1==l)return{container:h,offset:g};if(!i)return{container:h,offset:g+1}}d=c}}d||(d=a.duplicate(),d.moveToElementText(h),d.collapse(!1));d.setEndPoint("StartToStart",a);d=(""+d.text).replace(/\r\n|\r/g,
"\n").length;try{for(;0<d;)d-=e[--g].nodeValue.length}catch(x){d=0}return 0===d?{container:h,offset:g}:{container:e[g],offset:-d}};return function(b){var e=this._.cache;if(e.ranges&&!b)return e.ranges;var c=this.getNative(),b=c&&c.createRange(),d=this.getType();if(!c)return[];if(d==p.SELECTION_TEXT)return c=new w(this.document),d=a(b,r),c.setStart(new t(d.container),d.offset),d=a(b),c.setEnd(new t(d.container),d.offset),e.ranges=[c];if(d==p.SELECTION_ELEMENT){e=e.ranges=[];for(d=0;d<b.length;d++){for(var g=
b.item(d),i=g.parentNode,l=0,c=new w(this.document);l<i.childNodes.length&&i.childNodes[l]!=g;l++);c.setStart(new t(i),l);c.setEnd(new t(i),l+1);e.push(c)}return e}return e.ranges=[]}}():function(a){var b=this._.cache;if(b.ranges&&!a)return b.ranges;var a=[],e=this.getNative();if(!e)return[];for(var d=0;d<e.rangeCount;d++){var c=e.getRangeAt(d),g=new w(this.document);g.setStart(new t(c.startContainer),c.startOffset);g.setEnd(new t(c.endContainer),c.endOffset);a.push(g)}return b.ranges=a},getStartElement:function(){var a=
this._.cache;if(void 0!==a.startElement)return a.startElement;var b,e=this.getNative();switch(this.getType()){case p.SELECTION_ELEMENT:return this.getSelectedElement();case p.SELECTION_TEXT:var c=this.getRanges()[0];if(c&&!c.collapsed){for(c.optimize();r;)if(b=c.startContainer,c.startOffset==(b[0].nodeType===k.ELEMENT_NODE?b[0].childNodes.length:b[0].nodeValue.length)&&!b._4e_isBlockBoundary())c.setStartAfter(b);else break;b=c.startContainer;if(b[0].nodeType!=k.ELEMENT_NODE)return b.parent();b=new t(b[0].childNodes[c.startOffset]);
if(!b[0]||b[0].nodeType!=k.ELEMENT_NODE)return c.startContainer;for(c=b[0].firstChild;c&&c.nodeType==k.ELEMENT_NODE;)b=new t(c),c=c.firstChild;return b}if(n)c=e.createRange(),c.collapse(r),b=new t(c.parentElement());else{if((b=e.anchorNode)&&b.nodeType!=k.ELEMENT_NODE)b=b.parentNode;b&&(b=new t(b))}}return a.startElement=b},getSelectedElement:function(){var b,c=this._.cache;if(void 0!==c.selectedElement)return c.selectedElement;n&&(b=this.getNative().createRange(),b=b.item&&b.item(0));var e;if(b)e=
new t(b);else{b=this.getRanges()[0];for(var d,g=2;g&&(!(e=b.getEnclosedNode())||!(e[0].nodeType==k.ELEMENT_NODE&&a[e.nodeName()]&&(d=e)));g--)b.shrink(v.SHRINK_ELEMENT);e=d}return c.selectedElement=e},reset:function(){this._.cache={}},selectElement:function(a){var b,e=this.document;if(n)try{b=e.body.createControlRange(),b.addElement(a[0]),b.select()}catch(c){b=e.body.createTextRange(),b.moveToElementText(a[0]),b.select()}finally{}else b=e.createRange(),b.selectNode(a[0]),a=this.getNative(),a.removeAllRanges(),
a.addRange(b);this.reset()},selectRanges:function(a){if(n){if(1<a.length){var b=a[a.length-1];a[0].setEnd(b.endContainer,b.endOffset);a.length=1}a[0]&&a[0].select()}else{b=this.getNative();if(!b)return;b.removeAllRanges();for(var e=0;e<a.length;e++){var c=a[e],g=this.document.createRange(),i=c.startContainer;if(c.collapsed&&(d.gecko&&1.09>d.gecko||d.opera||d.webkit)&&i[0].nodeType==k.ELEMENT_NODE&&!i[0].childNodes.length)i[0].appendChild(this.document.createTextNode(d.webkit?"\u200b":"")),c.startOffset++,
c.endOffset++;g.setStart(i[0],c.startOffset);g.setEnd(c.endContainer[0],c.endOffset);b.addRange(g)}}this.reset()},createBookmarks2:function(a){for(var b=[],e=this.getRanges(),c=0;c<e.length;c++)b.push(e[c].createBookmark2(a));return b},createBookmarks:function(a,b){for(var e=[],c=this.document,d,b=b||this.getRanges(),i=b.length,o=0;o<i;o++){e.push(d=b[o].createBookmark(a,r));var l=(a=d.serializable)?g.one("#"+d.startNode,c):d.startNode;d=a?g.one("#"+d.endNode,c):d.endNode;for(var C=o+1;C<i;C++){var x=
b[C],y=x.startContainer,n=x.endContainer;k.equals(y,l.parent())&&x.startOffset++;k.equals(y,d.parent())&&x.startOffset++;k.equals(n,l.parent())&&x.endOffset++;k.equals(n,d.parent())&&x.endOffset++}}return e},selectBookmarks:function(a){for(var b=[],e=0;e<a.length;e++){var c=new w(this.document);c.moveToBookmark(a[e]);b.push(c)}this.selectRanges(b);return this},getCommonAncestor:function(){var a=this.getRanges();return a[0].startContainer._4e_commonAncestor(a[a.length-1].endContainer)},scrollIntoView:function(){var a=
this.getStartElement();a&&a.scrollIntoView(void 0,!1)},removeAllRanges:function(){var a=this.getNative();n?a&&a.clear():a&&a.removeAllRanges()}});var b={table:1,tbody:1,tr:1},e=q.whitespaces(r),i=/\ufeff|\u00a0/;w.prototype.select=w.prototype.select=!n?function(){var a=this.startContainer;this.collapsed&&a[0].nodeType==k.ELEMENT_NODE&&!a[0].childNodes.length&&a[0].appendChild(this.document.createTextNode(""));var b=this.document.createRange();b.setStart(a[0],this.startOffset);try{b.setEnd(this.endContainer[0],
this.endOffset)}catch(e){if(0<=e.toString().indexOf("NS_ERROR_ILLEGAL_VALUE"))this.collapse(r),b.setEnd(this.endContainer[0],this.endOffset);else throw e;}a=u(this.document).getNative();a.removeAllRanges();a.addRange(b)}:function(a){var c=this.collapsed,d,g;if(this.startContainer[0]===this.endContainer[0]&&1==this.endOffset-this.startOffset){var n=this.startContainer[0].childNodes[this.startOffset];if(n.nodeType==k.ELEMENT_NODE){(new o(this.document)).selectElement(new t(n));return}}(this.startContainer[0].nodeType==
k.ELEMENT_NODE&&this.startContainer.nodeName()in b||this.endContainer[0].nodeType==k.ELEMENT_NODE&&this.endContainer.nodeName()in b)&&this.shrink(v.SHRINK_ELEMENT,r);var m=this.createBookmark(),n=m.startNode,p;c||(p=m.endNode);m=this.document.body.createTextRange();m.moveToElementText(n[0]);m.moveStart("character",1);if(p)a=this.document.body.createTextRange(),a.moveToElementText(p[0]),m.setEndPoint("EndToEnd",a),m.moveEnd("character",-1);else{for(d=n[0].nextSibling;d&&!e(d);)d=d.nextSibling;d=!(d&&
d.nodeValue&&d.nodeValue.match(i))&&(a||!n[0].previousSibling||n[0].previousSibling&&"br"==k.nodeName(n[0].previousSibling));g=new t(this.document.createElement("span"));g.html("&#65279;");g.insertBefore(n);d&&k.insertBefore(this.document.createTextNode("\ufeff"),n[0]||n)}this.setStartBefore(n);n._4e_remove();if(c){if(d?(m.moveStart("character",-1),m.select(),this.document.selection.clear()):m.select(),g)this.moveToPosition(g,v.POSITION_BEFORE_START),g._4e_remove()}else this.setEndBefore(p),p._4e_remove(),
m.select()};o.getSelection=u;return m.Selection=o},{requires:["./base","./walker","./range","./dom"]});
KISSY.add("editor/plugin/selection/index",function(g,o){function u(a){function b(a,b){var c=g.body.createTextRange();try{c.moveToPoint(a,b)}catch(e){c=t}return c}function e(){var a=g.selection.createRange();k&&!a.item&&0===a.compareEndPoints("StartToEnd",a)&&k.select();v.remove(g,"mouseup",e);v.remove(g,"mousemove",c);k=d=0}function c(a){if(a.button){if(a=b(a.pageX,a.pageY))0<a.compareEndPoints("StartToStart",k)?a.setEndPoint("StartToStart",k):a.setEndPoint("EndToEnd",k),a.select()}else e()}var d,
f=a.get("window")[0],g=a.get("document")[0],k;v.on(g,"mousedown contextmenu",function(a){var o=g.documentElement;if(a.target===o&&(d&&e(),!(o.scrollHeight>o.clientHeight)&&(d=1,k=b(a.pageX,a.pageY))))v.on(g,"mouseup",e),v.on(g,"mousemove",c),f.focus(),k.select()})}function m(a){function b(h){if(j){var g=a.getSelection(),k=g&&g.getType(),l=g&&c.selection;if(h&&l&&k==w.SELECTION_NONE&&!c.queryCommandEnabled("InsertImage"))setTimeout(function(){b(d)},50);else{var i;if(!l||!l.type||!("Control"!=l.type&&
(i=l.createRange())&&(i=i.parentElement())&&(i=i.nodeName)&&i.toLowerCase()in{input:1,textarea:1}))f=l&&g.getRanges()[0],a.checkSelectionChange()}}}var c=a.get("document")[0],g=new q(c.body),h=new q(c.documentElement);if(8>o.Utils.ieEngine)h.on("click",function(b){"html"===(new q(b.target)).nodeName()&&a.getSelection().getNative().createRange().select()});var f,j,n=d;h.on("mousedown",function(){n=k});h.on("mouseup",function(){n=d});g.on("focusin",function(a){if("body"==(new q(a.target)).nodeName()&&
f){try{n&&f.select()}catch(b){}f=t}});g.on("focus",function(){j=d;b()});g.on("beforedeactivate",function(a){a.relatedTarget||(j=k,n=d)});g.on("mousedown",function(){j=k});g.on("mouseup",function(){j=d;setTimeout(function(){b(d)},0)});g.on("keydown",function(){j=k});g.on("keyup",function(){j=d;setTimeout(function(){b()},0)})}function r(a){var b=a.get("document")[0];v.on(b,"mouseup keyup",function(){a.checkSelectionChange()})}function c(a){function b(a){var b=o.XHTML_DTD;return a._4e_isBlockBoundary()&&
b.$empty[a.nodeName()]}function c(a){return f(a)&&j(a)}var g=a.get("document")[0],h=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;|(<\!--[\s\S]*?--\>))?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,f=o.Walker.whitespaces(d),j=o.Walker.bookmark(k,d),m=function(a){return f(a)&&8!=a.nodeType};a.on("selectionChange",function(f){var j=f.path,t=new q(a.get("document")[0].body),f=(f=f.selection)&&f.getRanges()[0],l=j.blockLimit;if(p.gecko){var C=j.block||j.blockLimit,x=C&&C.last(c);C&&C._4e_isBlockBoundary()&&
(!x||!(1==x[0].nodeType&&x._4e_isBlockBoundary()))&&"pre"!=C.nodeName()&&!C._4e_getBogus()&&C._4e_appendBogus()}if(f&&f.collapsed&&!j.block){if("body"==l.nodeName()){if((j=f.fixBlock(d,"p"))&&j[0]!=t[0].lastChild&&j._4e_outerHtml().match(h))if((l=j.next(m,1))&&l[0].nodeType==n.ELEMENT_NODE&&!b[l])f.moveToElementEditablePosition(l),j._4e_remove();else if((l=j.prev(m,1))&&l[0].nodeType==n.ELEMENT_NODE&&!b[l])f.moveToElementEditablePosition(l,l._4e_outerHtml().match(h)?k:d),j._4e_remove();f.select();
a.notifySelectionChange()}j=new o.Range(g);j.moveToElementEditablePosition(t,d);"body"!==(new o.ElementPath(j.startContainer)).blockLimit.nodeName()&&(t=(new q(g.createElement("p"))).appendTo(t),p.ie||t._4e_appendBogus())}})}var d=!0,k=!1,t=null,p=g.UA,v=g.Event,n=g.DOM,q=g.Node,w=o.SELECTION;return{init:function(a){a.docReady(function(){p.ie?(u(a),m(a)):r(a)});c(a)}}},{requires:["editor"]});
KISSY.add("editor/core/styles",function(g){function o(a){return!B.attr(a,"_ke_bookmark")}function u(a,b){for(var c in a)a.hasOwnProperty(c)&&(g.isString(a[c])?a[c]=a[c].replace(P,function(a,c){return b[c]}):u(a[c],b))}function m(a,b){b&&(a=g.clone(a),u(a,b));var c=this.element=this.element=(a.element||"*").toLowerCase();this.type=this.type="#"==c||O[c]?l.STYLE_BLOCK:M[c]?l.STYLE_OBJECT:l.STYLE_INLINE;this._={definition:a}}function r(a,b){var c=b?this.removeFromRange:this.applyToRange;a.body.focus();
for(var e=new x(a),d=e.getRanges(),f=0;f<d.length;f++)c.call(this,d[f]);e.selectRanges(d)}function c(a,b,c){var e=a.element;"*"==e&&(e="span");b=new G(b.createElement(e));c&&c._4e_copyAttributes(b);c=a._.definition;a=c.attributes;c=m.getStyleText(c);if(a)for(var d in a)a.hasOwnProperty(d)&&b.attr(d,a[d]);c&&(b[0].style.cssText=c);return b}function d(a){var b=a.createBookmark(s),e=a.createIterator();e.enforceRealBlocks=s;e.enlargeBr=s;for(var d,f=a.document;d=e.getNextParagraph();){var h=c(this,f,
d),g=h,h="pre"==g.nodeName,l="pre"==d.nodeName,i=!h&&l;h&&!l?(l=d,i=l.html(),i=k(i,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,""),i=i.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1"),i=i.replace(/([ \t\n\r]+|&nbsp;)/g," "),i=i.replace(/<br\b[^>]*>/gi,"\n"),K.ie?(l=l[0].ownerDocument.createElement("div"),l.appendChild(g[0]),g[0].outerHTML="<pre>"+i+"</pre>",g=new G(l.firstChild),g._4e_remove()):g.html(i)):i?g=p(t(d),g):d._4e_moveChildren(g);d[0].parentNode.replaceChild(g[0],d[0]);if(h&&(d=g,h=void 0,(h=d._4e_previousSourceNode(s,
B.ELEMENT_NODE))&&"pre"==h.nodeName()))g=k(h.html(),/\n$/,"")+"\n\n"+k(d.html(),/^\n/,""),K.ie?d[0].outerHTML="<pre>"+g+"</pre>":d.html(g),h._4e_remove()}a.moveToBookmark(b)}function k(a,b,c){var e="",d="",a=a.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(a,b,c){b&&(e=b);c&&(d=c);return""});return e+a.replace(b,c)+d}function t(a){var b=[];k(a._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,function(a,b,c){return b+"</pre>"+
c+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(a,c){b.push(c)});return b}function p(a,b){for(var c=b[0].ownerDocument.createDocumentFragment(),e=0;e<a.length;e++){var d=a[e],d=d.replace(/(\r\n|\r)/g,"\n"),d=k(d,/^[ \t]*\n/,""),d=k(d,/\n$/,""),d=k(d,/^[ \t]+|[ \t]+$/g,function(a,b){return 1==a.length?"&nbsp;":b?" "+Array(a.length).join("&nbsp;"):Array(a.length).join("&nbsp;")+" "}),d=d.replace(/\n/g,"<br>"),d=d.replace(/[ \t]{2,}/g,function(a){return Array(a.length).join("&nbsp;")+" "}),
f=b.clone();f.html(d);c.appendChild(f[0])}return c}function v(a){var b=a.document;if(a.collapsed)b=c(this,b,void 0),a.insertNode(b),a.moveToPosition(b,C.POSITION_BEFORE_END);else{var d=this.element,e=this._.definition,f,h=I[d];h||(f=s,h=I.span);var g=a.createBookmark();a.enlarge(C.ENLARGE_ELEMENT);a.trim();for(var l=a.createBookmark(),k=l.startNode,l=l.endNode,j=k,x;j&&j[0];){var n=A;if(B.equals(j,l))j=z,n=s;else{var m=j[0].nodeType,t=m==B.ELEMENT_NODE?j.nodeName():z;if(t&&j.attr("_ke_bookmark")){j=
j._4e_nextSourceNode(s);continue}if(!t||h[t]&&(j._4e_position(l)|y.POSITION_PRECEDING|y.POSITION_IDENTICAL|y.POSITION_IS_CONTAINED)==y.POSITION_PRECEDING+y.POSITION_IDENTICAL+y.POSITION_IS_CONTAINED&&(!e.childRule||e.childRule(j))){var p=j.parent();if(p&&"a"==d&&p.nodeName()==d)m=c(this,b,void 0),p._4e_moveChildren(m),p[0].parentNode.replaceChild(m[0],p[0]),m._4e_mergeSiblings();else if(p&&p[0]&&((I[p.nodeName()]||I.span)[d]||f)&&(!e.parentRule||e.parentRule(p))){if(!x&&(!t||!I.$removeEmpty[t]||(j._4e_position(l)|
y.POSITION_PRECEDING|y.POSITION_IDENTICAL|y.POSITION_IS_CONTAINED)==y.POSITION_PRECEDING+y.POSITION_IDENTICAL+y.POSITION_IS_CONTAINED))x=new F(b),x.setStartBefore(j);if(m==B.TEXT_NODE||m==B.ELEMENT_NODE&&!j[0].childNodes.length){p=j;for(m=null;(n=!p.next(o,1))&&(m=p.parent())&&h[m.nodeName()]&&(m._4e_position(k)|y.POSITION_FOLLOWING|y.POSITION_IDENTICAL|y.POSITION_IS_CONTAINED)==y.POSITION_FOLLOWING+y.POSITION_IDENTICAL+y.POSITION_IS_CONTAINED&&(!e.childRule||e.childRule(m));)p=m;x.setEndAfter(p)}}else n=
s}else n=s;j=j._4e_nextSourceNode()}if(n&&x&&!x.collapsed){for(var n=c(this,b,void 0),p=x.getCommonAncestor(),m={},t={},r,q=null,u;n&&p&&n[0]&&p[0];){if(p.nodeName()==d){for(r in e.attributes)if(e.attributes.hasOwnProperty(r)&&!t[r]&&(u=p.attr(q)))n.attr(r)==u?n.removeAttr(r):t[r]=1;for(q in e.styles)if(e.styles.hasOwnProperty(q)&&!m[q]&&(u=p.style(q)))n.style(q)==u?n.style(q,""):m[q]=1;if(!n._4e_hasAttributes()){n=z;break}}p=p.parent()}n?(n[0].appendChild(x.extractContents()),i(this,n),x.insertNode(n),
n._4e_mergeSiblings(),K.ie||n[0].normalize()):(n=new G(b.createElement("span")),n[0].appendChild(x.extractContents()),x.insertNode(n),i(this,n),n._4e_remove(!0));x=z}}k._4e_remove();l._4e_remove();a.moveToBookmark(g);a.shrink(C.SHRINK_TEXT)}}function n(c){c.enlarge(C.ENLARGE_ELEMENT);var d=c.createBookmark(),e=d.startNode;if(c.collapsed){for(var f=new L(e.parent()),g,l=0,i;l<f.elements.length&&(i=f.elements[l])&&!(i==f.block||i==f.blockLimit);l++)if(this.checkElementRemovable(i)){var j=c.checkBoundaryOfElement(i,
C.END),k=!j&&c.checkBoundaryOfElement(i,C.START);k||j?(g=i,g.match=k?"start":"end"):(i._4e_mergeSiblings(),i.nodeName()!=this.element?(j=a(this),h(i,j[i.nodeName()]||j["*"])):b(this,i))}if(g){i=e;for(l=0;;l++){j=f.elements[l];if(B.equals(j,g))break;else if(j.match)continue;else j=j.clone();j[0].appendChild(i[0]);i=j}i["start"==g.match?"insertBefore":"insertAfter"](g)}}else{var n=d.endNode,x=this,f=function(){for(var a=new L(e.parent()),b=new L(n.parent()),c=z,d=z,f=0;f<a.elements.length;f++){var h=
a.elements[f];if(h==a.block||h==a.blockLimit)break;x.checkElementRemovable(h)&&(c=h)}for(f=0;f<b.elements.length;f++){h=b.elements[f];if(h==b.block||h==b.blockLimit)break;x.checkElementRemovable(h)&&(d=h)}d&&n._4e_breakParent(d);c&&e._4e_breakParent(c)};f();for(g=new G(e[0].nextSibling);g[0]!==n[0];){l=g._4e_nextSourceNode();if(g[0]&&g[0].nodeType==B.ELEMENT_NODE&&this.checkElementRemovable(g)&&(g.nodeName()==this.element?b(this,g):(i=a(this),h(g,i[g.nodeName()]||i["*"])),l[0].nodeType==B.ELEMENT_NODE&&
l.contains(e)))f(),l=new G(e[0].nextSibling);g=l}}c.moveToBookmark(d)}function q(a){var b={};(""+a).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(a,c,d){b[c]=d});return b}function w(a,b){var c="";b!==A?(c=document.createElement("span"),c.style.cssText=a,c=c.style.cssText||""):c=a;return c.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function a(a){if(a._.overrides)return a._.overrides;var b=a._.overrides={},c=a._.definition.overrides;
if(c){g.isArray(c)||(c=[c]);for(var d=0;d<c.length;d++){var e=c[d],f,h,l;"string"==typeof e?f=e.toLowerCase():(f=e.element?e.element.toLowerCase():a.element,h=e.attributes,l=e.styles);e=b[f]||(b[f]={});if(h){f=e.attributes=e.attributes||[];for(var i in h)h.hasOwnProperty(i)&&f.push([i.toLowerCase(),h[i]])}if(l){var e=e.styles=e.styles||[],j;for(j in l)l.hasOwnProperty(j)&&e.push([j.toLowerCase(),l[j]])}}}return b}function b(b,c){var d=b._.definition,h=a(b),l=g.merge(d.attributes,(h[c.nodeName()]||
h["*"]||{}).attributes),d=g.merge(d.styles,(h[c.nodeName()]||h["*"]||{}).styles),h=g.isEmptyObject(l)&&g.isEmptyObject(d),i;for(i in l)if(l.hasOwnProperty(i)&&!(("class"==i||b._.definition.fullMatch)&&c.attr(i)!=e(i,l[i])))h=h||!!c.hasAttr(i),c.removeAttr(i);for(var j in d)d.hasOwnProperty(j)&&!(b._.definition.fullMatch&&c.style(j)!=e(j,d[j],s))&&(h=h||!!c.style(j),c.style(j,""));f(c)}function e(a,b,c){var d=new G("<span>");d[c?"style":"attr"](a,b);return d[c?"style":"attr"](a)}function i(c,d){for(var e=
a(c),f=d.all(c.element),g=f.length;0<=--g;)b(c,new G(f[g]));for(var l in e)if(e.hasOwnProperty(l)&&l!=c.element){f=d.all(l);for(g=f.length-1;0<=g;g--){var i=new G(f[g]);h(i,e[l])}}}function h(a,b){var c,d=b&&b.attributes;if(d)for(c=0;c<d.length;c++){var e=d[c][0],h;if(h=a.attr(e)){var g=d[c][1];(g===z||g.test&&g.test(h)||"string"==typeof g&&h==g)&&a[0].removeAttribute(e)}}if(d=b&&b.styles)for(c=0;c<d.length;c++)if(e=d[c][0],g=a.css(e)){var l=d[c][1];(l===z||l.test&&l.test(h)||"string"==typeof l&&
g==l)&&a.css(e,"")}f(a)}function f(a){if(!a._4e_hasAttributes()){var b=a[0].firstChild,c=a[0].lastChild;a._4e_remove(s);b&&(b.nodeType==B.ELEMENT_NODE&&B._4e_mergeSiblings(b),c&&b!=c&&c.nodeType==B.ELEMENT_NODE&&B._4e_mergeSiblings(c))}}var j=g.Editor,s=!0,A=!1,z=null,B=g.DOM,l={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3},C=j.RANGE,x=j.Selection,y=j.POSITION,F=j.Range,G=g.Node,K=g.UA,L=j.ElementPath,O={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},I=j.XHTML_DTD,M={embed:1,hr:1,img:1,li:1,
object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},N=/\s*(?:;\s*|$)/g,P=/#\((.+?)\)/g;j.STYLE=l;m.prototype={apply:function(a){r.call(this,a,A)},remove:function(a){r.call(this,a,s)},applyToRange:function(a){return(this.applyToRange=this.type==l.STYLE_INLINE?v:this.type==l.STYLE_BLOCK?d:z).call(this,a)},removeFromRange:function(a){return(this.removeFromRange=this.type==l.STYLE_INLINE?n:z).call(this,a)},checkElementRemovable:function(b,c){if(!b)return A;var d=this._.definition,e;if(b.nodeName()==
this.element){if(!c&&!b._4e_hasAttributes())return s;var f=d._AC;if(f)d=f;else{var f={},h=0,g=d.attributes;if(g)for(var l in g)g.hasOwnProperty(l)&&(h++,f[l]=g[l]);if(g=m.getStyleText(d))f.style||h++,f.style=g;f._length=h;d=d._AC=f}if(d._length){for(var i in d)if("_length"!=i&&d.hasOwnProperty(i)){h=b.attr(i)||"";if("style"==i)a:{f=d[i];h=w(h,A);"string"==typeof f&&(f=q(f));"string"==typeof h&&(h=q(h));g=void 0;for(g in f)if(f.hasOwnProperty(g)&&!(g in h&&(h[g]==f[g]||"inherit"==f[g]||"inherit"==
h[g]))){f=A;break a}f=s}else f=d[i]==h;if(f){if(!c)return s}else if(c)return A}if(c)return s}else return s}i=a(this);if(i=i[b.nodeName()]||i["*"]){if(!(d=i.attributes)&&!(e=i.styles))return s;if(d)for(f=0;f<d.length;f++)if(i=d[f][0],i=b.attr(i))if(h=d[f][1],h===z||"string"==typeof h&&i==h||h.test&&h.test(i))return s;if(e)for(f=0;f<e.length;f++)if(i=b.css(e[f][0]))if(d=e[f][1],d===z||"string"==typeof d&&i==d||d.test&&d.test(i))return s}return A},checkActive:function(a){switch(this.type){case l.STYLE_BLOCK:return this.checkElementRemovable(a.block||
a.blockLimit,s);case l.STYLE_OBJECT:case l.STYLE_INLINE:for(var b=a.elements,c=0,d;c<b.length;c++)if(d=b[c],!(this.type==l.STYLE_INLINE&&(B.equals(d,a.block)||B.equals(d,a.blockLimit))))if((this.type!=l.STYLE_OBJECT||d.nodeName()in M)&&this.checkElementRemovable(d,s))return s}return A}};m.getStyleText=function(a){var b=a._ST;if(b)return b;var b=a.styles,c=a.attributes&&a.attributes.style||"",d="";c.length&&(c=c.replace(N,";"));for(var e in b)if(b.hasOwnProperty(e)){var f=b[e],h=(e+":"+f).replace(N,
";");"inherit"==f?d+=h:c+=h}c.length&&(c=w(c));return a._ST=c+d};j.Style=m},{requires:["./range","./selection","./domIterator","./elementPath"]});
KISSY.add("editor/core/utils",function(g){var o=g.Node,u=g.DOM,m=g.UA,r={debugUrl:function(c){var d=g.Config;d.debug||(c=c.replace(/\.(js|css)/i,"-min.$1"));-1==c.indexOf("?t")&&(c=-1!=c.indexOf("?")?c+"&":c+"?",c+="t="+encodeURIComponent(d.tag));return d.base+"editor/"+c},lazyRun:function(c,d,g){var o=c[d],m=c[g];c[d]=function(){o.apply(this,arguments);c[d]=c[g];return m.apply(this,arguments)}},getXY:function(c,d,g,o){g=g.defaultView||g.parentWindow;c-=u.scrollLeft(g);d-=u.scrollTop(g);o&&(o=o.defaultView||
o.parentWindow,g!=o&&g.frameElement&&(o=u.offset(g.frameElement,void 0,o),c+=o.left,d+=o.top));return{left:c,top:d}},tryThese:function(c){for(var d,g=0,o=arguments.length;g<o;g++){var m=arguments[g];try{d=m();break}catch(r){}}return d},arrayCompare:function(c,d){if(!c&&!d)return!0;if(!c||!d||c.length!=d.length)return!1;for(var g=0;g<c.length;g++)if(c[g]!==d[g])return!1;return!0},clearAllMarkers:function(c){for(var d in c)c.hasOwnProperty(d)&&c[d]._4e_clearMarkers(c,!0,void 0)},ltrim:function(c){return c.replace(/^\s+/,
"")},rtrim:function(c){return c.replace(/\s+$/,"")},isNumber:function(c){return/^\d+(.\d+)?$/.test(g.trim(c))},verifyInputs:function(c){for(var d=0;d<c.length;d++){var k=new o(c[d]),m=g.trim(r.valInput(k)),p=k.attr("data-verify"),k=k.attr("data-warning");if(p&&!RegExp(p).test(m))return alert(k),!1}return!0},sourceDisable:function(c,d){c.on("sourceMode",d.disable,d);c.on("wysiwygMode",d.enable,d)},resetInput:function(c){var d=c.attr("placeholder");d&&m.ie?(c.addClass("ks-editor-input-tip"),c.val(d)):
m.ie||c.val("")},valInput:function(c,d){if(void 0===d)return c.hasClass("ks-editor-input-tip")?"":c.val();c.removeClass("ks-editor-input-tip");c.val(d)},placeholder:function(c,d){c.attr("placeholder",d);m.ie&&(c.on("blur",function(){g.trim(c.val())||(c.addClass("ks-editor-input-tip"),c.val(d))}),c.on("focus",function(){c.removeClass("ks-editor-input-tip");g.trim(c.val())==d&&c.val("")}))},htmlEncode:function(c){return!c?c:(""+c).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,
"&quot;")},normParams:function(c){var c=g.clone(c),d;for(d in c)if(c.hasOwnProperty(d)){var k=c[d];g.isFunction(k)&&(c[d]=k())}return c},map:function(c,d){for(var g=0;g<c.length;g++)c[g]=d(c[g]);return c},ieEngine:document.documentMode||m.ie,preventFocus:function(c){m.ie?c.unselectable(void 0):c.attr("onmousedown","return false;")},injectDom:function(c){g.mix(u,c);for(var d in c)c.hasOwnProperty(d)&&function(d){o.prototype[d]=function(){var m=[].slice.call(arguments,0);m.unshift(this[0]);return(m=
c[d].apply(null,m))&&(m.nodeType||g.isWindow(m))?new o(m):g.isArray(m)&&(m.__IS_NODELIST||m[0]&&m[0].nodeType)?new o(m):m}}(d)},addRes:function(){var c=this.__res=this.__res||[];c.push.apply(c,g.makeArray(arguments))},destroyRes:function(){for(var c=this.__res||[],d=0;d<c.length;d++){var k=c[d];g.isFunction(k)?k():(k.destroy&&k.destroy(),k.remove&&k.remove())}this.__res=[]},getQueryCmd:function(c){return"query"+("-"+c).replace(/-(\w)/g,function(c,g){return g.toUpperCase()})+"Active"}};return g.Editor.Utils=
r},{requires:["./base"]});
KISSY.add("editor/core/walker",function(g,o){function u(a,b){if(this._.end)return k;var h,f=this.range,g,m=this.guard,o=this.type,q=a?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start&&(this._.start=1,f.trim(),f.collapsed))return this.end(),k;if(!a&&!this._.guardLTR){var r=f.endContainer[0],l=r.childNodes[f.endOffset];this._.guardLTR=function(a,b){return b&&(r==a||"body"==p.nodeName(a))?!1:a!=l}}if(a&&!this._.guardRTL){var C=f.startContainer[0],x=0<f.startOffset&&C.childNodes[f.startOffset-
1]||null;this._.guardRTL=function(a,b){return b&&(C==a||"body"==p.nodeName(a))?!1:a!=x}}var y=a?this._.guardRTL:this._.guardLTR;g=m?function(a,b){return y(a,b)===d?d:m(a,b)}:y;this.current?h=this.current[q](d,o,g):a?(h=f.endContainer,0<f.endOffset?(h=new n(h[0].childNodes[f.endOffset-1]),g(h[0])===d&&(h=k)):h=g(h,c)===d?k:h._4e_previousSourceNode(c,o,g,void 0)):(h=f.startContainer,h=new n(h[0].childNodes[f.startOffset]),h.length?g(h[0])===d&&(h=k):h=g(f.startContainer,c)===d?k:f.startContainer._4e_nextSourceNode(c,
o,g,void 0));for(;h&&!this._.end;){this.current=h;if(!this.evaluator||this.evaluator(h[0])!==d){if(!b)return h}else if(b&&this.evaluator)return d;h=h[q](d,o,g)}this.end();return this.current=k}function m(a){for(var b,c=k;b=u.call(this,a);)c=b;return c}function r(a){this.range=a;this.guard=this.evaluator=k;this._={}}var c=!0,d=!1,k=null,t=g.UA,p=g.DOM,v=o.XHTML_DTD,n=g.Node;g.augment(r,{end:function(){this._.end=1},next:function(){return u.call(this)},previous:function(){return u.call(this,c)},checkForward:function(){return u.call(this,
d,c)!==d},checkBackward:function(){return u.call(this,c,c)!==d},lastForward:function(){return m.call(this)},lastBackward:function(){return m.call(this,c)},reset:function(){delete this.current;this._={}},_iterator:u});g.mix(r,{blockBoundary:function(a){return function(b){return!(b.nodeType==p.ELEMENT_NODE&&p._4e_isBlockBoundary(b,a))}},bookmark:function(a,b){function c(a){return"span"==p.nodeName(a)&&p.attr(a,"_ke_bookmark")}return function(d){var g,k;g=d.nodeType==p.TEXT_NODE&&(k=d.parentNode)&&c(k);
g=a?g:g||c(d);return!!(b^g)}},whitespaces:function(a){return function(b){b=b.nodeType==p.TEXT_NODE&&!g.trim(b.nodeValue);return!!(a^b)}},invisible:function(a){var b=r.whitespaces();return function(c){c=b(c)||c.nodeType==p.ELEMENT_NODE&&!c.offsetHeight;return!!(a^c)}}});var q=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,w=r.whitespaces(),a=r.bookmark(),b=function(b){var c=p.nodeName(b);return a(b)||w(b)||1==b.nodeType&&c in v.$inline&&!(c in v.$empty)};o.Utils.injectDom({_4e_getBogus:function(a){a=new n(a);do a=
a._4e_previousSourceNode();while(a&&b(a[0]));return a&&(!t.ie?"br"==a.nodeName():3==a[0].nodeType&&q.test(a.text()))?a[0]:!1}});return o.Walker=r},{requires:["./base","./utils","./dom"]});KISSY.add("editor/core/zIndexManager",function(g){var o=g.Editor;o.zIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,STORE_FLASH_SHOW:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};o.baseZIndex=function(g){return(o.Config.baseZIndex||1E4)+g}},{requires:["./base"]});
KISSY.add("editor",function(g,o,u,m){function r(a,b){var c=a.body;j(function(){a.designMode="on";setTimeout(function(){a.designMode="off";c.focus();arguments.callee.retry||(arguments.callee.retry=v)},50)},function(){a.designMode="off";i.attr(c,"contentEditable",w);i.attr(c,"contentEditable",v);!b&&r(a,1)})}function c(a){a.get("iframe");var c=a.get("textarea")[0],d=a.get("window")[0],i=a.get("document")[0];b.webkit&&(f.on(i,"click",function(a){var b=new h(a.target);g.inArray(b.nodeName(),["input",
"select"])&&a.preventDefault()}),f.on(i,"mouseup",function(a){var b=new h(a.target);g.inArray(b.nodeName(),["input","textarea"])&&a.preventDefault()}));if(b.gecko||e||b.opera){var j;j=(new h('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>')).insertAfter(c);j.on("focus",function(){a.focus()});a.activateGecko=function(){b.gecko&&a.__iframeFocus&&j[0].focus()};a.on("destroy",function(){j.detach();j.remove()})}f.on(d,"focus",function(){b.gecko?r(i,w):b.opera&&i.body.focus();
a.notifySelectionChange()});if(b.gecko)f.on(i,"mousedown",function(){a.__iframeFocus||r(i,w)});if(e&&(f.on(i,"keydown",function(b){if(b.keyCode in{8:1,46:1}){var c=a.getSelection(),d=c.getSelectedElement();if(d){a.fire("save");var e=c.getRanges()[0].createBookmark();d.remove();c.selectBookmarks([e]);a.fire("save");b.preventDefault()}}}),"CSS1Compat"==i.compatMode)){var k={33:1,34:1};f.on(i,"keydown",function(b){b.keyCode in k&&setTimeout(function(){a.getSelection().scrollIntoView()},0)})}if(b.webkit)f.on(i,
"mousedown",function(b){b=new h(b.target);g.inArray(b.nodeName(),["img","hr","input","textarea","select"])&&a.getSelection().selectElement(b)});if(b.gecko)f.on(i,"dragstart",function(a){var b=new h(a.target);b.nodeName()==="img"&&/ke_/.test(b[0].className)&&a.preventDefault()});m.add(a)}function d(b,c,d,e){var f="",h,j=u.debugUrl("theme/editor-iframe.css");for(h=0;h<d.length;h++)f+=g.substitute('<link href="{href}" rel="stylesheet" />',{href:d[h]});return g.substitute(s,{doctype:8===a.documentMode?
'<meta http-equiv="X-UA-Compatible" content="IE=7" />':"",title:"${title}",href:j,style:c,data:e||"&nbsp;",script:b?'<script id="ke_active_script">'+(i.isCustomDomain()?'document.domain="'+a.domain+'";':"")+'parent.KISSY.Editor._initIFrame("'+b+'");<\/script>':""})}function k(a,b){a.__saveTimer&&(clearTimeout(a.__saveTimer),a.__saveTimer=null);a.__saveTimer=setTimeout(function(){a.execCommand("save")},b||0)}function t(a,b){function c(){k=j.document;a.__set("document",new h(k));a.__set("window",new h(j));
f.detach();k.open("text/html","replace");k.write(g);k.close()}var f=a.get("iframe"),g=d(a._UUID,a.get("customStyle"),a.get("customLink"),b),i=f[0],j=i.contentWindow,k;f.__loaded=1;try{k=j.document}catch(n){if(i.src=i.src,7>e){setTimeout(c,10);return}}c()}function p(a,c){var d=new h(z),e=a.get("textarea");e.hasAttr("tabindex")&&d.attr("tabIndex",b.webkit?-1:e.attr("tabIndex"));a.get("iframeWrapEl").prepend(d);a.set("iframe",d);a.__docReady=0;if(b.gecko&&!d.__loaded)d.on("load",function(){t(a,c)},a);
else t(a,c)}var v=!0,n=n,q=g.all,w=!1,a=document,b=g.UA,e=b.ie,i=g.DOM,h=g.Node,f=g.Event,j=u.tryThese,s="<!doctype html><html><head>{doctype}<title>{title}</title><link href='{href}' rel='stylesheet' /><style>{style}</style>{links}</head><body class='ks-editor'>{data}{script}</body></html>",A=i.getEmptyIframeSrc(),z='<iframe style="width:100%;height:100%;border:none;"  frameborder="0"  title="kissy-editor"  allowTransparency="true" '+(A?' src="'+A+'"':"")+"</iframe>";g.mix(o,{SOURCE_MODE:0,WYSIWYG_MODE:1});
var B=o.WYSIWYG_MODE;g.augment(o,{createDom:function(){var a,b=this.get("textarea"),c;b||this.set("textarea",b=q("<textarea class='ks-editor-textarea'></textarea>"));c=this.get("el");c.html('<div class="ks-editor-tools"></div><div class="ks-editor-textarea-wrap"></div><div class=\'ks-editor-status\'></div>');this._UUID=g.guid();this.set({iframeWrapEl:a=c.one(".ks-editor-textarea-wrap"),toolBarEl:c.one(".ks-editor-tools"),statusBarEl:c.one(".ks-editor-status")},{silent:1});b.css("width","100%");b.css("display",
"none");a.append(b);m.register(this)},_uiSetHeight:function(a){var b=this.get("toolBarEl"),c=this.get("statusBarEl"),a=parseInt(a,10),a=a-((b&&b.outerHeight()||0)+(c&&c.outerHeight()||0));this.get("iframeWrapEl").css("height",a);this.get("textarea").css("height",a)},adjustHeight:function(){var a;(a=this.get("height"))&&this._uiSetHeight(a)},_uiSetMode:function(a){var b=this,c,d=b.get("iframe"),e=b.get("textarea");a==B?(b.execCommand("save"),b.on("docReady",c=function(){b.execCommand("save");b.detach("docReady",
c)}),b._setData(e.val()),b.fire("wysiwygMode")):(e.val(b._getData(1,B)),e[0].focus(),e.show(),d.hide(),b.fire("sourceMode"))},_uiSetFocused:function(a){a&&this.__docReady&&this.focus()},bindUI:function(){function a(){b.detach("docReady",a);if(b.get("focused"))b.focus();else{var c=b.getSelection();c&&c.removeAllRanges()}}var b=this,c,d=b.get("prefixCls"),e=b.get("textarea");if(b.get("attachForm")&&(c=e[0].form))i.on(c,"submit",b.sync,b),b.on("destroy",function(){i.detach(c,"submit",b.sync,b)});b.on("docReady",
a);b.on("blur",function(){b.get("el").removeClass(d+"editor-focused")});b.on("focus",function(){b.get("el").addClass(d+"editor-focused")})},destructor:function(){var a=this.get("document")[0],b=this.get("window");this.sync();m.remove(this);f.remove([a,a.documentElement,a.body,b[0]]);g.each(this.__controls,function(a){a.destroy&&a.destroy()});this.__commands={};this.__controls={}},getControl:function(a){return this.__controls[a]},getControls:function(){return this.__controls},addControl:function(a,
b){this.__controls[a]=b},showDialog:function(a,b){var a=a+"/dialog",c=this.__controls[a];c.show(b);this.fire("dialogShow",{dialog:c.dialog,pluginDialog:c,dialogName:a})},addCommand:function(a,b){this.__commands[a]=b},hasCommand:function(a){return this.__commands[a]},execCommand:function(a){var b=this.__commands[a],c=g.makeArray(arguments);c.shift();c.unshift(this);if(b)return b.exec.apply(b,c)},_getData:function(a,b){var c=this.htmlDataProcessor,d;b==n&&(b=this.get("mode"));d=b==B?this.get("document")[0].body.innerHTML:
c.toDataFormat(this.get("textarea").val());d=a?c.toHtml(d):c.toServer(d);d=g.trim(d);/^(?:<(p)>)?(?:(?:&nbsp;)|\s)*(?:<\/\1>)?$/.test(d)&&(d="");return d},_setData:function(a){var b,c=a;if(this.get("mode")!=B)this.get("textarea").val(a);else{if(b=this.htmlDataProcessor)c=b.toDataFormat(a,"p");if(this.get("iframe")){a=this.get("iframe");b=this.get("window")[0];var d=this.get("document")[0];f.remove([d,d.documentElement,d.body,b]);a.remove()}p(this,c)}},sync:function(){this.get("textarea").val(this.get("data"))},
getDocHtml:function(){return d(0,this.get("customStyle"),this.get("customLink"),this.get("formatData"))},getSelection:function(){return o.Selection.getSelection(this.get("document")[0])},focus:function(){var a=this.get("document")[0],c=i._getWin(a);b.ie||c&&c.parent&&c.parent.focus();c&&c.focus();a.body.focus();this.notifySelectionChange()},blur:function(){i._getWin(this.get("document")[0]).blur();this.get("document")[0].body.blur()},addCustomStyle:function(a,b){var c=this.get("customStyle")||"",
c=c+("\n"+a);this.set("customStyle",c);i.addStyleSheet(this.get("window"),c,b)},removeCustomStyle:function(a){i.remove(i.get("#"+a,this.get("window")[0]))},addCustomLink:function(a){var b=this.get("customLink")||[],c=this.get("document")[0];b.push(a);this.set("customLink",b);b=c.createElement("link");b.rel="stylesheet";c.getElementsByTagName("head")[0].appendChild(b);b.href=a},removeCustomLink:function(a){for(var b=this.get("document")[0],b=i.query("link",b),c=0;c<b.length;c++)i.attr(b[c],"href")==
a&&i.remove(b[c]);b=this.get("customLink")||[];a=g.indexOf(a,b);-1!=a&&b.splice(a,1)},docReady:function(a){this.on("docReady",a);this.__docReady&&a.call(this)},checkSelectionChange:function(){var a=this;a.__checkSelectionChangeId&&clearTimeout(a.__checkSelectionChangeId);a.__checkSelectionChangeId=setTimeout(function(){var b=a.getSelection();if(b&&!b.isInvalid){var c=b.getStartElement(),d=new o.ElementPath(c);if(!a.__previousPath||!a.__previousPath.compare(d))a.__previousPath=d,a.fire("selectionChange",
{selection:b,path:d,element:c})}},100)},notifySelectionChange:function(){this.__previousPath=null;this.checkSelectionChange()},insertElement:function(a){if(this.get("mode")===B){this.focus();var b,c=a.nodeName(),d=o.XHTML_DTD,e=d.$block[c],f=o.RANGE,g=(c=this.getSelection())&&c.getRanges(),h,j,m;if(g&&0!=g.length){this.execCommand("save");for(j=g.length-1;0<=j;j--)h=g[j],b=!j&&a||a.clone(v),h.insertNodeByDtd(b),m||(m=b);if(m)return h.moveToPosition(m,f.POSITION_AFTER_END),e&&(a=o.Walker.whitespaces(!0),
(a=(m=m.next(a,1))&&m[0].nodeType==i.ELEMENT_NODE&&m.nodeName())&&d.$block[a]&&d[a]["#"]&&h.moveToElementEditablePosition(m)),c.selectRanges([h]),this.focus(),b&&b.scrollIntoView(n,!1),k(this),b}}},insertHtml:function(a,b){var c=this,d;if(c.get("mode")===B){if(d=c.htmlDataProcessor)a=d.toDataFormat(a,null,b);c.focus();c.execCommand("save");var f=c.get("document")[0];d=0;if(e){var g=f.selection;"Control"==g.type&&g.clear();try{g.createRange().pasteHTML(a)}catch(j){}}else try{f.execCommand("inserthtml",
w,a)}catch(m){setTimeout(function(){if(0==c.getSelection().getRanges().length){var b=new o.Range(f),d=i.first(f.body,function(a){return 1==a.nodeType&&"br"!=i.nodeName(a)});d||(d=new h(f.createElement("p")),d._4e_appendBogus(n),f.body.appendChild(d[0]));b.setStartAt(d,o.RANGE.POSITION_AFTER_START);b.select()}f.execCommand("inserthtml",w,a)},d=100)}setTimeout(function(){c.getSelection().scrollIntoView()},d);k(c,d)}}});o._initIFrame=function(a){var d=m.getInstance(a),g=d.get("document")[0],a=g.getElementById("ke_active_script");
i.remove(a);c(d);var j=g.body;e?(j.hideFocus=v,j.disabled=v,j.contentEditable=v,j.removeAttribute("disabled")):setTimeout(function(){b.gecko||b.opera?j.contentEditable=v:b.webkit?j.parentNode.contentEditable=v:g.designMode="on"},0);if(b.gecko||b.opera){var k=g.documentElement;f.on(k,"mousedown",function(a){if(a.target==k){b.gecko&&r(g,w);d.activateGecko()}})}setTimeout(function(){e&&setTimeout(function(){if(g){j.runtimeStyle.marginBottom="0px";j.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){d.__docReady=
1;d.fire("docReady");var a=d.get("disableObjectResizing"),b=d.get("disableInlineTableEditing");if(a||b)try{g.execCommand("enableObjectResizing",w,!a);g.execCommand("enableInlineTableEditing",w,!b)}catch(c){f.on(j,e?"resizestart":"resize",function(c){var d=new h(c.target);(a||d.nodeName()==="table"&&b)&&c.preventDefault()})}},10)};return o},{requires:"editor/core/base,editor/core/utils,editor/core/focusManager,editor/core/styles,editor/core/zIndexManager,editor/core/focusManager,editor/core/meta".split(",")});
