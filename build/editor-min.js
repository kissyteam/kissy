/*
Copyright 2013, KISSY UI Library v1.40dev
MIT Licensed
build time: Aug 7 20:59
*/
/*
 thanks to CKSource's intelligent work on CKEditor
 @author yiminghe@gmail.com
*/
KISSY.add("editor/iframe-content-tpl",'<!doctype html> <html> <head>{doctype} <title>{title}</title> <style> {style} </style> {links} </head> <body class="ks-editor"> {data} {script} </body> </html>');KISSY.add("editor/render-tpl",'<div class="{{prefixCls}}editor-tools" id="ks-editor-tools-{{id}}"> </div> <\!-- http://johanbrook.com/browsers/native-momentum-scrolling-ios-5/ ios \u4e0d\u80fd\u653e\u5728 iframe \u4e0a\uff01 --\> <div class="{{prefixCls}}editor-textarea-wrap" {{#if mobile}} style="overflow:scroll;-webkit-overflow-scrolling:touch;" {{/if}} id="ks-editor-textarea-wrap-{{id}}" > <textarea id="ks-editor-textarea-{{id}}" class="{{prefixCls}}editor-textarea" {{#each textareaAttrs}} {{xkey}}="{{.}}" {{/each}} {{#if mode}} style="display:none" {{/if}} >{{data}}</textarea> </div> <div class="{{prefixCls}}editor-status" id="ks-editor-status-{{id}}"> </div>');
KISSY.add("editor/render",function(a,m,s){return m.getDefaultRender().extend({beforeCreateDom:function(p,q){a.mix(p,{mobile:a.UA.mobile});a.mix(q,{textarea:"#ks-editor-textarea-{id}",toolBarEl:"#ks-editor-tools-{id}",statusBarEl:"#ks-editor-status-{id}"})}},{ATTRS:{contentTpl:{value:s}}})},{requires:["component/control","./render-tpl"]});
KISSY.add("editor/base",function(a,m,s,p){return s.extend({},{Config:{},XHTML_DTD:m.DTD,ATTRS:{textarea:{},textareaAttrs:{view:1},iframe:{},window:{},document:{},toolBarEl:{},statusBarEl:{},handleMouseEvents:{value:!1},focusable:{value:!1},mode:{value:1},data:{view:1},customStyle:{value:""},customLink:{value:[]},xrender:{value:p}},xclass:"editor",name:"EditorRender"})},{requires:["html-parser","component/control","./render"]});
KISSY.add("editor/utils",function(a,m){var s=a.Node,p=a.DOM,q=a.UA,w={debugUrl:function(g){var j=a.Config;j.debug||(g=g.replace(/\.(js|css)/i,"-min.$1"));-1==g.indexOf("?t")&&(g=-1!=g.indexOf("?")?g+"&":g+"?",g+="t="+encodeURIComponent(j.tag));return j.base+"editor/"+g},lazyRun:function(a,j,l){var r=a[j],t=a[l];a[j]=function(){r.apply(this,arguments);a[j]=a[l];return t.apply(this,arguments)}},getXY:function(a,j){var l=a.left,r=a.top,t=j.get("window")[0],l=l-p.scrollLeft(t),r=r-p.scrollTop(t),t=j.get("iframe").offset(),
l=l+t.left,r=r+t.top;return{left:l,top:r}},tryThese:function(a){for(var j,l=0,r=arguments.length;l<r;l++){var t=arguments[l];try{j=t();break}catch(o){}}return j},arrayCompare:function(a,j){if(!a&&!j)return!0;if(!a||!j||a.length!=j.length)return!1;for(var l=0;l<a.length;l++)if(a[l]!==j[l])return!1;return!0},clearAllMarkers:function(a){for(var j in a)a[j]._4e_clearMarkers(a,!0,void 0)},ltrim:function(a){return a.replace(/^\s+/,"")},rtrim:function(a){return a.replace(/\s+$/,"")},isNumber:function(g){return/^\d+(.\d+)?$/.test(a.trim(g))},
verifyInputs:function(g){for(var j=0;j<g.length;j++){var l=new s(g[j]),r=a.trim(w.valInput(l)),t=l.attr("data-verify"),l=l.attr("data-warning");if(t&&!RegExp(t).test(r))return alert(l),!1}return!0},sourceDisable:function(a,j){a.on("sourceMode",j.disable,j);a.on("wysiwygMode",j.enable,j)},resetInput:function(a){var j=a.attr("placeholder");j&&q.ie?(a.addClass("ks-editor-input-tip"),a.val(j)):q.ie||a.val("")},valInput:function(a,j){if(void 0===j)return a.hasClass("ks-editor-input-tip")?"":a.val();a.removeClass("ks-editor-input-tip");
a.val(j)},placeholder:function(g,j){g.attr("placeholder",j);q.ie&&(g.on("blur",function(){a.trim(g.val())||(g.addClass("ks-editor-input-tip"),g.val(j))}),g.on("focus",function(){g.removeClass("ks-editor-input-tip");a.trim(g.val())==j&&g.val("")}))},htmlEncode:function(a){return!a?a:(""+a).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")},normParams:function(g){var g=a.clone(g),j;for(j in g){var l=g[j];"function"===typeof l&&(g[j]=l())}return g},map:function(a,
j){for(var l=0;l<a.length;l++)a[l]=j(a[l]);return a},ieEngine:document.documentMode||q.ie,preventFocus:function(a){q.ie?a.unselectable():a.attr("onmousedown","return false;")},injectDom:function(g){a.mix(p,g);for(var j in g)(function(l){s.prototype[l]=function(){var j=[].slice.call(arguments,0);j.unshift(this[0]);return(j=g[l].apply(null,j))&&(j.nodeType||a.isWindow(j))?new s(j):a.isArray(j)&&(j.__IS_NODELIST||j[0]&&j[0].nodeType)?new s(j):j}})(j)},addRes:function(){var g=this.__res=this.__res||[];
g.push.apply(g,a.makeArray(arguments))},destroyRes:function(){for(var a=this.__res||[],j=0;j<a.length;j++){var l=a[j];"function"===typeof l?l():l.destroy?l.destroy():l.remove&&l.remove()}this.__res=[]},getQueryCmd:function(a){return"query"+("-"+a).replace(/-(\w)/g,function(a,g){return g.toUpperCase()})+"Value"}};return m.Utils=w},{requires:["./base","node"]});
KISSY.add("editor/dom",function(a,m,s){function p(a,e){var d=a[e?"next":"prev"](q,1);if(d&&d[0].nodeType==j.ELEMENT_NODE){for(var b=[];d.attr("_ke_bookmark")||d._4e_isEmptyInlineRemovable(q);)if(b.push(d),d=e?d.next(q,1):d.prev(q,1),!d)return;if(a._4e_isIdentical(d,q)){for(var i=new r(e?a[0].lastChild:a[0].firstChild);b.length;)b.shift()._4e_move(a,!e,q);d._4e_moveChildren(a,!e,q);d.remove();i[0]&&i[0].nodeType==j.ELEMENT_NODE&&i._4e_mergeSiblings()}}}var q=q,w=m.XHTML_DTD,g=a.DOM,j=g.NodeType,l=
a.UA,r=a.Node,t={a:1,abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};m.POSITION={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};var o=m.POSITION,x={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,
"table-column":1,"table-cell":1,"table-caption":1},y={hr:1},h=function(a){return a&&(a[0]||a)};s.injectDom({_4e_sameLevel:function(a,e){var e=h(e),d=a.parentNode;return d&&d==e.parentNode},_4e_isBlockBoundary:function(n,e){var d=a.merge(y,e);return!(!x[g.css(n,"display")]&&!d[g.nodeName(n)])},_4e_index:function(a,e){for(var d=a.parentNode.childNodes,b,i=-1,c=0;c<d.length;c++)if(b=d[c],!e||!(3==b.nodeType&&b.previousSibling&&3==b.previousSibling.nodeType))if(i++,b===a)return i;return-1},_4e_move:function(a,
e,d){e=h(e);d?e.insertBefore(a,e.firstChild):e.appendChild(a)},_4e_isIdentical:function(a,e){if(!e)return!1;e=h(e);if(g.nodeName(a)!=g.nodeName(e))return!1;var d=a.attributes,b=e.attributes,i=d.length,c=b.length;if(i!=c)return!1;for(var f=0;f<i;f++){var k=d[f],v=k.name;if(k.specified&&g.attr(a,v)!=g.attr(e,v))return!1}if(8>s.ieEngine)for(f=0;f<c;f++)if(k=b[f],v=k.name,k.specified&&g.attr(a,v)!=g.attr(e,v))return!1;return!0},_4e_isEmptyInlineRemovable:function(n){if(!w.$removeEmpty[g.nodeName(n)])return!1;
for(var n=n.childNodes,e=0,d=n.length;e<d;e++){var b=n[e],i=b.nodeType;if(!(i==j.ELEMENT_NODE&&b.getAttribute("_ke_bookmark"))&&(i==j.ELEMENT_NODE&&!g._4e_isEmptyInlineRemovable(b)||i==g.NodeType.TEXT_NODE&&a.trim(b.nodeValue)))return!1}return!0},_4e_moveChildren:function(a,e,d){e=h(e);if(a!=e)if(d)for(;d=a.lastChild;)e.insertBefore(a.removeChild(d),e.firstChild);else for(;d=a.firstChild;)e.appendChild(a.removeChild(d))},_4e_mergeSiblings:function(a){a=new r(a);t[a.nodeName()]&&(p(a,!0),p(a))},_4e_splitText:function(a,
e){var d=a.ownerDocument;if(a.nodeType==g.NodeType.TEXT_NODE){if(l.ie&&e==a.nodeValue.length){var b=d.createTextNode("");g.insertAfter(b,a);return b}b=a.splitText(e);d.documentMode&&(d=d.createTextNode(""),g.insertAfter(d,b),g.remove(d));return b}},_4e_parents:function(a,e){var d=[];d.__IS_NODELIST=1;do d[e?"push":"unshift"](a);while(a=a.parentNode);return d},_4e_nextSourceNode:function(a,e,d,b){if(b&&!b.call)var i=h(b),b=function(a){return a!==i};var e=!e&&a.firstChild,c=a;if(!e){if(a.nodeType==
j.ELEMENT_NODE&&b&&!1===b(a,!0))return null;e=a.nextSibling}for(;!e&&(c=c.parentNode);){if(b&&!1===b(c,!0))return null;e=c.nextSibling}return!e||b&&!1===b(e)?null:d&&d!=e.nodeType?g._4e_nextSourceNode(e,!1,d,b):e},_4e_previousSourceNode:function(a,e,d,b){if(b&&!b.call)var i=h(b),b=function(a){return a!==i};var e=!e&&a.lastChild,c=a;if(!e){if(a.nodeType==j.ELEMENT_NODE&&b&&!1===b(a,!0))return null;e=a.previousSibling}for(;!e&&(c=c.parentNode);){if(b&&!1===b(c,!0))return null;e=c.previousSibling}return!e||
b&&!1===b(e)?null:d&&e.nodeType!=d?g._4e_previousSourceNode(e,!1,d,b):e},_4e_commonAncestor:function(a,e){e=h(e);if(a===e)return a;if(g.contains(e,a))return e;var d=a;do if(g.contains(d,e))return d;while(d=d.parentNode);return null},_4e_hasAttributes:9>s.ieEngine?function(a){for(var e=a.attributes,d=0;d<e.length;d++){var b=e[d];switch(b.name){case "class":if(a.getAttribute("class"))return!0;break;default:if(b.specified)return!0}}return!1}:function(a){l.gecko&&a.removeAttribute("_moz_dirty");return a.hasAttributes()},
_4e_position:function(a,e){var d=h(e);if(a.compareDocumentPosition)return a.compareDocumentPosition(d);if(a==d)return o.POSITION_IDENTICAL;if(a.nodeType==j.ELEMENT_NODE&&d.nodeType==j.ELEMENT_NODE){if(g.contains(a,d))return o.POSITION_CONTAINS+o.POSITION_PRECEDING;if(g.contains(d,a))return o.POSITION_IS_CONTAINED+o.POSITION_FOLLOWING;if("sourceIndex"in a)return 0>a.sourceIndex||0>d.sourceIndex?o.POSITION_DISCONNECTED:a.sourceIndex<d.sourceIndex?o.POSITION_PRECEDING:o.POSITION_FOLLOWING}for(var b=
g._4e_address(a),d=g._4e_address(d),i=Math.min(b.length,d.length),c=0;c<=i-1;c++)if(b[c]!=d[c])return b[c]<d[c]?o.POSITION_PRECEDING:o.POSITION_FOLLOWING;return b.length<d.length?o.POSITION_CONTAINS+o.POSITION_PRECEDING:o.POSITION_IS_CONTAINED+o.POSITION_FOLLOWING},_4e_address:function(a,e){for(var d=[],b=a.ownerDocument.documentElement,i=a;i&&i!=b;)d.unshift(g._4e_index(i,e)),i=i.parentNode;return d},_4e_remove:function(a,e){var d=a.parentNode;if(d){if(e)for(var b;b=a.firstChild;)d.insertBefore(a.removeChild(b),
a);d.removeChild(a)}return a},_4e_trim:function(a){g._4e_ltrim(a);g._4e_rtrim(a)},_4e_ltrim:function(a){for(var e;e=a.firstChild;){if(e.nodeType==g.NodeType.TEXT_NODE){var d=s.ltrim(e.nodeValue),b=e.nodeValue.length;if(d)d.length<b&&(g._4e_splitText(e,b-d.length),a.removeChild(a.firstChild));else{a.removeChild(e);continue}}break}},_4e_rtrim:function(a){for(var e;e=a.lastChild;){if(e.type==g.NodeType.TEXT_NODE){var d=s.rtrim(e.nodeValue),b=e.nodeValue.length;if(d)d.length<b&&(g._4e_splitText(e,d.length),
a.removeChild(a.lastChild));else{a.removeChild(e);continue}}break}!l.ie&&!l.opera&&(e=a.lastChild)&&1==e.nodeType&&"br"==g.nodeName(e)&&a.removeChild(e)},_4e_appendBogus:function(h){for(var e=h.lastChild;e&&e.nodeType==g.NodeType.TEXT_NODE&&!a.trim(e.nodeValue);)e=e.previousSibling;if(!e||e.nodeType==g.NodeType.TEXT_NODE||"br"!==g.nodeName(e))e=l.opera?h.ownerDocument.createTextNode(""):h.ownerDocument.createElement("br"),h.appendChild(e)},_4e_setMarker:function(h,e,d,b){var h=new r(h),i=h.data("list_marker_id")||
h.data("list_marker_id",a.guid()).data("list_marker_id"),c=h.data("list_marker_names")||h.data("list_marker_names",{}).data("list_marker_names");e[i]=h;c[d]=1;return h.data(d,b)},_4e_clearMarkers:function(a,e,d){var a=new r(a),b=a.data("list_marker_names"),i=a.data("list_marker_id"),c;for(c in b)a.removeData(c);a.removeData("list_marker_names");d&&(a.removeData("list_marker_id"),delete e[i])},_4e_copyAttributes:function(a,e,d){for(var e=new r(e),b=a.attributes,d=d||{},i=0;i<b.length;i++){var c=b[i],
f=c.name.toLowerCase(),k;if(!(f in d))if("checked"==f&&(k=g.attr(a,f)))e.attr(f,k);else if(c.specified||l.ie&&c.value&&"value"==f)k=g.attr(a,f),null===k&&(k=c.nodeValue),e.attr(f,k)}""!==a.style.cssText&&(e[0].style.cssText=a.style.cssText)},_4e_isEditable:function(a){a=g.nodeName(a);return(a=!w.$nonEditable[a]&&(w[a]||w.span))&&a["#text"]},_4e_getByAddress:function(a,e,d){for(var a=a.documentElement,b=0;a&&b<e.length;b++){var i=e[b];if(d)for(var c=-1,f=0;f<a.childNodes.length;f++){var k=a.childNodes[f];
if(!(!0===d&&3==k.nodeType&&k.previousSibling&&3==k.previousSibling.nodeType)&&(c++,c==i)){a=k;break}}else a=a.childNodes[i]}return a}})},{requires:["./base","./utils","node"]});
KISSY.add("editor/focusManager",function(a,m){function s(){var a=this;a.__iframeFocus=l;g=a;w&&clearTimeout(w);w=setTimeout(function(){a.fire("focus")},30)}function p(){var a=this;a.__iframeFocus=r;g=t;w&&clearTimeout(w);w=setTimeout(function(){a.fire("blur")},30)}var q={},w,g,j={refreshAll:function(){for(var a in q){var g=q[a].get("document")[0];g.designMode="off";g.designMode="on"}},currentInstance:function(){return g},getInstance:function(a){return q[a]},add:function(a){a.get("window").on("focus",
s,a).on("blur",p,a)},register:function(a){q[a.get("id")]=a},remove:function(a){delete q[a.get("id")];a.get("window").detach("focus",s,a).detach("blur",p,a)}},l=!0,r=!1,t=null;j.refreshAll=j.refreshAll;m.focusManager=j;m.getInstances=function(){return q};return j},{requires:["./base","./dom"]});
KISSY.add("editor/walker",function(a,m){function s(a,d){if(this._.end)return j;var b,i=this.range,c,f=this.guard,k=this.type,v=a?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start&&(this._.start=1,i.trim(),i.collapsed))return this.end(),j;if(!a&&!this._.guardLTR){var h=i.endContainer[0],l=h.childNodes[i.endOffset];this._.guardLTR=function(a,b){return b&&(h==a||"body"==r.nodeName(a))?!1:a!=l}}if(a&&!this._.guardRTL){var n=i.startContainer[0],t=0<i.startOffset&&n.childNodes[i.startOffset-
1]||null;this._.guardRTL=function(a,b){return b&&(n==a||"body"==r.nodeName(a))?!1:a!=t}}var J=a?this._.guardRTL:this._.guardLTR;c=f?function(a,b){return J(a,b)===g?g:f(a,b)}:J;this.current?b=this.current[v](g,k,c):a?(b=i.endContainer,0<i.endOffset?(b=new o(b[0].childNodes[i.endOffset-1]),c(b[0])===g&&(b=j)):b=c(b,w)===g?j:b._4e_previousSourceNode(w,k,c,void 0)):(b=i.startContainer,b=new o(b[0].childNodes[i.startOffset]),b.length?c(b[0])===g&&(b=j):b=c(i.startContainer,w)===g?j:i.startContainer._4e_nextSourceNode(w,
k,c,void 0));for(;b&&!this._.end;){this.current=b;if(!this.evaluator||this.evaluator(b[0])!==g){if(!d)return b}else if(d&&this.evaluator)return g;b=b[v](g,k,c)}this.end();return this.current=j}function p(a){for(var d,b=j;d=s.call(this,a);)b=d;return b}function q(a){this.range=a;this.guard=this.evaluator=j;this._={}}var w=!0,g=!1,j=null,l=a.UA,r=a.DOM,t=m.XHTML_DTD,o=a.Node;a.augment(q,{end:function(){this._.end=1},next:function(){return s.call(this)},previous:function(){return s.call(this,w)},checkForward:function(){return s.call(this,
g,w)!==g},checkBackward:function(){return s.call(this,w,w)!==g},lastForward:function(){return p.call(this)},lastBackward:function(){return p.call(this,w)},reset:function(){delete this.current;this._={}},_iterator:s});a.mix(q,{blockBoundary:function(a){return function(d){return!(d.nodeType==r.NodeType.ELEMENT_NODE&&r._4e_isBlockBoundary(d,a))}},bookmark:function(a,d){function b(a){return"span"==r.nodeName(a)&&r.attr(a,"_ke_bookmark")}return function(i){var c,f;c=i.nodeType==r.NodeType.TEXT_NODE&&(f=
i.parentNode)&&b(f);c=a?c:c||b(i);return!!(d^c)}},whitespaces:function(e){return function(d){d=d.nodeType==r.NodeType.TEXT_NODE&&!a.trim(d.nodeValue);return!!(e^d)}},invisible:function(a){var d=q.whitespaces();return function(b){b=d(b)||b.nodeType==r.NodeType.ELEMENT_NODE&&!b.offsetHeight;return!!(a^b)}}});var x=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,y=q.whitespaces(),h=q.bookmark(),n=function(a){var d=r.nodeName(a);return h(a)||y(a)||1==a.nodeType&&d in t.$inline&&!(d in t.$empty)};m.Utils.injectDom({_4e_getBogus:function(a){a=
new o(a);do a=a._4e_previousSourceNode();while(a&&n(a[0]));return a&&(!l.ie?"br"==a.nodeName():3==a[0].nodeType&&x.test(a.text()))?a[0]:!1}});return m.Walker=q},{requires:["./base","./utils","./dom","node"]});
KISSY.add("editor/elementPath",function(a,m){function s(a){for(var r=w,t=w,o=[];a;){if(a[0].nodeType==p.NodeType.ELEMENT_NODE){this.lastElement||(this.lastElement=a);var m=a.nodeName();if(!t&&(!r&&g[m]&&(r=a),j[m])){var s;if(s=!r)if(s="div"==m){a:{s=a[0].childNodes;for(var h=0,n=s.length;h<n;h++){var e=s[h];if(e.nodeType==p.NodeType.ELEMENT_NODE&&q.$block[e.nodeName.toLowerCase()]){s=!0;break a}}s=!1}s=!s}s?r=a:t=a}o.push(a);if("body"==m)break}a=a.parent()}this.block=r;this.blockLimit=t;this.elements=
o}var p=a.DOM,q=m.XHTML_DTD,w=null,g={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},j={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};s.prototype={constructor:s,compare:function(a){var g=this.elements,a=a&&a.elements;if(!a||g.length!=a.length)return!1;for(var j=0;j<g.length;j++)if(!p.equals(g[j],a[j]))return!1;return!0},contains:function(a){for(var g=this.elements,j=0;j<g.length;j++)if(g[j].nodeName()in a)return g[j];return w},toString:function(){var a=
this.elements,g,j=[];for(g=0;g<a.length;g++)j.push(a[g].nodeName());return j.toString()}};return m.ElementPath=s},{requires:["./base","./dom","node"]});
KISSY.add("editor/range",function(a,m,s,p,q){function w(c){var d=c.nodeType!=e.NodeType.TEXT_NODE&&e.nodeName(c)in b.$removeEmpty,i=c.nodeType==e.NodeType.TEXT_NODE&&!a.trim(c.nodeValue),c=!!c.parentNode.getAttribute("_ke_bookmark");return d||i||c}function g(a){return!v(a)&&!B(a)}function j(b){var c=x;return function(i){if(B(i))return o;if(i.nodeType==e.NodeType.TEXT_NODE){if(a.trim(i.nodeValue).length)return x}else if(i.nodeType==e.NodeType.ELEMENT_NODE&&(i=e.nodeName(i),!G[i]))if(!b&&!d.ie&&"br"==
i&&!c)c=o;else return x;return o}}function l(a,b){var c=a.startContainer,u=a.endContainer,d=a.startOffset,k=a.endOffset,h,v=x,g=x,j=void 0,n=a.document,R;0<b&&(j=n.createDocumentFragment());if(a.collapsed)return j;a.optimizeBookmark();u[0].nodeType==e.NodeType.TEXT_NODE?(g=o,u=u._4e_splitText(k)):0<u[0].childNodes.length&&(k>=u[0].childNodes.length?(u=new i(u[0].appendChild(n.createTextNode(""))),R=o):u=new i(u[0].childNodes[k]));c[0].nodeType==e.NodeType.TEXT_NODE?(v=o,c._4e_splitText(d)):d?d>=c[0].childNodes.length?
(c=new i(c[0].appendChild(n.createTextNode(""))),h=o):c=new i(c[0].childNodes[d].previousSibling):(h=new i(n.createTextNode("")),c.prepend(h),c=h,h=o);var I=c._4e_parents(),K=u._4e_parents();I.each(function(a,b){I[b]=a});K.each(function(a,b){K[b]=a});for(var F,O,n=0;n<I.length&&!(F=I[n],O=K[n],!F.equals(O));n++);for(var d=j,z,l,B=n;B<I.length;B++){z=I[B];k=0<b&&!z.equals(c)?d.appendChild(z.clone()[0]):null;z=z[0].nextSibling;l=K[B];for(var m=u[0],q=l&&l[0];z&&!(q==z||m==z);){l=z.nextSibling;if(2==
b)d.appendChild(z.cloneNode(o));else{if(f[z.nodeName.toLowerCase()]){var p=z.cloneNode(o);z.innerHTML="";z=p}else e._4e_remove(z);1==b&&d.appendChild(z)}z=l}k&&(d=k)}for(d=j;n<K.length;n++){z=K[n];k=0<b&&!z.equals(u)?d.appendChild(z.clone()[0]):null;if(!I[n]||!z._4e_sameLevel(I[n]))for(z=z[0].previousSibling;z;)l=z.previousSibling,2==b?d.insertBefore(z.cloneNode(o),d.firstChild):(e._4e_remove(z),1==b&&d.insertBefore(z,d.firstChild)),z=l;k&&(d=k)}if(2==b){if(v&&(F=c[0],F.nodeType==e.NodeType.TEXT_NODE&&
F.nextSibling&&F.nextSibling.nodeType==e.NodeType.TEXT_NODE&&(F.data+=F.nextSibling.data,F.parentNode.removeChild(F.nextSibling))),g)g=u[0],g.nodeType==e.NodeType.TEXT_NODE&&g.previousSibling&&g.previousSibling.nodeType==e.NodeType.TEXT_NODE&&(g.previousSibling.data+=g.data,g.parentNode.removeChild(g))}else{if(F&&O&&(!c._4e_sameLevel(F)||!u._4e_sameLevel(O)))g=F._4e_index(),h&&F._4e_sameLevel(c)&&g--,a.setStart(F.parent(),g+1);a.collapse(o)}h&&c.remove();R&&u.remove();return j}function r(a){a.collapsed=
a.startContainer&&a.endContainer&&a.startContainer[0]==a.endContainer[0]&&a.startOffset==a.endOffset}function t(a){this.endOffset=this.endContainer=this.startOffset=this.startContainer=y;this.collapsed=o;this.document=a}m.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var o=!0,x=!1,y=null,h=m.RANGE,n=m.POSITION,e=a.DOM,d=a.UA,b=m.XHTML_DTD,
i=a.Node,c=i.all,f={td:1},k={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},v=new p.whitespaces,B=new p.bookmark,D=p.whitespaces(o),A=p.bookmark(!1,!0),G={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};a.augment(t,{toString:function(){var a=[],b=this.startContainer[0],c=this.endContainer[0];a.push((b.id||b.nodeName)+":"+this.startOffset);a.push((c.id||c.nodeName)+
":"+this.endOffset);return a.join("<br/>")},optimize:function(){var a=this.startContainer,b=this.startOffset;a[0].nodeType!=e.NodeType.ELEMENT_NODE&&(b?b>=a[0].nodeValue.length&&this.setStartAfter(a):this.setStartBefore(a));a=this.endContainer;b=this.endOffset;a[0].nodeType!=e.NodeType.ELEMENT_NODE&&(b?b>=a[0].nodeValue.length&&this.setEndAfter(a):this.setEndBefore(a))},setStartAfter:function(a){this.setStart(a.parent(),a._4e_index()+1)},setStartBefore:function(a){this.setStart(a.parent(),a._4e_index())},
setEndAfter:function(a){this.setEnd(a.parent(),a._4e_index()+1)},setEndBefore:function(a){this.setEnd(a.parent(),a._4e_index())},optimizeBookmark:function(){var a=this.startContainer,b=this.endContainer;a&&"span"==a.nodeName()&&a.attr("_ke_bookmark")&&this.setStartBefore(a);b&&"span"==b.nodeName()&&b.attr("_ke_bookmark")&&this.setEndAfter(b)},setStart:function(a,b){a[0].nodeType==e.NodeType.ELEMENT_NODE&&k[a.nodeName()]&&(a=a.parent(),b=a._4e_index());this.startContainer=a;this.startOffset=b;this.endContainer||
(this.endContainer=a,this.endOffset=b);r(this)},setEnd:function(a,b){a[0].nodeType==e.NodeType.ELEMENT_NODE&&k[a.nodeName()]&&(a=a.parent(),b=a._4e_index()+1);this.endContainer=a;this.endOffset=b;this.startContainer||(this.startContainer=a,this.startOffset=b);r(this)},setStartAt:function(a,b){switch(b){case h.POSITION_AFTER_START:this.setStart(a,0);break;case h.POSITION_BEFORE_END:a[0].nodeType==e.NodeType.TEXT_NODE?this.setStart(a,a[0].nodeValue.length):this.setStart(a,a[0].childNodes.length);break;
case h.POSITION_BEFORE_START:this.setStartBefore(a);break;case h.POSITION_AFTER_END:this.setStartAfter(a)}r(this)},setEndAt:function(a,b){switch(b){case h.POSITION_AFTER_START:this.setEnd(a,0);break;case h.POSITION_BEFORE_END:a[0].nodeType==e.NodeType.TEXT_NODE?this.setEnd(a,a[0].nodeValue.length):this.setEnd(a,a[0].childNodes.length);break;case h.POSITION_BEFORE_START:this.setEndBefore(a);break;case h.POSITION_AFTER_END:this.setEndAfter(a)}r(this)},cloneContents:function(){return l(this,2)},deleteContents:function(){return l(this,
0)},extractContents:function(){return l(this,1)},collapse:function(a){a?(this.endContainer=this.startContainer,this.endOffset=this.startOffset):(this.startContainer=this.endContainer,this.startOffset=this.endOffset);this.collapsed=o},clone:function(){var a=new t(this.document);a.startContainer=this.startContainer;a.startOffset=this.startOffset;a.endContainer=this.endContainer;a.endOffset=this.endOffset;a.collapsed=this.collapsed;return a},getEnclosedNode:function(){var a=this.clone();a.optimize();
if(a.startContainer[0].nodeType!=e.NodeType.ELEMENT_NODE||a.endContainer[0].nodeType!=e.NodeType.ELEMENT_NODE)return y;var b=new p(a);b.evaluator=function(a){return D(a)&&A(a)};a=b.next();b.reset();b=b.previous();return a&&a.equals(b)?a:y},shrink:function(a,b){if(!this.collapsed){var a=a||h.SHRINK_TEXT,c=this.clone(),u=this.startContainer,d=this.endContainer,i=this.startOffset,f=this.endOffset,k=o,g,v,j=o;u&&u[0].nodeType==e.NodeType.TEXT_NODE&&(i?i>=u[0].nodeValue.length?c.setStartAfter(u):(c.setStartBefore(u),
k=x):c.setStartBefore(u));d&&d[0].nodeType==e.NodeType.TEXT_NODE&&(f?f>=d[0].nodeValue.length?c.setEndAfter(d):(c.setEndAfter(d),j=x):c.setEndBefore(d));if(k||j)v=new p(c),v.evaluator=function(b){return b.nodeType==(a==h.SHRINK_ELEMENT?e.NodeType.ELEMENT_NODE:e.NodeType.TEXT_NODE)},v.guard=function(b,c){if(a==h.SHRINK_ELEMENT&&b.nodeType==e.NodeType.TEXT_NODE||c&&b==g)return x;!c&&b.nodeType==e.NodeType.ELEMENT_NODE&&(g=b);return o};k&&(c=v[a==h.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(c,
b?h.POSITION_AFTER_START:h.POSITION_BEFORE_START);j&&(v.reset(),(v=v[a==h.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(v,b?h.POSITION_BEFORE_END:h.POSITION_AFTER_END));return k||j}},createBookmark2:function(a){var b=this.startContainer,c=this.endContainer,u=this.startOffset,d=this.endOffset,f,k;if(!b||!c)return{start:0,end:0};if(a){if(b[0].nodeType==e.NodeType.ELEMENT_NODE&&(f=new i(b[0].childNodes[u]))&&f[0]&&f[0].nodeType==e.NodeType.TEXT_NODE&&0<u&&f[0].previousSibling.nodeType==
e.NodeType.TEXT_NODE)b=f,u=0;for(;b[0].nodeType==e.NodeType.TEXT_NODE&&(k=b.prev(void 0,1))&&k[0].nodeType==e.NodeType.TEXT_NODE;)b=k,u+=k[0].nodeValue.length;if(!this.collapsed){if(c[0].nodeType==e.NodeType.ELEMENT_NODE&&(f=new i(c[0].childNodes[d]))&&f[0]&&f[0].nodeType==e.NodeType.TEXT_NODE&&0<d&&f[0].previousSibling.nodeType==e.NodeType.TEXT_NODE)c=f,d=0;for(;c[0].nodeType==e.NodeType.TEXT_NODE&&(k=c.prev(void 0,1))&&k[0].nodeType==e.NodeType.TEXT_NODE;)c=k,d+=k[0].nodeValue.length}}return{start:b._4e_address(a),
end:this.collapsed?y:c._4e_address(a),startOffset:u,endOffset:d,normalized:a,is2:o}},createBookmark:function(b){var c,d,u,f,e=this.collapsed;c=new i("<span>",y,this.document);c.attr("_ke_bookmark",1);c.css("display","none");c.html("&nbsp;");b&&(u=a.guid("ke_bm_"),c.attr("id",u+"S"));e||(d=c.clone(),d.html("&nbsp;"),b&&d.attr("id",u+"E"),f=this.clone(),f.collapse(),f.insertNode(d));f=this.clone();f.collapse(o);f.insertNode(c);d?(this.setStartAfter(c),this.setEndBefore(d)):this.moveToPosition(c,h.POSITION_AFTER_END);
return{startNode:b?u+"S":c,endNode:b?u+"E":d,serializable:b,collapsed:e}},moveToPosition:function(a,b){this.setStartAt(a,b);this.collapse(o)},trim:function(a,b){var c=this.startContainer,d=this.startOffset,i=this.collapsed;if((!a||i)&&c[0]&&c[0].nodeType==e.NodeType.TEXT_NODE){if(d)if(d>=c[0].nodeValue.length)d=c._4e_index()+1,c=c.parent();else{var f=c._4e_splitText(d),d=c._4e_index()+1,c=c.parent();e.equals(this.startContainer,this.endContainer)?this.setEnd(f,this.endOffset-this.startOffset):e.equals(c,
this.endContainer)&&(this.endOffset+=1)}else d=c._4e_index(),c=c.parent();this.setStart(c,d);if(i){this.collapse(o);return}}c=this.endContainer;d=this.endOffset;!b&&!i&&c[0]&&c[0].nodeType==e.NodeType.TEXT_NODE&&(d?(d>=c[0].nodeValue.length||c._4e_splitText(d),d=c._4e_index()+1):d=c._4e_index(),c=c.parent(),this.setEnd(c,d))},insertNode:function(a){this.optimizeBookmark();this.trim(x,o);var b=this.startContainer;b[0].insertBefore(a[0],b[0].childNodes[this.startOffset]||null);b[0]==this.endContainer[0]&&
this.endOffset++;this.setStartBefore(a)},moveToBookmark:function(b){var d=c(this.document);if(b.is2){var i=d._4e_getByAddress(b.start,b.normalized),u=b.startOffset,d=b.end&&d._4e_getByAddress(b.end,b.normalized),b=b.endOffset;this.setStart(i,u);d?this.setEnd(d,b):this.collapse(o)}else i=(u=b.serializable)?a.one("#"+b.startNode,d):b.startNode,b=u?a.one("#"+b.endNode,d):b.endNode,this.setStartBefore(i),i._4e_remove(),b&&b[0]?(this.setEndBefore(b),b._4e_remove()):this.collapse(o)},getCommonAncestor:function(a,
b){var c=this.startContainer,d=this.endContainer,c=c[0]==d[0]?a&&c[0].nodeType==e.NodeType.ELEMENT_NODE&&this.startOffset==this.endOffset-1?new i(c[0].childNodes[this.startOffset]):c:c._4e_commonAncestor(d);return b&&c[0].nodeType==e.NodeType.TEXT_NODE?c.parent():c},enlarge:function(){function a(b,d,u,i){var f=b[d?"startContainer":"endContainer"],k,g=d?0:1,h=0,j=d?"previousSibling":"nextSibling";k=b[d?"startOffset":"endOffset"];if(f[0].nodeType==e.NodeType.TEXT_NODE){if(d){if(k)return}else if(k<f[0].nodeValue.length)return;
k=f[0][j];f=f[0].parentNode}else k=f[0].childNodes[k+(d?-1:1)]||null,f=f[0];for(;f;){for(;k;)if(v(k)||B(k))k=k[j];else break;if(k){if(!h)b[d?"setStartAfter":"setEndBefore"](c(k));break}f=c(f);if("body"==f.nodeName())break;if(h||f.equals(i))u[g]=f,h=1;else b[d?"setStartBefore":"setEndAfter"](f);k=f[0][j];f=f[0].parentNode}}return function(b){switch(b){case h.ENLARGE_ELEMENT:if(this.collapsed)break;var b=this.getCommonAncestor(),d=[];a(this,1,d,b);a(this,0,d,b);d[0]&&d[1]&&(b=d[0].contains(d[1])?d[1]:
d[0],this.setStartBefore(b),this.setEndAfter(b));break;case h.ENLARGE_BLOCK_CONTENTS:case h.ENLARGE_LIST_ITEM_CONTENTS:var f=new t(this.document),d=new i(this.document.body);f.setStartAt(d,h.POSITION_AFTER_START);f.setEnd(this.startContainer,this.startOffset);var f=new p(f),k,g,v=p.blockBoundary(b==h.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:y),j=function(a){var b=v(a);b||(k=c(a));return b},n=function(a){var b=j(a);!b&&"br"==e.nodeName(a)&&(g=c(a));return b};f.guard=j;f=f.lastBackward();k=k||d;this.setStartAt(k,
"br"!=k.nodeName()&&(!f&&this.checkStartOfBlock()||f&&k.contains(f))?h.POSITION_AFTER_START:h.POSITION_AFTER_END);f=this.clone();f.collapse();f.setEndAt(d,h.POSITION_BEFORE_END);f=new p(f);f.guard=b==h.ENLARGE_LIST_ITEM_CONTENTS?n:j;k=y;f=f.lastForward();k=k||d;this.setEndAt(k,!f&&this.checkEndOfBlock()||f&&k.contains(f)?h.POSITION_BEFORE_END:h.POSITION_BEFORE_START);g&&this.setEndAfter(g)}}}(),checkStartOfBlock:function(){var b=this.startContainer,c=this.startOffset;if(c&&b[0].nodeType==e.NodeType.TEXT_NODE&&
a.trim(b[0].nodeValue.substring(0,c)).length)return x;this.trim();b=new q(this.startContainer);c=this.clone();c.collapse(o);c.setStartAt(b.block||b.blockLimit,h.POSITION_AFTER_START);b=new p(c);b.evaluator=j(o);return b.checkBackward()},checkEndOfBlock:function(){var b=this.endContainer,c=this.endOffset;if(b[0].nodeType==e.NodeType.TEXT_NODE&&a.trim(b[0].nodeValue.substring(c)).length)return x;this.trim();b=new q(this.endContainer);c=this.clone();c.collapse(x);c.setEndAt(b.block||b.blockLimit,h.POSITION_BEFORE_END);
b=new p(c);b.evaluator=j(x);return b.checkForward()},checkBoundaryOfElement:function(a,b){var c=this.clone();c[b==h.START?"setStartAt":"setEndAt"](a,b==h.START?h.POSITION_AFTER_START:h.POSITION_BEFORE_END);c=new p(c);c.evaluator=w;return c[b==h.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var a=this.startContainer,b=this.endContainer,d=this.startOffset,f=this.endOffset,i;if(a[0].nodeType==e.NodeType.ELEMENT_NODE)if(i=a[0].childNodes.length,i>d)a=c(a[0].childNodes[d]);else if(0==
i)a=a._4e_previousSourceNode();else{for(a=a[0];a.lastChild;)a=a.lastChild;a=c(a);a=a._4e_nextSourceNode()||a}if(b[0].nodeType==e.NodeType.ELEMENT_NODE)if(i=b[0].childNodes.length,i>f)b=c(b[0].childNodes[f])._4e_previousSourceNode(o);else if(0==i)b=b._4e_previousSourceNode();else{for(b=b[0];b.lastChild;)b=b.lastChild;b=c(b)}a._4e_position(b)&n.POSITION_FOLLOWING&&(a=b);return{startNode:a,endNode:b}},fixBlock:function(a,b){var f=this.createBookmark(),i=c(this.document.createElement(b));this.collapse(a);
this.enlarge(h.ENLARGE_BLOCK_CONTENTS);i[0].appendChild(this.extractContents());i._4e_trim();d.ie||i._4e_appendBogus();this.insertNode(i);this.moveToBookmark(f);return i},splitBlock:function(b){var c=new q(this.startContainer),f=new q(this.endContainer),i=c.block,k=f.block,e=y;if(!c.blockLimit.equals(f.blockLimit))return y;"br"!=b&&(i||(i=this.fixBlock(o,b),k=(new q(this.endContainer)).block),k||(k=this.fixBlock(x,b)));b=i&&this.checkStartOfBlock();c=k&&this.checkEndOfBlock();this.deleteContents();
i&&i[0]==k[0]&&(c?(e=new q(this.startContainer),this.moveToPosition(k,h.POSITION_AFTER_END),k=y):b?(e=new q(this.startContainer),this.moveToPosition(i,h.POSITION_BEFORE_START),i=y):(k=this.splitElement(i),!d.ie&&!a.inArray(i.nodeName(),["ul","ol"])&&i._4e_appendBogus()));return{previousBlock:i,nextBlock:k,wasStartOfBlock:b,wasEndOfBlock:c,elementPath:e}},splitElement:function(a){if(!this.collapsed)return y;this.setEndAt(a,h.POSITION_BEFORE_END);var b=this.extractContents(),c=a.clone(x);c[0].appendChild(b);
c.insertAfter(a);this.moveToPosition(a,h.POSITION_AFTER_END);return c},moveToElementEditablePosition:function(a,b){for(var c=0;a;){if(a[0].nodeType==e.NodeType.TEXT_NODE){this.moveToPosition(a,b?h.POSITION_AFTER_END:h.POSITION_BEFORE_START);c=1;break}a[0].nodeType==e.NodeType.ELEMENT_NODE&&a._4e_isEditable()&&(this.moveToPosition(a,b?h.POSITION_BEFORE_END:h.POSITION_AFTER_START),c=1);var d=a,f=c,i=void 0;d[0].nodeType==e.NodeType.ELEMENT_NODE&&d._4e_isEditable()&&(i=d[b?"last":"first"](g,1));!f&&
!i&&(i=d[b?"prev":"next"](g,1));a=i}return!!c},selectNodeContents:function(a){var b=a[0];this.setStart(a,0);this.setEnd(a,b.nodeType==e.NodeType.TEXT_NODE?b.nodeValue.length:b.childNodes.length)},insertNodeByDtd:function(a){var c,d,f,i=a.nodeName();c=b.$block[i];this.deleteContents();if(c){for(c=this.getCommonAncestor(x,o);(d=b[c.nodeName()])&&(!d||!d[i]);){var k=c.parent();this.checkStartOfBlock()&&this.checkEndOfBlock()?(this.setStartBefore(c),this.collapse(o),c.remove()):f=c;c=k}f&&this.splitElement(f)}this.insertNode(a)}});
s.injectDom({_4e_breakParent:function(a,b){var b=c(b),a=c(a),d,f=new m.Range(a[0].ownerDocument);f.setStartAfter(a);f.setEndAfter(b);d=f.extractContents();f.insertNode(a.remove());a.after(d)}});return m.Range=t},{requires:"./base,./utils,./walker,./elementPath,./dom,node".split(",")});
KISSY.add("editor/selection",function(a,m){function s(a){this.document=a;this._={cache:{}};if(o)try{var d=this.getNative().createRange();if(!d||d.item&&d.item(0).ownerDocument!=a||d.parentElement&&d.parentElement().ownerDocument!=a)this.isInvalid=q}catch(c){this.isInvalid=q}}function p(a){a=new s(a);return!a||a.isInvalid?w:a}m.SELECTION={SELECTION_NONE:1,SELECTION_TEXT:2,SELECTION_ELEMENT:3};var q=!0,w=null,g=a.UA,j=a.DOM,l=a.Node,r=m.SELECTION,t=m.RANGE,o=g.ie,x=m.Walker,y=m.Range,h={img:1,hr:1,
li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};a.augment(s,{getNative:!o?function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=j.getWindow(this.document).getSelection())}:function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=this.document.selection)},getType:!o?function(){var a=this._.cache;if(a.type)return a.type;var d=r.SELECTION_TEXT,c=this.getNative();if(c){if(1==c.rangeCount){var c=c.getRangeAt(0),
f=c.startContainer;f==c.endContainer&&f.nodeType==j.NodeType.ELEMENT_NODE&&1==Number(c.endOffset-c.startOffset)&&h[f.childNodes[c.startOffset].nodeName.toLowerCase()]&&(d=r.SELECTION_ELEMENT)}}else d=r.SELECTION_NONE;return a.type=d}:function(){var a=this._.cache;if(a.type)return a.type;var d=r.SELECTION_NONE;try{var c=this.getNative(),f=c.type;"Text"==f&&(d=r.SELECTION_TEXT);"Control"==f&&(d=r.SELECTION_ELEMENT);c.createRange().parentElement&&(d=r.SELECTION_TEXT)}catch(k){}return a.type=d},getRanges:o?
function(){var a=function(a,b){a=a.duplicate();a.collapse(b);for(var d=a.parentElement(),k=d.childNodes,e,g=0;g<k.length;g++){var h=k[g];if(h.nodeType==j.NodeType.ELEMENT_NODE){e=a.duplicate();e.moveToElementText(h);var h=e.compareEndPoints("StartToStart",a),n=e.compareEndPoints("EndToStart",a);e.collapse();if(0<h)break;else{if(!h||1==n&&-1==h)return{container:d,offset:g};if(!n)return{container:d,offset:g+1}}e=w}}e||(e=a.duplicate(),e.moveToElementText(d),e.collapse(!1));e.setEndPoint("StartToStart",
a);e=(""+e.text).replace(/\r\n|\r/g,"\n").length;try{for(;0<e;)e-=k[--g].nodeValue.length}catch(o){e=0}return 0===e?{container:d,offset:g}:{container:k[g],offset:-e}};return function(d){var c=this._.cache;if(c.ranges&&!d)return c.ranges;var f=this.getNative(),d=f&&f.createRange(),e=this.getType();if(!f)return[];if(e==r.SELECTION_TEXT)return f=new y(this.document),e=a(d,q),f.setStart(new l(e.container),e.offset),e=a(d),f.setEnd(new l(e.container),e.offset),c.ranges=[f];if(e==r.SELECTION_ELEMENT){c=
c.ranges=[];for(e=0;e<d.length;e++){for(var g=d.item(e),h=g.parentNode,j=0,f=new y(this.document);j<h.childNodes.length&&h.childNodes[j]!=g;j++);f.setStart(new l(h),j);f.setEnd(new l(h),j+1);c.push(f)}return c}return c.ranges=[]}}():function(a){var d=this._.cache;if(d.ranges&&!a)return d.ranges;var a=[],c=this.getNative();if(!c)return[];for(var f=0;f<c.rangeCount;f++){var e=c.getRangeAt(f),g=new y(this.document);g.setStart(new l(e.startContainer),e.startOffset);g.setEnd(new l(e.endContainer),e.endOffset);
a.push(g)}return d.ranges=a},getStartElement:function(){var a=this._.cache;if(void 0!==a.startElement)return a.startElement;var d,c=this.getNative();switch(this.getType()){case r.SELECTION_ELEMENT:return this.getSelectedElement();case r.SELECTION_TEXT:var f=this.getRanges()[0];if(f&&!f.collapsed){for(f.optimize();q;)if(d=f.startContainer,f.startOffset==(d[0].nodeType===j.NodeType.ELEMENT_NODE?d[0].childNodes.length:d[0].nodeValue.length)&&!d._4e_isBlockBoundary())f.setStartAfter(d);else break;d=f.startContainer;
if(d[0].nodeType!=j.NodeType.ELEMENT_NODE)return d.parent();d=new l(d[0].childNodes[f.startOffset]);if(!d[0]||d[0].nodeType!=j.NodeType.ELEMENT_NODE)return f.startContainer;for(f=d[0].firstChild;f&&f.nodeType==j.NodeType.ELEMENT_NODE;)d=new l(f),f=f.firstChild;return d}if(o)f=c.createRange(),f.collapse(q),d=new l(f.parentElement());else{if((d=c.anchorNode)&&d.nodeType!=j.NodeType.ELEMENT_NODE)d=d.parentNode;d&&(d=new l(d))}}return a.startElement=d},getSelectedElement:function(){var a,d=this._.cache;
if(void 0!==d.selectedElement)return d.selectedElement;o&&(a=this.getNative().createRange(),a=a.item&&a.item(0));var c;if(a)c=new l(a);else{a=this.getRanges()[0];for(var f,e=2;e&&(!(c=a.getEnclosedNode())||!(c[0].nodeType==j.NodeType.ELEMENT_NODE&&h[c.nodeName()]&&(f=c)));e--)a.shrink(t.SHRINK_ELEMENT);c=f}return d.selectedElement=c},reset:function(){this._.cache={}},selectElement:function(a){var d,c=this.document;if(o)try{d=c.body.createControlRange(),d.addElement(a[0]),d.select()}catch(f){d=c.body.createTextRange(),
d.moveToElementText(a[0]),d.select()}finally{}else d=c.createRange(),d.selectNode(a[0]),a=this.getNative(),a.removeAllRanges(),a.addRange(d);this.reset()},selectRanges:function(a){if(o){if(1<a.length){var d=a[a.length-1];a[0].setEnd(d.endContainer,d.endOffset);a.length=1}a[0]&&a[0].select()}else{d=this.getNative();if(!d)return;d.removeAllRanges();for(var c=0;c<a.length;c++){var f=a[c],e=this.document.createRange(),h=f.startContainer;if(f.collapsed&&(g.gecko&&1.09>g.gecko||g.opera||g.webkit)&&h[0].nodeType==
j.NodeType.ELEMENT_NODE&&!h[0].childNodes.length)h[0].appendChild(this.document.createTextNode(g.webkit?"\u200b":"")),f.startOffset++,f.endOffset++;e.setStart(h[0],f.startOffset);e.setEnd(f.endContainer[0],f.endOffset);d.addRange(e)}}this.reset()},createBookmarks2:function(a){for(var d=[],c=this.getRanges(),f=0;f<c.length;f++)d.push(c[f].createBookmark2(a));return d},createBookmarks:function(d,e){for(var c=[],f=this.document,k,e=e||this.getRanges(),g=e.length,h=0;h<g;h++){c.push(k=e[h].createBookmark(d,
q));var n=(d=k.serializable)?a.one("#"+k.startNode,f):k.startNode;k=d?a.one("#"+k.endNode,f):k.endNode;for(var o=h+1;o<g;o++){var l=e[o],m=l.startContainer,p=l.endContainer;j.equals(m,n.parent())&&l.startOffset++;j.equals(m,k.parent())&&l.startOffset++;j.equals(p,n.parent())&&l.endOffset++;j.equals(p,k.parent())&&l.endOffset++}}return c},selectBookmarks:function(a){for(var d=[],c=0;c<a.length;c++){var f=new y(this.document);f.moveToBookmark(a[c]);d.push(f)}this.selectRanges(d);return this},getCommonAncestor:function(){var a=
this.getRanges();return a[0].startContainer._4e_commonAncestor(a[a.length-1].endContainer)},scrollIntoView:function(){var a=this.getStartElement();a&&a.scrollIntoView(void 0,{alignWithTop:!1,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0})},removeAllRanges:function(){var a=this.getNative();o?a&&a.clear():a&&a.removeAllRanges()}});var n={table:1,tbody:1,tr:1},e=x.whitespaces(q),d=/\ufeff|\u00a0/;y.prototype.select=y.prototype.select=!o?function(){var a=this.startContainer;this.collapsed&&a[0].nodeType==
j.NodeType.ELEMENT_NODE&&!a[0].childNodes.length&&(a[0].appendChild(this.document.createTextNode(g.webkit?"\u200b":"")),this.startOffset++,this.endOffset++);var d=this.document.createRange();d.setStart(a[0],this.startOffset);try{d.setEnd(this.endContainer[0],this.endOffset)}catch(c){if(0<=c.toString().indexOf("NS_ERROR_ILLEGAL_VALUE"))this.collapse(q),d.setEnd(this.endContainer[0],this.endOffset);else throw c;}a=p(this.document).getNative();a.removeAllRanges();a.addRange(d)}:function(a){var i=this.collapsed,
c,f;if(this.startContainer[0]===this.endContainer[0]&&1==this.endOffset-this.startOffset){var k=this.startContainer[0].childNodes[this.startOffset];if(k.nodeType==j.NodeType.ELEMENT_NODE){(new s(this.document)).selectElement(new l(k));return}}(this.startContainer[0].nodeType==j.NodeType.ELEMENT_NODE&&this.startContainer.nodeName()in n||this.endContainer[0].nodeType==j.NodeType.ELEMENT_NODE&&this.endContainer.nodeName()in n)&&this.shrink(t.SHRINK_ELEMENT,q);var g=this.createBookmark(),k=g.startNode,
h;i||(h=g.endNode);g=this.document.body.createTextRange();g.moveToElementText(k[0]);g.moveStart("character",1);if(h)a=this.document.body.createTextRange(),a.moveToElementText(h[0]),g.setEndPoint("EndToEnd",a),g.moveEnd("character",-1);else{for(c=k[0].nextSibling;c&&!e(c);)c=c.nextSibling;c=!(c&&c.nodeValue&&c.nodeValue.match(d))&&(a||!k[0].previousSibling||k[0].previousSibling&&"br"==j.nodeName(k[0].previousSibling));f=new l(this.document.createElement("span"));f.html("&#65279;");f.insertBefore(k);
c&&j.insertBefore(this.document.createTextNode("\ufeff"),k[0]||k)}this.setStartBefore(k);k._4e_remove();if(i){if(c?(g.moveStart("character",-1),g.select(),this.document.selection.clear()):g.select(),f)this.moveToPosition(f,t.POSITION_BEFORE_START),f._4e_remove()}else this.setEndBefore(h),h._4e_remove(),g.select()};s.getSelection=p;return m.Selection=s},{requires:["./base","./walker","./range","./dom","node"]});
KISSY.add("editor/domIterator",function(a,m){function s(a){1>arguments.length||(this.range=a,this.forceBrBreak=q,this.enlargeBr=p,this.enforceRealBlocks=q,this._||(this._={}))}var p=!0,q=!1,w=a.UA,g=m.Walker,j=m.Range,l=m.RANGE,r=m.ElementPath,t=a.Node,o=a.DOM,x=/^[\r\n\t ]*$/;a.augment(s,{getNextParagraph:function(m){var h,n,e,d,b;if(!this._.lastNode){n=this.range.clone();n.shrink(l.SHRINK_ELEMENT,p);n.enlarge(this.forceBrBreak||!this.enlargeBr?l.ENLARGE_LIST_ITEM_CONTENTS:l.ENLARGE_BLOCK_CONTENTS);
var i=new g(n),c=g.bookmark(p,p);i.evaluator=c;this._.nextNode=i.next();i=new g(n);i.evaluator=c;i=i.previous();this._.lastNode=i._4e_nextSourceNode(p);this._.lastNode&&this._.lastNode[0].nodeType==o.NodeType.TEXT_NODE&&!a.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()&&(c=new j(n.document),c.moveToPosition(this._.lastNode,l.POSITION_AFTER_END),c.checkEndOfBlock()&&(c=new r(c.endContainer),this._.lastNode=(c.block||c.blockLimit)._4e_nextSourceNode(p)));this._.lastNode||
(this._.lastNode=this._.docEndMarker=new t(n.document.createTextNode("")),o.insertAfter(this._.lastNode[0],i[0]));n=null}c=this._.nextNode;i=this._.lastNode;for(this._.nextNode=null;c;){var f=q,k=c[0].nodeType!=o.NodeType.ELEMENT_NODE,v=q;if(k)c[0].nodeType==o.NodeType.TEXT_NODE&&x.test(c[0].nodeValue)&&(k=q);else{var s=c.nodeName();if(c._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if("br"==s)k=p;else if(!n&&!c[0].childNodes.length&&"hr"!=s){h=c;e=c.equals(i);break}n&&(n.setEndAt(c,l.POSITION_BEFORE_START),
"br"!=s&&(this._.nextNode=c));f=p}else{if(c[0].firstChild){n||(n=new j(this.range.document),n.setStartAt(c,l.POSITION_BEFORE_START));c=new t(c[0].firstChild);continue}k=p}}k&&!n&&(n=new j(this.range.document),n.setStartAt(c,l.POSITION_BEFORE_START));e=(!f||k)&&c.equals(i);if(n&&!f)for(;!c[0].nextSibling&&!e;){s=c.parent();if(s._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){f=p;e||s.equals(i);break}c=s;k=p;e=c.equals(i);v=p}k&&n.setEndAt(c,l.POSITION_AFTER_END);c=c._4e_nextSourceNode(v,null,i);if((e=
!c)||f&&n)break}if(!h){if(!n)return this._.docEndMarker&&this._.docEndMarker._4e_remove(),this._.nextNode=null;h=new r(n.startContainer);c=h.blockLimit;f={div:1,th:1,td:1};h=h.block;if((!h||!h[0])&&!this.enforceRealBlocks&&f[c.nodeName()]&&n.checkStartOfBlock()&&n.checkEndOfBlock())h=c;else if(!h||this.enforceRealBlocks&&"li"==h.nodeName())h=new t(this.range.document.createElement(m||"p")),h[0].appendChild(n.extractContents()),h._4e_trim(),n.insertNode(h),d=b=p;else if("li"!=h.nodeName()){if(!n.checkStartOfBlock()||
!n.checkEndOfBlock())h=h.clone(q),h[0].appendChild(n.extractContents()),h._4e_trim(),b=n.splitBlock(),d=!b.wasStartOfBlock,b=!b.wasEndOfBlock,n.insertNode(h)}else e||(this._.nextNode=h.equals(i)?null:n.getBoundaryNodes().endNode._4e_nextSourceNode(p,null,i))}d&&(n=new t(h[0].previousSibling),n[0]&&n[0].nodeType==o.NodeType.ELEMENT_NODE&&("br"==n.nodeName()?n._4e_remove():n[0].lastChild&&"br"==o.nodeName(n[0].lastChild)&&o._4e_remove(n[0].lastChild)));b&&(n=g.bookmark(q,p),d=new t(h[0].lastChild),
d[0]&&d[0].nodeType==o.NodeType.ELEMENT_NODE&&"br"==d.nodeName()&&(w.ie||d.prev(n,1)||d.next(n,1))&&d.remove());this._.nextNode||(this._.nextNode=e||h.equals(i)?null:h._4e_nextSourceNode(p,null,i));return h}});j.prototype.createIterator=function(){return new s(this)};return s},{requires:["./base","./range","./elementPath","./walker","node"]});
KISSY.add("editor/styles",function(a,m){function s(a){return!D.attr(a,"_ke_bookmark")}function p(a,d){for(var c in a)"string"==typeof a[c]?a[c]=a[c].replace(S,function(a,c){return d[c]}):p(a[c],d)}function q(d,c){c&&(d=a.clone(d),p(d,c));var b=this.element=this.element=(d.element||"*").toLowerCase();this.type=this.type="#text"==b||H[b]?A.STYLE_BLOCK:P[b]?A.STYLE_OBJECT:A.STYLE_INLINE;this._={definition:d}}function w(a,d){var c=d?this.removeFromRange:this.applyToRange;a.body.focus();for(var b=new J(a),
f=b.getRanges(),e=0;e<f.length;e++)c.call(this,f[e]);b.selectRanges(f)}function g(a,d,c){var b=a.element;"*"==b&&(b="span");d=new u(d.createElement(b));c&&c._4e_copyAttributes(d);c=a._.definition;a=c.attributes;c=q.getStyleText(c);if(a)for(var f in a)d.attr(f,a[f]);c&&(d[0].style.cssText=c);return d}function j(a){var d=a.createBookmark(f),c=a.createIterator();c.enforceRealBlocks=f;c.enlargeBr=f;for(var b,e=a.document;b=c.getNextParagraph();){var k=g(this,e,b),i=k,k="pre"==i.nodeName,h="pre"==b.nodeName,
j=!k&&h;k&&!h?(h=b,j=h.html(),j=l(j,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,""),j=j.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1"),j=j.replace(/([ \t\n\r]+|&nbsp;)/g," "),j=j.replace(/<br\b[^>]*>/gi,"\n"),N.ie?(h=h[0].ownerDocument.createElement("div"),h.appendChild(i[0]),i.outerHtml("<pre>"+j+"</pre>"),i=new u(h.firstChild),i._4e_remove()):i.html(j)):j?i=t(r(b),i):b._4e_moveChildren(i);b[0].parentNode.replaceChild(i[0],b[0]);if(k&&(b=i,k=void 0,(k=b._4e_previousSourceNode(f,D.NodeType.ELEMENT_NODE))&&
"pre"==k.nodeName()))i=l(k.html(),/\n$/,"")+"\n\n"+l(b.html(),/^\n/,""),N.ie?b.outerHtml("<pre>"+i+"</pre>"):b.html(i),k._4e_remove()}a.moveToBookmark(d)}function l(a,d,c){var b="",f="",a=a.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(a,d,c){d&&(b=d);c&&(f=c);return""});return b+a.replace(d,c)+f}function r(a){var d=[];l(a.outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,function(a,d,c){return d+"</pre>"+c+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,
function(a,c){d.push(c)});return d}function t(a,d){for(var c=d[0].ownerDocument.createDocumentFragment(),b=0;b<a.length;b++){var f=a[b],f=f.replace(/(\r\n|\r)/g,"\n"),f=l(f,/^[ \t]*\n/,""),f=l(f,/\n$/,""),f=l(f,/^[ \t]+|[ \t]+$/g,function(a,d){return 1==a.length?"&nbsp;":d?" "+Array(a.length).join("&nbsp;"):Array(a.length).join("&nbsp;")+" "}),f=f.replace(/\n/g,"<br>"),f=f.replace(/[ \t]{2,}/g,function(a){return Array(a.length).join("&nbsp;")+" "}),e=d.clone();e.html(f);c.appendChild(e[0])}return c}
function o(a){var d=a.document;if(a.collapsed)d=g(this,d,void 0),a.insertNode(d),a.moveToPosition(d,G.POSITION_BEFORE_END);else{var c=this.element,e=this._.definition,i,h=L[c];h||(i=f,h=L.span);var j=a.createBookmark();a.enlarge(G.ENLARGE_ELEMENT);a.trim();for(var n=a.createBookmark(),o=n.startNode,n=n.endNode,l=o,E;l&&l[0];){var m=k;if(D.equals(l,n))l=v,m=f;else{var p=l[0].nodeType,q=p==D.NodeType.ELEMENT_NODE?l.nodeName():v;if(q&&l.attr("_ke_bookmark")){l=l._4e_nextSourceNode(f);continue}if(!q||
h[q]&&(l._4e_position(n)|C.POSITION_PRECEDING|C.POSITION_IDENTICAL|C.POSITION_IS_CONTAINED)==C.POSITION_PRECEDING+C.POSITION_IDENTICAL+C.POSITION_IS_CONTAINED&&(!e.childRule||e.childRule(l))){var r=l.parent();if(r&&"a"==c&&r.nodeName()==c)p=g(this,d,void 0),r._4e_moveChildren(p),r[0].parentNode.replaceChild(p[0],r[0]),p._4e_mergeSiblings();else if(r&&r[0]&&((L[r.nodeName()]||L.span)[c]||i)&&(!e.parentRule||e.parentRule(r))){if(!E&&(!q||!L.$removeEmpty[q]||(l._4e_position(n)|C.POSITION_PRECEDING|C.POSITION_IDENTICAL|
C.POSITION_IS_CONTAINED)==C.POSITION_PRECEDING+C.POSITION_IDENTICAL+C.POSITION_IS_CONTAINED))E=new M(d),E.setStartBefore(l);if(p==D.NodeType.TEXT_NODE||p==D.NodeType.ELEMENT_NODE&&!l[0].childNodes.length){r=l;for(p=null;(m=!r.next(s,1))&&(p=r.parent())&&h[p.nodeName()]&&(p._4e_position(o)|C.POSITION_FOLLOWING|C.POSITION_IDENTICAL|C.POSITION_IS_CONTAINED)==C.POSITION_FOLLOWING+C.POSITION_IDENTICAL+C.POSITION_IS_CONTAINED&&(!e.childRule||e.childRule(p));)r=p;E.setEndAfter(r)}}else m=f}else m=f;l=l._4e_nextSourceNode()}if(m&&
E&&!E.collapsed){for(var m=g(this,d,void 0),r=E.getCommonAncestor(),p={},q={},t,H=null,B;m&&r&&m[0]&&r[0];){if(r.nodeName()==c){for(t in e.attributes)if(!q[t]&&(B=r.attr(H)))m.attr(t)==B?m.removeAttr(t):q[t]=1;for(H in e.styles)if(!p[H]&&(B=r.style(H)))m.style(H)==B?m.style(H,""):p[H]=1;if(!m._4e_hasAttributes()){m=v;break}}r=r.parent()}m?(m[0].appendChild(E.extractContents()),b(this,m),E.insertNode(m),m._4e_mergeSiblings(),N.ie||m[0].normalize()):(m=new u(d.createElement("span")),m[0].appendChild(E.extractContents()),
E.insertNode(m),b(this,m),m._4e_remove(!0));E=v}}o._4e_remove();n._4e_remove();a.moveToBookmark(j);a.shrink(G.SHRINK_TEXT)}}function x(a){a.enlarge(G.ENLARGE_ELEMENT);var d=a.createBookmark(),c=d.startNode;if(a.collapsed){for(var b=new E(c.parent()),f,k=0,h;k<b.elements.length&&(h=b.elements[k])&&!(h==b.block||h==b.blockLimit);k++)if(this.checkElementRemovable(h)){var g=a.checkBoundaryOfElement(h,G.END),j=!g&&a.checkBoundaryOfElement(h,G.START);j||g?(f=h,f.match=j?"start":"end"):(h._4e_mergeSiblings(),
h.nodeName()!=this.element?(g=n(this),i(h,g[h.nodeName()]||g["*"])):e(this,h))}if(f){h=c;for(k=0;;k++){g=b.elements[k];if(g.equals(f))break;else if(g.match)continue;else g=g.clone();g[0].appendChild(h[0]);h=g}h["start"==f.match?"insertBefore":"insertAfter"](f);b=f.html();!b||"\u200b"==b?f.remove():N.webkit&&B(a.document.createTextNode("\u200b")).insertBefore(h)}}else{var l=d.endNode,o=this;f=function(){for(var a=new E(c.parent()),d=new E(l.parent()),b=v,f=v,e=0;e<a.elements.length;e++){var k=a.elements[e];
if(k==a.block||k==a.blockLimit)break;o.checkElementRemovable(k)&&(b=k)}for(e=0;e<d.elements.length;e++){k=d.elements[e];if(k==d.block||k==d.blockLimit)break;o.checkElementRemovable(k)&&(f=k)}f&&l._4e_breakParent(f);b&&c._4e_breakParent(b)};f();for(b=new u(c[0].nextSibling);b[0]!==l[0];){k=b._4e_nextSourceNode();if(b[0]&&b[0].nodeType==D.NodeType.ELEMENT_NODE&&this.checkElementRemovable(b)&&(b.nodeName()==this.element?e(this,b):(h=n(this),i(b,h[b.nodeName()]||h["*"])),k[0].nodeType==D.NodeType.ELEMENT_NODE&&
k.contains(c)))f(),k=new u(c[0].nextSibling);b=k}}a.moveToBookmark(d)}function y(a){var d={};(""+a).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(a,c,b){d[c]=b});return d}function h(a,d){var c="";d!==k?(c=document.createElement("span"),c.style.cssText=a,c=c.style.cssText||""):c=a;return c.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function n(d){if(d._.overrides)return d._.overrides;var c=d._.overrides={},b=d._.definition.overrides;
if(b){a.isArray(b)||(b=[b]);for(var f=0;f<b.length;f++){var e=b[f],k,h,i;"string"==typeof e?k=e.toLowerCase():(k=e.element?e.element.toLowerCase():d.element,h=e.attributes,i=e.styles);e=c[k]||(c[k]={});if(h){k=e.attributes=e.attributes||[];for(var g in h)k.push([g.toLowerCase(),h[g]])}if(i){var e=e.styles=e.styles||[],u;for(u in i)e.push([u.toLowerCase(),i[u]])}}}return c}function e(b,e){var k=b._.definition,h=n(b),i=a.merge(k.attributes,(h[e.nodeName()]||h["*"]||{}).attributes),k=a.merge(k.styles,
(h[e.nodeName()]||h["*"]||{}).styles),h=a.isEmptyObject(i)&&a.isEmptyObject(k),g;for(g in i)("class"==g||b._.definition.fullMatch)&&e.attr(g)!=d(g,i[g])||(h=h||!!e.hasAttr(g),e.removeAttr(g));for(var u in k)b._.definition.fullMatch&&e.style(u)!=d(u,k[u],f)||(h=h||!!e.style(u),e.style(u,""));c(e)}function d(a,d,c){var b=new u("<span>");b[c?"style":"attr"](a,d);return b[c?"style":"attr"](a)}function b(a,d){for(var c=n(a),b=d.all(a.element),f=b.length;0<=--f;)e(a,new u(b[f]));for(var k in c)if(k!=a.element){b=
d.all(k);for(f=b.length-1;0<=f;f--){var h=new u(b[f]);i(h,c[k])}}}function i(a,d){var b,f=d&&d.attributes;if(f)for(b=0;b<f.length;b++){var e=f[b][0],k;if(k=a.attr(e)){var h=f[b][1];(h===v||h.test&&h.test(k)||"string"==typeof h&&k==h)&&a[0].removeAttribute(e)}}if(f=d&&d.styles)for(b=0;b<f.length;b++)if(e=f[b][0],h=a.css(e)){var g=f[b][1];(g===v||g.test&&g.test(k)||"string"==typeof g&&h==g)&&a.css(e,"")}c(a)}function c(a){if(!a._4e_hasAttributes()){var d=a[0].firstChild,c=a[0].lastChild;a._4e_remove(f);
d&&(d.nodeType==D.NodeType.ELEMENT_NODE&&D._4e_mergeSiblings(d),c&&d!=c&&c.nodeType==D.NodeType.ELEMENT_NODE&&D._4e_mergeSiblings(c))}}var f=!0,k=!1,v=null,B=a.all,D=a.DOM,A={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3},G=m.RANGE,J=m.Selection,C=m.POSITION,M=m.Range,u=a.Node,N=a.UA,E=m.ElementPath,H={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},L=m.XHTML_DTD,P={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},Q=/\s*(?:;\s*|$)/g,S=/#\((.+?)\)/g;m.STYLE=
A;q.prototype={constructor:q,apply:function(a){w.call(this,a,k)},remove:function(a){w.call(this,a,f)},applyToRange:function(a){return(this.applyToRange=this.type==A.STYLE_INLINE?o:this.type==A.STYLE_BLOCK?j:v).call(this,a)},removeFromRange:function(a){return(this.removeFromRange=this.type==A.STYLE_INLINE?x:v).call(this,a)},checkElementRemovable:function(a,d){if(!a)return k;var c=this._.definition,b;if(a.nodeName()==this.element){if(!d&&!a._4e_hasAttributes())return f;var e=c._AC;if(e)c=e;else{var e=
{},g=0,i=c.attributes;if(i)for(var u in i)g++,e[u]=i[u];if(i=q.getStyleText(c))e.style||g++,e.style=i;e._length=g;c=c._AC=e}if(c._length){for(var j in c)if("_length"!=j){g=a.attr(j)||"";if("style"==j)a:{e=c[j];g=h(g,k);"string"==typeof e&&(e=y(e));"string"==typeof g&&(g=y(g));i=void 0;for(i in e)if(!(i in g&&(g[i]==e[i]||"inherit"==e[i]||"inherit"==g[i]))){e=k;break a}e=f}else e=c[j]==g;if(e){if(!d)return f}else if(d)return k}if(d)return f}else return f}j=n(this);if(j=j[a.nodeName()]||j["*"]){if(!(c=
j.attributes)&&!(b=j.styles))return f;if(c)for(e=0;e<c.length;e++)if(j=c[e][0],j=a.attr(j))if(g=c[e][1],g===v||"string"==typeof g&&j==g||g.test&&g.test(j))return f;if(b)for(e=0;e<b.length;e++)if(j=a.css(b[e][0]))if(c=b[e][1],c===v||"string"==typeof c&&j==c||c.test&&c.test(j))return f}return k},checkActive:function(a){switch(this.type){case A.STYLE_BLOCK:return this.checkElementRemovable(a.block||a.blockLimit,f);case A.STYLE_OBJECT:case A.STYLE_INLINE:for(var d=a.elements,c=0,b;c<d.length;c++)if(b=
d[c],!(this.type==A.STYLE_INLINE&&(D.equals(b,a.block)||D.equals(b,a.blockLimit))))if((this.type!=A.STYLE_OBJECT||b.nodeName()in P)&&this.checkElementRemovable(b,f))return f}return k}};q.getStyleText=function(a){var d=a._ST;if(d)return d;var d=a.styles,c=a.attributes&&a.attributes.style||"",b="";c.length&&(c=c.replace(Q,";"));for(var f in d){var e=d[f],k=(f+":"+e).replace(Q,";");"inherit"==e?b+=k:c+=k}c.length&&(c=h(c));return a._ST=c+b};return m.Style=q},{requires:"./base,./range,./selection,./domIterator,./elementPath,node".split(",")});
KISSY.add("editor/zIndexManager",function(a,m){var s=m.zIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,STORE_FLASH_SHOW:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};m.baseZIndex=function(a){return(m.Config.baseZIndex||1E4)+a};return s},{requires:["./base"]});
KISSY.add("editor/clipboard",function(a,m,s,p){function q(a){this.editor=a;this._init()}function w(a){var b=a.get("document")[0],e=a.getSelection(),c;if(e.getType()==p.SELECTION_ELEMENT&&(c=e.getSelectedElement())){var a=e.getRanges()[0],f=r(b.createTextNode(""));f.insertBefore(c);a.setStartBefore(f);a.setEndAfter(c);e.selectRanges([a]);setTimeout(function(){c.parent()&&(f.remove(),e.selectElement(c))},0)}}function g(a){if(t.webkit){if(!a.match(/^[^<]*$/g)&&!a.match(/^(<div><br( ?\/)?><\/div>|<div>[^<]*<\/div>)*$/gi))return 0}else if(t.ie){if(!a.match(/^([^<]|<br( ?\/)?>)*$/gi)&&
!a.match(/^(<p>([^<]|<br( ?\/)?>)*<\/p>|(\r\n))*$/gi))return 0}else if(t.gecko||t.opera){if(!a.match(/^([^<]|<br( ?\/)?>)*$/gi))return 0}else return 0;return 1}function j(a){a=a.replace(/\s+/g," ").replace(/> +</g,"><").replace(/<br ?\/>/gi,"<br>");if(a.match(/^[^<]$/))return a;if(t.webkit&&-1<a.indexOf("<div>"))a.match(/<div>(?:<br>)?<\/div>/)&&(a=a.replace(/<div>(?:<br>)?<\/div>/g,function(){return"<p></p>"}),a=a.replace(/<\/p><div>/g,"</p><p>").replace(/<\/div><p>/g,"</p><p>").replace(/^<div>/,
"<p>").replace(/^<\/div>/,"</p>")),a.match(/<\/div><div>/)&&(a=a.replace(/<\/div><div>/g,"</p><p>").replace(/^<div>/,"<p>").replace(/^<\/div>/,"</p>"));else if(t.gecko||t.opera)t.gecko&&(a=a.replace(/^<br><br>$/,"<br>")),-1<a.indexOf("<br><br>")&&(a="<p>"+a.replace(/<br><br>/g,function(){return"</p><p>"})+"</p>");return a}function l(a){var b=0,a=a.replace(/<span[^>]+_ke_bookmark[^<]*?<\/span>(&nbsp;)*/ig,"");-1!=a.indexOf("Apple-")&&(a=a.replace(/<span class="Apple-converted-space">&nbsp;<\/span>/gi,
" "),a=a.replace(/<span class="Apple-tab-span"[^>]*>([^<]*)<\/span>/gi,function(a,c){return c.replace(/\t/g,Array(5).join("&nbsp;"))}),-1<a.indexOf('<br class="Apple-interchange-newline">')&&(b=1,a=a.replace(/<br class="Apple-interchange-newline">/,"")),a=a.replace(/(<[^>]+) class="Apple-[^"]*"/gi,"$1"));!b&&g(a)&&(a=j(a));return a}var r=a.all,t=a.UA,o=t.ie?"beforepaste":"paste",x=m.RANGE;a.augment(q,{_init:function(){var a=this,b=a.editor,e=b.get("document"),c=e.one("body"),f=function(a){this.type=
a};f.prototype={exec:function(c){var b=this.type;c.focus();setTimeout(function(){t.ie&&("cut"==b?w(c):"paste"==b&&(a._preventPasteEvent(),a._getClipboardDataFromPasteBin()));h(c,b)||alert(n[b])},0)}};c.on(o,a._getClipboardDataFromPasteBin,a);t.ie&&(c.on("paste",a._iePaste,a),e.on("keydown",a._onKeyDown,a),e.on("contextmenu",function(){a._isPreventBeforePaste=1;setTimeout(function(){a._isPreventBeforePaste=0},0)}));b.addCommand("copy",new f("copy"));b.addCommand("cut",new f("cut"));b.addCommand("paste",
new f("paste"))},_onKeyDown:function(a){this.editor.get("mode")==m.Mode.WYSIWYG_MODE&&(a.ctrlKey&&86==a.keyCode||a.shiftKey&&45==a.keyCode)&&this._preventPasteEvent()},_stateFromNamedCommand:function(a){var b,e=this.editor;if("paste"==a){this._isPreventBeforePaste=1;try{b=e.get("document")[0].queryCommandEnabled(a)}catch(c){}this._isPreventBeforePaste=0}else b=(a=(a=e.getSelection())&&a.getRanges())&&!(1==a.length&&a[0].collapsed);return b},_preventPasteEvent:function(){var a=this;a._preventPasteTimer&&
clearTimeout(a._preventPasteTimer);a._isPreventPaste=1;a._preventPasteTimer=setTimeout(function(){a._isPreventPaste=0},70)},_iePaste:function(a){var b=this.editor;this._isPreventPaste||(a.preventDefault(),b.execCommand("paste"))},_getClipboardDataFromPasteBin:function(){if(!this._isPreventBeforePaste){var d=this.editor,b=d.get("document")[0];if(!b.getElementById("ke-paste-bin")){var e=d.getSelection(),c=new s(b),f=r(t.webkit?"<body></body>":"<div></div>",b);f.attr("id","ke-paste-bin");t.webkit&&f[0].appendChild(b.createTextNode("\u200b"));
b.body.appendChild(f[0]);f.css({position:"absolute",top:e.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});f.css("left","-1000px");var k=e.createBookmarks();c.setStartAt(f,x.POSITION_AFTER_START);c.setEndAt(f,x.POSITION_BEFORE_END);c.select(!0);setTimeout(function(){var c,b=f;f=t.webkit&&(c=f.first())&&c.hasClass("Apple-style-span")?c:f;e.selectBookmarks(k);var g=f.html();b.remove();if(g=l(g))c=d.fire("paste",{html:g}),!1!==c&&(void 0!==c&&(g=c),/(class="?Mso|style="[^"]*\bmso\-|w:WordDocument)/.test(g)?
a.use("editor/plugin/word-filter",function(a,c){d.insertHtml(c.toDataFormat(g,d))}):d.insertHtml(g))},0)}}}});var y=function(a,b){var e=a.get("document")[0],c=r(e.body),f=!1,k=function(){f=!0};c.on(b,k);(7<t.ie?e:e.selection.createRange()).execCommand(b);c.detach(b,k);return f},h=t.ie?function(a,b){return y(a,b)}:function(a,b){try{return a.get("document")[0].execCommand(b)}catch(e){return!1}},n={cut:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u526a\u5207\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+X)\u6765\u5b8c\u6210",copy:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u590d\u5236\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+C)\u6765\u5b8c\u6210",
paste:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u7c98\u8d34\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+V)\u6765\u5b8c\u6210"},e={copy:"\u590d\u5236",paste:"\u7c98\u8d34",cut:"\u526a\u5207"};return{init:function(a){var b;a.docReady(function(){b=new q(a)});var g={copy:1,cut:1,paste:1},c=["copy","cut","paste"];a.on("contextmenu",function(f){var k=f.contextmenu;if(!k.__copy_fix){k.__copy_fix=1;for(f=0;f<c.length;f++)k.addChild({content:e[c[f]],value:c[f]});k.on("click",function(c){var b=c.target.get("value");g[b]&&(k.hide(),setTimeout(function(){a.execCommand("save");a.execCommand(b);setTimeout(function(){a.execCommand("save")},
10)},30))})}for(var h=k.get("children"),f=h.length-1;f--;0<=f){var j=h[f],l;l=j.get?j.get("value"):j.value;g[l]&&(l=!b._stateFromNamedCommand(l),j.set?j.set("disabled",l):j.disabled=l)}})}}},{requires:["./base","./range","./selection","node"]});
KISSY.add("editor/enterKey",function(a,m,s,p){function q(o){var m;m=o.getSelection().getRanges();for(var q=m.length-1;0<q;q--)m[q].deleteContents();m=m[0];q=m.document;if(m.checkStartOfBlock()&&m.checkEndOfBlock()){var h=(new p(m.startContainer)).block;if(h&&("li"==h.nodeName()||"li"==h.parent().nodeName()))return o.hasCommand("outdent")?(o.execCommand("save"),o.execCommand("outdent"),o.execCommand("save"),!0):!1}var n=m.splitBlock("p");if(!n)return!0;var o=n.previousBlock,h=n.nextBlock,e=n.wasStartOfBlock,
d=n.wasEndOfBlock,b;if(h)b=h.parent(),"li"==b.nodeName()&&(h._4e_breakParent(b),h._4e_move(h.next(),!0));else if(o&&(b=o.parent())&&"li"==b.nodeName())o._4e_breakParent(b),m.moveToElementEditablePosition(o.next()),o._4e_move(o.prev());if(!e&&!d){if("li"==h.nodeName()&&(b=h.first(s.invisible(!0)))&&a.inArray(b.nodeName(),["ul","ol"]))(g.ie?new r(q.createTextNode("\u00a0")):new r(q.createElement("br"))).insertBefore(b);h&&m.moveToElementEditablePosition(h)}else{var i;if(o){if("li"==o.nodeName()||!j.test(o.nodeName()))i=
o.clone()}else h&&(i=h.clone());i||(i=new r("<p>",null,q));if(b=n.elementPath)for(var n=0,c=b.elements.length;n<c;n++){var f=b.elements[n];if(f.equals(b.block)||f.equals(b.blockLimit))break;l.$removeEmpty[f.nodeName()]&&(f=f.clone(),i._4e_moveChildren(f),i.append(f))}g.ie||i._4e_appendBogus();m.insertNode(i);if(g.ie&&e&&(!d||!o[0].childNodes.length))m.moveToElementEditablePosition(d?o:i),m.select();m.moveToElementEditablePosition(e&&!d?h:i)}g.ie||(h?(i=new r(q.createElement("span")),i.html("&nbsp;"),
m.insertNode(i),i.scrollIntoView(void 0,{alignWithTop:!1,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0}),m.deleteContents()):i.scrollIntoView(void 0,{alignWithTop:!1,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0}));m.select();return!0}function w(a){var g=a.get("document")[0];t.on(g,"keydown",function(g){if(13===g.keyCode&&!g.shiftKey&&!g.ctrlKey&&!g.metaKey){a.execCommand("save");var h=a.execCommand("enterBlock");a.execCommand("save");!1!==h&&g.preventDefault()}})}var g=a.UA,j=/^h[1-6]$/,l=m.XHTML_DTD,
r=a.Node,t=a.Event;return{init:function(a){a.addCommand("enterBlock",{exec:q});a.docReady(function(){w(a)})}}},{requires:["./base","./walker","./elementPath","node"]});
KISSY.add("editor/htmlDataProcessor",function(a,m,s){return{init:function(p){function q(c){var c=c.childNodes,b,d,e,g=c.length;if(g){e=1;for(b=0;b<g;b++)if(d=c[b],d.nodeType!=a.DOM.NodeType.TEXT_NODE||d.nodeValue){e=0;break}return e?!1:void 0}return!1}function w(a){return a.replace(x,function(a,c,b){return"<"+c+b.replace(y,function(a,c){return-1==b.indexOf("_ke_saved_"+c)?" _ke_saved_"+a+" "+a:a})+">"})}function g(a){return a.replace(n,function(a){return"<ke:encoded>"+encodeURIComponent(a)+"</ke:encoded>"})}
function j(c){return c.replace(e,function(c,b){return a.urlDecode(b)})}var l=a.Node,r=a.UA,t=new s.Filter,o=new s.Filter;(function(){function c(a){a=s.serialize(a);return new s.Comment(h+encodeURIComponent(a).replace(/--/g,"%2D%2D"))}var b={tagNames:[[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],attributeNames:[[/^on/,"ke_on"],[/^lang$/,""]],tags:{script:c,noscript:c,span:q}},d={tagNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],tags:{$:function(a){if(a.attributes.length)for(var c=["name","href","src"],
b,d=0;d<c.length;d++)b="_ke_saved_"+c[d],a.getAttribute(b)&&a.removeAttribute(c[d]);return a},embed:function(a){var c=a.parentNode;if(c&&"object"==c.nodeName){var b=c.getAttribute("width"),c=c.getAttribute("height");b&&a.setAttribute("width",b);c&&a.setAttribute("width",c)}},a:function(a){if(!a.childNodes.length&&!a.attributes.length)return!1},span:q,strong:q,em:q,del:q,u:q},attributes:{style:function(c){if(!a.trim(c))return!1}},attributeNames:[[/^_ke_saved_/,""],[/^ke_on/,"on"],[/^_ke.*/,""],[/^ke:.*$/,
""],[/^_ks.*/,""]],comment:function(c){if(c.substr(0,h.length)==h)return c=a.trim(a.urlDecode(c.substr(h.length))),s.parse(c).childNodes[0]}};r.ie&&(d.attributes.style=function(a){return a.replace(/(^|;)([^:]+)/g,function(a){return a.toLowerCase()})});t.addRules(d);o.addRules(b)})();(function(){function c(c){for(var c=c.childNodes,b=c.length,d=c[b-1];d&&3==d.nodeType&&!a.trim(d.nodeValue);)d=c[--b];return d}function b(a){var d=c(a);d&&(1==d.nodeType&&"br"==d.nodeName?a.removeChild(d):3==d.nodeType&&
h.test(d.nodeValue)&&a.removeChild(d))}function d(a){var b=c(a);return!b||"form"==a.nodeName&&"input"==b.nodeName}function e(a){b(a);d(a)&&(r.ie||a.appendChild(new s.Tag("br")))}function g(a){b(a);d(a)&&a.appendChild(new s.Text("\u00a0"))}var h=/^[\t\r\n ]*(?:&nbsp;|\xa0)[\t\r\n ]*$/,i=m.XHTML_DTD,j=a.merge(i.$block,i.$listItem,i.$tableContent),l;for(l in j)"br"in i[l]||delete j[l];delete j.pre;var i={tags:{}},n={tags:{}};for(l in j)i.tags[l]=e,n.tags[l]=g;o.addRules(i);t.addRules(n)})();t.addRules({text:function(a){return a.replace(/\xa0/g,
"&nbsp;")}});var x=/<(a|area|img|input)\b([^>]*)>/gi,y=/\b(href|src|name)\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|(?:[^ "'>]+))/gi,h="{ke_protected}",n=/(?:<textarea[^>]*>[\s\S]*<\/textarea>)|(?:<style[^>]*>[\s\S]*<\/style>)|(?:<script[^>]*>[\s\S]*<\/script>)|(?:<(:?link|meta|base)[^>]*>)/gi,e=/<ke:encoded>([^<]*)<\/ke:encoded>/gi,d=/(<\/?)((?:object|embed|param|html|body|head|title|noscript)[^>]*>)/gi,b=/(<\/?)ke:((?:object|embed|param|html|body|head|title|noscript)[^>]*>)/gi,i=/<ke:(param|embed)([^>]*?)\/?>(?!\s*<\/ke:\1)/gi;
p.htmlDataProcessor={dataFilter:o,htmlFilter:t,toHtml:function(a){r.webkit&&(a=a.replace(/\u200b/g,""));var b=new s.BeautifyWriter;(new s.Parser(a)).parse().writeHtml(b,t);return a=b.getHtml()},toDataFormat:function(a,e){var e=e||o,a=g(a),a=w(a),a=a.replace(d,"$1ke:$2"),a=a.replace(i,"<ke:$1$2></ke:$1>"),h=new l("<div>");h.html("a"+a);a=h.html().substr(1);a=a.replace(b,"$1$2");a=j(a);h=new s.BasicWriter;(new s.Parser(a)).parse().writeHtml(h,e);return a=h.getHtml()},toServer:function(a){var b=new s.MinifyWriter;
(new s.Parser(a)).parse().writeHtml(b,t);return b.getHtml()}}}}},{requires:["./base","html-parser"]});
KISSY.add("editor/selectionFix",function(a,m){function s(a){function g(a,b){var d=c.body.createTextRange();try{d.moveToPoint(a,b)}catch(e){d=l}return d}function e(){var a=c.selection.createRange();f&&!a.item&&0===a.compareEndPoints("StartToEnd",a)&&f.select();t.remove(c,"mouseup",e);t.remove(c,"mousemove",d);f=b=0}function d(a){if(a.button){if(a=g(a.pageX,a.pageY))0<a.compareEndPoints("StartToStart",f)?a.setEndPoint("StartToStart",f):a.setEndPoint("EndToEnd",f),a.select()}else e()}var b,i=a.get("window")[0],
c=a.get("document")[0],f;t.on(c,"mousedown contextmenu",function(a){var h=c.documentElement;if(a.target===h&&(b&&e(),!(h.scrollHeight>h.clientHeight)&&(b=1,f=g(a.pageX,a.pageY))))t.on(c,"mouseup",e),t.on(c,"mousemove",d),i.focus(),f.select()})}function p(a){function n(b){if(c){var d=a.getSelection(),f=d&&d.getType(),j=d&&e.selection;if(b&&j&&f==y.SELECTION_NONE&&!e.queryCommandEnabled("InsertImage"))setTimeout(function(){n(g)},50);else{var l;if(!j||!j.type||!("Control"!=j.type&&(l=j.createRange())&&
(l=l.parentElement())&&(l=l.nodeName)&&l.toLowerCase()in{input:1,textarea:1}))i=j&&d.getRanges()[0],a.checkSelectionChange()}}}var e=a.get("document")[0],d=new x(e.body),b=new x(e.documentElement);if(8>m.Utils.ieEngine)b.on("click",function(b){"html"===(new x(b.target)).nodeName()&&a.getSelection().getNative().createRange().select()});var i,c,f=g;b.on("mousedown",function(){f=j});b.on("mouseup",function(){f=g});d.on("focusin",function(a){if("body"==(new x(a.target)).nodeName()&&i){try{f&&i.select()}catch(b){}i=
l}});d.on("focus",function(){c=g;n()});d.on("beforedeactivate",function(a){a.relatedTarget||(c=j,f=g)});d.on("mousedown",function(){c=j});d.on("mouseup",function(){c=g;setTimeout(function(){n(g)},0)});d.on("keydown",function(){c=j});d.on("keyup",function(){c=g;setTimeout(function(){n()},0)})}function q(a){var g=a.get("document")[0];t.on(g,"mouseup keyup selectionchange",function(){a.checkSelectionChange()})}function w(a){function l(a){var b=m.XHTML_DTD;return a._4e_isBlockBoundary()&&b.$empty[a.nodeName()]}
function e(a){return b(a)&&i(a)}var d=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;|(<\!--[\s\S]*?--\>))?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,b=m.Walker.whitespaces(g),i=m.Walker.bookmark(j,g),c=function(a){return b(a)&&8!=a.nodeType};a.on("selectionChange",function(b){var i=b.path,q=new x(a.get("document")[0].body),b=(b=b.selection)&&b.getRanges()[0],p=i.blockLimit;if(r.gecko){var s=i.block||i.blockLimit,t=s&&s.last(e);s&&s._4e_isBlockBoundary()&&(!t||!(1==t[0].nodeType&&
t._4e_isBlockBoundary()))&&"pre"!=s.nodeName()&&!s._4e_getBogus()&&s._4e_appendBogus()}if(b&&b.collapsed&&!i.block){if("body"==p.nodeName()){if((i=b.fixBlock(g,"p"))&&i[0]!=q[0].lastChild&&i.outerHtml().match(d))if((p=i.next(c,1))&&p[0].nodeType==o.NodeType.ELEMENT_NODE&&!l[p])b.moveToElementEditablePosition(p),i._4e_remove();else if((p=i.prev(c,1))&&p[0].nodeType==o.NodeType.ELEMENT_NODE&&!l[p])b.moveToElementEditablePosition(p,p.outerHtml().match(d)?j:g),i._4e_remove();b.select();a.notifySelectionChange()}i=
a.get("document")[0];b=new m.Range(i);b.moveToElementEditablePosition(q,g);"body"!==(new m.ElementPath(b.startContainer)).blockLimit.nodeName()&&(q=(new x(i.createElement("p"))).appendTo(q),r.ie||q._4e_appendBogus())}})}var g=!0,j=!1,l=null,r=a.UA,t=a.Event,o=a.DOM,x=a.Node,y=m.SELECTION;return{init:function(a){a.docReady(function(){r.ie?(s(a),p(a)):q(a)});w(a)}}},{requires:["./base","./selection","node"]});
KISSY.add("editor/plugin-meta",function(){(function(a){a({"editor/plugin/back-color":{requires:["editor","editor/plugin/color/btn","editor/plugin/back-color/cmd"]}});a({"editor/plugin/back-color/cmd":{requires:["editor/plugin/color/cmd"]}});a({"editor/plugin/bold":{requires:["editor","editor/plugin/font/ui","editor/plugin/bold/cmd"]}});a({"editor/plugin/bold/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/bubble":{requires:["overlay","editor"]}});a({"editor/plugin/button":{requires:["editor",
"button"]}});a({"editor/plugin/checkbox-source-area":{requires:["editor"]}});a({"editor/plugin/code":{requires:["editor","editor/plugin/dialog-loader"]}});a({"editor/plugin/code/dialog":{requires:["editor","editor/plugin/dialog","menubutton"]}});a({"editor/plugin/color/btn":{requires:["editor","editor/plugin/button","editor/plugin/overlay","editor/plugin/dialog-loader"]}});a({"editor/plugin/color/cmd":{requires:["editor"]}});a({"editor/plugin/color/dialog":{requires:["editor","editor/plugin/dialog"]}});
a({"editor/plugin/contextmenu":{requires:["editor","menu","editor/plugin/focus-fix"]}});a({"editor/plugin/dent-cmd":{requires:["editor","editor/plugin/list-utils"]}});a({"editor/plugin/dialog-loader":{requires:["overlay","editor"]}});a({"editor/plugin/dialog":{requires:["editor","overlay","editor/plugin/focus-fix","dd/plugin/constrain","component/plugin/drag"]}});a({"editor/plugin/draft":{requires:["editor","editor/plugin/local-storage","overlay","editor/plugin/menubutton"]}});a({"editor/plugin/drag-upload":{requires:["editor"]}});
a({"editor/plugin/element-path":{requires:["editor"]}});a({"editor/plugin/fake-objects":{requires:["editor","html-parser"]}});a({"editor/plugin/flash-bridge":{requires:["swf","editor"]}});a({"editor/plugin/flash-common/base-class":{requires:["editor","editor/plugin/contextmenu","editor/plugin/bubble","editor/plugin/dialog-loader","editor/plugin/flash-common/utils"]}});a({"editor/plugin/flash-common/utils":{requires:["swf"]}});a({"editor/plugin/flash":{requires:["editor","editor/plugin/flash-common/base-class",
"editor/plugin/flash-common/utils","editor/plugin/fake-objects"]}});a({"editor/plugin/flash/dialog":{requires:["editor","editor/plugin/flash-common/utils","editor/plugin/dialog","editor/plugin/menubutton"]}});a({"editor/plugin/focus-fix":{requires:["editor"]}});a({"editor/plugin/font-family":{requires:["editor","editor/plugin/font/ui","editor/plugin/font-family/cmd"]}});a({"editor/plugin/font-family/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/font-size":{requires:["editor",
"editor/plugin/font/ui","editor/plugin/font-size/cmd"]}});a({"editor/plugin/font-size/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/font/cmd":{requires:["editor"]}});a({"editor/plugin/font/ui":{requires:["editor","editor/plugin/button","editor/plugin/menubutton"]}});a({"editor/plugin/fore-color":{requires:["editor","editor/plugin/color/btn","editor/plugin/fore-color/cmd"]}});a({"editor/plugin/fore-color/cmd":{requires:["editor/plugin/color/cmd"]}});a({"editor/plugin/heading":{requires:["editor",
"editor/plugin/heading/cmd"]}});a({"editor/plugin/heading/cmd":{requires:["editor"]}});a({"editor/plugin/image":{requires:["editor","editor/plugin/button","editor/plugin/bubble","editor/plugin/contextmenu","editor/plugin/dialog-loader"]}});a({"editor/plugin/image/dialog":{requires:["io","editor","editor/plugin/dialog","tabs","editor/plugin/menubutton"]}});a({"editor/plugin/indent":{requires:["editor","editor/plugin/indent/cmd"]}});a({"editor/plugin/indent/cmd":{requires:["editor","editor/plugin/dent-cmd"]}});
a({"editor/plugin/italic":{requires:["editor","editor/plugin/font/ui","editor/plugin/italic/cmd"]}});a({"editor/plugin/italic/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/justify-center":{requires:["editor","editor/plugin/justify-center/cmd"]}});a({"editor/plugin/justify-center/cmd":{requires:["editor/plugin/justify-cmd"]}});a({"editor/plugin/justify-cmd":{requires:["editor"]}});a({"editor/plugin/justify-left":{requires:["editor","editor/plugin/justify-left/cmd"]}});a({"editor/plugin/justify-left/cmd":{requires:["editor/plugin/justify-cmd"]}});
a({"editor/plugin/justify-right":{requires:["editor","editor/plugin/justify-right/cmd"]}});a({"editor/plugin/justify-right/cmd":{requires:["editor/plugin/justify-cmd"]}});a({"editor/plugin/link":{requires:["editor","editor/plugin/bubble","editor/plugin/link/utils","editor/plugin/dialog-loader","editor/plugin/button"]}});a({"editor/plugin/link/dialog":{requires:["editor","editor/plugin/dialog","editor/plugin/link/utils"]}});a({"editor/plugin/link/utils":{requires:["editor"]}});a({"editor/plugin/list-utils":{requires:["editor"]}});
a({"editor/plugin/list-utils/btn":{requires:["editor","editor/plugin/button","editor/plugin/menubutton"]}});a({"editor/plugin/list-utils/cmd":{requires:["editor","editor/plugin/list-utils"]}});a({"editor/plugin/local-storage":{requires:["editor","overlay","editor/plugin/flash-bridge"]}});a({"editor/plugin/maximize":{requires:["editor","editor/plugin/maximize/cmd"]}});a({"editor/plugin/maximize/cmd":{requires:["editor"]}});a({"editor/plugin/menubutton":{requires:["editor","menubutton"]}});a({"editor/plugin/multiple-upload":{requires:["editor",
"editor/plugin/dialog-loader"]}});a({"editor/plugin/multiple-upload/dialog":{requires:"editor,overlay,component/plugin/drag,editor/plugin/progressbar,editor/plugin/dialog,editor/plugin/flash-bridge,editor/plugin/local-storage,swf".split(",")}});a({"editor/plugin/ordered-list":{requires:["editor","editor/plugin/list-utils/btn","editor/plugin/ordered-list/cmd"]}});a({"editor/plugin/ordered-list/cmd":{requires:["editor","editor/plugin/list-utils/cmd"]}});a({"editor/plugin/outdent":{requires:["editor",
"editor/plugin/outdent/cmd"]}});a({"editor/plugin/outdent/cmd":{requires:["editor","editor/plugin/dent-cmd"]}});a({"editor/plugin/overlay":{requires:["editor","overlay","editor/plugin/focus-fix"]}});a({"editor/plugin/page-break":{requires:["editor","editor/plugin/fake-objects"]}});a({"editor/plugin/remove-format":{requires:["editor","editor/plugin/remove-format/cmd","editor/plugin/button"]}});a({"editor/plugin/remove-format/cmd":{requires:["editor"]}});a({"editor/plugin/resize":{requires:["editor",
"dd"]}});a({"editor/plugin/separator":{requires:["editor"]}});a({"editor/plugin/smiley":{requires:["editor","editor/plugin/overlay"]}});a({"editor/plugin/source-area":{requires:["editor","editor/plugin/button"]}});a({"editor/plugin/strike-through":{requires:["editor","editor/plugin/font/ui","editor/plugin/strike-through/cmd"]}});a({"editor/plugin/strike-through/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/table":{requires:["editor","editor/plugin/dialog-loader","editor/plugin/contextmenu"]}});
a({"editor/plugin/table/dialog":{requires:["editor","editor/plugin/dialog","editor/plugin/menubutton"]}});a({"editor/plugin/underline":{requires:["editor","editor/plugin/font/ui","editor/plugin/underline/cmd"]}});a({"editor/plugin/underline/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/undo":{requires:["editor","editor/plugin/undo/btn","editor/plugin/undo/cmd"]}});a({"editor/plugin/undo/btn":{requires:["editor","editor/plugin/button"]}});a({"editor/plugin/undo/cmd":{requires:["editor"]}});
a({"editor/plugin/unordered-list":{requires:["editor","editor/plugin/list-utils/btn","editor/plugin/unordered-list/cmd"]}});a({"editor/plugin/unordered-list/cmd":{requires:["editor","editor/plugin/list-utils/cmd"]}});a({"editor/plugin/video":{requires:["editor","editor/plugin/flash-common/utils","editor/plugin/flash-common/base-class","editor/plugin/fake-objects"]}});a({"editor/plugin/video/dialog":{requires:["editor","editor/plugin/flash/dialog","editor/plugin/menubutton"]}});a({"editor/plugin/word-filter":{requires:["html-parser"]}});
a({"editor/plugin/xiami-music":{requires:["editor","editor/plugin/flash-common/base-class","editor/plugin/flash-common/utils","editor/plugin/fake-objects"]}});a({"editor/plugin/xiami-music/dialog":{requires:["editor","editor/plugin/flash/dialog","editor/plugin/menubutton"]}})})(function(a){KISSY.config("modules",a)},KISSY.Features,KISSY.UA)});
KISSY.add("editor",function(a,m,s,p,q,w,g,j,l,r,t,o){function x(a,c){var d=a.body;G(function(){a.designMode="on";setTimeout(function(){a.designMode="off";d.focus();arguments.callee.retry||(arguments.callee.retry=b)},50)},function(){a.designMode="off";d.setAttribute("contentEditable",!1);d.setAttribute("contentEditable",!0);!c&&x(a,1)})}function y(b){b.get("iframe");var d=b.get("textarea")[0],e=b.get("window"),f=b.get("document"),g=f[0];v.webkit&&(f.on("click",function(b){var c=new m(b.target);a.inArray(c.nodeName(),
["input","select"])&&b.preventDefault()}),f.on("mouseup",function(b){var c=new m(b.target);a.inArray(c.nodeName(),["input","textarea"])&&b.preventDefault()}));if(v.gecko||B||v.opera){var h;h=(new m('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>')).insertAfter(d);h.on("focus",function(){b.focus()});b.activateGecko=function(){v.gecko&&b.__iframeFocus&&h[0].focus()};b.on("destroy",function(){h.detach();h.remove()})}e.on("focus",function(){v.gecko?x(g,c):v.opera&&
g.body.focus();b.notifySelectionChange()});if(v.gecko)f.on("mousedown",function(){b.__iframeFocus||x(g,c)});if(B&&(f.on("keydown",function(a){if(a.keyCode in{8:1,46:1}){var c=b.getSelection(),d=c.getSelectedElement();if(d){b.execCommand("save");var e=c.getRanges()[0].createBookmark();d.remove();c.selectBookmarks([e]);b.execCommand("save");a.preventDefault()}}}),"CSS1Compat"==g.compatMode)){var i={33:1,34:1};f.on("keydown",function(a){a.keyCode in i&&setTimeout(function(){b.getSelection().scrollIntoView()},
0)})}if(v.webkit)f.on("mousedown",function(c){c=new m(c.target);a.inArray(c.nodeName(),["img","hr","input","textarea","select"])&&b.getSelection().selectElement(c)});if(v.gecko)f.on("dragstart",function(a){var b=new m(a.target);b.nodeName()==="img"&&/ke_/.test(b[0].className)&&a.preventDefault()});w.add(b)}function h(b,c,d,e){var g="",h;h=q.debugUrl("theme/editor-iframe.css");d=d.concat([]);d.unshift(h);for(h=0;h<d.length;h++)g+=a.substitute('<link href="{href}" rel="stylesheet" />',{href:d[h]});
return a.substitute(s,{doctype:8===k.documentMode?'<meta http-equiv="X-UA-Compatible" content="IE=7" />':"",title:"${title}",links:g,style:c,data:e||"",script:b?'<script id="ke_active_script">'+(A(f).isCustomDomain()?'document.domain="'+k.domain+'";':"")+'parent.KISSY.require("editor")._initIframe("'+b+'");<\/script>':""})}function n(a,b){function c(){i=g.document;a.setInternal("document",new m(i));a.setInternal("window",new m(g));d.detach();i.open("text/html","replace");i.write(e);i.close()}var d=
a.get("iframe"),e=h(a.get("id"),a.get("customStyle"),a.get("customLink"),b),f=d[0],g=f.contentWindow,i;d.__loaded=1;try{i=g.document}catch(j){if(f.src=f.src,7>B){setTimeout(c,10);return}}c()}function e(b,c){var d=A(f).getEmptyIframeSrc()||"";d&&(d=' src="'+d+'" ');var d=new m(a.substitute(J,{iframeSrc:d,prefixCls:b.get("prefixCls")})),e=b.get("textarea");e.hasAttr("tabindex")&&d.attr("tabindex",v.webkit?-1:e.attr("tabindex"));e.parent().prepend(d);b.set("iframe",d);b.__docReady=0;if(v.gecko&&!d.__loaded)d.on("load",
function(){n(b,c)},b);else n(b,c)}function d(b){if(b.get("iframe")){var c=b.get("iframe"),d=b.get("window"),b=b.get("document"),e=b[0],f=A(e.documentElement),e=A(e.body);a.each([b,f,e,d],function(a){a.detach()});c.remove()}}var b=!0,i=i,c=!1,f=a.Env.host,k=f.document,v=a.UA,B=v.ie,D=m.NodeType,A=m.all,G=q.tryThese,J='<iframe class="{prefixCls}editor-iframe" frameborder="0"  title="kissy-editor"  allowTransparency="true"  {iframeSrc} ></iframe>',C=/^(?:<(p)>)?(?:(?:&nbsp;)|\s|<br[^>]*>)*(?:<\/\1>)?$/i;
p.Mode={SOURCE_MODE:0,WYSIWYG_MODE:1};a.augment(p,{initializer:function(){this.__commands={};this.__controls={};w.register(this)},renderUI:function(){l.init(this);r.init(this);t.init(this);o.init(this)},bindUI:function(){function a(){b.detach("docReady",a);if(b.get("focused"))b.focus();else{var c=b.getSelection();c&&c.removeAllRanges()}}var b=this,c,d=b.get("prefixCls"),e=b.get("textarea");if(b.get("attachForm")&&(c=e[0].form)&&(c=A(c)))c.on("submit",b.sync,b);b.on("docReady",a);b.on("blur",function(){b.$el.removeClass(d+
"editor-focused")});b.on("focus",function(){b.$el.addClass(d+"editor-focused")})},_onSetHeight:function(a){var b=this.get("textarea"),c=this.get("toolBarEl"),d=this.get("statusBarEl"),a=parseInt(a,10),a=a-((c&&c.outerHeight()||0)+(d&&d.outerHeight()||0));b.parent().css("height",a);b.css("height",a)},_onSetMode:function(a){var b=this.get("iframe"),c=this.get("textarea");1==a?(this.setData(c.val()),c.hide(),this.fire("wysiwygMode")):(b&&(c.val(this.getFormatData(1)),b.hide()),c.show(),this.fire("sourceMode"))},
_onSetFocused:function(a){a&&this.__docReady&&this.focus()},setData:function(a){var b,c=a;if(1!=this.get("mode"))this.get("textarea").val(a);else{if(b=this.htmlDataProcessor)c=b.toDataFormat(a);d(this);e(this,c)}},destructor:function(){var b,c=this.get("textarea"),d=this.get("document");this.get("attachForm")&&(b=c[0].form)&&(b=A(b))&&b.detach("submit",this.sync,this);if(d){b=A(d[0].body);var c=A(d[0].documentElement),e=this.get("window");w.remove(this);d.detach();c.detach();b.detach();e.detach()}a.each(this.__controls,
function(a){a.destroy&&a.destroy()});this.__commands={};this.__controls={}},getControl:function(a){return this.__controls[a]},getControls:function(){return this.__controls},addControl:function(a,b){this.__controls[a]=b},showDialog:function(a,b){var a=a+"/dialog",c=this.__controls[a];c.show(b);this.fire("dialogShow",{dialog:c.dialog,pluginDialog:c,dialogName:a})},addCommand:function(a,b){this.__commands[a]=b},hasCommand:function(a){return this.__commands[a]},execCommand:function(b){var c=this.__commands[b],
d=a.makeArray(arguments);d.shift();d.unshift(this);return c?c.exec.apply(c,d):i},queryCommandValue:function(a){return this.execCommand(q.getQueryCmd(a))},getData:function(b,c){var d=this.htmlDataProcessor,e;c==i&&(c=this.get("mode"));e=1==c&&this.isDocReady()?this.get("document")[0].body.innerHTML:d.toDataFormat(this.get("textarea").val());e=b?d.toHtml(e):d.toServer(e);e=a.trim(e);C.test(e)&&(e="");return e},getFormatData:function(a){return this.getData(1,a)},getDocHtml:function(){return h(0,this.get("customStyle"),
this.get("customLink"),this.getFormatData())},getSelection:function(){return p.Selection.getSelection(this.get("document")[0])},getSelectedHtml:function(){var a=this.getSelection().getRanges()[0],b;a&&(a=a.cloneContents(),b=this.get("document")[0].createElement("div"),b.appendChild(a),b=b.innerHTML);return b},focus:function(){var a=this.get("window");if(a){var b=this.get("document")[0],a=a[0];v.ie||a&&a.parent&&a.parent.focus();a&&a.focus();try{b.body.focus()}catch(c){}this.notifySelectionChange()}},
blur:function(){this.get("window")[0].blur();this.get("document")[0].body.blur()},addCustomStyle:function(a,b){var c=this.get("window"),d=this.get("customStyle")||"";this.set("customStyle",d+("\n"+a));c&&c.addStyleSheet(c,a,b)},removeCustomStyle:function(a){this.get("document").on("#"+a).remove()},addCustomLink:function(a){var b=this.get("customLink"),c=this.get("document")[0];b.push(a);this.set("customLink",b);b=c.createElement("link");b.rel="stylesheet";c.getElementsByTagName("head")[0].appendChild(b);
b.href=a},removeCustomLink:function(b){this.get("document").all("link").each(function(a){a.attr("href")==b&&a.remove()});var c=this.get("customLink"),d=a.indexOf(b,c);-1!=d&&c.splice(d,1)},docReady:function(a){this.on("docReady",a);this.__docReady&&a.call(this)},isDocReady:function(){return this.__docReady},checkSelectionChange:function(){var a=this;a.__checkSelectionChangeId&&clearTimeout(a.__checkSelectionChangeId);a.__checkSelectionChangeId=setTimeout(function(){var b=a.getSelection();if(b&&!b.isInvalid){var c=
b.getStartElement(),d=new p.ElementPath(c);if(!a.__previousPath||!a.__previousPath.compare(d))a.__previousPath=d,a.fire("selectionChange",{selection:b,path:d,element:c})}},100)},notifySelectionChange:function(){this.__previousPath=null;this.checkSelectionChange()},insertElement:function(a){if(1!==this.get("mode"))return i;this.focus();var c,d=a.nodeName(),e=p.XHTML_DTD,f=e.$block[d],g=p.RANGE,h=(d=this.getSelection())&&d.getRanges(),j,k,l;if(!h||0==h.length)return i;this.execCommand("save");for(k=
h.length-1;0<=k;k--)j=h[k],c=!k&&a||a.clone(b),j.insertNodeByDtd(c),l||(l=c);if(!l)return i;j.moveToPosition(l,g.POSITION_AFTER_END);f&&(a=p.Walker.whitespaces(!0),(a=(l=l.next(a,1))&&l[0].nodeType==D.ELEMENT_NODE&&l.nodeName())&&e.$block[a]&&e[a]["#text"]&&j.moveToElementEditablePosition(l));d.selectRanges([j]);this.focus();c&&1==c[0].nodeType&&c.scrollIntoView(i,{alignWithTop:!1,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0});M.call(this);return c},insertHtml:function(a,b){var d=this,e,f=d.get("document")[0];
if(1===d.get("mode")){if(e=d.htmlDataProcessor)a=e.toDataFormat(a,b);d.focus();d.execCommand("save");if(B){e=f.selection;"Control"==e.type&&e.clear();try{e.createRange().pasteHTML(a)}catch(g){}}else try{f.execCommand("inserthtml",c,a)}catch(h){setTimeout(function(){if(0==d.getSelection().getRanges().length){var b=new p.Range(f),e=A(f.body).first(function(a){return 1==a.nodeType&&"br"!=a.nodeName.toLowerCase()});e||(e=A(f.createElement("p")),e._4e_appendBogus().appendTo(f.body));b.setStartAt(e,p.RANGE.POSITION_AFTER_START);
b.select()}f.execCommand("inserthtml",c,a)},50)}setTimeout(function(){d.getSelection().scrollIntoView()},50);M.call(d)}}});p.decorate=function(a,b){var b=b||{},a=A(a),c=b.textareaAttrs=b.textareaAttrs||{},d=a.style("width"),e=a.style("height"),f=a.attr("name");d&&(b.width=b.width||d);e&&(b.height=b.height||e);f&&(c.name=f);b.data=b.data||a.val();b.elBefore=a;c=(new p(b)).render();a.remove();return c};p._initIframe=function(a){var d=w.getInstance(a),a=d.get("document"),e=a[0];a.one("#ke_active_script").remove();
y(d);var f=e.body,g=A(f);B?(f.hideFocus=b,f.disabled=b,f.contentEditable=b,f.removeAttribute("disabled")):setTimeout(function(){v.gecko||v.opera?f.contentEditable=b:v.webkit?f.parentNode.contentEditable=b:e.designMode="on"},0);if(v.gecko||v.opera){var h=e.documentElement;A(h).on("mousedown",function(a){if(a.target==h){v.gecko&&x(e,c);d.activateGecko()}})}setTimeout(function(){B&&setTimeout(function(){if(e){f.runtimeStyle.marginBottom="0px";f.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){d.__docReady=
1;d.fire("docReady");var a=d.get("disableObjectResizing"),b=d.get("disableInlineTableEditing");if(a||b)try{e.execCommand("enableObjectResizing",c,!a);e.execCommand("enableInlineTableEditing",c,!b)}catch(f){g.on(B?"resizestart":"resize",function(c){var d=new m(c.target);(a||d.nodeName()==="table"&&b)&&c.preventDefault()})}},10)};var M=a.buffer(function(){this.execCommand("save")},50);return p},{requires:"node,editor/iframe-content-tpl,editor/base,editor/utils,editor/focusManager,editor/styles,editor/zIndexManager,editor/clipboard,editor/enterKey,editor/htmlDataProcessor,editor/selectionFix,editor/plugin-meta".split(",")});
