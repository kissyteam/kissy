/*
Copyright 2012, KISSY UI Library v1.30dev
MIT Licensed
build time: Jun 18 17:43
*/
/*
 thanks to CKSource's intelligent work on CKEditor
 @author yiminghe@gmail.com
*/
KISSY.add("editor/core/base",function(d,n,t){n=t.Controller.extend({initializer:function(){this.__commands={};this.__controls={}}},{Config:{},XHTML_DTD:n.DTD,ATTRS:{textarea:{},iframe:{},window:{},document:{},toolBarEl:{},statusBarEl:{},handleMouseEvents:{value:!1},focusable:{value:!1},mode:{value:1},data:{getter:function(){return this._getData()},setter:function(d){return this._setData(d)}},formatData:{getter:function(){return this._getData(1)},setter:function(d){return this._setData(d)}},customStyle:{value:""},
customLink:{value:[]}}},{xclass:"editor"});n.HTML_PARSER={textarea:function(d){return d.one(".ks-editor-textarea")}};d.mix(n,d.EventTarget);return KISSY.Editor=n},{requires:["htmlparser","component","core"]});
KISSY.add("editor/core/clipboard",function(d,n){function t(a){this.editor=a;this._init()}function u(a){if(h.ie&&"BackCompat"!=a.get("document")[0].compatMode){var b=a.getSelection(),e;if(b.getType()==x.SELECTION_ELEMENT&&(e=b.getSelectedElement())){var g=b.getRanges()[0],i=q(a.get("document")[0].createTextNode(""));i.insertBefore(e);g.setStartBefore(i);g.setEndAfter(e);b.selectRanges([g]);setTimeout(function(){e.parent()&&(i.remove(),b.selectElement(e))},0)}}}var q=d.all,h=d.UA,c=n.Range,k=n.RANGE,
o=d.Event;d.augment(t,{_init:function(){var a=this.editor;o.on(a.get("document")[0].body,h.webkit?"paste":h.gecko?"paste":"beforepaste",this._paste,this);o.on(a.get("document")[0].body,"contextmenu",function(){b=1;setTimeout(function(){b=0},10)});a.addCommand("copy",new s("copy"));a.addCommand("cut",new s("cut"));a.addCommand("paste",new s("paste"))},_paste:function(){if(!b){var a=this.editor,j=a.get("document")[0];if(!j.getElementById("ke_pastebin")){var e=a.getSelection(),g=new c(j),i=q(h.webkit?
"<body></body>":"<div></div>",null,j);i.attr("id","ke_pastebin");h.webkit&&i[0].appendChild(j.createTextNode("\u00a0"));j.body.appendChild(i[0]);i.css({position:"absolute",top:e.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});i.css("left","-1000px");var l=e.createBookmarks();g.setStartAt(i,k.POSITION_AFTER_START);g.setEndAt(i,k.POSITION_BEFORE_END);g.select(!0);setTimeout(function(){i.remove();var g;i=h.webkit&&(g=i.first())&&g.hasClass("Apple-style-span")?g:i;e.selectBookmarks(l);
g=i.html();if(g=d.trim(g.replace(/<span[^>]+_ke_bookmark[^<]*?<\/span>(&nbsp;)*/ig,""))){var b=a.fire("paste",{html:g,holder:i});void 0!==b&&(g=b);b=null;/(class="?Mso|style="[^"]*\bmso\-|w:WordDocument)/.test(g)&&(b=a.htmlDataProcessor.wordFilter);a.insertHtml(g,b)}},0)}}}});var p=function(a,b){var e=a.get("document")[0],g=q(e.body),i=!1,l=function(){i=!0};g.on(b,l);(7<h.ie?e:e.selection.createRange()).execCommand(b);g.detach(b,l);return i},w=h.ie?function(a,b){return p(a,b)}:function(a,b){try{return a.get("document")[0].execCommand(b)}catch(e){return!1}},
m={cut:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u526a\u5207\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+X)\u6765\u5b8c\u6210",copy:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u590d\u5236\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+C)\u6765\u5b8c\u6210",paste:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u7c98\u8d34\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+V)\u6765\u5b8c\u6210"},s=function(a){this.type=a};s.prototype={exec:function(a){"cut"==this.type&&u(a);(a=w(a,this.type))||alert(m[this.type]);return a}};var x=n.Selection,a={copy:"\u590d\u5236",paste:"\u7c98\u8d34",cut:"\u526a\u5207"},b;return{init:function(f){f.docReady(function(){new t(f)});var b={copy:1,cut:1,paste:1};f.on("contextmenu",function(e){e=e.contextmenu;if(!e.__copy_fix){e.__copy_fix=
1;for(var g in b)b.hasOwnProperty(g)&&e.addChild({xclass:"menuitem",content:a[g],value:g});e.on("click",function(a){var g=a.target.get("value");b[g]&&(this.hide(),setTimeout(function(){f.execCommand(g)},30))})}})}}},{requires:["./base"]});
KISSY.add("editor/core/dom",function(d,n,t){function u(a,b){var f=a[b?"next":"prev"](q,1);if(f&&f[0].nodeType==c.ELEMENT_NODE){for(var j=[];f.attr("_ke_bookmark")||f._4e_isEmptyInlineRemovable(q);)if(j.push(f),f=b?f.next(q,1):f.prev(q,1),!f)return;if(a._4e_isIdentical(f,q)){for(var e=new o(b?a[0].lastChild:a[0].firstChild);j.length;)j.shift()._4e_move(a,!b,q);f._4e_moveChildren(a,!b,q);f.remove();e[0]&&e[0].nodeType==c.ELEMENT_NODE&&e._4e_mergeSiblings()}}}var q=q,h=n.XHTML_DTD,c=d.DOM,k=d.UA,o=d.Node,
p={a:1,abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};n.POSITION={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};var w=n.POSITION,m={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,
"table-cell":1,"table-caption":1},s={hr:1},x=function(a){return a&&(a[0]||a)};t.injectDom({_4e_sameLevel:function(a,b){var b=x(b),f=a.parentNode;return f&&f==b.parentNode},_4e_isBlockBoundary:function(a,b){var f=d.merge(s,b);return!(!m[c.css(a,"display")]&&!f[c.nodeName(a)])},_4e_index:function(a,b){for(var f=a.parentNode.childNodes,j,e=-1,g=0;g<f.length;g++)if(j=f[g],!b||!(3==j.nodeType&&j.previousSibling&&3==j.previousSibling.nodeType))if(e++,j===a)return e;return-1},_4e_move:function(a,b,f){b=
x(b);f?b.insertBefore(a,b.firstChild):b.appendChild(a)},_4e_isIdentical:function(a,b){if(!b)return!1;b=x(b);if(c.nodeName(a)!=c.nodeName(b))return!1;var f=a.attributes,j=b.attributes,e=f.length,g=j.length;if(e!=g)return!1;for(var i=0;i<e;i++){var l=f[i],r=l.name;if(l.specified&&c.attr(a,r)!=c.attr(b,r))return!1}if(8>t.ieEngine)for(i=0;i<g;i++)if(l=j[i],r=l.name,l.specified&&c.attr(a,r)!=c.attr(b,r))return!1;return!0},_4e_isEmptyInlineRemovable:function(a){if(!h.$removeEmpty[c.nodeName(a)])return!1;
for(var a=a.childNodes,b=0,f=a.length;b<f;b++){var j=a[b],e=j.nodeType;if(!(e==c.ELEMENT_NODE&&j.getAttribute("_ke_bookmark"))&&(e==c.ELEMENT_NODE&&!c._4e_isEmptyInlineRemovable(j)||e==c.TEXT_NODE&&d.trim(j.nodeValue)))return!1}return!0},_4e_moveChildren:function(a,b,f){b=x(b);if(a!=b)if(f)for(;f=a.lastChild;)b.insertBefore(a.removeChild(f),b.firstChild);else for(;f=a.firstChild;)b.appendChild(a.removeChild(f))},_4e_mergeSiblings:function(a){a=new o(a);p[a.nodeName()]&&(u(a,!0),u(a))},_4e_splitText:function(a,
b){var f=a.ownerDocument;if(a.nodeType==c.TEXT_NODE){if(k.ie&&b==a.nodeValue.length){var j=f.createTextNode("");c.insertAfter(j,a);return j}j=a.splitText(b);f.documentMode&&(f=f.createTextNode(""),c.insertAfter(f,j),c.remove(f));return j}},_4e_parents:function(a,b){var f=[];f.__IS_NODELIST=1;do f[b?"push":"unshift"](a);while(a=a.parentNode);return f},_4e_nextSourceNode:function(a,b,f,j){if(j&&!j.call)var e=x(j),j=function(a){return a!==e};var b=!b&&a.firstChild,g=a;if(!b){if(a.nodeType==c.ELEMENT_NODE&&
j&&!1===j(a,!0))return null;b=a.nextSibling}for(;!b&&(g=g.parentNode);){if(j&&!1===j(g,!0))return null;b=g.nextSibling}return!b||j&&!1===j(b)?null:f&&f!=b.nodeType?c._4e_nextSourceNode(b,!1,f,j):b},_4e_previousSourceNode:function(a,b,f,j){if(j&&!j.call)var e=x(j),j=function(a){return a!==e};var b=!b&&a.lastChild,g=a;if(!b){if(a.nodeType==c.ELEMENT_NODE&&j&&!1===j(a,!0))return null;b=a.previousSibling}for(;!b&&(g=g.parentNode);){if(j&&!1===j(g,!0))return null;b=g.previousSibling}return!b||j&&!1===
j(b)?null:f&&b.nodeType!=f?c._4e_previousSourceNode(b,!1,f,j):b},_4e_commonAncestor:function(a,b){b=x(b);if(a===b)return a;if(c.contains(b,a))return b;var f=a;do if(c.contains(f,b))return f;while(f=f.parentNode);return null},_4e_hasAttributes:9>t.ieEngine?function(a){for(var b=a.attributes,f=0;f<b.length;f++){var j=b[f];switch(j.name){case "class":if(a.getAttribute("class"))return!0;break;default:if(j.specified)return!0}}return!1}:function(a){k.gecko&&a.removeAttribute("_moz_dirty");return a.hasAttributes()},
_4e_position:function(a,b){var f=x(b);if(a.compareDocumentPosition)return a.compareDocumentPosition(f);if(a==f)return w.POSITION_IDENTICAL;if(a.nodeType==c.ELEMENT_NODE&&f.nodeType==c.ELEMENT_NODE){if(c.contains(a,f))return w.POSITION_CONTAINS+w.POSITION_PRECEDING;if(c.contains(f,a))return w.POSITION_IS_CONTAINED+w.POSITION_FOLLOWING;if("sourceIndex"in a)return 0>a.sourceIndex||0>f.sourceIndex?w.POSITION_DISCONNECTED:a.sourceIndex<f.sourceIndex?w.POSITION_PRECEDING:w.POSITION_FOLLOWING}for(var j=
c._4e_address(a),f=c._4e_address(f),e=Math.min(j.length,f.length),g=0;g<=e-1;g++)if(j[g]!=f[g])return j[g]<f[g]?w.POSITION_PRECEDING:w.POSITION_FOLLOWING;return j.length<f.length?w.POSITION_CONTAINS+w.POSITION_PRECEDING:w.POSITION_IS_CONTAINED+w.POSITION_FOLLOWING},_4e_address:function(a,b){for(var f=[],j=a.ownerDocument.documentElement,e=a;e&&e!=j;)f.unshift(c._4e_index(e,b)),e=e.parentNode;return f},_4e_remove:function(a,b){var f=a.parentNode;if(f){if(b)for(var j;j=a.firstChild;)f.insertBefore(a.removeChild(j),
a);f.removeChild(a)}return a},_4e_trim:function(a){c._4e_ltrim(a);c._4e_rtrim(a)},_4e_ltrim:function(a){for(var b;b=a.firstChild;){if(b.nodeType==c.TEXT_NODE){var f=t.ltrim(b.nodeValue),j=b.nodeValue.length;if(f)f.length<j&&(c._4e_splitText(b,j-f.length),a.removeChild(a.firstChild));else{a.removeChild(b);continue}}break}},_4e_rtrim:function(a){for(var b;b=a.lastChild;){if(b.type==c.TEXT_NODE){var f=t.rtrim(b.nodeValue),j=b.nodeValue.length;if(f)f.length<j&&(c._4e_splitText(b,f.length),a.removeChild(a.lastChild));
else{a.removeChild(b);continue}}break}!k.ie&&!k.opera&&(b=a.lastChild)&&1==b.nodeType&&"br"==c.nodeName(b)&&a.removeChild(b)},_4e_appendBogus:function(a){for(var b=a.lastChild;b&&b.nodeType==c.TEXT_NODE&&!d.trim(b.nodeValue);)b=b.previousSibling;if(!b||b.nodeType==c.TEXT_NODE||"br"!==c.nodeName(b))b=k.opera?a.ownerDocument.createTextNode(""):a.ownerDocument.createElement("br"),k.gecko&&b.setAttribute("type","_moz"),a.appendChild(b)},_4e_outerHtml:function(a){if(a.outerHTML)return a.outerHTML.replace(/<\?[^>]*>/,
"");var b=a.ownerDocument.createElement("div");b.appendChild(a.cloneNode(!0));return b.innerHTML},_4e_setMarker:function(a,b,f,j){var a=new o(a),e=a.data("list_marker_id")||a.data("list_marker_id",d.guid()).data("list_marker_id"),g=a.data("list_marker_names")||a.data("list_marker_names",{}).data("list_marker_names");b[e]=a;g[f]=1;return a.data(f,j)},_4e_clearMarkers:function(a,b,f){var a=new o(a),j=a.data("list_marker_names"),e=a.data("list_marker_id"),g;for(g in j)j.hasOwnProperty(g)&&a.removeData(g);
a.removeData("list_marker_names");f&&(a.removeData("list_marker_id"),delete b[e])},_4e_copyAttributes:function(a,b,f){for(var b=new o(b),j=a.attributes,f=f||{},e=0;e<j.length;e++){var g=j[e],i=g.name.toLowerCase(),l;if(!(i in f))if("checked"==i&&(l=c.attr(a,i)))b.attr(i,l);else if(g.specified||k.ie&&g.value&&"value"==i)l=c.attr(a,i),null===l&&(l=g.nodeValue),b.attr(i,l)}""!==a.style.cssText&&(b[0].style.cssText=a.style.cssText)},_4e_isEditable:function(a){a=c.nodeName(a);return(a=!h.$nonEditable[a]&&
(h[a]||h.span))&&a["#"]},_4e_getByAddress:function(a,b,f){for(var a=a.documentElement,j=0;a&&j<b.length;j++){var e=b[j];if(f)for(var g=-1,i=0;i<a.childNodes.length;i++){var l=a.childNodes[i];if(!(!0===f&&3==l.nodeType&&l.previousSibling&&3==l.previousSibling.nodeType)&&(g++,g==e)){a=l;break}}else a=a.childNodes[e]}return a}})},{requires:["./base","./utils"]});
KISSY.add("editor/core/domIterator",function(d){function n(c){1>arguments.length||(this.range=c,this.forceBrBreak=u,this.enlargeBr=t,this.enforceRealBlocks=u,this._||(this._={}))}var t=!0,u=!1,q=d.Editor,h=d.UA,c=q.Walker,k=q.Range,o=q.RANGE,p=q.ElementPath,w=d.Node,m=d.DOM,s=/^[\r\n\t ]*$/;d.augment(n,{getNextParagraph:function(n){var a,b,f,j,e;if(!this._.lastNode){b=this.range.clone();b.shrink(o.SHRINK_ELEMENT,t);b.enlarge(this.forceBrBreak||!this.enlargeBr?o.ENLARGE_LIST_ITEM_CONTENTS:o.ENLARGE_BLOCK_CONTENTS);
var g=new c(b),i=c.bookmark(t,t);g.evaluator=i;this._.nextNode=g.next();g=new c(b);g.evaluator=i;g=g.previous();this._.lastNode=g._4e_nextSourceNode(t);this._.lastNode&&this._.lastNode[0].nodeType==m.TEXT_NODE&&!d.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()&&(i=new k(b.document),i.moveToPosition(this._.lastNode,o.POSITION_AFTER_END),i.checkEndOfBlock()&&(i=new p(i.endContainer),this._.lastNode=(i.block||i.blockLimit)._4e_nextSourceNode(t)));this._.lastNode||
(this._.lastNode=this._.docEndMarker=new w(b.document.createTextNode("")),m.insertAfter(this._.lastNode[0],g[0]));b=null}i=this._.nextNode;g=this._.lastNode;for(this._.nextNode=null;i;){var l=u,r=i[0].nodeType!=m.ELEMENT_NODE,z=u;if(r)i[0].nodeType==m.TEXT_NODE&&s.test(i[0].nodeValue)&&(r=u);else{var v=i.nodeName();if(i._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if("br"==v)r=t;else if(!b&&!i[0].childNodes.length&&"hr"!=v){a=i;f=i.equals(g);break}b&&(b.setEndAt(i,o.POSITION_BEFORE_START),"br"!=
v&&(this._.nextNode=i));l=t}else{if(i[0].firstChild){b||(b=new k(this.range.document),b.setStartAt(i,o.POSITION_BEFORE_START));i=new w(i[0].firstChild);continue}r=t}}r&&!b&&(b=new k(this.range.document),b.setStartAt(i,o.POSITION_BEFORE_START));f=(!l||r)&&i.equals(g);if(b&&!l)for(;!i[0].nextSibling&&!f;){v=i.parent();if(v._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){l=t;f||v.equals(g);break}i=v;r=t;f=i.equals(g);z=t}r&&b.setEndAt(i,o.POSITION_AFTER_END);i=i._4e_nextSourceNode(z,null,g);if((f=!i)||
l&&b)break}if(!a){if(!b)return this._.docEndMarker&&this._.docEndMarker._4e_remove(),this._.nextNode=null;a=new p(b.startContainer);i=a.blockLimit;l={div:1,th:1,td:1};a=a.block;if((!a||!a[0])&&!this.enforceRealBlocks&&l[i.nodeName()]&&b.checkStartOfBlock()&&b.checkEndOfBlock())a=i;else if(!a||this.enforceRealBlocks&&"li"==a.nodeName())a=new w(this.range.document.createElement(n||"p")),a[0].appendChild(b.extractContents()),a._4e_trim(),b.insertNode(a),j=e=t;else if("li"!=a.nodeName()){if(!b.checkStartOfBlock()||
!b.checkEndOfBlock())a=a.clone(u),a[0].appendChild(b.extractContents()),a._4e_trim(),e=b.splitBlock(),j=!e.wasStartOfBlock,e=!e.wasEndOfBlock,b.insertNode(a)}else f||(this._.nextNode=a.equals(g)?null:b.getBoundaryNodes().endNode._4e_nextSourceNode(t,null,g))}j&&(b=new w(a[0].previousSibling),b[0]&&b[0].nodeType==m.ELEMENT_NODE&&("br"==b.nodeName()?b._4e_remove():b[0].lastChild&&"br"==m.nodeName(b[0].lastChild)&&m._4e_remove(b[0].lastChild)));e&&(b=c.bookmark(u,t),j=new w(a[0].lastChild),j[0]&&j[0].nodeType==
m.ELEMENT_NODE&&"br"==j.nodeName()&&(h.ie||j.prev(b,1)||j.next(b,1))&&j.remove());this._.nextNode||(this._.nextNode=f||a.equals(g)?null:a._4e_nextSourceNode(t,null,g));return a}});k.prototype.createIterator=function(){return new n(this)}},{requires:["./base","./range","./elementPath","./walker"]});
KISSY.add("editor/core/elementPath",function(d){function n(d){for(var p=h,n=h,m=[];d;){if(d[0].nodeType==u.ELEMENT_NODE){this.lastElement||(this.lastElement=d);var s=d.nodeName();if(!n&&(!p&&c[s]&&(p=d),k[s])){var x;if(x=!p)if(x="div"==s){a:{x=d[0].childNodes;for(var a=0,b=x.length;a<b;a++){var f=x[a];if(f.nodeType==u.ELEMENT_NODE&&q.$block[f.nodeName.toLowerCase()]){x=!0;break a}}x=!1}x=!x}x?p=d:n=d}m.push(d);if("body"==s)break}d=d.parent()}this.block=p;this.blockLimit=n;this.elements=m}var t=d.Editor,
u=d.DOM,q=t.XHTML_DTD,h=null,c={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},k={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};n.prototype={compare:function(c){var h=this.elements,c=c&&c.elements;if(!c||h.length!=c.length)return!1;for(var d=0;d<h.length;d++)if(!u.equals(h[d],c[d]))return!1;return!0},contains:function(c){for(var d=this.elements,k=0;k<d.length;k++)if(d[k].nodeName()in c)return d[k];return h},toString:function(){var c=this.elements,
d,h=[];for(d=0;d<c.length;d++)h.push(c[d].nodeName());return h.toString()}};return t.ElementPath=n},{requires:["./base","./dom"]});
KISSY.add("editor/core/enterKey",function(d,n){function t(m){var s;s=m.getSelection().getRanges();for(var n=s.length-1;0<n;n--)s[n].deleteContents();s=s[0];n=s.document;if(s.checkStartOfBlock()&&s.checkEndOfBlock()){var a=(new w(s.startContainer)).block;if(a&&("li"==a.nodeName()||"li"==a.parent().nodeName()))return m.hasCommand("outdent")?(m.execCommand("save"),m.execCommand("outdent"),m.execCommand("save"),!0):!1}var b=s.splitBlock("p");if(!b)return!0;var m=b.previousBlock,a=b.nextBlock,f=b.wasStartOfBlock,
j=b.wasEndOfBlock,e;if(a)e=a.parent(),"li"==e.nodeName()&&(a._4e_breakParent(e),a._4e_move(a.next(),!0));else if(m&&(e=m.parent())&&"li"==e.nodeName())m._4e_breakParent(e),s.moveToElementEditablePosition(m.next()),m._4e_move(m.prev());if(!f&&!j){if("li"==a.nodeName()&&(e=a.first(p.invisible(!0)))&&d.inArray(e.nodeName(),["ul","ol"]))(q.ie?new k(n.createTextNode("\u00a0")):new k(n.createElement("br"))).insertBefore(e);a&&s.moveToElementEditablePosition(a)}else{var g;if(m){if("li"==m.nodeName()||!h.test(m.nodeName()))g=
m.clone()}else a&&(g=a.clone());g||(g=new k("<p>",null,n));if(e=b.elementPath)for(var b=0,i=e.elements.length;b<i;b++){var l=e.elements[b];if(l.equals(e.block)||l.equals(e.blockLimit))break;c.$removeEmpty[l.nodeName()]&&(l=l.clone(),g._4e_moveChildren(l),g.append(l))}q.ie||g._4e_appendBogus();s.insertNode(g);if(q.ie&&f&&(!j||!m[0].childNodes.length))s.moveToElementEditablePosition(j?m:g),s.select();s.moveToElementEditablePosition(f&&!j?a:g)}q.ie||(a?(g=new k(n.createElement("span")),g.html("&nbsp;"),
s.insertNode(g),g.scrollIntoView(void 0,!1),s.deleteContents()):g.scrollIntoView(void 0,!1));s.select();return!0}function u(c){var d=c.get("document")[0];o.on(d,"keydown",function(d){if(13===d.keyCode&&!d.shiftKey&&!d.ctrlKey&&!d.metaKey){c.execCommand("save");var a=c.execCommand("enterBlock");c.execCommand("save");!1!==a&&d.preventDefault()}})}var q=d.UA,h=/^h[1-6]$/,c=n.XHTML_DTD,k=d.Node,o=d.Event,p=n.Walker,w=n.ElementPath;return{init:function(c){c.addCommand("enterBlock",{exec:t});c.docReady(function(){u(c)})}}},
{requires:["./base"]});
KISSY.add("editor/core/focusManager",function(d){function n(){var c=this;c.__iframeFocus=p;o=c;k&&clearTimeout(k);k=setTimeout(function(){c.fire("focus")},100)}function t(){var c=this;c.__iframeFocus=w;o=m;k&&clearTimeout(k);k=setTimeout(function(){c.fire("blur")},100)}var u=d.Editor,q=d.DOM,h=d.Event,c={},k,o,d={refreshAll:function(){for(var d in c)if(c.hasOwnProperty(d)){var h=c[d].get("document")[0];h.designMode="off";h.designMode="on"}},currentInstance:function(){return o},getInstance:function(d){return c[d]},
add:function(c){var d=q._getWin(c.get("document")[0]);h.on(d,"focus",n,c);h.on(d,"blur",t,c)},register:function(d){c[d._UUID]=d},remove:function(d){delete c[d._UUID];var k=q._getWin(d.get("document")[0]);h.remove(k,"focus",n,d);h.remove(k,"blur",t,d)}},p=!0,w=!1,m=null;d.refreshAll=d.refreshAll;u.focusManager=d;u.getInstances=function(){return c};return d},{requires:["./base","./dom"]});
KISSY.add("editor/core/htmlDataProcessor",function(d,n){return{init:function(t){function u(f){return f.replace(x,function(f,e,g){return"<"+e+g.replace(a,function(a,f){return-1==g.indexOf("_ke_saved_"+f)?" _ke_saved_"+a+" "+a:a})+">"})}function q(a){return a.replace(/<\!--(?!{ke_protected})[\s\S]+?--\>/g,function(a){return"<\!--"+b+"{C}"+encodeURIComponent(a).replace(/--/g,"%2D%2D")+"--\>"})}function h(a){return a.replace(/<\!--\{ke_protected\}\{C\}([\s\S]+?)--\>/g,function(a,f){return decodeURIComponent(f)})}
var c=c,k=d.Node,o=d.UA,p=d.require("htmlparser"),w=new p.Filter,m=new p.Filter,s=new p.Filter;(function(){var a=function(a,f){return function(e,b){var c=[];(""+e).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(e,l,F){l=l.toLowerCase();"font-family"==l&&(F=F.replace(/["']/g,""));for(var C,d,j,y=0;y<a.length;y++)if(a[y]&&(e=a[y][0],C=a[y][1],d=a[y][2],j=a[y][3],l.match(e)&&(!C||F.match(C)))){l=j||l;f&&(d=d||F);"function"==typeof d&&(d=d(F,b,l));d&&d.push&&(l=d[0],d=
d[1]);"string"==typeof d&&c.push([l,d]);return}!f&&c.push([l,F])});for(var d=0;d<c.length;d++)c[d]=c[d].join(":");return c.length?c.join(";")+";":!1}}([[/mso/i],[/w:WordDocument/i],[/^-ms/i],[/^-moz/i],[/^-webkit/i]],c),j={tagNames:[[/^script$/i,""],[/^iframe$/i,""],[/^style$/i,""],[/^link$/i,""],[/^meta$/i,""],[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],root:function(a){a.filterChildren()},tags:{p:function(a){a.filterChildren()},$:function(a){var f=a.nodeName||"";if(-1!=f.indexOf(":")&&!/^ke/.test(f))if("v:imagedata"==
f){if(f=a.getAttribute("o:href"))a.setAttribute("src",f),a.removeAttribute("o:href");if(f=a.getAttribute("o:title"))a.setAttribute("title",f),a.removeAttribute("o:title");a.setTagName("img")}else a.setTagName("")}},attributes:{"class":function(a){return!a||/(^|\s+)Mso/.test(a)?!1:a},style:function(g){g=a(g);return!g?!1:g}},attributeNames:[[/^on/,"ke_on"],[/^lang$/,""]]},e={tagNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],tags:{$:function(a){if(a.attributes.length)for(var f=["name","href","src"],e,
b=0;b<f.length;b++)e="_ke_saved_"+f[b],a.getAttribute(e)&&a.removeAttribute(f[b]);return a},embed:function(a){var f=a.parentNode;if(f&&"object"==f.nodeName){var e=f.getAttribute("width"),f=f.getAttribute("height");e&&a.setAttribute("width",e);f&&a.setAttribute("width",f)}},a:function(a){if(!a.childNodes.length&&!a.attributes.length)return!1},span:function(a){if(!a.childNodes.length&&!a.attributes.length)return!1}},attributes:{style:function(a){if(!d.trim(a))return!1}},attributeNames:[[/^_ke_saved_/,
""],[/^ke_on/,"on"],[/^_ke.*/,""],[/^_ks.*/,""],[/^ke:.*$/,""]],comment:function(a){return a.substr(0,b.length)==b?(a="{C}"==a.substr(b.length,3)?a.substr(b.length+3):a.substr(b.length),new p.CData(decodeURIComponent(a))):a}};o.ie&&(e.attributes.style=function(a){return a.replace(/(^|;)([^:]+)/g,function(a){return a.toLowerCase()})});w.addRules(e);m.addRules(j);s.addRules(j)})();(function(){function a(f){for(var f=f.childNodes,F=f.length,g=f[F-1];g&&3==g.nodeType&&!d.trim(g.nodeValue);)g=f[--F];return g}
function b(g,F){var e=a(g);e&&((F||!o.ie)&&1==e.nodeType&&"br"==e.nodeName?g.removeChild(e):3==e.nodeType&&c.test(e.nodeValue)&&g.removeChild(e))}function e(g){var F=a(g);return!F||1==F.nodeType&&"br"==F.nodeName||"form"==g.nodeName&&"input"==F.nodeName}function g(a){b(a,!0);e(a)&&(o.ie?a.appendChild(new p.Text("\u00a0")):(a.appendChild(new p.Text("&nbsp;")),a.appendChild(new p.Tag("br"))))}function i(a){b(a,!1);e(a)&&a.appendChild(new p.Text("\u00a0"))}var c=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,h=n.XHTML_DTD,k=d.merge(h.$block,
h.$listItem,h.$tableContent),v;for(v in k)k.hasOwnProperty(v)&&("br"in h[v]||delete k[v]);delete k.td;delete k.pre;var h={tags:{}},q={tags:{}};for(v in k)k.hasOwnProperty(v)&&(h.tags[v]=g,q.tags[v]=i);m.addRules(h);w.addRules(q);s.addRules(h)})();(function(){w.addRules({text:function(a){return a.replace(/\xa0/g,"&nbsp;")}})})();var x=/<(a|area|img|input)\b([^>]*)>/gi,a=/\b(href|src|name)\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|(?:[^ "'>]+))/gi,b="{ke_protected}";t.htmlDataProcessor={wordFilter:s,dataFilter:m,
htmlFilter:w,toHtml:function(a){var b=new p.BeautifyWriter;(new p.Parser(a)).parse().writeHtml(b,w);return b.getHtml()},toDataFormat:function(a,b,e){e=e||m;o.gecko&&(a=a.replace(/(<\!--\[if[^<]*?\])--\>([\S\s]*?)<\!--(\[endif\]--\>)/gi,"$1$2$3"));a=u(a);b=new k("<div>");b.html("a"+a);a=b.html().substr(1);a=h(a);b=new p.BeautifyWriter;(new p.Parser(a)).parse().writeHtml(b,e);a=b.getHtml();return a=q(a)},toServer:function(a){var b=new p.MinifyWriter;(new p.Parser(a)).parse().writeHtml(b,w);return b.getHtml()}}}}},
{requires:["./base"]});
KISSY.add("editor/core/meta",function(){var d={backColor:["../color/btn","./cmd"],localStorage:["../flashBridge/"],bold:["../font/ui","./cmd"],draft:["../localStorage/","../menubutton/"],flash:["../flashCommon/baseClass","../flashCommon/utils"],fontFamily:["../font/ui","./cmd"],fontSize:["../font/ui","./cmd"],foreColor:["../color/btn","./cmd"],heading:["./cmd"],image:["../button/","../bubble/","../contextmenu/","../dialogLoader/"],indent:["./cmd"],orderedList:["../listUtils/btn","./cmd"],unorderedList:["../listUtils/btn",
"./cmd"],italic:["../font/ui","./cmd"],justifyCenter:["./cmd"],justifyLeft:["./cmd"],justifyRight:["./cmd"],link:["../bubble/","./utils","../dialogLoader/"],maximize:["./cmd"],multipleUpload:["../dialogLoader/"],outdent:["./cmd"],overlay:["dd","../focusFix/"],pageBreak:["../fakeObjects/"],removeFormat:["./cmd","../button/"],resize:["dd"],menubutton:["menubutton"],smiley:["../overlay/"],sourceArea:["../button/"],strikeThrough:["../font/ui","./cmd"],table:["../dialogLoader/","../contextmenu/"],underline:["../font/ui",
"./cmd"],undo:["./btn","./cmd"],contextmenu:["menu","../focusFix/"],video:["../flashCommon/utils","../flashCommon/baseClass"],xiamiMusic:["../flashCommon/baseClass","../flashCommon/utils"]},n,t,u={"backColor/cmd":["../color/cmd"],"bold/cmd":["../font/cmd"],"color/btn":["../button/","../overlay/","../dialogLoader/"],"color/colorPicker/dialog":["../../overlay/"],"dentUtils/cmd":["../listUtils/"],"flash/dialog":["../flashCommon/utils","../overlay/","../menubutton/"],"flashCommon/baseClass":["../contextmenu/",
"../bubble/","../dialogLoader/","./utils"],"font/ui":["../button/","../menubutton/"],"fontFamily/cmd":["../font/cmd"],"fontSize/cmd":["../font/cmd"],"foreColor/cmd":["../color/cmd"],"image/dialog":["../overlay/","switchable","../menubutton/"],"indent/cmd":["../dentUtils/cmd"],"orderedList/cmd":["../listUtils/cmd"],"unorderedList/cmd":["../listUtils/cmd"],"italic/cmd":["../font/cmd"],"justifyCenter/cmd":["../justifyUtils/cmd"],"justifyLeft/cmd":["../justifyUtils/cmd"],"justifyRight/cmd":["../justifyUtils/cmd"],
"link/dialog":["../overlay/","./utils"],"listUtils/btn":["../button/"],"listUtils/cmd":["../listUtils/"],"multipleUpload/dialog":["../progressbar/","../overlay/","../flashBridge/","../localStorage/"],"outdent/cmd":["../dentUtils/cmd"],"strikeThrough/cmd":["../font/cmd"],"table/dialog":["../overlay/","../menubutton/"],"underline/cmd":["../font/cmd"],"undo/btn":["../button/"],"video/dialog":["../flash/dialog","../menubutton/"],"xiamiMusic/dialog":["../flash/dialog","../menubutton/"]},q={};for(n in d)t=
"editor/plugin/"+n+"/index",q[t]={requires:d[n]};for(n in u)t="editor/plugin/"+n,q[t]={requires:u[n]};KISSY.add(q)});
KISSY.add("editor/core/range",function(d,n,t,u,q){function h(a){var g=a.nodeType!=f.TEXT_NODE&&f.nodeName(a)in e.$removeEmpty,b=a.nodeType==f.TEXT_NODE&&!d.trim(a.nodeValue),a=!!a.parentNode.getAttribute("_ke_bookmark");return g||b||a}function c(a){return!r(a)&&!z(a)}function k(a){var g=s;return function(b){if(z(b))return m;if(b.nodeType==f.TEXT_NODE){if(d.trim(b.nodeValue).length)return s}else if(b.nodeType==f.ELEMENT_NODE&&(b=f.nodeName(b),!E[b]))if(!a&&!j.ie&&"br"==b&&!g)g=m;else return s;return m}}
function o(a,b){var e=a.startContainer,i=a.endContainer,y=a.startOffset,c=a.endOffset,d,l=s,h=s,j=void 0,r=a.document,P;0<b&&(j=r.createDocumentFragment());if(a.collapsed)return j;a.optimizeBookmark();i[0].nodeType==f.TEXT_NODE?(h=m,i=i._4e_splitText(c)):0<i[0].childNodes.length&&(c>=i[0].childNodes.length?(i=new g(i[0].appendChild(r.createTextNode(""))),P=m):i=new g(i[0].childNodes[c]));e[0].nodeType==f.TEXT_NODE?(l=m,e._4e_splitText(y)):y?y>=e[0].childNodes.length?(e=new g(e[0].appendChild(r.createTextNode(""))),
d=m):e=new g(e[0].childNodes[y].previousSibling):(d=new g(r.createTextNode("")),e.prepend(d),e=d,d=m);var k=e._4e_parents(),J=i._4e_parents();k.each(function(a,b){k[b]=a});J.each(function(a,b){J[b]=a});for(var H,L,r=0;r<k.length&&!(H=k[r],L=J[r],!H.equals(L));r++);for(var y=j,B,n,v=r;v<k.length;v++){B=k[v];c=0<b&&!B.equals(e)?y.appendChild(B.clone()[0]):null;B=B[0].nextSibling;n=J[v];for(var z=i[0],o=n&&n[0];B&&!(o==B||z==B);)n=B.nextSibling,2==b?y.appendChild(B.cloneNode(m)):(f._4e_remove(B),1==
b&&y.appendChild(B)),B=n;c&&(y=c)}for(y=j;r<J.length;r++){B=J[r];c=0<b&&!B.equals(i)?y.appendChild(B.clone()[0]):null;if(!k[r]||!B._4e_sameLevel(k[r]))for(B=B[0].previousSibling;B;)n=B.previousSibling,2==b?y.insertBefore(B.cloneNode(m),y.firstChild):(f._4e_remove(B),1==b&&y.insertBefore(B,y.firstChild)),B=n;c&&(y=c)}if(2==b){if(l&&(H=e[0],H.nodeType==f.TEXT_NODE&&H.nextSibling&&H.nextSibling.nodeType==f.TEXT_NODE&&(H.data+=H.nextSibling.data,H.parentNode.removeChild(H.nextSibling))),h)h=i[0],h.nodeType==
f.TEXT_NODE&&h.previousSibling&&h.previousSibling.nodeType==f.TEXT_NODE&&(h.previousSibling.data+=h.data,h.parentNode.removeChild(h))}else{if(H&&L&&(!e._4e_sameLevel(H)||!i._4e_sameLevel(L)))h=H._4e_index(),d&&H._4e_sameLevel(e)&&h--,a.setStart(H.parent(),h+1);a.collapse(m)}d&&e.remove();P&&i.remove();return j}function p(a){a.collapsed=a.startContainer&&a.endContainer&&a.startContainer[0]==a.endContainer[0]&&a.startOffset==a.endOffset}function w(a){this.endOffset=this.endContainer=this.startOffset=
this.startContainer=x;this.collapsed=m;this.document=a}n.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var m=!0,s=!1,x=null,a=n.RANGE,b=n.POSITION,f=d.DOM,j=d.UA,e=n.XHTML_DTD,g=d.Node,i=g.all,l={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},r=new u.whitespaces,z=new u.bookmark,v=u.whitespaces(m),A=u.bookmark(!1,
!0),E={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};d.augment(w,{toString:function(){var a=[],b=this.startContainer[0],e=this.endContainer[0];a.push((b.id||b.nodeName)+":"+this.startOffset);a.push((e.id||e.nodeName)+":"+this.endOffset);return a.join("<br/>")},optimize:function(){var a=this.startContainer,b=this.startOffset;a[0].nodeType!=f.ELEMENT_NODE&&(b?b>=a[0].nodeValue.length&&
this.setStartAfter(a):this.setStartBefore(a));a=this.endContainer;b=this.endOffset;a[0].nodeType!=f.ELEMENT_NODE&&(b?b>=a[0].nodeValue.length&&this.setEndAfter(a):this.setEndBefore(a))},setStartAfter:function(a){this.setStart(a.parent(),a._4e_index()+1)},setStartBefore:function(a){this.setStart(a.parent(),a._4e_index())},setEndAfter:function(a){this.setEnd(a.parent(),a._4e_index()+1)},setEndBefore:function(a){this.setEnd(a.parent(),a._4e_index())},optimizeBookmark:function(){var a=this.startContainer,
b=this.endContainer;a&&"span"==a.nodeName()&&a.attr("_ke_bookmark")&&this.setStartBefore(a);b&&"span"==b.nodeName()&&b.attr("_ke_bookmark")&&this.setEndAfter(b)},setStart:function(a,b){a[0].nodeType==f.ELEMENT_NODE&&l[a.nodeName()]&&(a=a.parent(),b=a._4e_index());this.startContainer=a;this.startOffset=b;this.endContainer||(this.endContainer=a,this.endOffset=b);p(this)},setEnd:function(a,b){a[0].nodeType==f.ELEMENT_NODE&&l[a.nodeName()]&&(a=a.parent(),b=a._4e_index()+1);this.endContainer=a;this.endOffset=
b;this.startContainer||(this.startContainer=a,this.startOffset=b);p(this)},setStartAt:function(b,e){switch(e){case a.POSITION_AFTER_START:this.setStart(b,0);break;case a.POSITION_BEFORE_END:b[0].nodeType==f.TEXT_NODE?this.setStart(b,b[0].nodeValue.length):this.setStart(b,b[0].childNodes.length);break;case a.POSITION_BEFORE_START:this.setStartBefore(b);break;case a.POSITION_AFTER_END:this.setStartAfter(b)}p(this)},setEndAt:function(b,e){switch(e){case a.POSITION_AFTER_START:this.setEnd(b,0);break;
case a.POSITION_BEFORE_END:b[0].nodeType==f.TEXT_NODE?this.setEnd(b,b[0].nodeValue.length):this.setEnd(b,b[0].childNodes.length);break;case a.POSITION_BEFORE_START:this.setEndBefore(b);break;case a.POSITION_AFTER_END:this.setEndAfter(b)}p(this)},cloneContents:function(){return o(this,2)},deleteContents:function(){return o(this,0)},extractContents:function(){return o(this,1)},collapse:function(a){a?(this.endContainer=this.startContainer,this.endOffset=this.startOffset):(this.startContainer=this.endContainer,
this.startOffset=this.endOffset);this.collapsed=m},clone:function(){var a=new w(this.document);a.startContainer=this.startContainer;a.startOffset=this.startOffset;a.endContainer=this.endContainer;a.endOffset=this.endOffset;a.collapsed=this.collapsed;return a},getEnclosedNode:function(){var a=this.clone();a.optimize();if(a.startContainer[0].nodeType!=f.ELEMENT_NODE||a.endContainer[0].nodeType!=f.ELEMENT_NODE)return x;var b=new u(a);b.evaluator=function(a){return v(a)&&A(a)};a=b.next();b.reset();b=
b.previous();return a&&a.equals(b)?a:x},shrink:function(b,e){if(!this.collapsed){var b=b||a.SHRINK_TEXT,g=this.clone(),i=this.startContainer,y=this.endContainer,c=this.startOffset,d=this.endOffset,l=m,h,r,j=m;i&&i[0].nodeType==f.TEXT_NODE&&(c?c>=i[0].nodeValue.length?g.setStartAfter(i):(g.setStartBefore(i),l=s):g.setStartBefore(i));y&&y[0].nodeType==f.TEXT_NODE&&(d?d>=y[0].nodeValue.length?g.setEndAfter(y):(g.setEndAfter(y),j=s):g.setEndBefore(y));if(l||j)r=new u(g),r.evaluator=function(e){return e.nodeType==
(b==a.SHRINK_ELEMENT?f.ELEMENT_NODE:f.TEXT_NODE)},r.guard=function(e,g){if(b==a.SHRINK_ELEMENT&&e.nodeType==f.TEXT_NODE||g&&e==h)return s;!g&&e.nodeType==f.ELEMENT_NODE&&(h=e);return m};l&&(g=r[b==a.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(g,e?a.POSITION_AFTER_START:a.POSITION_BEFORE_START);j&&(r.reset(),(r=r[b==a.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(r,e?a.POSITION_BEFORE_END:a.POSITION_AFTER_END));return l||j}},createBookmark2:function(a){var b=this.startContainer,
e=this.endContainer,i=this.startOffset,y=this.endOffset,c,d;if(!b||!e)return{start:0,end:0};if(a){if(b[0].nodeType==f.ELEMENT_NODE&&(c=new g(b[0].childNodes[i]))&&c[0]&&c[0].nodeType==f.TEXT_NODE&&0<i&&c[0].previousSibling.nodeType==f.TEXT_NODE)b=c,i=0;for(;b[0].nodeType==f.TEXT_NODE&&(d=b.prev(void 0,1))&&d[0].nodeType==f.TEXT_NODE;)b=d,i+=d[0].nodeValue.length;if(!this.collapsed){if(e[0].nodeType==f.ELEMENT_NODE&&(c=new g(e[0].childNodes[y]))&&c[0]&&c[0].nodeType==f.TEXT_NODE&&0<y&&c[0].previousSibling.nodeType==
f.TEXT_NODE)e=c,y=0;for(;e[0].nodeType==f.TEXT_NODE&&(d=e.prev(void 0,1))&&d[0].nodeType==f.TEXT_NODE;)e=d,y+=d[0].nodeValue.length}}return{start:b._4e_address(a),end:this.collapsed?x:e._4e_address(a),startOffset:i,endOffset:y,normalized:a,is2:m}},createBookmark:function(b){var e,f,i,c,l=this.collapsed;e=new g("<span>",x,this.document);e.attr("_ke_bookmark",1);e.css("display","none");e.html("&nbsp;");b&&(i=d.guid("ke_bm_"),e.attr("id",i+"S"));l||(f=e.clone(),f.html("&nbsp;"),b&&f.attr("id",i+"E"),
c=this.clone(),c.collapse(),c.insertNode(f));c=this.clone();c.collapse(m);c.insertNode(e);f?(this.setStartAfter(e),this.setEndBefore(f)):this.moveToPosition(e,a.POSITION_AFTER_END);return{startNode:b?i+"S":e,endNode:b?i+"E":f,serializable:b,collapsed:l}},moveToPosition:function(a,b){this.setStartAt(a,b);this.collapse(m)},trim:function(a,b){var e=this.startContainer,g=this.startOffset,i=this.collapsed;if((!a||i)&&e[0]&&e[0].nodeType==f.TEXT_NODE){if(g)if(g>=e[0].nodeValue.length)g=e._4e_index()+1,
e=e.parent();else{var c=e._4e_splitText(g),g=e._4e_index()+1,e=e.parent();f.equals(this.startContainer,this.endContainer)?this.setEnd(c,this.endOffset-this.startOffset):f.equals(e,this.endContainer)&&(this.endOffset+=1)}else g=e._4e_index(),e=e.parent();this.setStart(e,g);if(i){this.collapse(m);return}}e=this.endContainer;g=this.endOffset;!b&&!i&&e[0]&&e[0].nodeType==f.TEXT_NODE&&(g?(g>=e[0].nodeValue.length||e._4e_splitText(g),g=e._4e_index()+1):g=e._4e_index(),e=e.parent(),this.setEnd(e,g))},insertNode:function(a){this.optimizeBookmark();
this.trim(s,m);var b=this.startContainer;b[0].insertBefore(a[0],b[0].childNodes[this.startOffset]||null);b[0]==this.endContainer[0]&&this.endOffset++;this.setStartBefore(a)},moveToBookmark:function(a){var b=i(this.document);if(a.is2){var e=b._4e_getByAddress(a.start,a.normalized),g=a.startOffset,b=a.end&&b._4e_getByAddress(a.end,a.normalized),a=a.endOffset;this.setStart(e,g);b?this.setEnd(b,a):this.collapse(m)}else e=(g=a.serializable)?d.one("#"+a.startNode,b):a.startNode,a=g?d.one("#"+a.endNode,
b):a.endNode,this.setStartBefore(e),e._4e_remove(),a&&a[0]?(this.setEndBefore(a),a._4e_remove()):this.collapse(m)},getCommonAncestor:function(a,b){var e=this.startContainer,i=this.endContainer,e=e[0]==i[0]?a&&e[0].nodeType==f.ELEMENT_NODE&&this.startOffset==this.endOffset-1?new g(e[0].childNodes[this.startOffset]):e:e._4e_commonAncestor(i);return b&&e[0].nodeType==f.TEXT_NODE?e.parent():e},enlarge:function(){function b(a,e,g,c){var d=a[e?"startContainer":"endContainer"],l,h=e?0:1,j=0,k=e?"previousSibling":
"nextSibling";l=a[e?"startOffset":"endOffset"];if(d[0].nodeType==f.TEXT_NODE){if(e){if(l)return}else if(l<d[0].nodeValue.length)return;l=d[0][k];d=d[0].parentNode}else l=d[0].childNodes[l+(e?-1:1)]||null,d=d[0];for(;d;){for(;l;)if(r(l)||z(l))l=l[k];else break;if(l){if(!j)a[e?"setStartAfter":"setEndBefore"](i(l));break}d=i(d);if("body"==d.nodeName())break;if(j||d.equals(c))g[h]=d,j=1;else a[e?"setStartBefore":"setEndAfter"](d);l=d[0][k];d=d[0].parentNode}}return function(e){switch(e){case a.ENLARGE_ELEMENT:if(this.collapsed)break;
var e=this.getCommonAncestor(),d=[];b(this,1,d,e);b(this,0,d,e);d[0]&&d[1]&&(e=d[0].contains(d[1])?d[1]:d[0],this.setStartBefore(e),this.setEndAfter(e));break;case a.ENLARGE_BLOCK_CONTENTS:case a.ENLARGE_LIST_ITEM_CONTENTS:var c=new w(this.document),d=new g(this.document.body);c.setStartAt(d,a.POSITION_AFTER_START);c.setEnd(this.startContainer,this.startOffset);var c=new u(c),l,h,r=u.blockBoundary(e==a.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:x),j=function(a){var b=r(a);b||(l=i(a));return b},k=function(a){var b=
j(a);!b&&"br"==f.nodeName(a)&&(h=i(a));return b};c.guard=j;c=c.lastBackward();l=l||d;this.setStartAt(l,"br"!=l.nodeName()&&(!c&&this.checkStartOfBlock()||c&&l.contains(c))?a.POSITION_AFTER_START:a.POSITION_AFTER_END);c=this.clone();c.collapse();c.setEndAt(d,a.POSITION_BEFORE_END);c=new u(c);c.guard=e==a.ENLARGE_LIST_ITEM_CONTENTS?k:j;l=x;c=c.lastForward();l=l||d;this.setEndAt(l,!c&&this.checkEndOfBlock()||c&&l.contains(c)?a.POSITION_BEFORE_END:a.POSITION_BEFORE_START);h&&this.setEndAfter(h)}}}(),
checkStartOfBlock:function(){var b=this.startContainer,e=this.startOffset;if(e&&b[0].nodeType==f.TEXT_NODE&&d.trim(b[0].nodeValue.substring(0,e)).length)return s;this.trim();b=new q(this.startContainer);e=this.clone();e.collapse(m);e.setStartAt(b.block||b.blockLimit,a.POSITION_AFTER_START);b=new u(e);b.evaluator=k(m);return b.checkBackward()},checkEndOfBlock:function(){var b=this.endContainer,e=this.endOffset;if(b[0].nodeType==f.TEXT_NODE&&d.trim(b[0].nodeValue.substring(e)).length)return s;this.trim();
b=new q(this.endContainer);e=this.clone();e.collapse(s);e.setEndAt(b.block||b.blockLimit,a.POSITION_BEFORE_END);b=new u(e);b.evaluator=k(s);return b.checkForward()},checkBoundaryOfElement:function(b,e){var g=this.clone();g[e==a.START?"setStartAt":"setEndAt"](b,e==a.START?a.POSITION_AFTER_START:a.POSITION_BEFORE_END);g=new u(g);g.evaluator=h;return g[e==a.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var a=this.startContainer,e=this.endContainer,g=this.startOffset,c=this.endOffset,
d;if(a[0].nodeType==f.ELEMENT_NODE)if(d=a[0].childNodes.length,d>g)a=i(a[0].childNodes[g]);else if(0==d)a=a._4e_previousSourceNode();else{for(a=a[0];a.lastChild;)a=a.lastChild;a=i(a);a=a._4e_nextSourceNode()||a}if(e[0].nodeType==f.ELEMENT_NODE)if(d=e[0].childNodes.length,d>c)e=i(e[0].childNodes[c])._4e_previousSourceNode(m);else if(0==d)e=e._4e_previousSourceNode();else{for(e=e[0];e.lastChild;)e=e.lastChild;e=i(e)}a._4e_position(e)&b.POSITION_FOLLOWING&&(a=e);return{startNode:a,endNode:e}},fixBlock:function(e,
b){var g=this.createBookmark(),f=i(this.document.createElement(b));this.collapse(e);this.enlarge(a.ENLARGE_BLOCK_CONTENTS);f[0].appendChild(this.extractContents());f._4e_trim();j.ie||f._4e_appendBogus();this.insertNode(f);this.moveToBookmark(g);return f},splitBlock:function(e){var b=new q(this.startContainer),g=new q(this.endContainer),f=b.block,c=g.block,i=x;if(!b.blockLimit.equals(g.blockLimit))return x;"br"!=e&&(f||(f=this.fixBlock(m,e),c=(new q(this.endContainer)).block),c||(c=this.fixBlock(s,
e)));e=f&&this.checkStartOfBlock();b=c&&this.checkEndOfBlock();this.deleteContents();f&&f[0]==c[0]&&(b?(i=new q(this.startContainer),this.moveToPosition(c,a.POSITION_AFTER_END),c=x):e?(i=new q(this.startContainer),this.moveToPosition(f,a.POSITION_BEFORE_START),f=x):(c=this.splitElement(f),!j.ie&&!d.inArray(f.nodeName(),["ul","ol"])&&f._4e_appendBogus()));return{previousBlock:f,nextBlock:c,wasStartOfBlock:e,wasEndOfBlock:b,elementPath:i}},splitElement:function(e){if(!this.collapsed)return x;this.setEndAt(e,
a.POSITION_BEFORE_END);var b=this.extractContents(),g=e.clone(s);g[0].appendChild(b);g.insertAfter(e);this.moveToPosition(e,a.POSITION_AFTER_END);return g},moveToElementEditablePosition:function(e,b){for(var g=0;e;){if(e[0].nodeType==f.TEXT_NODE){this.moveToPosition(e,b?a.POSITION_AFTER_END:a.POSITION_BEFORE_START);g=1;break}e[0].nodeType==f.ELEMENT_NODE&&e._4e_isEditable()&&(this.moveToPosition(e,b?a.POSITION_BEFORE_END:a.POSITION_AFTER_START),g=1);var i=e,d=g,l=void 0;i[0].nodeType==f.ELEMENT_NODE&&
i._4e_isEditable()&&(l=i[b?"last":"first"](c,1));!d&&!l&&(l=i[b?"prev":"next"](c,1));e=l}return!!g},selectNodeContents:function(a){var e=a[0];this.setStart(a,0);this.setEnd(a,e.nodeType==f.TEXT_NODE?e.nodeValue.length:e.childNodes.length)},insertNodeByDtd:function(a){var b,g,f,c=a.nodeName();b=e.$block[c];this.deleteContents();if(b){for(b=this.getCommonAncestor(s,m);(g=e[b.nodeName()])&&(!g||!g[c]);){var i=b.parent();this.checkStartOfBlock()&&this.checkEndOfBlock()?(this.setStartBefore(b),this.collapse(m),
b.remove()):f=b;b=i}f&&this.splitElement(f)}this.insertNode(a)}});t.injectDom({_4e_breakParent:function(a,e){var e=i(e),a=i(a),b,g=new n.Range(a[0].ownerDocument);g.setStartAfter(a);g.setEndAfter(e);b=g.extractContents();g.insertNode(a.remove());a.after(b)}});n.Range=w},{requires:["./base","./utils","./walker","./elementPath","./dom"]});
KISSY.add("editor/core/selection",function(d){function n(a){this.document=a;this._={cache:{}};if(m)try{var b=this.getNative().createRange();if(!b||b.item&&b.item(0).ownerDocument!=a||b.parentElement&&b.parentElement().ownerDocument!=a)this.isInvalid=q}catch(f){this.isInvalid=q}}function t(a){a=new n(a);return!a||a.isInvalid?h:a}var u=d.Editor;u.SELECTION={SELECTION_NONE:1,SELECTION_TEXT:2,SELECTION_ELEMENT:3};var q=!0,h=null,c=d.UA,k=d.DOM,o=d.Node,p=u.SELECTION,w=u.RANGE,m=c.ie,s=u.Walker,x=u.Range,
a={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};d.augment(n,{getNative:!m?function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=k._getWin(this.document).getSelection())}:function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=this.document.selection)},getType:!m?function(){var b=this._.cache;if(b.type)return b.type;var g=p.SELECTION_TEXT,f=this.getNative();if(f){if(1==f.rangeCount){var f=
f.getRangeAt(0),c=f.startContainer;c==f.endContainer&&c.nodeType==k.ELEMENT_NODE&&1==Number(f.endOffset-f.startOffset)&&a[c.childNodes[f.startOffset].nodeName.toLowerCase()]&&(g=p.SELECTION_ELEMENT)}}else g=p.SELECTION_NONE;return b.type=g}:function(){var a=this._.cache;if(a.type)return a.type;var b=p.SELECTION_NONE;try{var f=this.getNative(),c=f.type;"Text"==c&&(b=p.SELECTION_TEXT);"Control"==c&&(b=p.SELECTION_ELEMENT);f.createRange().parentElement&&(b=p.SELECTION_TEXT)}catch(d){}return a.type=b},
getRanges:m?function(){var a=function(a,b){a=a.duplicate();a.collapse(b);for(var e=a.parentElement(),f=e.childNodes,c,d=0;d<f.length;d++){var j=f[d];if(j.nodeType==k.ELEMENT_NODE){c=a.duplicate();c.moveToElementText(j);var j=c.compareEndPoints("StartToStart",a),n=c.compareEndPoints("EndToStart",a);c.collapse();if(0<j)break;else{if(!j||1==n&&-1==j)return{container:e,offset:d};if(!n)return{container:e,offset:d+1}}c=h}}c||(c=a.duplicate(),c.moveToElementText(e),c.collapse(!1));c.setEndPoint("StartToStart",
a);c=(""+c.text).replace(/\r\n|\r/g,"\n").length;try{for(;0<c;)c-=f[--d].nodeValue.length}catch(m){c=0}return 0===c?{container:e,offset:d}:{container:f[d],offset:-c}};return function(b){var f=this._.cache;if(f.ranges&&!b)return f.ranges;var c=this.getNative(),b=c&&c.createRange(),d=this.getType();if(!c)return[];if(d==p.SELECTION_TEXT)return c=new x(this.document),d=a(b,q),c.setStart(new o(d.container),d.offset),d=a(b),c.setEnd(new o(d.container),d.offset),f.ranges=[c];if(d==p.SELECTION_ELEMENT){f=
f.ranges=[];for(d=0;d<b.length;d++){for(var h=b.item(d),j=h.parentNode,k=0,c=new x(this.document);k<j.childNodes.length&&j.childNodes[k]!=h;k++);c.setStart(new o(j),k);c.setEnd(new o(j),k+1);f.push(c)}return f}return f.ranges=[]}}():function(a){var b=this._.cache;if(b.ranges&&!a)return b.ranges;var a=[],f=this.getNative();if(!f)return[];for(var c=0;c<f.rangeCount;c++){var d=f.getRangeAt(c),h=new x(this.document);h.setStart(new o(d.startContainer),d.startOffset);h.setEnd(new o(d.endContainer),d.endOffset);
a.push(h)}return b.ranges=a},getStartElement:function(){var a=this._.cache;if(void 0!==a.startElement)return a.startElement;var b,f=this.getNative();switch(this.getType()){case p.SELECTION_ELEMENT:return this.getSelectedElement();case p.SELECTION_TEXT:var c=this.getRanges()[0];if(c&&!c.collapsed){for(c.optimize();q;)if(b=c.startContainer,c.startOffset==(b[0].nodeType===k.ELEMENT_NODE?b[0].childNodes.length:b[0].nodeValue.length)&&!b._4e_isBlockBoundary())c.setStartAfter(b);else break;b=c.startContainer;
if(b[0].nodeType!=k.ELEMENT_NODE)return b.parent();b=new o(b[0].childNodes[c.startOffset]);if(!b[0]||b[0].nodeType!=k.ELEMENT_NODE)return c.startContainer;for(c=b[0].firstChild;c&&c.nodeType==k.ELEMENT_NODE;)b=new o(c),c=c.firstChild;return b}if(m)c=f.createRange(),c.collapse(q),b=new o(c.parentElement());else{if((b=f.anchorNode)&&b.nodeType!=k.ELEMENT_NODE)b=b.parentNode;b&&(b=new o(b))}}return a.startElement=b},getSelectedElement:function(){var b,c=this._.cache;if(void 0!==c.selectedElement)return c.selectedElement;
m&&(b=this.getNative().createRange(),b=b.item&&b.item(0));var f;if(b)f=new o(b);else{b=this.getRanges()[0];for(var d,h=2;h&&(!(f=b.getEnclosedNode())||!(f[0].nodeType==k.ELEMENT_NODE&&a[f.nodeName()]&&(d=f)));h--)b.shrink(w.SHRINK_ELEMENT);f=d}return c.selectedElement=f},reset:function(){this._.cache={}},selectElement:function(a){var b,c=this.document;if(m)try{b=c.body.createControlRange(),b.addElement(a[0]),b.select()}catch(f){b=c.body.createTextRange(),b.moveToElementText(a[0]),b.select()}finally{}else b=
c.createRange(),b.selectNode(a[0]),a=this.getNative(),a.removeAllRanges(),a.addRange(b);this.reset()},selectRanges:function(a){if(m){if(1<a.length){var b=a[a.length-1];a[0].setEnd(b.endContainer,b.endOffset);a.length=1}a[0]&&a[0].select()}else{b=this.getNative();if(!b)return;b.removeAllRanges();for(var f=0;f<a.length;f++){var d=a[f],h=this.document.createRange(),j=d.startContainer;if(d.collapsed&&(c.gecko&&1.09>c.gecko||c.opera||c.webkit)&&j[0].nodeType==k.ELEMENT_NODE&&!j[0].childNodes.length)j[0].appendChild(this.document.createTextNode(c.webkit?
"\u200b":"")),d.startOffset++,d.endOffset++;h.setStart(j[0],d.startOffset);h.setEnd(d.endContainer[0],d.endOffset);b.addRange(h)}}this.reset()},createBookmarks2:function(a){for(var b=[],c=this.getRanges(),f=0;f<c.length;f++)b.push(c[f].createBookmark2(a));return b},createBookmarks:function(a,b){for(var c=[],f=this.document,h,b=b||this.getRanges(),j=b.length,n=0;n<j;n++){c.push(h=b[n].createBookmark(a,q));var m=(a=h.serializable)?d.one("#"+h.startNode,f):h.startNode;h=a?d.one("#"+h.endNode,f):h.endNode;
for(var o=n+1;o<j;o++){var p=b[o],s=p.startContainer,t=p.endContainer;k.equals(s,m.parent())&&p.startOffset++;k.equals(s,h.parent())&&p.startOffset++;k.equals(t,m.parent())&&p.endOffset++;k.equals(t,h.parent())&&p.endOffset++}}return c},selectBookmarks:function(a){for(var b=[],c=0;c<a.length;c++){var f=new x(this.document);f.moveToBookmark(a[c]);b.push(f)}this.selectRanges(b);return this},getCommonAncestor:function(){var a=this.getRanges();return a[0].startContainer._4e_commonAncestor(a[a.length-
1].endContainer)},scrollIntoView:function(){var a=this.getStartElement();a&&a.scrollIntoView(void 0,!1)},removeAllRanges:function(){var a=this.getNative();m?a&&a.clear():a&&a.removeAllRanges()}});var b={table:1,tbody:1,tr:1},f=s.whitespaces(q),j=/\ufeff|\u00a0/;x.prototype.select=x.prototype.select=!m?function(){var a=this.startContainer;this.collapsed&&a[0].nodeType==k.ELEMENT_NODE&&!a[0].childNodes.length&&a[0].appendChild(this.document.createTextNode(""));var b=this.document.createRange();b.setStart(a[0],
this.startOffset);try{b.setEnd(this.endContainer[0],this.endOffset)}catch(c){if(0<=c.toString().indexOf("NS_ERROR_ILLEGAL_VALUE"))this.collapse(q),b.setEnd(this.endContainer[0],this.endOffset);else throw c;}a=t(this.document).getNative();a.removeAllRanges();a.addRange(b)}:function(a){var c=this.collapsed,d,h;if(this.startContainer[0]===this.endContainer[0]&&1==this.endOffset-this.startOffset){var r=this.startContainer[0].childNodes[this.startOffset];if(r.nodeType==k.ELEMENT_NODE){(new n(this.document)).selectElement(new o(r));
return}}(this.startContainer[0].nodeType==k.ELEMENT_NODE&&this.startContainer.nodeName()in b||this.endContainer[0].nodeType==k.ELEMENT_NODE&&this.endContainer.nodeName()in b)&&this.shrink(w.SHRINK_ELEMENT,q);var m=this.createBookmark(),r=m.startNode,v;c||(v=m.endNode);m=this.document.body.createTextRange();m.moveToElementText(r[0]);m.moveStart("character",1);if(v)a=this.document.body.createTextRange(),a.moveToElementText(v[0]),m.setEndPoint("EndToEnd",a),m.moveEnd("character",-1);else{for(d=r[0].nextSibling;d&&
!f(d);)d=d.nextSibling;d=!(d&&d.nodeValue&&d.nodeValue.match(j))&&(a||!r[0].previousSibling||r[0].previousSibling&&"br"==k.nodeName(r[0].previousSibling));h=new o(this.document.createElement("span"));h.html("&#65279;");h.insertBefore(r);d&&k.insertBefore(this.document.createTextNode("\ufeff"),r[0]||r)}this.setStartBefore(r);r._4e_remove();if(c){if(d?(m.moveStart("character",-1),m.select(),this.document.selection.clear()):m.select(),h)this.moveToPosition(h,w.POSITION_BEFORE_START),h._4e_remove()}else this.setEndBefore(v),
v._4e_remove(),m.select()};n.getSelection=t;return u.Selection=n},{requires:["./base","./walker","./range","./dom"]});
KISSY.add("editor/core/selectionFix",function(d,n){function t(a){function b(a,b){var c=h.body.createTextRange();try{c.moveToPoint(a,b)}catch(e){c=o}return c}function c(){var a=h.selection.createRange();k&&!a.item&&0===a.compareEndPoints("StartToEnd",a)&&k.select();w.remove(h,"mouseup",c);w.remove(h,"mousemove",d);k=e=0}function d(a){if(a.button){if(a=b(a.pageX,a.pageY))0<a.compareEndPoints("StartToStart",k)?a.setEndPoint("StartToStart",k):a.setEndPoint("EndToEnd",k),a.select()}else c()}var e,g=a.get("window")[0],
h=a.get("document")[0],k;w.on(h,"mousedown contextmenu",function(a){var n=h.documentElement;if(a.target===n&&(e&&c(),!(n.scrollHeight>n.clientHeight)&&(e=1,k=b(a.pageX,a.pageY))))w.on(h,"mouseup",c),w.on(h,"mousemove",d),g.focus(),k.select()})}function u(a){function b(e){if(h){var d=a.getSelection(),j=d&&d.getType(),k=d&&f.selection;if(e&&k&&j==x.SELECTION_NONE&&!f.queryCommandEnabled("InsertImage"))setTimeout(function(){b(c)},50);else{var l;if(!k||!k.type||!("Control"!=k.type&&(l=k.createRange())&&
(l=l.parentElement())&&(l=l.nodeName)&&l.toLowerCase()in{input:1,textarea:1}))g=k&&d.getRanges()[0],a.checkSelectionChange()}}}var f=a.get("document")[0],d=new s(f.body),e=new s(f.documentElement);if(8>n.Utils.ieEngine)e.on("click",function(b){"html"===(new s(b.target)).nodeName()&&a.getSelection().getNative().createRange().select()});var g,h,l=c;e.on("mousedown",function(){l=k});e.on("mouseup",function(){l=c});d.on("focusin",function(a){if("body"==(new s(a.target)).nodeName()&&g){try{l&&g.select()}catch(b){}g=
o}});d.on("focus",function(){h=c;b()});d.on("beforedeactivate",function(a){a.relatedTarget||(h=k,l=c)});d.on("mousedown",function(){h=k});d.on("mouseup",function(){h=c;setTimeout(function(){b(c)},0)});d.on("keydown",function(){h=k});d.on("keyup",function(){h=c;setTimeout(function(){b()},0)})}function q(a){var b=a.get("document")[0];w.on(b,"mouseup keyup",function(){a.checkSelectionChange()})}function h(a){function b(a){var b=n.XHTML_DTD;return a._4e_isBlockBoundary()&&b.$empty[a.nodeName()]}function f(a){return e(a)&&
g(a)}var d=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;|(<\!--[\s\S]*?--\>))?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,e=n.Walker.whitespaces(c),g=n.Walker.bookmark(k,c),h=function(a){return e(a)&&8!=a.nodeType};a.on("selectionChange",function(e){var g=e.path,o=new s(a.get("document")[0].body),e=(e=e.selection)&&e.getRanges()[0],v=g.blockLimit;if(p.gecko){var q=g.block||g.blockLimit,t=q&&q.last(f);q&&q._4e_isBlockBoundary()&&(!t||!(1==t[0].nodeType&&t._4e_isBlockBoundary()))&&
"pre"!=q.nodeName()&&!q._4e_getBogus()&&q._4e_appendBogus()}if(e&&e.collapsed&&!g.block){if("body"==v.nodeName()){if((g=e.fixBlock(c,"p"))&&g[0]!=o[0].lastChild&&g._4e_outerHtml().match(d))if((v=g.next(h,1))&&v[0].nodeType==m.ELEMENT_NODE&&!b[v])e.moveToElementEditablePosition(v),g._4e_remove();else if((v=g.prev(h,1))&&v[0].nodeType==m.ELEMENT_NODE&&!b[v])e.moveToElementEditablePosition(v,v._4e_outerHtml().match(d)?k:c),g._4e_remove();e.select();a.notifySelectionChange()}g=a.get("document")[0];e=
new n.Range(g);e.moveToElementEditablePosition(o,c);"body"!==(new n.ElementPath(e.startContainer)).blockLimit.nodeName()&&(o=(new s(g.createElement("p"))).appendTo(o),p.ie||o._4e_appendBogus())}})}var c=!0,k=!1,o=null,p=d.UA,w=d.Event,m=d.DOM,s=d.Node,x=n.SELECTION;return{init:function(a){a.docReady(function(){p.ie?(t(a),u(a)):q(a)});h(a)}}},{requires:["./base"]});
KISSY.add("editor/core/styles",function(d){function n(a){return!v.attr(a,"_ke_bookmark")}function t(a,b){for(var c in a)a.hasOwnProperty(c)&&(d.isString(a[c])?a[c]=a[c].replace(Q,function(a,c){return b[c]}):t(a[c],b))}function u(a,b){b&&(a=d.clone(a),t(a,b));var c=this.element=this.element=(a.element||"*").toLowerCase();this.type=this.type="#"==c||G[c]?A.STYLE_BLOCK:N[c]?A.STYLE_OBJECT:A.STYLE_INLINE;this._={definition:a}}function q(a,b){var c=b?this.removeFromRange:this.applyToRange;a.body.focus();
for(var e=new F(a),f=e.getRanges(),d=0;d<f.length;d++)c.call(this,f[d]);e.selectRanges(f)}function h(a,b,c){var e=a.element;"*"==e&&(e="span");b=new I(b.createElement(e));c&&c._4e_copyAttributes(b);c=a._.definition;a=c.attributes;c=u.getStyleText(c);if(a)for(var f in a)a.hasOwnProperty(f)&&b.attr(f,a[f]);c&&(b[0].style.cssText=c);return b}function c(a){var b=a.createBookmark(l),c=a.createIterator();c.enforceRealBlocks=l;c.enlargeBr=l;for(var e,f=a.document;e=c.getNextParagraph();){var d=h(this,f,
e),g=d,d="pre"==g.nodeName,j="pre"==e.nodeName,i=!d&&j;d&&!j?(j=e,i=j.html(),i=k(i,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,""),i=i.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1"),i=i.replace(/([ \t\n\r]+|&nbsp;)/g," "),i=i.replace(/<br\b[^>]*>/gi,"\n"),y.ie?(j=j[0].ownerDocument.createElement("div"),j.appendChild(g[0]),g[0].outerHTML="<pre>"+i+"</pre>",g=new I(j.firstChild),g._4e_remove()):g.html(i)):i?g=p(o(e),g):e._4e_moveChildren(g);e[0].parentNode.replaceChild(g[0],e[0]);if(d&&(e=g,d=void 0,(d=e._4e_previousSourceNode(l,
v.ELEMENT_NODE))&&"pre"==d.nodeName()))g=k(d.html(),/\n$/,"")+"\n\n"+k(e.html(),/^\n/,""),y.ie?e[0].outerHTML="<pre>"+g+"</pre>":e.html(g),d._4e_remove()}a.moveToBookmark(b)}function k(a,b,c){var e="",f="",a=a.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(a,b,c){b&&(e=b);c&&(f=c);return""});return e+a.replace(b,c)+f}function o(a){var b=[];k(a._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,function(a,b,c){return b+"</pre>"+
c+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(a,c){b.push(c)});return b}function p(a,b){for(var c=b[0].ownerDocument.createDocumentFragment(),e=0;e<a.length;e++){var f=a[e],f=f.replace(/(\r\n|\r)/g,"\n"),f=k(f,/^[ \t]*\n/,""),f=k(f,/\n$/,""),f=k(f,/^[ \t]+|[ \t]+$/g,function(a,b){return 1==a.length?"&nbsp;":b?" "+Array(a.length).join("&nbsp;"):Array(a.length).join("&nbsp;")+" "}),f=f.replace(/\n/g,"<br>"),f=f.replace(/[ \t]{2,}/g,function(a){return Array(a.length).join("&nbsp;")+" "}),
d=b.clone();d.html(f);c.appendChild(d[0])}return c}function w(a){var b=a.document;if(a.collapsed)b=h(this,b,void 0),a.insertNode(b),a.moveToPosition(b,E.POSITION_BEFORE_END);else{var c=this.element,e=this._.definition,f,d=K[c];d||(f=l,d=K.span);var g=a.createBookmark();a.enlarge(E.ENLARGE_ELEMENT);a.trim();for(var i=a.createBookmark(),k=i.startNode,i=i.endNode,D=k,m;D&&D[0];){var o=r;if(v.equals(D,i))D=z,o=l;else{var G=D[0].nodeType,q=G==v.ELEMENT_NODE?D.nodeName():z;if(q&&D.attr("_ke_bookmark")){D=
D._4e_nextSourceNode(l);continue}if(!q||d[q]&&(D._4e_position(i)|C.POSITION_PRECEDING|C.POSITION_IDENTICAL|C.POSITION_IS_CONTAINED)==C.POSITION_PRECEDING+C.POSITION_IDENTICAL+C.POSITION_IS_CONTAINED&&(!e.childRule||e.childRule(D))){var p=D.parent();if(p&&"a"==c&&p.nodeName()==c)G=h(this,b,void 0),p._4e_moveChildren(G),p[0].parentNode.replaceChild(G[0],p[0]),G._4e_mergeSiblings();else if(p&&p[0]&&((K[p.nodeName()]||K.span)[c]||f)&&(!e.parentRule||e.parentRule(p))){if(!m&&(!q||!K.$removeEmpty[q]||(D._4e_position(i)|
C.POSITION_PRECEDING|C.POSITION_IDENTICAL|C.POSITION_IS_CONTAINED)==C.POSITION_PRECEDING+C.POSITION_IDENTICAL+C.POSITION_IS_CONTAINED))m=new M(b),m.setStartBefore(D);if(G==v.TEXT_NODE||G==v.ELEMENT_NODE&&!D[0].childNodes.length){p=D;for(G=null;(o=!p.next(n,1))&&(G=p.parent())&&d[G.nodeName()]&&(G._4e_position(k)|C.POSITION_FOLLOWING|C.POSITION_IDENTICAL|C.POSITION_IS_CONTAINED)==C.POSITION_FOLLOWING+C.POSITION_IDENTICAL+C.POSITION_IS_CONTAINED&&(!e.childRule||e.childRule(G));)p=G;m.setEndAfter(p)}}else o=
l}else o=l;D=D._4e_nextSourceNode()}if(o&&m&&!m.collapsed){for(var o=h(this,b,void 0),p=m.getCommonAncestor(),G={},q={},t,s=null,u;o&&p&&o[0]&&p[0];){if(p.nodeName()==c){for(t in e.attributes)if(e.attributes.hasOwnProperty(t)&&!q[t]&&(u=p.attr(s)))o.attr(t)==u?o.removeAttr(t):q[t]=1;for(s in e.styles)if(e.styles.hasOwnProperty(s)&&!G[s]&&(u=p.style(s)))o.style(s)==u?o.style(s,""):G[s]=1;if(!o._4e_hasAttributes()){o=z;break}}p=p.parent()}o?(o[0].appendChild(m.extractContents()),j(this,o),m.insertNode(o),
o._4e_mergeSiblings(),y.ie||o[0].normalize()):(o=new I(b.createElement("span")),o[0].appendChild(m.extractContents()),m.insertNode(o),j(this,o),o._4e_remove(!0));m=z}}k._4e_remove();i._4e_remove();a.moveToBookmark(g);a.shrink(E.SHRINK_TEXT)}}function m(c){c.enlarge(E.ENLARGE_ELEMENT);var f=c.createBookmark(),d=f.startNode;if(c.collapsed){for(var g=new D(d.parent()),h,i=0,j;i<g.elements.length&&(j=g.elements[i])&&!(j==g.block||j==g.blockLimit);i++)if(this.checkElementRemovable(j)){var k=c.checkBoundaryOfElement(j,
E.END),y=!k&&c.checkBoundaryOfElement(j,E.START);y||k?(h=j,h.match=y?"start":"end"):(j._4e_mergeSiblings(),j.nodeName()!=this.element?(k=a(this),e(j,k[j.nodeName()]||k["*"])):b(this,j))}if(h){j=d;for(i=0;;i++){k=g.elements[i];if(v.equals(k,h))break;else if(k.match)continue;else k=k.clone();k[0].appendChild(j[0]);j=k}j["start"==h.match?"insertBefore":"insertAfter"](h)}}else{var l=f.endNode,m=this,g=function(){for(var a=new D(d.parent()),b=new D(l.parent()),c=z,e=z,f=0;f<a.elements.length;f++){var g=
a.elements[f];if(g==a.block||g==a.blockLimit)break;m.checkElementRemovable(g)&&(c=g)}for(f=0;f<b.elements.length;f++){g=b.elements[f];if(g==b.block||g==b.blockLimit)break;m.checkElementRemovable(g)&&(e=g)}e&&l._4e_breakParent(e);c&&d._4e_breakParent(c)};g();for(h=new I(d[0].nextSibling);h[0]!==l[0];){i=h._4e_nextSourceNode();if(h[0]&&h[0].nodeType==v.ELEMENT_NODE&&this.checkElementRemovable(h)&&(h.nodeName()==this.element?b(this,h):(j=a(this),e(h,j[h.nodeName()]||j["*"])),i[0].nodeType==v.ELEMENT_NODE&&
i.contains(d)))g(),i=new I(d[0].nextSibling);h=i}}c.moveToBookmark(f)}function s(a){var b={};(""+a).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(a,c,e){b[c]=e});return b}function x(a,b){var c="";b!==r?(c=document.createElement("span"),c.style.cssText=a,c=c.style.cssText||""):c=a;return c.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function a(a){if(a._.overrides)return a._.overrides;var b=a._.overrides={},c=a._.definition.overrides;
if(c){d.isArray(c)||(c=[c]);for(var e=0;e<c.length;e++){var f=c[e],g,h,i;"string"==typeof f?g=f.toLowerCase():(g=f.element?f.element.toLowerCase():a.element,h=f.attributes,i=f.styles);f=b[g]||(b[g]={});if(h){g=f.attributes=f.attributes||[];for(var j in h)h.hasOwnProperty(j)&&g.push([j.toLowerCase(),h[j]])}if(i){var f=f.styles=f.styles||[],k;for(k in i)i.hasOwnProperty(k)&&f.push([k.toLowerCase(),i[k]])}}}return b}function b(b,c){var e=b._.definition,h=a(b),i=d.merge(e.attributes,(h[c.nodeName()]||
h["*"]||{}).attributes),e=d.merge(e.styles,(h[c.nodeName()]||h["*"]||{}).styles),h=d.isEmptyObject(i)&&d.isEmptyObject(e),j;for(j in i)if(i.hasOwnProperty(j)&&!(("class"==j||b._.definition.fullMatch)&&c.attr(j)!=f(j,i[j])))h=h||!!c.hasAttr(j),c.removeAttr(j);for(var k in e)e.hasOwnProperty(k)&&!(b._.definition.fullMatch&&c.style(k)!=f(k,e[k],l))&&(h=h||!!c.style(k),c.style(k,""));g(c)}function f(a,b,c){var e=new I("<span>");e[c?"style":"attr"](a,b);return e[c?"style":"attr"](a)}function j(c,f){for(var d=
a(c),g=f.all(c.element),h=g.length;0<=--h;)b(c,new I(g[h]));for(var i in d)if(d.hasOwnProperty(i)&&i!=c.element){g=f.all(i);for(h=g.length-1;0<=h;h--){var j=new I(g[h]);e(j,d[i])}}}function e(a,b){var c,e=b&&b.attributes;if(e)for(c=0;c<e.length;c++){var f=e[c][0],d;if(d=a.attr(f)){var h=e[c][1];(h===z||h.test&&h.test(d)||"string"==typeof h&&d==h)&&a[0].removeAttribute(f)}}if(e=b&&b.styles)for(c=0;c<e.length;c++)if(f=e[c][0],h=a.css(f)){var i=e[c][1];(i===z||i.test&&i.test(d)||"string"==typeof i&&
h==i)&&a.css(f,"")}g(a)}function g(a){if(!a._4e_hasAttributes()){var b=a[0].firstChild,c=a[0].lastChild;a._4e_remove(l);b&&(b.nodeType==v.ELEMENT_NODE&&v._4e_mergeSiblings(b),c&&b!=c&&c.nodeType==v.ELEMENT_NODE&&v._4e_mergeSiblings(c))}}var i=d.Editor,l=!0,r=!1,z=null,v=d.DOM,A={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3},E=i.RANGE,F=i.Selection,C=i.POSITION,M=i.Range,I=d.Node,y=d.UA,D=i.ElementPath,G={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},K=i.XHTML_DTD,N={embed:1,hr:1,img:1,li:1,
object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},O=/\s*(?:;\s*|$)/g,Q=/#\((.+?)\)/g;i.STYLE=A;u.prototype={apply:function(a){q.call(this,a,r)},remove:function(a){q.call(this,a,l)},applyToRange:function(a){return(this.applyToRange=this.type==A.STYLE_INLINE?w:this.type==A.STYLE_BLOCK?c:z).call(this,a)},removeFromRange:function(a){return(this.removeFromRange=this.type==A.STYLE_INLINE?m:z).call(this,a)},checkElementRemovable:function(b,c){if(!b)return r;var e=this._.definition,f;if(b.nodeName()==
this.element){if(!c&&!b._4e_hasAttributes())return l;var d=e._AC;if(d)e=d;else{var d={},g=0,h=e.attributes;if(h)for(var i in h)h.hasOwnProperty(i)&&(g++,d[i]=h[i]);if(h=u.getStyleText(e))d.style||g++,d.style=h;d._length=g;e=e._AC=d}if(e._length){for(var j in e)if("_length"!=j&&e.hasOwnProperty(j)){g=b.attr(j)||"";if("style"==j)a:{d=e[j];g=x(g,r);"string"==typeof d&&(d=s(d));"string"==typeof g&&(g=s(g));h=void 0;for(h in d)if(d.hasOwnProperty(h)&&!(h in g&&(g[h]==d[h]||"inherit"==d[h]||"inherit"==
g[h]))){d=r;break a}d=l}else d=e[j]==g;if(d){if(!c)return l}else if(c)return r}if(c)return l}else return l}j=a(this);if(j=j[b.nodeName()]||j["*"]){if(!(e=j.attributes)&&!(f=j.styles))return l;if(e)for(d=0;d<e.length;d++)if(j=e[d][0],j=b.attr(j))if(g=e[d][1],g===z||"string"==typeof g&&j==g||g.test&&g.test(j))return l;if(f)for(d=0;d<f.length;d++)if(j=b.css(f[d][0]))if(e=f[d][1],e===z||"string"==typeof e&&j==e||e.test&&e.test(j))return l}return r},checkActive:function(a){switch(this.type){case A.STYLE_BLOCK:return this.checkElementRemovable(a.block||
a.blockLimit,l);case A.STYLE_OBJECT:case A.STYLE_INLINE:for(var b=a.elements,c=0,e;c<b.length;c++)if(e=b[c],!(this.type==A.STYLE_INLINE&&(v.equals(e,a.block)||v.equals(e,a.blockLimit))))if((this.type!=A.STYLE_OBJECT||e.nodeName()in N)&&this.checkElementRemovable(e,l))return l}return r}};u.getStyleText=function(a){var b=a._ST;if(b)return b;var b=a.styles,c=a.attributes&&a.attributes.style||"",e="";c.length&&(c=c.replace(O,";"));for(var f in b)if(b.hasOwnProperty(f)){var d=b[f],g=(f+":"+d).replace(O,
";");"inherit"==d?e+=g:c+=g}c.length&&(c=x(c));return a._ST=c+e};i.Style=u},{requires:["./range","./selection","./domIterator","./elementPath"]});
KISSY.add("editor/core/utils",function(d){var n=d.Node,t=d.DOM,u=d.UA,q={debugUrl:function(h){var c=d.Config;c.debug||(h=h.replace(/\.(js|css)/i,"-min.$1"));-1==h.indexOf("?t")&&(h=-1!=h.indexOf("?")?h+"&":h+"?",h+="t="+encodeURIComponent(c.tag));return c.base+"editor/"+h},lazyRun:function(d,c,k){var o=d[c],n=d[k];d[c]=function(){o.apply(this,arguments);d[c]=d[k];return n.apply(this,arguments)}},getXY:function(d,c,k,o){k=k.defaultView||k.parentWindow;d-=t.scrollLeft(k);c-=t.scrollTop(k);o&&(o=o.defaultView||
o.parentWindow,k!=o&&k.frameElement&&(o=t.offset(k.frameElement,void 0,o),d+=o.left,c+=o.top));return{left:d,top:c}},tryThese:function(d){for(var c,k=0,o=arguments.length;k<o;k++){var n=arguments[k];try{c=n();break}catch(q){}}return c},arrayCompare:function(d,c){if(!d&&!c)return!0;if(!d||!c||d.length!=c.length)return!1;for(var k=0;k<d.length;k++)if(d[k]!==c[k])return!1;return!0},clearAllMarkers:function(d){for(var c in d)d.hasOwnProperty(c)&&d[c]._4e_clearMarkers(d,!0,void 0)},ltrim:function(d){return d.replace(/^\s+/,
"")},rtrim:function(d){return d.replace(/\s+$/,"")},isNumber:function(h){return/^\d+(.\d+)?$/.test(d.trim(h))},verifyInputs:function(h){for(var c=0;c<h.length;c++){var k=new n(h[c]),o=d.trim(q.valInput(k)),p=k.attr("data-verify"),k=k.attr("data-warning");if(p&&!RegExp(p).test(o))return alert(k),!1}return!0},sourceDisable:function(d,c){d.on("sourceMode",c.disable,c);d.on("wysiwygMode",c.enable,c)},resetInput:function(d){var c=d.attr("placeholder");c&&u.ie?(d.addClass("ks-editor-input-tip"),d.val(c)):
u.ie||d.val("")},valInput:function(d,c){if(void 0===c)return d.hasClass("ks-editor-input-tip")?"":d.val();d.removeClass("ks-editor-input-tip");d.val(c)},placeholder:function(h,c){h.attr("placeholder",c);u.ie&&(h.on("blur",function(){d.trim(h.val())||(h.addClass("ks-editor-input-tip"),h.val(c))}),h.on("focus",function(){h.removeClass("ks-editor-input-tip");d.trim(h.val())==c&&h.val("")}))},htmlEncode:function(d){return!d?d:(""+d).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,
"&quot;")},normParams:function(h){var h=d.clone(h),c;for(c in h)if(h.hasOwnProperty(c)){var k=h[c];d.isFunction(k)&&(h[c]=k())}return h},map:function(d,c){for(var k=0;k<d.length;k++)d[k]=c(d[k]);return d},ieEngine:document.documentMode||u.ie,preventFocus:function(d){u.ie?d.unselectable(void 0):d.attr("onmousedown","return false;")},injectDom:function(h){d.mix(t,h);for(var c in h)h.hasOwnProperty(c)&&function(c){n.prototype[c]=function(){var o=[].slice.call(arguments,0);o.unshift(this[0]);return(o=
h[c].apply(null,o))&&(o.nodeType||d.isWindow(o))?new n(o):d.isArray(o)&&(o.__IS_NODELIST||o[0]&&o[0].nodeType)?new n(o):o}}(c)},addRes:function(){var h=this.__res=this.__res||[];h.push.apply(h,d.makeArray(arguments))},destroyRes:function(){for(var h=this.__res||[],c=0;c<h.length;c++){var k=h[c];d.isFunction(k)?k():(k.destroy&&k.destroy(),k.remove&&k.remove())}this.__res=[]},getQueryCmd:function(d){return"query"+("-"+d).replace(/-(\w)/g,function(c,d){return d.toUpperCase()})+"Active"}};return d.Editor.Utils=
q},{requires:["./base"]});
KISSY.add("editor/core/walker",function(d,n){function t(a,b){if(this._.end)return k;var e,d=this.range,i,l=this.guard,n=this.type,o=a?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start&&(this._.start=1,d.trim(),d.collapsed))return this.end(),k;if(!a&&!this._.guardLTR){var q=d.endContainer[0],t=q.childNodes[d.endOffset];this._.guardLTR=function(a,b){return b&&(q==a||"body"==p.nodeName(a))?!1:a!=t}}if(a&&!this._.guardRTL){var s=d.startContainer[0],u=0<d.startOffset&&s.childNodes[d.startOffset-
1]||null;this._.guardRTL=function(a,b){return b&&(s==a||"body"==p.nodeName(a))?!1:a!=u}}var w=a?this._.guardRTL:this._.guardLTR;i=l?function(a,b){return w(a,b)===c?c:l(a,b)}:w;this.current?e=this.current[o](c,n,i):a?(e=d.endContainer,0<d.endOffset?(e=new m(e[0].childNodes[d.endOffset-1]),i(e[0])===c&&(e=k)):e=i(e,h)===c?k:e._4e_previousSourceNode(h,n,i,void 0)):(e=d.startContainer,e=new m(e[0].childNodes[d.startOffset]),e.length?i(e[0])===c&&(e=k):e=i(d.startContainer,h)===c?k:d.startContainer._4e_nextSourceNode(h,
n,i,void 0));for(;e&&!this._.end;){this.current=e;if(!this.evaluator||this.evaluator(e[0])!==c){if(!b)return e}else if(b&&this.evaluator)return c;e=e[o](c,n,i)}this.end();return this.current=k}function u(a){for(var b,c=k;b=t.call(this,a);)c=b;return c}function q(a){this.range=a;this.guard=this.evaluator=k;this._={}}var h=!0,c=!1,k=null,o=d.UA,p=d.DOM,w=n.XHTML_DTD,m=d.Node;d.augment(q,{end:function(){this._.end=1},next:function(){return t.call(this)},previous:function(){return t.call(this,h)},checkForward:function(){return t.call(this,
c,h)!==c},checkBackward:function(){return t.call(this,h,h)!==c},lastForward:function(){return u.call(this)},lastBackward:function(){return u.call(this,h)},reset:function(){delete this.current;this._={}},_iterator:t});d.mix(q,{blockBoundary:function(a){return function(b){return!(b.nodeType==p.ELEMENT_NODE&&p._4e_isBlockBoundary(b,a))}},bookmark:function(a,b){function c(a){return"span"==p.nodeName(a)&&p.attr(a,"_ke_bookmark")}return function(d){var h,k;h=d.nodeType==p.TEXT_NODE&&(k=d.parentNode)&&c(k);
h=a?h:h||c(d);return!!(b^h)}},whitespaces:function(a){return function(b){b=b.nodeType==p.TEXT_NODE&&!d.trim(b.nodeValue);return!!(a^b)}},invisible:function(a){var b=q.whitespaces();return function(c){c=b(c)||c.nodeType==p.ELEMENT_NODE&&!c.offsetHeight;return!!(a^c)}}});var s=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,x=q.whitespaces(),a=q.bookmark(),b=function(b){var c=p.nodeName(b);return a(b)||x(b)||1==b.nodeType&&c in w.$inline&&!(c in w.$empty)};n.Utils.injectDom({_4e_getBogus:function(a){a=new m(a);do a=
a._4e_previousSourceNode();while(a&&b(a[0]));return a&&(!o.ie?"br"==a.nodeName():3==a[0].nodeType&&s.test(a.text()))?a[0]:!1}});return n.Walker=q},{requires:["./base","./utils","./dom"]});KISSY.add("editor/core/zIndexManager",function(d){var n=d.Editor;n.zIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,STORE_FLASH_SHOW:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};n.baseZIndex=function(d){return(n.Config.baseZIndex||1E4)+d}},{requires:["./base"]});
KISSY.add("editor",function(d,n,t,u,q,h,c,k,o,p,w){function m(a,b){var c=a.body;F(function(){a.designMode="on";setTimeout(function(){a.designMode="off";c.focus();arguments.callee.retry||(arguments.callee.retry=j)},50)},function(){a.designMode="off";v.attr(c,"contentEditable",i);v.attr(c,"contentEditable",j);!b&&m(a,1)})}function s(a){a.get("iframe");var b=a.get("textarea")[0],c=a.get("window")[0],e=a.get("document")[0];r.webkit&&(E.on(e,"click",function(a){var b=new A(a.target);d.inArray(b.nodeName(),
["input","select"])&&a.preventDefault()}),E.on(e,"mouseup",function(a){var b=new A(a.target);d.inArray(b.nodeName(),["input","textarea"])&&a.preventDefault()}));if(r.gecko||z||r.opera){var f;f=(new A('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>')).insertAfter(b);f.on("focus",function(){a.focus()});a.activateGecko=function(){r.gecko&&a.__iframeFocus&&f[0].focus()};a.on("destroy",function(){f.detach();f.remove()})}E.on(c,"focus",function(){r.gecko?m(e,i):r.opera&&
e.body.focus();a.notifySelectionChange()});if(r.gecko)E.on(e,"mousedown",function(){a.__iframeFocus||m(e,i)});if(z&&(E.on(e,"keydown",function(b){if(b.keyCode in{8:1,46:1}){var c=a.getSelection(),d=c.getSelectedElement();if(d){a.execCommand("save");var e=c.getRanges()[0].createBookmark();d.remove();c.selectBookmarks([e]);a.execCommand("save");b.preventDefault()}}}),"CSS1Compat"==e.compatMode)){var g={33:1,34:1};E.on(e,"keydown",function(b){b.keyCode in g&&setTimeout(function(){a.getSelection().scrollIntoView()},
0)})}if(r.webkit)E.on(e,"mousedown",function(b){b=new A(b.target);d.inArray(b.nodeName(),["img","hr","input","textarea","select"])&&a.getSelection().selectElement(b)});if(r.gecko)E.on(e,"dragstart",function(a){var b=new A(a.target);b.nodeName()==="img"&&/ke_/.test(b[0].className)&&a.preventDefault()});u.add(a)}function x(a,b,c,e){var f="",g,h=t.debugUrl("theme/editor-iframe.css");for(g=0;g<c.length;g++)f+=d.substitute('<link href="{href}" rel="stylesheet" />',{href:c[g]});return d.substitute(C,{doctype:8===
l.documentMode?'<meta http-equiv="X-UA-Compatible" content="IE=7" />':"",title:"${title}",href:h,style:b,data:e||"&nbsp;",script:a?'<script id="ke_active_script">'+(v.isCustomDomain()?'document.domain="'+l.domain+'";':"")+'parent.KISSY.Editor._initIFrame("'+a+'");<\/script>':""})}function a(a,b){a.__saveTimer&&(clearTimeout(a.__saveTimer),a.__saveTimer=null);a.__saveTimer=setTimeout(function(){a.execCommand("save")},b||0)}function b(a,b){function c(){h=g.document;a.__set("document",new A(h));a.__set("window",
new A(g));d.detach();h.open("text/html","replace");h.write(e);h.close()}var d=a.get("iframe"),e=x(a._UUID,a.get("customStyle"),a.get("customLink"),b),f=d[0],g=f.contentWindow,h;d.__loaded=1;try{h=g.document}catch(i){if(f.src=f.src,7>z){setTimeout(c,10);return}}c()}function f(a,c){var d=new A(M),e=a.get("textarea");e.hasAttr("tabindex")&&d.attr("tabIndex",r.webkit?-1:e.attr("tabIndex"));e.parent().prepend(d);a.set("iframe",d);a.__docReady=0;if(r.gecko&&!d.__loaded)d.on("load",function(){b(a,c)},a);
else b(a,c)}var j=!0,e=e,g=d.all,i=!1,l=document,r=d.UA,z=r.ie,v=d.DOM,A=d.Node,E=d.Event,F=t.tryThese,C="<!doctype html><html><head>{doctype}<title>{title}</title><link href='{href}' rel='stylesheet' /><style>{style}</style>{links}</head><body class='ks-editor'>{data}{script}</body></html>",q=v.getEmptyIframeSrc(),M='<iframe style="width:100%;height:100%;border:none;"  frameborder="0"  title="kissy-editor"  allowTransparency="true" '+(q?' src="'+q+'"':"")+"</iframe>";d.mix(n,{SOURCE_MODE:0,WYSIWYG_MODE:1});
var I=n.WYSIWYG_MODE;d.augment(n,{createDom:function(){var a,b=this.get("textarea"),c;b||this.set("textarea",b=g("<textarea class='ks-editor-textarea'></textarea>"));c=this.get("el");c.html('<div class="ks-editor-tools"></div><div class="ks-editor-textarea-wrap"></div><div class=\'ks-editor-status\'></div>');a=c.one(".ks-editor-textarea-wrap");this._UUID=d.guid();this.set({toolBarEl:c.one(".ks-editor-tools"),statusBarEl:c.one(".ks-editor-status")},{silent:1});b.css("width","100%");b.css("display",
"none");a.append(b);u.register(this)},renderUI:function(){k.init(this);o.init(this);p.init(this);w.init(this)},bindUI:function(){function a(){b.detach("docReady",a);if(b.get("focused"))b.focus();else{var c=b.getSelection();c&&c.removeAllRanges()}}var b=this,c,d=b.get("prefixCls"),e=b.get("textarea");if(b.get("attachForm")&&(c=e[0].form))v.on(c,"submit",b.sync,b),b.on("destroy",function(){v.detach(c,"submit",b.sync,b)});b.on("docReady",a);b.on("blur",function(){b.get("el").removeClass(d+"editor-focused")});
b.on("focus",function(){b.get("el").addClass(d+"editor-focused")})},syncUI:function(){var a=this.get("height");a&&this._uiSetHeight(a)},_uiSetHeight:function(a){var b=this.get("textarea"),c=this.get("toolBarEl"),d=this.get("statusBarEl"),a=parseInt(a,10),a=a-((c&&c.outerHeight()||0)+(d&&d.outerHeight()||0));b.parent().css("height",a);b.css("height",a)},_uiSetMode:function(a){var b=this,c,d=b.get("render"),e=b.get("iframe"),f=b.get("textarea");a==I?(d&&b.execCommand("save"),b.on("docReady",c=function(){d&&
b.execCommand("save");b.detach("docReady",c)}),b._setData(f.val()),b.fire("wysiwygMode")):(f.val(b._getData(1,I)),f[0].focus(),f.show(),e.hide(),b.fire("sourceMode"))},_uiSetFocused:function(a){a&&this.__docReady&&this.focus()},destructor:function(){var a=this.get("document")[0],b=this.get("window");this.sync();u.remove(this);E.remove([a,a.documentElement,a.body,b[0]]);d.each(this.__controls,function(a){a.destroy&&a.destroy()});this.__commands={};this.__controls={}},getControl:function(a){return this.__controls[a]},
getControls:function(){return this.__controls},addControl:function(a,b){this.__controls[a]=b},showDialog:function(a,b){var a=a+"/dialog",c=this.__controls[a];c.show(b);this.fire("dialogShow",{dialog:c.dialog,pluginDialog:c,dialogName:a})},addCommand:function(a,b){this.__commands[a]=b},hasCommand:function(a){return this.__commands[a]},execCommand:function(a){var b=this.__commands[a],c=d.makeArray(arguments);c.shift();c.unshift(this);if(b)return b.exec.apply(b,c)},_getData:function(a,b){var c=this.htmlDataProcessor,
f;b==e&&(b=this.get("mode"));f=b==I?this.get("document")[0].body.innerHTML:c.toDataFormat(this.get("textarea").val());f=a?c.toHtml(f):c.toServer(f);f=d.trim(f);/^(?:<(p)>)?(?:(?:&nbsp;)|\s)*(?:<\/\1>)?$/.test(f)&&(f="");return f},_setData:function(a){var b,c=a;if(this.get("mode")!=I)this.get("textarea").val(a);else{if(b=this.htmlDataProcessor)c=b.toDataFormat(a,"p");if(this.get("iframe")){a=this.get("iframe");b=this.get("window")[0];var d=this.get("document")[0];E.remove([d,d.documentElement,d.body,
b]);a.remove()}f(this,c)}},sync:function(){this.get("textarea").val(this.get("data"))},getDocHtml:function(){return x(0,this.get("customStyle"),this.get("customLink"),this.get("formatData"))},getSelection:function(){return n.Selection.getSelection(this.get("document")[0])},focus:function(){var a=this.get("document")[0],b=v._getWin(a);r.ie||b&&b.parent&&b.parent.focus();b&&b.focus();a.body.focus();this.notifySelectionChange()},blur:function(){v._getWin(this.get("document")[0]).blur();this.get("document")[0].body.blur()},
addCustomStyle:function(a,b){var c=this.get("customStyle")||"",c=c+("\n"+a);this.set("customStyle",c);v.addStyleSheet(this.get("window"),c,b)},removeCustomStyle:function(a){v.remove(v.get("#"+a,this.get("window")[0]))},addCustomLink:function(a){var b=this.get("customLink")||[],c=this.get("document")[0];b.push(a);this.set("customLink",b);b=c.createElement("link");b.rel="stylesheet";c.getElementsByTagName("head")[0].appendChild(b);b.href=a},removeCustomLink:function(a){for(var b=this.get("document")[0],
b=v.query("link",b),c=0;c<b.length;c++)v.attr(b[c],"href")==a&&v.remove(b[c]);b=this.get("customLink")||[];a=d.indexOf(a,b);-1!=a&&b.splice(a,1)},docReady:function(a){this.on("docReady",a);this.__docReady&&a.call(this)},checkSelectionChange:function(){var a=this;a.__checkSelectionChangeId&&clearTimeout(a.__checkSelectionChangeId);a.__checkSelectionChangeId=setTimeout(function(){var b=a.getSelection();if(b&&!b.isInvalid){var c=b.getStartElement(),d=new n.ElementPath(c);if(!a.__previousPath||!a.__previousPath.compare(d))a.__previousPath=
d,a.fire("selectionChange",{selection:b,path:d,element:c})}},100)},notifySelectionChange:function(){this.__previousPath=null;this.checkSelectionChange()},insertElement:function(b){if(this.get("mode")===I){this.focus();var c,d=b.nodeName(),f=n.XHTML_DTD,g=f.$block[d],h=n.RANGE,i=(d=this.getSelection())&&d.getRanges(),k,l,m;if(i&&0!=i.length){this.execCommand("save");for(l=i.length-1;0<=l;l--)k=i[l],c=!l&&b||b.clone(j),k.insertNodeByDtd(c),m||(m=c);if(m)return k.moveToPosition(m,h.POSITION_AFTER_END),
g&&(b=n.Walker.whitespaces(!0),(b=(m=m.next(b,1))&&m[0].nodeType==v.ELEMENT_NODE&&m.nodeName())&&f.$block[b]&&f[b]["#"]&&k.moveToElementEditablePosition(m)),d.selectRanges([k]),this.focus(),c&&c.scrollIntoView(e,!1),a(this),c}}},insertHtml:function(b,c){var d=this,f;if(d.get("mode")===I){if(f=d.htmlDataProcessor)b=f.toDataFormat(b,null,c);d.focus();d.execCommand("save");var g=d.get("document")[0];f=0;if(z){var h=g.selection;"Control"==h.type&&h.clear();try{h.createRange().pasteHTML(b)}catch(j){}}else try{g.execCommand("inserthtml",
i,b)}catch(k){setTimeout(function(){if(0==d.getSelection().getRanges().length){var a=new n.Range(g),c=v.first(g.body,function(a){return 1==a.nodeType&&"br"!=v.nodeName(a)});c||(c=new A(g.createElement("p")),c._4e_appendBogus(e),g.body.appendChild(c[0]));a.setStartAt(c,n.RANGE.POSITION_AFTER_START);a.select()}g.execCommand("inserthtml",i,b)},f=100)}setTimeout(function(){d.getSelection().scrollIntoView()},f);a(d,f)}}});n._initIFrame=function(a){var b=u.getInstance(a),c=b.get("document")[0],a=c.getElementById("ke_active_script");
v.remove(a);s(b);var d=c.body;z?(d.hideFocus=j,d.disabled=j,d.contentEditable=j,d.removeAttribute("disabled")):setTimeout(function(){r.gecko||r.opera?d.contentEditable=j:r.webkit?d.parentNode.contentEditable=j:c.designMode="on"},0);if(r.gecko||r.opera){var e=c.documentElement;E.on(e,"mousedown",function(a){if(a.target==e){r.gecko&&m(c,i);b.activateGecko()}})}setTimeout(function(){z&&setTimeout(function(){if(c){d.runtimeStyle.marginBottom="0px";d.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){b.__docReady=
1;b.fire("docReady");var a=b.get("disableObjectResizing"),e=b.get("disableInlineTableEditing");if(a||e)try{c.execCommand("enableObjectResizing",i,!a);c.execCommand("enableInlineTableEditing",i,!e)}catch(f){E.on(d,z?"resizestart":"resize",function(b){var c=new A(b.target);(a||c.nodeName()==="table"&&e)&&b.preventDefault()})}},10)};return n},{requires:"editor/core/base,editor/core/utils,editor/core/focusManager,editor/core/styles,editor/core/zIndexManager,editor/core/meta,editor/core/clipboard,editor/core/enterKey,editor/core/htmlDataProcessor,editor/core/selectionFix".split(",")});
