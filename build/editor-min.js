/*
Copyright 2012, KISSY UI Library v1.30dev
MIT Licensed
build time: Jun 7 00:48
*/
/*
 thanks to CKSource's intelligent work on CKEditor
 @author yiminghe@gmail.com
*/
KISSY.add("editor/core/base",function(f,o,t){o=t.Controller.extend({initializer:function(){this.__commands={};this.__dialogs={};this.__controls={}},use:function(l,o){var c=this,d=c.__CORE_PLUGINS||["htmlDataProcessor","enterKey","clipboard","selection"];f.isString(l)&&(l=l.split(","));for(var i=l.length-1;0<=i;i--)l[i]||l.splice(i,1);for(i=0;i<d.length;i++){var u=d[i];f.inArray(u,l)||l.unshift(u)}f.each(l,function(d,c){l[c]&&(l[c]="editor/plugin/"+d+"/")});f.use(l,function(){var d=f.makeArray(arguments);
d.shift();for(var i=0;i<d.length;i++)d[i]&&d[i].init(c);o&&o.call(c);c.adjustHeight()});c.__CORE_PLUGINS=[];return c}},{Config:{},XHTML_DTD:o.DTD,ATTRS:{textarea:{},iframe:{},window:{},document:{},iframeWrapEl:{},toolBarEl:{},statusBarEl:{},handleMouseEvents:{value:!1},focusable:{value:!1},mode:{value:1},data:{getter:function(){return this._getData()},setter:function(f){return this._setData(f)}},formatData:{getter:function(){return this._getData(1)},setter:function(f){return this._setData(f)}},customStyle:{value:""},
customLink:{value:[]}}},{xclass:"editor"});o.HTML_PARSER={textarea:function(f){return f.one(this.get("prefixCls")+".editor-textarea")}};f.mix(o,f.EventTarget);return KISSY.Editor=o},{requires:["htmlparser","component","core"]});
KISSY.add("editor/plugin/clipboard/index",function(f){function o(a){this.editor=a;this._init()}function t(a){if(c.ie&&"BackCompat"!=a.get("document")[0].compatMode){var b=a.getSelection(),g;if(b.getType()==w.SELECTION_ELEMENT&&(g=b.getSelectedElement())){var h=b.getRanges()[0],j=new r(a.get("document")[0].createTextNode(""));j.insertBefore(g);h.setStartBefore(j);h.setEndAfter(g);b.selectRanges([h]);setTimeout(function(){g.parent()&&(j.remove(),b.selectElement(g))},0)}}}var l=f.Editor,r=f.Node,c=f.UA,
d=l.Range,i=l.RANGE,u=f.Event;f.augment(o,{_init:function(){var a=this.editor;u.on(a.get("document")[0].body,c.webkit?"paste":c.gecko?"paste":"beforepaste",this._paste,this);u.on(a.get("document")[0].body,"contextmenu",function(){b=1;setTimeout(function(){b=0},10)});a.addCommand("copy",new s("copy"));a.addCommand("cut",new s("cut"));a.addCommand("paste",new s("paste"))},_paste:function(){if(!b){var a=this.editor,k=a.get("document")[0];if(!k.getElementById("ke_pastebin")){var g=a.getSelection(),h=
new d(k),j=new r(c.webkit?"<body></body>":"<div></div>",null,k);j.attr("id","ke_pastebin");c.webkit&&j[0].appendChild(k.createTextNode("\u00a0"));k.body.appendChild(j[0]);j.css({position:"absolute",top:g.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});j.css("left","-1000px");var p=g.createBookmarks();h.setStartAt(j,i.POSITION_AFTER_START);h.setEndAt(j,i.POSITION_BEFORE_END);h.select(!0);setTimeout(function(){j.remove();var h;j=c.webkit&&(h=j.first())&&h.hasClass("Apple-style-span")?
h:j;g.selectBookmarks(p);h=j.html();if(h=f.trim(h.replace(/<span[^>]+_ke_bookmark[^<]*?<\/span>(&nbsp;)*/ig,""))){var b=a.fire("paste",{html:h,holder:j});void 0!==b&&(h=b);b=null;/(class="?Mso|style="[^"]*\bmso\-|w:WordDocument)/.test(h)&&(b=a.htmlDataProcessor.wordFilter);a.insertHtml(h,b)}},0)}}}});var q=function(a,b){var g=a.get("document")[0],h=new r(g.body),j=!1,p=function(){j=!0};h.on(b,p);(7<c.ie?g:g.selection.createRange()).execCommand(b);h.detach(b,p);return j},v=c.ie?function(a,b){return q(a,
b)}:function(a,b){try{return a.get("document")[0].execCommand(b)}catch(g){return!1}},n={cut:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u526a\u5207\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+X)\u6765\u5b8c\u6210",copy:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u590d\u5236\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+C)\u6765\u5b8c\u6210",paste:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u7c98\u8d34\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+V)\u6765\u5b8c\u6210"},s=function(a){this.type=a};s.prototype={exec:function(a){"cut"==this.type&&t(a);(a=v(a,this.type))||alert(n[this.type]);return a}};var w=l.Selection,a={copy:"\u590d\u5236",paste:"\u7c98\u8d34",cut:"\u526a\u5207"},b;l.on("contextmenu",function(e){var b=e.contextmenu,g=b.get("editor"),
h=b.menu.get("contentEl"),j={copy:0,cut:0,paste:0},p;for(p in j)j.hasOwnProperty(p)&&(j[p]=h.one(".ks-editor-paste-"+p),j[p]||function(e){var p=(new r("<a href='#'class='ks-editor-paste-"+e+"'>"+a[e]+"</a>")).appendTo(h);p.on("click",function(a){a.halt();b.hide();setTimeout(function(){g.execCommand(e)},30)});j[e]=p}(p))});return{init:function(a){a.docReady(function(){new o(a)})}}},{requires:["editor"]});
KISSY.add("editor/core/dom",function(f,o,t){function l(a,b){var e=a[b?"next":"prev"](r,1);if(e&&e[0].nodeType==d.ELEMENT_NODE){for(var k=[];e.attr("_ke_bookmark")||e._4e_isEmptyInlineRemovable(r);)if(k.push(e),e=b?e.next(r,1):e.prev(r,1),!e)return;if(a._4e_isIdentical(e,r)){for(var g=new u(b?a[0].lastChild:a[0].firstChild);k.length;)k.shift()._4e_move(a,!b,r);e._4e_moveChildren(a,!b,r);e.remove();g[0]&&g[0].nodeType==d.ELEMENT_NODE&&g._4e_mergeSiblings()}}}var r=r,c=o.XHTML_DTD,d=f.DOM,i=f.UA,u=f.Node,
q={a:1,abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};o.POSITION={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};var v=o.POSITION,n={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,
"table-cell":1,"table-caption":1},s={hr:1},w=function(a){return a&&(a[0]||a)};t.injectDom({_4e_sameLevel:function(a,b){var b=w(b),e=a.parentNode;return e&&e==b.parentNode},_4e_isBlockBoundary:function(a,b){var e=f.merge(s,b);return!(!n[d.css(a,"display")]&&!e[d.nodeName(a)])},_4e_index:function(a,b){for(var e=a.parentNode.childNodes,k,g=-1,h=0;h<e.length;h++)if(k=e[h],!b||!(3==k.nodeType&&k.previousSibling&&3==k.previousSibling.nodeType))if(g++,k===a)return g;return-1},_4e_move:function(a,b,e){b=
w(b);e?b.insertBefore(a,b.firstChild):b.appendChild(a)},_4e_isIdentical:function(a,b){if(!b)return!1;b=w(b);if(d.nodeName(a)!=d.nodeName(b))return!1;var e=a.attributes,k=b.attributes,g=e.length,h=k.length;if(g!=h)return!1;for(var j=0;j<g;j++){var p=e[j],c=p.name;if(p.specified&&d.attr(a,c)!=d.attr(b,c))return!1}if(8>t.ieEngine)for(j=0;j<h;j++)if(p=k[j],c=p.name,p.specified&&d.attr(a,c)!=d.attr(b,c))return!1;return!0},_4e_isEmptyInlineRemovable:function(a){if(!c.$removeEmpty[d.nodeName(a)])return!1;
for(var a=a.childNodes,b=0,e=a.length;b<e;b++){var k=a[b],g=k.nodeType;if(!(g==d.ELEMENT_NODE&&k.getAttribute("_ke_bookmark"))&&(g==d.ELEMENT_NODE&&!d._4e_isEmptyInlineRemovable(k)||g==d.TEXT_NODE&&f.trim(k.nodeValue)))return!1}return!0},_4e_moveChildren:function(a,b,e){b=w(b);if(a!=b)if(e)for(;e=a.lastChild;)b.insertBefore(a.removeChild(e),b.firstChild);else for(;e=a.firstChild;)b.appendChild(a.removeChild(e))},_4e_mergeSiblings:function(a){a=new u(a);q[a.nodeName()]&&(l(a,!0),l(a))},_4e_splitText:function(a,
b){var e=a.ownerDocument;if(a.nodeType==d.TEXT_NODE){if(i.ie&&b==a.nodeValue.length){var k=e.createTextNode("");d.insertAfter(k,a);return k}k=a.splitText(b);e.documentMode&&(e=e.createTextNode(""),d.insertAfter(e,k),d.remove(e));return k}},_4e_parents:function(a,b){var e=[];e.__IS_NODELIST=1;do e[b?"push":"unshift"](a);while(a=a.parentNode);return e},_4e_nextSourceNode:function(a,b,e,k){if(k&&!k.call)var g=w(k),k=function(a){return a!==g};var b=!b&&a.firstChild,h=a;if(!b){if(a.nodeType==d.ELEMENT_NODE&&
k&&!1===k(a,!0))return null;b=a.nextSibling}for(;!b&&(h=h.parentNode);){if(k&&!1===k(h,!0))return null;b=h.nextSibling}return!b||k&&!1===k(b)?null:e&&e!=b.nodeType?d._4e_nextSourceNode(b,!1,e,k):b},_4e_previousSourceNode:function(a,b,e,k){if(k&&!k.call)var g=w(k),k=function(a){return a!==g};var b=!b&&a.lastChild,h=a;if(!b){if(a.nodeType==d.ELEMENT_NODE&&k&&!1===k(a,!0))return null;b=a.previousSibling}for(;!b&&(h=h.parentNode);){if(k&&!1===k(h,!0))return null;b=h.previousSibling}return!b||k&&!1===
k(b)?null:e&&b.nodeType!=e?d._4e_previousSourceNode(b,!1,e,k):b},_4e_commonAncestor:function(a,b){b=w(b);if(a===b)return a;if(d.contains(b,a))return b;var e=a;do if(d.contains(e,b))return e;while(e=e.parentNode);return null},_4e_hasAttributes:9>t.ieEngine?function(a){for(var b=a.attributes,e=0;e<b.length;e++){var k=b[e];switch(k.name){case "class":if(a.getAttribute("class"))return!0;break;default:if(k.specified)return!0}}return!1}:function(a){i.gecko&&a.removeAttribute("_moz_dirty");return a.hasAttributes()},
_4e_position:function(a,b){var e=w(b);if(a.compareDocumentPosition)return a.compareDocumentPosition(e);if(a==e)return v.POSITION_IDENTICAL;if(a.nodeType==d.ELEMENT_NODE&&e.nodeType==d.ELEMENT_NODE){if(d.contains(a,e))return v.POSITION_CONTAINS+v.POSITION_PRECEDING;if(d.contains(e,a))return v.POSITION_IS_CONTAINED+v.POSITION_FOLLOWING;if("sourceIndex"in a)return 0>a.sourceIndex||0>e.sourceIndex?v.POSITION_DISCONNECTED:a.sourceIndex<e.sourceIndex?v.POSITION_PRECEDING:v.POSITION_FOLLOWING}for(var k=
d._4e_address(a),e=d._4e_address(e),g=Math.min(k.length,e.length),h=0;h<=g-1;h++)if(k[h]!=e[h])return k[h]<e[h]?v.POSITION_PRECEDING:v.POSITION_FOLLOWING;return k.length<e.length?v.POSITION_CONTAINS+v.POSITION_PRECEDING:v.POSITION_IS_CONTAINED+v.POSITION_FOLLOWING},_4e_address:function(a,b){for(var e=[],k=a.ownerDocument.documentElement,g=a;g&&g!=k;)e.unshift(d._4e_index(g,b)),g=g.parentNode;return e},_4e_remove:function(a,b){var e=a.parentNode;if(e){if(b)for(var k;k=a.firstChild;)e.insertBefore(a.removeChild(k),
a);e.removeChild(a)}return a},_4e_trim:function(a){d._4e_ltrim(a);d._4e_rtrim(a)},_4e_ltrim:function(a){for(var b;b=a.firstChild;){if(b.nodeType==d.TEXT_NODE){var e=t.ltrim(b.nodeValue),k=b.nodeValue.length;if(e)e.length<k&&(d._4e_splitText(b,k-e.length),a.removeChild(a.firstChild));else{a.removeChild(b);continue}}break}},_4e_rtrim:function(a){for(var b;b=a.lastChild;){if(b.type==d.TEXT_NODE){var e=t.rtrim(b.nodeValue),k=b.nodeValue.length;if(e)e.length<k&&(d._4e_splitText(b,e.length),a.removeChild(a.lastChild));
else{a.removeChild(b);continue}}break}!i.ie&&!i.opera&&(b=a.lastChild)&&1==b.nodeType&&"br"==d.nodeName(b)&&a.removeChild(b)},_4e_appendBogus:function(a){for(var b=a.lastChild;b&&b.nodeType==d.TEXT_NODE&&!f.trim(b.nodeValue);)b=b.previousSibling;if(!b||b.nodeType==d.TEXT_NODE||"br"!==d.nodeName(b))b=i.opera?a.ownerDocument.createTextNode(""):a.ownerDocument.createElement("br"),i.gecko&&b.setAttribute("type","_moz"),a.appendChild(b)},_4e_outerHtml:function(a){if(a.outerHTML)return a.outerHTML.replace(/<\?[^>]*>/,
"");var b=a.ownerDocument.createElement("div");b.appendChild(a.cloneNode(!0));return b.innerHTML},_4e_setMarker:function(a,b,e,k){var a=new u(a),g=a.data("list_marker_id")||a.data("list_marker_id",f.guid()).data("list_marker_id"),h=a.data("list_marker_names")||a.data("list_marker_names",{}).data("list_marker_names");b[g]=a;h[e]=1;return a.data(e,k)},_4e_clearMarkers:function(a,b,e){var a=new u(a),k=a.data("list_marker_names"),g=a.data("list_marker_id"),h;for(h in k)k.hasOwnProperty(h)&&a.removeData(h);
a.removeData("list_marker_names");e&&(a.removeData("list_marker_id"),delete b[g])},_4e_copyAttributes:function(a,b,e){for(var b=new u(b),k=a.attributes,e=e||{},g=0;g<k.length;g++){var h=k[g],j=h.name.toLowerCase(),p;if(!(j in e))if("checked"==j&&(p=d.attr(a,j)))b.attr(j,p);else if(h.specified||i.ie&&h.value&&"value"==j)p=d.attr(a,j),null===p&&(p=h.nodeValue),b.attr(j,p)}""!==a.style.cssText&&(b[0].style.cssText=a.style.cssText)},_4e_isEditable:function(a){a=d.nodeName(a);return(a=!c.$nonEditable[a]&&
(c[a]||c.span))&&a["#"]},_4e_getByAddress:function(a,b,e){for(var a=a.documentElement,k=0;a&&k<b.length;k++){var g=b[k];if(e)for(var h=-1,j=0;j<a.childNodes.length;j++){var p=a.childNodes[j];if(!(!0===e&&3==p.nodeType&&p.previousSibling&&3==p.previousSibling.nodeType)&&(h++,h==g)){a=p;break}}else a=a.childNodes[g]}return a}})},{requires:["./base","./utils"]});
KISSY.add("editor/core/domIterator",function(f){function o(d){1>arguments.length||(this.range=d,this.forceBrBreak=l,this.enlargeBr=t,this.enforceRealBlocks=l,this._||(this._={}))}var t=!0,l=!1,r=f.Editor,c=f.UA,d=r.Walker,i=r.Range,u=r.RANGE,q=r.ElementPath,v=f.Node,n=f.DOM,s=/^[\r\n\t ]*$/;f.augment(o,{getNextParagraph:function(w){var a,b,e,k,g;if(!this._.lastNode){b=this.range.clone();b.shrink(u.SHRINK_ELEMENT,t);b.enlarge(this.forceBrBreak||!this.enlargeBr?u.ENLARGE_LIST_ITEM_CONTENTS:u.ENLARGE_BLOCK_CONTENTS);
var h=new d(b),j=d.bookmark(t,t);h.evaluator=j;this._.nextNode=h.next();h=new d(b);h.evaluator=j;h=h.previous();this._.lastNode=h._4e_nextSourceNode(t);this._.lastNode&&this._.lastNode[0].nodeType==n.TEXT_NODE&&!f.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()&&(j=new i(b.document),j.moveToPosition(this._.lastNode,u.POSITION_AFTER_END),j.checkEndOfBlock()&&(j=new q(j.endContainer),this._.lastNode=(j.block||j.blockLimit)._4e_nextSourceNode(t)));this._.lastNode||
(this._.lastNode=this._.docEndMarker=new v(b.document.createTextNode("")),n.insertAfter(this._.lastNode[0],h[0]));b=null}j=this._.nextNode;h=this._.lastNode;for(this._.nextNode=null;j;){var p=l,A=j[0].nodeType!=n.ELEMENT_NODE,y=l;if(A)j[0].nodeType==n.TEXT_NODE&&s.test(j[0].nodeValue)&&(A=l);else{var B=j.nodeName();if(j._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if("br"==B)A=t;else if(!b&&!j[0].childNodes.length&&"hr"!=B){a=j;e=j.equals(h);break}b&&(b.setEndAt(j,u.POSITION_BEFORE_START),"br"!=
B&&(this._.nextNode=j));p=t}else{if(j[0].firstChild){b||(b=new i(this.range.document),b.setStartAt(j,u.POSITION_BEFORE_START));j=new v(j[0].firstChild);continue}A=t}}A&&!b&&(b=new i(this.range.document),b.setStartAt(j,u.POSITION_BEFORE_START));e=(!p||A)&&j.equals(h);if(b&&!p)for(;!j[0].nextSibling&&!e;){B=j.parent();if(B._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){p=t;e||B.equals(h);break}j=B;A=t;e=j.equals(h);y=t}A&&b.setEndAt(j,u.POSITION_AFTER_END);j=j._4e_nextSourceNode(y,null,h);if((e=!j)||
p&&b)break}if(!a){if(!b)return this._.docEndMarker&&this._.docEndMarker._4e_remove(),this._.nextNode=null;a=new q(b.startContainer);j=a.blockLimit;p={div:1,th:1,td:1};a=a.block;if((!a||!a[0])&&!this.enforceRealBlocks&&p[j.nodeName()]&&b.checkStartOfBlock()&&b.checkEndOfBlock())a=j;else if(!a||this.enforceRealBlocks&&"li"==a.nodeName())a=new v(this.range.document.createElement(w||"p")),a[0].appendChild(b.extractContents()),a._4e_trim(),b.insertNode(a),k=g=t;else if("li"!=a.nodeName()){if(!b.checkStartOfBlock()||
!b.checkEndOfBlock())a=a.clone(l),a[0].appendChild(b.extractContents()),a._4e_trim(),g=b.splitBlock(),k=!g.wasStartOfBlock,g=!g.wasEndOfBlock,b.insertNode(a)}else e||(this._.nextNode=a.equals(h)?null:b.getBoundaryNodes().endNode._4e_nextSourceNode(t,null,h))}k&&(b=new v(a[0].previousSibling),b[0]&&b[0].nodeType==n.ELEMENT_NODE&&("br"==b.nodeName()?b._4e_remove():b[0].lastChild&&"br"==n.nodeName(b[0].lastChild)&&n._4e_remove(b[0].lastChild)));g&&(b=d.bookmark(l,t),k=new v(a[0].lastChild),k[0]&&k[0].nodeType==
n.ELEMENT_NODE&&"br"==k.nodeName()&&(c.ie||k.prev(b,1)||k.next(b,1))&&k.remove());this._.nextNode||(this._.nextNode=e||a.equals(h)?null:a._4e_nextSourceNode(t,null,h));return a}});i.prototype.createIterator=function(){return new o(this)}},{requires:["./base","./range","./elementPath","./walker"]});
KISSY.add("editor/core/elementPath",function(f){function o(f){for(var q=c,o=c,n=[];f;){if(f[0].nodeType==l.ELEMENT_NODE){this.lastElement||(this.lastElement=f);var s=f.nodeName();if(!o&&(!q&&d[s]&&(q=f),i[s])){var w;if(w=!q)if(w="div"==s){a:{w=f[0].childNodes;for(var a=0,b=w.length;a<b;a++){var e=w[a];if(e.nodeType==l.ELEMENT_NODE&&r.$block[e.nodeName.toLowerCase()]){w=!0;break a}}w=!1}w=!w}w?q=f:o=f}n.push(f);if("body"==s)break}f=f.parent()}this.block=q;this.blockLimit=o;this.elements=n}var t=f.Editor,
l=f.DOM,r=t.XHTML_DTD,c=null,d={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},i={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};o.prototype={compare:function(d){var c=this.elements,d=d&&d.elements;if(!d||c.length!=d.length)return!1;for(var f=0;f<c.length;f++)if(!l.equals(c[f],d[f]))return!1;return!0},contains:function(d){for(var f=this.elements,i=0;i<f.length;i++)if(f[i].nodeName()in d)return f[i];return c},toString:function(){var d=this.elements,
c,f=[];for(c=0;c<d.length;c++)f.push(d[c].nodeName());return f.toString()}};return t.ElementPath=o},{requires:["./base","./dom"]});
KISSY.add("editor/plugin/enterKey/index",function(f){function o(n){var s;s=n.getSelection().getRanges();for(var o=s.length-1;0<o;o--)s[o].deleteContents();s=s[0];o=s.document;if(s.checkStartOfBlock()&&s.checkEndOfBlock()){var a=(new v(s.startContainer)).block;if(a&&("li"==a.nodeName()||"li"==a.parent().nodeName()))return n.hasCommand("outdent")?(n.execCommand("save"),n.execCommand("outdent"),n.execCommand("save"),!0):!1}var b=s.splitBlock("p");if(!b)return!0;var n=b.previousBlock,a=b.nextBlock,e=
b.wasStartOfBlock,k=b.wasEndOfBlock,g;if(a)g=a.parent(),"li"==g.nodeName()&&(a._4e_breakParent(g),a._4e_move(a.next(),!0));else if(n&&(g=n.parent())&&"li"==g.nodeName())n._4e_breakParent(g),s.moveToElementEditablePosition(n.next()),n._4e_move(n.prev());if(!e&&!k){if("li"==a.nodeName()&&(g=a.first(q.invisible(!0)))&&f.inArray(g.nodeName(),["ul","ol"]))(r.ie?new i(o.createTextNode("\u00a0")):new i(o.createElement("br"))).insertBefore(g);a&&s.moveToElementEditablePosition(a)}else{var h;if(n){if("li"==n.nodeName()||
!c.test(n.nodeName()))h=n.clone()}else a&&(h=a.clone());h||(h=new i("<p>",null,o));if(g=b.elementPath)for(var b=0,j=g.elements.length;b<j;b++){var p=g.elements[b];if(p.equals(g.block)||p.equals(g.blockLimit))break;d.$removeEmpty[p.nodeName()]&&(p=p.clone(),h._4e_moveChildren(p),h.append(p))}r.ie||h._4e_appendBogus();s.insertNode(h);if(r.ie&&e&&(!k||!n[0].childNodes.length))s.moveToElementEditablePosition(k?n:h),s.select();s.moveToElementEditablePosition(e&&!k?a:h)}r.ie||(a?(h=new i(o.createElement("span")),
h.html("&nbsp;"),s.insertNode(h),h.scrollIntoView(void 0,!1),s.deleteContents()):h.scrollIntoView(void 0,!1));s.select();return!0}function t(d){var c=d.get("document")[0];u.on(c,"keydown",function(c){if(13===c.keyCode&&!c.shiftKey&&!c.ctrlKey&&!c.metaKey){d.execCommand("save");var a=d.execCommand("enterBlock");d.execCommand("save");!1!==a&&c.preventDefault()}})}var l=f.Editor,r=f.UA,c=/^h[1-6]$/,d=l.XHTML_DTD,i=f.Node,u=f.Event,q=l.Walker,v=l.ElementPath;return{init:function(d){d.addCommand("enterBlock",
{exec:o});d.docReady(function(){t(d)})}}},{requires:["editor"]});
KISSY.add("editor/core/focusManager",function(f){function o(){var d=this;d.__iframeFocus=q;u=d;i&&clearTimeout(i);i=setTimeout(function(){d.fire("focus")},100)}function t(){var d=this;d.__iframeFocus=v;u=n;i&&clearTimeout(i);i=setTimeout(function(){d.fire("blur")},100)}var l=f.Editor,r=f.DOM,c=f.Event,d={},i,u,f={refreshAll:function(){for(var c in d)if(d.hasOwnProperty(c)){var f=d[c].get("document")[0];f.designMode="off";f.designMode="on"}},currentInstance:function(){return u},getInstance:function(c){return d[c]},
add:function(d){var f=r._getWin(d.get("document")[0]);c.on(f,"focus",o,d);c.on(f,"blur",t,d)},register:function(c){d[c._UUID]=c},remove:function(f){delete d[f._UUID];var i=r._getWin(f.get("document")[0]);c.remove(i,"focus",o,f);c.remove(i,"blur",t,f)}},q=!0,v=!1,n=null;f.refreshAll=f.refreshAll;l.focusManager=f;l.getInstances=function(){return d};return f},{requires:["./base","./dom"]});
KISSY.add("editor/plugin/htmlDataProcessor/index",function(f){return{init:function(o){function t(e){return e.replace(w,function(e,b,h){return"<"+b+h.replace(a,function(a,e){return-1==h.indexOf("_ke_saved_"+e)?" _ke_saved_"+a+" "+a:a})+">"})}function l(a){return a.replace(/<\!--(?!{ke_protected})[\s\S]+?--\>/g,function(a){return"<\!--"+b+"{C}"+encodeURIComponent(a).replace(/--/g,"%2D%2D")+"--\>"})}function r(a){return a.replace(/<\!--\{ke_protected\}\{C\}([\s\S]+?)--\>/g,function(a,e){return decodeURIComponent(e)})}
var c=c,d=f.Editor,i=f.Node,u=f.UA,q=f.require("htmlparser"),v=new q.Filter,n=new q.Filter,s=new q.Filter;(function(){var a=function(a,e){return function(b,g){var d=[];(""+b).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(b,c,x){c=c.toLowerCase();"font-family"==c&&(x=x.replace(/["']/g,""));for(var z,F,p,f=0;f<a.length;f++)if(a[f]&&(b=a[f][0],z=a[f][1],F=a[f][2],p=a[f][3],c.match(b)&&(!z||x.match(z)))){c=p||c;e&&(F=F||x);"function"==typeof F&&(F=F(x,g,c));F&&F.push&&
(c=F[0],F=F[1]);"string"==typeof F&&d.push([c,F]);return}!e&&d.push([c,x])});for(var c=0;c<d.length;c++)d[c]=d[c].join(":");return d.length?d.join(";")+";":!1}}([[/mso/i],[/w:WordDocument/i],[/^-ms/i],[/^-moz/i],[/^-webkit/i]],c),d={tagNames:[[/^script$/i,""],[/^iframe$/i,""],[/^style$/i,""],[/^link$/i,""],[/^meta$/i,""],[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],root:function(a){a.filterChildren()},tags:{p:function(a){a.filterChildren()},$:function(a){var e=a.nodeName||"";if(-1!=e.indexOf(":")&&
!/^ke/.test(e))if("v:imagedata"==e){if(e=a.getAttribute("o:href"))a.setAttribute("src",e),a.removeAttribute("o:href");if(e=a.getAttribute("o:title"))a.setAttribute("title",e),a.removeAttribute("o:title");a.setTagName("img")}else a.setTagName("")}},attributes:{"class":function(a){return!a||/(^|\s+)Mso/.test(a)?!1:a},style:function(h){h=a(h);return!h?!1:h}},attributeNames:[[/^on/,"ke_on"],[/^lang$/,""]]},g={tagNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],tags:{$:function(a){if(a.attributes.length)for(var e=
["name","href","src"],b,g=0;g<e.length;g++)b="_ke_saved_"+e[g],a.getAttribute(b)&&a.removeAttribute(e[g]);return a},embed:function(a){var e=a.parentNode;if(e&&"object"==e.nodeName){var b=e.getAttribute("width"),e=e.getAttribute("height");b&&a.setAttribute("width",b);e&&a.setAttribute("width",e)}},a:function(a){if(!a.childNodes.length&&!a.attributes.length)return!1},span:function(a){if(!a.childNodes.length&&!a.attributes.length)return!1}},attributes:{style:function(a){if(!f.trim(a))return!1}},attributeNames:[[/^_ke_saved_/,
""],[/^ke_on/,"on"],[/^_ke.*/,""],[/^_ks.*/,""],[/^ke:.*$/,""]],comment:function(a){return a.substr(0,b.length)==b?(a="{C}"==a.substr(b.length,3)?a.substr(b.length+3):a.substr(b.length),new q.CData(decodeURIComponent(a))):a}};u.ie&&(g.attributes.style=function(a){return a.replace(/(^|;)([^:]+)/g,function(a){return a.toLowerCase()})});v.addRules(g);n.addRules(d);s.addRules(d)})();(function(){function a(e){for(var e=e.childNodes,x=e.length,b=e[x-1];b&&3==b.nodeType&&!f.trim(b.nodeValue);)b=e[--x];return b}
function b(h,x){var z=a(h);z&&((x||!u.ie)&&1==z.nodeType&&"br"==z.nodeName?h.removeChild(z):3==z.nodeType&&c.test(z.nodeValue)&&h.removeChild(z))}function g(b){var x=a(b);return!x||1==x.nodeType&&"br"==x.nodeName||"form"==b.nodeName&&"input"==x.nodeName}function h(a){b(a,!0);g(a)&&(u.ie?a.appendChild(new q.Text("\u00a0")):(a.appendChild(new q.Text("&nbsp;")),a.appendChild(new q.Tag("br"))))}function j(a){b(a,!1);g(a)&&a.appendChild(new q.Text("\u00a0"))}var c=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,i=d.XHTML_DTD,y=f.merge(i.$block,
i.$listItem,i.$tableContent),o;for(o in y)y.hasOwnProperty(o)&&("br"in i[o]||delete y[o]);delete y.td;delete y.pre;var i={tags:{}},m={tags:{}};for(o in y)y.hasOwnProperty(o)&&(i.tags[o]=h,m.tags[o]=j);n.addRules(i);v.addRules(m);s.addRules(i)})();(function(){v.addRules({text:function(a){return a.replace(/\xa0/g,"&nbsp;")}})})();var w=/<(a|area|img|input)\b([^>]*)>/gi,a=/\b(href|src|name)\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|(?:[^ "'>]+))/gi,b="{ke_protected}";o.htmlDataProcessor={wordFilter:s,dataFilter:n,
htmlFilter:v,toHtml:function(a){var b=new q.BeautifyWriter;(new q.Parser(a)).parse().writeHtml(b,v);return b.getHtml()},toDataFormat:function(a,b,g){g=g||n;u.gecko&&(a=a.replace(/(<\!--\[if[^<]*?\])--\>([\S\s]*?)<\!--(\[endif\]--\>)/gi,"$1$2$3"));a=t(a);b=new i("<div>");b.html("a"+a);a=b.html().substr(1);a=r(a);b=new q.BeautifyWriter;(new q.Parser(a)).parse().writeHtml(b,g);a=b.getHtml();return a=l(a)},toServer:function(a){var b=new q.MinifyWriter;(new q.Parser(a)).parse().writeHtml(b,v);return b.getHtml()}}}}},
{requires:["editor"]});
KISSY.add("editor/core/meta",function(){var f={backColor:["../color/btn","./cmd"],localStorage:["../flashBridge/"],bold:["../font/ui","./cmd"],draft:["../localStorage/","../select/"],flash:["../flashCommon/baseClass","../flashCommon/utils"],fontFamily:["../font/ui","./cmd"],fontSize:["../font/ui","./cmd"],foreColor:["../color/btn","./cmd"],heading:["./cmd"],image:["../button/","../bubbleview/","../contextmenu/","../dialogLoader/"],indent:["./cmd"],orderedList:["../listUtils/btn","./cmd"],unorderedList:["../listUtils/btn",
"./cmd"],italic:["../font/ui","./cmd"],justifyCenter:["./cmd"],justifyLeft:["./cmd"],justifyRight:["./cmd"],link:["../bubbleview/","./utils","../dialogLoader/"],maximize:["./cmd"],multipleUpload:["../dialogLoader/"],outdent:["./cmd"],overlay:["./focus","dd"],pageBreak:["../fakeObjects/"],removeFormat:["./cmd","../button/"],resize:["dd"],smiley:["../overlay/"],sourceArea:["../button/"],strikeThrough:["../font/ui","./cmd"],table:["../dialogLoader/","../contextmenu/"],underline:["../font/ui","./cmd"],
undo:["./btn","./cmd"],video:["../flashCommon/utils","../flashCommon/baseClass"],xiamiMusic:["../flashCommon/baseClass","../flashCommon/utils"]},o,t,l={"backColor/cmd":["../color/cmd"],"bold/cmd":["../font/cmd"],"color/btn":["../button/","../overlay/","../dialogLoader/"],"color/colorPicker/dialog":["../../overlay/"],"dentUtils/cmd":["../listUtils/"],"flash/dialog":["../flashCommon/utils","../overlay/","../select/"],"flashCommon/baseClass":["../contextmenu/","../bubbleview/","../dialogLoader/","./utils"],
"font/ui":["../button/","../select/"],"fontFamily/cmd":["../font/cmd"],"fontSize/cmd":["../font/cmd"],"foreColor/cmd":["../color/cmd"],"image/dialog":["../overlay/","switchable","../select/"],"indent/cmd":["../dentUtils/cmd"],"orderedList/cmd":["../listUtils/cmd"],"unorderedList/cmd":["../listUtils/cmd"],"italic/cmd":["../font/cmd"],"justifyCenter/cmd":["../justifyUtils/cmd"],"justifyLeft/cmd":["../justifyUtils/cmd"],"justifyRight/cmd":["../justifyUtils/cmd"],"link/dialog":["../overlay/","./utils"],
"listUtils/btn":["../button/"],"listUtils/cmd":["../listUtils/"],"multipleUpload/dialog":["../progressbar/","../overlay/","../flashBridge/","../localStorage/"],"outdent/cmd":["../dentUtils/cmd"],"strikeThrough/cmd":["../font/cmd"],"table/dialog":["../overlay/","../select/"],"underline/cmd":["../font/cmd"],"undo/btn":["../button/"],"video/dialog":["../flash/dialog","../select/"],"xiamiMusic/dialog":["../flash/dialog","../select/"]},r={};for(o in f)t="editor/plugin/"+o+"/index",r[t]={requires:f[o]};
for(o in l)t="editor/plugin/"+o,r[t]={requires:l[o]};KISSY.add(r)});
KISSY.add("editor/core/range",function(f,o,t,l,r){function c(a){var b=a.nodeType!=e.TEXT_NODE&&e.nodeName(a)in g.$removeEmpty,h=a.nodeType==e.TEXT_NODE&&!f.trim(a.nodeValue),a=!!a.parentNode.getAttribute("_ke_bookmark");return b||h||a}function d(a){return!A(a)&&!y(a)}function i(a){var b=s;return function(h){if(y(h))return n;if(h.nodeType==e.TEXT_NODE){if(f.trim(h.nodeValue).length)return s}else if(h.nodeType==e.ELEMENT_NODE&&(h=e.nodeName(h),!C[h]))if(!a&&!k.ie&&"br"==h&&!b)b=n;else return s;return n}}
function u(a,b){var g=a.startContainer,d=a.endContainer,j=a.startOffset,c=a.endOffset,m,f=s,p=s,k=void 0,i=a.document,C;if(a.collapsed)return k;0<b&&(k=i.createDocumentFragment());a.optimizeBookmark();d[0].nodeType==e.TEXT_NODE?(p=n,d=d._4e_splitText(c)):0<d[0].childNodes.length&&(c>=d[0].childNodes.length?(d=new h(d[0].appendChild(i.createTextNode(""))),C=n):d=new h(d[0].childNodes[c]));g[0].nodeType==e.TEXT_NODE?(f=n,g._4e_splitText(j)):j?j>=g[0].childNodes.length?(g=new h(g[0].appendChild(i.createTextNode(""))),
m=n):g=new h(g[0].childNodes[j].previousSibling):(m=new h(i.createTextNode("")),g.prepend(m),g=m,m=n);var A=g._4e_parents(),H=d._4e_parents();A.each(function(a,x){A[x]=a});H.each(function(a,x){H[x]=a});for(var E,J,i=0;i<A.length&&!(E=A[i],J=H[i],!E.equals(J));i++);for(var j=k,D,y,o=i;o<A.length;o++){D=A[o];c=0<b&&!D.equals(g)?j.appendChild(D.clone()[0]):null;D=D[0].nextSibling;y=H[o];for(var u=d[0],l=y&&y[0];D&&!(l==D||u==D);)y=D.nextSibling,2==b?j.appendChild(D.cloneNode(n)):(e._4e_remove(D),1==
b&&j.appendChild(D)),D=y;c&&(j=c)}for(j=k;i<H.length;i++){D=H[i];c=0<b&&!D.equals(d)?j.appendChild(D.clone()[0]):null;if(!A[i]||!D._4e_sameLevel(A[i]))for(D=D[0].previousSibling;D;)y=D.previousSibling,2==b?j.insertBefore(D.cloneNode(n),j.firstChild):(e._4e_remove(D),1==b&&j.insertBefore(D,j.firstChild)),D=y;c&&(j=c)}if(2==b){if(f&&(E=g[0],E.nodeType==e.TEXT_NODE&&E.nextSibling&&E.nextSibling.nodeType==e.TEXT_NODE&&(E.data+=E.nextSibling.data,E.parentNode.removeChild(E.nextSibling))),p)p=d[0],p.nodeType==
e.TEXT_NODE&&p.previousSibling&&p.previousSibling.nodeType==e.TEXT_NODE&&(p.previousSibling.data+=p.data,p.parentNode.removeChild(p))}else{if(E&&J&&(!g._4e_sameLevel(E)||!d._4e_sameLevel(J)))p=E._4e_index(),m&&E._4e_sameLevel(g)&&p--,a.setStart(E.parent(),p+1);a.collapse(n)}m&&g.remove();C&&d.remove();return k}function q(a){a.collapsed=a.startContainer&&a.endContainer&&a.startContainer[0]==a.endContainer[0]&&a.startOffset==a.endOffset}function v(a){this.endOffset=this.endContainer=this.startOffset=
this.startContainer=w;this.collapsed=n;this.document=a}o.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var n=!0,s=!1,w=null,a=o.RANGE,b=o.POSITION,e=f.DOM,k=f.UA,g=o.XHTML_DTD,h=f.Node,j=h.all,p={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},A=new l.whitespaces,y=new l.bookmark,B=l.whitespaces(n),m=l.bookmark(!1,
!0),C={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};f.augment(v,{toString:function(){var a=[],b=this.startContainer[0],h=this.endContainer[0];a.push((b.id||b.nodeName)+":"+this.startOffset);a.push((h.id||h.nodeName)+":"+this.endOffset);return a.join("<br/>")},optimize:function(){var a=this.startContainer,b=this.startOffset;a[0].nodeType!=e.ELEMENT_NODE&&(b?b>=a[0].nodeValue.length&&
this.setStartAfter(a):this.setStartBefore(a));a=this.endContainer;b=this.endOffset;a[0].nodeType!=e.ELEMENT_NODE&&(b?b>=a[0].nodeValue.length&&this.setEndAfter(a):this.setEndBefore(a))},setStartAfter:function(a){this.setStart(a.parent(),a._4e_index()+1)},setStartBefore:function(a){this.setStart(a.parent(),a._4e_index())},setEndAfter:function(a){this.setEnd(a.parent(),a._4e_index()+1)},setEndBefore:function(a){this.setEnd(a.parent(),a._4e_index())},optimizeBookmark:function(){var a=this.startContainer,
b=this.endContainer;a&&"span"==a.nodeName()&&a.attr("_ke_bookmark")&&this.setStartBefore(a);b&&"span"==b.nodeName()&&b.attr("_ke_bookmark")&&this.setEndAfter(b)},setStart:function(a,b){a[0].nodeType==e.ELEMENT_NODE&&p[a.nodeName()]&&(a=a.parent(),b=a._4e_index());this.startContainer=a;this.startOffset=b;this.endContainer||(this.endContainer=a,this.endOffset=b);q(this)},setEnd:function(a,b){a[0].nodeType==e.ELEMENT_NODE&&p[a.nodeName()]&&(a=a.parent(),b=a._4e_index()+1);this.endContainer=a;this.endOffset=
b;this.startContainer||(this.startContainer=a,this.startOffset=b);q(this)},setStartAt:function(b,h){switch(h){case a.POSITION_AFTER_START:this.setStart(b,0);break;case a.POSITION_BEFORE_END:b[0].nodeType==e.TEXT_NODE?this.setStart(b,b[0].nodeValue.length):this.setStart(b,b[0].childNodes.length);break;case a.POSITION_BEFORE_START:this.setStartBefore(b);break;case a.POSITION_AFTER_END:this.setStartAfter(b)}q(this)},setEndAt:function(b,h){switch(h){case a.POSITION_AFTER_START:this.setEnd(b,0);break;
case a.POSITION_BEFORE_END:b[0].nodeType==e.TEXT_NODE?this.setEnd(b,b[0].nodeValue.length):this.setEnd(b,b[0].childNodes.length);break;case a.POSITION_BEFORE_START:this.setEndBefore(b);break;case a.POSITION_AFTER_END:this.setEndAfter(b)}q(this)},cloneContents:function(){return u(this,2)},deleteContents:function(){return u(this,0)},extractContents:function(){return u(this,1)},collapse:function(a){a?(this.endContainer=this.startContainer,this.endOffset=this.startOffset):(this.startContainer=this.endContainer,
this.startOffset=this.endOffset);this.collapsed=n},clone:function(){var a=new v(this.document);a.startContainer=this.startContainer;a.startOffset=this.startOffset;a.endContainer=this.endContainer;a.endOffset=this.endOffset;a.collapsed=this.collapsed;return a},getEnclosedNode:function(){var a=this.clone();a.optimize();if(a.startContainer[0].nodeType!=e.ELEMENT_NODE||a.endContainer[0].nodeType!=e.ELEMENT_NODE)return w;var b=new l(a);b.evaluator=function(a){return B(a)&&m(a)};a=b.next();b.reset();b=
b.previous();return a&&a.equals(b)?a:w},shrink:function(b,h){if(!this.collapsed){var b=b||a.SHRINK_TEXT,g=this.clone(),d=this.startContainer,j=this.endContainer,c=this.startOffset,m=this.endOffset,p=n,f,i,k=n;d&&d[0].nodeType==e.TEXT_NODE&&(c?c>=d[0].nodeValue.length?g.setStartAfter(d):(g.setStartBefore(d),p=s):g.setStartBefore(d));j&&j[0].nodeType==e.TEXT_NODE&&(m?m>=j[0].nodeValue.length?g.setEndAfter(j):(g.setEndAfter(j),k=s):g.setEndBefore(j));if(p||k)i=new l(g),i.evaluator=function(h){return h.nodeType==
(b==a.SHRINK_ELEMENT?e.ELEMENT_NODE:e.TEXT_NODE)},i.guard=function(h,g){if(b==a.SHRINK_ELEMENT&&h.nodeType==e.TEXT_NODE||g&&h==f)return s;!g&&h.nodeType==e.ELEMENT_NODE&&(f=h);return n};p&&(g=i[b==a.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(g,h?a.POSITION_AFTER_START:a.POSITION_BEFORE_START);k&&(i.reset(),(i=i[b==a.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(i,h?a.POSITION_BEFORE_END:a.POSITION_AFTER_END));return p||k}},createBookmark2:function(a){var b=this.startContainer,
g=this.endContainer,d=this.startOffset,j=this.endOffset,c,m;if(!b||!g)return{start:0,end:0};if(a){if(b[0].nodeType==e.ELEMENT_NODE&&(c=new h(b[0].childNodes[d]))&&c[0]&&c[0].nodeType==e.TEXT_NODE&&0<d&&c[0].previousSibling.nodeType==e.TEXT_NODE)b=c,d=0;for(;b[0].nodeType==e.TEXT_NODE&&(m=b.prev(void 0,1))&&m[0].nodeType==e.TEXT_NODE;)b=m,d+=m[0].nodeValue.length;if(!this.collapsed){if(g[0].nodeType==e.ELEMENT_NODE&&(c=new h(g[0].childNodes[j]))&&c[0]&&c[0].nodeType==e.TEXT_NODE&&0<j&&c[0].previousSibling.nodeType==
e.TEXT_NODE)g=c,j=0;for(;g[0].nodeType==e.TEXT_NODE&&(m=g.prev(void 0,1))&&m[0].nodeType==e.TEXT_NODE;)g=m,j+=m[0].nodeValue.length}}return{start:b._4e_address(a),end:this.collapsed?w:g._4e_address(a),startOffset:d,endOffset:j,normalized:a,is2:n}},createBookmark:function(b){var g,e,d,j,c=this.collapsed;g=new h("<span>",w,this.document);g.attr("_ke_bookmark",1);g.css("display","none");g.html("&nbsp;");b&&(d=f.guid("ke_bm_"),g.attr("id",d+"S"));c||(e=g.clone(),e.html("&nbsp;"),b&&e.attr("id",d+"E"),
j=this.clone(),j.collapse(),j.insertNode(e));j=this.clone();j.collapse(n);j.insertNode(g);e?(this.setStartAfter(g),this.setEndBefore(e)):this.moveToPosition(g,a.POSITION_AFTER_END);return{startNode:b?d+"S":g,endNode:b?d+"E":e,serializable:b,collapsed:c}},moveToPosition:function(a,b){this.setStartAt(a,b);this.collapse(n)},trim:function(a,b){var g=this.startContainer,h=this.startOffset,d=this.collapsed;if((!a||d)&&g[0]&&g[0].nodeType==e.TEXT_NODE){if(h)if(h>=g[0].nodeValue.length)h=g._4e_index()+1,
g=g.parent();else{var j=g._4e_splitText(h),h=g._4e_index()+1,g=g.parent();e.equals(this.startContainer,this.endContainer)?this.setEnd(j,this.endOffset-this.startOffset):e.equals(g,this.endContainer)&&(this.endOffset+=1)}else h=g._4e_index(),g=g.parent();this.setStart(g,h);if(d){this.collapse(n);return}}g=this.endContainer;h=this.endOffset;!b&&!d&&g[0]&&g[0].nodeType==e.TEXT_NODE&&(h?(h>=g[0].nodeValue.length||g._4e_splitText(h),h=g._4e_index()+1):h=g._4e_index(),g=g.parent(),this.setEnd(g,h))},insertNode:function(a){this.optimizeBookmark();
this.trim(s,n);var b=this.startContainer;b[0].insertBefore(a[0],b[0].childNodes[this.startOffset]||null);b[0]==this.endContainer[0]&&this.endOffset++;this.setStartBefore(a)},moveToBookmark:function(a){var b=j(this.document);if(a.is2){var g=b._4e_getByAddress(a.start,a.normalized),h=a.startOffset,b=a.end&&b._4e_getByAddress(a.end,a.normalized),a=a.endOffset;this.setStart(g,h);b?this.setEnd(b,a):this.collapse(n)}else g=(h=a.serializable)?f.one("#"+a.startNode,b):a.startNode,a=h?f.one("#"+a.endNode,
b):a.endNode,this.setStartBefore(g),g._4e_remove(),a&&a[0]?(this.setEndBefore(a),a._4e_remove()):this.collapse(n)},getCommonAncestor:function(a,b){var g=this.startContainer,d=this.endContainer,g=g[0]==d[0]?a&&g[0].nodeType==e.ELEMENT_NODE&&this.startOffset==this.endOffset-1?new h(g[0].childNodes[this.startOffset]):g:g._4e_commonAncestor(d);return b&&g[0].nodeType==e.TEXT_NODE?g.parent():g},enlarge:function(){function b(a,g,h,d){var c=a[g?"startContainer":"endContainer"],m,x=g?0:1,p=0,f=g?"previousSibling":
"nextSibling";m=a[g?"startOffset":"endOffset"];if(c[0].nodeType==e.TEXT_NODE){if(g){if(m)return}else if(m<c[0].nodeValue.length)return;m=c[0][f];c=c[0].parentNode}else m=c[0].childNodes[m+(g?-1:1)]||null,c=c[0];for(;c;){for(;m;)if(A(m)||y(m))m=m[f];else break;if(m){if(!p)a[g?"setStartAfter":"setEndBefore"](j(m));break}c=j(c);if("body"==c.nodeName())break;if(p||c.equals(d))h[x]=c,p=1;else a[g?"setStartBefore":"setEndAfter"](c);m=c[0][f];c=c[0].parentNode}}return function(g){switch(g){case a.ENLARGE_ELEMENT:if(this.collapsed)break;
var g=this.getCommonAncestor(),d=[];b(this,1,d,g);b(this,0,d,g);d[0]&&d[1]&&(g=d[0].contains(d[1])?d[1]:d[0],this.setStartBefore(g),this.setEndAfter(g));break;case a.ENLARGE_BLOCK_CONTENTS:case a.ENLARGE_LIST_ITEM_CONTENTS:var c=new v(this.document),d=new h(this.document.body);c.setStartAt(d,a.POSITION_AFTER_START);c.setEnd(this.startContainer,this.startOffset);var c=new l(c),m,p,f=l.blockBoundary(g==a.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:w),i=function(a){var b=f(a);b||(m=j(a));return b},k=function(a){var b=
i(a);!b&&"br"==e.nodeName(a)&&(p=j(a));return b};c.guard=i;c=c.lastBackward();m=m||d;this.setStartAt(m,"br"!=m.nodeName()&&(!c&&this.checkStartOfBlock()||c&&m.contains(c))?a.POSITION_AFTER_START:a.POSITION_AFTER_END);c=this.clone();c.collapse();c.setEndAt(d,a.POSITION_BEFORE_END);c=new l(c);c.guard=g==a.ENLARGE_LIST_ITEM_CONTENTS?k:i;m=w;c=c.lastForward();m=m||d;this.setEndAt(m,!c&&this.checkEndOfBlock()||c&&m.contains(c)?a.POSITION_BEFORE_END:a.POSITION_BEFORE_START);p&&this.setEndAfter(p)}}}(),
checkStartOfBlock:function(){var b=this.startContainer,g=this.startOffset;if(g&&b[0].nodeType==e.TEXT_NODE&&f.trim(b[0].nodeValue.substring(0,g)).length)return s;this.trim();b=new r(this.startContainer);g=this.clone();g.collapse(n);g.setStartAt(b.block||b.blockLimit,a.POSITION_AFTER_START);b=new l(g);b.evaluator=i(n);return b.checkBackward()},checkEndOfBlock:function(){var b=this.endContainer,g=this.endOffset;if(b[0].nodeType==e.TEXT_NODE&&f.trim(b[0].nodeValue.substring(g)).length)return s;this.trim();
b=new r(this.endContainer);g=this.clone();g.collapse(s);g.setEndAt(b.block||b.blockLimit,a.POSITION_BEFORE_END);b=new l(g);b.evaluator=i(s);return b.checkForward()},checkBoundaryOfElement:function(b,g){var h=this.clone();h[g==a.START?"setStartAt":"setEndAt"](b,g==a.START?a.POSITION_AFTER_START:a.POSITION_BEFORE_END);h=new l(h);h.evaluator=c;return h[g==a.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var a=this.startContainer,g=this.endContainer,h=this.startOffset,d=this.endOffset,
c;if(a[0].nodeType==e.ELEMENT_NODE)if(c=a[0].childNodes.length,c>h)a=j(a[0].childNodes[h]);else if(0==c)a=a._4e_previousSourceNode();else{for(a=a[0];a.lastChild;)a=a.lastChild;a=j(a);a=a._4e_nextSourceNode()||a}if(g[0].nodeType==e.ELEMENT_NODE)if(c=g[0].childNodes.length,c>d)g=j(g[0].childNodes[d])._4e_previousSourceNode(n);else if(0==c)g=g._4e_previousSourceNode();else{for(g=g[0];g.lastChild;)g=g.lastChild;g=j(g)}a._4e_position(g)&b.POSITION_FOLLOWING&&(a=g);return{startNode:a,endNode:g}},fixBlock:function(b,
g){var h=this.createBookmark(),c=j(this.document.createElement(g));this.collapse(b);this.enlarge(a.ENLARGE_BLOCK_CONTENTS);c[0].appendChild(this.extractContents());c._4e_trim();k.ie||c._4e_appendBogus();this.insertNode(c);this.moveToBookmark(h);return c},splitBlock:function(b){var g=new r(this.startContainer),h=new r(this.endContainer),c=g.block,d=h.block,e=w;if(!g.blockLimit.equals(h.blockLimit))return w;"br"!=b&&(c||(c=this.fixBlock(n,b),d=(new r(this.endContainer)).block),d||(d=this.fixBlock(s,
b)));b=c&&this.checkStartOfBlock();g=d&&this.checkEndOfBlock();this.deleteContents();c&&c[0]==d[0]&&(g?(e=new r(this.startContainer),this.moveToPosition(d,a.POSITION_AFTER_END),d=w):b?(e=new r(this.startContainer),this.moveToPosition(c,a.POSITION_BEFORE_START),c=w):(d=this.splitElement(c),!k.ie&&!f.inArray(c.nodeName(),["ul","ol"])&&c._4e_appendBogus()));return{previousBlock:c,nextBlock:d,wasStartOfBlock:b,wasEndOfBlock:g,elementPath:e}},splitElement:function(b){if(!this.collapsed)return w;this.setEndAt(b,
a.POSITION_BEFORE_END);var g=this.extractContents(),h=b.clone(s);h[0].appendChild(g);h.insertAfter(b);this.moveToPosition(b,a.POSITION_AFTER_END);return h},moveToElementEditablePosition:function(b,g){for(var h=0;b;){if(b[0].nodeType==e.TEXT_NODE){this.moveToPosition(b,g?a.POSITION_AFTER_END:a.POSITION_BEFORE_START);h=1;break}b[0].nodeType==e.ELEMENT_NODE&&b._4e_isEditable()&&(this.moveToPosition(b,g?a.POSITION_BEFORE_END:a.POSITION_AFTER_START),h=1);var c=b,j=h,m=void 0;c[0].nodeType==e.ELEMENT_NODE&&
c._4e_isEditable()&&(m=c[g?"last":"first"](d,1));!j&&!m&&(m=c[g?"prev":"next"](d,1));b=m}return!!h},selectNodeContents:function(a){var b=a[0];this.setStart(a,0);this.setEnd(a,b.nodeType==e.TEXT_NODE?b.nodeValue.length:b.childNodes.length)},insertNodeByDtd:function(a){var b,h,c,d=a.nodeName();b=g.$block[d];this.deleteContents();if(b){for(b=this.getCommonAncestor(s,n);(h=g[b.nodeName()])&&(!h||!h[d]);){var e=b.parent();this.checkStartOfBlock()&&this.checkEndOfBlock()?(this.setStartBefore(b),this.collapse(n),
b.remove()):c=b;b=e}c&&this.splitElement(c)}this.insertNode(a)}});t.injectDom({_4e_breakParent:function(a,b){var b=j(b),a=j(a),g,h=new o.Range(a[0].ownerDocument);h.setStartAfter(a);h.setEndAfter(b);g=h.extractContents();h.insertNode(a.remove());a.after(g)}});o.Range=v},{requires:["./base","./utils","./walker","./elementPath","./dom"]});
KISSY.add("editor/core/selection",function(f){function o(a){this.document=a;this._={cache:{}};if(n){var b=this.getNative().createRange();if(!b||b.item&&b.item(0).ownerDocument!=a||b.parentElement&&b.parentElement().ownerDocument!=a)this.isInvalid=r}}function t(a){a=new o(a);return!a||a.isInvalid?c:a}var l=f.Editor;l.SELECTION={SELECTION_NONE:1,SELECTION_TEXT:2,SELECTION_ELEMENT:3};var r=!0,c=null,d=f.UA,i=f.DOM,u=f.Node,q=l.SELECTION,v=l.RANGE,n=d.ie,s=l.Walker,w=l.Range,a={img:1,hr:1,li:1,table:1,
tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};f.augment(o,{getNative:!n?function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=i._getWin(this.document).getSelection())}:function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=this.document.selection)},getType:!n?function(){var b=this._.cache;if(b.type)return b.type;var h=q.SELECTION_TEXT,c=this.getNative();if(c){if(1==c.rangeCount){var c=c.getRangeAt(0),d=c.startContainer;
d==c.endContainer&&d.nodeType==i.ELEMENT_NODE&&1==Number(c.endOffset-c.startOffset)&&a[d.childNodes[c.startOffset].nodeName.toLowerCase()]&&(h=q.SELECTION_ELEMENT)}}else h=q.SELECTION_NONE;return b.type=h}:function(){var a=this._.cache;if(a.type)return a.type;var b=q.SELECTION_NONE;try{var c=this.getNative(),d=c.type;"Text"==d&&(b=q.SELECTION_TEXT);"Control"==d&&(b=q.SELECTION_ELEMENT);c.createRange().parentElement&&(b=q.SELECTION_TEXT)}catch(e){}return a.type=b},getRanges:n?function(){var a=function(a,
b){a=a.duplicate();a.collapse(b);for(var g=a.parentElement(),d=g.childNodes,e,f=0;f<d.length;f++){var m=d[f];if(m.nodeType==i.ELEMENT_NODE){e=a.duplicate();e.moveToElementText(m);var m=e.compareEndPoints("StartToStart",a),k=e.compareEndPoints("EndToStart",a);e.collapse();if(0<m)break;else{if(!m||1==k&&-1==m)return{container:g,offset:f};if(!k)return{container:g,offset:f+1}}e=c}}e||(e=a.duplicate(),e.moveToElementText(g),e.collapse(!1));e.setEndPoint("StartToStart",a);e=(""+e.text).replace(/\r\n|\r/g,
"\n").length;try{for(;0<e;)e-=d[--f].nodeValue.length}catch(x){e=0}return 0===e?{container:g,offset:f}:{container:d[f],offset:-e}};return function(b){var c=this._.cache;if(c.ranges&&!b)return c.ranges;var e=this.getNative(),b=e&&e.createRange(),d=this.getType();if(!e)return[];if(d==q.SELECTION_TEXT)return e=new w(this.document),d=a(b,r),e.setStart(new u(d.container),d.offset),d=a(b),e.setEnd(new u(d.container),d.offset),c.ranges=[e];if(d==q.SELECTION_ELEMENT){c=c.ranges=[];for(d=0;d<b.length;d++){for(var f=
b.item(d),i=f.parentNode,m=0,e=new w(this.document);m<i.childNodes.length&&i.childNodes[m]!=f;m++);e.setStart(new u(i),m);e.setEnd(new u(i),m+1);c.push(e)}return c}return c.ranges=[]}}():function(a){var b=this._.cache;if(b.ranges&&!a)return b.ranges;var a=[],c=this.getNative();if(!c)return[];for(var d=0;d<c.rangeCount;d++){var e=c.getRangeAt(d),f=new w(this.document);f.setStart(new u(e.startContainer),e.startOffset);f.setEnd(new u(e.endContainer),e.endOffset);a.push(f)}return b.ranges=a},getStartElement:function(){var a=
this._.cache;if(void 0!==a.startElement)return a.startElement;var b,c=this.getNative();switch(this.getType()){case q.SELECTION_ELEMENT:return this.getSelectedElement();case q.SELECTION_TEXT:var e=this.getRanges()[0];if(e&&!e.collapsed){for(e.optimize();r;)if(b=e.startContainer,e.startOffset==(b[0].nodeType===i.ELEMENT_NODE?b[0].childNodes.length:b[0].nodeValue.length)&&!b._4e_isBlockBoundary())e.setStartAfter(b);else break;b=e.startContainer;if(b[0].nodeType!=i.ELEMENT_NODE)return b.parent();b=new u(b[0].childNodes[e.startOffset]);
if(!b[0]||b[0].nodeType!=i.ELEMENT_NODE)return e.startContainer;for(e=b[0].firstChild;e&&e.nodeType==i.ELEMENT_NODE;)b=new u(e),e=e.firstChild;return b}if(n)e=c.createRange(),e.collapse(r),b=new u(e.parentElement());else{if((b=c.anchorNode)&&b.nodeType!=i.ELEMENT_NODE)b=b.parentNode;b&&(b=new u(b))}}return a.startElement=b},getSelectedElement:function(){var b,e=this._.cache;if(void 0!==e.selectedElement)return e.selectedElement;n&&(b=this.getNative().createRange(),b=b.item&&b.item(0));var c;if(b)c=
new u(b);else{b=this.getRanges()[0];for(var d,f=2;f&&(!(c=b.getEnclosedNode())||!(c[0].nodeType==i.ELEMENT_NODE&&a[c.nodeName()]&&(d=c)));f--)b.shrink(v.SHRINK_ELEMENT);c=d}return e.selectedElement=c},reset:function(){this._.cache={}},selectElement:function(a){var b,c=this.document;if(n)try{b=c.body.createControlRange(),b.addElement(a[0]),b.select()}catch(e){b=c.body.createTextRange(),b.moveToElementText(a[0]),b.select()}finally{}else b=c.createRange(),b.selectNode(a[0]),a=this.getNative(),a.removeAllRanges(),
a.addRange(b);this.reset()},selectRanges:function(a){if(n){if(1<a.length){var b=a[a.length-1];a[0].setEnd(b.endContainer,b.endOffset);a.length=1}a[0]&&a[0].select()}else{b=this.getNative();if(!b)return;b.removeAllRanges();for(var c=0;c<a.length;c++){var e=a[c],f=this.document.createRange(),k=e.startContainer;if(e.collapsed&&(d.gecko&&1.09>d.gecko||d.opera||d.webkit)&&k[0].nodeType==i.ELEMENT_NODE&&!k[0].childNodes.length)k[0].appendChild(this.document.createTextNode(d.webkit?"\u200b":"")),e.startOffset++,
e.endOffset++;f.setStart(k[0],e.startOffset);f.setEnd(e.endContainer[0],e.endOffset);b.addRange(f)}}this.reset()},createBookmarks2:function(a){for(var b=[],e=this.getRanges(),c=0;c<e.length;c++)b.push(e[c].createBookmark2(a));return b},createBookmarks:function(a,b){for(var c=[],e=this.document,d,b=b||this.getRanges(),k=b.length,o=0;o<k;o++){c.push(d=b[o].createBookmark(a,r));var m=(a=d.serializable)?f.one("#"+d.startNode,e):d.startNode;d=a?f.one("#"+d.endNode,e):d.endNode;for(var C=o+1;C<k;C++){var x=
b[C],z=x.startContainer,n=x.endContainer;i.equals(z,m.parent())&&x.startOffset++;i.equals(z,d.parent())&&x.startOffset++;i.equals(n,m.parent())&&x.endOffset++;i.equals(n,d.parent())&&x.endOffset++}}return c},selectBookmarks:function(a){for(var b=[],c=0;c<a.length;c++){var e=new w(this.document);e.moveToBookmark(a[c]);b.push(e)}this.selectRanges(b);return this},getCommonAncestor:function(){var a=this.getRanges();return a[0].startContainer._4e_commonAncestor(a[a.length-1].endContainer)},scrollIntoView:function(){var a=
this.getStartElement();a&&a.scrollIntoView(void 0,!1)},removeAllRanges:function(){var a=this.getNative();n?a&&a.clear():a&&a.removeAllRanges()}});var b={table:1,tbody:1,tr:1},e=s.whitespaces(r),k=/\ufeff|\u00a0/;w.prototype.select=w.prototype.select=!n?function(){var a=this.startContainer;this.collapsed&&a[0].nodeType==i.ELEMENT_NODE&&!a[0].childNodes.length&&a[0].appendChild(this.document.createTextNode(""));var b=this.document.createRange();b.setStart(a[0],this.startOffset);try{b.setEnd(this.endContainer[0],
this.endOffset)}catch(c){if(0<=c.toString().indexOf("NS_ERROR_ILLEGAL_VALUE"))this.collapse(r),b.setEnd(this.endContainer[0],this.endOffset);else throw c;}a=t(this.document).getNative();a.removeAllRanges();a.addRange(b)}:function(a){var c=this.collapsed,d,f;if(this.startContainer[0]===this.endContainer[0]&&1==this.endOffset-this.startOffset){var n=this.startContainer[0].childNodes[this.startOffset];if(n.nodeType==i.ELEMENT_NODE){(new o(this.document)).selectElement(new u(n));return}}(this.startContainer[0].nodeType==
i.ELEMENT_NODE&&this.startContainer.nodeName()in b||this.endContainer[0].nodeType==i.ELEMENT_NODE&&this.endContainer.nodeName()in b)&&this.shrink(v.SHRINK_ELEMENT,r);var l=this.createBookmark(),n=l.startNode,q;c||(q=l.endNode);l=this.document.body.createTextRange();l.moveToElementText(n[0]);l.moveStart("character",1);if(q)a=this.document.body.createTextRange(),a.moveToElementText(q[0]),l.setEndPoint("EndToEnd",a),l.moveEnd("character",-1);else{for(d=n[0].nextSibling;d&&!e(d);)d=d.nextSibling;d=!(d&&
d.nodeValue&&d.nodeValue.match(k))&&(a||!n[0].previousSibling||n[0].previousSibling&&"br"==i.nodeName(n[0].previousSibling));f=new u(this.document.createElement("span"));f.html("&#65279;");f.insertBefore(n);d&&i.insertBefore(this.document.createTextNode("\ufeff"),n[0]||n)}this.setStartBefore(n);n._4e_remove();if(c){if(d?(l.moveStart("character",-1),l.select(),this.document.selection.clear()):l.select(),f)this.moveToPosition(f,v.POSITION_BEFORE_START),f._4e_remove()}else this.setEndBefore(q),q._4e_remove(),
l.select()};o.getSelection=t;return l.Selection=o},{requires:["./base","./walker","./range","./dom"]});
KISSY.add("editor/plugin/selection/index",function(f,o){function t(a){function b(a,b){var c=f.body.createTextRange();try{c.moveToPoint(a,b)}catch(e){c=u}return c}function c(){var a=f.selection.createRange();i&&!a.item&&0===a.compareEndPoints("StartToEnd",a)&&i.select();v.remove(f,"mouseup",c);v.remove(f,"mousemove",d);i=g=0}function d(a){if(a.button){if(a=b(a.pageX,a.pageY))0<a.compareEndPoints("StartToStart",i)?a.setEndPoint("StartToStart",i):a.setEndPoint("EndToEnd",i),a.select()}else c()}var g,
h=a.get("window")[0],f=a.get("document")[0],i;v.on(f,"mousedown contextmenu",function(a){var o=f.documentElement;if(a.target===o&&(g&&c(),!(o.scrollHeight>o.clientHeight)&&(g=1,i=b(a.pageX,a.pageY))))v.on(f,"mouseup",c),v.on(f,"mousemove",d),h.focus(),i.select()})}function l(a){function b(g){if(j){var f=a.getSelection(),i=f&&f.getType(),m=f&&c.selection;if(g&&m&&i==w.SELECTION_NONE&&!c.queryCommandEnabled("InsertImage"))setTimeout(function(){b(d)},50);else{var k;if(!m||!m.type||!("Control"!=m.type&&
(k=m.createRange())&&(k=k.parentElement())&&(k=k.nodeName)&&k.toLowerCase()in{input:1,textarea:1}))h=m&&f.getRanges()[0],a.checkSelectionChange()}}}var c=a.get("document")[0],f=new s(c.body),g=new s(c.documentElement);if(8>o.Utils.ieEngine)g.on("click",function(b){"html"===(new s(b.target)).nodeName()&&a.getSelection().getNative().createRange().select()});var h,j,p=d;g.on("mousedown",function(){p=i});g.on("mouseup",function(){p=d});f.on("focusin",function(a){if("body"==(new s(a.target)).nodeName()&&
h){try{p&&h.select()}catch(b){}h=u}});f.on("focus",function(){j=d;b()});f.on("beforedeactivate",function(a){a.relatedTarget||(j=i,p=d)});f.on("mousedown",function(){j=i});f.on("mouseup",function(){j=d;setTimeout(function(){b(d)},0)});f.on("keydown",function(){j=i});f.on("keyup",function(){j=d;setTimeout(function(){b()},0)})}function r(a){var b=a.get("document")[0];v.on(b,"mouseup keyup",function(){a.checkSelectionChange()})}function c(a){function b(a){var b=o.XHTML_DTD;return a._4e_isBlockBoundary()&&
b.$empty[a.nodeName()]}function c(a){return h(a)&&j(a)}var f=a.get("document")[0],g=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;|(<\!--[\s\S]*?--\>))?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,h=o.Walker.whitespaces(d),j=o.Walker.bookmark(i,d),p=function(a){return h(a)&&8!=a.nodeType};a.on("selectionChange",function(h){var j=h.path,l=new s(a.get("document")[0].body),h=(h=h.selection)&&h.getRanges()[0],m=j.blockLimit;if(q.gecko){var C=j.block||j.blockLimit,x=C&&C.last(c);C&&C._4e_isBlockBoundary()&&
(!x||!(1==x[0].nodeType&&x._4e_isBlockBoundary()))&&"pre"!=C.nodeName()&&!C._4e_getBogus()&&C._4e_appendBogus()}if(h&&h.collapsed&&!j.block){if("body"==m.nodeName()){if((j=h.fixBlock(d,"p"))&&j[0]!=l[0].lastChild&&j._4e_outerHtml().match(g))if((m=j.next(p,1))&&m[0].nodeType==n.ELEMENT_NODE&&!b[m])h.moveToElementEditablePosition(m),j._4e_remove();else if((m=j.prev(p,1))&&m[0].nodeType==n.ELEMENT_NODE&&!b[m])h.moveToElementEditablePosition(m,m._4e_outerHtml().match(g)?i:d),j._4e_remove();h.select();
a.notifySelectionChange()}j=new o.Range(f);j.moveToElementEditablePosition(l,d);"body"!==(new o.ElementPath(j.startContainer)).blockLimit.nodeName()&&(l=(new s(f.createElement("p"))).appendTo(l),q.ie||l._4e_appendBogus())}})}var d=!0,i=!1,u=null,q=f.UA,v=f.Event,n=f.DOM,s=f.Node,w=o.SELECTION;return{init:function(a){a.docReady(function(){q.ie?(t(a),l(a)):r(a)});c(a)}}},{requires:["editor"]});
KISSY.add("editor/core/styles",function(f){function o(a){return!B.attr(a,"_ke_bookmark")}function t(a,b){for(var c in a)a.hasOwnProperty(c)&&(f.isString(a[c])?a[c]=a[c].replace(P,function(a,c){return b[c]}):t(a[c],b))}function l(a,b){b&&(a=f.clone(a),t(a,b));var c=this.element=this.element=(a.element||"*").toLowerCase();this.type=this.type="#"==c||O[c]?m.STYLE_BLOCK:M[c]?m.STYLE_OBJECT:m.STYLE_INLINE;this._={definition:a}}function r(a,b){var c=b?this.removeFromRange:this.applyToRange;a.body.focus();
for(var e=new x(a),d=e.getRanges(),g=0;g<d.length;g++)c.call(this,d[g]);e.selectRanges(d)}function c(a,b,c){var e=a.element;"*"==e&&(e="span");b=new G(b.createElement(e));c&&c._4e_copyAttributes(b);c=a._.definition;a=c.attributes;c=l.getStyleText(c);if(a)for(var d in a)a.hasOwnProperty(d)&&b.attr(d,a[d]);c&&(b[0].style.cssText=c);return b}function d(a){var b=a.createBookmark(p),e=a.createIterator();e.enforceRealBlocks=p;e.enlargeBr=p;for(var d,g=a.document;d=e.getNextParagraph();){var h=c(this,g,
d),f=h,h="pre"==f.nodeName,m="pre"==d.nodeName,j=!h&&m;h&&!m?(m=d,j=m.html(),j=i(j,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,""),j=j.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1"),j=j.replace(/([ \t\n\r]+|&nbsp;)/g," "),j=j.replace(/<br\b[^>]*>/gi,"\n"),K.ie?(m=m[0].ownerDocument.createElement("div"),m.appendChild(f[0]),f[0].outerHTML="<pre>"+j+"</pre>",f=new G(m.firstChild),f._4e_remove()):f.html(j)):j?f=q(u(d),f):d._4e_moveChildren(f);d[0].parentNode.replaceChild(f[0],d[0]);if(h&&(d=f,h=void 0,(h=d._4e_previousSourceNode(p,
B.ELEMENT_NODE))&&"pre"==h.nodeName()))f=i(h.html(),/\n$/,"")+"\n\n"+i(d.html(),/^\n/,""),K.ie?d[0].outerHTML="<pre>"+f+"</pre>":d.html(f),h._4e_remove()}a.moveToBookmark(b)}function i(a,b,c){var d="",e="",a=a.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(a,b,c){b&&(d=b);c&&(e=c);return""});return d+a.replace(b,c)+e}function u(a){var b=[];i(a._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,function(a,b,c){return b+"</pre>"+
c+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(a,c){b.push(c)});return b}function q(a,b){for(var c=b[0].ownerDocument.createDocumentFragment(),d=0;d<a.length;d++){var e=a[d],e=e.replace(/(\r\n|\r)/g,"\n"),e=i(e,/^[ \t]*\n/,""),e=i(e,/\n$/,""),e=i(e,/^[ \t]+|[ \t]+$/g,function(a,b){return 1==a.length?"&nbsp;":b?" "+Array(a.length).join("&nbsp;"):Array(a.length).join("&nbsp;")+" "}),e=e.replace(/\n/g,"<br>"),e=e.replace(/[ \t]{2,}/g,function(a){return Array(a.length).join("&nbsp;")+" "}),
g=b.clone();g.html(e);c.appendChild(g[0])}return c}function v(a){var b=a.document;if(a.collapsed)b=c(this,b,void 0),a.insertNode(b),a.moveToPosition(b,C.POSITION_BEFORE_END);else{var e=this.element,d=this._.definition,g,h=I[e];h||(g=p,h=I.span);var f=a.createBookmark();a.enlarge(C.ENLARGE_ELEMENT);a.trim();for(var m=a.createBookmark(),j=m.startNode,m=m.endNode,i=j,x;i&&i[0];){var n=A;if(B.equals(i,m))i=y,n=p;else{var l=i[0].nodeType,u=l==B.ELEMENT_NODE?i.nodeName():y;if(u&&i.attr("_ke_bookmark")){i=
i._4e_nextSourceNode(p);continue}if(!u||h[u]&&(i._4e_position(m)|z.POSITION_PRECEDING|z.POSITION_IDENTICAL|z.POSITION_IS_CONTAINED)==z.POSITION_PRECEDING+z.POSITION_IDENTICAL+z.POSITION_IS_CONTAINED&&(!d.childRule||d.childRule(i))){var q=i.parent();if(q&&"a"==e&&q.nodeName()==e)l=c(this,b,void 0),q._4e_moveChildren(l),q[0].parentNode.replaceChild(l[0],q[0]),l._4e_mergeSiblings();else if(q&&q[0]&&((I[q.nodeName()]||I.span)[e]||g)&&(!d.parentRule||d.parentRule(q))){if(!x&&(!u||!I.$removeEmpty[u]||(i._4e_position(m)|
z.POSITION_PRECEDING|z.POSITION_IDENTICAL|z.POSITION_IS_CONTAINED)==z.POSITION_PRECEDING+z.POSITION_IDENTICAL+z.POSITION_IS_CONTAINED))x=new F(b),x.setStartBefore(i);if(l==B.TEXT_NODE||l==B.ELEMENT_NODE&&!i[0].childNodes.length){q=i;for(l=null;(n=!q.next(o,1))&&(l=q.parent())&&h[l.nodeName()]&&(l._4e_position(j)|z.POSITION_FOLLOWING|z.POSITION_IDENTICAL|z.POSITION_IS_CONTAINED)==z.POSITION_FOLLOWING+z.POSITION_IDENTICAL+z.POSITION_IS_CONTAINED&&(!d.childRule||d.childRule(l));)q=l;x.setEndAfter(q)}}else n=
p}else n=p;i=i._4e_nextSourceNode()}if(n&&x&&!x.collapsed){for(var n=c(this,b,void 0),q=x.getCommonAncestor(),l={},u={},r,s=null,t;n&&q&&n[0]&&q[0];){if(q.nodeName()==e){for(r in d.attributes)if(d.attributes.hasOwnProperty(r)&&!u[r]&&(t=q.attr(s)))n.attr(r)==t?n.removeAttr(r):u[r]=1;for(s in d.styles)if(d.styles.hasOwnProperty(s)&&!l[s]&&(t=q.style(s)))n.style(s)==t?n.style(s,""):l[s]=1;if(!n._4e_hasAttributes()){n=y;break}}q=q.parent()}n?(n[0].appendChild(x.extractContents()),k(this,n),x.insertNode(n),
n._4e_mergeSiblings(),K.ie||n[0].normalize()):(n=new G(b.createElement("span")),n[0].appendChild(x.extractContents()),x.insertNode(n),k(this,n),n._4e_remove(!0));x=y}}j._4e_remove();m._4e_remove();a.moveToBookmark(f);a.shrink(C.SHRINK_TEXT)}}function n(c){c.enlarge(C.ENLARGE_ELEMENT);var d=c.createBookmark(),e=d.startNode;if(c.collapsed){for(var h=new L(e.parent()),f,m=0,i;m<h.elements.length&&(i=h.elements[m])&&!(i==h.block||i==h.blockLimit);m++)if(this.checkElementRemovable(i)){var j=c.checkBoundaryOfElement(i,
C.END),k=!j&&c.checkBoundaryOfElement(i,C.START);k||j?(f=i,f.match=k?"start":"end"):(i._4e_mergeSiblings(),i.nodeName()!=this.element?(j=a(this),g(i,j[i.nodeName()]||j["*"])):b(this,i))}if(f){i=e;for(m=0;;m++){j=h.elements[m];if(B.equals(j,f))break;else if(j.match)continue;else j=j.clone();j[0].appendChild(i[0]);i=j}i["start"==f.match?"insertBefore":"insertAfter"](f)}}else{var x=d.endNode,n=this,h=function(){for(var a=new L(e.parent()),b=new L(x.parent()),c=y,d=y,g=0;g<a.elements.length;g++){var h=
a.elements[g];if(h==a.block||h==a.blockLimit)break;n.checkElementRemovable(h)&&(c=h)}for(g=0;g<b.elements.length;g++){h=b.elements[g];if(h==b.block||h==b.blockLimit)break;n.checkElementRemovable(h)&&(d=h)}d&&x._4e_breakParent(d);c&&e._4e_breakParent(c)};h();for(f=new G(e[0].nextSibling);f[0]!==x[0];){m=f._4e_nextSourceNode();if(f[0]&&f[0].nodeType==B.ELEMENT_NODE&&this.checkElementRemovable(f)&&(f.nodeName()==this.element?b(this,f):(i=a(this),g(f,i[f.nodeName()]||i["*"])),m[0].nodeType==B.ELEMENT_NODE&&
m.contains(e)))h(),m=new G(e[0].nextSibling);f=m}}c.moveToBookmark(d)}function s(a){var b={};(""+a).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(a,c,d){b[c]=d});return b}function w(a,b){var c="";b!==A?(c=document.createElement("span"),c.style.cssText=a,c=c.style.cssText||""):c=a;return c.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function a(a){if(a._.overrides)return a._.overrides;var b=a._.overrides={},c=a._.definition.overrides;
if(c){f.isArray(c)||(c=[c]);for(var d=0;d<c.length;d++){var e=c[d],g,h,m;"string"==typeof e?g=e.toLowerCase():(g=e.element?e.element.toLowerCase():a.element,h=e.attributes,m=e.styles);e=b[g]||(b[g]={});if(h){g=e.attributes=e.attributes||[];for(var i in h)h.hasOwnProperty(i)&&g.push([i.toLowerCase(),h[i]])}if(m){var e=e.styles=e.styles||[],j;for(j in m)m.hasOwnProperty(j)&&e.push([j.toLowerCase(),m[j]])}}}return b}function b(b,c){var d=b._.definition,g=a(b),m=f.merge(d.attributes,(g[c.nodeName()]||
g["*"]||{}).attributes),d=f.merge(d.styles,(g[c.nodeName()]||g["*"]||{}).styles),g=f.isEmptyObject(m)&&f.isEmptyObject(d),i;for(i in m)if(m.hasOwnProperty(i)&&!(("class"==i||b._.definition.fullMatch)&&c.attr(i)!=e(i,m[i])))g=g||!!c.hasAttr(i),c.removeAttr(i);for(var j in d)d.hasOwnProperty(j)&&!(b._.definition.fullMatch&&c.style(j)!=e(j,d[j],p))&&(g=g||!!c.style(j),c.style(j,""));h(c)}function e(a,b,c){var d=new G("<span>");d[c?"style":"attr"](a,b);return d[c?"style":"attr"](a)}function k(c,d){for(var e=
a(c),h=d.all(c.element),f=h.length;0<=--f;)b(c,new G(h[f]));for(var m in e)if(e.hasOwnProperty(m)&&m!=c.element){h=d.all(m);for(f=h.length-1;0<=f;f--){var i=new G(h[f]);g(i,e[m])}}}function g(a,b){var c,d=b&&b.attributes;if(d)for(c=0;c<d.length;c++){var e=d[c][0],g;if(g=a.attr(e)){var f=d[c][1];(f===y||f.test&&f.test(g)||"string"==typeof f&&g==f)&&a[0].removeAttribute(e)}}if(d=b&&b.styles)for(c=0;c<d.length;c++)if(e=d[c][0],f=a.css(e)){var m=d[c][1];(m===y||m.test&&m.test(g)||"string"==typeof m&&
f==m)&&a.css(e,"")}h(a)}function h(a){if(!a._4e_hasAttributes()){var b=a[0].firstChild,c=a[0].lastChild;a._4e_remove(p);b&&(b.nodeType==B.ELEMENT_NODE&&B._4e_mergeSiblings(b),c&&b!=c&&c.nodeType==B.ELEMENT_NODE&&B._4e_mergeSiblings(c))}}var j=f.Editor,p=!0,A=!1,y=null,B=f.DOM,m={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3},C=j.RANGE,x=j.Selection,z=j.POSITION,F=j.Range,G=f.Node,K=f.UA,L=j.ElementPath,O={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},I=j.XHTML_DTD,M={embed:1,hr:1,img:1,li:1,
object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},N=/\s*(?:;\s*|$)/g,P=/#\((.+?)\)/g;j.STYLE=m;l.prototype={apply:function(a){r.call(this,a,A)},remove:function(a){r.call(this,a,p)},applyToRange:function(a){return(this.applyToRange=this.type==m.STYLE_INLINE?v:this.type==m.STYLE_BLOCK?d:y).call(this,a)},removeFromRange:function(a){return(this.removeFromRange=this.type==m.STYLE_INLINE?n:y).call(this,a)},checkElementRemovable:function(b,c){if(!b)return A;var d=this._.definition,e;if(b.nodeName()==
this.element){if(!c&&!b._4e_hasAttributes())return p;var g=d._AC;if(g)d=g;else{var g={},h=0,f=d.attributes;if(f)for(var m in f)f.hasOwnProperty(m)&&(h++,g[m]=f[m]);if(f=l.getStyleText(d))g.style||h++,g.style=f;g._length=h;d=d._AC=g}if(d._length){for(var i in d)if("_length"!=i&&d.hasOwnProperty(i)){h=b.attr(i)||"";if("style"==i)a:{g=d[i];h=w(h,A);"string"==typeof g&&(g=s(g));"string"==typeof h&&(h=s(h));f=void 0;for(f in g)if(g.hasOwnProperty(f)&&!(f in h&&(h[f]==g[f]||"inherit"==g[f]||"inherit"==
h[f]))){g=A;break a}g=p}else g=d[i]==h;if(g){if(!c)return p}else if(c)return A}if(c)return p}else return p}i=a(this);if(i=i[b.nodeName()]||i["*"]){if(!(d=i.attributes)&&!(e=i.styles))return p;if(d)for(g=0;g<d.length;g++)if(i=d[g][0],i=b.attr(i))if(h=d[g][1],h===y||"string"==typeof h&&i==h||h.test&&h.test(i))return p;if(e)for(g=0;g<e.length;g++)if(i=b.css(e[g][0]))if(d=e[g][1],d===y||"string"==typeof d&&i==d||d.test&&d.test(i))return p}return A},checkActive:function(a){switch(this.type){case m.STYLE_BLOCK:return this.checkElementRemovable(a.block||
a.blockLimit,p);case m.STYLE_OBJECT:case m.STYLE_INLINE:for(var b=a.elements,c=0,d;c<b.length;c++)if(d=b[c],!(this.type==m.STYLE_INLINE&&(B.equals(d,a.block)||B.equals(d,a.blockLimit))))if((this.type!=m.STYLE_OBJECT||d.nodeName()in M)&&this.checkElementRemovable(d,p))return p}return A}};l.getStyleText=function(a){var b=a._ST;if(b)return b;var b=a.styles,c=a.attributes&&a.attributes.style||"",d="";c.length&&(c=c.replace(N,";"));for(var e in b)if(b.hasOwnProperty(e)){var g=b[e],h=(e+":"+g).replace(N,
";");"inherit"==g?d+=h:c+=h}c.length&&(c=w(c));return a._ST=c+d};j.Style=l},{requires:["./range","./selection","./domIterator","./elementPath"]});
KISSY.add("editor/core/utils",function(f){var o=f.Node,t=f.DOM,l=f.UA,r={debugUrl:function(c){var d=f.Config;d.debug||(c=c.replace(/\.(js|css)/i,"-min.$1"));-1==c.indexOf("?t")&&(c=-1!=c.indexOf("?")?c+"&":c+"?",c+="t="+encodeURIComponent(d.tag));return d.base+"editor/"+c},lazyRun:function(c,d,f){var l=c[d],o=c[f];c[d]=function(){l.apply(this,arguments);c[d]=c[f];return o.apply(this,arguments)}},getXY:function(c,d,f,l){f=f.defaultView||f.parentWindow;c-=t.scrollLeft(f);d-=t.scrollTop(f);l&&(l=l.defaultView||
l.parentWindow,f!=l&&f.frameElement&&(l=t.offset(f.frameElement,void 0,l),c+=l.left,d+=l.top));return{left:c,top:d}},tryThese:function(c){for(var d,f=0,l=arguments.length;f<l;f++){var o=arguments[f];try{d=o();break}catch(r){}}return d},arrayCompare:function(c,d){if(!c&&!d)return!0;if(!c||!d||c.length!=d.length)return!1;for(var f=0;f<c.length;f++)if(c[f]!==d[f])return!1;return!0},clearAllMarkers:function(c){for(var d in c)c.hasOwnProperty(d)&&c[d]._4e_clearMarkers(c,!0,void 0)},ltrim:function(c){return c.replace(/^\s+/,
"")},rtrim:function(c){return c.replace(/\s+$/,"")},isNumber:function(c){return/^\d+(.\d+)?$/.test(f.trim(c))},verifyInputs:function(c){for(var d=0;d<c.length;d++){var i=new o(c[d]),l=f.trim(r.valInput(i)),q=i.attr("data-verify"),i=i.attr("data-warning");if(q&&!RegExp(q).test(l))return alert(i),!1}return!0},sourceDisable:function(c,d){c.on("sourceMode",d.disable,d);c.on("wysiwygMode",d.enable,d)},resetInput:function(c){var d=c.attr("placeholder");d&&l.ie?(c.addClass("ks-editor-input-tip"),c.val(d)):
l.ie||c.val("")},valInput:function(c,d){if(void 0===d)return c.hasClass("ks-editor-input-tip")?"":c.val();c.removeClass("ks-editor-input-tip");c.val(d)},placeholder:function(c,d){c.attr("placeholder",d);l.ie&&(c.on("blur",function(){f.trim(c.val())||(c.addClass("ks-editor-input-tip"),c.val(d))}),c.on("focus",function(){c.removeClass("ks-editor-input-tip");f.trim(c.val())==d&&c.val("")}))},htmlEncode:function(c){return!c?c:(""+c).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,
"&quot;")},normParams:function(c){var c=f.clone(c),d;for(d in c)if(c.hasOwnProperty(d)){var i=c[d];f.isFunction(i)&&(c[d]=i())}return c},map:function(c,d){for(var f=0;f<c.length;f++)c[f]=d(c[f]);return c},ieEngine:document.documentMode||l.ie,preventFocus:function(c){l.ie?c.unselectable(void 0):c.attr("onmousedown","return false;")},injectDom:function(c){f.mix(t,c);for(var d in c)c.hasOwnProperty(d)&&function(d){o.prototype[d]=function(){var l=[].slice.call(arguments,0);l.unshift(this[0]);return(l=
c[d].apply(null,l))&&(l.nodeType||f.isWindow(l))?new o(l):f.isArray(l)&&(l.__IS_NODELIST||l[0]&&l[0].nodeType)?new o(l):l}}(d)},addRes:function(){var c=this.__res=this.__res||[];c.push.apply(c,f.makeArray(arguments))},destroyRes:function(){for(var c=this.__res||[],d=0;d<c.length;d++){var i=c[d];f.isFunction(i)?i():(i.destroy&&i.destroy(),i.remove&&i.remove())}this.__res=[]},getQueryCmd:function(c){return"query"+("-"+c).replace(/-(\w)/g,function(c,f){return f.toUpperCase()})+"Active"}};return f.Editor.Utils=
r},{requires:["./base"]});
KISSY.add("editor/core/walker",function(f,o){function t(a,b){if(this._.end)return i;var g,f=this.range,j,l=this.guard,o=this.type,r=a?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start&&(this._.start=1,f.trim(),f.collapsed))return this.end(),i;if(!a&&!this._.guardLTR){var s=f.endContainer[0],m=s.childNodes[f.endOffset];this._.guardLTR=function(a,b){return b&&(s==a||"body"==q.nodeName(a))?!1:a!=m}}if(a&&!this._.guardRTL){var C=f.startContainer[0],x=0<f.startOffset&&C.childNodes[f.startOffset-
1]||null;this._.guardRTL=function(a,b){return b&&(C==a||"body"==q.nodeName(a))?!1:a!=x}}var z=a?this._.guardRTL:this._.guardLTR;j=l?function(a,b){return z(a,b)===d?d:l(a,b)}:z;this.current?g=this.current[r](d,o,j):a?(g=f.endContainer,0<f.endOffset?(g=new n(g[0].childNodes[f.endOffset-1]),j(g[0])===d&&(g=i)):g=j(g,c)===d?i:g._4e_previousSourceNode(c,o,j,void 0)):(g=f.startContainer,g=new n(g[0].childNodes[f.startOffset]),g.length?j(g[0])===d&&(g=i):g=j(f.startContainer,c)===d?i:f.startContainer._4e_nextSourceNode(c,
o,j,void 0));for(;g&&!this._.end;){this.current=g;if(!this.evaluator||this.evaluator(g[0])!==d){if(!b)return g}else if(b&&this.evaluator)return d;g=g[r](d,o,j)}this.end();return this.current=i}function l(a){for(var b,c=i;b=t.call(this,a);)c=b;return c}function r(a){this.range=a;this.guard=this.evaluator=i;this._={}}var c=!0,d=!1,i=null,u=f.UA,q=f.DOM,v=o.XHTML_DTD,n=f.Node;f.augment(r,{end:function(){this._.end=1},next:function(){return t.call(this)},previous:function(){return t.call(this,c)},checkForward:function(){return t.call(this,
d,c)!==d},checkBackward:function(){return t.call(this,c,c)!==d},lastForward:function(){return l.call(this)},lastBackward:function(){return l.call(this,c)},reset:function(){delete this.current;this._={}},_iterator:t});f.mix(r,{blockBoundary:function(a){return function(b){return!(b.nodeType==q.ELEMENT_NODE&&q._4e_isBlockBoundary(b,a))}},bookmark:function(a,b){function c(a){return"span"==q.nodeName(a)&&q.attr(a,"_ke_bookmark")}return function(d){var f,i;f=d.nodeType==q.TEXT_NODE&&(i=d.parentNode)&&c(i);
f=a?f:f||c(d);return!!(b^f)}},whitespaces:function(a){return function(b){b=b.nodeType==q.TEXT_NODE&&!f.trim(b.nodeValue);return!!(a^b)}},invisible:function(a){var b=r.whitespaces();return function(c){c=b(c)||c.nodeType==q.ELEMENT_NODE&&!c.offsetHeight;return!!(a^c)}}});var s=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,w=r.whitespaces(),a=r.bookmark(),b=function(b){var c=q.nodeName(b);return a(b)||w(b)||1==b.nodeType&&c in v.$inline&&!(c in v.$empty)};o.Utils.injectDom({_4e_getBogus:function(a){a=new n(a);do a=
a._4e_previousSourceNode();while(a&&b(a[0]));return a&&(!u.ie?"br"==a.nodeName():3==a[0].nodeType&&s.test(a.text()))?a[0]:!1}});return o.Walker=r},{requires:["./base","./utils","./dom"]});KISSY.add("editor/core/zIndexManager",function(f){var o=f.Editor;o.zIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,STORE_FLASH_SHOW:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};o.baseZIndex=function(f){return(o.Config.baseZIndex||1E4)+f}},{requires:["./base"]});
KISSY.add("editor",function(f,o,t,l){function r(a,b){var c=a.body;j(function(){a.designMode="on";setTimeout(function(){a.designMode="off";c.focus();arguments.callee.retry||(arguments.callee.retry=v)},50)},function(){a.designMode="off";k.attr(c,"contentEditable",w);k.attr(c,"contentEditable",v);!b&&r(a,1)})}function c(a){a.get("iframe");var c=a.get("textarea")[0],d=a.get("window")[0],i=a.get("document")[0];b.webkit&&(h.on(i,"click",function(a){var b=new g(a.target);f.inArray(b.nodeName(),["input",
"select"])&&a.preventDefault()}),h.on(i,"mouseup",function(a){var b=new g(a.target);f.inArray(b.nodeName(),["input","textarea"])&&a.preventDefault()}));if(b.gecko||e||b.opera){var j;j=(new g('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>')).insertAfter(c);j.on("focus",function(){a.focus()});a.activateGecko=function(){b.gecko&&a.__iframeFocus&&j[0].focus()};a.on("destroy",function(){j.detach();j.remove()})}h.on(d,"focus",function(){b.gecko?r(i,w):b.opera&&i.body.focus();
a.notifySelectionChange()});if(b.gecko)h.on(i,"mousedown",function(){a.__iframeFocus||r(i,w)});if(e&&(h.on(i,"keydown",function(b){if(b.keyCode in{8:1,46:1}){var c=a.getSelection(),d=c.getSelectedElement();if(d){a.fire("save");var e=c.getRanges()[0].createBookmark();d.remove();c.selectBookmarks([e]);a.fire("save");b.preventDefault()}}}),"CSS1Compat"==i.compatMode)){var k={33:1,34:1};h.on(i,"keydown",function(b){b.keyCode in k&&setTimeout(function(){a.getSelection().scrollIntoView()},0)})}if(b.webkit)h.on(i,
"mousedown",function(b){b=new g(b.target);f.inArray(b.nodeName(),["img","hr","input","textarea","select"])&&a.getSelection().selectElement(b)});if(b.gecko)h.on(i,"dragstart",function(a){var b=new g(a.target);b.nodeName()==="img"&&/ke_/.test(b[0].className)&&a.preventDefault()});l.add(a)}function d(b,c,d,e){var g="",h,i=t.debugUrl("theme/editor-iframe.css");for(h=0;h<d.length;h++)g+=f.substitute('<link href="{href}" rel="stylesheet" />',{href:d[h]});return f.substitute(p,{doctype:8===a.documentMode?
'<meta http-equiv="X-UA-Compatible" content="IE=7" />':"",title:"${title}",href:i,style:c,data:e||"&nbsp;",script:b?'<script id="ke_active_script">'+(k.isCustomDomain()?'document.domain="'+a.domain+'";':"")+'parent.KISSY.Editor._initIFrame("'+b+'");<\/script>':""})}function i(a,b){a.__saveTimer&&(clearTimeout(a.__saveTimer),a.__saveTimer=null);a.__saveTimer=setTimeout(function(){a.execCommand("save")},b||0)}function u(a,b){function c(){k=j.document;a.__set("document",new g(k));a.__set("window",new g(j));
f.detach();k.open("text/html","replace");k.write(h);k.close()}var f=a.get("iframe"),h=d(a._UUID,a.get("customStyle"),a.get("customLink"),b),i=f[0],j=i.contentWindow,k;f.__loaded=1;try{k=j.document}catch(l){if(i.src=i.src,7>e){setTimeout(c,10);return}}c()}function q(a,c){var d=new g(y),e=a.get("textarea");e.hasAttr("tabindex")&&d.attr("tabIndex",b.webkit?-1:e.attr("tabIndex"));a.get("iframeWrapEl").prepend(d);a.set("iframe",d);a.__docReady=0;if(b.gecko&&!d.__loaded)d.on("load",function(){u(a,c)},a);
else u(a,c)}var v=!0,n=n,s=f.all,w=!1,a=document,b=f.UA,e=b.ie,k=f.DOM,g=f.Node,h=f.Event,j=t.tryThese,p="<!doctype html><html><head>{doctype}<title>{title}</title><link href='{href}' rel='stylesheet' /><style>{style}</style>{links}</head><body class='ks-editor'>{data}{script}</body></html>",A=k.getEmptyIframeSrc(),y='<iframe style="width:100%;height:100%;border:none;"  frameborder="0"  title="kissy-editor"  allowTransparency="true" '+(A?' src="'+A+'"':"")+"</iframe>";f.mix(o,{SOURCE_MODE:0,WYSIWYG_MODE:1});
var B=o.WYSIWYG_MODE;f.augment(o,{createDom:function(){var a,b=this.get("textarea"),c;b||this.set("textarea",b=s("<textarea class='ks-editor-textarea'></textarea>"));c=this.get("el");c.html('<div class="ks-editor-tools"></div><div class="ks-editor-textarea-wrap"></div><div class=\'ks-editor-status\'></div>');this._UUID=f.guid();this.set({iframeWrapEl:a=c.one(".ks-editor-textarea-wrap"),toolBarEl:c.one(".ks-editor-tools"),statusBarEl:c.one(".ks-editor-status")},{silent:1});b.css("width","100%");b.css("display",
"none");a.append(b);l.register(this)},_uiSetHeight:function(a){var b=this.get("toolBarEl"),c=this.get("statusBarEl"),a=parseInt(a,10),a=a-((b&&b.outerHeight()||0)+(c&&c.outerHeight()||0));this.get("iframeWrapEl").css("height",a);this.get("textarea").css("height",a)},adjustHeight:function(){var a;(a=this.get("height"))&&this._uiSetHeight(a)},_uiSetMode:function(a){var b=this,c,d=b.get("iframe"),e=b.get("textarea");a==B?(b.execCommand("save"),b.on("docReady",c=function(){b.execCommand("save");b.detach("docReady",
c)}),b._setData(e.val()),b.fire("wysiwygMode")):(e.val(b._getData(1,B)),e[0].focus(),e.show(),d.hide(),b.fire("sourceMode"))},_uiSetFocused:function(a){a&&this.__docReady&&this.focus()},bindUI:function(){function a(){b.detach("docReady",a);if(b.get("focused"))b.focus();else{var c=b.getSelection();c&&c.removeAllRanges()}}var b=this,c,d=b.get("prefixCls"),e=b.get("textarea");if(b.get("attachForm")&&(c=e[0].form))k.on(c,"submit",b.sync,b),b.on("destroy",function(){k.detach(c,"submit",b.sync,b)});b.on("docReady",
a);b.on("blur",function(){b.get("el").removeClass(d+"editor-focused")});b.on("focus",function(){b.get("el").addClass(d+"editor-focused")})},destructor:function(){var a=this.get("document")[0],b=this.get("window");this.sync();l.remove(this);h.remove([a,a.documentElement,a.body,b[0]]);f.each(this.__dialogs,function(a){a.destroy&&a.destroy()});f.each(this.__controls,function(a){a.destroy&&a.destroy()});this.__dialogs={};this.__commands={};this.__controls={}},getControl:function(a){return this.__controls[a]},
addControl:function(a,b){this.__controls[a]=b},addDialog:function(a,b){this.__dialogs[a]=b},showDialog:function(a,b){var c=this.__dialogs[a];c.show(b);this.fire("dialogShow",{dialog:c.dialog,pluginDialog:c,dialogName:a})},hasDialog:function(a){return!!this.__dialogs[a]},addCommand:function(a,b){this.__commands[a]=b},hasCommand:function(a){return this.__commands[a]},execCommand:function(a){var b=this.__commands[a],c=f.makeArray(arguments);c.shift();c.unshift(this);if(b)return b.exec.apply(b,c)},_getData:function(a,
b){var c=this.htmlDataProcessor,d;b==n&&(b=this.get("mode"));d=b==B?this.get("document")[0].body.innerHTML:c.toDataFormat(this.get("textarea").val());d=a?c.toHtml(d):c.toServer(d);d=f.trim(d);/^(?:<(p)>)?(?:(?:&nbsp;)|\s)*(?:<\/\1>)?$/.test(d)&&(d="");return d},_setData:function(a){var b,c=a;if(this.get("mode")!=B)this.get("textarea").val(a);else{if(b=this.htmlDataProcessor)c=b.toDataFormat(a,"p");if(this.get("iframe")){a=this.get("iframe");b=this.get("window")[0];var d=this.get("document")[0];h.remove([d,
d.documentElement,d.body,b]);a.remove()}q(this,c)}},sync:function(){this.get("textarea").val(this.get("data"))},getDocHtml:function(){return d(0,this.get("customStyle"),this.get("customLink"),this.get("formatData"))},getSelection:function(){return o.Selection.getSelection(this.get("document")[0])},focus:function(){var a=this.get("document")[0],c=k._getWin(a);b.ie||c&&c.parent&&c.parent.focus();c&&c.focus();a.body.focus();this.notifySelectionChange()},blur:function(){k._getWin(this.get("document")[0]).blur();
this.get("document")[0].body.blur()},addCustomStyle:function(a,b){var c=this.get("customStyle")||"",c=c+("\n"+a);this.set("customStyle",c);k.addStyleSheet(this.get("window"),c,b)},removeCustomStyle:function(a){k.remove(k.get("#"+a,this.get("window")[0]))},addCustomLink:function(a){var b=this.get("customLink")||[],c=this.get("document")[0];b.push(a);this.set("customLink",b);b=c.createElement("link");b.rel="stylesheet";c.getElementsByTagName("head")[0].appendChild(b);b.href=a},removeCustomLink:function(a){for(var b=
this.get("document")[0],b=k.query("link",b),c=0;c<b.length;c++)k.attr(b[c],"href")==a&&k.remove(b[c]);b=this.get("customLink")||[];a=f.indexOf(a,b);-1!=a&&b.splice(a,1)},docReady:function(a){this.on("docReady",a);this.__docReady&&a.call(this)},checkSelectionChange:function(){var a=this;a.__checkSelectionChangeId&&clearTimeout(a.__checkSelectionChangeId);a.__checkSelectionChangeId=setTimeout(function(){var b=a.getSelection();if(b&&!b.isInvalid){var c=b.getStartElement(),d=new o.ElementPath(c);if(!a.__previousPath||
!a.__previousPath.compare(d))a.__previousPath=d,a.fire("selectionChange",{selection:b,path:d,element:c})}},100)},notifySelectionChange:function(){this.__previousPath=null;this.checkSelectionChange()},insertElement:function(a){if(this.get("mode")===B){this.focus();var b,c=a.nodeName(),d=o.XHTML_DTD,e=d.$block[c],g=o.RANGE,f=(c=this.getSelection())&&c.getRanges(),h,j,l;if(f&&0!=f.length){this.execCommand("save");for(j=f.length-1;0<=j;j--)h=f[j],b=!j&&a||a.clone(v),h.insertNodeByDtd(b),l||(l=b);if(l)return h.moveToPosition(l,
g.POSITION_AFTER_END),e&&(a=o.Walker.whitespaces(!0),(a=(l=l.next(a,1))&&l[0].nodeType==k.ELEMENT_NODE&&l.nodeName())&&d.$block[a]&&d[a]["#"]&&h.moveToElementEditablePosition(l)),c.selectRanges([h]),this.focus(),b&&b.scrollIntoView(n,!1),i(this),b}}},insertHtml:function(a,b){var c=this,d;if(c.get("mode")===B){if(d=c.htmlDataProcessor)a=d.toDataFormat(a,null,b);c.focus();c.execCommand("save");var f=c.get("document")[0];d=0;if(e){var h=f.selection;"Control"==h.type&&h.clear();try{h.createRange().pasteHTML(a)}catch(j){}}else try{f.execCommand("inserthtml",
w,a)}catch(l){setTimeout(function(){if(0==c.getSelection().getRanges().length){var b=new o.Range(f),d=k.first(f.body,function(a){return 1==a.nodeType&&"br"!=k.nodeName(a)});d||(d=new g(f.createElement("p")),d._4e_appendBogus(n),f.body.appendChild(d[0]));b.setStartAt(d,o.RANGE.POSITION_AFTER_START);b.select()}f.execCommand("inserthtml",w,a)},d=100)}setTimeout(function(){c.getSelection().scrollIntoView()},d);i(c,d)}}});o._initIFrame=function(a){var d=l.getInstance(a),f=d.get("document")[0],a=f.getElementById("ke_active_script");
k.remove(a);c(d);var i=f.body;e?(i.hideFocus=v,i.disabled=v,i.contentEditable=v,i.removeAttribute("disabled")):setTimeout(function(){b.gecko||b.opera?i.contentEditable=v:b.webkit?i.parentNode.contentEditable=v:f.designMode="on"},0);if(b.gecko||b.opera){var j=f.documentElement;h.on(j,"mousedown",function(a){if(a.target==j){b.gecko&&r(f,w);d.activateGecko()}})}setTimeout(function(){e&&setTimeout(function(){if(f){i.runtimeStyle.marginBottom="0px";i.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){d.__docReady=
1;d.fire("docReady");var a=d.get("disableObjectResizing"),b=d.get("disableInlineTableEditing");if(a||b)try{f.execCommand("enableObjectResizing",w,!a);f.execCommand("enableInlineTableEditing",w,!b)}catch(c){h.on(i,e?"resizestart":"resize",function(c){var d=new g(c.target);(a||d.nodeName()==="table"&&b)&&c.preventDefault()})}},10)};return o},{requires:"editor/core/base,editor/core/utils,editor/core/focusManager,editor/core/styles,editor/core/zIndexManager,editor/core/focusManager,editor/core/meta".split(",")});
