<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>KISSY Seed Test</title>
</head>
<body>
<script src="../../test/test.js"></script>

<h2>Test Data</h2>
<script src="../kissy.js"></script>
<script src="../lang.js"></script>
<script src="../web.js"></script>
<script src="../loader.js"></script>
<script src="../mods.js"></script>

<script src="../../../tools/third-party/jquery.js"></script>

<script>
    var S = KISSY,
        doc = document,
        now = function() {
            return new Date().getTime();
        },
        get = function(id) {
            return typeof id === 'string' ? doc.getElementById(id) : id;
        },
        readyTime, loadTime;

    S.ready(function() {
        readyTime = now();
        S.log('readyTime = ' + readyTime);
    });

    window.onload = function() {
        loadTime = now();
        S.log('loadTime = ' + loadTime);
    };

    //alert(window === window.top);
    //alert(window == window.top);
</script>
<img src="../../../docs/assets/logo.png" alt="test image" />
<div id="test-available">test available</div>
<iframe id="test-iframe" src="test-iframe.html"></iframe>

<!-- Test Cases -->
<script>

    function test_preserve(test) {
        if (!KISSY.Test) test.fail();
    }

    function test_add(test) {
        KISSY.add('test-ks-mod', function(S) {
           S.TestMod = { prop: 1 };
        });

        if(!KISSY.TestMod.prop) test.fail();
        if(KISSY.Env.mods['test-ks-mod'].name !== 'test-ks-mod') test.fail();

        // clear
        delete KISSY.TestMod;
        delete KISSY.Env.mods['test-ks-mod'];
    }

    function test_ready(test) {
        // normal
        var diff = loadTime - readyTime;
        test.extraMsg = 'loadTime - readyTime = ' + diff + 'ms';
        if(diff < 0) test.fail();

        // iframe
        var ifr = get('test-iframe');
        diff = ifr.contentWindow.loadTime - ifr.contentWindow.readyTime;
        if(diff < 0) test.fail();
    }

    function test_available(test) {

        S.available('#test-available', function() {
           test.echo('#test-available is available now.');
        });

        S.later(function() {
            var t = document.createElement('DIV');
            t.id = 'test-available2';
            document.body.appendChild(t);
            test.echo('#test-available2 is created.')
        }, 2000);

        S.available('test-available2', function() {
           test.echo('#test-available2 is available now.');
        });

        // 下面的语句不抛异常
        S.available();
        S.available('test-avaialble');
    }

    function test_makeArray(test) {
        var o;

        // 普通对象(无 length 属性)转换为 [obj]
        o = {a:1};
        if(S.makeArray(o)[0] !== o) test.fail();

        // string 转换为 [str]
        if(S.makeArray('test')[0] !== 'test') test.fail();

        // function 转换为 [fn]
        o = function() {};
        if(S.makeArray(o)[0] !== o) test.fail();

        // array-like 对象，转换为数组
        if(S.makeArray({'0':0, '1':1, length:2}).length !== 2) test.fail();
        if(S.makeArray({'0':0, '1':1, length:2})[1] !== 1) test.fail();

        // nodeList 转换为普通数组
        o = document.getElementsByTagName('body');
        if(S.makeArray(o).length !== 1) test.fail();
        if(S.makeArray(o)[0] !== o[0]) test.fail();
        if(!S.makeArray(o).slice) test.fail();

        // arguments 转换为普通数组
        o = arguments;
        if(S.makeArray(o).length !== 1) test.fail();
        if(S.makeArray(o)[0] !== test) test.fail();
        if(!S.makeArray(o).slice) test.fail();

        // 伪 array-like 对象
        o = S.makeArray({a:1,b:2,length:2});
        if(o.length !== 2) test.fail();
        if(o[0] !== undefined) test.fail();
        if(o[1] !== undefined) test.fail();
    }

    function test_param(test) {
        if(S.param({foo:1, bar:2}) !== 'foo=1&bar=2') test.fail();
        if(S.param({foo:1, bar:[2,3]}) !== 'foo=1&bar%5B%5D=2&bar%5B%5D=3') test.fail();

        if(S.param({'&#': '!#='}) !== '%26%23=!%23%3D') test.fail();

        if(S.param({foo:1, bar:[]}) !== 'foo=1') test.fail();
        if(S.param({foo:{}, bar:2}) !== 'bar=2') test.fail();
        if(S.param({foo:function() {}, bar:2}) !== 'bar=2') test.fail();

        if(S.param({foo:undefined, bar:2}) !== 'foo=undefined&bar=2') test.fail();
        if(S.param({foo:null, bar:2}) !== 'foo=null&bar=2') test.fail();
        if(S.param({foo:true, bar:2}) !== 'foo=true&bar=2') test.fail();
        if(S.param({foo:false, bar:2}) !== 'foo=false&bar=2') test.fail();
        if(S.param({foo:'', bar:2}) !== 'foo=&bar=2') test.fail();
        if(S.param({foo:NaN, bar:2}) !== 'foo=NaN&bar=2') test.fail();
    }

    function test_unparam(test) {
        if(S.unparam('foo=1&bar=2').foo !== '1') test.fail();
        if(S.unparam('foo=1&bar=2').bar !== '2') test.fail();

        if(S.unparam('foo').foo !== '') test.fail();
        if(S.unparam('foo=').foo !== '') test.fail();

        if(S.unparam('foo=1&bar[]=2&bar[]=3').bar[0] !== '2') test.fail();
        if(S.unparam('foo=1&bar[]=2&bar[]=3').bar[1] !== '3') test.fail();

        if(S.unparam('foo=null&bar=2').foo !== 'null') test.fail();
        if(S.unparam('foo=&bar=2').foo !== '') test.fail();
        if(S.unparam('foo&bar=2').foo !== '') test.fail();

        if(S.unparam('foo=1&bar=2&foo=3').foo !== '3') test.fail();        
    }

    function test_later(test) {
        S.later(function(data) {
            test.echo(data);
        }, 0, false, null, 'I am later data.');

        var i = 0;
        var timer = S.later(function(data) {
                        test.echo(data + ' ' + ++i);
                        if(i === 3) {
                            timer.cancel();
                            test.echo('later test done.');
                        }
                      },
                      500, true, null, 'I am periodic later data.');
    }

    function test_globalEval(test) {
        S.globalEval('var globalEvalTest = 1;');
        if(window['globalEvalTest'] !== 1) test.fail();
    }

</script>
</body>
</html>
