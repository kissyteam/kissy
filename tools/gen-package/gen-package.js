var cwd = process.cwd();
var path = require('path');
var startDir = normalizeSlash(path.resolve(cwd, 'src') + '/');
var saveTo = startDir + '/package.js';
var base = '/kissy/src/';
var baseDir = normalizeSlash(path.resolve(cwd, '../'));
var fs = require('fs');

function normalizeSlash(str) {
    return str.replace(/\\/g, '/');
}

function collectSrcDir(dir, allSrc) {
    var files = fs.readdirSync(dir);
    files.forEach(function (f) {
        var c = dir + f;
        var state = fs.statSync(c);
        if (state.isDirectory()) {
            if (f == 'src') {
                allSrc.push(c);
            } else {
                collectSrcDir(c + '/', allSrc);
            }
        }
    });
}

var js_beautify = require('js-beautify').js_beautify;

function my_js_beautify(str) {
    var opts = {"indent_size": "4", "indent_char": " ",
        "preserve_newlines": true, "brace_style": "collapse",
        "keep_array_indentation": false, "space_after_anon_function": true};
    return js_beautify(str, opts);
}

var allSrc = [];

collectSrcDir(startDir, allSrc);

var mod = {};

allSrc.forEach(function (v) {
    v = v.substring(baseDir.length);
    var name = v.substring(base.length, v.length - 4);
    name = name.replace(/sub-modules\//g, '');
    mod[name] = {
        base: v + '/' + path.basename(name),
        ignorePackageNameInUri: 1
    };
});

var code = "/**\n" +
    "    Generated By gen-package.\n" +
    "    For dev mode only!\n" +
    "*/\n" +
    "KISSY.config('tag',KISSY.now());\n" +
    "if (location.href.indexOf('__build') == -1) {\n" +
    "KISSY.config('packages', \n" +
    JSON.stringify(mod) +
    ');}';

fs.writeFileSync(saveTo, my_js_beautify(code));

console.log('saved to: ' + saveTo);







